package com.android.server.devicepolicy;

import android.R;
import android.accessibilityservice.AccessibilityServiceInfo;
import android.accounts.Account;
import android.accounts.AccountManager;
import android.accounts.AuthenticatorException;
import android.accounts.OperationCanceledException;
import android.app.ActivityManager;
import android.app.ActivityManagerInternal;
import android.app.ActivityTaskManager;
import android.app.AlarmManager;
import android.app.AppGlobals;
import android.app.AppOpsManager;
import android.app.BroadcastOptions;
import android.app.IActivityManager;
import android.app.IActivityTaskManager;
import android.app.IApplicationThread;
import android.app.IServiceConnection;
import android.app.IStopUserCallback;
import android.app.Notification;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.app.admin.AccountTypePolicyKey;
import android.app.admin.BooleanPolicyValue;
import android.app.admin.BundlePolicyValue;
import android.app.admin.ComponentNamePolicyValue;
import android.app.admin.DeviceAdminInfo;
import android.app.admin.DevicePolicyCache;
import android.app.admin.DevicePolicyDrawableResource;
import android.app.admin.DevicePolicyEventLogger;
import android.app.admin.DevicePolicyManager;
import android.app.admin.DevicePolicyManagerInternal;
import android.app.admin.DevicePolicyManagerLiteInternal;
import android.app.admin.DevicePolicySafetyChecker;
import android.app.admin.DevicePolicyState;
import android.app.admin.DevicePolicyStringResource;
import android.app.admin.DeviceStateCache;
import android.app.admin.FactoryResetProtectionPolicy;
import android.app.admin.FullyManagedDeviceProvisioningParams;
import android.app.admin.IDevicePolicyManager;
import android.app.admin.IntegerPolicyValue;
import android.app.admin.IntentFilterPolicyKey;
import android.app.admin.LockTaskPolicy;
import android.app.admin.LongPolicyValue;
import android.app.admin.ManagedProfileProvisioningParams;
import android.app.admin.ManagedSubscriptionsPolicy;
import android.app.admin.PackagePolicy;
import android.app.admin.ParcelableGranteeMap;
import android.app.admin.ParcelableResource;
import android.app.admin.PasswordMetrics;
import android.app.admin.PasswordPolicy;
import android.app.admin.PolicyValue;
import android.app.admin.PreferentialNetworkServiceConfig;
import android.app.admin.SecurityLog;
import android.app.admin.StartInstallingUpdateCallback;
import android.app.admin.StringSetPolicyValue;
import android.app.admin.SystemUpdateInfo;
import android.app.admin.SystemUpdatePolicy;
import android.app.admin.UnsafeStateException;
import android.app.admin.UserRestrictionPolicyKey;
import android.app.admin.WifiSsidPolicy;
import android.app.backup.IBackupManager;
import android.app.compat.CompatChanges;
import android.app.role.OnRoleHoldersChangedListener;
import android.app.role.RoleManager;
import android.app.trust.TrustManager;
import android.app.usage.UsageStatsManagerInternal;
import android.content.ActivityNotFoundException;
import android.content.BroadcastReceiver;
import android.content.ComponentName;
import android.content.ContentResolver;
import android.content.ContentValues;
import android.content.Context;
import android.content.IIntentReceiver;
import android.content.IIntentSender;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.IntentSender;
import android.content.PermissionChecker;
import android.content.pm.ActivityInfo;
import android.content.pm.ApplicationInfo;
import android.content.pm.CrossProfileApps;
import android.content.pm.CrossProfileAppsInternal;
import android.content.pm.IPackageDataObserver;
import android.content.pm.IPackageDeleteObserver;
import android.content.pm.IPackageManager;
import android.content.pm.PackageInfo;
import android.content.pm.PackageManager;
import android.content.pm.PackageManagerInternal;
import android.content.pm.ParceledListSlice;
import android.content.pm.ResolveInfo;
import android.content.pm.ServiceInfo;
import android.content.pm.Signature;
import android.content.pm.StringParceledListSlice;
import android.content.pm.UserInfo;
import android.content.pm.UserPackage;
import android.content.pm.parsing.FrameworkParsingPackageUtils;
import android.content.res.Resources;
import android.database.ContentObserver;
import android.database.Cursor;
import android.graphics.Bitmap;
import android.graphics.drawable.Icon;
import android.hardware.usb.UsbManager;
import android.location.Location;
import android.location.LocationManager;
import android.media.AudioManager;
import android.net.ConnectivityManager;
import android.net.ConnectivitySettingsManager;
import android.net.IIpConnectivityMetrics;
import android.net.ProfileNetworkPreference;
import android.net.ProxyInfo;
import android.net.Uri;
import android.net.VpnManager;
import android.net.wifi.WifiManager;
import android.os.AsyncTask;
import android.os.Binder;
import android.os.Build;
import android.os.Bundle;
import android.os.Handler;
import android.os.IBinder;
import android.os.IInstalld;
import android.os.Looper;
import android.os.ParcelFileDescriptor;
import android.os.Parcelable;
import android.os.PersistableBundle;
import android.os.PowerManager;
import android.os.PowerManagerInternal;
import android.os.Process;
import android.os.RemoteCallback;
import android.os.RemoteException;
import android.os.ResultReceiver;
import android.os.ServiceManager;
import android.os.ServiceSpecificException;
import android.os.ShellCallback;
import android.os.SystemClock;
import android.os.SystemProperties;
import android.os.UserHandle;
import android.os.UserManager;
import android.os.storage.StorageManager;
import android.permission.AdminPermissionControlParams;
import android.permission.IPermissionManager;
import android.permission.PermissionControllerManager;
import android.provider.ContactsContract;
import android.provider.ContactsInternal;
import android.provider.DeviceConfig;
import android.provider.Settings;
import android.provider.Telephony;
import android.sec.enterprise.auditlog.AuditLog;
import android.security.AppUriAuthenticationPolicy;
import android.security.IKeyChainAliasCallback;
import android.security.IKeyChainService;
import android.security.KeyChain;
import android.security.keymaster.KeymasterCertificateChain;
import android.security.keystore.KeyGenParameterSpec;
import android.security.keystore.ParcelableKeyGenParameterSpec;
import android.telecom.TelecomManager;
import android.telephony.SubscriptionManager;
import android.telephony.TelephonyManager;
import android.telephony.data.ApnSetting;
import android.text.TextUtils;
import android.text.format.DateUtils;
import android.util.ArrayMap;
import android.util.ArraySet;
import android.util.AtomicFile;
import android.util.DebugUtils;
import android.util.IndentingPrintWriter;
import android.util.IntArray;
import android.util.Log;
import android.util.Pair;
import android.util.Slog;
import android.util.SparseArray;
import android.util.Xml;
import android.view.IWindowManager;
import android.view.accessibility.AccessibilityManager;
import android.view.accessibility.IAccessibilityManager;
import android.view.inputmethod.InputMethodInfo;
import com.android.internal.app.LocalePicker;
import com.android.internal.infra.AndroidFuture;
import com.android.internal.logging.MetricsLogger;
import com.android.internal.net.NetworkUtilsInternal;
import com.android.internal.notification.SystemNotificationChannels;
import com.android.internal.os.BackgroundThread;
import com.android.internal.policy.IKeyguardDismissCallback;
import com.android.internal.statusbar.IStatusBarService;
import com.android.internal.telephony.SmsApplication;
import com.android.internal.util.ArrayUtils;
import com.android.internal.util.DumpUtils;
import com.android.internal.util.FrameworkStatsLog;
import com.android.internal.util.FunctionalUtils;
import com.android.internal.util.JournaledFile;
import com.android.internal.util.Preconditions;
import com.android.internal.util.StatLogger;
import com.android.internal.util.jobs.XmlUtils;
import com.android.internal.widget.LockPatternUtils;
import com.android.internal.widget.LockSettingsInternal;
import com.android.internal.widget.LockscreenCredential;
import com.android.modules.utils.TypedXmlPullParser;
import com.android.modules.utils.TypedXmlSerializer;
import com.android.server.AlarmManagerInternal;
import com.android.server.LocalManagerRegistry;
import com.android.server.LocalServices;
import com.android.server.LockGuard;
import com.android.server.PersistentDataBlockManagerInternal;
import com.android.server.SystemServerInitThreadPool;
import com.android.server.SystemService;
import com.android.server.SystemServiceManager;
import com.android.server.am.mars.filter.filter.ProtectedPackagesFilter;
import com.android.server.devicepolicy.ActiveAdmin;
import com.android.server.devicepolicy.DevicePolicyManagerService;
import com.android.server.devicepolicy.TransferOwnershipMetadataManager;
import com.android.server.inputmethod.InputMethodManagerInternal;
import com.android.server.knox.dar.DarManagerService;
import com.android.server.knox.dar.sdp.SDPLog;
import com.android.server.net.NetworkPolicyManagerInternal;
import com.android.server.pm.DefaultCrossProfileIntentFilter;
import com.android.server.pm.DefaultCrossProfileIntentFiltersUtils;
import com.android.server.pm.PackageManagerLocal;
import com.android.server.pm.PersonaManagerService;
import com.android.server.pm.RestrictionsSet;
import com.android.server.pm.UserManagerInternal;
import com.android.server.pm.UserRestrictionsUtils;
import com.android.server.pm.pkg.AndroidPackage;
import com.android.server.pm.pkg.PackageState;
import com.android.server.uri.UriGrantsManagerInternal;
import com.android.server.utils.Slogf;
import com.android.server.wm.ActivityTaskManagerInternal;
import com.samsung.android.knox.ContextInfo;
import com.samsung.android.knox.EdmConstants;
import com.samsung.android.knox.EnterpriseDeviceManager;
import com.samsung.android.knox.EnterpriseKnoxManager;
import com.samsung.android.knox.IEnterpriseDeviceManager;
import com.samsung.android.knox.IMiscPolicy;
import com.samsung.android.knox.SemPersonaManager;
import com.samsung.android.knox.analytics.KnoxAnalytics;
import com.samsung.android.knox.analytics.KnoxAnalyticsData;
import com.samsung.android.knox.analytics.activation.DevicePolicyListener;
import com.samsung.android.knox.container.KnoxContainerManager;
import com.samsung.android.knox.custom.IKnoxCustomManager;
import com.samsung.android.knox.custom.KnoxCustomManagerService;
import com.samsung.android.knox.custom.LauncherConfigurationInternal;
import com.samsung.android.knox.custom.utils.KnoxsdkFileLog;
import com.samsung.android.knox.dar.IDarManagerService;
import com.samsung.android.knox.dar.ddar.DualDarManager;
import com.samsung.android.knox.license.IEnterpriseLicense;
import com.samsung.android.knox.localservice.ApplicationRestrictionsInternal;
import com.samsung.android.knox.net.wifi.IWifiPolicy;
import com.samsung.android.knox.restriction.IRestrictionPolicy;
import com.samsung.android.security.SemSdCardEncryption;
import com.samsung.android.security.mdf.MdfUtils;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileDescriptor;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.PrintWriter;
import java.security.cert.Certificate;
import java.security.cert.CertificateException;
import java.security.cert.CertificateFactory;
import java.security.cert.X509Certificate;
import java.text.DateFormat;
import java.time.LocalDate;
import java.time.chrono.ChronoLocalDate;
import java.util.ArrayDeque;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.Executor;
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.TimeoutException;
import java.util.function.Consumer;
import java.util.function.Function;
import java.util.function.IntFunction;
import java.util.function.Predicate;
import java.util.function.Supplier;
import java.util.function.ToIntFunction;
import java.util.stream.Collectors;
import java.util.stream.Stream;
import org.xmlpull.v1.XmlPullParserException;

/* loaded from: classes2.dex */
public class DevicePolicyManagerService extends IDevicePolicyManager.Stub {
    static final String ACTION_PROFILE_OFF_DEADLINE = "com.android.server.ACTION_PROFILE_OFF_DEADLINE";
    static final String ACTION_TURN_PROFILE_ON_NOTIFICATION = "com.android.server.ACTION_TURN_PROFILE_ON_NOTIFICATION";
    public static final List ADDITIONAL_AFFILIATED_PROFILE_OWNER_ON_USER_PERMISSIONS;
    public static final List ADDITIONAL_PROFILE_OWNER_OF_ORGANIZATION_OWNED_DEVICE_PERMISSIONS;
    public static final List ADDITIONAL_PROFILE_OWNER_ON_USER_0_PERMISSIONS;
    public static final List ADDITIONAL_PROFILE_OWNER_ON_USER_PERMISSIONS;
    public static final List AFFILIATED_PROFILE_OWNER_ON_USER_PERMISSIONS;
    public static final Map APPLICATION_EXEMPTION_CONSTANTS_TO_APP_OPS;
    public static final HashMap CROSS_USER_PERMISSIONS;
    public static final Set DA_DISALLOWED_POLICIES;
    public static final List DEFAULT_DEVICE_OWNER_PERMISSIONS;
    public static final HashMap DELEGATE_SCOPES;
    public static final String[] DELEGATIONS;
    public static final List DEVICE_OWNER_OR_MANAGED_PROFILE_OWNER_DELEGATIONS;
    public static final List DEVICE_OWNER_OR_ORGANIZATION_OWNED_MANAGED_PROFILE_OWNER_DELEGATIONS;
    public static final HashMap DPC_PERMISSIONS;
    public static final List EXCLUSIVE_DELEGATIONS;
    public static final long EXPIRATION_GRACE_PERIOD_MS;
    public static final List FINANCED_DEVICE_OWNER_PERMISSIONS;
    public static final List FRP_PROTECTED_PACKAGES;
    public static final Set GLOBAL_SETTINGS_ALLOWLIST;
    public static final Set GLOBAL_SETTINGS_DEPRECATED;
    public static final long MANAGED_PROFILE_MAXIMUM_TIME_OFF_THRESHOLD;
    public static final long MANAGED_PROFILE_OFF_WARNING_PERIOD;
    public static final long MINIMUM_STRONG_AUTH_TIMEOUT_MS;
    public static final long MS_PER_DAY;
    public static final HashMap POLICY_IDENTIFIER_TO_ACTIVE_ADMIN_POLICY;
    public static final HashMap POLICY_IDENTIFIER_TO_PERMISSION;
    public static final List PROFILE_OWNER_OF_ORGANIZATION_OWNED_DEVICE_PERMISSIONS;
    public static final List PROFILE_OWNER_ON_USER_0_PERMISSIONS;
    public static final List PROFILE_OWNER_ON_USER_PERMISSIONS;
    public static final List PROFILE_OWNER_PERMISSIONS;
    public static final Set SECURE_SETTINGS_ALLOWLIST;
    public static final Set SECURE_SETTINGS_DEVICEOWNER_ALLOWLIST;
    public static final List SENSOR_PERMISSIONS;
    public static final Set SYSTEM_SETTINGS_ALLOWLIST;
    public static final HashMap USER_RESTRICTION_PERMISSIONS;
    public ThreadPoolExecutor calculateHasIncompatibleAccountsExecutor;
    public final Handler mBackgroundHandler;
    public final RemoteBugreportManager mBugreportCollectionManager;
    public final CertificateMonitor mCertificateMonitor;
    public DevicePolicyConstants mConstants;
    public final DevicePolicyConstantsObserver mConstantsObserver;
    public final Set mContactSystemRoleHolders;
    public final Context mContext;
    public final DeviceAdminServiceController mDeviceAdminServiceController;
    public final DeviceManagementResourcesProvider mDeviceManagementResourcesProvider;
    public final DevicePolicyEngine mDevicePolicyEngine;
    public final DevicePolicyManagementRoleObserver mDevicePolicyManagementRoleObserver;
    public DualDarProvisioningHelper mDualDarProvisioningHelper;
    public final Object mESIDInitilizationLock;
    public EnterpriseSpecificIdCalculator mEsidCalculator;
    public final Handler mHandler;
    public final boolean mHasFeature;
    public volatile Map mHasIncompatibleAccounts;
    public final boolean mHasTelephonyDataFeature;
    public final boolean mHasTelephonyFeature;
    public final IPackageManager mIPackageManager;
    public final IPermissionManager mIPermissionManager;
    public final Injector mInjector;
    public final boolean mIsAutomotive;
    public final boolean mIsWatch;
    public final LocalService mLocalService;
    public final Object mLockDoNoUseDirectly;
    public final LockPatternUtils mLockPatternUtils;
    public final LockSettingsInternal mLockSettingsInternal;
    public int mLogoutUserId;
    public NetworkLogger mNetworkLogger;
    public int mNetworkLoggingNotificationUserId;
    public boolean mNotifyChanges;
    public final OverlayPackagesProvider mOverlayPackagesProvider;
    final Owners mOwners;
    public final Set mPackagesToRemove;
    public final PolicyPathProvider mPathProvider;
    public final ArrayList mPendingUserCreatedCallbackTokens;
    public final DevicePolicyCacheImpl mPolicyCache;
    public final BroadcastReceiver mReceiver;
    public final RoleManager mRoleManager;
    public DevicePolicySafetyChecker mSafetyChecker;
    public final SecurityLogMonitor mSecurityLogMonitor;
    public final SetupContentObserver mSetupContentObserver;
    public final StatLogger mStatLogger;
    public final DeviceStateCacheImpl mStateCache;
    public SubscriptionManager.OnSubscriptionsChangedListener mSubscriptionsChangedListener;
    public final Object mSubscriptionsChangedListenerLock;
    public final TelephonyManager mTelephonyManager;
    public final Binder mToken;
    final TransferOwnershipMetadataManager mTransferOwnershipMetadataManager;
    public final UsageStatsManagerInternal mUsageStatsManagerInternal;
    public final SparseArray mUserData;
    public final UserManager mUserManager;
    public final UserManagerInternal mUserManagerInternal;
    public boolean oldAllowWifi;

    /* renamed from: com.android.server.devicepolicy.DevicePolicyManagerService$2 */
    /* loaded from: classes2.dex */
    public class AnonymousClass2 implements PolicyPathProvider {
    }

    public static boolean isKeepProfilesRunningFlagEnabled() {
        return false;
    }

    public static /* synthetic */ boolean lambda$getActiveAdminsForAffectedUserInclPermissionBasedAdminLocked$18(UserInfo userInfo) {
        return false;
    }

    public static /* synthetic */ boolean lambda$getActiveAdminsForAffectedUserLocked$17(UserInfo userInfo) {
        return false;
    }

    public static /* synthetic */ boolean lambda$getAggregatedPasswordComplexityLocked$34(UserInfo userInfo) {
        return false;
    }

    public static /* synthetic */ boolean lambda$getCombinedWifiSsidPolicyLocked$184(UserInfo userInfo) {
        return true;
    }

    public static /* synthetic */ boolean lambda$getPasswordMinimumMetricsUnchecked$31(UserInfo userInfo) {
        return false;
    }

    public static /* synthetic */ boolean lambda$getStrictestMinimumRequiredWifiSecurityLevelLocked$183(UserInfo userInfo) {
        return true;
    }

    public final String getEncryptionStatusName(int i) {
        return i != 0 ? i != 5 ? "unknown" : "per-user" : "unsupported";
    }

    public final boolean isUnicornFlagEnabled() {
        return false;
    }

    public final int makeSuspensionReasons(boolean z, boolean z2) {
        return z2 ? (z ? 1 : 0) | 2 : z ? 1 : 0;
    }

    public final void setEncryptionRequested(boolean z) {
    }

    static {
        long millis = TimeUnit.DAYS.toMillis(1L);
        MS_PER_DAY = millis;
        EXPIRATION_GRACE_PERIOD_MS = 5 * millis;
        MANAGED_PROFILE_MAXIMUM_TIME_OFF_THRESHOLD = 3 * millis;
        MANAGED_PROFILE_OFF_WARNING_PERIOD = millis * 1;
        DELEGATIONS = new String[]{"delegation-cert-install", "delegation-app-restrictions", "delegation-block-uninstall", "delegation-enable-system-app", "delegation-keep-uninstalled-packages", "delegation-package-access", "delegation-permission-grant", "delegation-install-existing-package", "delegation-keep-uninstalled-packages", "delegation-network-logging", "delegation-security-logging", "delegation-cert-selection"};
        DEVICE_OWNER_OR_MANAGED_PROFILE_OWNER_DELEGATIONS = Arrays.asList("delegation-network-logging");
        DEVICE_OWNER_OR_ORGANIZATION_OWNED_MANAGED_PROFILE_OWNER_DELEGATIONS = Arrays.asList("delegation-security-logging");
        EXCLUSIVE_DELEGATIONS = Arrays.asList("delegation-network-logging", "delegation-security-logging", "delegation-cert-selection");
        ArraySet arraySet = new ArraySet();
        SECURE_SETTINGS_ALLOWLIST = arraySet;
        arraySet.add("default_input_method");
        arraySet.add("skip_first_use_hints");
        arraySet.add("install_non_market_apps");
        ArraySet arraySet2 = new ArraySet();
        SECURE_SETTINGS_DEVICEOWNER_ALLOWLIST = arraySet2;
        arraySet2.addAll((Collection) arraySet);
        arraySet2.add("location_mode");
        ArraySet arraySet3 = new ArraySet();
        GLOBAL_SETTINGS_ALLOWLIST = arraySet3;
        arraySet3.add("adb_enabled");
        arraySet3.add("adb_wifi_enabled");
        arraySet3.add("auto_time");
        arraySet3.add("auto_time_zone");
        arraySet3.add("data_roaming");
        arraySet3.add("usb_mass_storage_enabled");
        arraySet3.add("wifi_sleep_policy");
        arraySet3.add("stay_on_while_plugged_in");
        arraySet3.add("wifi_device_owner_configs_lockdown");
        arraySet3.add("private_dns_mode");
        arraySet3.add("private_dns_specifier");
        ArraySet arraySet4 = new ArraySet();
        GLOBAL_SETTINGS_DEPRECATED = arraySet4;
        arraySet4.add("bluetooth_on");
        arraySet4.add("development_settings_enabled");
        arraySet4.add("mode_ringer");
        arraySet4.add("network_preference");
        arraySet4.add("wifi_on");
        ArraySet arraySet5 = new ArraySet();
        SYSTEM_SETTINGS_ALLOWLIST = arraySet5;
        arraySet5.add("screen_brightness");
        arraySet5.add("screen_brightness_float");
        arraySet5.add("screen_brightness_mode");
        arraySet5.add("screen_off_timeout");
        ArraySet arraySet6 = new ArraySet();
        DA_DISALLOWED_POLICIES = arraySet6;
        arraySet6.add(8);
        arraySet6.add(9);
        arraySet6.add(6);
        arraySet6.add(0);
        MINIMUM_STRONG_AUTH_TIMEOUT_MS = TimeUnit.HOURS.toMillis(1L);
        ArrayMap arrayMap = new ArrayMap();
        APPLICATION_EXEMPTION_CONSTANTS_TO_APP_OPS = arrayMap;
        arrayMap.put(0, "android:system_exempt_from_suspension");
        arrayMap.put(1, "android:system_exempt_from_dismissible_notifications");
        arrayMap.put(2, "android:system_exempt_from_activity_bg_start_restriction");
        arrayMap.put(3, "android:system_exempt_from_hibernation");
        arrayMap.put(4, "android:system_exempt_from_power_restrictions");
        FRP_PROTECTED_PACKAGES = Arrays.asList("com.google.android.setupwizard", "com.sec.android.app.SecSetupWizard", "com.google.android.gms", "com.sec.android.app.setupwizard");
        USER_RESTRICTION_PERMISSIONS = new HashMap();
        SENSOR_PERMISSIONS = new ArrayList();
        DEFAULT_DEVICE_OWNER_PERMISSIONS = List.of((Object[]) new String[]{"android.permission.MANAGE_DEVICE_POLICY_ACCOUNT_MANAGEMENT", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_SECURITY_CRITICAL", "android.permission.MANAGE_DEVICE_POLICY_AIRPLANE_MODE", "android.permission.MANAGE_DEVICE_POLICY_APPS_CONTROL", "android.permission.MANAGE_DEVICE_POLICY_APP_RESTRICTIONS", "android.permission.MANAGE_DEVICE_POLICY_AUDIO_OUTPUT", "android.permission.MANAGE_DEVICE_POLICY_AUTOFILL", "android.permission.MANAGE_DEVICE_POLICY_BLUETOOTH", "android.permission.MANAGE_DEVICE_POLICY_CALLS", "android.permission.MANAGE_DEVICE_POLICY_CAMERA", "android.permission.MANAGE_DEVICE_POLICY_CERTIFICATES", "android.permission.MANAGE_DEVICE_POLICY_COMMON_CRITERIA_MODE", "android.permission.MANAGE_DEVICE_POLICY_DEBUGGING_FEATURES", "android.permission.MANAGE_DEVICE_POLICY_DEFAULT_SMS", "android.permission.MANAGE_DEVICE_POLICY_DISPLAY", "android.permission.MANAGE_DEVICE_POLICY_FACTORY_RESET", "android.permission.MANAGE_DEVICE_POLICY_FUN", "android.permission.MANAGE_DEVICE_POLICY_INPUT_METHODS", "android.permission.MANAGE_DEVICE_POLICY_INSTALL_UNKNOWN_SOURCES", "android.permission.MANAGE_DEVICE_POLICY_KEYGUARD", "android.permission.MANAGE_DEVICE_POLICY_LOCALE", "android.permission.MANAGE_DEVICE_POLICY_LOCATION", "android.permission.MANAGE_DEVICE_POLICY_LOCK", "android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS", "android.permission.MANAGE_DEVICE_POLICY_LOCK_TASK", "android.permission.MANAGE_DEVICE_POLICY_MICROPHONE", "android.permission.MANAGE_DEVICE_POLICY_MOBILE_NETWORK", "android.permission.MANAGE_DEVICE_POLICY_MODIFY_USERS", "android.permission.MANAGE_DEVICE_POLICY_MTE", "android.permission.MANAGE_DEVICE_POLICY_NEARBY_COMMUNICATION", "android.permission.MANAGE_DEVICE_POLICY_ORGANIZATION_IDENTITY", "android.permission.MANAGE_DEVICE_POLICY_PACKAGE_STATE", "android.permission.MANAGE_DEVICE_POLICY_PHYSICAL_MEDIA", "android.permission.MANAGE_DEVICE_POLICY_PRINTING", "android.permission.MANAGE_DEVICE_POLICY_PROFILES", "android.permission.MANAGE_DEVICE_POLICY_PROFILE_INTERACTION", "android.permission.MANAGE_DEVICE_POLICY_RESET_PASSWORD", "android.permission.MANAGE_DEVICE_POLICY_RESTRICT_PRIVATE_DNS", "android.permission.MANAGE_DEVICE_POLICY_RUNTIME_PERMISSIONS", "android.permission.MANAGE_DEVICE_POLICY_SAFE_BOOT", "android.permission.MANAGE_DEVICE_POLICY_SCREEN_CAPTURE", "android.permission.MANAGE_DEVICE_POLICY_SCREEN_CONTENT", "android.permission.MANAGE_DEVICE_POLICY_SECURITY_LOGGING", "android.permission.MANAGE_DEVICE_POLICY_SMS", "android.permission.MANAGE_DEVICE_POLICY_STATUS_BAR", "android.permission.MANAGE_DEVICE_POLICY_SUPPORT_MESSAGE", "android.permission.MANAGE_DEVICE_POLICY_SYSTEM_DIALOGS", "android.permission.MANAGE_DEVICE_POLICY_SYSTEM_UPDATES", "android.permission.MANAGE_DEVICE_POLICY_TIME", "android.permission.MANAGE_DEVICE_POLICY_USB_DATA_SIGNALLING", "android.permission.MANAGE_DEVICE_POLICY_USB_FILE_TRANSFER", "android.permission.MANAGE_DEVICE_POLICY_VPN", "android.permission.MANAGE_DEVICE_POLICY_WALLPAPER", "android.permission.MANAGE_DEVICE_POLICY_WIFI", "android.permission.MANAGE_DEVICE_POLICY_WINDOWS", "android.permission.MANAGE_DEVICE_POLICY_WIPE_DATA", "android.permission.SET_TIME", "android.permission.SET_TIME_ZONE"});
        FINANCED_DEVICE_OWNER_PERMISSIONS = List.of((Object[]) new String[]{"android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_SECURITY_CRITICAL", "android.permission.MANAGE_DEVICE_POLICY_APPS_CONTROL", "android.permission.MANAGE_DEVICE_POLICY_CALLS", "android.permission.MANAGE_DEVICE_POLICY_DEBUGGING_FEATURES", "android.permission.MANAGE_DEVICE_POLICY_FACTORY_RESET", "android.permission.MANAGE_DEVICE_POLICY_INSTALL_UNKNOWN_SOURCES", "android.permission.MANAGE_DEVICE_POLICY_KEYGUARD", "android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS", "android.permission.MANAGE_DEVICE_POLICY_LOCK_TASK", "android.permission.MANAGE_DEVICE_POLICY_MODIFY_USERS", "android.permission.MANAGE_DEVICE_POLICY_ORGANIZATION_IDENTITY", "android.permission.MANAGE_DEVICE_POLICY_RUNTIME_PERMISSIONS", "android.permission.MANAGE_DEVICE_POLICY_SAFE_BOOT", "android.permission.MANAGE_DEVICE_POLICY_SUPPORT_MESSAGE", "android.permission.MANAGE_DEVICE_POLICY_TIME", "android.permission.MANAGE_DEVICE_POLICY_WIPE_DATA"});
        PROFILE_OWNER_PERMISSIONS = List.of((Object[]) new String[]{"android.permission.MANAGE_DEVICE_POLICY_ACCOUNT_MANAGEMENT", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_SECURITY_CRITICAL", "android.permission.MANAGE_DEVICE_POLICY_APPS_CONTROL", "android.permission.MANAGE_DEVICE_POLICY_APP_RESTRICTIONS", "android.permission.MANAGE_DEVICE_POLICY_AUDIO_OUTPUT", "android.permission.MANAGE_DEVICE_POLICY_AUTOFILL", "android.permission.MANAGE_DEVICE_POLICY_BLUETOOTH", "android.permission.MANAGE_DEVICE_POLICY_CALLS", "android.permission.MANAGE_DEVICE_POLICY_CAMERA", "android.permission.MANAGE_DEVICE_POLICY_CERTIFICATES", "android.permission.MANAGE_DEVICE_POLICY_DEBUGGING_FEATURES", "android.permission.MANAGE_DEVICE_POLICY_DISPLAY", "android.permission.MANAGE_DEVICE_POLICY_FACTORY_RESET", "android.permission.MANAGE_DEVICE_POLICY_INPUT_METHODS", "android.permission.MANAGE_DEVICE_POLICY_INSTALL_UNKNOWN_SOURCES", "android.permission.MANAGE_DEVICE_POLICY_KEYGUARD", "android.permission.MANAGE_DEVICE_POLICY_LOCALE", "android.permission.MANAGE_DEVICE_POLICY_LOCATION", "android.permission.MANAGE_DEVICE_POLICY_LOCK", "android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS", "android.permission.MANAGE_DEVICE_POLICY_CERTIFICATES", "android.permission.MANAGE_DEVICE_POLICY_NEARBY_COMMUNICATION", "android.permission.MANAGE_DEVICE_POLICY_ORGANIZATION_IDENTITY", "android.permission.MANAGE_DEVICE_POLICY_PACKAGE_STATE", "android.permission.MANAGE_DEVICE_POLICY_PRINTING", "android.permission.MANAGE_DEVICE_POLICY_PROFILES", "android.permission.MANAGE_DEVICE_POLICY_PROFILE_INTERACTION", "android.permission.MANAGE_DEVICE_POLICY_RESET_PASSWORD", "android.permission.MANAGE_DEVICE_POLICY_RUNTIME_PERMISSIONS", "android.permission.MANAGE_DEVICE_POLICY_SCREEN_CAPTURE", "android.permission.MANAGE_DEVICE_POLICY_SCREEN_CONTENT", "android.permission.MANAGE_DEVICE_POLICY_SUPPORT_MESSAGE", "android.permission.MANAGE_DEVICE_POLICY_SYSTEM_DIALOGS", "android.permission.MANAGE_DEVICE_POLICY_TIME", "android.permission.MANAGE_DEVICE_POLICY_VPN", "android.permission.MANAGE_DEVICE_POLICY_WIPE_DATA"});
        ADDITIONAL_PROFILE_OWNER_OF_ORGANIZATION_OWNED_DEVICE_PERMISSIONS = List.of((Object[]) new String[]{"android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS", "android.permission.MANAGE_DEVICE_POLICY_AIRPLANE_MODE", "android.permission.MANAGE_DEVICE_POLICY_APPS_CONTROL", "android.permission.MANAGE_DEVICE_POLICY_COMMON_CRITERIA_MODE", "android.permission.MANAGE_DEVICE_POLICY_DEFAULT_SMS", "android.permission.MANAGE_DEVICE_POLICY_LOCALE", "android.permission.MANAGE_DEVICE_POLICY_MICROPHONE", "android.permission.MANAGE_DEVICE_POLICY_MOBILE_NETWORK", "android.permission.MANAGE_DEVICE_POLICY_MTE", "android.permission.MANAGE_DEVICE_POLICY_NEARBY_COMMUNICATION", "android.permission.MANAGE_DEVICE_POLICY_PHYSICAL_MEDIA", "android.permission.MANAGE_DEVICE_POLICY_RESTRICT_PRIVATE_DNS", "android.permission.MANAGE_DEVICE_POLICY_SAFE_BOOT", "android.permission.MANAGE_DEVICE_POLICY_SECURITY_LOGGING", "android.permission.MANAGE_DEVICE_POLICY_SMS", "android.permission.MANAGE_DEVICE_POLICY_SYSTEM_UPDATES", "android.permission.MANAGE_DEVICE_POLICY_USB_DATA_SIGNALLING", "android.permission.MANAGE_DEVICE_POLICY_USB_FILE_TRANSFER", "android.permission.MANAGE_DEVICE_POLICY_WIFI", "android.permission.SET_TIME", "android.permission.SET_TIME_ZONE"});
        ADDITIONAL_PROFILE_OWNER_ON_USER_0_PERMISSIONS = List.of((Object[]) new String[]{"android.permission.MANAGE_DEVICE_POLICY_AIRPLANE_MODE", "android.permission.MANAGE_DEVICE_POLICY_DISPLAY", "android.permission.MANAGE_DEVICE_POLICY_FUN", "android.permission.MANAGE_DEVICE_POLICY_LOCK_TASK", "android.permission.MANAGE_DEVICE_POLICY_MOBILE_NETWORK", "android.permission.MANAGE_DEVICE_POLICY_MODIFY_USERS", "android.permission.MANAGE_DEVICE_POLICY_PHYSICAL_MEDIA", "android.permission.MANAGE_DEVICE_POLICY_PRINTING", "android.permission.MANAGE_DEVICE_POLICY_PROFILES", "android.permission.MANAGE_DEVICE_POLICY_PROFILE_INTERACTION", "android.permission.MANAGE_DEVICE_POLICY_SAFE_BOOT", "android.permission.MANAGE_DEVICE_POLICY_SMS", "android.permission.MANAGE_DEVICE_POLICY_SYSTEM_DIALOGS", "android.permission.MANAGE_DEVICE_POLICY_USB_FILE_TRANSFER", "android.permission.MANAGE_DEVICE_POLICY_WINDOWS", "android.permission.SET_TIME", "android.permission.SET_TIME_ZONE"});
        ADDITIONAL_PROFILE_OWNER_ON_USER_PERMISSIONS = List.of("android.permission.MANAGE_DEVICE_POLICY_LOCK_TASK");
        ADDITIONAL_AFFILIATED_PROFILE_OWNER_ON_USER_PERMISSIONS = List.of("android.permission.MANAGE_DEVICE_POLICY_STATUS_BAR");
        PROFILE_OWNER_OF_ORGANIZATION_OWNED_DEVICE_PERMISSIONS = new ArrayList();
        PROFILE_OWNER_ON_USER_0_PERMISSIONS = new ArrayList();
        AFFILIATED_PROFILE_OWNER_ON_USER_PERMISSIONS = new ArrayList();
        PROFILE_OWNER_ON_USER_PERMISSIONS = new ArrayList();
        DPC_PERMISSIONS = new HashMap();
        DELEGATE_SCOPES = new HashMap();
        CROSS_USER_PERMISSIONS = new HashMap();
        POLICY_IDENTIFIER_TO_PERMISSION = new HashMap();
        POLICY_IDENTIFIER_TO_ACTIVE_ADMIN_POLICY = new HashMap();
    }

    public final Object getLockObject() {
        long time = this.mStatLogger.getTime();
        LockGuard.guard(8);
        this.mStatLogger.logDurationStat(0, time);
        return this.mLockDoNoUseDirectly;
    }

    public final void ensureLocked() {
        if (Thread.holdsLock(this.mLockDoNoUseDirectly)) {
            return;
        }
        Slogf.wtfStack("DevicePolicyManager", "Not holding DPMS lock.");
    }

    public final void wtfIfInLock() {
        if (Thread.holdsLock(this.mLockDoNoUseDirectly)) {
            Slogf.wtfStack("DevicePolicyManager", "Shouldn't be called with DPMS lock held");
        }
    }

    /* loaded from: classes2.dex */
    public final class Lifecycle extends SystemService {
        public DevicePolicyManagerService mService;

        public Lifecycle(Context context) {
            super(context);
            String string = context.getResources().getString(R.string.face_error_security_update_required);
            if (TextUtils.isEmpty(string)) {
                this.mService = new DevicePolicyManagerService(context);
                return;
            }
            try {
                this.mService = (DevicePolicyManagerService) Class.forName(string).getConstructor(Context.class).newInstance(context);
            } catch (Exception e) {
                throw new IllegalStateException("Failed to instantiate DevicePolicyManagerService with class name: " + string, e);
            }
        }

        public void setDevicePolicySafetyChecker(DevicePolicySafetyChecker devicePolicySafetyChecker) {
            this.mService.setDevicePolicySafetyChecker(devicePolicySafetyChecker);
        }

        @Override // com.android.server.SystemService
        public void onStart() {
            publishBinderService("device_policy", this.mService);
        }

        @Override // com.android.server.SystemService
        public void onBootPhase(int i) {
            this.mService.systemReady(i);
        }

        @Override // com.android.server.SystemService
        public void onUserStarting(SystemService.TargetUser targetUser) {
            if (targetUser.isPreCreated()) {
                return;
            }
            this.mService.handleStartUser(targetUser.getUserIdentifier());
        }

        @Override // com.android.server.SystemService
        public void onUserUnlocking(SystemService.TargetUser targetUser) {
            if (targetUser.isPreCreated()) {
                return;
            }
            this.mService.handleUnlockUser(targetUser.getUserIdentifier());
        }

        @Override // com.android.server.SystemService
        public void onUserStopping(SystemService.TargetUser targetUser) {
            if (targetUser.isPreCreated()) {
                return;
            }
            this.mService.handleStopUser(targetUser.getUserIdentifier());
        }

        @Override // com.android.server.SystemService
        public void onUserUnlocked(SystemService.TargetUser targetUser) {
            if (targetUser.isPreCreated()) {
                return;
            }
            this.mService.handleOnUserUnlocked(targetUser.getUserIdentifier());
        }
    }

    /* renamed from: com.android.server.devicepolicy.DevicePolicyManagerService$1 */
    /* loaded from: classes2.dex */
    public class AnonymousClass1 extends BroadcastReceiver {
        public AnonymousClass1() {
        }

        @Override // android.content.BroadcastReceiver
        public void onReceive(Context context, Intent intent) {
            String action = intent.getAction();
            int intExtra = intent.getIntExtra("android.intent.extra.user_handle", getSendingUserId());
            if ("android.intent.action.USER_STARTED".equals(action) && intExtra == 0) {
                synchronized (DevicePolicyManagerService.this.getLockObject()) {
                    if (DevicePolicyManagerService.this.isNetworkLoggingEnabledInternalLocked()) {
                        DevicePolicyManagerService.this.setNetworkLoggingActiveInternal(true);
                    }
                }
            }
            if ("android.intent.action.BOOT_COMPLETED".equals(action)) {
                DevicePolicyManagerService.this.calculateHasIncompatibleAccounts();
            }
            if ("android.intent.action.BOOT_COMPLETED".equals(action) && intExtra == DevicePolicyManagerService.this.mOwners.getDeviceOwnerUserId()) {
                DevicePolicyManagerService.this.mBugreportCollectionManager.checkForPendingBugreportAfterBoot();
            }
            if ("android.intent.action.BOOT_COMPLETED".equals(action) || "com.android.server.ACTION_EXPIRED_PASSWORD_NOTIFICATION".equals(action)) {
                DevicePolicyManagerService.this.mHandler.post(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService.1.1
                    public final /* synthetic */ int val$userHandle;

                    public RunnableC00151(int intExtra2) {
                        r2 = intExtra2;
                    }

                    @Override // java.lang.Runnable
                    public void run() {
                        DevicePolicyManagerService.this.handlePasswordExpirationNotification(r2);
                    }
                });
            }
            if ("android.intent.action.USER_ADDED".equals(action)) {
                sendDeviceOwnerUserCommand("android.app.action.USER_ADDED", intExtra2);
                synchronized (DevicePolicyManagerService.this.getLockObject()) {
                    DevicePolicyManagerService.this.maybePauseDeviceWideLoggingLocked();
                }
                return;
            }
            if ("android.intent.action.USER_REMOVED".equals(action)) {
                sendDeviceOwnerUserCommand("android.app.action.USER_REMOVED", intExtra2);
                synchronized (DevicePolicyManagerService.this.getLockObject()) {
                    boolean isUserAffiliatedWithDeviceLocked = DevicePolicyManagerService.this.isUserAffiliatedWithDeviceLocked(intExtra2);
                    DevicePolicyManagerService.this.removeUserData(intExtra2);
                    if (!isUserAffiliatedWithDeviceLocked) {
                        DevicePolicyManagerService.this.discardDeviceWideLogsLocked();
                        DevicePolicyManagerService.this.maybeResumeDeviceWideLoggingLocked();
                    }
                }
                if (DevicePolicyManagerService.isPolicyEngineForFinanceFlagEnabled() || DevicePolicyManagerService.this.isPermissionCheckFlagEnabled()) {
                    DevicePolicyManagerService.this.mDevicePolicyEngine.handleUserRemoved(intExtra2);
                    return;
                }
                return;
            }
            if ("android.intent.action.USER_STARTED".equals(action)) {
                sendDeviceOwnerUserCommand("android.app.action.USER_STARTED", intExtra2);
                synchronized (DevicePolicyManagerService.this.getLockObject()) {
                    DevicePolicyManagerService.this.maybeSendAdminEnabledBroadcastLocked(intExtra2);
                    DevicePolicyManagerService.this.mUserData.remove(intExtra2);
                }
                DevicePolicyManagerService.this.handlePackagesChanged(null, intExtra2);
                DevicePolicyManagerService.this.updatePersonalAppsSuspensionOnUserStart(intExtra2);
                return;
            }
            if ("android.intent.action.USER_STOPPED".equals(action)) {
                sendDeviceOwnerUserCommand("android.app.action.USER_STOPPED", intExtra2);
                if (DevicePolicyManagerService.this.isManagedProfile(intExtra2)) {
                    Slogf.d("DevicePolicyManager", "Managed profile was stopped");
                    DevicePolicyManagerService.this.updatePersonalAppsSuspension(intExtra2);
                    return;
                }
                return;
            }
            if ("android.intent.action.USER_SWITCHED".equals(action)) {
                sendDeviceOwnerUserCommand("android.app.action.USER_SWITCHED", intExtra2);
                return;
            }
            if ("android.intent.action.USER_UNLOCKED".equals(action)) {
                synchronized (DevicePolicyManagerService.this.getLockObject()) {
                    DevicePolicyManagerService.this.maybeSendAdminEnabledBroadcastLocked(intExtra2);
                }
                if (DevicePolicyManagerService.this.isManagedProfile(intExtra2)) {
                    Slogf.d("DevicePolicyManager", "Managed profile became unlocked");
                    DevicePolicyManagerService.this.triggerPolicyComplianceCheckIfNeeded(intExtra2, DevicePolicyManagerService.this.updatePersonalAppsSuspension(intExtra2));
                    return;
                }
                return;
            }
            if ("android.intent.action.EXTERNAL_APPLICATIONS_UNAVAILABLE".equals(action)) {
                DevicePolicyManagerService.this.handlePackagesChanged(null, intExtra2);
                return;
            }
            if ("android.intent.action.PACKAGE_CHANGED".equals(action)) {
                DevicePolicyManagerService.this.handlePackagesChanged(intent.getData().getSchemeSpecificPart(), intExtra2);
                return;
            }
            if ("android.intent.action.PACKAGE_ADDED".equals(action)) {
                if (intent.getBooleanExtra("android.intent.extra.REPLACING", false)) {
                    DevicePolicyManagerService.this.handlePackagesChanged(intent.getData().getSchemeSpecificPart(), intExtra2);
                    return;
                } else {
                    DevicePolicyManagerService.this.handleNewPackageInstalled(intent.getData().getSchemeSpecificPart(), intExtra2);
                    return;
                }
            }
            if ("android.intent.action.PACKAGE_REMOVED".equals(action) && !intent.getBooleanExtra("android.intent.extra.REPLACING", false)) {
                DevicePolicyManagerService.this.handlePackagesChanged(intent.getData().getSchemeSpecificPart(), intExtra2);
                DevicePolicyManagerService.this.removeCredentialManagementApp(intent.getData().getSchemeSpecificPart());
                return;
            }
            if (DevicePolicyListener.ACTION_PROFILE_OWNER_ADDED.equals(action)) {
                DevicePolicyManagerService.this.clearWipeProfileNotification();
                return;
            }
            if ("android.intent.action.DATE_CHANGED".equals(action) || "android.intent.action.TIME_SET".equals(action)) {
                DevicePolicyManagerService.this.updateSystemUpdateFreezePeriodsRecord(true);
                DevicePolicyManagerService devicePolicyManagerService = DevicePolicyManagerService.this;
                int managedUserId = devicePolicyManagerService.getManagedUserId(devicePolicyManagerService.getMainUserId());
                if (managedUserId >= 0) {
                    DevicePolicyManagerService.this.updatePersonalAppsSuspension(managedUserId);
                    return;
                }
                return;
            }
            if (DevicePolicyManagerService.ACTION_PROFILE_OFF_DEADLINE.equals(action)) {
                Slogf.i("DevicePolicyManager", "Profile off deadline alarm was triggered");
                DevicePolicyManagerService devicePolicyManagerService2 = DevicePolicyManagerService.this;
                int managedUserId2 = devicePolicyManagerService2.getManagedUserId(devicePolicyManagerService2.getMainUserId());
                if (managedUserId2 >= 0) {
                    DevicePolicyManagerService.this.updatePersonalAppsSuspension(managedUserId2);
                    return;
                } else {
                    Slogf.wtf("DevicePolicyManager", "Got deadline alarm for nonexistent profile");
                    return;
                }
            }
            if (DevicePolicyManagerService.ACTION_TURN_PROFILE_ON_NOTIFICATION.equals(action)) {
                Slogf.i("DevicePolicyManager", "requesting to turn on the profile: " + intExtra2);
                DevicePolicyManagerService.this.mUserManager.requestQuietModeEnabled(false, UserHandle.of(intExtra2));
                return;
            }
            if ("android.intent.action.MANAGED_PROFILE_UNAVAILABLE".equals(action)) {
                DevicePolicyManagerService.this.notifyIfManagedSubscriptionsAreUnavailable(UserHandle.of(intExtra2), false);
                DevicePolicyManagerService.this.updatePersonalAppsSuspension(intExtra2);
            } else if ("android.intent.action.MANAGED_PROFILE_AVAILABLE".equals(action)) {
                DevicePolicyManagerService.this.notifyIfManagedSubscriptionsAreUnavailable(UserHandle.of(intExtra2), true);
                DevicePolicyManagerService.this.triggerPolicyComplianceCheckIfNeeded(intExtra2, DevicePolicyManagerService.this.updatePersonalAppsSuspension(intExtra2));
            } else if ("android.accounts.LOGIN_ACCOUNTS_CHANGED".equals(action)) {
                DevicePolicyManagerService.this.calculateHasIncompatibleAccounts();
            }
        }

        /* renamed from: com.android.server.devicepolicy.DevicePolicyManagerService$1$1 */
        /* loaded from: classes2.dex */
        public class RunnableC00151 implements Runnable {
            public final /* synthetic */ int val$userHandle;

            public RunnableC00151(int intExtra2) {
                r2 = intExtra2;
            }

            @Override // java.lang.Runnable
            public void run() {
                DevicePolicyManagerService.this.handlePasswordExpirationNotification(r2);
            }
        }

        public final void sendDeviceOwnerUserCommand(String str, int i) {
            synchronized (DevicePolicyManagerService.this.getLockObject()) {
                ActiveAdmin deviceOwnerAdminLocked = DevicePolicyManagerService.this.getDeviceOwnerAdminLocked();
                if (deviceOwnerAdminLocked != null) {
                    Bundle bundle = new Bundle();
                    bundle.putParcelable("android.intent.extra.USER", UserHandle.of(i));
                    DevicePolicyManagerService.this.sendAdminCommandLocked(deviceOwnerAdminLocked, str, bundle, null, true);
                }
            }
        }
    }

    /* loaded from: classes2.dex */
    public class RestrictionsListener implements UserManagerInternal.UserRestrictionsListener {
        public final Context mContext;
        public final DevicePolicyManagerService mDpms;
        public final UserManagerInternal mUserManagerInternal;

        public RestrictionsListener(Context context, UserManagerInternal userManagerInternal, DevicePolicyManagerService devicePolicyManagerService) {
            this.mContext = context;
            this.mUserManagerInternal = userManagerInternal;
            this.mDpms = devicePolicyManagerService;
        }

        @Override // com.android.server.pm.UserManagerInternal.UserRestrictionsListener
        public void onUserRestrictionsChanged(int i, Bundle bundle, Bundle bundle2) {
            resetCrossProfileIntentFiltersIfNeeded(i, bundle, bundle2);
            resetUserVpnIfNeeded(i, bundle, bundle2);
        }

        public final void resetUserVpnIfNeeded(int i, Bundle bundle, Bundle bundle2) {
            if (!bundle2.getBoolean("no_config_vpn") && bundle.getBoolean("no_config_vpn")) {
                this.mDpms.clearUserConfiguredVpns(i);
            }
        }

        public final void resetCrossProfileIntentFiltersIfNeeded(int i, Bundle bundle, Bundle bundle2) {
            int profileParentId;
            if (!UserRestrictionsUtils.restrictionsChanged(bundle2, bundle, "no_sharing_into_profile") || (profileParentId = this.mUserManagerInternal.getProfileParentId(i)) == i) {
                return;
            }
            Slogf.i("DevicePolicyManager", "Resetting cross-profile intent filters on restriction change");
            this.mDpms.resetDefaultCrossProfileIntentFilters(profileParentId);
            try {
                this.mContext.sendBroadcastAsUser(new Intent("android.app.action.DATA_SHARING_RESTRICTION_APPLIED"), UserHandle.of(i));
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    public final void clearUserConfiguredVpns(int i) {
        synchronized (getLockObject()) {
            ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(i);
            if (deviceOrProfileOwnerAdminLocked == null) {
                Slogf.wtf("DevicePolicyManager", "Admin not found");
                return;
            }
            String str = deviceOrProfileOwnerAdminLocked.mAlwaysOnVpnPackage;
            if (str == null) {
                this.mInjector.getVpnManager().setAlwaysOnVpnPackageForUser(i, null, false, null);
            }
            List<AppOpsManager.PackageOps> packagesForOps = this.mInjector.getAppOpsManager().getPackagesForOps(new int[]{47});
            if (packagesForOps == null) {
                return;
            }
            for (AppOpsManager.PackageOps packageOps : packagesForOps) {
                if (UserHandle.getUserId(packageOps.getUid()) == i && !packageOps.getPackageName().equals(str)) {
                    if (packageOps.getOps().size() != 1) {
                        Slogf.wtf("DevicePolicyManager", "Unexpected number of ops returned");
                    } else if (((AppOpsManager.OpEntry) packageOps.getOps().get(0)).getMode() == 0) {
                        Slogf.i("DevicePolicyManager", String.format("Revoking VPN authorization for package %s uid %d", packageOps.getPackageName(), Integer.valueOf(packageOps.getUid())));
                        this.mInjector.getAppOpsManager().setMode(47, packageOps.getUid(), packageOps.getPackageName(), 3);
                    }
                }
            }
        }
    }

    /* loaded from: classes2.dex */
    public final class UserLifecycleListener implements UserManagerInternal.UserLifecycleListener {
        public /* synthetic */ UserLifecycleListener(DevicePolicyManagerService devicePolicyManagerService, UserLifecycleListenerIA userLifecycleListenerIA) {
            this();
        }

        public UserLifecycleListener() {
        }

        public /* synthetic */ void lambda$onUserCreated$0(UserInfo userInfo, Object obj) {
            DevicePolicyManagerService.this.handleNewUserCreated(userInfo, obj);
        }

        @Override // com.android.server.pm.UserManagerInternal.UserLifecycleListener
        public void onUserCreated(final UserInfo userInfo, final Object obj) {
            DevicePolicyManagerService.this.mHandler.post(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$UserLifecycleListener$$ExternalSyntheticLambda0
                @Override // java.lang.Runnable
                public final void run() {
                    DevicePolicyManagerService.UserLifecycleListener.this.lambda$onUserCreated$0(userInfo, obj);
                }
            });
        }
    }

    public void setCrossProfileAppToIgnored(int i, String str) {
        if (this.mInjector.binderGetCallingUid() != 1000) {
            return;
        }
        setCrossProfileAppToIgnored(str, i);
    }

    public final void setCrossProfileAppToIgnored(String str, int i) {
        long clearCallingIdentity = Binder.clearCallingIdentity();
        try {
            try {
            } catch (RemoteException unused) {
                Slogf.d("DevicePolicyManager", "RemoteException : setCrossProfileAppToIgnored " + str + " for user " + i);
            }
            if (SemPersonaManager.isSecureFolderId(i)) {
                return;
            }
            if (this.mUserManager.isManagedProfile(i)) {
                if (this.mIPackageManager.getPackageInfo(str, 0L, i) == null) {
                    return;
                }
                if (str != null && !str.contains("google")) {
                    this.mInjector.getCrossProfileApps().setInteractAcrossProfilesAppOp(str, 1);
                }
            }
        } finally {
            Binder.restoreCallingIdentity(clearCallingIdentity);
        }
    }

    public final void handlePackagesChanged(String str, int i) {
        boolean z;
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
        Log.d("DevicePolicyManager", " handle packages changed  setCrossProfileAppToIgnored " + str + " " + i);
        setCrossProfileAppToIgnored(str, i);
        synchronized (getLockObject()) {
            boolean z2 = false;
            String str2 = null;
            z = false;
            for (int size = lambda$getUserDataUnchecked$2.mAdminList.size() - 1; size >= 0; size--) {
                ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(size);
                try {
                    String packageName = activeAdmin.info.getPackageName();
                    if ((str == null || str.equals(packageName)) && (this.mIPackageManager.getPackageInfo(packageName, 0L, i) == null || this.mIPackageManager.getReceiverInfo(activeAdmin.info.getComponent(), 786432L, i) == null)) {
                        Slogf.e("DevicePolicyManager", String.format("Admin package %s not found for user %d, removing active admin", str, Integer.valueOf(i)));
                        try {
                            lambda$getUserDataUnchecked$2.mAdminList.remove(size);
                            lambda$getUserDataUnchecked$2.mAdminMap.remove(activeAdmin.info.getComponent());
                            pushActiveAdminPackagesLocked(i);
                            lambda$getUserDataUnchecked$2.validatePasswordOwner();
                            saveSettingsLocked(lambda$getUserDataUnchecked$2.mUserId);
                            z = true;
                            str2 = packageName;
                        } catch (RemoteException e) {
                            e = e;
                            z = true;
                            str2 = packageName;
                            Slogf.wtf("DevicePolicyManager", "Error handling package changes", e);
                        }
                    }
                } catch (RemoteException e2) {
                    e = e2;
                }
            }
            if (z) {
                lambda$getUserDataUnchecked$2.validatePasswordOwner();
            }
            for (int size2 = lambda$getUserDataUnchecked$2.mDelegationMap.size() - 1; size2 >= 0; size2--) {
                if (isRemovedPackage(str, (String) lambda$getUserDataUnchecked$2.mDelegationMap.keyAt(size2), i)) {
                    lambda$getUserDataUnchecked$2.mDelegationMap.removeAt(size2);
                    z2 = true;
                }
            }
            ComponentName ownerComponent = getOwnerComponent(i);
            if (str != null && ownerComponent != null && ownerComponent.getPackageName().equals(str)) {
                startOwnerService(i, "package-broadcast");
            }
            if (isPolicyEngineForFinanceFlagEnabled() || isPermissionCheckFlagEnabled()) {
                this.mDevicePolicyEngine.handlePackageChanged(str, i, str2);
            }
            if (z || z2) {
                saveSettingsLocked(lambda$getUserDataUnchecked$2.mUserId);
            }
        }
        if (z) {
            pushUserRestrictions(i);
            pushMeteredDisabledPackages(i);
            pushCameraRestrictionForRemovingAdmin(i);
        }
    }

    public final void removeCredentialManagementApp(final String str) {
        this.mBackgroundHandler.post(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda219
            @Override // java.lang.Runnable
            public final void run() {
                DevicePolicyManagerService.this.lambda$removeCredentialManagementApp$0(str);
            }
        });
    }

    public /* synthetic */ void lambda$removeCredentialManagementApp$0(String str) {
        try {
            KeyChain.KeyChainConnection keyChainBind = this.mInjector.keyChainBind();
            try {
                IKeyChainService service = keyChainBind.getService();
                if (service.hasCredentialManagementApp() && str.equals(service.getCredentialManagementAppPackageName())) {
                    service.removeCredentialManagementApp();
                }
                keyChainBind.close();
            } catch (Throwable th) {
                if (keyChainBind != null) {
                    try {
                        keyChainBind.close();
                    } catch (Throwable th2) {
                        th.addSuppressed(th2);
                    }
                }
                throw th;
            }
        } catch (RemoteException | AssertionError | IllegalStateException | InterruptedException e) {
            Slogf.e("DevicePolicyManager", "Unable to remove the credential management app", e);
        }
    }

    public final boolean isRemovedPackage(String str, String str2, int i) {
        if (str2 == null) {
            return false;
        }
        if (str != null) {
            try {
                if (!str.equals(str2)) {
                    return false;
                }
            } catch (RemoteException e) {
                Slogf.wtf("DevicePolicyManager", "Error checking isRemovedPackage", e);
                return false;
            }
        }
        return this.mIPackageManager.getPackageInfo(str2, 0L, i) == null;
    }

    public final void handleNewPackageInstalled(String str, int i) {
        if (lambda$getUserDataUnchecked$2(i).mAppsSuspended) {
            String[] strArr = {str};
            if (this.mInjector.getPackageManager(i).getUnsuspendablePackages(strArr).length != 0) {
                Slogf.i("DevicePolicyManager", "Newly installed package is unsuspendable: " + str);
                return;
            }
            setCrossProfileAppToIgnored(str, i);
            this.mInjector.getPackageManagerInternal().setPackagesSuspendedByAdmin(i, strArr, true);
        }
    }

    public void setDevicePolicySafetyChecker(DevicePolicySafetyChecker devicePolicySafetyChecker) {
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(this.mIsAutomotive || isAdb(callerIdentity), "can only set DevicePolicySafetyChecker on automotive builds or from ADB (but caller is %s)", new Object[]{callerIdentity});
        setDevicePolicySafetyCheckerUnchecked(devicePolicySafetyChecker);
    }

    public void setDevicePolicySafetyCheckerUnchecked(DevicePolicySafetyChecker devicePolicySafetyChecker) {
        Slogf.i("DevicePolicyManager", "Setting DevicePolicySafetyChecker as %s", devicePolicySafetyChecker);
        this.mSafetyChecker = devicePolicySafetyChecker;
        this.mInjector.setDevicePolicySafetyChecker(devicePolicySafetyChecker);
    }

    public DevicePolicySafetyChecker getDevicePolicySafetyChecker() {
        return this.mSafetyChecker;
    }

    public final void checkCanExecuteOrThrowUnsafe(int i) {
        int unsafeOperationReason = getUnsafeOperationReason(i);
        if (unsafeOperationReason == -1) {
            return;
        }
        DevicePolicySafetyChecker devicePolicySafetyChecker = this.mSafetyChecker;
        if (devicePolicySafetyChecker == null) {
            throw new UnsafeStateException(i, unsafeOperationReason);
        }
        throw devicePolicySafetyChecker.newUnsafeStateException(i, unsafeOperationReason);
    }

    public int getUnsafeOperationReason(int i) {
        DevicePolicySafetyChecker devicePolicySafetyChecker = this.mSafetyChecker;
        if (devicePolicySafetyChecker == null) {
            return -1;
        }
        return devicePolicySafetyChecker.getUnsafeOperationReason(i);
    }

    public void setNextOperationSafety(int i, int i2) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_DEVICE_ADMINS"));
        Slogf.i("DevicePolicyManager", "setNextOperationSafety(%s, %s)", DevicePolicyManager.operationToString(i), DevicePolicyManager.operationSafetyReasonToString(i2));
        this.mSafetyChecker = new OneTimeSafetyChecker(this, i, i2);
    }

    public boolean isSafeOperation(int i) {
        DevicePolicySafetyChecker devicePolicySafetyChecker = this.mSafetyChecker;
        if (devicePolicySafetyChecker == null) {
            return true;
        }
        return devicePolicySafetyChecker.isSafeOperation(i);
    }

    public List listAllOwners() {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_DEVICE_ADMINS"));
        return (List) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda117
            public final Object getOrThrow() {
                List lambda$listAllOwners$1;
                lambda$listAllOwners$1 = DevicePolicyManagerService.this.lambda$listAllOwners$1();
                return lambda$listAllOwners$1;
            }
        });
    }

    public /* synthetic */ List lambda$listAllOwners$1() {
        SparseArray sparseArray;
        List listAllOwners = this.mOwners.listAllOwners();
        synchronized (getLockObject()) {
            for (int i = 0; i < listAllOwners.size(); i++) {
                OwnerShellData ownerShellData = (OwnerShellData) listAllOwners.get(i);
                ownerShellData.isAffiliated = isUserAffiliatedWithDeviceLocked(ownerShellData.userId);
            }
            sparseArray = this.mUserData;
        }
        for (int i2 = 0; i2 < sparseArray.size(); i2++) {
            DevicePolicyData devicePolicyData = (DevicePolicyData) this.mUserData.valueAt(i2);
            int keyAt = sparseArray.keyAt(i2);
            int profileParentId = this.mUserManagerInternal.getProfileParentId(keyAt);
            if (profileParentId != keyAt) {
                for (int i3 = 0; i3 < devicePolicyData.mAdminList.size(); i3++) {
                    listAllOwners.add(OwnerShellData.forManagedProfileOwner(keyAt, profileParentId, ((ActiveAdmin) devicePolicyData.mAdminList.get(i3)).info.getComponent()));
                }
            }
        }
        return listAllOwners;
    }

    /* loaded from: classes2.dex */
    public class Injector {
        public final Context mContext;
        public DevicePolicySafetyChecker mSafetyChecker;

        public boolean isDeviceSupportKnoxSDP() {
            return false;
        }

        public Injector(Context context) {
            this.mContext = context;
        }

        public boolean hasFeature() {
            return getPackageManager().hasSystemFeature("android.software.device_admin");
        }

        public Context createContextAsUser(UserHandle userHandle) {
            return this.mContext.createPackageContextAsUser(this.mContext.getPackageName(), 0, userHandle);
        }

        public Resources getResources() {
            return this.mContext.getResources();
        }

        public UserManager getUserManager() {
            return UserManager.get(this.mContext);
        }

        public UserManagerInternal getUserManagerInternal() {
            return (UserManagerInternal) LocalServices.getService(UserManagerInternal.class);
        }

        public PackageManagerInternal getPackageManagerInternal() {
            return (PackageManagerInternal) LocalServices.getService(PackageManagerInternal.class);
        }

        public PackageManagerLocal getPackageManagerLocal() {
            return (PackageManagerLocal) LocalManagerRegistry.getManager(PackageManagerLocal.class);
        }

        public ActivityTaskManagerInternal getActivityTaskManagerInternal() {
            return (ActivityTaskManagerInternal) LocalServices.getService(ActivityTaskManagerInternal.class);
        }

        public PermissionControllerManager getPermissionControllerManager(UserHandle userHandle) {
            if (userHandle.equals(this.mContext.getUser())) {
                return (PermissionControllerManager) this.mContext.getSystemService(PermissionControllerManager.class);
            }
            try {
                Context context = this.mContext;
                return (PermissionControllerManager) context.createPackageContextAsUser(context.getPackageName(), 0, userHandle).getSystemService(PermissionControllerManager.class);
            } catch (PackageManager.NameNotFoundException e) {
                throw new IllegalStateException(e);
            }
        }

        public UsageStatsManagerInternal getUsageStatsManagerInternal() {
            return (UsageStatsManagerInternal) LocalServices.getService(UsageStatsManagerInternal.class);
        }

        public NetworkPolicyManagerInternal getNetworkPolicyManagerInternal() {
            return (NetworkPolicyManagerInternal) LocalServices.getService(NetworkPolicyManagerInternal.class);
        }

        public NotificationManager getNotificationManager() {
            return (NotificationManager) this.mContext.getSystemService(NotificationManager.class);
        }

        public IIpConnectivityMetrics getIIpConnectivityMetrics() {
            return IIpConnectivityMetrics.Stub.asInterface(ServiceManager.getService("connmetrics"));
        }

        public PackageManager getPackageManager() {
            return this.mContext.getPackageManager();
        }

        public PackageManager getPackageManager(int i) {
            try {
                return createContextAsUser(UserHandle.of(i)).getPackageManager();
            } catch (PackageManager.NameNotFoundException e) {
                throw new IllegalStateException(e);
            }
        }

        public PowerManagerInternal getPowerManagerInternal() {
            return (PowerManagerInternal) LocalServices.getService(PowerManagerInternal.class);
        }

        public TelephonyManager getTelephonyManager() {
            return (TelephonyManager) this.mContext.getSystemService(TelephonyManager.class);
        }

        public RoleManager getRoleManager() {
            return (RoleManager) this.mContext.getSystemService(RoleManager.class);
        }

        public TrustManager getTrustManager() {
            return (TrustManager) this.mContext.getSystemService("trust");
        }

        public AlarmManager getAlarmManager() {
            return (AlarmManager) this.mContext.getSystemService(AlarmManager.class);
        }

        public AlarmManagerInternal getAlarmManagerInternal() {
            return (AlarmManagerInternal) LocalServices.getService(AlarmManagerInternal.class);
        }

        public ConnectivityManager getConnectivityManager() {
            return (ConnectivityManager) this.mContext.getSystemService(ConnectivityManager.class);
        }

        public VpnManager getVpnManager() {
            return (VpnManager) this.mContext.getSystemService(VpnManager.class);
        }

        public LocationManager getLocationManager() {
            return (LocationManager) this.mContext.getSystemService(LocationManager.class);
        }

        public IWindowManager getIWindowManager() {
            return IWindowManager.Stub.asInterface(ServiceManager.getService("window"));
        }

        public IActivityManager getIActivityManager() {
            return ActivityManager.getService();
        }

        public IActivityTaskManager getIActivityTaskManager() {
            return ActivityTaskManager.getService();
        }

        public ActivityManagerInternal getActivityManagerInternal() {
            return (ActivityManagerInternal) LocalServices.getService(ActivityManagerInternal.class);
        }

        public IPackageManager getIPackageManager() {
            return AppGlobals.getPackageManager();
        }

        public IPermissionManager getIPermissionManager() {
            return AppGlobals.getPermissionManager();
        }

        public IBackupManager getIBackupManager() {
            return IBackupManager.Stub.asInterface(ServiceManager.getService("backup"));
        }

        public PersistentDataBlockManagerInternal getPersistentDataBlockManagerInternal() {
            return (PersistentDataBlockManagerInternal) LocalServices.getService(PersistentDataBlockManagerInternal.class);
        }

        public AppOpsManager getAppOpsManager() {
            return (AppOpsManager) this.mContext.getSystemService(AppOpsManager.class);
        }

        public LockSettingsInternal getLockSettingsInternal() {
            return (LockSettingsInternal) LocalServices.getService(LockSettingsInternal.class);
        }

        public CrossProfileApps getCrossProfileApps() {
            return (CrossProfileApps) this.mContext.getSystemService(CrossProfileApps.class);
        }

        public CrossProfileApps getCrossProfileApps(int i) {
            return (CrossProfileApps) this.mContext.createContextAsUser(UserHandle.of(i), 0).getSystemService(CrossProfileApps.class);
        }

        public boolean hasUserSetupCompleted(DevicePolicyData devicePolicyData) {
            return devicePolicyData.mUserSetupComplete;
        }

        public boolean isBuildDebuggable() {
            return Build.IS_DEBUGGABLE;
        }

        public LockPatternUtils newLockPatternUtils() {
            return new LockPatternUtils(this.mContext);
        }

        public EnterpriseSpecificIdCalculator newEnterpriseSpecificIdCalculator() {
            return new EnterpriseSpecificIdCalculator(this.mContext);
        }

        public boolean storageManagerIsFileBasedEncryptionEnabled() {
            return StorageManager.isFileEncrypted();
        }

        public Looper getMyLooper() {
            return Looper.myLooper();
        }

        public WifiManager getWifiManager() {
            return (WifiManager) this.mContext.getSystemService(WifiManager.class);
        }

        public UsbManager getUsbManager() {
            return (UsbManager) this.mContext.getSystemService(UsbManager.class);
        }

        public long binderClearCallingIdentity() {
            return Binder.clearCallingIdentity();
        }

        public void binderRestoreCallingIdentity(long j) {
            Binder.restoreCallingIdentity(j);
        }

        public int binderGetCallingUid() {
            return Binder.getCallingUid();
        }

        public int binderGetCallingPid() {
            return Binder.getCallingPid();
        }

        public UserHandle binderGetCallingUserHandle() {
            return Binder.getCallingUserHandle();
        }

        public boolean binderIsCallingUidMyUid() {
            return Binder.getCallingUid() == Process.myUid();
        }

        public void binderWithCleanCallingIdentity(FunctionalUtils.ThrowingRunnable throwingRunnable) {
            Binder.withCleanCallingIdentity(throwingRunnable);
        }

        public final Object binderWithCleanCallingIdentity(FunctionalUtils.ThrowingSupplier throwingSupplier) {
            return Binder.withCleanCallingIdentity(throwingSupplier);
        }

        public final int userHandleGetCallingUserId() {
            return UserHandle.getUserId(binderGetCallingUid());
        }

        public void powerManagerGoToSleep(long j, int i, int i2) {
            ((PowerManager) this.mContext.getSystemService(PowerManager.class)).goToSleep(j, i, i2);
        }

        public void powerManagerReboot(String str) {
            ((PowerManager) this.mContext.getSystemService(PowerManager.class)).reboot(str);
        }

        public boolean recoverySystemRebootWipeUserData(boolean z, String str, boolean z2, boolean z3, boolean z4, boolean z5) {
            return FactoryResetter.newBuilder(this.mContext).setSafetyChecker(this.mSafetyChecker).setReason(str).setShutdown(z).setForce(z2).setWipeEuicc(z3).setWipeAdoptableStorage(z4).setWipeFactoryResetProtection(z5).build().factoryReset();
        }

        public boolean systemPropertiesGetBoolean(String str, boolean z) {
            return SystemProperties.getBoolean(str, z);
        }

        public long systemPropertiesGetLong(String str, long j) {
            return SystemProperties.getLong(str, j);
        }

        public String systemPropertiesGet(String str, String str2) {
            return SystemProperties.get(str, str2);
        }

        public String systemPropertiesGet(String str) {
            return SystemProperties.get(str);
        }

        public void systemPropertiesSet(String str, String str2) {
            SystemProperties.set(str, str2);
        }

        public boolean userManagerIsHeadlessSystemUserMode() {
            return UserManager.isHeadlessSystemUserMode();
        }

        public PendingIntent pendingIntentGetActivityAsUser(Context context, int i, Intent intent, int i2, Bundle bundle, UserHandle userHandle) {
            return PendingIntent.getActivityAsUser(context, i, intent, i2, bundle, userHandle);
        }

        public PendingIntent pendingIntentGetBroadcast(Context context, int i, Intent intent, int i2) {
            return PendingIntent.getBroadcast(context, i, intent, i2);
        }

        public void registerContentObserver(Uri uri, boolean z, ContentObserver contentObserver, int i) {
            this.mContext.getContentResolver().registerContentObserver(uri, z, contentObserver, i);
        }

        public int settingsSecureGetIntForUser(String str, int i, int i2) {
            return Settings.Secure.getIntForUser(this.mContext.getContentResolver(), str, i, i2);
        }

        public String settingsSecureGetStringForUser(String str, int i) {
            return Settings.Secure.getStringForUser(this.mContext.getContentResolver(), str, i);
        }

        public void settingsSecurePutIntForUser(String str, int i, int i2) {
            Settings.Secure.putIntForUser(this.mContext.getContentResolver(), str, i, i2);
        }

        public void settingsSecurePutStringForUser(String str, String str2, int i) {
            Settings.Secure.putStringForUser(this.mContext.getContentResolver(), str, str2, i);
        }

        public void settingsGlobalPutStringForUser(String str, String str2, int i) {
            Settings.Global.putStringForUser(this.mContext.getContentResolver(), str, str2, i);
        }

        public int settingsGlobalGetInt(String str, int i) {
            return Settings.Global.getInt(this.mContext.getContentResolver(), str, i);
        }

        public String settingsGlobalGetString(String str) {
            return Settings.Global.getString(this.mContext.getContentResolver(), str);
        }

        public void settingsGlobalPutInt(String str, int i) {
            Settings.Global.putInt(this.mContext.getContentResolver(), str, i);
        }

        public void settingsGlobalPutString(String str, String str2) {
            Settings.Global.putString(this.mContext.getContentResolver(), str, str2);
        }

        public void settingsSystemPutStringForUser(String str, String str2, int i) {
            Settings.System.putStringForUser(this.mContext.getContentResolver(), str, str2, i);
        }

        public void securityLogSetLoggingEnabledProperty(boolean z) {
            SecurityLog.setLoggingEnabledProperty(z);
        }

        public boolean securityLogGetLoggingEnabledProperty() {
            return SecurityLog.getLoggingEnabledProperty();
        }

        public boolean securityLogIsLoggingEnabled() {
            return SecurityLog.isLoggingEnabled();
        }

        public KeyChain.KeyChainConnection keyChainBind() {
            return KeyChain.bind(this.mContext);
        }

        public KeyChain.KeyChainConnection keyChainBindAsUser(UserHandle userHandle) {
            return KeyChain.bindAsUser(this.mContext, userHandle);
        }

        public void postOnSystemServerInitThreadPool(Runnable runnable) {
            SystemServerInitThreadPool.submit(runnable, "DevicePolicyManager");
        }

        public TransferOwnershipMetadataManager newTransferOwnershipMetadataManager() {
            return new TransferOwnershipMetadataManager();
        }

        public void runCryptoSelfTest() {
            CryptoTestHelper.runAndLogSelfTest();
        }

        public IEnterpriseDeviceManager getIEDMService() {
            return IEnterpriseDeviceManager.Stub.asInterface(ServiceManager.getService("enterprise_policy"));
        }

        public EnterpriseDeviceManager getEDM() {
            return EnterpriseDeviceManager.getInstance(this.mContext);
        }

        public IEnterpriseLicense getLicenseService() {
            return IEnterpriseLicense.Stub.asInterface(ServiceManager.getService("enterprise_license_policy"));
        }

        public IRestrictionPolicy getRestrictionService() {
            return IRestrictionPolicy.Stub.asInterface(ServiceManager.getService("restriction_policy"));
        }

        public IMiscPolicy getMiscService() {
            return IMiscPolicy.Stub.asInterface(ServiceManager.getService("misc_policy"));
        }

        public IWifiPolicy getWifiService() {
            return IWifiPolicy.Stub.asInterface(ServiceManager.getService("wifi_policy"));
        }

        public IKnoxCustomManager getKCMService() {
            return IKnoxCustomManager.Stub.asInterface(ServiceManager.getService(KnoxCustomManagerService.KNOX_CUSTOM_MANAGER_SERVICE));
        }

        public final PowerManager.WakeLock powerManagerNewWakeLock(int i, String str) {
            return ((PowerManager) this.mContext.getSystemService(PowerManager.class)).newWakeLock(i, str);
        }

        public String[] getPersonalAppsForSuspension(int i) {
            return PersonalAppsSuspensionHelper.forUser(this.mContext, i).getPersonalAppsForSuspension();
        }

        public long systemCurrentTimeMillis() {
            return System.currentTimeMillis();
        }

        public boolean isChangeEnabled(long j, String str, int i) {
            return CompatChanges.isChangeEnabled(j, str, UserHandle.of(i));
        }

        public void setDevicePolicySafetyChecker(DevicePolicySafetyChecker devicePolicySafetyChecker) {
            this.mSafetyChecker = devicePolicySafetyChecker;
        }

        public boolean personaManagerIsContainerService() {
            return KnoxUtils.isSpfKnoxSupported() && SemPersonaManager.isContainerServicebyUID(binderGetCallingUid());
        }

        public KnoxContainerManager getKCM(int i) {
            EnterpriseKnoxManager enterpriseKnoxManager = EnterpriseKnoxManager.getInstance();
            if (enterpriseKnoxManager != null) {
                return enterpriseKnoxManager.getKnoxContainerManager(this.mContext, i);
            }
            return null;
        }

        public void postContainerAnalytics(long j, int i) {
            PersonaManagerService personaManagerService = (PersonaManagerService) ServiceManager.getService("persona");
            if (personaManagerService == null || !SemPersonaManager.isKnoxId(i)) {
                return;
            }
            new Handler(this.mContext.getMainLooper()).postDelayed(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService.Injector.1
                public final /* synthetic */ PersonaManagerService val$personaService;
                public final /* synthetic */ long val$timeMs;
                public final /* synthetic */ int val$userHandle;

                public AnonymousClass1(PersonaManagerService personaManagerService2, long j2, int i2) {
                    r2 = personaManagerService2;
                    r3 = j2;
                    r5 = i2;
                }

                @Override // java.lang.Runnable
                public void run() {
                    Log.i("DevicePolicyManager", "notify persona to may log analytics");
                    r2.notifyPersona(r3, r5);
                }
            }, 300L);
        }

        /* renamed from: com.android.server.devicepolicy.DevicePolicyManagerService$Injector$1 */
        /* loaded from: classes2.dex */
        public class AnonymousClass1 implements Runnable {
            public final /* synthetic */ PersonaManagerService val$personaService;
            public final /* synthetic */ long val$timeMs;
            public final /* synthetic */ int val$userHandle;

            public AnonymousClass1(PersonaManagerService personaManagerService2, long j2, int i2) {
                r2 = personaManagerService2;
                r3 = j2;
                r5 = i2;
            }

            @Override // java.lang.Runnable
            public void run() {
                Log.i("DevicePolicyManager", "notify persona to may log analytics");
                r2.notifyPersona(r3, r5);
            }
        }

        public boolean verifyDeviceIntegrity() {
            IDarManagerService asInterface = IDarManagerService.Stub.asInterface(ServiceManager.getService("dar"));
            if (asInterface != null) {
                try {
                    return asInterface.isKnoxKeyInstallable();
                } catch (RemoteException e) {
                    Log.e("DevicePolicyManager", "check Device Integrity - RemoteException : " + e);
                    return false;
                }
            }
            Log.d("DevicePolicyManager", "check Device Integrity - failed. cannot get DAR Service");
            return false;
        }

        public boolean isDeviceRootKeyInstalled() {
            IDarManagerService asInterface = IDarManagerService.Stub.asInterface(ServiceManager.getService("dar"));
            if (asInterface != null) {
                try {
                    return asInterface.isDeviceRootKeyInstalled();
                } catch (RemoteException e) {
                    Log.e("DevicePolicyManager", "check Device Root Key - RemoteException : " + e);
                    return false;
                }
            }
            Log.d("DevicePolicyManager", "check Device Root Key - failed. cannot get DAR Service");
            return false;
        }

        public void notifyDeviceOwnerChanged() {
            if (isDeviceSupportKnoxSDP()) {
                long binderClearCallingIdentity = binderClearCallingIdentity();
                try {
                    try {
                        DarManagerService darManagerService = (DarManagerService) ServiceManager.getService("dar");
                        if (darManagerService != null) {
                            darManagerService.handleDeviceOwnerChanged();
                        }
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                } finally {
                    binderRestoreCallingIdentity(binderClearCallingIdentity);
                }
            }
        }

        public DualDarProvisioningHelper getDualDarProvisioningHelper(UserManagerInternal userManagerInternal) {
            return new DualDarProvisioningHelper(this.mContext, userManagerInternal);
        }

        public DeviceManagementResourcesProvider getDeviceManagementResourcesProvider() {
            return new DeviceManagementResourcesProvider();
        }
    }

    public DevicePolicyManagerService(Context context) {
        this(new Injector(context.createAttributionContext("DevicePolicyManagerService")), new PolicyPathProvider() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService.2
        });
    }

    public DevicePolicyManagerService(Injector injector, PolicyPathProvider policyPathProvider) {
        this.mPolicyCache = new DevicePolicyCacheImpl();
        this.mStateCache = new DeviceStateCacheImpl();
        this.mESIDInitilizationLock = new Object();
        this.mSubscriptionsChangedListenerLock = new Object();
        this.mNotifyChanges = true;
        this.oldAllowWifi = true;
        this.mPackagesToRemove = new ArraySet();
        this.mToken = new Binder();
        this.mLogoutUserId = -10000;
        this.mNetworkLoggingNotificationUserId = -10000;
        this.mStatLogger = new StatLogger(new String[]{"LockGuard.guard()"});
        this.mLockDoNoUseDirectly = LockGuard.installNewLock(8, true);
        this.mPendingUserCreatedCallbackTokens = new ArrayList();
        AnonymousClass1 anonymousClass1 = new BroadcastReceiver() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService.1
            public AnonymousClass1() {
            }

            @Override // android.content.BroadcastReceiver
            public void onReceive(Context context, Intent intent) {
                String action = intent.getAction();
                int intExtra2 = intent.getIntExtra("android.intent.extra.user_handle", getSendingUserId());
                if ("android.intent.action.USER_STARTED".equals(action) && intExtra2 == 0) {
                    synchronized (DevicePolicyManagerService.this.getLockObject()) {
                        if (DevicePolicyManagerService.this.isNetworkLoggingEnabledInternalLocked()) {
                            DevicePolicyManagerService.this.setNetworkLoggingActiveInternal(true);
                        }
                    }
                }
                if ("android.intent.action.BOOT_COMPLETED".equals(action)) {
                    DevicePolicyManagerService.this.calculateHasIncompatibleAccounts();
                }
                if ("android.intent.action.BOOT_COMPLETED".equals(action) && intExtra2 == DevicePolicyManagerService.this.mOwners.getDeviceOwnerUserId()) {
                    DevicePolicyManagerService.this.mBugreportCollectionManager.checkForPendingBugreportAfterBoot();
                }
                if ("android.intent.action.BOOT_COMPLETED".equals(action) || "com.android.server.ACTION_EXPIRED_PASSWORD_NOTIFICATION".equals(action)) {
                    DevicePolicyManagerService.this.mHandler.post(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService.1.1
                        public final /* synthetic */ int val$userHandle;

                        public RunnableC00151(int intExtra22) {
                            r2 = intExtra22;
                        }

                        @Override // java.lang.Runnable
                        public void run() {
                            DevicePolicyManagerService.this.handlePasswordExpirationNotification(r2);
                        }
                    });
                }
                if ("android.intent.action.USER_ADDED".equals(action)) {
                    sendDeviceOwnerUserCommand("android.app.action.USER_ADDED", intExtra22);
                    synchronized (DevicePolicyManagerService.this.getLockObject()) {
                        DevicePolicyManagerService.this.maybePauseDeviceWideLoggingLocked();
                    }
                    return;
                }
                if ("android.intent.action.USER_REMOVED".equals(action)) {
                    sendDeviceOwnerUserCommand("android.app.action.USER_REMOVED", intExtra22);
                    synchronized (DevicePolicyManagerService.this.getLockObject()) {
                        boolean isUserAffiliatedWithDeviceLocked = DevicePolicyManagerService.this.isUserAffiliatedWithDeviceLocked(intExtra22);
                        DevicePolicyManagerService.this.removeUserData(intExtra22);
                        if (!isUserAffiliatedWithDeviceLocked) {
                            DevicePolicyManagerService.this.discardDeviceWideLogsLocked();
                            DevicePolicyManagerService.this.maybeResumeDeviceWideLoggingLocked();
                        }
                    }
                    if (DevicePolicyManagerService.isPolicyEngineForFinanceFlagEnabled() || DevicePolicyManagerService.this.isPermissionCheckFlagEnabled()) {
                        DevicePolicyManagerService.this.mDevicePolicyEngine.handleUserRemoved(intExtra22);
                        return;
                    }
                    return;
                }
                if ("android.intent.action.USER_STARTED".equals(action)) {
                    sendDeviceOwnerUserCommand("android.app.action.USER_STARTED", intExtra22);
                    synchronized (DevicePolicyManagerService.this.getLockObject()) {
                        DevicePolicyManagerService.this.maybeSendAdminEnabledBroadcastLocked(intExtra22);
                        DevicePolicyManagerService.this.mUserData.remove(intExtra22);
                    }
                    DevicePolicyManagerService.this.handlePackagesChanged(null, intExtra22);
                    DevicePolicyManagerService.this.updatePersonalAppsSuspensionOnUserStart(intExtra22);
                    return;
                }
                if ("android.intent.action.USER_STOPPED".equals(action)) {
                    sendDeviceOwnerUserCommand("android.app.action.USER_STOPPED", intExtra22);
                    if (DevicePolicyManagerService.this.isManagedProfile(intExtra22)) {
                        Slogf.d("DevicePolicyManager", "Managed profile was stopped");
                        DevicePolicyManagerService.this.updatePersonalAppsSuspension(intExtra22);
                        return;
                    }
                    return;
                }
                if ("android.intent.action.USER_SWITCHED".equals(action)) {
                    sendDeviceOwnerUserCommand("android.app.action.USER_SWITCHED", intExtra22);
                    return;
                }
                if ("android.intent.action.USER_UNLOCKED".equals(action)) {
                    synchronized (DevicePolicyManagerService.this.getLockObject()) {
                        DevicePolicyManagerService.this.maybeSendAdminEnabledBroadcastLocked(intExtra22);
                    }
                    if (DevicePolicyManagerService.this.isManagedProfile(intExtra22)) {
                        Slogf.d("DevicePolicyManager", "Managed profile became unlocked");
                        DevicePolicyManagerService.this.triggerPolicyComplianceCheckIfNeeded(intExtra22, DevicePolicyManagerService.this.updatePersonalAppsSuspension(intExtra22));
                        return;
                    }
                    return;
                }
                if ("android.intent.action.EXTERNAL_APPLICATIONS_UNAVAILABLE".equals(action)) {
                    DevicePolicyManagerService.this.handlePackagesChanged(null, intExtra22);
                    return;
                }
                if ("android.intent.action.PACKAGE_CHANGED".equals(action)) {
                    DevicePolicyManagerService.this.handlePackagesChanged(intent.getData().getSchemeSpecificPart(), intExtra22);
                    return;
                }
                if ("android.intent.action.PACKAGE_ADDED".equals(action)) {
                    if (intent.getBooleanExtra("android.intent.extra.REPLACING", false)) {
                        DevicePolicyManagerService.this.handlePackagesChanged(intent.getData().getSchemeSpecificPart(), intExtra22);
                        return;
                    } else {
                        DevicePolicyManagerService.this.handleNewPackageInstalled(intent.getData().getSchemeSpecificPart(), intExtra22);
                        return;
                    }
                }
                if ("android.intent.action.PACKAGE_REMOVED".equals(action) && !intent.getBooleanExtra("android.intent.extra.REPLACING", false)) {
                    DevicePolicyManagerService.this.handlePackagesChanged(intent.getData().getSchemeSpecificPart(), intExtra22);
                    DevicePolicyManagerService.this.removeCredentialManagementApp(intent.getData().getSchemeSpecificPart());
                    return;
                }
                if (DevicePolicyListener.ACTION_PROFILE_OWNER_ADDED.equals(action)) {
                    DevicePolicyManagerService.this.clearWipeProfileNotification();
                    return;
                }
                if ("android.intent.action.DATE_CHANGED".equals(action) || "android.intent.action.TIME_SET".equals(action)) {
                    DevicePolicyManagerService.this.updateSystemUpdateFreezePeriodsRecord(true);
                    DevicePolicyManagerService devicePolicyManagerService = DevicePolicyManagerService.this;
                    int managedUserId = devicePolicyManagerService.getManagedUserId(devicePolicyManagerService.getMainUserId());
                    if (managedUserId >= 0) {
                        DevicePolicyManagerService.this.updatePersonalAppsSuspension(managedUserId);
                        return;
                    }
                    return;
                }
                if (DevicePolicyManagerService.ACTION_PROFILE_OFF_DEADLINE.equals(action)) {
                    Slogf.i("DevicePolicyManager", "Profile off deadline alarm was triggered");
                    DevicePolicyManagerService devicePolicyManagerService2 = DevicePolicyManagerService.this;
                    int managedUserId2 = devicePolicyManagerService2.getManagedUserId(devicePolicyManagerService2.getMainUserId());
                    if (managedUserId2 >= 0) {
                        DevicePolicyManagerService.this.updatePersonalAppsSuspension(managedUserId2);
                        return;
                    } else {
                        Slogf.wtf("DevicePolicyManager", "Got deadline alarm for nonexistent profile");
                        return;
                    }
                }
                if (DevicePolicyManagerService.ACTION_TURN_PROFILE_ON_NOTIFICATION.equals(action)) {
                    Slogf.i("DevicePolicyManager", "requesting to turn on the profile: " + intExtra22);
                    DevicePolicyManagerService.this.mUserManager.requestQuietModeEnabled(false, UserHandle.of(intExtra22));
                    return;
                }
                if ("android.intent.action.MANAGED_PROFILE_UNAVAILABLE".equals(action)) {
                    DevicePolicyManagerService.this.notifyIfManagedSubscriptionsAreUnavailable(UserHandle.of(intExtra22), false);
                    DevicePolicyManagerService.this.updatePersonalAppsSuspension(intExtra22);
                } else if ("android.intent.action.MANAGED_PROFILE_AVAILABLE".equals(action)) {
                    DevicePolicyManagerService.this.notifyIfManagedSubscriptionsAreUnavailable(UserHandle.of(intExtra22), true);
                    DevicePolicyManagerService.this.triggerPolicyComplianceCheckIfNeeded(intExtra22, DevicePolicyManagerService.this.updatePersonalAppsSuspension(intExtra22));
                } else if ("android.accounts.LOGIN_ACCOUNTS_CHANGED".equals(action)) {
                    DevicePolicyManagerService.this.calculateHasIncompatibleAccounts();
                }
            }

            /* renamed from: com.android.server.devicepolicy.DevicePolicyManagerService$1$1 */
            /* loaded from: classes2.dex */
            public class RunnableC00151 implements Runnable {
                public final /* synthetic */ int val$userHandle;

                public RunnableC00151(int intExtra22) {
                    r2 = intExtra22;
                }

                @Override // java.lang.Runnable
                public void run() {
                    DevicePolicyManagerService.this.handlePasswordExpirationNotification(r2);
                }
            }

            public final void sendDeviceOwnerUserCommand(String str, int i) {
                synchronized (DevicePolicyManagerService.this.getLockObject()) {
                    ActiveAdmin deviceOwnerAdminLocked = DevicePolicyManagerService.this.getDeviceOwnerAdminLocked();
                    if (deviceOwnerAdminLocked != null) {
                        Bundle bundle = new Bundle();
                        bundle.putParcelable("android.intent.extra.USER", UserHandle.of(i));
                        DevicePolicyManagerService.this.sendAdminCommandLocked(deviceOwnerAdminLocked, str, bundle, null, true);
                    }
                }
            }
        };
        this.mReceiver = anonymousClass1;
        HashMap hashMap = USER_RESTRICTION_PERMISSIONS;
        hashMap.put("allow_parent_profile_app_linking", new String[]{"android.permission.MANAGE_DEVICE_POLICY_PROFILES"});
        hashMap.put("no_add_clone_profile", new String[]{"android.permission.MANAGE_DEVICE_POLICY_PROFILES"});
        hashMap.put("no_add_user", new String[]{"android.permission.MANAGE_DEVICE_POLICY_MODIFY_USERS"});
        hashMap.put("no_add_wifi_config", new String[]{"android.permission.MANAGE_DEVICE_POLICY_WIFI"});
        hashMap.put("no_adjust_volume", new String[]{"android.permission.MANAGE_DEVICE_POLICY_AUDIO_OUTPUT"});
        hashMap.put("no_airplane_mode", new String[]{"android.permission.MANAGE_DEVICE_POLICY_AIRPLANE_MODE"});
        hashMap.put("no_ambient_display", new String[]{"android.permission.MANAGE_DEVICE_POLICY_DISPLAY"});
        hashMap.put("no_control_apps", new String[]{"android.permission.MANAGE_DEVICE_POLICY_APPS_CONTROL"});
        hashMap.put("no_autofill", new String[]{"android.permission.MANAGE_DEVICE_POLICY_AUTOFILL"});
        hashMap.put("no_bluetooth", new String[]{"android.permission.MANAGE_DEVICE_POLICY_BLUETOOTH"});
        hashMap.put("no_bluetooth_sharing", new String[]{"android.permission.MANAGE_DEVICE_POLICY_BLUETOOTH"});
        hashMap.put("no_camera", new String[]{"android.permission.MANAGE_DEVICE_POLICY_CAMERA"});
        hashMap.put("disallow_camera_toggle", new String[]{"manage_device_policy_camera_toggle"});
        hashMap.put("no_cellular_2g", new String[]{"android.permission.MANAGE_DEVICE_POLICY_MOBILE_NETWORK"});
        hashMap.put("no_change_wifi_state", new String[]{"android.permission.MANAGE_DEVICE_POLICY_WIFI"});
        hashMap.put("no_config_bluetooth", new String[]{"android.permission.MANAGE_DEVICE_POLICY_BLUETOOTH"});
        hashMap.put("no_config_brightness", new String[]{"android.permission.MANAGE_DEVICE_POLICY_DISPLAY"});
        hashMap.put("no_config_cell_broadcasts", new String[]{"android.permission.MANAGE_DEVICE_POLICY_MOBILE_NETWORK"});
        hashMap.put("no_config_credentials", new String[]{"android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS"});
        hashMap.put("no_config_date_time", new String[]{"android.permission.MANAGE_DEVICE_POLICY_TIME"});
        hashMap.put("disallow_config_default_apps", new String[]{"android.permission.MANAGE_DEFAULT_APPLICATIONS"});
        hashMap.put("no_config_locale", new String[]{"android.permission.MANAGE_DEVICE_POLICY_LOCALE"});
        hashMap.put("no_config_location", new String[]{"android.permission.MANAGE_DEVICE_POLICY_LOCATION"});
        hashMap.put("no_config_mobile_networks", new String[]{"android.permission.MANAGE_DEVICE_POLICY_MOBILE_NETWORK"});
        hashMap.put("disallow_config_private_dns", new String[]{"android.permission.MANAGE_DEVICE_POLICY_RESTRICT_PRIVATE_DNS"});
        hashMap.put("no_config_screen_timeout", new String[]{"android.permission.MANAGE_DEVICE_POLICY_DISPLAY"});
        hashMap.put("no_config_tethering", new String[]{"android.permission.MANAGE_DEVICE_POLICY_MOBILE_NETWORK"});
        hashMap.put("no_config_vpn", new String[]{"android.permission.MANAGE_DEVICE_POLICY_VPN"});
        hashMap.put("no_config_wifi", new String[]{"android.permission.MANAGE_DEVICE_POLICY_WIFI"});
        hashMap.put("no_content_capture", new String[]{"android.permission.MANAGE_DEVICE_POLICY_SCREEN_CONTENT"});
        hashMap.put("no_content_suggestions", new String[]{"android.permission.MANAGE_DEVICE_POLICY_SCREEN_CONTENT"});
        hashMap.put("no_create_windows", new String[]{"android.permission.MANAGE_DEVICE_POLICY_WINDOWS"});
        hashMap.put("no_cross_profile_copy_paste", new String[]{"android.permission.MANAGE_DEVICE_POLICY_PROFILE_INTERACTION"});
        hashMap.put("no_data_roaming", new String[]{"android.permission.MANAGE_DEVICE_POLICY_MOBILE_NETWORK"});
        hashMap.put("no_debugging_features", new String[]{"android.permission.MANAGE_DEVICE_POLICY_DEBUGGING_FEATURES"});
        hashMap.put("no_factory_reset", new String[]{"android.permission.MANAGE_DEVICE_POLICY_FACTORY_RESET"});
        hashMap.put("no_fun", new String[]{"android.permission.MANAGE_DEVICE_POLICY_FUN"});
        hashMap.put("no_install_apps", new String[]{"android.permission.MANAGE_DEVICE_POLICY_APPS_CONTROL"});
        hashMap.put("no_install_unknown_sources", new String[]{"android.permission.MANAGE_DEVICE_POLICY_INSTALL_UNKNOWN_SOURCES"});
        hashMap.put("no_install_unknown_sources_globally", new String[]{"android.permission.MANAGE_DEVICE_POLICY_INSTALL_UNKNOWN_SOURCES"});
        hashMap.put("disallow_microphone_toggle", new String[]{"manage_device_policy_microphone_toggle"});
        hashMap.put("no_modify_accounts", new String[]{"android.permission.MANAGE_DEVICE_POLICY_ACCOUNT_MANAGEMENT"});
        hashMap.put("no_physical_media", new String[]{"android.permission.MANAGE_DEVICE_POLICY_PHYSICAL_MEDIA"});
        hashMap.put("no_network_reset", new String[]{"android.permission.MANAGE_DEVICE_POLICY_MOBILE_NETWORK"});
        hashMap.put("no_outgoing_beam", new String[]{"android.permission.MANAGE_DEVICE_POLICY_NEARBY_COMMUNICATION"});
        hashMap.put("no_outgoing_calls", new String[]{"android.permission.MANAGE_DEVICE_POLICY_CALLS"});
        hashMap.put("no_printing", new String[]{"android.permission.MANAGE_DEVICE_POLICY_PRINTING"});
        hashMap.put("no_remove_user", new String[]{"android.permission.MANAGE_DEVICE_POLICY_MODIFY_USERS"});
        hashMap.put("no_run_in_background", new String[]{"android.permission.MANAGE_DEVICE_POLICY_RUN_IN_BACKGROUND"});
        hashMap.put("no_safe_boot", new String[]{"android.permission.MANAGE_DEVICE_POLICY_SAFE_BOOT"});
        hashMap.put("no_set_user_icon", new String[]{"android.permission.MANAGE_DEVICE_POLICY_MODIFY_USERS"});
        hashMap.put("no_set_wallpaper", new String[]{"android.permission.MANAGE_DEVICE_POLICY_WALLPAPER"});
        hashMap.put("no_sharing_into_profile", new String[]{"android.permission.MANAGE_DEVICE_POLICY_PROFILE_INTERACTION"});
        hashMap.put("no_share_location", new String[]{"android.permission.MANAGE_DEVICE_POLICY_LOCATION"});
        hashMap.put("no_sharing_admin_configured_wifi", new String[]{"android.permission.MANAGE_DEVICE_POLICY_WIFI"});
        hashMap.put("no_sms", new String[]{"android.permission.MANAGE_DEVICE_POLICY_SMS"});
        hashMap.put("no_system_error_dialogs", new String[]{"android.permission.MANAGE_DEVICE_POLICY_SYSTEM_DIALOGS"});
        hashMap.put("no_ultra_wideband_radio", new String[]{"android.permission.MANAGE_DEVICE_POLICY_NEARBY_COMMUNICATION"});
        hashMap.put("no_unified_password", new String[]{"android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS"});
        hashMap.put("no_uninstall_apps", new String[]{"android.permission.MANAGE_DEVICE_POLICY_APPS_CONTROL"});
        hashMap.put("disallow_unmute_device", new String[]{"android.permission.MANAGE_DEVICE_POLICY_AUDIO_OUTPUT"});
        hashMap.put("no_unmute_microphone", new String[]{"android.permission.MANAGE_DEVICE_POLICY_MICROPHONE"});
        hashMap.put("no_usb_file_transfer", new String[]{"android.permission.MANAGE_DEVICE_POLICY_USB_FILE_TRANSFER"});
        hashMap.put("no_user_switch", new String[]{"android.permission.MANAGE_DEVICE_POLICY_MODIFY_USERS"});
        hashMap.put("no_wifi_direct", new String[]{"android.permission.MANAGE_DEVICE_POLICY_WIFI"});
        hashMap.put("no_wifi_tethering", new String[]{"android.permission.MANAGE_DEVICE_POLICY_WIFI"});
        hashMap.put("ensure_verify_apps", new String[]{"android.permission.MANAGE_DEVICE_POLICY_INSTALL_UNKNOWN_SOURCES"});
        hashMap.put("no_record_audio", null);
        hashMap.put("no_wallpaper", null);
        List list = SENSOR_PERMISSIONS;
        list.add("android.permission.ACCESS_FINE_LOCATION");
        list.add("android.permission.ACCESS_BACKGROUND_LOCATION");
        list.add("android.permission.ACCESS_COARSE_LOCATION");
        list.add("android.permission.CAMERA");
        list.add("android.permission.RECORD_AUDIO");
        list.add("android.permission.ACTIVITY_RECOGNITION");
        list.add("android.permission.BODY_SENSORS");
        list.add("android.permission.BACKGROUND_CAMERA");
        list.add("android.permission.RECORD_BACKGROUND_AUDIO");
        list.add("android.permission.BODY_SENSORS_BACKGROUND");
        this.calculateHasIncompatibleAccountsExecutor = new ThreadPoolExecutor(1, 1, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue());
        List list2 = PROFILE_OWNER_OF_ORGANIZATION_OWNED_DEVICE_PERMISSIONS;
        List list3 = PROFILE_OWNER_PERMISSIONS;
        list2.addAll(list3);
        list2.addAll(ADDITIONAL_PROFILE_OWNER_OF_ORGANIZATION_OWNED_DEVICE_PERMISSIONS);
        List list4 = PROFILE_OWNER_ON_USER_0_PERMISSIONS;
        list4.addAll(list3);
        list4.addAll(ADDITIONAL_PROFILE_OWNER_ON_USER_0_PERMISSIONS);
        List list5 = PROFILE_OWNER_ON_USER_PERMISSIONS;
        list5.addAll(list3);
        list5.addAll(ADDITIONAL_PROFILE_OWNER_ON_USER_PERMISSIONS);
        List list6 = AFFILIATED_PROFILE_OWNER_ON_USER_PERMISSIONS;
        list6.addAll(list5);
        list6.addAll(ADDITIONAL_AFFILIATED_PROFILE_OWNER_ON_USER_PERMISSIONS);
        HashMap hashMap2 = DPC_PERMISSIONS;
        hashMap2.put(0, DEFAULT_DEVICE_OWNER_PERMISSIONS);
        hashMap2.put(1, FINANCED_DEVICE_OWNER_PERMISSIONS);
        hashMap2.put(2, list2);
        hashMap2.put(3, list4);
        hashMap2.put(4, list3);
        hashMap2.put(5, list5);
        hashMap2.put(6, list6);
        HashMap hashMap3 = DELEGATE_SCOPES;
        hashMap3.put("android.permission.MANAGE_DEVICE_POLICY_APP_RESTRICTIONS", "delegation-app-restrictions");
        hashMap3.put("manage_device_policy_block_uninstall", "delegation-block-uninstall");
        hashMap3.put("android.permission.MANAGE_DEVICE_POLICY_CERTIFICATES", "delegation-cert-install");
        hashMap3.put("android.permission.MANAGE_DEVICE_POLICY_PACKAGE_STATE", "delegation-package-access");
        hashMap3.put("android.permission.MANAGE_DEVICE_POLICY_RUNTIME_PERMISSIONS", "delegation-permission-grant");
        hashMap3.put("android.permission.MANAGE_DEVICE_POLICY_SECURITY_LOGGING", "delegation-security-logging");
        HashMap hashMap4 = CROSS_USER_PERMISSIONS;
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_FACTORY_RESET", null);
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_MTE", null);
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_SECURITY_LOGGING", null);
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_STATUS_BAR", null);
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_SYSTEM_UPDATES", null);
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_USB_DATA_SIGNALLING", null);
        hashMap4.put("android.permission.SET_TIME", null);
        hashMap4.put("android.permission.SET_TIME_ZONE", null);
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_INSTALL_UNKNOWN_SOURCES", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_SECURITY_CRITICAL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_KEYGUARD", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_SECURITY_CRITICAL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_SECURITY_CRITICAL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_ACCOUNT_MANAGEMENT", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_AIRPLANE_MODE", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_BLUETOOTH", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_CALLS", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_CAMERA", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_DEFAULT_SMS", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_INPUT_METHODS", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_MICROPHONE", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_MOBILE_NETWORK", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_NEARBY_COMMUNICATION", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_PHYSICAL_MEDIA", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_PACKAGE_STATE", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_RESTRICT_PRIVATE_DNS", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_SCREEN_CAPTURE", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_SMS", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_SAFE_BOOT", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_TIME", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_USB_FILE_TRANSFER", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_WIFI", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_WIPE_DATA", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_APPS_CONTROL", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_APP_RESTRICTIONS", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_AUDIO_OUTPUT", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_AUTOFILL", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("manage_device_policy_block_uninstall", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("manage_device_policy_camera_toggle", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_COMMON_CRITERIA_MODE", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_DEBUGGING_FEATURES", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_DISPLAY", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_FUN", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_LOCALE", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_LOCATION", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_LOCK", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_LOCK_TASK", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_MODIFY_USERS", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("manage_device_policy_microphone_toggle", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_ORGANIZATION_IDENTITY", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_PROFILES", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_PROFILE_INTERACTION", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_PRINTING", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_RESET_PASSWORD", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_RUNTIME_PERMISSIONS", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_SCREEN_CONTENT", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_SUPPORT_MESSAGE", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_SYSTEM_DIALOGS", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_VPN", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_WALLPAPER", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        hashMap4.put("android.permission.MANAGE_DEVICE_POLICY_WINDOWS", "android.permission.MANAGE_DEVICE_POLICY_ACROSS_USERS_FULL");
        POLICY_IDENTIFIER_TO_PERMISSION.put("autoTimezone", "android.permission.SET_TIME_ZONE");
        DevicePolicyManager.disableLocalCaches();
        this.mInjector = injector;
        this.mPathProvider = policyPathProvider;
        Context context = injector.mContext;
        Objects.requireNonNull(context);
        this.mContext = context;
        Looper myLooper = injector.getMyLooper();
        Objects.requireNonNull(myLooper);
        Handler handler = new Handler(myLooper);
        this.mHandler = handler;
        DevicePolicyConstantsObserver devicePolicyConstantsObserver = new DevicePolicyConstantsObserver(handler);
        this.mConstantsObserver = devicePolicyConstantsObserver;
        devicePolicyConstantsObserver.register();
        this.mConstants = loadConstants();
        UserManager userManager = injector.getUserManager();
        Objects.requireNonNull(userManager);
        this.mUserManager = userManager;
        UserManagerInternal userManagerInternal = injector.getUserManagerInternal();
        Objects.requireNonNull(userManagerInternal);
        this.mUserManagerInternal = userManagerInternal;
        UsageStatsManagerInternal usageStatsManagerInternal = injector.getUsageStatsManagerInternal();
        Objects.requireNonNull(usageStatsManagerInternal);
        this.mUsageStatsManagerInternal = usageStatsManagerInternal;
        IPackageManager iPackageManager = injector.getIPackageManager();
        Objects.requireNonNull(iPackageManager);
        this.mIPackageManager = iPackageManager;
        IPermissionManager iPermissionManager = injector.getIPermissionManager();
        Objects.requireNonNull(iPermissionManager);
        this.mIPermissionManager = iPermissionManager;
        TelephonyManager telephonyManager = injector.getTelephonyManager();
        Objects.requireNonNull(telephonyManager);
        this.mTelephonyManager = telephonyManager;
        RoleManager roleManager = injector.getRoleManager();
        Objects.requireNonNull(roleManager);
        this.mRoleManager = roleManager;
        LocalService localService = new LocalService();
        this.mLocalService = localService;
        this.mLockPatternUtils = injector.newLockPatternUtils();
        this.mLockSettingsInternal = injector.getLockSettingsInternal();
        this.mSecurityLogMonitor = new SecurityLogMonitor(this);
        boolean hasFeature = injector.hasFeature();
        this.mHasFeature = hasFeature;
        this.mIsWatch = injector.getPackageManager().hasSystemFeature("android.hardware.type.watch");
        this.mHasTelephonyFeature = injector.getPackageManager().hasSystemFeature("android.hardware.telephony");
        this.mHasTelephonyDataFeature = injector.getTelephonyManager().isDataCapable();
        this.mIsAutomotive = injector.getPackageManager().hasSystemFeature("android.hardware.type.automotive");
        Handler handler2 = BackgroundThread.getHandler();
        this.mBackgroundHandler = handler2;
        this.mCertificateMonitor = new CertificateMonitor(this, injector, handler2);
        DeviceAdminServiceController deviceAdminServiceController = new DeviceAdminServiceController(this, this.mConstants);
        this.mDeviceAdminServiceController = deviceAdminServiceController;
        this.mOverlayPackagesProvider = new OverlayPackagesProvider(context);
        this.mTransferOwnershipMetadataManager = injector.newTransferOwnershipMetadataManager();
        this.mBugreportCollectionManager = new RemoteBugreportManager(this, injector);
        DeviceManagementResourcesProvider deviceManagementResourcesProvider = injector.getDeviceManagementResourcesProvider();
        this.mDeviceManagementResourcesProvider = deviceManagementResourcesProvider;
        DevicePolicyManagementRoleObserver devicePolicyManagementRoleObserver = new DevicePolicyManagementRoleObserver(context);
        this.mDevicePolicyManagementRoleObserver = devicePolicyManagementRoleObserver;
        devicePolicyManagementRoleObserver.register();
        LocalServices.addService(DevicePolicyManagerLiteInternal.class, localService);
        if (hasFeature) {
            performPolicyVersionUpgrade();
        }
        this.mUserData = new SparseArray();
        this.mOwners = makeOwners(injector, policyPathProvider);
        DevicePolicyEngine devicePolicyEngine = new DevicePolicyEngine(context, deviceAdminServiceController, getLockObject());
        this.mDevicePolicyEngine = devicePolicyEngine;
        if (!hasFeature) {
            this.mSetupContentObserver = null;
            this.mContactSystemRoleHolders = Collections.emptySet();
            return;
        }
        loadOwners();
        IntentFilter intentFilter = new IntentFilter();
        intentFilter.addAction("android.intent.action.BOOT_COMPLETED");
        intentFilter.addAction("com.android.server.ACTION_EXPIRED_PASSWORD_NOTIFICATION");
        intentFilter.addAction(ACTION_TURN_PROFILE_ON_NOTIFICATION);
        intentFilter.addAction(ACTION_PROFILE_OFF_DEADLINE);
        intentFilter.addAction("android.intent.action.USER_ADDED");
        intentFilter.addAction("android.intent.action.USER_REMOVED");
        intentFilter.addAction("android.intent.action.USER_STARTED");
        intentFilter.addAction("android.intent.action.USER_STOPPED");
        intentFilter.addAction("android.intent.action.USER_SWITCHED");
        intentFilter.addAction("android.intent.action.USER_UNLOCKED");
        intentFilter.addAction("android.accounts.LOGIN_ACCOUNTS_CHANGED");
        intentFilter.addAction("android.intent.action.MANAGED_PROFILE_UNAVAILABLE");
        intentFilter.addAction("android.intent.action.MANAGED_PROFILE_AVAILABLE");
        intentFilter.setPriority(1000);
        context.registerReceiverAsUser(anonymousClass1, UserHandle.ALL, intentFilter, null, handler);
        IntentFilter intentFilter2 = new IntentFilter();
        intentFilter2.addAction("android.intent.action.PACKAGE_CHANGED");
        intentFilter2.addAction("android.intent.action.PACKAGE_REMOVED");
        intentFilter2.addAction("android.intent.action.EXTERNAL_APPLICATIONS_UNAVAILABLE");
        intentFilter2.addAction("android.intent.action.PACKAGE_ADDED");
        intentFilter2.addDataScheme("package");
        context.registerReceiverAsUser(anonymousClass1, UserHandle.ALL, intentFilter2, null, handler);
        IntentFilter intentFilter3 = new IntentFilter();
        intentFilter3.addAction(DevicePolicyListener.ACTION_PROFILE_OWNER_ADDED);
        intentFilter3.addAction("android.intent.action.TIME_SET");
        intentFilter3.addAction("android.intent.action.DATE_CHANGED");
        context.registerReceiverAsUser(anonymousClass1, UserHandle.ALL, intentFilter3, null, handler);
        LocalServices.addService(DevicePolicyManagerInternal.class, localService);
        this.mSetupContentObserver = new SetupContentObserver(handler);
        userManagerInternal.addUserRestrictionsListener(new RestrictionsListener(context, userManagerInternal, this));
        userManagerInternal.addUserLifecycleListener(new UserLifecycleListener());
        deviceManagementResourcesProvider.load();
        devicePolicyEngine.load();
        this.mContactSystemRoleHolders = fetchOemSystemHolders(R.string.config_defaultSms, R.string.config_defaultDialer, R.string.CLIRDefaultOnNextCallOff);
        invalidateBinderCaches();
        this.mDualDarProvisioningHelper = injector.getDualDarProvisioningHelper(userManagerInternal);
    }

    public final Set fetchOemSystemHolders(int... iArr) {
        ArraySet arraySet = new ArraySet();
        for (int i : iArr) {
            String defaultRoleHolderPackageName = getDefaultRoleHolderPackageName(i);
            if (defaultRoleHolderPackageName != null) {
                arraySet.add(defaultRoleHolderPackageName);
            }
        }
        return Collections.unmodifiableSet(arraySet);
    }

    public final String getDefaultRoleHolderPackageName(int i) {
        String string = this.mContext.getString(i);
        if (TextUtils.isEmpty(string)) {
            return null;
        }
        return string.contains(XmlUtils.STRING_ARRAY_SEPARATOR) ? string.split(XmlUtils.STRING_ARRAY_SEPARATOR)[0] : string;
    }

    public final void suspendAppsForQuietProfiles(boolean z) {
        PackageManagerInternal packageManagerInternal = this.mInjector.getPackageManagerInternal();
        for (UserInfo userInfo : this.mUserManagerInternal.getUsers(true)) {
            if (userInfo.isManagedProfile() && userInfo.isQuietModeEnabled()) {
                packageManagerInternal.setPackagesSuspendedForQuietMode(userInfo.id, z);
            }
        }
    }

    public final Owners makeOwners(Injector injector, PolicyPathProvider policyPathProvider) {
        return new Owners(injector.getUserManager(), injector.getUserManagerInternal(), injector.getPackageManagerInternal(), injector.getActivityTaskManagerInternal(), injector.getActivityManagerInternal(), this.mStateCache, policyPathProvider);
    }

    public static void invalidateBinderCaches() {
        DevicePolicyManager.invalidateBinderCaches();
    }

    /* renamed from: getUserData */
    public DevicePolicyData lambda$getUserDataUnchecked$2(int i) {
        DevicePolicyData devicePolicyData;
        synchronized (getLockObject()) {
            devicePolicyData = (DevicePolicyData) this.mUserData.get(i);
            if (devicePolicyData == null) {
                devicePolicyData = new DevicePolicyData(i);
                this.mUserData.append(i, devicePolicyData);
                loadSettingsLocked(devicePolicyData, i);
                if (i == 0) {
                    this.mStateCache.setDeviceProvisioned(devicePolicyData.mUserSetupComplete);
                }
            }
        }
        return devicePolicyData;
    }

    public DevicePolicyData getUserDataUnchecked(final int i) {
        return (DevicePolicyData) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda99
            public final Object getOrThrow() {
                DevicePolicyData lambda$getUserDataUnchecked$2;
                lambda$getUserDataUnchecked$2 = DevicePolicyManagerService.this.lambda$getUserDataUnchecked$2(i);
                return lambda$getUserDataUnchecked$2;
            }
        });
    }

    public void removeUserData(int i) {
        synchronized (getLockObject()) {
            if (i == 0) {
                Slogf.w("DevicePolicyManager", "Tried to remove device policy file for user 0! Ignoring.");
                return;
            }
            updatePasswordQualityCacheForUserGroup(i);
            this.mPolicyCache.onUserRemoved(i);
            if (isManagedProfile(i)) {
                clearManagedProfileApnUnchecked();
            }
            boolean isProfileOwnerOfOrganizationOwnedDevice = this.mOwners.isProfileOwnerOfOrganizationOwnedDevice(i);
            ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(i);
            if (profileOwnerLocked != null) {
                profileOwnerLocked.userRestrictions = null;
                ActiveAdmin parentActiveAdmin = profileOwnerLocked.getParentActiveAdmin();
                if (parentActiveAdmin != null) {
                    parentActiveAdmin.userRestrictions = null;
                }
                pushUserRestrictions(i);
            }
            this.mOwners.removeProfileOwner(i);
            this.mOwners.writeProfileOwner(i);
            pushScreenCapturePolicy(i);
            DevicePolicyData devicePolicyData = (DevicePolicyData) this.mUserData.get(i);
            if (devicePolicyData != null) {
                ArrayList arrayList = devicePolicyData.mAdminList;
                if (arrayList != null) {
                    Iterator it = arrayList.iterator();
                    while (it.hasNext()) {
                        ActiveAdmin activeAdmin = (ActiveAdmin) it.next();
                        IEnterpriseDeviceManager iEDMService = this.mInjector.getIEDMService();
                        if (iEDMService != null) {
                            try {
                                iEDMService.removeActiveAdminFromDpm(activeAdmin.info.getComponent(), i);
                            } catch (RemoteException e) {
                                Slogf.e("DevicePolicyManager", "failed to remove active admin from edm database " + e.getMessage());
                            }
                        } else {
                            Log.i("DevicePolicyManager", "removeUserData() : passed EDMS.removeActiveAdminFromDpm() because edms is null");
                        }
                    }
                }
                this.mUserData.remove(i);
            }
            File file = new File(this.mPathProvider.getUserSystemDirectory(i), "device_policies.xml");
            file.delete();
            Slogf.i("DevicePolicyManager", "Removed device policy file " + file.getAbsolutePath());
            if (isProfileOwnerOfOrganizationOwnedDevice) {
                UserInfo primaryUser = this.mUserManager.getPrimaryUser();
                if (primaryUser != null) {
                    clearOrgOwnedProfileOwnerDeviceWidePolicies(primaryUser.id);
                } else {
                    Slogf.wtf("DevicePolicyManager", "Was unable to get primary user.");
                }
            }
        }
    }

    public void loadOwners() {
        synchronized (getLockObject()) {
            this.mOwners.load();
            setDeviceOwnershipSystemPropertyLocked();
            if (this.mOwners.hasDeviceOwner()) {
                Owners owners = this.mOwners;
                setGlobalSettingDeviceOwnerType(owners.getDeviceOwnerType(owners.getDeviceOwnerPackageName()));
            }
        }
    }

    public final CallerIdentity getCallerIdentity() {
        return getCallerIdentity(null, null);
    }

    public final CallerIdentity getCallerIdentity(String str) {
        return getCallerIdentity(null, str);
    }

    public CallerIdentity getCallerIdentity(ComponentName componentName) {
        return getCallerIdentity(componentName, null);
    }

    public CallerIdentity getCallerIdentity(ComponentName componentName, String str) {
        int binderGetCallingUid = this.mInjector.binderGetCallingUid();
        if (str != null && !isCallingFromPackage(str, binderGetCallingUid)) {
            throw new SecurityException(String.format("Caller with uid %d is not %s", Integer.valueOf(binderGetCallingUid), str));
        }
        if (componentName != null) {
            ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2(UserHandle.getUserId(binderGetCallingUid)).mAdminMap.get(componentName);
            if (activeAdmin == null || (activeAdmin.getUid() != binderGetCallingUid && !this.mInjector.personaManagerIsContainerService() && binderGetCallingUid != 1000)) {
                throw new SecurityException(String.format("Admin %s does not exist or is not owned by uid %d", componentName, Integer.valueOf(binderGetCallingUid)));
            }
            if (str != null && !this.mInjector.personaManagerIsContainerService()) {
                Preconditions.checkArgument(str.equals(componentName.getPackageName()));
            } else {
                str = componentName.getPackageName();
            }
        }
        return new CallerIdentity(binderGetCallingUid, str, componentName);
    }

    public final void migrateToProfileOnOrganizationOwnedDeviceIfCompLocked() {
        int deviceOwnerUserId = this.mOwners.getDeviceOwnerUserId();
        if (deviceOwnerUserId == -10000) {
            return;
        }
        List profiles = this.mUserManager.getProfiles(deviceOwnerUserId);
        if (profiles.size() != 2) {
            if (profiles.size() == 1) {
                return;
            }
            Slogf.wtf("DevicePolicyManager", "Found " + profiles.size() + " profiles, skipping migration");
            return;
        }
        int managedUserId = getManagedUserId(deviceOwnerUserId);
        if (managedUserId < 0) {
            Slogf.wtf("DevicePolicyManager", "Found DO and a profile, but it is not managed, skipping migration");
            return;
        }
        ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
        ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(managedUserId);
        if (deviceOwnerAdminLocked == null || profileOwnerAdminLocked == null) {
            Slogf.wtf("DevicePolicyManager", "Failed to get either PO or DO admin, aborting migration.");
            return;
        }
        ComponentName deviceOwnerComponent = this.mOwners.getDeviceOwnerComponent();
        ComponentName profileOwnerComponent = this.mOwners.getProfileOwnerComponent(managedUserId);
        if (deviceOwnerComponent == null || profileOwnerComponent == null) {
            Slogf.wtf("DevicePolicyManager", "Cannot find PO or DO component name, aborting migration.");
            return;
        }
        if (!deviceOwnerComponent.getPackageName().equals(profileOwnerComponent.getPackageName())) {
            Slogf.e("DevicePolicyManager", "DO and PO are different packages, aborting migration.");
            return;
        }
        Slogf.i("DevicePolicyManager", "Migrating COMP to PO on a corp owned device; primary user: %d; profile: %d", Integer.valueOf(deviceOwnerUserId), Integer.valueOf(managedUserId));
        Slogf.i("DevicePolicyManager", "Giving the PO additional power...");
        setProfileOwnerOnOrganizationOwnedDeviceUncheckedLocked(profileOwnerComponent, managedUserId, true);
        Slogf.i("DevicePolicyManager", "Migrating DO policies to PO...");
        moveDoPoliciesToProfileParentAdminLocked(deviceOwnerAdminLocked, profileOwnerAdminLocked.getParentActiveAdmin());
        migratePersonalAppSuspensionLocked(deviceOwnerUserId, managedUserId, profileOwnerAdminLocked);
        migrateKnoxPoliciesForWpcod(managedUserId);
        migrateApplicationRestrictions();
        saveSettingsLocked(managedUserId);
        Slogf.i("DevicePolicyManager", "Clearing the DO...");
        ComponentName component = deviceOwnerAdminLocked.info.getComponent();
        clearDeviceOwnerLocked(deviceOwnerAdminLocked, deviceOwnerUserId);
        Slogf.i("DevicePolicyManager", "Removing admin artifacts...");
        removeAdminArtifacts(component, deviceOwnerUserId);
        Slogf.i("DevicePolicyManager", "Uninstalling the DO...");
        uninstallOrDisablePackage(deviceOwnerComponent.getPackageName(), deviceOwnerUserId);
        Slogf.i("DevicePolicyManager", "Migration complete.");
        DevicePolicyEventLogger.createEvent(137).setAdmin(profileOwnerComponent).write();
    }

    public final void migratePersonalAppSuspensionLocked(int i, int i2, ActiveAdmin activeAdmin) {
        PackageManagerInternal packageManagerInternal = this.mInjector.getPackageManagerInternal();
        if (!packageManagerInternal.isSuspendingAnyPackages("android", i)) {
            Slogf.i("DevicePolicyManager", "DO is not suspending any apps.");
            return;
        }
        if (getTargetSdk(activeAdmin.info.getPackageName(), i2) >= 30) {
            Slogf.i("DevicePolicyManager", "PO is targeting R+, keeping personal apps suspended.");
            lambda$getUserDataUnchecked$2(i).mAppsSuspended = true;
            activeAdmin.mSuspendPersonalApps = true;
        } else {
            Slogf.i("DevicePolicyManager", "PO isn't targeting R+, unsuspending personal apps.");
            packageManagerInternal.unsuspendForSuspendingPackage("android", i);
        }
    }

    public final void uninstallOrDisablePackage(String str, int i) {
        try {
            ApplicationInfo applicationInfo = this.mIPackageManager.getApplicationInfo(str, 786432L, i);
            if (applicationInfo == null) {
                Slogf.wtf("DevicePolicyManager", "Failed to get package info for " + str);
                return;
            }
            if ((applicationInfo.flags & 1) != 0) {
                Slogf.i("DevicePolicyManager", "Package %s is pre-installed, marking disabled until used", str);
                this.mContext.getPackageManager().setApplicationEnabledSetting(str, 4, 0);
            } else {
                this.mInjector.getPackageManager(i).getPackageInstaller().uninstall(str, 0, new IntentSender(new IIntentSender.Stub() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService.3
                    public final /* synthetic */ String val$packageName;
                    public final /* synthetic */ int val$userId;

                    public AnonymousClass3(String str2, int i2) {
                        r2 = str2;
                        r3 = i2;
                    }

                    public void send(int i2, Intent intent, String str2, IBinder iBinder, IIntentReceiver iIntentReceiver, String str3, Bundle bundle) {
                        int intExtra = intent.getIntExtra("android.content.pm.extra.STATUS", 1);
                        if (intExtra == 0) {
                            Slogf.i("DevicePolicyManager", "Package %s uninstalled for user %d", r2, Integer.valueOf(r3));
                        } else {
                            Slogf.e("DevicePolicyManager", "Failed to uninstall %s; status: %d", r2, Integer.valueOf(intExtra));
                        }
                    }
                }));
            }
        } catch (RemoteException e) {
            Slogf.wtf("DevicePolicyManager", "Error getting application info", e);
        }
    }

    /* renamed from: com.android.server.devicepolicy.DevicePolicyManagerService$3 */
    /* loaded from: classes2.dex */
    public class AnonymousClass3 extends IIntentSender.Stub {
        public final /* synthetic */ String val$packageName;
        public final /* synthetic */ int val$userId;

        public AnonymousClass3(String str2, int i2) {
            r2 = str2;
            r3 = i2;
        }

        public void send(int i2, Intent intent, String str2, IBinder iBinder, IIntentReceiver iIntentReceiver, String str3, Bundle bundle) {
            int intExtra = intent.getIntExtra("android.content.pm.extra.STATUS", 1);
            if (intExtra == 0) {
                Slogf.i("DevicePolicyManager", "Package %s uninstalled for user %d", r2, Integer.valueOf(r3));
            } else {
                Slogf.e("DevicePolicyManager", "Failed to uninstall %s; status: %d", r2, Integer.valueOf(intExtra));
            }
        }
    }

    public final void moveDoPoliciesToProfileParentAdminLocked(ActiveAdmin activeAdmin, ActiveAdmin activeAdmin2) {
        if (activeAdmin2.mPasswordPolicy.quality == 0) {
            activeAdmin2.mPasswordPolicy = activeAdmin.mPasswordPolicy;
        }
        if (activeAdmin2.passwordHistoryLength == 0) {
            activeAdmin2.passwordHistoryLength = activeAdmin.passwordHistoryLength;
        }
        if (activeAdmin2.passwordExpirationTimeout == 0) {
            activeAdmin2.passwordExpirationTimeout = activeAdmin.passwordExpirationTimeout;
        }
        if (activeAdmin2.maximumFailedPasswordsForWipe == 0) {
            activeAdmin2.maximumFailedPasswordsForWipe = activeAdmin.maximumFailedPasswordsForWipe;
        }
        if (activeAdmin2.maximumTimeToUnlock == 0) {
            activeAdmin2.maximumTimeToUnlock = activeAdmin.maximumTimeToUnlock;
        }
        if (activeAdmin2.strongAuthUnlockTimeout == 259200000) {
            activeAdmin2.strongAuthUnlockTimeout = activeAdmin.strongAuthUnlockTimeout;
        }
        activeAdmin2.disabledKeyguardFeatures |= activeAdmin.disabledKeyguardFeatures & 950;
        activeAdmin2.trustAgentInfos.putAll(activeAdmin.trustAgentInfos);
        activeAdmin2.disableCamera = activeAdmin.disableCamera;
        activeAdmin2.disableScreenCapture = activeAdmin.disableScreenCapture;
        activeAdmin2.accountTypesWithManagementDisabled.addAll(activeAdmin.accountTypesWithManagementDisabled);
        moveDoUserRestrictionsToCopeParent(activeAdmin, activeAdmin2);
        if (activeAdmin.requireAutoTime) {
            activeAdmin2.ensureUserRestrictions().putBoolean("no_config_date_time", true);
        }
    }

    public final void moveDoUserRestrictionsToCopeParent(ActiveAdmin activeAdmin, ActiveAdmin activeAdmin2) {
        Bundle bundle = activeAdmin.userRestrictions;
        if (bundle == null) {
            return;
        }
        for (String str : bundle.keySet()) {
            if (UserRestrictionsUtils.canProfileOwnerOfOrganizationOwnedDeviceChange(str)) {
                activeAdmin2.ensureUserRestrictions().putBoolean(str, activeAdmin.userRestrictions.getBoolean(str));
            }
        }
    }

    public final void applyProfileRestrictionsIfDeviceOwnerLocked() {
        if (this.mOwners.getDeviceOwnerUserId() == -10000) {
            return;
        }
        Iterator it = this.mUserManager.getUsers().iterator();
        while (it.hasNext()) {
            UserHandle userHandle = ((UserInfo) it.next()).getUserHandle();
            if (!this.mUserManager.hasUserRestriction("no_add_clone_profile", userHandle)) {
                this.mUserManager.setUserRestriction("no_add_clone_profile", true, userHandle);
            }
            if (!this.mUserManager.hasUserRestriction("no_add_managed_profile", userHandle)) {
                this.mUserManager.setUserRestriction("no_add_managed_profile", true, userHandle);
            }
        }
    }

    public final void maybeSetDefaultProfileOwnerUserRestrictions() {
        synchronized (getLockObject()) {
            Iterator it = this.mOwners.getProfileOwnerKeys().iterator();
            while (it.hasNext()) {
                int intValue = ((Integer) it.next()).intValue();
                ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(intValue);
                if (profileOwnerAdminLocked != null && this.mUserManager.isManagedProfile(intValue)) {
                    maybeSetDefaultRestrictionsForAdminLocked(intValue, profileOwnerAdminLocked);
                    ensureUnknownSourcesRestrictionForProfileOwnerLocked(intValue, profileOwnerAdminLocked, false);
                }
            }
        }
    }

    public final void ensureUnknownSourcesRestrictionForProfileOwnerLocked(int i, ActiveAdmin activeAdmin, boolean z) {
        if (z || this.mInjector.settingsSecureGetIntForUser("unknown_sources_default_reversed", 0, i) != 0) {
            if (isPolicyEngineForFinanceFlagEnabled()) {
                this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.getPolicyDefinitionForUserRestriction("no_install_unknown_sources"), EnforcingAdmin.createEnterpriseEnforcingAdmin(activeAdmin.info.getComponent(), activeAdmin.getUserHandle().getIdentifier()), new BooleanPolicyValue(true), i);
            } else {
                activeAdmin.ensureUserRestrictions().putBoolean("no_install_unknown_sources", true);
                saveUserRestrictionsLocked(i);
            }
            this.mInjector.settingsSecurePutIntForUser("unknown_sources_default_reversed", 0, i);
        }
    }

    public final void maybeSetDefaultRestrictionsForAdminLocked(int i, ActiveAdmin activeAdmin) {
        Set defaultEnabledForManagedProfiles = UserRestrictionsUtils.getDefaultEnabledForManagedProfiles();
        if (defaultEnabledForManagedProfiles.equals(activeAdmin.defaultEnabledRestrictionsAlreadySet) || SemPersonaManager.isSecureFolderId(i)) {
            return;
        }
        if (isPolicyEngineForFinanceFlagEnabled()) {
            Iterator it = defaultEnabledForManagedProfiles.iterator();
            while (it.hasNext()) {
                this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.getPolicyDefinitionForUserRestriction((String) it.next()), EnforcingAdmin.createEnterpriseEnforcingAdmin(activeAdmin.info.getComponent(), activeAdmin.getUserHandle().getIdentifier()), new BooleanPolicyValue(true), i);
            }
            activeAdmin.defaultEnabledRestrictionsAlreadySet.addAll(defaultEnabledForManagedProfiles);
            Slogf.i("DevicePolicyManager", "Enabled the following restrictions by default: " + defaultEnabledForManagedProfiles);
            return;
        }
        Slogf.i("DevicePolicyManager", "New user restrictions need to be set by default for user " + i);
        ArraySet arraySet = new ArraySet(defaultEnabledForManagedProfiles);
        arraySet.removeAll(activeAdmin.defaultEnabledRestrictionsAlreadySet);
        if (arraySet.isEmpty()) {
            return;
        }
        Iterator it2 = arraySet.iterator();
        while (it2.hasNext()) {
            activeAdmin.ensureUserRestrictions().putBoolean((String) it2.next(), true);
        }
        activeAdmin.defaultEnabledRestrictionsAlreadySet.addAll(arraySet);
        Slogf.i("DevicePolicyManager", "Enabled the following restrictions by default: " + arraySet);
        saveUserRestrictionsLocked(i);
    }

    public final void setDeviceOwnershipSystemPropertyLocked() {
        boolean z = this.mInjector.settingsGlobalGetInt("device_provisioned", 0) != 0;
        boolean hasDeviceOwner = this.mOwners.hasDeviceOwner();
        boolean isOrganizationOwnedDeviceWithManagedProfile = isOrganizationOwnedDeviceWithManagedProfile();
        if (hasDeviceOwner || isOrganizationOwnedDeviceWithManagedProfile || z) {
            String bool = Boolean.toString(hasDeviceOwner || isOrganizationOwnedDeviceWithManagedProfile);
            String systemPropertiesGet = this.mInjector.systemPropertiesGet("ro.organization_owned", null);
            if (TextUtils.isEmpty(systemPropertiesGet)) {
                Slogf.i("DevicePolicyManager", "Set ro.organization_owned property to " + bool);
                this.mInjector.systemPropertiesSet("ro.organization_owned", bool);
            } else if (!bool.equals(systemPropertiesGet)) {
                Slogf.w("DevicePolicyManager", "Cannot change existing ro.organization_owned to " + bool);
            }
            if (TextUtils.isEmpty(this.mInjector.systemPropertiesGet("persist.sys.knox.device_owner", null))) {
                if (this.mOwners.hasDeviceOwner()) {
                    this.mInjector.systemPropertiesSet("persist.sys.knox.device_owner", "true");
                    this.mInjector.settingsGlobalPutInt("do_setup_complete", 1);
                    Slogf.i("DevicePolicyManager", "Set persist.sys.knox.device_owner property to true");
                } else {
                    this.mInjector.systemPropertiesSet("persist.sys.knox.device_owner", "false");
                    this.mInjector.settingsGlobalPutInt("do_setup_complete", 0);
                    Slogf.i("DevicePolicyManager", "Set persist.sys.knox.device_owner property to false");
                }
            }
        }
    }

    public final void maybeStartSecurityLogMonitorOnActivityManagerReady() {
        synchronized (getLockObject()) {
            if (this.mInjector.securityLogIsLoggingEnabled()) {
                this.mSecurityLogMonitor.start(getSecurityLoggingEnabledUser());
                this.mInjector.runCryptoSelfTest();
                maybePauseDeviceWideLoggingLocked();
            }
        }
    }

    public final void fixupAutoTimeRestrictionDuringOrganizationOwnedDeviceMigration() {
        ActiveAdmin activeAdmin;
        Iterator it = this.mUserManager.getUsers().iterator();
        while (it.hasNext()) {
            int i = ((UserInfo) it.next()).id;
            if (isProfileOwnerOfOrganizationOwnedDevice(i) && (activeAdmin = getProfileOwnerAdminLocked(i).parentAdmin) != null && activeAdmin.requireAutoTime) {
                activeAdmin.requireAutoTime = false;
                saveSettingsLocked(i);
                this.mUserManagerInternal.setDevicePolicyUserRestrictions(0, new Bundle(), new RestrictionsSet(), false);
                activeAdmin.ensureUserRestrictions().putBoolean("no_config_date_time", true);
                pushUserRestrictions(i);
            }
        }
    }

    public final void setExpirationAlarmCheckLocked(final Context context, final int i, final boolean z) {
        long j;
        final long j2;
        long passwordExpirationLocked = getPasswordExpirationLocked(null, i, z);
        long currentTimeMillis = System.currentTimeMillis();
        long j3 = passwordExpirationLocked - currentTimeMillis;
        if (passwordExpirationLocked == 0) {
            j2 = 0;
        } else {
            if (j3 <= 0) {
                j = MS_PER_DAY;
            } else {
                j = MS_PER_DAY;
                long j4 = j3 % j;
                if (j4 != 0) {
                    j = j4;
                }
            }
            j2 = currentTimeMillis + j;
        }
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda16
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setExpirationAlarmCheckLocked$3(z, i, context, j2);
            }
        });
    }

    public /* synthetic */ void lambda$setExpirationAlarmCheckLocked$3(boolean z, int i, Context context, long j) {
        if (z) {
            i = getProfileParentId(i);
        }
        AlarmManager alarmManager = this.mInjector.getAlarmManager();
        PendingIntent broadcastAsUser = PendingIntent.getBroadcastAsUser(context, 5571, new Intent("com.android.server.ACTION_EXPIRED_PASSWORD_NOTIFICATION"), 1275068416, UserHandle.of(i));
        alarmManager.cancel(broadcastAsUser);
        if (j != 0) {
            alarmManager.set(1, j, broadcastAsUser);
        }
    }

    public ActiveAdmin getActiveAdminUncheckedLocked(ComponentName componentName, int i) {
        ensureLocked();
        ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2(i).mAdminMap.get(componentName);
        if (activeAdmin != null && componentName.getPackageName().equals(activeAdmin.info.getActivityInfo().packageName) && componentName.getClassName().equals(activeAdmin.info.getActivityInfo().name)) {
            return activeAdmin;
        }
        return null;
    }

    public ActiveAdmin getActiveAdminUncheckedLocked(ComponentName componentName, int i, boolean z) {
        ensureLocked();
        if (z) {
            Preconditions.checkCallAuthorization(isManagedProfile(i), "You can not call APIs on the parent profile outside a managed profile, userId = %d", new Object[]{Integer.valueOf(i)});
        }
        ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
        return (activeAdminUncheckedLocked == null || !z) ? activeAdminUncheckedLocked : activeAdminUncheckedLocked.getParentActiveAdmin();
    }

    public ActiveAdmin getActiveAdminForCallerLocked(ComponentName componentName, int i) {
        return getActiveAdminOrCheckPermissionForCallerLocked(componentName, i, null);
    }

    public ActiveAdmin getDeviceOwnerLocked(int i) {
        ensureLocked();
        return (ActiveAdmin) lambda$getUserDataUnchecked$2(i).mAdminMap.get(this.mOwners.getDeviceOwnerComponent());
    }

    public ActiveAdmin getDefaultDeviceOwnerLocked(int i) {
        ensureLocked();
        ComponentName deviceOwnerComponent = this.mOwners.getDeviceOwnerComponent();
        if (this.mOwners.getDeviceOwnerType(deviceOwnerComponent.getPackageName()) == 0) {
            return (ActiveAdmin) lambda$getUserDataUnchecked$2(i).mAdminMap.get(deviceOwnerComponent);
        }
        return null;
    }

    public ActiveAdmin getProfileOwnerLocked(int i) {
        ensureLocked();
        return (ActiveAdmin) lambda$getUserDataUnchecked$2(i).mAdminMap.get(this.mOwners.getProfileOwnerComponent(i));
    }

    public ActiveAdmin getOrganizationOwnedProfileOwnerLocked(CallerIdentity callerIdentity) {
        Preconditions.checkCallAuthorization(this.mOwners.isProfileOwnerOfOrganizationOwnedDevice(callerIdentity.getUserId()), "Caller %s is not an admin of an org-owned device", new Object[]{callerIdentity.getComponentName()});
        return getProfileOwnerLocked(callerIdentity.getUserId());
    }

    public ActiveAdmin getProfileOwnerOrDeviceOwnerLocked(int i) {
        ensureLocked();
        if (this.mOwners.getProfileOwnerComponent(i) != null) {
            return getProfileOwnerLocked(i);
        }
        return getDeviceOwnerLocked(i);
    }

    public ActiveAdmin getProfileOwnerOrDefaultDeviceOwnerLocked(int i) {
        ensureLocked();
        if (this.mOwners.getProfileOwnerComponent(i) != null) {
            return getProfileOwnerLocked(i);
        }
        return getDefaultDeviceOwnerLocked(i);
    }

    public ActiveAdmin getParentOfAdminIfRequired(ActiveAdmin activeAdmin, boolean z) {
        Objects.requireNonNull(activeAdmin);
        return z ? activeAdmin.getParentActiveAdmin() : activeAdmin;
    }

    public ActiveAdmin getActiveAdminOrCheckPermissionForCallerLocked(ComponentName componentName, int i, String str) {
        return getActiveAdminOrCheckPermissionsForCallerLocked(componentName, i, str == null ? Set.of() : Set.of(str));
    }

    public ActiveAdmin getActiveAdminOrCheckPermissionsForCallerLocked(ComponentName componentName, int i, Set set) {
        String str;
        ensureLocked();
        CallerIdentity callerIdentity = getCallerIdentity();
        ActiveAdmin activeAdminWithPolicyForUidLocked = getActiveAdminWithPolicyForUidLocked(componentName, i, callerIdentity.getUid());
        if (activeAdminWithPolicyForUidLocked != null) {
            return activeAdminWithPolicyForUidLocked;
        }
        Iterator it = set.iterator();
        while (it.hasNext()) {
            if (hasCallingPermission((String) it.next())) {
                return null;
            }
        }
        if (componentName != null) {
            ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2(callerIdentity.getUserId()).mAdminMap.get(componentName);
            boolean isDeviceOwner = isDeviceOwner(activeAdmin.info.getComponent(), callerIdentity.getUserId());
            boolean isProfileOwner = isProfileOwner(activeAdmin.info.getComponent(), callerIdentity.getUserId());
            if (DA_DISALLOWED_POLICIES.contains(Integer.valueOf(i)) && !isDeviceOwner && !isProfileOwner) {
                throw new SecurityException("Admin " + activeAdmin.info.getComponent() + " is not a device owner or profile owner, so may not use policy: " + activeAdmin.info.getTagForPolicy(i));
            }
            throw new SecurityException("Admin " + activeAdmin.info.getComponent() + " did not specify uses-policy for: " + activeAdmin.info.getTagForPolicy(i));
        }
        StringBuilder sb = new StringBuilder();
        sb.append("No active admin owned by uid ");
        sb.append(callerIdentity.getUid());
        sb.append(" for policy #");
        sb.append(i);
        if (set.isEmpty()) {
            str = "";
        } else {
            str = ", which doesn't have " + set;
        }
        sb.append(str);
        throw new SecurityException(sb.toString());
    }

    public ActiveAdmin getActiveAdminForCallerLocked(ComponentName componentName, int i, boolean z) {
        return getActiveAdminOrCheckPermissionForCallerLocked(componentName, i, z, null);
    }

    public ActiveAdmin getActiveAdminOrCheckPermissionForCallerLocked(ComponentName componentName, int i, boolean z, String str) {
        return getActiveAdminOrCheckPermissionsForCallerLocked(componentName, i, z, str == null ? Set.of() : Set.of(str));
    }

    public ActiveAdmin getActiveAdminOrCheckPermissionsForCallerLocked(ComponentName componentName, int i, boolean z, Set set) {
        ensureLocked();
        if (z) {
            Preconditions.checkCallingUser(isManagedProfile(getCallerIdentity().getUserId()));
        }
        ActiveAdmin activeAdminOrCheckPermissionsForCallerLocked = getActiveAdminOrCheckPermissionsForCallerLocked(componentName, i, set);
        return z ? activeAdminOrCheckPermissionsForCallerLocked.getParentActiveAdmin() : activeAdminOrCheckPermissionsForCallerLocked;
    }

    public final ActiveAdmin getActiveAdminForUidLocked(ComponentName componentName, int i) {
        ensureLocked();
        ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2(UserHandle.getUserId(i)).mAdminMap.get(componentName);
        if (activeAdmin == null) {
            throw new SecurityException("No active admin " + componentName + " for UID " + i);
        }
        if (activeAdmin.getUid() == i) {
            return activeAdmin;
        }
        throw new SecurityException("Admin " + componentName + " is not owned by uid " + i);
    }

    public final ActiveAdmin getActiveAdminWithPolicyForUidLocked(ComponentName componentName, int i, int i2) {
        ensureLocked();
        int userId = UserHandle.getUserId(i2);
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(userId);
        if (componentName != null) {
            ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminMap.get(componentName);
            if (activeAdmin == null || activeAdmin.getUid() != i2) {
                throw new SecurityException("Admin " + componentName + " is not active or not owned by uid " + i2);
            }
            if (this.mInjector.personaManagerIsContainerService() || isActiveAdminWithPolicyForUserLocked(activeAdmin, i, userId)) {
                return activeAdmin;
            }
            return null;
        }
        Iterator it = lambda$getUserDataUnchecked$2.mAdminList.iterator();
        while (it.hasNext()) {
            ActiveAdmin activeAdmin2 = (ActiveAdmin) it.next();
            if (activeAdmin2.getUid() == i2 && isActiveAdminWithPolicyForUserLocked(activeAdmin2, i, userId)) {
                return activeAdmin2;
            }
        }
        return null;
    }

    public boolean isActiveAdminWithPolicyForUserLocked(ActiveAdmin activeAdmin, int i, int i2) {
        ensureLocked();
        return (isDeviceOwner(activeAdmin.info.getComponent(), i2) || isProfileOwner(activeAdmin.info.getComponent(), i2) || !DA_DISALLOWED_POLICIES.contains(Integer.valueOf(i)) || getTargetSdk(activeAdmin.info.getPackageName(), i2) < 29) && activeAdmin.info.usesPolicy(i);
    }

    public void sendAdminCommandLocked(ActiveAdmin activeAdmin, String str) {
        sendAdminCommandLocked(activeAdmin, str, null);
    }

    public void sendAdminCommandLocked(ActiveAdmin activeAdmin, String str, BroadcastReceiver broadcastReceiver) {
        sendAdminCommandLocked(activeAdmin, str, (Bundle) null, broadcastReceiver);
    }

    public void sendAdminCommandLocked(ActiveAdmin activeAdmin, String str, Bundle bundle, BroadcastReceiver broadcastReceiver) {
        sendAdminCommandLocked(activeAdmin, str, bundle, broadcastReceiver, false);
    }

    public boolean sendAdminCommandLocked(ActiveAdmin activeAdmin, String str, Bundle bundle, BroadcastReceiver broadcastReceiver, boolean z) {
        Intent intent = new Intent(str);
        intent.setComponent(activeAdmin.info.getComponent());
        if (UserManager.isDeviceInDemoMode(this.mContext)) {
            intent.addFlags(268435456);
        }
        if (str.equals("android.app.action.ACTION_PASSWORD_EXPIRING")) {
            intent.putExtra("expiration", activeAdmin.passwordExpirationDate);
        }
        if (z) {
            intent.addFlags(268435456);
        }
        if (bundle != null) {
            intent.putExtras(bundle);
        }
        if (this.mInjector.getPackageManager().queryBroadcastReceiversAsUser(intent, 268435456, activeAdmin.getUserHandle()).isEmpty()) {
            return false;
        }
        BroadcastOptions makeBasic = BroadcastOptions.makeBasic();
        makeBasic.setBackgroundActivityStartsAllowed(true);
        if (broadcastReceiver != null) {
            this.mContext.sendOrderedBroadcastAsUser(intent, activeAdmin.getUserHandle(), null, -1, makeBasic.toBundle(), broadcastReceiver, this.mHandler, -1, null, null);
        } else {
            this.mContext.sendBroadcastAsUser(intent, activeAdmin.getUserHandle(), null, makeBasic.toBundle());
        }
        return true;
    }

    public void sendAdminCommandLocked(String str, int i, int i2, Bundle bundle) {
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i2);
        int size = lambda$getUserDataUnchecked$2.mAdminList.size();
        for (int i3 = 0; i3 < size; i3++) {
            ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i3);
            if (activeAdmin.info.usesPolicy(i)) {
                sendAdminCommandLocked(activeAdmin, str, bundle, (BroadcastReceiver) null);
            }
        }
    }

    public final void sendAdminCommandToSelfAndProfilesLocked(String str, int i, int i2, Bundle bundle) {
        for (int i3 : this.mUserManager.getProfileIdsWithDisabled(i2)) {
            sendAdminCommandLocked(str, i, i3, bundle);
        }
    }

    public final void sendAdminCommandForLockscreenPoliciesLocked(String str, int i, int i2) {
        Bundle bundle = new Bundle();
        bundle.putParcelable("android.intent.extra.USER", UserHandle.of(i2));
        if (isSeparateProfileChallengeEnabled(i2)) {
            sendAdminCommandLocked(str, i, i2, bundle);
        } else {
            sendAdminCommandToSelfAndProfilesLocked(str, i, i2, bundle);
        }
    }

    /* renamed from: removeActiveAdminLocked */
    public void lambda$removeActiveAdmin$13(ComponentName componentName, int i) {
        ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
        if (activeAdminUncheckedLocked == null || lambda$getUserDataUnchecked$2.mRemovingAdmins.contains(componentName)) {
            return;
        }
        lambda$getUserDataUnchecked$2.mRemovingAdmins.add(componentName);
        sendAdminCommandLocked(activeAdminUncheckedLocked, "android.app.action.DEVICE_ADMIN_DISABLED", new BroadcastReceiver() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService.4
            public final /* synthetic */ ComponentName val$adminReceiver;
            public final /* synthetic */ int val$userHandle;

            public AnonymousClass4(ComponentName componentName2, int i2) {
                r2 = componentName2;
                r3 = i2;
            }

            @Override // android.content.BroadcastReceiver
            public void onReceive(Context context, Intent intent) {
                DevicePolicyManagerService.this.removeAdminArtifacts(r2, r3);
                DevicePolicyManagerService.this.removePackageIfRequired(r2.getPackageName(), r3);
                DevicePolicyManagerService.this.makeAuditLogGroupSystem(String.format("Package %s has been removed as admin.", r2.getPackageName()), r3);
                IEnterpriseDeviceManager iEDMService = DevicePolicyManagerService.this.mInjector.getIEDMService();
                try {
                    if (iEDMService != null) {
                        iEDMService.removeActiveAdminFromDpm(r2, r3);
                    } else {
                        Log.i("DevicePolicyManager", "removeActiveAdminLocked() : passed EDMS.removeActiveAdminFromDpm() because edms is null");
                    }
                } catch (RemoteException e) {
                    Slogf.e("DevicePolicyManager", "failed to remove active admin from edm database " + e.getMessage());
                }
            }
        });
    }

    /* renamed from: com.android.server.devicepolicy.DevicePolicyManagerService$4 */
    /* loaded from: classes2.dex */
    public class AnonymousClass4 extends BroadcastReceiver {
        public final /* synthetic */ ComponentName val$adminReceiver;
        public final /* synthetic */ int val$userHandle;

        public AnonymousClass4(ComponentName componentName2, int i2) {
            r2 = componentName2;
            r3 = i2;
        }

        @Override // android.content.BroadcastReceiver
        public void onReceive(Context context, Intent intent) {
            DevicePolicyManagerService.this.removeAdminArtifacts(r2, r3);
            DevicePolicyManagerService.this.removePackageIfRequired(r2.getPackageName(), r3);
            DevicePolicyManagerService.this.makeAuditLogGroupSystem(String.format("Package %s has been removed as admin.", r2.getPackageName()), r3);
            IEnterpriseDeviceManager iEDMService = DevicePolicyManagerService.this.mInjector.getIEDMService();
            try {
                if (iEDMService != null) {
                    iEDMService.removeActiveAdminFromDpm(r2, r3);
                } else {
                    Log.i("DevicePolicyManager", "removeActiveAdminLocked() : passed EDMS.removeActiveAdminFromDpm() because edms is null");
                }
            } catch (RemoteException e) {
                Slogf.e("DevicePolicyManager", "failed to remove active admin from edm database " + e.getMessage());
            }
        }
    }

    public final DeviceAdminInfo findAdmin(final ComponentName componentName, final int i, boolean z) {
        ActivityInfo activityInfo = (ActivityInfo) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda193
            public final Object getOrThrow() {
                ActivityInfo lambda$findAdmin$4;
                lambda$findAdmin$4 = DevicePolicyManagerService.this.lambda$findAdmin$4(componentName, i);
                return lambda$findAdmin$4;
            }
        });
        if (activityInfo == null) {
            throw new IllegalArgumentException("Unknown admin: " + componentName);
        }
        if (!"android.permission.BIND_DEVICE_ADMIN".equals(activityInfo.permission)) {
            String str = "DeviceAdminReceiver " + componentName + " must be protected with android.permission.BIND_DEVICE_ADMIN";
            Slogf.w("DevicePolicyManager", str);
            if (z && activityInfo.applicationInfo.targetSdkVersion > 23) {
                throw new IllegalArgumentException(str);
            }
        }
        try {
            return new DeviceAdminInfo(this.mContext, activityInfo);
        } catch (IOException | XmlPullParserException e) {
            Slogf.w("DevicePolicyManager", "Bad device admin requested for user=" + i + ": " + componentName, e);
            return null;
        }
    }

    public /* synthetic */ ActivityInfo lambda$findAdmin$4(ComponentName componentName, int i) {
        try {
            return this.mIPackageManager.getReceiverInfo(componentName, 819328L, i);
        } catch (RemoteException e) {
            Slogf.wtf("DevicePolicyManager", "Error getting receiver info", e);
            return null;
        }
    }

    public final File getPolicyFileDirectory(int i) {
        if (i == 0) {
            return this.mPathProvider.getDataSystemDirectory();
        }
        return this.mPathProvider.getUserSystemDirectory(i);
    }

    public final JournaledFile makeJournaledFile(int i, String str) {
        String absolutePath = new File(getPolicyFileDirectory(i), str).getAbsolutePath();
        return new JournaledFile(new File(absolutePath), new File(absolutePath + ".tmp"));
    }

    public final JournaledFile makeJournaledFile(int i) {
        return makeJournaledFile(i, "device_policies.xml");
    }

    public final File getDevicePoliciesXmlFile(int i) {
        return new File(getPolicyFileDirectory(i), "device_policies.xml");
    }

    public final void saveSettingsForUsersLocked(Set set) {
        Iterator it = set.iterator();
        while (it.hasNext()) {
            saveSettingsLocked(((Integer) it.next()).intValue());
        }
    }

    public final void saveSettingsLocked(int i) {
        saveSettingsLocked(i, false, false, false);
    }

    public final void saveSettingsLocked(int i, boolean z, boolean z2, boolean z3) {
        if (DevicePolicyData.store(lambda$getUserDataUnchecked$2(i), makeJournaledFile(i))) {
            DevicePolicyData.sync(getDevicePoliciesXmlFile(i));
            if (z || z2 || z3) {
                sendChangedNotification(i, z, z2, z3);
            } else {
                sendChangedNotification(i);
            }
        }
        invalidateBinderCaches();
    }

    public final void sendChangedNotification(int i) {
        sendChangedNotification(i, false, false, false);
    }

    public final void sendChangedNotification(final int i, boolean z, boolean z2, final boolean z3) {
        if (this.mNotifyChanges) {
            final Intent intent = new Intent("android.app.action.DEVICE_POLICY_MANAGER_STATE_CHANGED");
            intent.setFlags(1073741824);
            final Bundle bundle = new BroadcastOptions().setDeliveryGroupPolicy(0).setDeferralPolicy(2).toBundle();
            if (z) {
                intent.putExtra("isBTChanged", z);
            }
            if (z2) {
                intent.putExtra("isWifiChanged", z2);
            }
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda178
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$sendChangedNotification$5(z3, intent, bundle, i);
                }
            });
        }
    }

    public /* synthetic */ void lambda$sendChangedNotification$5(boolean z, Intent intent, Bundle bundle, int i) {
        if (z) {
            this.mContext.sendBroadcast(intent, null, bundle);
        } else {
            this.mContext.sendBroadcastAsUser(intent, new UserHandle(i), null, bundle);
        }
    }

    public final void loadSettingsLocked(DevicePolicyData devicePolicyData, final int i) {
        DevicePolicyData.load(devicePolicyData, makeJournaledFile(i), new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda131
            @Override // java.util.function.Function
            public final Object apply(Object obj) {
                DeviceAdminInfo lambda$loadSettingsLocked$6;
                lambda$loadSettingsLocked$6 = DevicePolicyManagerService.this.lambda$loadSettingsLocked$6(i, (ComponentName) obj);
                return lambda$loadSettingsLocked$6;
            }
        }, getOwnerComponent(i));
        devicePolicyData.validatePasswordOwner();
        updateMaximumTimeToLockLocked(i);
        if (!isPolicyEngineForFinanceFlagEnabled()) {
            updateLockTaskPackagesLocked(this.mContext, devicePolicyData.mLockTaskPackages, i);
            updateLockTaskFeaturesLocked(devicePolicyData.mLockTaskFeatures, i);
        }
        boolean z = devicePolicyData.mStatusBarDisabled;
        if (z) {
            setStatusBarDisabledInternal(z, i);
        }
    }

    public /* synthetic */ DeviceAdminInfo lambda$loadSettingsLocked$6(int i, ComponentName componentName) {
        return findAdmin(componentName, i, false);
    }

    public static void updateLockTaskPackagesLocked(final Context context, final List list, final int i) {
        Binder.withCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda150
            public final void runOrThrow() {
                DevicePolicyManagerService.lambda$updateLockTaskPackagesLocked$7(list, context, i);
            }
        });
    }

    /* JADX WARN: Removed duplicated region for block: B:7:0x0028  */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public static /* synthetic */ void lambda$updateLockTaskPackagesLocked$7(java.util.List r1, android.content.Context r2, int r3) {
        /*
            boolean r0 = r1.isEmpty()
            if (r0 != 0) goto L25
            java.util.List r2 = listPolicyExemptAppsUnchecked(r2)
            boolean r0 = r2.isEmpty()
            if (r0 != 0) goto L25
            java.util.HashSet r0 = new java.util.HashSet
            r0.<init>(r1)
            r0.addAll(r2)
            int r2 = r0.size()
            java.lang.String[] r2 = new java.lang.String[r2]
            java.lang.Object[] r2 = r0.toArray(r2)
            java.lang.String[] r2 = (java.lang.String[]) r2
            goto L26
        L25:
            r2 = 0
        L26:
            if (r2 != 0) goto L35
            int r2 = r1.size()
            java.lang.String[] r2 = new java.lang.String[r2]
            java.lang.Object[] r1 = r1.toArray(r2)
            r2 = r1
            java.lang.String[] r2 = (java.lang.String[]) r2
        L35:
            android.app.IActivityManager r1 = android.app.ActivityManager.getService()     // Catch: android.os.RemoteException -> L3d
            r1.updateLockTaskPackages(r3, r2)     // Catch: android.os.RemoteException -> L3d
            goto L45
        L3d:
            r1 = move-exception
            java.lang.String r2 = "DevicePolicyManager"
            java.lang.String r3 = "Remote Exception: "
            android.util.Slog.wtf(r2, r3, r1)
        L45:
            return
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.lambda$updateLockTaskPackagesLocked$7(java.util.List, android.content.Context, int):void");
    }

    public static void updateLockTaskFeaturesLocked(final int i, final int i2) {
        Binder.withCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda177
            public final void runOrThrow() {
                DevicePolicyManagerService.lambda$updateLockTaskFeaturesLocked$8(i2, i);
            }
        });
    }

    public static /* synthetic */ void lambda$updateLockTaskFeaturesLocked$8(int i, int i2) {
        try {
            ActivityTaskManager.getService().updateLockTaskFeatures(i, i2);
        } catch (RemoteException e) {
            Slog.wtf("DevicePolicyManager", "Remote Exception: ", e);
        }
    }

    public static void validateQualityConstant(int i) {
        if (i == 0 || i == 32768 || i == 65536 || i == 131072 || i == 196608 || i == 262144 || i == 327680 || i == 393216 || i == 524288) {
            return;
        }
        throw new IllegalArgumentException("Invalid quality constant: 0x" + Integer.toHexString(i));
    }

    public void systemReady(int i) {
        if (this.mHasFeature) {
            if (i == 480) {
                onLockSettingsReady();
                loadAdminDataAsync();
                this.mOwners.systemReady();
                applyManagedSubscriptionsPolicyIfRequired();
                return;
            }
            if (i == 500) {
                synchronized (getLockObject()) {
                    this.mDevicePolicyEngine.reapplyAllPoliciesLocked();
                }
            } else {
                if (i != 550) {
                    if (i != 1000) {
                        return;
                    }
                    factoryResetIfDelayedEarlier();
                    ensureDeviceOwnerUserStarted();
                    return;
                }
                synchronized (getLockObject()) {
                    migrateToProfileOnOrganizationOwnedDeviceIfCompLocked();
                    applyProfileRestrictionsIfDeviceOwnerLocked();
                    if (shouldMigrateToDevicePolicyEngine()) {
                        migratePoliciesToDevicePolicyEngine();
                    }
                    maybeMigratePoliciesPostUpgradeToDevicePolicyEngineLocked();
                }
                maybeStartSecurityLogMonitorOnActivityManagerReady();
            }
        }
    }

    public final void applyManagedSubscriptionsPolicyIfRequired() {
        int organizationOwnedProfileUserId = getOrganizationOwnedProfileUserId();
        if (organizationOwnedProfileUserId != -10000) {
            unregisterOnSubscriptionsChangedListener();
            int policyType = getManagedSubscriptionsPolicy().getPolicyType();
            if (policyType == 0) {
                clearManagedSubscriptionsPolicy();
            } else if (policyType == 1) {
                registerListenerToAssignSubscriptionsToUser(organizationOwnedProfileUserId);
            }
        }
    }

    public final void updatePersonalAppsSuspensionOnUserStart(int i) {
        int managedUserId = getManagedUserId(i);
        if (managedUserId >= 0) {
            updatePersonalAppsSuspension(managedUserId);
        } else {
            suspendPersonalAppsInternal(i, managedUserId, false);
        }
    }

    public final void onLockSettingsReady() {
        List keepUninstalledPackagesLocked;
        synchronized (getLockObject()) {
            fixupAutoTimeRestrictionDuringOrganizationOwnedDeviceMigration();
        }
        lambda$getUserDataUnchecked$2(0);
        cleanUpOldUsers();
        maybeSetDefaultProfileOwnerUserRestrictions();
        handleStartUser(0);
        maybeLogStart();
        this.mSetupContentObserver.register();
        updateUserSetupCompleteAndPaired();
        synchronized (getLockObject()) {
            keepUninstalledPackagesLocked = getKeepUninstalledPackagesLocked();
        }
        if (keepUninstalledPackagesLocked != null) {
            this.mInjector.getPackageManagerInternal().setKeepUninstalledPackages(keepUninstalledPackagesLocked);
        }
        synchronized (getLockObject()) {
            ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
            if (deviceOwnerAdminLocked != null) {
                this.mUserManagerInternal.setForceEphemeralUsers(deviceOwnerAdminLocked.forceEphemeralUsers);
                ActivityManagerInternal activityManagerInternal = this.mInjector.getActivityManagerInternal();
                activityManagerInternal.setSwitchingFromSystemUserMessage(deviceOwnerAdminLocked.startUserSessionMessage);
                activityManagerInternal.setSwitchingToSystemUserMessage(deviceOwnerAdminLocked.endUserSessionMessage);
            }
            revertTransferOwnershipIfNecessaryLocked();
        }
        updateUsbDataSignal();
        setKeepProfileRunningEnabledUnchecked(isKeepProfilesRunningFlagEnabled());
    }

    /* loaded from: classes2.dex */
    public class DpmsUpgradeDataProvider implements PolicyUpgraderDataProvider {
        public /* synthetic */ DpmsUpgradeDataProvider(DevicePolicyManagerService devicePolicyManagerService, DpmsUpgradeDataProviderIA dpmsUpgradeDataProviderIA) {
            this();
        }

        public DpmsUpgradeDataProvider() {
        }

        @Override // com.android.server.devicepolicy.PolicyUpgraderDataProvider
        public JournaledFile makeDevicePoliciesJournaledFile(int i) {
            return DevicePolicyManagerService.this.makeJournaledFile(i, "device_policies.xml");
        }

        @Override // com.android.server.devicepolicy.PolicyUpgraderDataProvider
        public JournaledFile makePoliciesVersionJournaledFile(int i) {
            return DevicePolicyManagerService.this.makeJournaledFile(i, "device_policies_version");
        }

        @Override // com.android.server.devicepolicy.PolicyUpgraderDataProvider
        public Function getAdminInfoSupplier(final int i) {
            return new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$DpmsUpgradeDataProvider$$ExternalSyntheticLambda0
                @Override // java.util.function.Function
                public final Object apply(Object obj) {
                    DeviceAdminInfo lambda$getAdminInfoSupplier$0;
                    lambda$getAdminInfoSupplier$0 = DevicePolicyManagerService.DpmsUpgradeDataProvider.this.lambda$getAdminInfoSupplier$0(i, (ComponentName) obj);
                    return lambda$getAdminInfoSupplier$0;
                }
            };
        }

        public /* synthetic */ DeviceAdminInfo lambda$getAdminInfoSupplier$0(int i, ComponentName componentName) {
            return DevicePolicyManagerService.this.findAdmin(componentName, i, false);
        }

        @Override // com.android.server.devicepolicy.PolicyUpgraderDataProvider
        public int[] getUsersForUpgrade() {
            return DevicePolicyManagerService.this.mUserManager.getUsers().stream().mapToInt(new ToIntFunction() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$DpmsUpgradeDataProvider$$ExternalSyntheticLambda3
                @Override // java.util.function.ToIntFunction
                public final int applyAsInt(Object obj) {
                    int i;
                    i = ((UserInfo) obj).id;
                    return i;
                }
            }).toArray();
        }

        @Override // com.android.server.devicepolicy.PolicyUpgraderDataProvider
        public List getPlatformSuspendedPackages(final int i) {
            final PackageManagerInternal packageManagerInternal = DevicePolicyManagerService.this.mInjector.getPackageManagerInternal();
            return (List) DevicePolicyManagerService.this.mInjector.getPackageManager(i).getInstalledPackages(PackageManager.PackageInfoFlags.of(786432L)).stream().map(new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$DpmsUpgradeDataProvider$$ExternalSyntheticLambda1
                @Override // java.util.function.Function
                public final Object apply(Object obj) {
                    String str;
                    str = ((PackageInfo) obj).packageName;
                    return str;
                }
            }).filter(new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$DpmsUpgradeDataProvider$$ExternalSyntheticLambda2
                @Override // java.util.function.Predicate
                public final boolean test(Object obj) {
                    boolean lambda$getPlatformSuspendedPackages$3;
                    lambda$getPlatformSuspendedPackages$3 = DevicePolicyManagerService.DpmsUpgradeDataProvider.lambda$getPlatformSuspendedPackages$3(PackageManagerInternal.this, i, (String) obj);
                    return lambda$getPlatformSuspendedPackages$3;
                }
            }).collect(Collectors.toList());
        }

        public static /* synthetic */ boolean lambda$getPlatformSuspendedPackages$3(PackageManagerInternal packageManagerInternal, int i, String str) {
            return "android".equals(packageManagerInternal.getSuspendingPackage(str, i));
        }
    }

    public final void performPolicyVersionUpgrade() {
        new PolicyVersionUpgrader(new DpmsUpgradeDataProvider(), this.mPathProvider).upgradePolicy(6);
    }

    public final void revertTransferOwnershipIfNecessaryLocked() {
        if (this.mTransferOwnershipMetadataManager.metadataFileExists()) {
            Slogf.e("DevicePolicyManager", "Owner transfer metadata file exists! Reverting transfer.");
            TransferOwnershipMetadataManager.Metadata loadMetadataFile = this.mTransferOwnershipMetadataManager.loadMetadataFile();
            if (loadMetadataFile.adminType.equals("profile-owner")) {
                transferProfileOwnershipLocked(loadMetadataFile.targetComponent, loadMetadataFile.sourceComponent, loadMetadataFile.userId);
                deleteTransferOwnershipMetadataFileLocked();
                deleteTransferOwnershipBundleLocked(loadMetadataFile.userId);
            } else if (loadMetadataFile.adminType.equals("device-owner")) {
                transferDeviceOwnershipLocked(loadMetadataFile.targetComponent, loadMetadataFile.sourceComponent, loadMetadataFile.userId);
                deleteTransferOwnershipMetadataFileLocked();
                deleteTransferOwnershipBundleLocked(loadMetadataFile.userId);
            }
            updateSystemUpdateFreezePeriodsRecord(true);
            if (isPolicyEngineForFinanceFlagEnabled()) {
                return;
            }
            pushUserControlDisabledPackagesLocked(loadMetadataFile.userId);
        }
    }

    public final void maybeLogStart() {
        if (SecurityLog.isLoggingEnabled()) {
            SecurityLog.writeEvent(210009, new Object[]{this.mInjector.systemPropertiesGet("ro.boot.verifiedbootstate"), this.mInjector.systemPropertiesGet("ro.boot.veritymode")});
        }
    }

    public final void ensureDeviceOwnerUserStarted() {
        synchronized (getLockObject()) {
            if (this.mOwners.hasDeviceOwner()) {
                int deviceOwnerUserId = this.mOwners.getDeviceOwnerUserId();
                if (deviceOwnerUserId != 0) {
                    try {
                        this.mInjector.getIActivityManager().startUserInBackground(deviceOwnerUserId);
                    } catch (RemoteException e) {
                        Slogf.w("DevicePolicyManager", "Exception starting user", e);
                    }
                }
            }
        }
    }

    public void handleStartUser(int i) {
        List of;
        synchronized (getLockObject()) {
            pushScreenCapturePolicy(i);
            if (!isPolicyEngineForFinanceFlagEnabled()) {
                pushUserControlDisabledPackagesLocked(i);
            }
        }
        pushUserRestrictions(i);
        updatePasswordQualityCacheForUserGroup(i == 0 ? -1 : i);
        updatePermissionPolicyCache(i);
        updateAdminCanGrantSensorsPermissionCache(i);
        synchronized (getLockObject()) {
            ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(i);
            if (deviceOrProfileOwnerAdminLocked != null) {
                of = deviceOrProfileOwnerAdminLocked.mPreferentialNetworkServiceConfigs;
            } else {
                of = List.of(PreferentialNetworkServiceConfig.DEFAULT);
            }
        }
        updateNetworkPreferenceForUser(i, of);
        if (isProfileOwnerOfOrganizationOwnedDevice(i) && getManagedSubscriptionsPolicy().getPolicyType() == 1) {
            lambda$setDefaultSmsApplication$90();
        }
        startOwnerService(i, "start-user");
        if (isPermissionCheckFlagEnabled() || isPolicyEngineForFinanceFlagEnabled()) {
            this.mDevicePolicyEngine.handleStartUser(i);
        }
    }

    public void pushUserControlDisabledPackagesLocked(int i) {
        ActiveAdmin profileOwnerAdminLocked;
        final int i2;
        final List list;
        if (getDeviceOwnerUserIdUncheckedLocked() == i) {
            profileOwnerAdminLocked = getDeviceOwnerAdminLocked();
            i2 = -1;
        } else {
            profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            i2 = i;
        }
        if (profileOwnerAdminLocked == null || (list = profileOwnerAdminLocked.protectedPackages) == null) {
            list = null;
        }
        ProtectedPackagesFilter.getInstance().updateProtectedPackages(i, list);
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda23
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$pushUserControlDisabledPackagesLocked$9(i2, list);
            }
        });
        this.mUsageStatsManagerInternal.setAdminProtectedPackages(new ArraySet(list), i2);
    }

    public /* synthetic */ void lambda$pushUserControlDisabledPackagesLocked$9(int i, List list) {
        this.mInjector.getPackageManagerInternal().setOwnerProtectedPackages(i, list);
    }

    public void handleUnlockUser(int i) {
        startOwnerService(i, "unlock-user");
        if (isPermissionCheckFlagEnabled() || isPolicyEngineForFinanceFlagEnabled()) {
            this.mDevicePolicyEngine.handleUnlockUser(i);
        }
    }

    public void handleOnUserUnlocked(int i) {
        showNewUserDisclaimerIfNecessary(i);
    }

    public void handleStopUser(int i) {
        updateNetworkPreferenceForUser(i, List.of(PreferentialNetworkServiceConfig.DEFAULT));
        this.mDeviceAdminServiceController.stopServicesForUser(i, "stop-user");
        if (isPermissionCheckFlagEnabled() || isPolicyEngineForFinanceFlagEnabled()) {
            this.mDevicePolicyEngine.handleStopUser(i);
        }
    }

    public final void startOwnerService(int i, String str) {
        ComponentName ownerComponent = getOwnerComponent(i);
        if (ownerComponent != null) {
            this.mDeviceAdminServiceController.startServiceForAdmin(ownerComponent.getPackageName(), i, str);
            invalidateBinderCaches();
        }
    }

    public final void cleanUpOldUsers() {
        Set profileOwnerKeys;
        ArraySet arraySet;
        synchronized (getLockObject()) {
            profileOwnerKeys = this.mOwners.getProfileOwnerKeys();
            arraySet = new ArraySet();
            for (int i = 0; i < this.mUserData.size(); i++) {
                arraySet.add(Integer.valueOf(this.mUserData.keyAt(i)));
            }
        }
        List users = this.mUserManager.getUsers();
        ArraySet<Integer> arraySet2 = new ArraySet();
        arraySet2.addAll(profileOwnerKeys);
        arraySet2.addAll((Collection) arraySet);
        Iterator it = users.iterator();
        while (it.hasNext()) {
            arraySet2.remove(Integer.valueOf(((UserInfo) it.next()).id));
        }
        for (Integer num : arraySet2) {
            removeUserData(num.intValue());
            if (isPolicyEngineForFinanceFlagEnabled() || isPermissionCheckFlagEnabled()) {
                this.mDevicePolicyEngine.handleUserRemoved(num.intValue());
            }
        }
    }

    public final void handlePasswordExpirationNotification(int i) {
        boolean z;
        IEnterpriseDeviceManager iEDMService;
        Bundle bundle = new Bundle();
        bundle.putParcelable("android.intent.extra.USER", UserHandle.of(i));
        synchronized (getLockObject()) {
            long currentTimeMillis = System.currentTimeMillis();
            List activeAdminsForLockscreenPoliciesLocked = getActiveAdminsForLockscreenPoliciesLocked(i);
            int size = activeAdminsForLockscreenPoliciesLocked.size();
            for (int i2 = 0; i2 < size; i2++) {
                ActiveAdmin activeAdmin = (ActiveAdmin) activeAdminsForLockscreenPoliciesLocked.get(i2);
                if ((activeAdmin.isPermissionBased || activeAdmin.info.usesPolicy(6)) && activeAdmin.passwordExpirationTimeout > 0) {
                    long j = activeAdmin.passwordExpirationDate;
                    if (currentTimeMillis >= j - EXPIRATION_GRACE_PERIOD_MS && j > 0) {
                        sendAdminCommandLocked(activeAdmin, "android.app.action.ACTION_PASSWORD_EXPIRING", bundle, (BroadcastReceiver) null);
                        try {
                            iEDMService = this.mInjector.getIEDMService();
                        } catch (Exception e) {
                            e.printStackTrace();
                        }
                        if (iEDMService != null) {
                            z = iEDMService.isEmailAdminPkg(activeAdmin.info.getPackageName());
                            if (!z && !isDeviceOwner(activeAdmin) && !isProfileOwner(activeAdmin.info.getComponent(), activeAdmin.getUserHandle().getIdentifier())) {
                                Intent intent = new Intent("com.samsung.android.knox.intent.action.NOTIFICATION_PASSWORD_EXPIRED_INTERNAL");
                                intent.putExtra("pkgName", activeAdmin.info.getPackageName());
                                intent.putExtra("expiration", activeAdmin.passwordExpirationDate);
                                this.mContext.sendBroadcastAsUser(intent, new UserHandle(lambda$getUserDataUnchecked$2(i).mUserId));
                            }
                        }
                        z = false;
                        if (!z) {
                            Intent intent2 = new Intent("com.samsung.android.knox.intent.action.NOTIFICATION_PASSWORD_EXPIRED_INTERNAL");
                            intent2.putExtra("pkgName", activeAdmin.info.getPackageName());
                            intent2.putExtra("expiration", activeAdmin.passwordExpirationDate);
                            this.mContext.sendBroadcastAsUser(intent2, new UserHandle(lambda$getUserDataUnchecked$2(i).mUserId));
                        }
                    }
                }
            }
            setExpirationAlarmCheckLocked(this.mContext, i, false);
        }
    }

    public void onInstalledCertificatesChanged(UserHandle userHandle, Collection collection) {
        if (this.mHasFeature) {
            Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()));
            synchronized (getLockObject()) {
                DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(userHandle.getIdentifier());
                if (lambda$getUserDataUnchecked$2.mOwnerInstalledCaCerts.retainAll(collection) | lambda$getUserDataUnchecked$2.mAcceptedCaCertificates.retainAll(collection) | false) {
                    saveSettingsLocked(userHandle.getIdentifier());
                }
            }
        }
    }

    public Set getAcceptedCaCertificates(UserHandle userHandle) {
        ArraySet arraySet;
        if (!this.mHasFeature) {
            return Collections.emptySet();
        }
        synchronized (getLockObject()) {
            arraySet = lambda$getUserDataUnchecked$2(userHandle.getIdentifier()).mAcceptedCaCertificates;
        }
        return arraySet;
    }

    public void setActiveAdmin(final ComponentName componentName, final boolean z, final int i) {
        if (this.mHasFeature) {
            Preconditions.checkArgumentNonnegative(i, "Invalid userId");
            CallerIdentity callerIdentity = getCallerIdentity();
            Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_DEVICE_ADMINS"));
            Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i));
            final DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            final DeviceAdminInfo findAdmin = findAdmin(componentName, i, true);
            try {
                IRestrictionPolicy restrictionService = this.mInjector.getRestrictionService();
                if (restrictionService != null && !restrictionService.checkAdminActivationEnabled(i, componentName.getPackageName())) {
                    throw new IllegalArgumentException("Admin cannot be activated");
                }
            } catch (RemoteException unused) {
            }
            synchronized (getLockObject()) {
                checkActiveAdminPrecondition(componentName, findAdmin, lambda$getUserDataUnchecked$2);
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda111
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$setActiveAdmin$10(componentName, i, z, findAdmin, lambda$getUserDataUnchecked$2);
                    }
                });
            }
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                IEnterpriseDeviceManager iEDMService = this.mInjector.getIEDMService();
                if (iEDMService != null) {
                    try {
                        iEDMService.reconcileAdmin(componentName, i);
                        makeAuditLogGroupSystem(String.format("Package %s has been activated as admin.", componentName.getPackageName()), i);
                    } catch (Exception e) {
                        Log.e("DevicePolicyManager", "setActiveAdmin() : failed to call EDMS.reconcileAdmin()", e);
                    }
                } else {
                    Log.i("DevicePolicyManager", "setActiveAdmin() : passed EDMS.reconcileAdmin() because edms is null");
                }
            } finally {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        }
    }

    public /* synthetic */ void lambda$setActiveAdmin$10(ComponentName componentName, int i, boolean z, DeviceAdminInfo deviceAdminInfo, DevicePolicyData devicePolicyData) {
        boolean isPackageTestOnly;
        ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
        if (!z && activeAdminUncheckedLocked != null) {
            throw new IllegalArgumentException("Admin is already added");
        }
        int i2 = 0;
        ActiveAdmin activeAdmin = new ActiveAdmin(deviceAdminInfo, false);
        if (activeAdminUncheckedLocked != null) {
            isPackageTestOnly = activeAdminUncheckedLocked.testOnlyAdmin;
        } else {
            isPackageTestOnly = isPackageTestOnly(componentName.getPackageName(), i);
        }
        activeAdmin.testOnlyAdmin = isPackageTestOnly;
        devicePolicyData.mAdminMap.put(componentName, activeAdmin);
        int size = devicePolicyData.mAdminList.size();
        while (true) {
            if (i2 >= size) {
                i2 = -1;
                break;
            } else if (((ActiveAdmin) devicePolicyData.mAdminList.get(i2)).info.getComponent().equals(componentName)) {
                break;
            } else {
                i2++;
            }
        }
        if (i2 == -1) {
            devicePolicyData.mAdminList.add(activeAdmin);
            enableIfNecessary(deviceAdminInfo.getPackageName(), i);
            this.mUsageStatsManagerInternal.onActiveAdminAdded(componentName.getPackageName(), i);
        } else {
            devicePolicyData.mAdminList.set(i2, activeAdmin);
        }
        this.oldAllowWifi = activeAdmin.allowWifi;
        saveSettingsLocked(i);
        sendAdminCommandLocked(activeAdmin, "android.app.action.DEVICE_ADMIN_ENABLED", (Bundle) null, (BroadcastReceiver) null);
    }

    public final void loadAdminDataAsync() {
        this.mInjector.postOnSystemServerInitThreadPool(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda7
            @Override // java.lang.Runnable
            public final void run() {
                DevicePolicyManagerService.this.lambda$loadAdminDataAsync$11();
            }
        });
    }

    public /* synthetic */ void lambda$loadAdminDataAsync$11() {
        pushActiveAdminPackages();
        this.mUsageStatsManagerInternal.onAdminDataAvailable();
        pushAllMeteredRestrictedPackages();
        this.mInjector.getNetworkPolicyManagerInternal().onAdminDataAvailable();
    }

    public final void pushActiveAdminPackages() {
        synchronized (getLockObject()) {
            List users = this.mUserManager.getUsers();
            for (int size = users.size() - 1; size >= 0; size--) {
                int i = ((UserInfo) users.get(size)).id;
                this.mUsageStatsManagerInternal.setActiveAdminApps(getActiveAdminPackagesLocked(i), i);
            }
        }
    }

    public final void pushAllMeteredRestrictedPackages() {
        synchronized (getLockObject()) {
            List users = this.mUserManager.getUsers();
            for (int size = users.size() - 1; size >= 0; size--) {
                int i = ((UserInfo) users.get(size)).id;
                this.mInjector.getNetworkPolicyManagerInternal().setMeteredRestrictedPackagesAsync(getMeteredDisabledPackages(i), i);
            }
        }
    }

    public final void pushActiveAdminPackagesLocked(int i) {
        this.mUsageStatsManagerInternal.setActiveAdminApps(getActiveAdminPackagesLocked(i), i);
    }

    public final Set getActiveAdminPackagesLocked(int i) {
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
        ArraySet arraySet = null;
        for (int size = lambda$getUserDataUnchecked$2.mAdminList.size() - 1; size >= 0; size--) {
            String packageName = ((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(size)).info.getPackageName();
            if (arraySet == null) {
                arraySet = new ArraySet();
            }
            arraySet.add(packageName);
        }
        return arraySet;
    }

    public final void transferActiveAdminUncheckedLocked(ComponentName componentName, ComponentName componentName2, int i) {
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
        if (lambda$getUserDataUnchecked$2.mAdminMap.containsKey(componentName2) || !lambda$getUserDataUnchecked$2.mAdminMap.containsKey(componentName)) {
            DeviceAdminInfo findAdmin = findAdmin(componentName, i, true);
            ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminMap.get(componentName2);
            int uid = activeAdmin.getUid();
            if (isPolicyEngineForFinanceFlagEnabled() || isPermissionCheckFlagEnabled()) {
                this.mDevicePolicyEngine.transferPolicies(EnforcingAdmin.createEnterpriseEnforcingAdmin(componentName2, i, activeAdmin), EnforcingAdmin.createEnterpriseEnforcingAdmin(componentName, i, activeAdmin));
            }
            activeAdmin.transfer(findAdmin);
            lambda$getUserDataUnchecked$2.mAdminMap.remove(componentName2);
            lambda$getUserDataUnchecked$2.mAdminMap.put(componentName, activeAdmin);
            if (lambda$getUserDataUnchecked$2.mPasswordOwner == uid) {
                lambda$getUserDataUnchecked$2.mPasswordOwner = activeAdmin.getUid();
            }
            saveSettingsLocked(i);
            sendAdminCommandLocked(activeAdmin, "android.app.action.DEVICE_ADMIN_ENABLED", (Bundle) null, (BroadcastReceiver) null);
        }
    }

    public final void checkActiveAdminPrecondition(ComponentName componentName, DeviceAdminInfo deviceAdminInfo, DevicePolicyData devicePolicyData) {
        if (deviceAdminInfo == null) {
            throw new IllegalArgumentException("Bad admin: " + componentName);
        }
        if (!deviceAdminInfo.getActivityInfo().applicationInfo.isInternal()) {
            throw new IllegalArgumentException("Only apps in internal storage can be active admin: " + componentName);
        }
        if (deviceAdminInfo.getActivityInfo().applicationInfo.isInstantApp()) {
            throw new IllegalArgumentException("Instant apps cannot be device admins: " + componentName);
        }
        if (devicePolicyData.mRemovingAdmins.contains(componentName)) {
            throw new IllegalArgumentException("Trying to set an admin which is being removed");
        }
    }

    public final void checkAllUsersAreAffiliatedWithDevice() {
        Preconditions.checkCallAuthorization(areAllUsersAffiliatedWithDeviceLocked(), "operation not allowed when device has unaffiliated users");
    }

    public boolean isAdminActive(ComponentName componentName, int i) {
        boolean z;
        if (!this.mHasFeature) {
            return false;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        synchronized (getLockObject()) {
            z = getActiveAdminUncheckedLocked(componentName, i) != null;
        }
        return z;
    }

    public boolean isRemovingAdmin(ComponentName componentName, int i) {
        boolean contains;
        if (!this.mHasFeature) {
            return false;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        synchronized (getLockObject()) {
            contains = lambda$getUserDataUnchecked$2(i).mRemovingAdmins.contains(componentName);
        }
        return contains;
    }

    public boolean hasGrantedPolicy(ComponentName componentName, int i, int i2) {
        boolean usesPolicy;
        if (!this.mHasFeature) {
            return false;
        }
        Preconditions.checkArgumentNonnegative(i2, "Invalid userId");
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i2));
        Preconditions.checkCallAuthorization(isCallingFromPackage(componentName.getPackageName(), callerIdentity.getUid()) || isSystemUid(callerIdentity));
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i2);
            if (activeAdminUncheckedLocked == null) {
                throw new SecurityException("No active admin " + componentName);
            }
            usesPolicy = activeAdminUncheckedLocked.info.usesPolicy(i);
        }
        return usesPolicy;
    }

    public List getActiveAdmins(int i) {
        if (!this.mHasFeature) {
            return Collections.EMPTY_LIST;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        synchronized (getLockObject()) {
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            if (size <= 0) {
                return null;
            }
            ArrayList arrayList = new ArrayList(size);
            for (int i2 = 0; i2 < size; i2++) {
                arrayList.add(((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2)).info.getComponent());
            }
            return arrayList;
        }
    }

    public boolean packageHasActiveAdmins(String str, int i) {
        if (!this.mHasFeature) {
            return false;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        synchronized (getLockObject()) {
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            for (int i2 = 0; i2 < size; i2++) {
                if (((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2)).info.getPackageName().equals(str)) {
                    return true;
                }
            }
            return false;
        }
    }

    public void forceRemoveActiveAdmin(final ComponentName componentName, final int i) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isAdb(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"), "Caller must be shell or hold MANAGE_PROFILE_AND_DEVICE_OWNERS to call forceRemoveActiveAdmin");
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda158
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$forceRemoveActiveAdmin$12(componentName, i);
                }
            });
        }
    }

    public /* synthetic */ void lambda$forceRemoveActiveAdmin$12(ComponentName componentName, int i) {
        boolean z;
        synchronized (getLockObject()) {
            if (!isAdminTestOnlyLocked(componentName, i)) {
                throw new SecurityException("Attempt to remove non-test admin " + componentName + " " + i);
            }
            if (isDeviceOwner(componentName, i)) {
                clearDeviceOwnerLocked(getDeviceOwnerAdminLocked(), i);
            }
            z = false;
            if (isProfileOwner(componentName, i)) {
                boolean isProfileOwnerOfOrganizationOwnedDevice = isProfileOwnerOfOrganizationOwnedDevice(i);
                clearProfileOwnerLocked(getActiveAdminUncheckedLocked(componentName, i, false), i);
                z = isProfileOwnerOfOrganizationOwnedDevice;
            }
        }
        removeAdminArtifacts(componentName, i);
        if (z) {
            UserHandle of = UserHandle.of(getProfileParentId(i));
            lambda$wipeDataWithReason$52(of);
            clearOrgOwnedProfileOwnerDeviceWidePolicies(of.getIdentifier());
        }
        Slogf.i("DevicePolicyManager", "Admin " + componentName + " removed from user " + i);
    }

    /* renamed from: clearOrgOwnedProfileOwnerUserRestrictions */
    public final void lambda$wipeDataWithReason$52(UserHandle userHandle) {
        this.mUserManager.setUserRestriction("no_remove_managed_profile", false, userHandle);
        this.mUserManager.setUserRestriction("no_add_user", false, userHandle);
    }

    public final void clearDeviceOwnerUserRestriction(UserHandle userHandle) {
        if (isHeadlessFlagEnabled()) {
            for (int i : this.mUserManagerInternal.getUserIds()) {
                UserHandle of = UserHandle.of(i);
                if (this.mUserManager.hasUserRestriction("no_add_user", of)) {
                    this.mUserManager.setUserRestriction("no_add_user", false, of);
                }
                if (this.mUserManager.hasUserRestriction("no_add_managed_profile", of)) {
                    this.mUserManager.setUserRestriction("no_add_managed_profile", false, of);
                }
                if (this.mUserManager.hasUserRestriction("no_add_clone_profile", of)) {
                    this.mUserManager.setUserRestriction("no_add_clone_profile", false, of);
                }
            }
            return;
        }
        if (this.mUserManager.hasUserRestriction("no_add_user", userHandle)) {
            this.mUserManager.setUserRestriction("no_add_user", false, userHandle);
        }
        if (this.mUserManager.hasUserRestriction("no_add_managed_profile", userHandle)) {
            this.mUserManager.setUserRestriction("no_add_managed_profile", false, userHandle);
        }
        if (this.mUserManager.hasUserRestriction("no_add_clone_profile", userHandle)) {
            this.mUserManager.setUserRestriction("no_add_clone_profile", false, userHandle);
        }
    }

    public final boolean isPackageTestOnly(String str, int i) {
        try {
            ApplicationInfo applicationInfo = this.mInjector.getIPackageManager().getApplicationInfo(str, 786432L, i);
            if (applicationInfo != null) {
                return (applicationInfo.flags & 256) != 0;
            }
            throw new IllegalStateException("Couldn't find package: " + str + " on user " + i);
        } catch (RemoteException e) {
            throw new IllegalStateException(e);
        }
    }

    public final boolean isAdminTestOnlyLocked(ComponentName componentName, int i) {
        ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
        return activeAdminUncheckedLocked != null && activeAdminUncheckedLocked.testOnlyAdmin;
    }

    /* JADX WARN: Code restructure failed: missing block: B:21:0x0081, code lost:
    
        if (r2 != false) goto L138;
     */
    /* JADX WARN: Multi-variable type inference failed */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public void removeActiveAdmin(final android.content.ComponentName r7, final int r8) {
        /*
            Method dump skipped, instructions count: 277
            To view this dump change 'Code comments level' option to 'DEBUG'
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.removeActiveAdmin(android.content.ComponentName, int):void");
    }

    public final boolean canSetPasswordQualityOnParent(String str, CallerIdentity callerIdentity) {
        return !this.mInjector.isChangeEnabled(165573442L, str, callerIdentity.getUserId()) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity);
    }

    public final boolean isPasswordLimitingAdminTargetingP(CallerIdentity callerIdentity) {
        boolean z;
        if (!callerIdentity.hasAdminComponent()) {
            return false;
        }
        synchronized (getLockObject()) {
            z = getActiveAdminWithPolicyForUidLocked(callerIdentity.getComponentName(), 0, callerIdentity.getUid()) != null;
        }
        return z;
    }

    public final boolean notSupportedOnAutomotive(String str) {
        if (!this.mIsAutomotive) {
            return false;
        }
        Slogf.i("DevicePolicyManager", "%s is not supported on automotive builds", str);
        return true;
    }

    public void setPasswordQuality(final ComponentName componentName, final int i, final boolean z) {
        if (!this.mHasFeature || notSupportedOnAutomotive("setPasswordQuality")) {
            return;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        validateQualityConstant(i);
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || isSystemUid(callerIdentity) || isPasswordLimitingAdminTargetingP(callerIdentity));
        if (z) {
            Preconditions.checkCallAuthorization(canSetPasswordQualityOnParent(componentName.getPackageName(), callerIdentity), "Profile Owner may not apply password quality requirements device-wide");
        }
        final int userId = callerIdentity.getUserId();
        synchronized (getLockObject()) {
            final ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 0, z);
            if (z) {
                Preconditions.checkState(!(getActiveAdminForCallerLocked(componentName, 0, false).mPasswordComplexity != 0), "Cannot set password quality when complexity is set on the primary admin. Set the primary admin's complexity to NONE first.");
            }
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda44
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setPasswordQuality$14(activeAdminForCallerLocked, i, userId, z, componentName);
                }
            });
        }
        DevicePolicyEventLogger devicePolicyEventLogger = DevicePolicyEventLogger.createEvent(1).setAdmin(componentName).setInt(i);
        String[] strArr = new String[1];
        strArr[0] = z ? "calledFromParent" : "notCalledFromParent";
        devicePolicyEventLogger.setStrings(strArr).write();
    }

    public /* synthetic */ void lambda$setPasswordQuality$14(ActiveAdmin activeAdmin, int i, int i2, boolean z, ComponentName componentName) {
        PasswordPolicy passwordPolicy = activeAdmin.mPasswordPolicy;
        if (passwordPolicy.quality != i) {
            passwordPolicy.quality = i;
            activeAdmin.mPasswordComplexity = 0;
            resetInactivePasswordRequirementsIfRPlus(i2, activeAdmin);
            updatePasswordValidityCheckpointLocked(i2, z);
            updatePasswordQualityCacheForUserGroup(i2);
            saveSettingsLocked(i2);
        }
        logPasswordQualitySetIfSecurityLogEnabled(componentName, i2, z, passwordPolicy);
    }

    public final boolean passwordQualityInvocationOrderCheckEnabled(String str, int i) {
        return this.mInjector.isChangeEnabled(123562444L, str, i);
    }

    public final void resetInactivePasswordRequirementsIfRPlus(int i, ActiveAdmin activeAdmin) {
        if (passwordQualityInvocationOrderCheckEnabled(activeAdmin.info.getPackageName(), i)) {
            PasswordPolicy passwordPolicy = activeAdmin.mPasswordPolicy;
            int i2 = passwordPolicy.quality;
            if (i2 < 131072) {
                passwordPolicy.length = 0;
            }
            if (i2 < 393216) {
                passwordPolicy.letters = 1;
                passwordPolicy.upperCase = 0;
                passwordPolicy.lowerCase = 0;
                passwordPolicy.numeric = 1;
                passwordPolicy.symbols = 1;
                passwordPolicy.nonLetter = 0;
            }
        }
    }

    public final Set updatePasswordValidityCheckpointLocked(int i, boolean z) {
        boolean isPasswordSufficientForUserWithoutCheckpointLocked;
        ArraySet arraySet = new ArraySet();
        int credentialOwner = getCredentialOwner(i, z);
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(credentialOwner);
        PasswordMetrics userPasswordMetrics = this.mLockSettingsInternal.getUserPasswordMetrics(credentialOwner);
        if (userPasswordMetrics != null && (isPasswordSufficientForUserWithoutCheckpointLocked = isPasswordSufficientForUserWithoutCheckpointLocked(userPasswordMetrics, getProfileParentUserIfRequested(i, z))) != lambda$getUserDataUnchecked$2.mPasswordValidAtLastCheckpoint) {
            lambda$getUserDataUnchecked$2.mPasswordValidAtLastCheckpoint = isPasswordSufficientForUserWithoutCheckpointLocked;
            arraySet.add(Integer.valueOf(credentialOwner));
        }
        return arraySet;
    }

    public final void updatePasswordQualityCacheForUserGroup(int i) {
        List profiles;
        if (i == -1) {
            profiles = this.mUserManager.getUsers();
        } else {
            profiles = this.mUserManager.getProfiles(i);
        }
        Iterator it = profiles.iterator();
        while (it.hasNext()) {
            int i2 = ((UserInfo) it.next()).id;
            this.mPolicyCache.setPasswordQuality(i2, getPasswordQuality(null, i2, false));
        }
    }

    public int getPasswordQuality(ComponentName componentName, int i, boolean z) {
        if (!this.mHasFeature) {
            return 0;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i));
        Preconditions.checkCallAuthorization(componentName == null || isCallingFromPackage(componentName.getPackageName(), callerIdentity.getUid()) || canQueryAdminPolicy(callerIdentity));
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i, z);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.mPasswordPolicy.quality : 0;
            }
            List activeAdminsForLockscreenPoliciesLocked = getActiveAdminsForLockscreenPoliciesLocked(getProfileParentUserIfRequested(i, z));
            int size = activeAdminsForLockscreenPoliciesLocked.size();
            int i2 = 0;
            while (r1 < size) {
                int i3 = ((ActiveAdmin) activeAdminsForLockscreenPoliciesLocked.get(r1)).mPasswordPolicy.quality;
                if (i2 < i3) {
                    i2 = i3;
                }
                r1++;
            }
            return i2;
        }
    }

    public final List getActiveAdminsForLockscreenPoliciesLocked(int i) {
        if (isSeparateProfileChallengeEnabled(i)) {
            if (isPermissionCheckFlagEnabled()) {
                return getActiveAdminsForAffectedUserInclPermissionBasedAdminLocked(i);
            }
            return getUserDataUnchecked(i).mAdminList;
        }
        if (isPermissionCheckFlagEnabled()) {
            return getActiveAdminsForUserAndItsManagedProfilesInclPermissionBasedAdminLocked(getProfileParentId(i), new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda173
                @Override // java.util.function.Predicate
                public final boolean test(Object obj) {
                    boolean lambda$getActiveAdminsForLockscreenPoliciesLocked$15;
                    lambda$getActiveAdminsForLockscreenPoliciesLocked$15 = DevicePolicyManagerService.this.lambda$getActiveAdminsForLockscreenPoliciesLocked$15((UserInfo) obj);
                    return lambda$getActiveAdminsForLockscreenPoliciesLocked$15;
                }
            });
        }
        return getActiveAdminsForUserAndItsManagedProfilesLocked(getProfileParentId(i), new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda174
            @Override // java.util.function.Predicate
            public final boolean test(Object obj) {
                boolean lambda$getActiveAdminsForLockscreenPoliciesLocked$16;
                lambda$getActiveAdminsForLockscreenPoliciesLocked$16 = DevicePolicyManagerService.this.lambda$getActiveAdminsForLockscreenPoliciesLocked$16((UserInfo) obj);
                return lambda$getActiveAdminsForLockscreenPoliciesLocked$16;
            }
        });
    }

    public /* synthetic */ boolean lambda$getActiveAdminsForLockscreenPoliciesLocked$15(UserInfo userInfo) {
        return !this.mLockPatternUtils.isSeparateProfileChallengeEnabled(userInfo.id);
    }

    public /* synthetic */ boolean lambda$getActiveAdminsForLockscreenPoliciesLocked$16(UserInfo userInfo) {
        return !this.mLockPatternUtils.isSeparateProfileChallengeEnabled(userInfo.id);
    }

    public final List getActiveAdminsForAffectedUserLocked(int i) {
        if (isManagedProfile(i)) {
            return getUserDataUnchecked(i).mAdminList;
        }
        return getActiveAdminsForUserAndItsManagedProfilesLocked(i, new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda45
            @Override // java.util.function.Predicate
            public final boolean test(Object obj) {
                boolean lambda$getActiveAdminsForAffectedUserLocked$17;
                lambda$getActiveAdminsForAffectedUserLocked$17 = DevicePolicyManagerService.lambda$getActiveAdminsForAffectedUserLocked$17((UserInfo) obj);
                return lambda$getActiveAdminsForAffectedUserLocked$17;
            }
        });
    }

    public final List getActiveAdminsForAffectedUserInclPermissionBasedAdminLocked(int i) {
        if (isManagedProfile(i)) {
            ArrayList arrayList = getUserDataUnchecked(i).mAdminList;
        }
        List activeAdminsForUserAndItsManagedProfilesInclPermissionBasedAdminLocked = getActiveAdminsForUserAndItsManagedProfilesInclPermissionBasedAdminLocked(i, new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda112
            @Override // java.util.function.Predicate
            public final boolean test(Object obj) {
                boolean lambda$getActiveAdminsForAffectedUserInclPermissionBasedAdminLocked$18;
                lambda$getActiveAdminsForAffectedUserInclPermissionBasedAdminLocked$18 = DevicePolicyManagerService.lambda$getActiveAdminsForAffectedUserInclPermissionBasedAdminLocked$18((UserInfo) obj);
                return lambda$getActiveAdminsForAffectedUserInclPermissionBasedAdminLocked$18;
            }
        });
        if (lambda$getUserDataUnchecked$2(i).mPermissionBasedAdmin != null) {
            activeAdminsForUserAndItsManagedProfilesInclPermissionBasedAdminLocked.add(lambda$getUserDataUnchecked$2(i).mPermissionBasedAdmin);
        }
        return activeAdminsForUserAndItsManagedProfilesInclPermissionBasedAdminLocked;
    }

    public final List getActiveAdminsForUserAndItsManagedProfilesLocked(final int i, final Predicate predicate) {
        final ArrayList arrayList = new ArrayList();
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda213
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$getActiveAdminsForUserAndItsManagedProfilesLocked$19(i, arrayList, predicate);
            }
        });
        return arrayList;
    }

    public /* synthetic */ void lambda$getActiveAdminsForUserAndItsManagedProfilesLocked$19(int i, ArrayList arrayList, Predicate predicate) {
        for (UserInfo userInfo : this.mUserManager.getProfiles(i)) {
            DevicePolicyData userDataUnchecked = getUserDataUnchecked(userInfo.id);
            if (userInfo.id == i) {
                arrayList.addAll(userDataUnchecked.mAdminList);
            } else if (userInfo.isManagedProfile()) {
                for (int i2 = 0; i2 < userDataUnchecked.mAdminList.size(); i2++) {
                    ActiveAdmin activeAdmin = (ActiveAdmin) userDataUnchecked.mAdminList.get(i2);
                    if (activeAdmin.hasParentActiveAdmin()) {
                        arrayList.add(activeAdmin.getParentActiveAdmin());
                    }
                    if (predicate.test(userInfo)) {
                        arrayList.add(activeAdmin);
                    }
                }
            }
        }
    }

    public final List getActiveAdminsForUserAndItsManagedProfilesInclPermissionBasedAdminLocked(final int i, final Predicate predicate) {
        final ArrayList arrayList = new ArrayList();
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda214
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$getActiveAdminsForUserAndItsManagedProfilesInclPermissionBasedAdminLocked$20(i, arrayList, predicate);
            }
        });
        return arrayList;
    }

    public /* synthetic */ void lambda$getActiveAdminsForUserAndItsManagedProfilesInclPermissionBasedAdminLocked$20(int i, ArrayList arrayList, Predicate predicate) {
        for (UserInfo userInfo : this.mUserManager.getProfiles(i)) {
            DevicePolicyData userDataUnchecked = getUserDataUnchecked(userInfo.id);
            if (userInfo.id == i) {
                arrayList.addAll(userDataUnchecked.mAdminList);
                ActiveAdmin activeAdmin = userDataUnchecked.mPermissionBasedAdmin;
                if (activeAdmin != null) {
                    arrayList.add(activeAdmin);
                }
            } else if (userInfo.isManagedProfile()) {
                for (int i2 = 0; i2 < userDataUnchecked.mAdminList.size(); i2++) {
                    ActiveAdmin activeAdmin2 = (ActiveAdmin) userDataUnchecked.mAdminList.get(i2);
                    if (activeAdmin2.hasParentActiveAdmin()) {
                        arrayList.add(activeAdmin2.getParentActiveAdmin());
                    }
                    if (predicate.test(userInfo)) {
                        arrayList.add(activeAdmin2);
                    }
                }
                if (userDataUnchecked.mPermissionBasedAdmin != null && predicate.test(userInfo)) {
                    arrayList.add(userDataUnchecked.mPermissionBasedAdmin);
                }
            }
        }
    }

    public final boolean isSeparateProfileChallengeEnabled(final int i) {
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda82
            public final Object getOrThrow() {
                Boolean lambda$isSeparateProfileChallengeEnabled$21;
                lambda$isSeparateProfileChallengeEnabled$21 = DevicePolicyManagerService.this.lambda$isSeparateProfileChallengeEnabled$21(i);
                return lambda$isSeparateProfileChallengeEnabled$21;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$isSeparateProfileChallengeEnabled$21(int i) {
        return Boolean.valueOf(this.mLockPatternUtils.isSeparateProfileChallengeEnabled(i));
    }

    public void setPasswordMinimumLength(ComponentName componentName, int i, boolean z) {
        if (!this.mHasFeature || notSupportedOnAutomotive("setPasswordMinimumLength")) {
            return;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 0, z);
            ensureMinimumQuality(userHandleGetCallingUserId, activeAdminForCallerLocked, IInstalld.FLAG_CLEAR_APP_DATA_KEEP_ART_PROFILES, "setPasswordMinimumLength");
            PasswordPolicy passwordPolicy = activeAdminForCallerLocked.mPasswordPolicy;
            if (passwordPolicy.length != i) {
                passwordPolicy.length = i;
                updatePasswordValidityCheckpointLocked(userHandleGetCallingUserId, z);
                saveSettingsLocked(userHandleGetCallingUserId);
            }
            logPasswordQualitySetIfSecurityLogEnabled(componentName, userHandleGetCallingUserId, z, passwordPolicy);
        }
        DevicePolicyEventLogger.createEvent(2).setAdmin(componentName).setInt(i).write();
    }

    public final void ensureMinimumQuality(final int i, final ActiveAdmin activeAdmin, final int i2, final String str) {
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda137
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$ensureMinimumQuality$22(activeAdmin, i2, i, str);
            }
        });
    }

    public /* synthetic */ void lambda$ensureMinimumQuality$22(ActiveAdmin activeAdmin, int i, int i2, String str) {
        if (activeAdmin.mPasswordPolicy.quality < i && passwordQualityInvocationOrderCheckEnabled(activeAdmin.info.getPackageName(), i2)) {
            throw new IllegalStateException(String.format("password quality should be at least %d for %s", Integer.valueOf(i), str));
        }
    }

    public int getPasswordMinimumLength(ComponentName componentName, int i, boolean z) {
        return getStrictestPasswordRequirement(componentName, i, z, new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda118
            @Override // java.util.function.Function
            public final Object apply(Object obj) {
                Integer lambda$getPasswordMinimumLength$23;
                lambda$getPasswordMinimumLength$23 = DevicePolicyManagerService.lambda$getPasswordMinimumLength$23((ActiveAdmin) obj);
                return lambda$getPasswordMinimumLength$23;
            }
        }, IInstalld.FLAG_CLEAR_APP_DATA_KEEP_ART_PROFILES);
    }

    public static /* synthetic */ Integer lambda$getPasswordMinimumLength$23(ActiveAdmin activeAdmin) {
        return Integer.valueOf(activeAdmin.mPasswordPolicy.length);
    }

    public void setPasswordHistoryLength(ComponentName componentName, int i, boolean z) {
        if (this.mHasFeature && this.mLockPatternUtils.hasSecureLockScreen()) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 0, z);
                if (activeAdminForCallerLocked.passwordHistoryLength != i) {
                    activeAdminForCallerLocked.passwordHistoryLength = i;
                    updatePasswordValidityCheckpointLocked(userHandleGetCallingUserId, z);
                    saveSettingsLocked(userHandleGetCallingUserId);
                }
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210018, new Object[]{componentName.getPackageName(), Integer.valueOf(userHandleGetCallingUserId), Integer.valueOf(z ? getProfileParentId(userHandleGetCallingUserId) : userHandleGetCallingUserId), Integer.valueOf(i)});
            }
        }
    }

    public int getPasswordHistoryLength(ComponentName componentName, int i, boolean z) {
        if (this.mLockPatternUtils.hasSecureLockScreen()) {
            return getStrictestPasswordRequirement(componentName, i, z, new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda166
                @Override // java.util.function.Function
                public final Object apply(Object obj) {
                    Integer lambda$getPasswordHistoryLength$24;
                    lambda$getPasswordHistoryLength$24 = DevicePolicyManagerService.lambda$getPasswordHistoryLength$24((ActiveAdmin) obj);
                    return lambda$getPasswordHistoryLength$24;
                }
            }, 0);
        }
        return 0;
    }

    public static /* synthetic */ Integer lambda$getPasswordHistoryLength$24(ActiveAdmin activeAdmin) {
        return Integer.valueOf(activeAdmin.passwordHistoryLength);
    }

    public void setPasswordExpirationTimeout(ComponentName componentName, String str, long j, boolean z) {
        ActiveAdmin activeAdminForCallerLocked;
        if (this.mHasFeature && this.mLockPatternUtils.hasSecureLockScreen()) {
            if (!isPermissionCheckFlagEnabled()) {
                Objects.requireNonNull(componentName, "ComponentName is null");
            }
            Preconditions.checkArgumentNonnegative(j, "Timeout must be >= 0 ms");
            int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            int profileParentId = z ? getProfileParentId(userHandleGetCallingUserId) : userHandleGetCallingUserId;
            synchronized (getLockObject()) {
                if (isPermissionCheckFlagEnabled()) {
                    activeAdminForCallerLocked = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS", getCallerIdentity(componentName, str).getPackageName(), profileParentId).getActiveAdmin();
                } else {
                    activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 6, z);
                }
                long currentTimeMillis = j > 0 ? System.currentTimeMillis() + j : 0L;
                activeAdminForCallerLocked.passwordExpirationDate = currentTimeMillis;
                activeAdminForCallerLocked.passwordExpirationTimeout = j;
                if (j > 0) {
                    Slogf.w("DevicePolicyManager", "setPasswordExpiration(): password will expire on " + DateFormat.getDateTimeInstance(2, 2).format(new Date(currentTimeMillis)));
                }
                saveSettingsLocked(userHandleGetCallingUserId);
                setExpirationAlarmCheckLocked(this.mContext, userHandleGetCallingUserId, z);
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210016, new Object[]{str, Integer.valueOf(userHandleGetCallingUserId), Integer.valueOf(profileParentId), Long.valueOf(j)});
            }
        }
    }

    public long getPasswordExpirationTimeout(ComponentName componentName, int i, boolean z) {
        if (!this.mHasFeature || !this.mLockPatternUtils.hasSecureLockScreen()) {
            return 0L;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(componentName), i));
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i, z);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.passwordExpirationTimeout : 0L;
            }
            List activeAdminsForLockscreenPoliciesLocked = getActiveAdminsForLockscreenPoliciesLocked(getProfileParentUserIfRequested(i, z));
            int size = activeAdminsForLockscreenPoliciesLocked.size();
            long j = 0;
            for (int i2 = 0; i2 < size; i2++) {
                ActiveAdmin activeAdmin = (ActiveAdmin) activeAdminsForLockscreenPoliciesLocked.get(i2);
                if (j != 0) {
                    long j2 = activeAdmin.passwordExpirationTimeout;
                    if (j2 != 0) {
                        if (j <= j2) {
                        }
                    }
                }
                j = activeAdmin.passwordExpirationTimeout;
            }
            return j;
        }
    }

    public boolean addCrossProfileWidgetProvider(ComponentName componentName, String str, String str2) {
        CallerIdentity callerIdentity;
        ActiveAdmin profileOwnerLocked;
        ActiveAdmin activeAdmin;
        ArrayList arrayList;
        if (isPermissionCheckFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        if (isPermissionCheckFlagEnabled()) {
            activeAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_PROFILE_INTERACTION", callerIdentity.getPackageName(), callerIdentity.getUserId()).getActiveAdmin();
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
            synchronized (getLockObject()) {
                profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
            }
            activeAdmin = profileOwnerLocked;
        }
        synchronized (getLockObject()) {
            if (activeAdmin.crossProfileWidgetProviders == null) {
                activeAdmin.crossProfileWidgetProviders = new ArrayList();
            }
            List list = activeAdmin.crossProfileWidgetProviders;
            if (list.contains(str2)) {
                arrayList = null;
            } else {
                list.add(str2);
                arrayList = new ArrayList(list);
                saveSettingsLocked(callerIdentity.getUserId());
            }
        }
        DevicePolicyEventLogger.createEvent(49).setAdmin(callerIdentity.getPackageName()).write();
        if (arrayList == null) {
            return false;
        }
        this.mLocalService.notifyCrossProfileProvidersChanged(callerIdentity.getUserId(), arrayList);
        return true;
    }

    public boolean removeCrossProfileWidgetProvider(ComponentName componentName, String str, String str2) {
        CallerIdentity callerIdentity;
        ActiveAdmin profileOwnerLocked;
        ActiveAdmin activeAdmin;
        ArrayList arrayList;
        if (isPermissionCheckFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        if (isPermissionCheckFlagEnabled()) {
            activeAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_PROFILE_INTERACTION", callerIdentity.getPackageName(), callerIdentity.getUserId()).getActiveAdmin();
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
            synchronized (getLockObject()) {
                profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
            }
            activeAdmin = profileOwnerLocked;
        }
        synchronized (getLockObject()) {
            List list = activeAdmin.crossProfileWidgetProviders;
            if (list != null && !list.isEmpty()) {
                List list2 = activeAdmin.crossProfileWidgetProviders;
                if (list2.remove(str2)) {
                    arrayList = new ArrayList(list2);
                    saveSettingsLocked(callerIdentity.getUserId());
                } else {
                    arrayList = null;
                }
                DevicePolicyEventLogger.createEvent(117).setAdmin(callerIdentity.getPackageName()).write();
                if (arrayList == null) {
                    return false;
                }
                this.mLocalService.notifyCrossProfileProvidersChanged(callerIdentity.getUserId(), arrayList);
                return true;
            }
            return false;
        }
    }

    public List getCrossProfileWidgetProviders(ComponentName componentName, String str) {
        CallerIdentity callerIdentity;
        ActiveAdmin profileOwnerLocked;
        ActiveAdmin activeAdmin;
        if (isPermissionCheckFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        if (isPermissionCheckFlagEnabled()) {
            activeAdmin = enforceCanQueryAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_PROFILE_INTERACTION", callerIdentity.getPackageName(), callerIdentity.getUserId()).getActiveAdmin();
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
            synchronized (getLockObject()) {
                profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
            }
            activeAdmin = profileOwnerLocked;
        }
        synchronized (getLockObject()) {
            List list = activeAdmin.crossProfileWidgetProviders;
            if (list != null && !list.isEmpty()) {
                if (this.mInjector.binderIsCallingUidMyUid()) {
                    return new ArrayList(activeAdmin.crossProfileWidgetProviders);
                }
                return activeAdmin.crossProfileWidgetProviders;
            }
            return null;
        }
    }

    public final long getPasswordExpirationLocked(ComponentName componentName, int i, boolean z) {
        if (componentName != null) {
            ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i, z);
            if (activeAdminUncheckedLocked != null) {
                return activeAdminUncheckedLocked.passwordExpirationDate;
            }
            return 0L;
        }
        List activeAdminsForLockscreenPoliciesLocked = getActiveAdminsForLockscreenPoliciesLocked(getProfileParentUserIfRequested(i, z));
        int size = activeAdminsForLockscreenPoliciesLocked.size();
        long j = 0;
        for (int i2 = 0; i2 < size; i2++) {
            ActiveAdmin activeAdmin = (ActiveAdmin) activeAdminsForLockscreenPoliciesLocked.get(i2);
            if (j != 0) {
                long j2 = activeAdmin.passwordExpirationDate;
                if (j2 != 0) {
                    if (j <= j2) {
                    }
                }
            }
            j = activeAdmin.passwordExpirationDate;
        }
        return j;
    }

    public long getPasswordExpiration(ComponentName componentName, int i, boolean z) {
        long passwordExpirationLocked;
        if (!this.mHasFeature || !this.mLockPatternUtils.hasSecureLockScreen()) {
            return 0L;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(componentName), i));
        synchronized (getLockObject()) {
            passwordExpirationLocked = getPasswordExpirationLocked(componentName, i, z);
        }
        return passwordExpirationLocked;
    }

    public void setPasswordMinimumUpperCase(ComponentName componentName, int i, boolean z) {
        if (!this.mHasFeature || notSupportedOnAutomotive("setPasswordMinimumUpperCase")) {
            return;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 0, z);
            ensureMinimumQuality(userHandleGetCallingUserId, activeAdminForCallerLocked, 393216, "setPasswordMinimumUpperCase");
            PasswordPolicy passwordPolicy = activeAdminForCallerLocked.mPasswordPolicy;
            if (passwordPolicy.upperCase != i) {
                passwordPolicy.upperCase = i;
                updatePasswordValidityCheckpointLocked(userHandleGetCallingUserId, z);
                saveSettingsLocked(userHandleGetCallingUserId);
            }
            logPasswordQualitySetIfSecurityLogEnabled(componentName, userHandleGetCallingUserId, z, passwordPolicy);
        }
        DevicePolicyEventLogger.createEvent(7).setAdmin(componentName).setInt(i).write();
    }

    public int getPasswordMinimumUpperCase(ComponentName componentName, int i, boolean z) {
        return getStrictestPasswordRequirement(componentName, i, z, new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda100
            @Override // java.util.function.Function
            public final Object apply(Object obj) {
                Integer lambda$getPasswordMinimumUpperCase$25;
                lambda$getPasswordMinimumUpperCase$25 = DevicePolicyManagerService.lambda$getPasswordMinimumUpperCase$25((ActiveAdmin) obj);
                return lambda$getPasswordMinimumUpperCase$25;
            }
        }, 393216);
    }

    public static /* synthetic */ Integer lambda$getPasswordMinimumUpperCase$25(ActiveAdmin activeAdmin) {
        return Integer.valueOf(activeAdmin.mPasswordPolicy.upperCase);
    }

    public void setPasswordMinimumLowerCase(ComponentName componentName, int i, boolean z) {
        if (notSupportedOnAutomotive("setPasswordMinimumLowerCase")) {
            return;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 0, z);
            ensureMinimumQuality(userHandleGetCallingUserId, activeAdminForCallerLocked, 393216, "setPasswordMinimumLowerCase");
            PasswordPolicy passwordPolicy = activeAdminForCallerLocked.mPasswordPolicy;
            if (passwordPolicy.lowerCase != i) {
                passwordPolicy.lowerCase = i;
                updatePasswordValidityCheckpointLocked(userHandleGetCallingUserId, z);
                saveSettingsLocked(userHandleGetCallingUserId);
            }
            logPasswordQualitySetIfSecurityLogEnabled(componentName, userHandleGetCallingUserId, z, passwordPolicy);
        }
        DevicePolicyEventLogger.createEvent(6).setAdmin(componentName).setInt(i).write();
    }

    public int getPasswordMinimumLowerCase(ComponentName componentName, int i, boolean z) {
        return getStrictestPasswordRequirement(componentName, i, z, new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda10
            @Override // java.util.function.Function
            public final Object apply(Object obj) {
                Integer lambda$getPasswordMinimumLowerCase$26;
                lambda$getPasswordMinimumLowerCase$26 = DevicePolicyManagerService.lambda$getPasswordMinimumLowerCase$26((ActiveAdmin) obj);
                return lambda$getPasswordMinimumLowerCase$26;
            }
        }, 393216);
    }

    public static /* synthetic */ Integer lambda$getPasswordMinimumLowerCase$26(ActiveAdmin activeAdmin) {
        return Integer.valueOf(activeAdmin.mPasswordPolicy.lowerCase);
    }

    public void setPasswordMinimumLetters(ComponentName componentName, int i, boolean z) {
        if (!this.mHasFeature || notSupportedOnAutomotive("setPasswordMinimumLetters")) {
            return;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 0, z);
            ensureMinimumQuality(userHandleGetCallingUserId, activeAdminForCallerLocked, 393216, "setPasswordMinimumLetters");
            PasswordPolicy passwordPolicy = activeAdminForCallerLocked.mPasswordPolicy;
            if (passwordPolicy.letters != i) {
                passwordPolicy.letters = i;
                updatePasswordValidityCheckpointLocked(userHandleGetCallingUserId, z);
                saveSettingsLocked(userHandleGetCallingUserId);
            }
            logPasswordQualitySetIfSecurityLogEnabled(componentName, userHandleGetCallingUserId, z, passwordPolicy);
        }
        DevicePolicyEventLogger.createEvent(5).setAdmin(componentName).setInt(i).write();
    }

    public int getPasswordMinimumLetters(ComponentName componentName, int i, boolean z) {
        return getStrictestPasswordRequirement(componentName, i, z, new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda108
            @Override // java.util.function.Function
            public final Object apply(Object obj) {
                Integer lambda$getPasswordMinimumLetters$27;
                lambda$getPasswordMinimumLetters$27 = DevicePolicyManagerService.lambda$getPasswordMinimumLetters$27((ActiveAdmin) obj);
                return lambda$getPasswordMinimumLetters$27;
            }
        }, 393216);
    }

    public static /* synthetic */ Integer lambda$getPasswordMinimumLetters$27(ActiveAdmin activeAdmin) {
        return Integer.valueOf(activeAdmin.mPasswordPolicy.letters);
    }

    public void setPasswordMinimumNumeric(ComponentName componentName, int i, boolean z) {
        if (!this.mHasFeature || notSupportedOnAutomotive("setPasswordMinimumNumeric")) {
            return;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 0, z);
            ensureMinimumQuality(userHandleGetCallingUserId, activeAdminForCallerLocked, 393216, "setPasswordMinimumNumeric");
            PasswordPolicy passwordPolicy = activeAdminForCallerLocked.mPasswordPolicy;
            if (passwordPolicy.numeric != i) {
                passwordPolicy.numeric = i;
                updatePasswordValidityCheckpointLocked(userHandleGetCallingUserId, z);
                saveSettingsLocked(userHandleGetCallingUserId);
            }
            logPasswordQualitySetIfSecurityLogEnabled(componentName, userHandleGetCallingUserId, z, passwordPolicy);
        }
        DevicePolicyEventLogger.createEvent(3).setAdmin(componentName).setInt(i).write();
    }

    public int getPasswordMinimumNumeric(ComponentName componentName, int i, boolean z) {
        return getStrictestPasswordRequirement(componentName, i, z, new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda182
            @Override // java.util.function.Function
            public final Object apply(Object obj) {
                Integer lambda$getPasswordMinimumNumeric$28;
                lambda$getPasswordMinimumNumeric$28 = DevicePolicyManagerService.lambda$getPasswordMinimumNumeric$28((ActiveAdmin) obj);
                return lambda$getPasswordMinimumNumeric$28;
            }
        }, 393216);
    }

    public static /* synthetic */ Integer lambda$getPasswordMinimumNumeric$28(ActiveAdmin activeAdmin) {
        return Integer.valueOf(activeAdmin.mPasswordPolicy.numeric);
    }

    public void setPasswordMinimumSymbols(ComponentName componentName, int i, boolean z) {
        if (!this.mHasFeature || notSupportedOnAutomotive("setPasswordMinimumSymbols")) {
            return;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 0, z);
            ensureMinimumQuality(userHandleGetCallingUserId, activeAdminForCallerLocked, 393216, "setPasswordMinimumSymbols");
            PasswordPolicy passwordPolicy = activeAdminForCallerLocked.mPasswordPolicy;
            if (passwordPolicy.symbols != i) {
                passwordPolicy.symbols = i;
                updatePasswordValidityCheckpointLocked(userHandleGetCallingUserId, z);
                saveSettingsLocked(userHandleGetCallingUserId);
            }
            logPasswordQualitySetIfSecurityLogEnabled(componentName, userHandleGetCallingUserId, z, passwordPolicy);
        }
        DevicePolicyEventLogger.createEvent(8).setAdmin(componentName).setInt(i).write();
    }

    public int getPasswordMinimumSymbols(ComponentName componentName, int i, boolean z) {
        return getStrictestPasswordRequirement(componentName, i, z, new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda187
            @Override // java.util.function.Function
            public final Object apply(Object obj) {
                Integer lambda$getPasswordMinimumSymbols$29;
                lambda$getPasswordMinimumSymbols$29 = DevicePolicyManagerService.lambda$getPasswordMinimumSymbols$29((ActiveAdmin) obj);
                return lambda$getPasswordMinimumSymbols$29;
            }
        }, 393216);
    }

    public static /* synthetic */ Integer lambda$getPasswordMinimumSymbols$29(ActiveAdmin activeAdmin) {
        return Integer.valueOf(activeAdmin.mPasswordPolicy.symbols);
    }

    public void setPasswordMinimumNonLetter(ComponentName componentName, int i, boolean z) {
        if (!this.mHasFeature || notSupportedOnAutomotive("setPasswordMinimumNonLetter")) {
            return;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 0, z);
            ensureMinimumQuality(userHandleGetCallingUserId, activeAdminForCallerLocked, 393216, "setPasswordMinimumNonLetter");
            PasswordPolicy passwordPolicy = activeAdminForCallerLocked.mPasswordPolicy;
            if (passwordPolicy.nonLetter != i) {
                passwordPolicy.nonLetter = i;
                updatePasswordValidityCheckpointLocked(userHandleGetCallingUserId, z);
                saveSettingsLocked(userHandleGetCallingUserId);
            }
            logPasswordQualitySetIfSecurityLogEnabled(componentName, userHandleGetCallingUserId, z, passwordPolicy);
        }
        DevicePolicyEventLogger.createEvent(4).setAdmin(componentName).setInt(i).write();
    }

    public int getPasswordMinimumNonLetter(ComponentName componentName, int i, boolean z) {
        return getStrictestPasswordRequirement(componentName, i, z, new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda197
            @Override // java.util.function.Function
            public final Object apply(Object obj) {
                Integer lambda$getPasswordMinimumNonLetter$30;
                lambda$getPasswordMinimumNonLetter$30 = DevicePolicyManagerService.lambda$getPasswordMinimumNonLetter$30((ActiveAdmin) obj);
                return lambda$getPasswordMinimumNonLetter$30;
            }
        }, 393216);
    }

    public static /* synthetic */ Integer lambda$getPasswordMinimumNonLetter$30(ActiveAdmin activeAdmin) {
        return Integer.valueOf(activeAdmin.mPasswordPolicy.nonLetter);
    }

    public final int getStrictestPasswordRequirement(ComponentName componentName, int i, boolean z, Function function, int i2) {
        if (!this.mHasFeature) {
            return 0;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(componentName), i));
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i, z);
                return activeAdminUncheckedLocked != null ? ((Integer) function.apply(activeAdminUncheckedLocked)).intValue() : 0;
            }
            List activeAdminsForLockscreenPoliciesLocked = getActiveAdminsForLockscreenPoliciesLocked(getProfileParentUserIfRequested(i, z));
            int size = activeAdminsForLockscreenPoliciesLocked.size();
            int i3 = 0;
            while (r1 < size) {
                ActiveAdmin activeAdmin = (ActiveAdmin) activeAdminsForLockscreenPoliciesLocked.get(r1);
                if (isLimitPasswordAllowed(activeAdmin, i2)) {
                    Integer num = (Integer) function.apply(activeAdmin);
                    if (num.intValue() > i3) {
                        i3 = num.intValue();
                    }
                }
                r1++;
            }
            return i3;
        }
    }

    public PasswordMetrics getPasswordMinimumMetrics(int i, boolean z) {
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i) && (isSystemUid(callerIdentity) || hasCallingOrSelfPermission("android.permission.SET_INITIAL_LOCK")));
        return getPasswordMinimumMetricsUnchecked(i, z);
    }

    public final PasswordMetrics getPasswordMinimumMetricsUnchecked(int i) {
        return getPasswordMinimumMetricsUnchecked(i, false);
    }

    public final PasswordMetrics getPasswordMinimumMetricsUnchecked(int i, boolean z) {
        List activeAdminsForLockscreenPoliciesLocked;
        if (!this.mHasFeature) {
            new PasswordMetrics(-1);
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        if (z) {
            Preconditions.checkArgument(!isManagedProfile(i));
        }
        ArrayList arrayList = new ArrayList();
        synchronized (getLockObject()) {
            if (z) {
                activeAdminsForLockscreenPoliciesLocked = getActiveAdminsForUserAndItsManagedProfilesLocked(i, new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda4
                    @Override // java.util.function.Predicate
                    public final boolean test(Object obj) {
                        boolean lambda$getPasswordMinimumMetricsUnchecked$31;
                        lambda$getPasswordMinimumMetricsUnchecked$31 = DevicePolicyManagerService.lambda$getPasswordMinimumMetricsUnchecked$31((UserInfo) obj);
                        return lambda$getPasswordMinimumMetricsUnchecked$31;
                    }
                });
            } else {
                activeAdminsForLockscreenPoliciesLocked = getActiveAdminsForLockscreenPoliciesLocked(i);
            }
            Iterator it = activeAdminsForLockscreenPoliciesLocked.iterator();
            while (it.hasNext()) {
                arrayList.add(((ActiveAdmin) it.next()).mPasswordPolicy.getMinMetrics());
            }
        }
        return PasswordMetrics.merge(arrayList);
    }

    public boolean isActivePasswordSufficient(String str, int i, boolean z) {
        boolean isActivePasswordSufficientForUserLocked;
        if (!this.mHasFeature) {
            return true;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        enforceUserUnlocked(i, z);
        synchronized (getLockObject()) {
            if (isPermissionCheckFlagEnabled()) {
                enforcePermission("android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS", str, z ? getProfileParentId(i) : i);
            } else if (this.mInjector.binderGetCallingPid() == Process.myPid()) {
                getActiveAdminForCallerLockedMDM(null, 0, i);
            } else {
                getActiveAdminForCallerLocked(null, 0, z);
            }
            int credentialOwner = getCredentialOwner(i, z);
            isActivePasswordSufficientForUserLocked = isActivePasswordSufficientForUserLocked(getUserDataUnchecked(credentialOwner).mPasswordValidAtLastCheckpoint, this.mLockSettingsInternal.getUserPasswordMetrics(credentialOwner), getProfileParentUserIfRequested(i, z));
        }
        return isActivePasswordSufficientForUserLocked;
    }

    public boolean isActivePasswordSufficientForDeviceRequirement() {
        boolean isEmpty;
        if (!this.mHasFeature) {
            return true;
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
        int userId = callerIdentity.getUserId();
        Preconditions.checkCallingUser(isManagedProfile(userId));
        int profileParentId = getProfileParentId(userId);
        enforceUserUnlocked(profileParentId);
        synchronized (getLockObject()) {
            isEmpty = PasswordMetrics.validatePasswordMetrics(getPasswordMinimumMetricsUnchecked(profileParentId, true), getAggregatedPasswordComplexityLocked(profileParentId, true), this.mLockSettingsInternal.getUserPasswordMetrics(profileParentId)).isEmpty();
        }
        DevicePolicyEventLogger.createEvent(189).setStrings(new String[]{this.mOwners.getProfileOwnerComponent(callerIdentity.getUserId()).getPackageName()}).write();
        return isEmpty;
    }

    public boolean isUsingUnifiedPassword(ComponentName componentName) {
        if (!this.mHasFeature) {
            return true;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        Preconditions.checkCallingUser(isManagedProfile(callerIdentity.getUserId()));
        return !isSeparateProfileChallengeEnabled(callerIdentity.getUserId());
    }

    public boolean isPasswordSufficientAfterProfileUnification(int i, final int i2) {
        boolean isEmpty;
        if (!this.mHasFeature) {
            return true;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        Preconditions.checkCallAuthorization(!isManagedProfile(i), "You can not check password sufficiency for a managed profile, userId = %d", new Object[]{Integer.valueOf(i)});
        enforceUserUnlocked(i);
        synchronized (getLockObject()) {
            PasswordMetrics userPasswordMetrics = this.mLockSettingsInternal.getUserPasswordMetrics(i);
            List<ActiveAdmin> activeAdminsForUserAndItsManagedProfilesLocked = getActiveAdminsForUserAndItsManagedProfilesLocked(i, new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda186
                @Override // java.util.function.Predicate
                public final boolean test(Object obj) {
                    boolean lambda$isPasswordSufficientAfterProfileUnification$32;
                    lambda$isPasswordSufficientAfterProfileUnification$32 = DevicePolicyManagerService.this.lambda$isPasswordSufficientAfterProfileUnification$32(i2, (UserInfo) obj);
                    return lambda$isPasswordSufficientAfterProfileUnification$32;
                }
            });
            ArrayList arrayList = new ArrayList(activeAdminsForUserAndItsManagedProfilesLocked.size());
            int i3 = 0;
            for (ActiveAdmin activeAdmin : activeAdminsForUserAndItsManagedProfilesLocked) {
                arrayList.add(activeAdmin.mPasswordPolicy.getMinMetrics());
                i3 = Math.max(i3, activeAdmin.mPasswordComplexity);
            }
            isEmpty = PasswordMetrics.validatePasswordMetrics(PasswordMetrics.merge(arrayList), i3, userPasswordMetrics).isEmpty();
        }
        return isEmpty;
    }

    public /* synthetic */ boolean lambda$isPasswordSufficientAfterProfileUnification$32(int i, UserInfo userInfo) {
        int i2 = userInfo.id;
        return i2 == i || !this.mLockPatternUtils.isSeparateProfileChallengeEnabled(i2);
    }

    public final boolean isActivePasswordSufficientForUserLocked(boolean z, PasswordMetrics passwordMetrics, int i) {
        if (!this.mInjector.storageManagerIsFileBasedEncryptionEnabled() && passwordMetrics == null) {
            return z;
        }
        if (passwordMetrics == null) {
            throw new IllegalStateException("isActivePasswordSufficient called on FBE-locked user");
        }
        return isPasswordSufficientForUserWithoutCheckpointLocked(passwordMetrics, i);
    }

    public final boolean isPasswordSufficientForUserWithoutCheckpointLocked(PasswordMetrics passwordMetrics, int i) {
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            if (!semIsSimplePasswordEnabled(null, i)) {
                if (this.mContext != null) {
                    if (this.mLockPatternUtils.isDevicePasswordSimple(i)) {
                        Slogf.e("DevicePolicyManager", "isActivePasswordSufficient() : simple password is not allowed");
                        this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                        return false;
                    }
                } else {
                    Slogf.e("DevicePolicyManager", "isActivePasswordSufficient() : fail to get isDevicePasswordSimple() due to mContext == null");
                }
            }
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            return PasswordMetrics.validatePasswordMetrics(getPasswordMinimumMetricsUnchecked(i), getAggregatedPasswordComplexityLocked(i), passwordMetrics).isEmpty();
        } catch (Throwable th) {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            throw th;
        }
    }

    public int getPasswordComplexity(boolean z) {
        CallerIdentity callerIdentity = getCallerIdentity();
        DevicePolicyEventLogger.createEvent(72).setStrings(z ? "calledFromParent" : "notCalledFromParent", this.mInjector.getPackageManager().getPackagesForUid(callerIdentity.getUid())).write();
        enforceUserUnlocked(callerIdentity.getUserId());
        boolean z2 = true;
        int i = 0;
        if (z) {
            if (!isDefaultDeviceOwner(callerIdentity) && !isProfileOwner(callerIdentity) && !isSystemUid(callerIdentity)) {
                z2 = false;
            }
            Preconditions.checkCallAuthorization(z2, "Only profile owner, device owner and system may call this method on parent.");
        } else if (isPermissionCheckFlagEnabled()) {
            if (!hasCallingOrSelfPermission("android.permission.REQUEST_PASSWORD_COMPLEXITY") && !hasCallingOrSelfPermission("android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS") && !isDefaultDeviceOwner(callerIdentity) && !isProfileOwner(callerIdentity)) {
                z2 = false;
            }
            Preconditions.checkCallAuthorization(z2, "Must have android.permission.REQUEST_PASSWORD_COMPLEXITY or android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS permissions, or be a profile owner or device owner.");
        } else {
            if (!hasCallingOrSelfPermission("android.permission.REQUEST_PASSWORD_COMPLEXITY") && !isDefaultDeviceOwner(callerIdentity) && !isProfileOwner(callerIdentity)) {
                z2 = false;
            }
            Preconditions.checkCallAuthorization(z2, "Must have android.permission.REQUEST_PASSWORD_COMPLEXITY permission, or be a profile owner or device owner.");
        }
        synchronized (getLockObject()) {
            PasswordMetrics userPasswordMetrics = this.mLockSettingsInternal.getUserPasswordMetrics(getCredentialOwner(callerIdentity.getUserId(), z));
            if (userPasswordMetrics != null) {
                i = userPasswordMetrics.determineComplexity();
            }
        }
        return i;
    }

    public void setRequiredPasswordComplexity(String str, final int i, final boolean z) {
        ActiveAdmin parentOfAdminIfRequired;
        if (this.mHasFeature) {
            Preconditions.checkArgument(Set.of(0, 65536, 196608, 327680).contains(Integer.valueOf(i)), "Provided complexity is not one of the allowed values.");
            final CallerIdentity callerIdentity = getCallerIdentity(str);
            if (!isPermissionCheckFlagEnabled()) {
                Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
                Preconditions.checkArgument(!z || isProfileOwner(callerIdentity));
            }
            synchronized (getLockObject()) {
                if (isPermissionCheckFlagEnabled()) {
                    parentOfAdminIfRequired = enforcePermissionAndGetEnforcingAdmin(null, "android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS", callerIdentity.getPackageName(), z ? getProfileParentId(callerIdentity.getUserId()) : callerIdentity.getUserId()).getActiveAdmin();
                } else {
                    parentOfAdminIfRequired = getParentOfAdminIfRequired(getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()), z);
                }
                final ActiveAdmin activeAdmin = parentOfAdminIfRequired;
                if (activeAdmin.mPasswordComplexity != i) {
                    if (!z) {
                        Preconditions.checkState(activeAdmin.hasParentActiveAdmin() && activeAdmin.getParentActiveAdmin().mPasswordPolicy.quality != 0 ? false : true, "Password quality is set on the parent when attempting to set passwordcomplexity. Clear the quality by setting the password quality on the parent to PASSWORD_QUALITY_UNSPECIFIED first");
                    }
                    this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda79
                        public final void runOrThrow() {
                            DevicePolicyManagerService.this.lambda$setRequiredPasswordComplexity$33(activeAdmin, i, callerIdentity, z);
                        }
                    });
                    DevicePolicyEventLogger.createEvent(177).setAdmin(activeAdmin.info.getPackageName()).setInt(i).setBoolean(z).write();
                }
                logPasswordComplexityRequiredIfSecurityLogEnabled(callerIdentity.getPackageName(), callerIdentity.getUserId(), z, i);
            }
        }
    }

    public /* synthetic */ void lambda$setRequiredPasswordComplexity$33(ActiveAdmin activeAdmin, int i, CallerIdentity callerIdentity, boolean z) {
        activeAdmin.mPasswordComplexity = i;
        activeAdmin.mPasswordPolicy = new PasswordPolicy();
        updatePasswordValidityCheckpointLocked(callerIdentity.getUserId(), z);
        updatePasswordQualityCacheForUserGroup(callerIdentity.getUserId());
        saveSettingsLocked(callerIdentity.getUserId());
    }

    public final void logPasswordComplexityRequiredIfSecurityLogEnabled(String str, int i, boolean z, int i2) {
        if (SecurityLog.isLoggingEnabled()) {
            SecurityLog.writeEvent(210035, new Object[]{str, Integer.valueOf(i), Integer.valueOf(z ? getProfileParentId(i) : i), Integer.valueOf(i2)});
        }
    }

    public final int getAggregatedPasswordComplexityLocked(int i) {
        return getAggregatedPasswordComplexityLocked(i, false);
    }

    public final int getAggregatedPasswordComplexityLocked(int i, boolean z) {
        List activeAdminsForLockscreenPoliciesLocked;
        ensureLocked();
        if (z) {
            activeAdminsForLockscreenPoliciesLocked = getActiveAdminsForUserAndItsManagedProfilesLocked(i, new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda184
                @Override // java.util.function.Predicate
                public final boolean test(Object obj) {
                    boolean lambda$getAggregatedPasswordComplexityLocked$34;
                    lambda$getAggregatedPasswordComplexityLocked$34 = DevicePolicyManagerService.lambda$getAggregatedPasswordComplexityLocked$34((UserInfo) obj);
                    return lambda$getAggregatedPasswordComplexityLocked$34;
                }
            });
        } else {
            activeAdminsForLockscreenPoliciesLocked = getActiveAdminsForLockscreenPoliciesLocked(i);
        }
        Iterator it = activeAdminsForLockscreenPoliciesLocked.iterator();
        int i2 = 0;
        while (it.hasNext()) {
            i2 = Math.max(i2, ((ActiveAdmin) it.next()).mPasswordComplexity);
        }
        return i2;
    }

    public int getRequiredPasswordComplexity(String str, boolean z) {
        int i;
        int userId;
        if (!this.mHasFeature) {
            return 0;
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        if (isPermissionCheckFlagEnabled()) {
            if (z) {
                userId = getProfileParentId(callerIdentity.getUserId());
            } else {
                userId = callerIdentity.getUserId();
            }
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS", str, userId);
        } else {
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
            Preconditions.checkArgument(!z || isProfileOwner(callerIdentity));
        }
        synchronized (getLockObject()) {
            i = getParentOfAdminIfRequired(getDeviceOrProfileOwnerAdminLocked(callerIdentity.getUserId()), z).mPasswordComplexity;
        }
        return i;
    }

    public int getAggregatedPasswordComplexityForUser(int i, boolean z) {
        int aggregatedPasswordComplexityLocked;
        if (!this.mHasFeature) {
            return 0;
        }
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        synchronized (getLockObject()) {
            aggregatedPasswordComplexityLocked = getAggregatedPasswordComplexityLocked(i, z);
        }
        return aggregatedPasswordComplexityLocked;
    }

    public int getCurrentFailedPasswordAttempts(String str, int i, boolean z) {
        int i2;
        if (!this.mLockPatternUtils.hasSecureLockScreen()) {
            return 0;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i));
        synchronized (getLockObject()) {
            if (!isSystemUid(callerIdentity) && !hasCallingPermission("android.permission.ACCESS_KEYGUARD_SECURE_STORAGE")) {
                if (isPermissionCheckFlagEnabled()) {
                    enforcePermission("android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS", str, z ? getProfileParentId(i) : i);
                } else {
                    getActiveAdminForCallerLocked(null, 1, z);
                }
            }
            i2 = getUserDataUnchecked(getCredentialOwner(i, z)).mFailedPasswordAttempts;
        }
        return i2;
    }

    public int getCurrentFailedBiometricAttempts(int i) {
        int i2;
        if (i == 0 || !isManagedProfile(i)) {
            return -1;
        }
        if (!this.mLockPatternUtils.hasSecureLockScreen()) {
            return 0;
        }
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        synchronized (getLockObject()) {
            if (!isSystemUid(getCallerIdentity()) && this.mContext.checkCallingPermission("android.permission.ACCESS_KEYGUARD_SECURE_STORAGE") != 0) {
                getActiveAdminForCallerLocked(null, 1);
            }
            i2 = getUserDataUnchecked(i).mFailedBiometricAttempts;
        }
        return i2;
    }

    public void setMaximumFailedPasswordsForWipe(ComponentName componentName, String str, int i, boolean z) {
        ActiveAdmin activeAdminForCallerLocked;
        if (this.mHasFeature && this.mLockPatternUtils.hasSecureLockScreen()) {
            if (!isPermissionCheckFlagEnabled()) {
                Objects.requireNonNull(componentName, "ComponentName is null");
            }
            int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            int profileParentId = z ? getProfileParentId(userHandleGetCallingUserId) : userHandleGetCallingUserId;
            synchronized (getLockObject()) {
                if (isPermissionCheckFlagEnabled()) {
                    activeAdminForCallerLocked = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_WIPE_DATA", 4, getCallerIdentity(componentName, str).getPackageName(), profileParentId).getActiveAdmin();
                } else {
                    getActiveAdminForCallerLocked(componentName, 4, z);
                    activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 1, z);
                }
                if (activeAdminForCallerLocked.maximumFailedPasswordsForWipe != i) {
                    activeAdminForCallerLocked.maximumFailedPasswordsForWipe = i;
                    saveSettingsLocked(userHandleGetCallingUserId);
                }
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210020, new Object[]{str, Integer.valueOf(userHandleGetCallingUserId), Integer.valueOf(profileParentId), Integer.valueOf(i)});
            }
        }
    }

    public int getMaximumFailedPasswordsForWipe(ComponentName componentName, int i, boolean z) {
        ActiveAdmin adminWithMinimumFailedPasswordsForWipeLocked;
        int i2;
        if (!this.mHasFeature || !this.mLockPatternUtils.hasSecureLockScreen()) {
            return 0;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i));
        Preconditions.checkCallAuthorization(componentName == null || isCallingFromPackage(componentName.getPackageName(), callerIdentity.getUid()) || canQueryAdminPolicy(callerIdentity));
        synchronized (getLockObject()) {
            if (componentName != null) {
                adminWithMinimumFailedPasswordsForWipeLocked = getActiveAdminUncheckedLocked(componentName, i, z);
            } else {
                adminWithMinimumFailedPasswordsForWipeLocked = getAdminWithMinimumFailedPasswordsForWipeLocked(i, z);
            }
            i2 = adminWithMinimumFailedPasswordsForWipeLocked != null ? adminWithMinimumFailedPasswordsForWipeLocked.maximumFailedPasswordsForWipe : 0;
        }
        return i2;
    }

    public int getProfileWithMinimumFailedPasswordsForWipe(int i, boolean z) {
        int userIdToWipeForFailedPasswords;
        if (!this.mHasFeature || !this.mLockPatternUtils.hasSecureLockScreen()) {
            return -10000;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        synchronized (getLockObject()) {
            ActiveAdmin adminWithMinimumFailedPasswordsForWipeLocked = getAdminWithMinimumFailedPasswordsForWipeLocked(i, z);
            userIdToWipeForFailedPasswords = adminWithMinimumFailedPasswordsForWipeLocked != null ? getUserIdToWipeForFailedPasswords(adminWithMinimumFailedPasswordsForWipeLocked) : -10000;
        }
        return userIdToWipeForFailedPasswords;
    }

    public final ActiveAdmin getAdminWithMinimumFailedPasswordsForWipeLocked(int i, boolean z) {
        int i2;
        List activeAdminsForLockscreenPoliciesLocked = getActiveAdminsForLockscreenPoliciesLocked(getProfileParentUserIfRequested(i, z));
        int size = activeAdminsForLockscreenPoliciesLocked.size();
        ActiveAdmin activeAdmin = null;
        int i3 = 0;
        for (int i4 = 0; i4 < size; i4++) {
            ActiveAdmin activeAdmin2 = (ActiveAdmin) activeAdminsForLockscreenPoliciesLocked.get(i4);
            if (activeAdmin2.maximumFailedPasswordsForWipe != 0) {
                int userIdToWipeForFailedPasswords = getUserIdToWipeForFailedPasswords(activeAdmin2);
                if (i3 == 0 || i3 > (i2 = activeAdmin2.maximumFailedPasswordsForWipe) || (i3 == i2 && getUserInfo(userIdToWipeForFailedPasswords).isPrimary())) {
                    i3 = activeAdmin2.maximumFailedPasswordsForWipe;
                    activeAdmin = activeAdmin2;
                }
            }
        }
        return activeAdmin;
    }

    public /* synthetic */ UserInfo lambda$getUserInfo$35(int i) {
        return this.mUserManager.getUserInfo(i);
    }

    public final UserInfo getUserInfo(final int i) {
        return (UserInfo) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda179
            public final Object getOrThrow() {
                UserInfo lambda$getUserInfo$35;
                lambda$getUserInfo$35 = DevicePolicyManagerService.this.lambda$getUserInfo$35(i);
                return lambda$getUserInfo$35;
            }
        });
    }

    public final boolean setPasswordPrivileged(String str, int i, CallerIdentity callerIdentity) {
        if (isLockScreenSecureUnchecked(callerIdentity.getUserId())) {
            throw new SecurityException("Cannot change current password");
        }
        return resetPasswordInternal(str, 0L, null, i, callerIdentity);
    }

    public boolean resetPassword(String str, int i) {
        if (!this.mLockPatternUtils.hasSecureLockScreen()) {
            Slogf.w("DevicePolicyManager", "Cannot reset password when the device has no lock screen");
            return false;
        }
        if (str == null) {
            str = "";
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        int userId = callerIdentity.getUserId();
        if (hasCallingPermission("android.permission.RESET_PASSWORD")) {
            boolean passwordPrivileged = setPasswordPrivileged(str, i, callerIdentity);
            if (passwordPrivileged) {
                DevicePolicyEventLogger.createEvent(205).write();
            }
            return passwordPrivileged;
        }
        if (isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity)) {
            synchronized (getLockObject()) {
                if (getTargetSdk(getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()).info.getPackageName(), userId) < 26) {
                    Slogf.e("DevicePolicyManager", "DPC can no longer call resetPassword()");
                } else {
                    throw new SecurityException("Device admin can no longer call resetPassword()");
                }
            }
            return false;
        }
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(null, 2, false);
            Preconditions.checkCallAuthorization(activeAdminForCallerLocked != null, "Unauthorized caller cannot call resetPassword.");
            if (getTargetSdk(activeAdminForCallerLocked.info.getPackageName(), userId) <= 23) {
                Slogf.e("DevicePolicyManager", "Device admin can no longer call resetPassword()");
            } else {
                throw new SecurityException("Device admin can no longer call resetPassword()");
            }
        }
        return false;
    }

    public final boolean resetPasswordInternal(String str, long j, byte[] bArr, int i, CallerIdentity callerIdentity) {
        return resetPasswordInternal(str, j, bArr, i, callerIdentity, UserHandle.getUserId(callerIdentity.getUid()));
    }

    public final boolean resetPasswordInternal(String str, long j, byte[] bArr, int i, CallerIdentity callerIdentity, int i2) {
        List validatePassword;
        PowerManager.WakeLock powerManagerNewWakeLock;
        int uid = callerIdentity.getUid();
        boolean isNumericOnly = PasswordMetrics.isNumericOnly(str);
        synchronized (getLockObject()) {
            PasswordMetrics passwordMinimumMetricsUnchecked = getPasswordMinimumMetricsUnchecked(i2);
            int aggregatedPasswordComplexityLocked = getAggregatedPasswordComplexityLocked(i2);
            boolean z = false;
            if (!str.isEmpty()) {
                validatePassword = PasswordMetrics.validatePassword(passwordMinimumMetricsUnchecked, aggregatedPasswordComplexityLocked, isNumericOnly, str.getBytes());
            } else {
                if (isMultifactorAuthEnforced(i2)) {
                    Log.w("DevicePolicyManager", "Failed to reset password due to constraint violation: password null does not meet multi-factor auth enforced");
                    return false;
                }
                if (DualDarManager.isOnDeviceOwnerEnabled()) {
                    Log.w("DevicePolicyManager", "Failed to reset password due to constraint violation: password null does not meet DualDAR on Device Owner Enabled");
                    return false;
                }
                validatePassword = PasswordMetrics.validatePasswordMetrics(passwordMinimumMetricsUnchecked, aggregatedPasswordComplexityLocked, new PasswordMetrics(-1));
            }
            if (!validatePassword.isEmpty()) {
                Slogf.w("DevicePolicyManager", "Failed to reset password due to constraint violation: %s", validatePassword.get(0));
                return false;
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i2);
            int i3 = lambda$getUserDataUnchecked$2.mPasswordOwner;
            if (i3 >= 0 && i3 != uid) {
                Slogf.w("DevicePolicyManager", "resetPassword: already set by another uid and not entered by user");
                return false;
            }
            boolean isDefaultDeviceOwner = isDefaultDeviceOwner(callerIdentity);
            boolean z2 = (i & 2) != 0;
            if (isDefaultDeviceOwner && z2) {
                setDoNotAskCredentialsOnBoot();
            }
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            LockscreenCredential createPin = isNumericOnly ? LockscreenCredential.createPin(str) : LockscreenCredential.createPasswordOrNone(str);
            try {
                if (j != 0 && bArr != null) {
                    PowerManager.WakeLock wakeLock = null;
                    try {
                        powerManagerNewWakeLock = this.mInjector.powerManagerNewWakeLock(1, "DevicePolicyManager");
                    } catch (Throwable th) {
                        th = th;
                    }
                    try {
                        if (powerManagerNewWakeLock != null) {
                            powerManagerNewWakeLock.acquire();
                            Log.d("DevicePolicyManager", "wakeLock acquired.");
                        } else {
                            Log.w("DevicePolicyManager", "wakeLock must not be null!");
                        }
                        if (!this.mLockPatternUtils.setLockCredentialWithToken(createPin, j, bArr, i2)) {
                            if (powerManagerNewWakeLock == null) {
                                Log.w("DevicePolicyManager", "wakeLock must not be null!");
                            } else if (powerManagerNewWakeLock.isHeld()) {
                                powerManagerNewWakeLock.release();
                                Log.d("DevicePolicyManager", "wakeLock released.");
                            } else {
                                Log.d("DevicePolicyManager", "wakeLock is not held.");
                            }
                            return false;
                        }
                        if (powerManagerNewWakeLock == null) {
                            Log.w("DevicePolicyManager", "wakeLock must not be null!");
                        } else if (powerManagerNewWakeLock.isHeld()) {
                            powerManagerNewWakeLock.release();
                            Log.d("DevicePolicyManager", "wakeLock released.");
                        } else {
                            Log.d("DevicePolicyManager", "wakeLock is not held.");
                        }
                    } catch (Throwable th2) {
                        th = th2;
                        wakeLock = powerManagerNewWakeLock;
                        if (wakeLock == null) {
                            Log.w("DevicePolicyManager", "wakeLock must not be null!");
                        } else if (wakeLock.isHeld()) {
                            wakeLock.release();
                            Log.d("DevicePolicyManager", "wakeLock released.");
                        } else {
                            Log.d("DevicePolicyManager", "wakeLock is not held.");
                        }
                        throw th;
                    }
                } else if (!this.mLockPatternUtils.setLockCredential(createPin, LockscreenCredential.createNone(), i2)) {
                    return false;
                }
                boolean z3 = (i & 1) != 0;
                if (z3) {
                    this.mLockPatternUtils.requireStrongAuth(2, -1);
                }
                synchronized (getLockObject()) {
                    int i4 = z3 ? uid : -1;
                    if (lambda$getUserDataUnchecked$2.mPasswordOwner != i4) {
                        lambda$getUserDataUnchecked$2.mPasswordOwner = i4;
                        z = true;
                    }
                    if (lambda$getUserDataUnchecked$2.mLastResetPassword != uid) {
                        lambda$getUserDataUnchecked$2.mLastResetPassword = uid;
                        z = true;
                    }
                    if (z) {
                        saveSettingsLocked(i2);
                    }
                }
                Intent intent = new Intent("com.samsung.knox.app.action.DEVICE_POLICY_MANAGER_PASSWORD_CHANGED");
                intent.setFlags(1073741824);
                this.mContext.sendBroadcastAsUser(intent, new UserHandle(i2));
                return true;
            } finally {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        }
    }

    public /* synthetic */ Boolean lambda$isLockScreenSecureUnchecked$36(int i) {
        return Boolean.valueOf(this.mLockPatternUtils.isSecure(i));
    }

    public final boolean isLockScreenSecureUnchecked(final int i) {
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda202
            public final Object getOrThrow() {
                Boolean lambda$isLockScreenSecureUnchecked$36;
                lambda$isLockScreenSecureUnchecked$36 = DevicePolicyManagerService.this.lambda$isLockScreenSecureUnchecked$36(i);
                return lambda$isLockScreenSecureUnchecked$36;
            }
        })).booleanValue();
    }

    public final void setDoNotAskCredentialsOnBoot() {
        synchronized (getLockObject()) {
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(0);
            if (!lambda$getUserDataUnchecked$2.mDoNotAskCredentialsOnBoot) {
                lambda$getUserDataUnchecked$2.mDoNotAskCredentialsOnBoot = true;
                saveSettingsLocked(0);
            }
        }
    }

    public boolean getDoNotAskCredentialsOnBoot() {
        boolean z;
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.QUERY_DO_NOT_ASK_CREDENTIALS_ON_BOOT"));
        synchronized (getLockObject()) {
            z = lambda$getUserDataUnchecked$2(0).mDoNotAskCredentialsOnBoot;
        }
        return z;
    }

    public void setMaximumTimeToLock(ComponentName componentName, String str, long j, boolean z) {
        ActiveAdmin activeAdminForCallerLocked;
        if (this.mHasFeature) {
            if (!isPermissionCheckFlagEnabled()) {
                Objects.requireNonNull(componentName, "ComponentName is null");
            }
            int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            int profileParentId = z ? getProfileParentId(userHandleGetCallingUserId) : userHandleGetCallingUserId;
            synchronized (getLockObject()) {
                if (isPermissionCheckFlagEnabled()) {
                    activeAdminForCallerLocked = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_LOCK", 3, getCallerIdentity(componentName, str).getPackageName(), profileParentId).getActiveAdmin();
                } else {
                    activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 3, z);
                }
                if (activeAdminForCallerLocked.maximumTimeToUnlock != j) {
                    activeAdminForCallerLocked.maximumTimeToUnlock = j;
                    saveSettingsLocked(userHandleGetCallingUserId);
                    updateMaximumTimeToLockLocked(userHandleGetCallingUserId);
                    if (KnoxUtils.isSpfKnoxSupported()) {
                        this.mInjector.postContainerAnalytics(j, userHandleGetCallingUserId);
                    }
                }
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210019, new Object[]{str, Integer.valueOf(userHandleGetCallingUserId), Integer.valueOf(profileParentId), Long.valueOf(j)});
            }
        }
    }

    public final void updateMaximumTimeToLockLocked(final int i) {
        if (isManagedProfile(i)) {
            updateProfileLockTimeoutLocked(i);
        }
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda12
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$updateMaximumTimeToLockLocked$37(i);
            }
        });
    }

    public /* synthetic */ void lambda$updateMaximumTimeToLockLocked$37(int i) {
        int profileParentId = getProfileParentId(i);
        long maximumTimeToLockPolicyFromAdmins = getMaximumTimeToLockPolicyFromAdmins(getActiveAdminsForLockscreenPoliciesLocked(profileParentId));
        DevicePolicyData userDataUnchecked = getUserDataUnchecked(profileParentId);
        if (userDataUnchecked.mLastMaximumTimeToLock == maximumTimeToLockPolicyFromAdmins) {
            return;
        }
        userDataUnchecked.mLastMaximumTimeToLock = maximumTimeToLockPolicyFromAdmins;
        if (maximumTimeToLockPolicyFromAdmins != Long.MAX_VALUE) {
            this.mInjector.settingsGlobalPutInt("stay_on_while_plugged_in", 0);
        }
        getPowerManagerInternal().setMaximumScreenOffTimeoutFromDeviceAdmin(profileParentId, maximumTimeToLockPolicyFromAdmins);
    }

    public final void updateProfileLockTimeoutLocked(final int i) {
        long maximumTimeToLockPolicyFromAdmins = isSeparateProfileChallengeEnabled(i) ? getMaximumTimeToLockPolicyFromAdmins(getActiveAdminsForLockscreenPoliciesLocked(i)) : Long.MAX_VALUE;
        final DevicePolicyData userDataUnchecked = getUserDataUnchecked(i);
        if (userDataUnchecked.mLastMaximumTimeToLock == maximumTimeToLockPolicyFromAdmins) {
            return;
        }
        userDataUnchecked.mLastMaximumTimeToLock = maximumTimeToLockPolicyFromAdmins;
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda204
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$updateProfileLockTimeoutLocked$38(i, userDataUnchecked);
            }
        });
    }

    public /* synthetic */ void lambda$updateProfileLockTimeoutLocked$38(int i, DevicePolicyData devicePolicyData) {
        getPowerManagerInternal().setMaximumScreenOffTimeoutFromDeviceAdmin(i, devicePolicyData.mLastMaximumTimeToLock);
    }

    public long getMaximumTimeToLock(ComponentName componentName, int i, boolean z) {
        if (!this.mHasFeature) {
            return 0L;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i));
        Preconditions.checkCallAuthorization(componentName == null || isCallingFromPackage(componentName.getPackageName(), callerIdentity.getUid()) || canQueryAdminPolicy(callerIdentity));
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i, z);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.maximumTimeToUnlock : 0L;
            }
            long maximumTimeToLockPolicyFromAdmins = getMaximumTimeToLockPolicyFromAdmins(getActiveAdminsForLockscreenPoliciesLocked(getProfileParentUserIfRequested(i, z)));
            if (maximumTimeToLockPolicyFromAdmins != Long.MAX_VALUE) {
                r1 = maximumTimeToLockPolicyFromAdmins;
            }
            return r1;
        }
    }

    public final long getMaximumTimeToLockPolicyFromAdmins(List list) {
        Iterator it = list.iterator();
        long j = Long.MAX_VALUE;
        while (it.hasNext()) {
            long j2 = ((ActiveAdmin) it.next()).maximumTimeToUnlock;
            if (j2 > 0 && j2 < j) {
                j = j2;
            }
        }
        return j;
    }

    public void setRequiredStrongAuthTimeout(ComponentName componentName, String str, long j, boolean z) {
        CallerIdentity callerIdentity;
        ActiveAdmin parentOfAdminIfRequired;
        if (this.mHasFeature && this.mLockPatternUtils.hasSecureLockScreen()) {
            boolean z2 = true;
            Preconditions.checkArgument(j >= 0, "Timeout must not be a negative number.");
            if (isPermissionCheckFlagEnabled()) {
                callerIdentity = getCallerIdentity(componentName, str);
            } else {
                callerIdentity = getCallerIdentity(componentName);
                Objects.requireNonNull(componentName, "ComponentName is null");
                Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
            }
            long minimumStrongAuthTimeoutMs = getMinimumStrongAuthTimeoutMs();
            if (j != 0 && j < minimumStrongAuthTimeoutMs) {
                j = minimumStrongAuthTimeoutMs;
            }
            if (j > 259200000) {
                j = 259200000;
            }
            int userId = callerIdentity.getUserId();
            synchronized (getLockObject()) {
                if (isPermissionCheckFlagEnabled()) {
                    parentOfAdminIfRequired = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_LOCK_CREDENTIALS", callerIdentity.getPackageName(), z ? getProfileParentId(callerIdentity.getUserId()) : callerIdentity.getUserId()).getActiveAdmin();
                } else {
                    parentOfAdminIfRequired = getParentOfAdminIfRequired(getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()), z);
                }
                if (parentOfAdminIfRequired.strongAuthUnlockTimeout != j) {
                    parentOfAdminIfRequired.strongAuthUnlockTimeout = j;
                    saveSettingsLocked(userId);
                } else {
                    z2 = false;
                }
            }
            if (z2) {
                this.mLockSettingsInternal.refreshStrongAuthTimeout(userId);
                if (!isManagedProfile(userId) || isSeparateProfileChallengeEnabled(userId)) {
                    return;
                }
                this.mLockSettingsInternal.refreshStrongAuthTimeout(getProfileParentId(userId));
            }
        }
    }

    public long getRequiredStrongAuthTimeout(ComponentName componentName, int i, boolean z) {
        long j = 259200000;
        if (!this.mHasFeature) {
            return 259200000L;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(componentName), i));
        if (!this.mLockPatternUtils.hasSecureLockScreen()) {
            return 0L;
        }
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i, z);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.strongAuthUnlockTimeout : 0L;
            }
            List activeAdminsForLockscreenPoliciesLocked = getActiveAdminsForLockscreenPoliciesLocked(getProfileParentUserIfRequested(i, z));
            for (int i2 = 0; i2 < activeAdminsForLockscreenPoliciesLocked.size(); i2++) {
                long j2 = ((ActiveAdmin) activeAdminsForLockscreenPoliciesLocked.get(i2)).strongAuthUnlockTimeout;
                if (j2 != 0) {
                    j = Math.min(j2, j);
                }
            }
            return Math.max(j, getMinimumStrongAuthTimeoutMs());
        }
    }

    public final long getMinimumStrongAuthTimeoutMs() {
        if (!this.mInjector.isBuildDebuggable()) {
            return MINIMUM_STRONG_AUTH_TIMEOUT_MS;
        }
        Injector injector = this.mInjector;
        long j = MINIMUM_STRONG_AUTH_TIMEOUT_MS;
        return Math.min(injector.systemPropertiesGetLong("persist.sys.min_str_auth_timeo", j), j);
    }

    /* JADX WARN: Removed duplicated region for block: B:45:0x00a3 A[Catch: RemoteException -> 0x0098, all -> 0x00f4, TryCatch #0 {all -> 0x00f4, blocks: (B:18:0x0057, B:21:0x0063, B:23:0x006e, B:25:0x0076, B:26:0x007c, B:27:0x0083, B:29:0x0084, B:30:0x008b, B:39:0x008f, B:43:0x009b, B:45:0x00a3, B:48:0x00b1, B:49:0x00c4, B:53:0x00ce, B:54:0x00d4, B:57:0x00a8, B:58:0x00bb, B:61:0x004a), top: B:60:0x004a, outer: #1 }] */
    /* JADX WARN: Removed duplicated region for block: B:53:0x00ce A[Catch: RemoteException -> 0x0098, all -> 0x00f4, TryCatch #0 {all -> 0x00f4, blocks: (B:18:0x0057, B:21:0x0063, B:23:0x006e, B:25:0x0076, B:26:0x007c, B:27:0x0083, B:29:0x0084, B:30:0x008b, B:39:0x008f, B:43:0x009b, B:45:0x00a3, B:48:0x00b1, B:49:0x00c4, B:53:0x00ce, B:54:0x00d4, B:57:0x00a8, B:58:0x00bb, B:61:0x004a), top: B:60:0x004a, outer: #1 }] */
    /* JADX WARN: Removed duplicated region for block: B:55:0x00d3  */
    /* JADX WARN: Removed duplicated region for block: B:58:0x00bb A[Catch: RemoteException -> 0x0098, all -> 0x00f4, TryCatch #0 {all -> 0x00f4, blocks: (B:18:0x0057, B:21:0x0063, B:23:0x006e, B:25:0x0076, B:26:0x007c, B:27:0x0083, B:29:0x0084, B:30:0x008b, B:39:0x008f, B:43:0x009b, B:45:0x00a3, B:48:0x00b1, B:49:0x00c4, B:53:0x00ce, B:54:0x00d4, B:57:0x00a8, B:58:0x00bb, B:61:0x004a), top: B:60:0x004a, outer: #1 }] */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public void lockNow(int r13, java.lang.String r14, boolean r15) {
        /*
            Method dump skipped, instructions count: 279
            To view this dump change 'Code comments level' option to 'DEBUG'
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.lockNow(int, java.lang.String, boolean):void");
    }

    public void enforceCanManageCaCerts(ComponentName componentName, String str) {
        Preconditions.checkCallAuthorization(canManageCaCerts(getCallerIdentity(componentName, str)));
    }

    public final boolean canManageCaCerts(CallerIdentity callerIdentity) {
        return (callerIdentity.hasAdminComponent() && (isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-cert-install")) || hasCallingOrSelfPermission("android.permission.MANAGE_CA_CERTIFICATES");
    }

    public boolean approveCaCert(String str, int i, boolean z) {
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()));
        synchronized (getLockObject()) {
            ArraySet arraySet = lambda$getUserDataUnchecked$2(i).mAcceptedCaCertificates;
            if (!(z ? arraySet.add(str) : arraySet.remove(str))) {
                return false;
            }
            saveSettingsLocked(i);
            this.mCertificateMonitor.onCertificateApprovalsChanged(i);
            return true;
        }
    }

    public boolean isCaCertApproved(String str, int i) {
        boolean contains;
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()));
        synchronized (getLockObject()) {
            contains = lambda$getUserDataUnchecked$2(i).mAcceptedCaCertificates.contains(str);
        }
        return contains;
    }

    public final Set removeCaApprovalsIfNeeded(int i) {
        ArraySet arraySet = new ArraySet();
        for (UserInfo userInfo : this.mUserManager.getProfiles(i)) {
            boolean isSecure = this.mLockPatternUtils.isSecure(userInfo.id);
            if (userInfo.isManagedProfile()) {
                isSecure |= this.mLockPatternUtils.isSecure(getProfileParentId(userInfo.id));
            }
            if (!isSecure) {
                synchronized (getLockObject()) {
                    lambda$getUserDataUnchecked$2(userInfo.id).mAcceptedCaCertificates.clear();
                    arraySet.add(Integer.valueOf(userInfo.id));
                }
                this.mCertificateMonitor.onCertificateApprovalsChanged(i);
            }
        }
        return arraySet;
    }

    public boolean installCaCert(final ComponentName componentName, String str, final byte[] bArr) {
        if (!this.mHasFeature) {
            return false;
        }
        final CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        Preconditions.checkCallAuthorization(canManageCaCerts(callerIdentity));
        checkCanExecuteOrThrowUnsafe(24);
        String str2 = (String) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda101
            public final Object getOrThrow() {
                String lambda$installCaCert$39;
                lambda$installCaCert$39 = DevicePolicyManagerService.this.lambda$installCaCert$39(callerIdentity, bArr, componentName);
                return lambda$installCaCert$39;
            }
        });
        if (str2 == null) {
            Slogf.w("DevicePolicyManager", "Problem installing cert");
            return false;
        }
        synchronized (getLockObject()) {
            lambda$getUserDataUnchecked$2(callerIdentity.getUserId()).mOwnerInstalledCaCerts.add(str2);
            saveSettingsLocked(callerIdentity.getUserId());
        }
        KnoxAnalyticsData knoxAnalyticsData = new KnoxAnalyticsData("KNOX_AKS", 1, "API:DPM-installCaCert");
        knoxAnalyticsData.setProperty("pN", str);
        KnoxAnalytics.log(knoxAnalyticsData);
        return true;
    }

    public /* synthetic */ String lambda$installCaCert$39(CallerIdentity callerIdentity, byte[] bArr, ComponentName componentName) {
        String installCaCert = this.mCertificateMonitor.installCaCert(callerIdentity.getUserHandle(), bArr);
        DevicePolicyEventLogger.createEvent(21).setAdmin(callerIdentity.getPackageName()).setBoolean(componentName == null).write();
        return installCaCert;
    }

    public void uninstallCaCerts(final ComponentName componentName, String str, final String[] strArr) {
        if (this.mHasFeature) {
            final CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
            Preconditions.checkCallAuthorization(canManageCaCerts(callerIdentity));
            checkCanExecuteOrThrowUnsafe(40);
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda19
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$uninstallCaCerts$40(callerIdentity, strArr, componentName);
                }
            });
            synchronized (getLockObject()) {
                if (lambda$getUserDataUnchecked$2(callerIdentity.getUserId()).mOwnerInstalledCaCerts.removeAll(Arrays.asList(strArr))) {
                    saveSettingsLocked(callerIdentity.getUserId());
                }
            }
            KnoxAnalyticsData knoxAnalyticsData = new KnoxAnalyticsData("KNOX_AKS", 1, "API:DPM-uninstallCaCerts");
            knoxAnalyticsData.setProperty("pN", str);
            KnoxAnalytics.log(knoxAnalyticsData);
        }
    }

    public /* synthetic */ void lambda$uninstallCaCerts$40(CallerIdentity callerIdentity, String[] strArr, ComponentName componentName) {
        this.mCertificateMonitor.uninstallCaCerts(callerIdentity.getUserHandle(), strArr);
        DevicePolicyEventLogger.createEvent(24).setAdmin(callerIdentity.getPackageName()).setBoolean(componentName == null).write();
    }

    public boolean installKeyPair(ComponentName componentName, String str, byte[] bArr, byte[] bArr2, byte[] bArr3, String str2, boolean z, boolean z2) {
        long j;
        KeyChain.KeyChainConnection bindAsUser;
        IKeyChainService service;
        IKeyChainService iKeyChainService;
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        boolean isCallerDelegate = isCallerDelegate(callerIdentity, "delegation-cert-install");
        boolean isCredentialManagementApp = isCredentialManagementApp(callerIdentity);
        if (isPermissionCheckFlagEnabled()) {
            Preconditions.checkCallAuthorization(hasPermission("android.permission.MANAGE_DEVICE_POLICY_CERTIFICATES", callerIdentity.getPackageName(), callerIdentity.getUserId()) || isCredentialManagementApp);
        } else {
            Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && (isCallerDelegate || isCredentialManagementApp)));
        }
        if (isCredentialManagementApp) {
            Preconditions.checkCallAuthorization(!z2, "The credential management app is not allowed to install a user selectable key pair");
            Preconditions.checkCallAuthorization(isAliasInCredentialManagementAppPolicy(callerIdentity, str2), "The alias provided must be contained in the aliases specified in the credential management app's authentication policy");
        }
        checkCanExecuteOrThrowUnsafe(25);
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            try {
                try {
                    try {
                        bindAsUser = KeyChain.bindAsUser(this.mContext, callerIdentity.getUserHandle());
                        try {
                            service = bindAsUser.getService();
                            j = binderClearCallingIdentity;
                        } catch (RemoteException e) {
                            e = e;
                            j = binderClearCallingIdentity;
                        } catch (Throwable th) {
                            th = th;
                            bindAsUser.close();
                            throw th;
                        }
                    } catch (InterruptedException e2) {
                        e = e2;
                        j = binderClearCallingIdentity;
                        Slogf.w("DevicePolicyManager", "Interrupted while installing certificate", e);
                        Thread.currentThread().interrupt();
                        this.mInjector.binderRestoreCallingIdentity(j);
                        logInstallKeyPairFailure(callerIdentity, isCredentialManagementApp);
                        return false;
                    } catch (Throwable th2) {
                        th = th2;
                        this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                        throw th;
                    }
                } catch (Throwable th3) {
                    th = th3;
                }
            } catch (InterruptedException e3) {
                e = e3;
                Slogf.w("DevicePolicyManager", "Interrupted while installing certificate", e);
                Thread.currentThread().interrupt();
                this.mInjector.binderRestoreCallingIdentity(j);
                logInstallKeyPairFailure(callerIdentity, isCredentialManagementApp);
                return false;
            }
            try {
                if (!service.installKeyPair(bArr, bArr2, bArr3, str2, -1)) {
                    logInstallKeyPairFailure(callerIdentity, isCredentialManagementApp);
                    bindAsUser.close();
                    this.mInjector.binderRestoreCallingIdentity(j);
                    return false;
                }
                if (z) {
                    iKeyChainService = service;
                    iKeyChainService.setGrant(callerIdentity.getUid(), str2, true);
                } else {
                    iKeyChainService = service;
                }
                iKeyChainService.setUserSelectable(str2, z2);
                DevicePolicyEventLogger devicePolicyEventLogger = DevicePolicyEventLogger.createEvent(20).setAdmin(callerIdentity.getPackageName()).setBoolean(isCallerDelegate);
                String[] strArr = new String[1];
                strArr[0] = isCredentialManagementApp ? "credentialManagementApp" : "notCredentialManagementApp";
                devicePolicyEventLogger.setStrings(strArr).write();
                KnoxAnalyticsData knoxAnalyticsData = new KnoxAnalyticsData("KNOX_AKS", 1, "API:DPM-installKeyPair");
                knoxAnalyticsData.setProperty("pN", str);
                KnoxAnalytics.log(knoxAnalyticsData);
                bindAsUser.close();
                this.mInjector.binderRestoreCallingIdentity(j);
                return true;
            } catch (RemoteException e4) {
                e = e4;
                Slogf.e("DevicePolicyManager", "Installing certificate", e);
                bindAsUser.close();
                this.mInjector.binderRestoreCallingIdentity(j);
                logInstallKeyPairFailure(callerIdentity, isCredentialManagementApp);
                return false;
            }
        } catch (Throwable th4) {
            th = th4;
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            throw th;
        }
    }

    public final void logInstallKeyPairFailure(CallerIdentity callerIdentity, boolean z) {
        if (z) {
            DevicePolicyEventLogger.createEvent(184).setStrings(new String[]{callerIdentity.getPackageName()}).write();
        }
    }

    public boolean removeKeyPair(ComponentName componentName, String str, String str2) {
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        boolean isCallerDelegate = isCallerDelegate(callerIdentity, "delegation-cert-install");
        boolean isCredentialManagementApp = isCredentialManagementApp(callerIdentity);
        if (isPermissionCheckFlagEnabled()) {
            Preconditions.checkCallAuthorization(hasPermission("android.permission.MANAGE_DEVICE_POLICY_CERTIFICATES", callerIdentity.getPackageName(), callerIdentity.getUserId()) || isCredentialManagementApp);
        } else {
            Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && (isCallerDelegate || isCredentialManagementApp)));
        }
        if (isCredentialManagementApp) {
            Preconditions.checkCallAuthorization(isAliasInCredentialManagementAppPolicy(callerIdentity, str2), "The alias provided must be contained in the aliases specified in the credential management app's authentication policy");
        }
        checkCanExecuteOrThrowUnsafe(28);
        long clearCallingIdentity = Binder.clearCallingIdentity();
        try {
            try {
                KeyChain.KeyChainConnection bindAsUser = KeyChain.bindAsUser(this.mContext, callerIdentity.getUserHandle());
                try {
                    try {
                        IKeyChainService service = bindAsUser.getService();
                        DevicePolicyEventLogger devicePolicyEventLogger = DevicePolicyEventLogger.createEvent(23).setAdmin(callerIdentity.getPackageName()).setBoolean(isCallerDelegate);
                        String[] strArr = new String[1];
                        strArr[0] = isCredentialManagementApp ? "credentialManagementApp" : "notCredentialManagementApp";
                        devicePolicyEventLogger.setStrings(strArr).write();
                        return service.removeKeyPair(str2);
                    } catch (RemoteException e) {
                        Slogf.e("DevicePolicyManager", "Removing keypair", e);
                        bindAsUser.close();
                        return false;
                    }
                } finally {
                    bindAsUser.close();
                }
            } catch (InterruptedException e2) {
                Slogf.w("DevicePolicyManager", "Interrupted while removing keypair", e2);
                Thread.currentThread().interrupt();
            }
        } finally {
            Binder.restoreCallingIdentity(clearCallingIdentity);
        }
    }

    public boolean hasKeyPair(String str, final String str2) {
        final CallerIdentity callerIdentity = getCallerIdentity(str);
        boolean isCredentialManagementApp = isCredentialManagementApp(callerIdentity);
        Preconditions.checkCallAuthorization(canInstallCertificates(callerIdentity) || isCredentialManagementApp);
        if (isCredentialManagementApp) {
            Preconditions.checkCallAuthorization(isAliasInCredentialManagementAppPolicy(callerIdentity, str2), "The alias provided must be contained in the aliases specified in the credential management app's authentication policy");
        }
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda133
            public final Object getOrThrow() {
                Boolean lambda$hasKeyPair$41;
                lambda$hasKeyPair$41 = DevicePolicyManagerService.this.lambda$hasKeyPair$41(callerIdentity, str2);
                return lambda$hasKeyPair$41;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$hasKeyPair$41(CallerIdentity callerIdentity, String str) {
        try {
            KeyChain.KeyChainConnection bindAsUser = KeyChain.bindAsUser(this.mContext, callerIdentity.getUserHandle());
            try {
                Boolean valueOf = Boolean.valueOf(bindAsUser.getService().containsKeyPair(str));
                bindAsUser.close();
                return valueOf;
            } finally {
            }
        } catch (RemoteException e) {
            Slogf.e("DevicePolicyManager", "Querying keypair", e);
            return Boolean.FALSE;
        } catch (InterruptedException e2) {
            Slogf.w("DevicePolicyManager", "Interrupted while querying keypair", e2);
            Thread.currentThread().interrupt();
            return Boolean.FALSE;
        }
    }

    public final boolean canInstallCertificates(CallerIdentity callerIdentity) {
        if (isPermissionCheckFlagEnabled()) {
            return hasPermission("android.permission.MANAGE_DEVICE_POLICY_CERTIFICATES", callerIdentity.getPackageName(), callerIdentity.getUserId());
        }
        return isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || isCallerDelegate(callerIdentity, "delegation-cert-install");
    }

    public final boolean canChooseCertificates(CallerIdentity callerIdentity) {
        return isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || isCallerDelegate(callerIdentity, "delegation-cert-selection");
    }

    public boolean setKeyGrantToWifiAuth(String str, String str2, boolean z) {
        Preconditions.checkStringNotEmpty(str2, "Alias to grant cannot be empty");
        CallerIdentity callerIdentity = getCallerIdentity(str);
        Preconditions.checkCallAuthorization(canChooseCertificates(callerIdentity));
        try {
            return setKeyChainGrantInternal(str2, z, 1010, callerIdentity.getUserHandle());
        } catch (IllegalArgumentException e) {
            if (this.mInjector.isChangeEnabled(175101461L, callerIdentity.getPackageName(), callerIdentity.getUserId())) {
                throw e;
            }
            return false;
        }
    }

    public boolean isKeyPairGrantedToWifiAuth(String str, final String str2) {
        Preconditions.checkStringNotEmpty(str2, "Alias to check cannot be empty");
        final CallerIdentity callerIdentity = getCallerIdentity(str);
        Preconditions.checkCallAuthorization(canChooseCertificates(callerIdentity));
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda64
            public final Object getOrThrow() {
                Boolean lambda$isKeyPairGrantedToWifiAuth$42;
                lambda$isKeyPairGrantedToWifiAuth$42 = DevicePolicyManagerService.this.lambda$isKeyPairGrantedToWifiAuth$42(callerIdentity, str2);
                return lambda$isKeyPairGrantedToWifiAuth$42;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$isKeyPairGrantedToWifiAuth$42(CallerIdentity callerIdentity, String str) {
        try {
            KeyChain.KeyChainConnection bindAsUser = KeyChain.bindAsUser(this.mContext, callerIdentity.getUserHandle());
            try {
                new ArrayList();
                for (int i : bindAsUser.getService().getGrants(str)) {
                    if (i == 1010) {
                        Boolean bool = Boolean.TRUE;
                        bindAsUser.close();
                        return bool;
                    }
                }
                Boolean bool2 = Boolean.FALSE;
                bindAsUser.close();
                return bool2;
            } finally {
            }
        } catch (RemoteException e) {
            Slogf.e("DevicePolicyManager", "Querying grant to wifi auth.", e);
            return Boolean.FALSE;
        }
    }

    public boolean setKeyGrantForApp(ComponentName componentName, String str, String str2, String str3, boolean z) {
        Preconditions.checkStringNotEmpty(str2, "Alias to grant cannot be empty");
        Preconditions.checkStringNotEmpty(str3, "Package to grant to cannot be empty");
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        boolean z2 = true;
        Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-cert-selection")));
        try {
            ApplicationInfo applicationInfo = this.mInjector.getIPackageManager().getApplicationInfo(str3, 0L, callerIdentity.getUserId());
            if (applicationInfo == null) {
                z2 = false;
            }
            Preconditions.checkArgument(z2, "Provided package %s is not installed", new Object[]{str3});
            try {
                return setKeyChainGrantInternal(str2, z, applicationInfo.uid, callerIdentity.getUserHandle());
            } catch (IllegalArgumentException e) {
                if (this.mInjector.isChangeEnabled(175101461L, str, callerIdentity.getUserId())) {
                    throw e;
                }
                return false;
            }
        } catch (RemoteException e2) {
            throw new IllegalStateException("Failure getting grantee uid", e2);
        }
    }

    public final boolean setKeyChainGrantInternal(String str, boolean z, int i, UserHandle userHandle) {
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            try {
                KeyChain.KeyChainConnection bindAsUser = KeyChain.bindAsUser(this.mContext, userHandle);
                try {
                    boolean grant = bindAsUser.getService().setGrant(i, str, z);
                    bindAsUser.close();
                    return grant;
                } catch (Throwable th) {
                    if (bindAsUser != null) {
                        try {
                            bindAsUser.close();
                        } catch (Throwable th2) {
                            th.addSuppressed(th2);
                        }
                    }
                    throw th;
                }
            } catch (InterruptedException e) {
                Slogf.w("DevicePolicyManager", "Interrupted while setting key grant", e);
                Thread.currentThread().interrupt();
                return false;
            } finally {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        } catch (RemoteException e2) {
            Slogf.e("DevicePolicyManager", "Setting grant for package.", e2);
            return false;
        }
    }

    public ParcelableGranteeMap getKeyPairGrants(String str, final String str2) {
        final CallerIdentity callerIdentity = getCallerIdentity(str);
        Preconditions.checkCallAuthorization(canChooseCertificates(callerIdentity));
        final ArrayMap arrayMap = new ArrayMap();
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda104
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$getKeyPairGrants$43(callerIdentity, str2, arrayMap);
            }
        });
        return new ParcelableGranteeMap(arrayMap);
    }

    public /* synthetic */ void lambda$getKeyPairGrants$43(CallerIdentity callerIdentity, String str, ArrayMap arrayMap) {
        try {
            KeyChain.KeyChainConnection bindAsUser = KeyChain.bindAsUser(this.mContext, callerIdentity.getUserHandle());
            try {
                int[] grants = bindAsUser.getService().getGrants(str);
                PackageManager packageManager = this.mInjector.getPackageManager(callerIdentity.getUserId());
                for (int i : grants) {
                    String[] packagesForUid = packageManager.getPackagesForUid(i);
                    if (packagesForUid == null) {
                        Slogf.wtf("DevicePolicyManager", "No packages found for uid " + i);
                    } else {
                        arrayMap.put(Integer.valueOf(i), new ArraySet(packagesForUid));
                    }
                }
                bindAsUser.close();
            } catch (Throwable th) {
                if (bindAsUser != null) {
                    try {
                        bindAsUser.close();
                    } catch (Throwable th2) {
                        th.addSuppressed(th2);
                    }
                }
                throw th;
            }
        } catch (RemoteException e) {
            Slogf.e("DevicePolicyManager", "Querying keypair grants", e);
        } catch (InterruptedException e2) {
            Slogf.w("DevicePolicyManager", "Interrupted while querying keypair grants", e2);
            Thread.currentThread().interrupt();
        }
    }

    public static int[] translateIdAttestationFlags(int i) {
        HashMap hashMap = new HashMap();
        hashMap.put(2, 1);
        hashMap.put(4, 2);
        hashMap.put(8, 3);
        hashMap.put(16, 4);
        int bitCount = Integer.bitCount(i);
        if (bitCount == 0) {
            return null;
        }
        if ((i & 1) != 0) {
            bitCount--;
            i &= -2;
        }
        int[] iArr = new int[bitCount];
        int i2 = 0;
        for (Integer num : hashMap.keySet()) {
            if ((num.intValue() & i) != 0) {
                iArr[i2] = ((Integer) hashMap.get(num)).intValue();
                i2++;
            }
        }
        return iArr;
    }

    public boolean generateKeyPair(ComponentName componentName, String str, String str2, ParcelableKeyGenParameterSpec parcelableKeyGenParameterSpec, int i, KeymasterCertificateChain keymasterCertificateChain) {
        int[] translateIdAttestationFlags = translateIdAttestationFlags(i);
        boolean z = translateIdAttestationFlags != null;
        KeyGenParameterSpec spec = parcelableKeyGenParameterSpec.getSpec();
        String keystoreAlias = spec.getKeystoreAlias();
        Preconditions.checkStringNotEmpty(keystoreAlias, "Empty alias provided");
        Preconditions.checkArgument((z && spec.getAttestationChallenge() == null) ? false : true, "Requested Device ID attestation but challenge is empty");
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        boolean isCallerDelegate = isCallerDelegate(callerIdentity, "delegation-cert-install");
        boolean isCredentialManagementApp = isCredentialManagementApp(callerIdentity);
        if (!z || translateIdAttestationFlags.length <= 0) {
            if (isPermissionCheckFlagEnabled()) {
                Preconditions.checkCallAuthorization(hasPermission("android.permission.MANAGE_DEVICE_POLICY_CERTIFICATES", callerIdentity.getPackageName(), callerIdentity.getUserId()) || isCredentialManagementApp);
            } else {
                Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && (isCallerDelegate || isCredentialManagementApp)));
            }
            if (isCredentialManagementApp) {
                Preconditions.checkCallAuthorization(isAliasInCredentialManagementAppPolicy(callerIdentity, keystoreAlias), "The alias provided must be contained in the aliases specified in the credential management app's authentication policy");
            }
        } else {
            Preconditions.checkCallAuthorization(hasDeviceIdAccessUnchecked(callerIdentity.getPackageName(), callerIdentity.getUid()));
            enforceIndividualAttestationSupportedIfRequested(translateIdAttestationFlags);
        }
        if (TextUtils.isEmpty(keystoreAlias)) {
            throw new IllegalArgumentException("Empty alias provided.");
        }
        if (spec.getUid() != -1) {
            Slogf.e("DevicePolicyManager", "Only the caller can be granted access to the generated keypair.");
            logGenerateKeyPairFailure(callerIdentity, isCredentialManagementApp);
            return false;
        }
        if (z) {
            if (spec.getAttestationChallenge() == null) {
                throw new IllegalArgumentException("Requested Device ID attestation but challenge is empty.");
            }
            KeyGenParameterSpec.Builder builder = new KeyGenParameterSpec.Builder(spec);
            builder.setAttestationIds(translateIdAttestationFlags);
            builder.setDevicePropertiesAttestationIncluded(true);
            spec = builder.build();
        }
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            try {
                KeyChain.KeyChainConnection bindAsUser = KeyChain.bindAsUser(this.mContext, callerIdentity.getUserHandle());
                try {
                    IKeyChainService service = bindAsUser.getService();
                    int generateKeyPair = service.generateKeyPair(str2, new ParcelableKeyGenParameterSpec(spec));
                    if (generateKeyPair != 0) {
                        Slogf.e("DevicePolicyManager", "KeyChain failed to generate a keypair, error %d.", Integer.valueOf(generateKeyPair));
                        logGenerateKeyPairFailure(callerIdentity, isCredentialManagementApp);
                        if (generateKeyPair == 3) {
                            throw new UnsupportedOperationException("Device does not support Device ID attestation.");
                        }
                        if (generateKeyPair == 6) {
                            throw new ServiceSpecificException(1, String.format("KeyChain error: %d", Integer.valueOf(generateKeyPair)));
                        }
                        bindAsUser.close();
                        return false;
                    }
                    service.setGrant(callerIdentity.getUid(), keystoreAlias, true);
                    try {
                        ArrayList arrayList = new ArrayList();
                        CertificateFactory certificateFactory = CertificateFactory.getInstance("X.509");
                        byte[] caCertificates = service.getCaCertificates(keystoreAlias);
                        arrayList.add(service.getCertificate(keystoreAlias));
                        if (caCertificates != null) {
                            Iterator<? extends Certificate> it = certificateFactory.generateCertificates(new ByteArrayInputStream(caCertificates)).iterator();
                            while (it.hasNext()) {
                                arrayList.add(((X509Certificate) it.next()).getEncoded());
                            }
                        }
                        keymasterCertificateChain.shallowCopyFrom(new KeymasterCertificateChain(arrayList));
                        DevicePolicyEventLogger devicePolicyEventLogger = DevicePolicyEventLogger.createEvent(59).setAdmin(callerIdentity.getPackageName()).setBoolean(isCallerDelegate).setInt(i);
                        String[] strArr = new String[2];
                        strArr[0] = str2;
                        strArr[1] = isCredentialManagementApp ? "credentialManagementApp" : "notCredentialManagementApp";
                        devicePolicyEventLogger.setStrings(strArr).write();
                        bindAsUser.close();
                        return true;
                    } catch (CertificateException e) {
                        logGenerateKeyPairFailure(callerIdentity, isCredentialManagementApp);
                        Slogf.e("DevicePolicyManager", "While retrieving certificate chain.", e);
                        bindAsUser.close();
                        return false;
                    }
                } finally {
                }
            } catch (RemoteException e2) {
                Slogf.e("DevicePolicyManager", "KeyChain error while generating a keypair", e2);
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                logGenerateKeyPairFailure(callerIdentity, isCredentialManagementApp);
                return false;
            } catch (InterruptedException e3) {
                Slogf.w("DevicePolicyManager", "Interrupted while generating keypair", e3);
                Thread.currentThread().interrupt();
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                logGenerateKeyPairFailure(callerIdentity, isCredentialManagementApp);
                return false;
            }
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public final void logGenerateKeyPairFailure(CallerIdentity callerIdentity, boolean z) {
        if (z) {
            DevicePolicyEventLogger.createEvent(185).setStrings(new String[]{callerIdentity.getPackageName()}).write();
        }
    }

    public final void enforceIndividualAttestationSupportedIfRequested(int[] iArr) {
        for (int i : iArr) {
            if (i == 4 && !this.mInjector.getPackageManager().hasSystemFeature("android.hardware.device_unique_attestation")) {
                throw new UnsupportedOperationException("Device Individual attestation is not supported on this device.");
            }
        }
    }

    public boolean setKeyPairCertificate(ComponentName componentName, String str, String str2, byte[] bArr, byte[] bArr2, boolean z) {
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        boolean isCallerDelegate = isCallerDelegate(callerIdentity, "delegation-cert-install");
        boolean isCredentialManagementApp = isCredentialManagementApp(callerIdentity);
        if (isPermissionCheckFlagEnabled()) {
            Preconditions.checkCallAuthorization(hasPermission("android.permission.MANAGE_DEVICE_POLICY_CERTIFICATES", callerIdentity.getPackageName(), callerIdentity.getUserId()) || isCredentialManagementApp);
        } else {
            Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && (isCallerDelegate || isCredentialManagementApp)));
        }
        if (isCredentialManagementApp) {
            Preconditions.checkCallAuthorization(isAliasInCredentialManagementAppPolicy(callerIdentity, str2), "The alias provided must be contained in the aliases specified in the credential management app's authentication policy");
        }
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            try {
                KeyChain.KeyChainConnection bindAsUser = KeyChain.bindAsUser(this.mContext, callerIdentity.getUserHandle());
                try {
                    IKeyChainService service = bindAsUser.getService();
                    if (!service.setKeyPairCertificate(str2, bArr, bArr2)) {
                        bindAsUser.close();
                        return false;
                    }
                    service.setUserSelectable(str2, z);
                    DevicePolicyEventLogger devicePolicyEventLogger = DevicePolicyEventLogger.createEvent(60).setAdmin(callerIdentity.getPackageName()).setBoolean(isCallerDelegate);
                    String[] strArr = new String[1];
                    strArr[0] = isCredentialManagementApp ? "credentialManagementApp" : "notCredentialManagementApp";
                    devicePolicyEventLogger.setStrings(strArr).write();
                    bindAsUser.close();
                    return true;
                } catch (Throwable th) {
                    if (bindAsUser != null) {
                        try {
                            bindAsUser.close();
                        } catch (Throwable th2) {
                            th.addSuppressed(th2);
                        }
                    }
                    throw th;
                }
            } catch (RemoteException e) {
                Slogf.e("DevicePolicyManager", "Failed setting keypair certificate", e);
                return false;
            } catch (InterruptedException e2) {
                Slogf.w("DevicePolicyManager", "Interrupted while setting keypair certificate", e2);
                Thread.currentThread().interrupt();
                return false;
            }
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public void choosePrivateKeyAlias(int i, Uri uri, String str, final IBinder iBinder) {
        boolean z;
        final CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isSystemUid(callerIdentity), String.format("Only the system can %s", "choose private key alias"));
        ComponentName lambda$isProfileOwner$71 = lambda$isProfileOwner$71(callerIdentity.getUserId());
        if (lambda$isProfileOwner$71 == null && callerIdentity.getUserHandle().isSystem()) {
            synchronized (getLockObject()) {
                ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
                if (deviceOwnerAdminLocked != null) {
                    lambda$isProfileOwner$71 = deviceOwnerAdminLocked.info.getComponent();
                }
            }
        }
        if (lambda$isProfileOwner$71 == null) {
            sendPrivateKeyAliasResponse(null, iBinder);
            return;
        }
        final Intent intent = new Intent("android.app.action.CHOOSE_PRIVATE_KEY_ALIAS");
        intent.putExtra("android.app.extra.CHOOSE_PRIVATE_KEY_SENDER_UID", i);
        intent.putExtra("android.app.extra.CHOOSE_PRIVATE_KEY_URI", uri);
        intent.putExtra("android.app.extra.CHOOSE_PRIVATE_KEY_ALIAS", str);
        intent.putExtra("android.app.extra.CHOOSE_PRIVATE_KEY_RESPONSE", iBinder);
        intent.addFlags(268435456);
        ComponentName resolveDelegateReceiver = resolveDelegateReceiver("delegation-cert-selection", "android.app.action.CHOOSE_PRIVATE_KEY_ALIAS", callerIdentity.getUserId());
        if (resolveDelegateReceiver != null) {
            intent.setComponent(resolveDelegateReceiver);
            z = true;
        } else {
            intent.setComponent(lambda$isProfileOwner$71);
            z = false;
        }
        final boolean z2 = z;
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda93
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$choosePrivateKeyAlias$44(intent, callerIdentity, iBinder, z2);
            }
        });
    }

    /* renamed from: com.android.server.devicepolicy.DevicePolicyManagerService$5 */
    /* loaded from: classes2.dex */
    public class AnonymousClass5 extends BroadcastReceiver {
        public final /* synthetic */ IBinder val$response;

        public AnonymousClass5(IBinder iBinder) {
            r2 = iBinder;
        }

        @Override // android.content.BroadcastReceiver
        public void onReceive(Context context, Intent intent) {
            DevicePolicyManagerService.this.sendPrivateKeyAliasResponse(getResultData(), r2);
        }
    }

    public /* synthetic */ void lambda$choosePrivateKeyAlias$44(Intent intent, CallerIdentity callerIdentity, IBinder iBinder, boolean z) {
        this.mContext.sendOrderedBroadcastAsUser(intent, callerIdentity.getUserHandle(), null, new BroadcastReceiver() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService.5
            public final /* synthetic */ IBinder val$response;

            public AnonymousClass5(IBinder iBinder2) {
                r2 = iBinder2;
            }

            @Override // android.content.BroadcastReceiver
            public void onReceive(Context context, Intent intent2) {
                DevicePolicyManagerService.this.sendPrivateKeyAliasResponse(getResultData(), r2);
            }
        }, null, -1, null, null);
        DevicePolicyEventLogger.createEvent(22).setAdmin(intent.getComponent()).setBoolean(z).write();
    }

    public final void sendPrivateKeyAliasResponse(String str, IBinder iBinder) {
        try {
            IKeyChainAliasCallback.Stub.asInterface(iBinder).alias(str);
        } catch (Exception e) {
            Slogf.e("DevicePolicyManager", "error while responding to callback", e);
        }
    }

    public static boolean shouldCheckIfDelegatePackageIsInstalled(String str, int i, List list) {
        if (i >= 24) {
            return true;
        }
        return ((list.size() == 1 && ((String) list.get(0)).equals("delegation-cert-install")) || list.isEmpty()) ? false : true;
    }

    public void setDelegatedScopes(ComponentName componentName, String str, List list) {
        ArrayList arrayList;
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkStringNotEmpty(str, "Delegate package is null or empty");
        Preconditions.checkCollectionElementsNotNull(list, "Scopes");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        ArrayList arrayList2 = new ArrayList(new ArraySet(list));
        if (arrayList2.retainAll(Arrays.asList(DELEGATIONS))) {
            throw new IllegalArgumentException("Unexpected delegation scopes");
        }
        int userId = callerIdentity.getUserId();
        if (!Collections.disjoint(arrayList2, DEVICE_OWNER_OR_MANAGED_PROFILE_OWNER_DELEGATIONS)) {
            if (isDefaultDeviceOwner(callerIdentity) || (isProfileOwner(callerIdentity) && isManagedProfile(callerIdentity.getUserId()))) {
                r3 = true;
            }
            Preconditions.checkCallAuthorization(r3);
        } else if (!Collections.disjoint(arrayList2, DEVICE_OWNER_OR_ORGANIZATION_OWNED_MANAGED_PROFILE_OWNER_DELEGATIONS)) {
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        } else {
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        }
        synchronized (getLockObject()) {
            if (shouldCheckIfDelegatePackageIsInstalled(str, getTargetSdk(componentName.getPackageName(), userId), arrayList2) && !isPackageInstalledForUser(str, userId)) {
                throw new IllegalArgumentException("Package " + str + " is not installed on the current user");
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(userId);
            if (!arrayList2.isEmpty()) {
                lambda$getUserDataUnchecked$2.mDelegationMap.put(str, new ArrayList(arrayList2));
                arrayList = new ArrayList(arrayList2);
                arrayList.retainAll(EXCLUSIVE_DELEGATIONS);
            } else {
                lambda$getUserDataUnchecked$2.mDelegationMap.remove(str);
                arrayList = null;
            }
            sendDelegationChangedBroadcast(str, arrayList2, userId);
            if (arrayList != null && !arrayList.isEmpty()) {
                for (int size = lambda$getUserDataUnchecked$2.mDelegationMap.size() - 1; size >= 0; size--) {
                    String str2 = (String) lambda$getUserDataUnchecked$2.mDelegationMap.keyAt(size);
                    List list2 = (List) lambda$getUserDataUnchecked$2.mDelegationMap.valueAt(size);
                    if (!str2.equals(str) && list2.removeAll(arrayList)) {
                        if (list2.isEmpty()) {
                            lambda$getUserDataUnchecked$2.mDelegationMap.removeAt(size);
                        }
                        sendDelegationChangedBroadcast(str2, new ArrayList(list2), userId);
                    }
                }
            }
            saveSettingsLocked(userId);
        }
    }

    public final void sendDelegationChangedBroadcast(String str, ArrayList arrayList, int i) {
        Intent intent = new Intent("android.app.action.APPLICATION_DELEGATION_SCOPES_CHANGED");
        intent.addFlags(1073741824);
        intent.setPackage(str);
        intent.putStringArrayListExtra("android.app.extra.DELEGATION_SCOPES", arrayList);
        this.mContext.sendBroadcastAsUser(intent, UserHandle.of(i));
    }

    public List getDelegatedScopes(ComponentName componentName, String str) {
        List list;
        Objects.requireNonNull(str, "Delegate package is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        if (callerIdentity.hasAdminComponent()) {
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        } else {
            Preconditions.checkCallAuthorization(isPackage(callerIdentity, str), String.format("Caller with uid %d is not %s", Integer.valueOf(callerIdentity.getUid()), str));
        }
        synchronized (getLockObject()) {
            list = (List) lambda$getUserDataUnchecked$2(callerIdentity.getUserId()).mDelegationMap.get(str);
            if (list == null) {
                list = Collections.EMPTY_LIST;
            }
        }
        return list;
    }

    public List getDelegatePackages(ComponentName componentName, String str) {
        List delegatePackagesInternalLocked;
        Objects.requireNonNull(componentName, "ComponentName is null");
        Objects.requireNonNull(str, "Scope is null");
        if (!Arrays.asList(DELEGATIONS).contains(str)) {
            throw new IllegalArgumentException("Unexpected delegation scope: " + str);
        }
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        synchronized (getLockObject()) {
            delegatePackagesInternalLocked = getDelegatePackagesInternalLocked(str, callerIdentity.getUserId());
        }
        return delegatePackagesInternalLocked;
    }

    public final List getDelegatePackagesInternalLocked(String str, int i) {
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
        ArrayList arrayList = new ArrayList();
        for (int i2 = 0; i2 < lambda$getUserDataUnchecked$2.mDelegationMap.size(); i2++) {
            if (((List) lambda$getUserDataUnchecked$2.mDelegationMap.valueAt(i2)).contains(str)) {
                arrayList.add((String) lambda$getUserDataUnchecked$2.mDelegationMap.keyAt(i2));
            }
        }
        return arrayList;
    }

    public final ComponentName resolveDelegateReceiver(String str, String str2, int i) {
        List delegatePackagesInternalLocked;
        synchronized (getLockObject()) {
            delegatePackagesInternalLocked = getDelegatePackagesInternalLocked(str, i);
        }
        if (delegatePackagesInternalLocked.size() == 0) {
            return null;
        }
        if (delegatePackagesInternalLocked.size() > 1) {
            Slogf.wtf("DevicePolicyManager", "More than one delegate holds " + str);
            return null;
        }
        String str3 = (String) delegatePackagesInternalLocked.get(0);
        Intent intent = new Intent(str2);
        intent.setPackage(str3);
        try {
            List list = this.mIPackageManager.queryIntentReceivers(intent, (String) null, 0L, i).getList();
            int size = list.size();
            if (size >= 1) {
                if (size > 1) {
                    Slogf.w("DevicePolicyManager", str3 + " defines more than one delegate receiver for " + str2);
                }
                return ((ResolveInfo) list.get(0)).activityInfo.getComponentName();
            }
        } catch (RemoteException unused) {
        }
        return null;
    }

    public final boolean isCallerDelegate(String str, int i, String str2) {
        Objects.requireNonNull(str, "callerPackage is null");
        if (!Arrays.asList(DELEGATIONS).contains(str2)) {
            throw new IllegalArgumentException("Unexpected delegation scope: " + str2);
        }
        int userId = UserHandle.getUserId(i);
        synchronized (getLockObject()) {
            List list = (List) lambda$getUserDataUnchecked$2(userId).mDelegationMap.get(str);
            if (list == null || !list.contains(str2)) {
                return false;
            }
            return isCallingFromPackage(str, i);
        }
    }

    public boolean hasDelegatedPermission(String str, int i, String str2) {
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()), String.format("Only the system can %s", "hasDelegatedPermission:" + str2));
        return isCallerDelegate(str, i, str2);
    }

    public final boolean isCallerDelegate(CallerIdentity callerIdentity, String str) {
        boolean z = false;
        if (callerIdentity.getPackageName() == null) {
            return false;
        }
        Preconditions.checkArgument(Arrays.asList(DELEGATIONS).contains(str), "Unexpected delegation scope: %s", new Object[]{str});
        synchronized (getLockObject()) {
            List list = (List) lambda$getUserDataUnchecked$2(callerIdentity.getUserId()).mDelegationMap.get(callerIdentity.getPackageName());
            if (list != null && list.contains(str)) {
                z = true;
            }
        }
        return z;
    }

    public final boolean isCallerDelegate(CallerIdentity callerIdentity) {
        boolean z;
        Objects.requireNonNull(callerIdentity.getPackageName(), "callerPackage is null");
        synchronized (getLockObject()) {
            z = ((List) lambda$getUserDataUnchecked$2(callerIdentity.getUserId()).mDelegationMap.get(callerIdentity.getPackageName())) != null;
        }
        return z;
    }

    public final void setDelegatedScopePreO(ComponentName componentName, String str, String str2) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        synchronized (getLockObject()) {
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(callerIdentity.getUserId());
            if (str != null) {
                List list = (List) lambda$getUserDataUnchecked$2.mDelegationMap.get(str);
                if (list == null) {
                    list = new ArrayList();
                }
                if (!list.contains(str2)) {
                    list.add(str2);
                    setDelegatedScopes(componentName, str, list);
                }
            }
            for (int i = 0; i < lambda$getUserDataUnchecked$2.mDelegationMap.size(); i++) {
                String str3 = (String) lambda$getUserDataUnchecked$2.mDelegationMap.keyAt(i);
                List list2 = (List) lambda$getUserDataUnchecked$2.mDelegationMap.valueAt(i);
                if (!str3.equals(str) && list2.contains(str2)) {
                    ArrayList arrayList = new ArrayList(list2);
                    arrayList.remove(str2);
                    setDelegatedScopes(componentName, str3, arrayList);
                }
            }
        }
    }

    public final boolean isCredentialManagementApp(final CallerIdentity callerIdentity) {
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda129
            public final Object getOrThrow() {
                Boolean lambda$isCredentialManagementApp$45;
                lambda$isCredentialManagementApp$45 = DevicePolicyManagerService.this.lambda$isCredentialManagementApp$45(callerIdentity);
                return lambda$isCredentialManagementApp$45;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$isCredentialManagementApp$45(CallerIdentity callerIdentity) {
        AppOpsManager appOpsManager = this.mInjector.getAppOpsManager();
        if (appOpsManager == null) {
            return Boolean.FALSE;
        }
        return Boolean.valueOf(appOpsManager.noteOpNoThrow(104, callerIdentity.getUid(), callerIdentity.getPackageName(), (String) null, (String) null) == 0);
    }

    public final boolean isAliasInCredentialManagementAppPolicy(final CallerIdentity callerIdentity, final String str) {
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda75
            public final Object getOrThrow() {
                Boolean lambda$isAliasInCredentialManagementAppPolicy$46;
                lambda$isAliasInCredentialManagementAppPolicy$46 = DevicePolicyManagerService.this.lambda$isAliasInCredentialManagementAppPolicy$46(callerIdentity, str);
                return lambda$isAliasInCredentialManagementAppPolicy$46;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$isAliasInCredentialManagementAppPolicy$46(CallerIdentity callerIdentity, String str) {
        try {
            KeyChain.KeyChainConnection bindAsUser = KeyChain.bindAsUser(this.mContext, callerIdentity.getUserHandle());
            try {
                AppUriAuthenticationPolicy credentialManagementAppPolicy = bindAsUser.getService().getCredentialManagementAppPolicy();
                Boolean valueOf = Boolean.valueOf((credentialManagementAppPolicy == null || credentialManagementAppPolicy.getAppAndUriMappings().isEmpty() || !containsAlias(credentialManagementAppPolicy, str)) ? false : true);
                bindAsUser.close();
                return valueOf;
            } catch (Throwable th) {
                if (bindAsUser != null) {
                    try {
                        bindAsUser.close();
                    } catch (Throwable th2) {
                        th.addSuppressed(th2);
                    }
                }
                throw th;
            }
        } catch (RemoteException | InterruptedException unused) {
            return Boolean.FALSE;
        }
    }

    public static boolean containsAlias(AppUriAuthenticationPolicy appUriAuthenticationPolicy, String str) {
        Iterator<Map.Entry<String, Map<Uri, String>>> it = appUriAuthenticationPolicy.getAppAndUriMappings().entrySet().iterator();
        while (it.hasNext()) {
            Iterator<Map.Entry<Uri, String>> it2 = it.next().getValue().entrySet().iterator();
            while (it2.hasNext()) {
                if (it2.next().getValue().equals(str)) {
                    return true;
                }
            }
        }
        return false;
    }

    public void setCertInstallerPackage(ComponentName componentName, String str) {
        setDelegatedScopePreO(componentName, str, "delegation-cert-install");
        DevicePolicyEventLogger.createEvent(25).setAdmin(componentName).setStrings(new String[]{str}).write();
    }

    public String getCertInstallerPackage(ComponentName componentName) {
        List delegatePackages = getDelegatePackages(componentName, "delegation-cert-install");
        if (delegatePackages.size() > 0) {
            return (String) delegatePackages.get(0);
        }
        return null;
    }

    public boolean setAlwaysOnVpnPackage(ComponentName componentName, final String str, final boolean z, final List list) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        checkCanExecuteOrThrowUnsafe(30);
        if (str == null) {
            synchronized (getLockObject()) {
                String str2 = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()).mAlwaysOnVpnPackage;
                if (TextUtils.isEmpty(str2)) {
                    return true;
                }
                revokeVpnAuthorizationForPackage(str2, callerIdentity.getUserId());
            }
        }
        final int userId = callerIdentity.getUserId();
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda124
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setAlwaysOnVpnPackage$47(str, userId, z, list);
            }
        });
        DevicePolicyEventLogger.createEvent(26).setAdmin(callerIdentity.getComponentName()).setStrings(new String[]{str}).setBoolean(z).setInt(list != null ? list.size() : 0).write();
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
            if (!TextUtils.equals(str, profileOwnerOrDeviceOwnerLocked.mAlwaysOnVpnPackage) || z != profileOwnerOrDeviceOwnerLocked.mAlwaysOnVpnLockdown) {
                profileOwnerOrDeviceOwnerLocked.mAlwaysOnVpnPackage = str;
                profileOwnerOrDeviceOwnerLocked.mAlwaysOnVpnLockdown = z;
                saveSettingsLocked(userId);
            }
        }
        return true;
    }

    public /* synthetic */ void lambda$setAlwaysOnVpnPackage$47(String str, int i, boolean z, List list) {
        if (str != null && !isPackageInstalledForUser(str, i)) {
            Slogf.w("DevicePolicyManager", "Non-existent VPN package specified: " + str);
            throw new ServiceSpecificException(1, str);
        }
        if (str != null && z && list != null) {
            Iterator it = list.iterator();
            while (it.hasNext()) {
                String str2 = (String) it.next();
                if (!isPackageInstalledForUser(str2, i)) {
                    Slogf.w("DevicePolicyManager", "Non-existent package in VPN allowlist: " + str2);
                    throw new ServiceSpecificException(1, str2);
                }
            }
        }
        if (!this.mInjector.getVpnManager().setAlwaysOnVpnPackageForUser(i, str, z, list)) {
            throw new UnsupportedOperationException();
        }
    }

    public final void revokeVpnAuthorizationForPackage(final String str, final int i) {
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda205
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$revokeVpnAuthorizationForPackage$48(str, i);
            }
        });
    }

    public /* synthetic */ void lambda$revokeVpnAuthorizationForPackage$48(String str, int i) {
        try {
            ApplicationInfo applicationInfo = this.mIPackageManager.getApplicationInfo(str, 0L, i);
            if (applicationInfo == null) {
                Slogf.w("DevicePolicyManager", "Non-existent VPN package: " + str);
            } else {
                this.mInjector.getAppOpsManager().setMode(47, applicationInfo.uid, str, 3);
            }
        } catch (RemoteException e) {
            Slogf.e("DevicePolicyManager", "Can't talk to package managed", e);
        }
    }

    public String getAlwaysOnVpnPackage(ComponentName componentName) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        final CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        return (String) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda28
            public final Object getOrThrow() {
                String lambda$getAlwaysOnVpnPackage$49;
                lambda$getAlwaysOnVpnPackage$49 = DevicePolicyManagerService.this.lambda$getAlwaysOnVpnPackage$49(callerIdentity);
                return lambda$getAlwaysOnVpnPackage$49;
            }
        });
    }

    public /* synthetic */ String lambda$getAlwaysOnVpnPackage$49(CallerIdentity callerIdentity) {
        return this.mInjector.getVpnManager().getAlwaysOnVpnPackageForUser(callerIdentity.getUserId());
    }

    public String getAlwaysOnVpnPackageForUser(int i) {
        String str;
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()), String.format("Only the system can %s", "call getAlwaysOnVpnPackageForUser"));
        synchronized (getLockObject()) {
            ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(i);
            str = deviceOrProfileOwnerAdminLocked != null ? deviceOrProfileOwnerAdminLocked.mAlwaysOnVpnPackage : null;
        }
        return str;
    }

    public boolean isAlwaysOnVpnLockdownEnabled(ComponentName componentName) {
        final CallerIdentity callerIdentity;
        if (hasCallingPermission("android.permission.MAINLINE_NETWORK_STACK")) {
            callerIdentity = getCallerIdentity();
        } else {
            callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        }
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda73
            public final Object getOrThrow() {
                Boolean lambda$isAlwaysOnVpnLockdownEnabled$50;
                lambda$isAlwaysOnVpnLockdownEnabled$50 = DevicePolicyManagerService.this.lambda$isAlwaysOnVpnLockdownEnabled$50(callerIdentity);
                return lambda$isAlwaysOnVpnLockdownEnabled$50;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$isAlwaysOnVpnLockdownEnabled$50(CallerIdentity callerIdentity) {
        return Boolean.valueOf(this.mInjector.getVpnManager().isVpnLockdownEnabled(callerIdentity.getUserId()));
    }

    public boolean isAlwaysOnVpnLockdownEnabledForUser(int i) {
        boolean z;
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()), String.format("Only the system can %s", "call isAlwaysOnVpnLockdownEnabledForUser"));
        synchronized (getLockObject()) {
            ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(i);
            z = deviceOrProfileOwnerAdminLocked != null && deviceOrProfileOwnerAdminLocked.mAlwaysOnVpnLockdown;
        }
        return z;
    }

    public List getAlwaysOnVpnLockdownAllowlist(ComponentName componentName) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        final CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        return (List) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda152
            public final Object getOrThrow() {
                List lambda$getAlwaysOnVpnLockdownAllowlist$51;
                lambda$getAlwaysOnVpnLockdownAllowlist$51 = DevicePolicyManagerService.this.lambda$getAlwaysOnVpnLockdownAllowlist$51(callerIdentity);
                return lambda$getAlwaysOnVpnLockdownAllowlist$51;
            }
        });
    }

    public /* synthetic */ List lambda$getAlwaysOnVpnLockdownAllowlist$51(CallerIdentity callerIdentity) {
        return this.mInjector.getVpnManager().getVpnLockdownAllowlist(callerIdentity.getUserId());
    }

    public final void forceWipeDeviceNoLock(boolean z, String str, boolean z2, boolean z3) {
        wtfIfInLock();
        try {
            try {
                if (!this.mInjector.recoverySystemRebootWipeUserData(false, str, true, z2, z, z3)) {
                    Slogf.i("DevicePolicyManager", "Persisting factory reset request as it could be delayed by %s", this.mSafetyChecker);
                    synchronized (getLockObject()) {
                        lambda$getUserDataUnchecked$2(0).setDelayedFactoryReset(str, z, z2, z3);
                        saveSettingsLocked(0);
                    }
                }
            } catch (IOException | SecurityException e) {
                Slogf.w("DevicePolicyManager", "Failed requesting data wipe", e);
                SecurityLog.writeEvent(210023, new Object[0]);
            }
        } catch (Throwable th) {
            SecurityLog.writeEvent(210023, new Object[0]);
            throw th;
        }
    }

    public final void factoryResetIfDelayedEarlier() {
        synchronized (getLockObject()) {
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(0);
            if (lambda$getUserDataUnchecked$2.mFactoryResetFlags == 0) {
                return;
            }
            if (lambda$getUserDataUnchecked$2.mFactoryResetReason == null) {
                Slogf.e("DevicePolicyManager", "no persisted reason for factory resetting");
                lambda$getUserDataUnchecked$2.mFactoryResetReason = "requested before boot";
            }
            FactoryResetter build = FactoryResetter.newBuilder(this.mContext).setReason(lambda$getUserDataUnchecked$2.mFactoryResetReason).setForce(true).setWipeEuicc((lambda$getUserDataUnchecked$2.mFactoryResetFlags & 4) != 0).setWipeAdoptableStorage((lambda$getUserDataUnchecked$2.mFactoryResetFlags & 2) != 0).setWipeFactoryResetProtection((lambda$getUserDataUnchecked$2.mFactoryResetFlags & 8) != 0).build();
            Slogf.i("DevicePolicyManager", "Factory resetting on boot using " + build);
            try {
                if (!build.factoryReset()) {
                    Slogf.wtf("DevicePolicyManager", "Factory reset using " + build + " failed.");
                }
            } catch (IOException e) {
                Slogf.wtf("DevicePolicyManager", "Could not factory reset using " + build, e);
            }
        }
    }

    /* JADX WARN: Removed duplicated region for block: B:29:0x0064  */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public final void forceWipeUser(int r6, java.lang.String r7, boolean r8) {
        /*
            r5 = this;
            java.lang.String r0 = "DevicePolicyManager"
            r1 = 210023(0x33467, float:2.94305E-40)
            r2 = 0
            int r3 = r5.getCurrentForegroundUserId()     // Catch: java.lang.Throwable -> L4f android.os.RemoteException -> L52
            if (r3 != r6) goto L15
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r3 = r5.mInjector     // Catch: java.lang.Throwable -> L4f android.os.RemoteException -> L52
            android.app.IActivityManager r3 = r3.getIActivityManager()     // Catch: java.lang.Throwable -> L4f android.os.RemoteException -> L52
            r3.switchUser(r2)     // Catch: java.lang.Throwable -> L4f android.os.RemoteException -> L52
        L15:
            com.android.server.pm.UserManagerInternal r3 = r5.mUserManagerInternal     // Catch: java.lang.Throwable -> L4f android.os.RemoteException -> L52
            boolean r3 = r3.removeUserEvenWhenDisallowed(r6)     // Catch: java.lang.Throwable -> L4f android.os.RemoteException -> L52
            if (r3 != 0) goto L32
            java.lang.StringBuilder r5 = new java.lang.StringBuilder     // Catch: android.os.RemoteException -> L4d java.lang.Throwable -> L61
            r5.<init>()     // Catch: android.os.RemoteException -> L4d java.lang.Throwable -> L61
            java.lang.String r7 = "Couldn't remove user "
            r5.append(r7)     // Catch: android.os.RemoteException -> L4d java.lang.Throwable -> L61
            r5.append(r6)     // Catch: android.os.RemoteException -> L4d java.lang.Throwable -> L61
            java.lang.String r5 = r5.toString()     // Catch: android.os.RemoteException -> L4d java.lang.Throwable -> L61
            com.android.server.utils.Slogf.w(r0, r5)     // Catch: android.os.RemoteException -> L4d java.lang.Throwable -> L61
            goto L45
        L32:
            boolean r4 = r5.isManagedProfile(r6)     // Catch: android.os.RemoteException -> L4d java.lang.Throwable -> L61
            if (r4 == 0) goto L45
            if (r8 != 0) goto L45
            int r6 = r5.getProfileParentId(r6)     // Catch: android.os.RemoteException -> L4d java.lang.Throwable -> L61
            android.os.UserHandle r6 = android.os.UserHandle.of(r6)     // Catch: android.os.RemoteException -> L4d java.lang.Throwable -> L61
            r5.sendWipeProfileNotification(r7, r6)     // Catch: android.os.RemoteException -> L4d java.lang.Throwable -> L61
        L45:
            if (r3 != 0) goto L60
            java.lang.Object[] r5 = new java.lang.Object[r2]
            android.app.admin.SecurityLog.writeEvent(r1, r5)
            goto L60
        L4d:
            r5 = move-exception
            goto L54
        L4f:
            r5 = move-exception
            r3 = r2
            goto L62
        L52:
            r5 = move-exception
            r3 = r2
        L54:
            java.lang.String r6 = "Error forcing wipe user"
            com.android.server.utils.Slogf.wtf(r0, r6, r5)     // Catch: java.lang.Throwable -> L61
            if (r3 != 0) goto L60
            java.lang.Object[] r5 = new java.lang.Object[r2]
            android.app.admin.SecurityLog.writeEvent(r1, r5)
        L60:
            return
        L61:
            r5 = move-exception
        L62:
            if (r3 != 0) goto L69
            java.lang.Object[] r6 = new java.lang.Object[r2]
            android.app.admin.SecurityLog.writeEvent(r1, r6)
        L69:
            throw r5
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.forceWipeUser(int, java.lang.String, boolean):void");
    }

    public void wipeDataWithReason(String str, int i, String str2, boolean z, boolean z2) {
        CallerIdentity callerIdentity;
        ActiveAdmin activeAdminWithPolicyForUidLocked;
        ActiveAdmin activeAdmin;
        int userId;
        String str3;
        ComponentName componentName;
        int i2;
        if (this.mHasFeature || hasCallingOrSelfPermission("android.permission.MASTER_CLEAR")) {
            if (isPolicyEngineForFinanceFlagEnabled()) {
                callerIdentity = getCallerIdentity(str);
            } else {
                callerIdentity = getCallerIdentity();
            }
            CallerIdentity callerIdentity2 = callerIdentity;
            boolean isProfileOwnerOfOrganizationOwnedDevice = isProfileOwnerOfOrganizationOwnedDevice(callerIdentity2.getUserId());
            if (isPolicyEngineForFinanceFlagEnabled()) {
                activeAdmin = enforcePermissionsAndGetEnforcingAdmin(null, new String[]{"android.permission.MANAGE_DEVICE_POLICY_WIPE_DATA", "android.permission.MASTER_CLEAR"}, 4, callerIdentity2.getPackageName(), z2 ? -1 : getAffectedUser(z)).getActiveAdmin();
            } else {
                if (z) {
                    Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice, "Wiping the entire device can only be done by a profile owner on organization-owned device.");
                }
                if ((i & 2) != 0) {
                    Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity2) || isProfileOwnerOfOrganizationOwnedDevice || isFinancedDeviceOwner(callerIdentity2), "Only device owners or profile owners of organization-owned device can set WIPE_RESET_PROTECTION_DATA");
                }
                synchronized (getLockObject()) {
                    activeAdminWithPolicyForUidLocked = getActiveAdminWithPolicyForUidLocked(null, 4, callerIdentity2.getUid());
                }
                Preconditions.checkCallAuthorization(activeAdminWithPolicyForUidLocked != null || hasCallingOrSelfPermission("android.permission.MASTER_CLEAR"), "No active admin for user %d and caller %d does not hold MASTER_CLEAR permission", new Object[]{Integer.valueOf(callerIdentity2.getUserId()), Integer.valueOf(callerIdentity2.getUid())});
                activeAdmin = activeAdminWithPolicyForUidLocked;
            }
            checkCanExecuteOrThrowUnsafe(8);
            String genericWipeReason = TextUtils.isEmpty(str2) ? getGenericWipeReason(isProfileOwnerOfOrganizationOwnedDevice, z) : str2;
            if (activeAdmin != null) {
                userId = activeAdmin.getUserHandle().getIdentifier();
            } else {
                userId = callerIdentity2.getUserId();
            }
            Slogf.i("DevicePolicyManager", "wipeDataWithReason(%s): admin=%s, user=%d", genericWipeReason, activeAdmin, Integer.valueOf(userId));
            if (isProfileOwnerOfOrganizationOwnedDevice) {
                if (z) {
                    userId = 0;
                } else {
                    final UserHandle of = UserHandle.of(getProfileParentId(userId));
                    this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda40
                        public final void runOrThrow() {
                            DevicePolicyManagerService.this.lambda$wipeDataWithReason$52(of);
                        }
                    });
                }
            }
            DevicePolicyEventLogger devicePolicyEventLogger = DevicePolicyEventLogger.createEvent(11).setInt(i);
            String[] strArr = new String[1];
            strArr[0] = z ? "calledFromParent" : "notCalledFromParent";
            DevicePolicyEventLogger strings = devicePolicyEventLogger.setStrings(strArr);
            if (activeAdmin != null) {
                if (activeAdmin.isPermissionBased) {
                    str3 = callerIdentity2.getPackageName();
                    strings.setAdmin(str3);
                    i2 = userId;
                    componentName = null;
                    strings.write();
                    wipeDataNoLock(componentName, i, String.format("DevicePolicyManager.wipeDataWithReason() from %s, organization-owned? %s", str3, Boolean.valueOf(isProfileOwnerOfOrganizationOwnedDevice)), genericWipeReason, i2, z, Boolean.valueOf(z2));
                }
                ComponentName component = activeAdmin.info.getComponent();
                String flattenToShortString = component.flattenToShortString();
                strings.setAdmin(component);
                i2 = userId;
                componentName = component;
                str3 = flattenToShortString;
                strings.write();
                wipeDataNoLock(componentName, i, String.format("DevicePolicyManager.wipeDataWithReason() from %s, organization-owned? %s", str3, Boolean.valueOf(isProfileOwnerOfOrganizationOwnedDevice)), genericWipeReason, i2, z, Boolean.valueOf(z2));
            }
            str3 = this.mInjector.getPackageManager().getPackagesForUid(callerIdentity2.getUid())[0];
            Slogf.i("DevicePolicyManager", "Logging wipeData() event admin as " + str3);
            strings.setAdmin(str3);
            if (this.mInjector.userManagerIsHeadlessSystemUserMode()) {
                componentName = null;
                i2 = 0;
                strings.write();
                wipeDataNoLock(componentName, i, String.format("DevicePolicyManager.wipeDataWithReason() from %s, organization-owned? %s", str3, Boolean.valueOf(isProfileOwnerOfOrganizationOwnedDevice)), genericWipeReason, i2, z, Boolean.valueOf(z2));
            }
            i2 = userId;
            componentName = null;
            strings.write();
            wipeDataNoLock(componentName, i, String.format("DevicePolicyManager.wipeDataWithReason() from %s, organization-owned? %s", str3, Boolean.valueOf(isProfileOwnerOfOrganizationOwnedDevice)), genericWipeReason, i2, z, Boolean.valueOf(z2));
        }
    }

    public final String getGenericWipeReason(boolean z, boolean z2) {
        if (z && !z2) {
            return getUpdatableString("Core.WORK_PROFILE_DELETED_ORG_OWNED_MESSAGE", R.string.leave_accessibility_shortcut_on, new Object[0]);
        }
        return getUpdatableString("Core.WORK_PROFILE_DELETED_GENERIC_MESSAGE", 17043408, new Object[0]);
    }

    public final void clearOrgOwnedProfileOwnerDeviceWidePolicies(int i) {
        boolean z;
        Slogf.i("DevicePolicyManager", "Cleaning up device-wide policies left over from org-owned profile...");
        this.mLockPatternUtils.setDeviceOwnerInfo((String) null);
        this.mInjector.settingsGlobalPutInt("wifi_device_owner_configs_lockdown", 0);
        if (this.mInjector.securityLogGetLoggingEnabledProperty()) {
            this.mSecurityLogMonitor.stop();
            this.mInjector.securityLogSetLoggingEnabledProperty(false);
        }
        setNetworkLoggingActiveInternal(false);
        synchronized (getLockObject()) {
            z = this.mOwners.getSystemUpdatePolicy() != null;
            if (z) {
                this.mOwners.clearSystemUpdatePolicy();
                this.mOwners.writeDeviceOwner();
            }
        }
        if (z) {
            this.mContext.sendBroadcastAsUser(new Intent("android.app.action.SYSTEM_UPDATE_POLICY_CHANGED"), UserHandle.SYSTEM);
        }
        suspendPersonalAppsInternal(i, getManagedUserId(i), false);
        int frpManagementAgentUid = getFrpManagementAgentUid();
        if (frpManagementAgentUid > 0) {
            lambda$setFactoryResetProtectionPolicy$57(frpManagementAgentUid);
        }
        this.mLockSettingsInternal.refreshStrongAuthTimeout(i);
        clearManagedSubscriptionsPolicy();
        clearLauncherShortcutOverrides();
        updateTelephonyCrossProfileIntentFilters(i, -10000, false);
        Slogf.i("DevicePolicyManager", "Cleaning up device-wide policies done.");
    }

    public final void clearManagedSubscriptionsPolicy() {
        unregisterOnSubscriptionsChangedListener();
        SubscriptionManager subscriptionManager = (SubscriptionManager) this.mContext.getSystemService(SubscriptionManager.class);
        for (int i : subscriptionManager.getActiveSubscriptionIdList(false)) {
            subscriptionManager.setSubscriptionUserHandle(i, null);
        }
    }

    public final void clearLauncherShortcutOverrides() {
        this.mPolicyCache.setLauncherShortcutOverrides(new ArrayMap());
    }

    public final void updateTelephonyCrossProfileIntentFilters(int i, int i2, boolean z) {
        try {
            if (!z && i2 == -10000) {
                this.mIPackageManager.clearCrossProfileIntentFilters(i, this.mContext.getPackageName());
                return;
            }
            for (DefaultCrossProfileIntentFilter defaultCrossProfileIntentFilter : DefaultCrossProfileIntentFiltersUtils.getDefaultCrossProfileTelephonyIntentFilters(!z)) {
                if (removeCrossProfileIntentFilter(defaultCrossProfileIntentFilter, i, i2)) {
                    Slogf.w("DevicePolicyManager", "Failed to remove cross-profile intent filter: " + defaultCrossProfileIntentFilter.filter.getIntentFilter() + ", enableWorkTelephony: " + z);
                }
            }
            Iterator it = DefaultCrossProfileIntentFiltersUtils.getDefaultCrossProfileTelephonyIntentFilters(z).iterator();
            while (it.hasNext()) {
                addCrossProfileIntentFilter((DefaultCrossProfileIntentFilter) it.next(), i, i2);
            }
        } catch (RemoteException e) {
            Slogf.wtf("DevicePolicyManager", "Error updating telephony cross profile intent filters", e);
        }
    }

    public void addCrossProfileIntentFilter(DefaultCrossProfileIntentFilter defaultCrossProfileIntentFilter, int i, int i2) {
        if (defaultCrossProfileIntentFilter.direction == 1) {
            this.mIPackageManager.addCrossProfileIntentFilter(defaultCrossProfileIntentFilter.filter.getIntentFilter(), this.mContext.getOpPackageName(), i, i2, defaultCrossProfileIntentFilter.flags);
        } else {
            this.mIPackageManager.addCrossProfileIntentFilter(defaultCrossProfileIntentFilter.filter.getIntentFilter(), this.mContext.getOpPackageName(), i2, i, defaultCrossProfileIntentFilter.flags);
        }
    }

    public boolean removeCrossProfileIntentFilter(DefaultCrossProfileIntentFilter defaultCrossProfileIntentFilter, int i, int i2) {
        if (defaultCrossProfileIntentFilter.direction == 1) {
            return this.mIPackageManager.removeCrossProfileIntentFilter(defaultCrossProfileIntentFilter.filter.getIntentFilter(), this.mContext.getOpPackageName(), i, i2, defaultCrossProfileIntentFilter.flags);
        }
        return this.mIPackageManager.removeCrossProfileIntentFilter(defaultCrossProfileIntentFilter.filter.getIntentFilter(), this.mContext.getOpPackageName(), i2, i, defaultCrossProfileIntentFilter.flags);
    }

    public final void wipeDataNoLock(final ComponentName componentName, final int i, final String str, final String str2, final int i2, boolean z, Boolean bool) {
        String str3;
        final boolean z2;
        wtfIfInLock();
        if (componentName != null) {
            str3 = componentName.getPackageName();
        } else {
            int binderGetCallingUid = this.mInjector.binderGetCallingUid();
            String[] packagesForUid = this.mInjector.getPackageManager().getPackagesForUid(binderGetCallingUid);
            Preconditions.checkState(packagesForUid.length > 0, "Caller %s does not have any associated packages", new Object[]{Integer.valueOf(binderGetCallingUid)});
            str3 = packagesForUid[0];
        }
        String str4 = str3;
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda114
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$wipeDataNoLock$53(i2, componentName);
            }
        });
        final boolean z3 = i2 == 0;
        if (bool == null || !this.mInjector.isChangeEnabled(242193913L, str4, i2)) {
            z2 = z3;
        } else if (bool.booleanValue()) {
            enforcePermissionsAndGetEnforcingAdmin(null, new String[]{"android.permission.MANAGE_DEVICE_POLICY_WIPE_DATA", "android.permission.MASTER_CLEAR"}, 4, str4, bool.booleanValue() ? -1 : getAffectedUser(z));
            z2 = true;
        } else {
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda115
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$wipeDataNoLock$55(z3, i2);
                }
            });
            z2 = false;
        }
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda116
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$wipeDataNoLock$56(z2, i, str, i2, str2);
            }
        });
    }

    public /* synthetic */ void lambda$wipeDataNoLock$53(int i, ComponentName componentName) {
        String str;
        IRestrictionPolicy restrictionService;
        if (i == 0) {
            str = "no_factory_reset";
        } else {
            str = isManagedProfile(i) ? "no_remove_managed_profile" : "no_remove_user";
        }
        if (isAdminAffectedByRestriction(componentName, str, i)) {
            throw new SecurityException("Cannot wipe data. " + str + " restriction is set for user " + i);
        }
        if (i != 0 || (restrictionService = this.mInjector.getRestrictionService()) == null) {
            return;
        }
        boolean isFactoryResetAllowed = restrictionService.isFactoryResetAllowed(new ContextInfo(this.mInjector.binderGetCallingUid(), i));
        Log.d("DevicePolicyManager", "isFactoryResetAllowed = " + isFactoryResetAllowed);
        if (!isFactoryResetAllowed) {
            throw new SecurityException("Cannot wipe data. Factory reset is not allowed from Restriction Policy.");
        }
    }

    public /* synthetic */ void lambda$wipeDataNoLock$55(boolean z, final int i) {
        Preconditions.checkCallAuthorization(!z, "User %s is a system user and cannot be removed", new Object[]{Integer.valueOf(i)});
        Preconditions.checkState(!(getUserInfo(i).isFull() && this.mUserManager.getAliveUsers().stream().filter(new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda225
            @Override // java.util.function.Predicate
            public final boolean test(Object obj) {
                boolean lambda$wipeDataNoLock$54;
                lambda$wipeDataNoLock$54 = DevicePolicyManagerService.lambda$wipeDataNoLock$54(i, (UserInfo) obj);
                return lambda$wipeDataNoLock$54;
            }
        }).noneMatch(new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda226
            @Override // java.util.function.Predicate
            public final boolean test(Object obj) {
                return ((UserInfo) obj).isFull();
            }
        })), "Removing user %s would leave the device without any active users. Consider factory resetting the device instead.", new Object[]{Integer.valueOf(i)});
    }

    public static /* synthetic */ boolean lambda$wipeDataNoLock$54(int i, UserInfo userInfo) {
        return userInfo.getUserHandle().getIdentifier() != i;
    }

    public /* synthetic */ void lambda$wipeDataNoLock$56(boolean z, int i, String str, int i2, String str2) {
        if (z) {
            forceWipeDeviceNoLock((i & 1) != 0, str, (i & 4) != 0, (i & 2) != 0);
        } else {
            forceWipeUser(i2, str2, (i & 8) != 0);
        }
    }

    public final void sendWipeProfileNotification(String str, UserHandle userHandle) {
        this.mInjector.getNotificationManager().notifyAsUser(null, 1001, new Notification.Builder(this.mContext, SystemNotificationChannels.DEVICE_ADMIN).setSmallIcon(R.drawable.stat_sys_warning).setContentTitle(getWorkProfileDeletedTitle()).setContentText(str).setColor(this.mContext.getColor(R.color.system_notification_accent_color)).setStyle(new Notification.BigTextStyle().bigText(str)).build(), userHandle);
    }

    public final String getWorkProfileDeletedTitle() {
        return getUpdatableString("Core.WORK_PROFILE_DELETED_TITLE", 17043407, new Object[0]);
    }

    public final void clearWipeProfileNotification() {
        this.mInjector.getNotificationManager().cancel(1001);
    }

    public void setFactoryResetProtectionPolicy(ComponentName componentName, String str, FactoryResetProtectionPolicy factoryResetProtectionPolicy) {
        ActiveAdmin profileOwnerOrDeviceOwnerLocked;
        if (this.mHasFeature) {
            if (!isPermissionCheckFlagEnabled()) {
                Preconditions.checkNotNull(componentName, "ComponentName is null");
            }
            CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
            if (!isPermissionCheckFlagEnabled()) {
                Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
            }
            checkCanExecuteOrThrowUnsafe(32);
            final int frpManagementAgentUidOrThrow = getFrpManagementAgentUidOrThrow();
            synchronized (getLockObject()) {
                if (isPermissionCheckFlagEnabled()) {
                    profileOwnerOrDeviceOwnerLocked = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_FACTORY_RESET", callerIdentity.getPackageName(), -1).getActiveAdmin();
                } else {
                    profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
                }
                profileOwnerOrDeviceOwnerLocked.mFactoryResetProtectionPolicy = factoryResetProtectionPolicy;
                saveSettingsLocked(callerIdentity.getUserId());
            }
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda41
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setFactoryResetProtectionPolicy$57(frpManagementAgentUidOrThrow);
                }
            });
            DevicePolicyEventLogger.createEvent(130).setAdmin(callerIdentity.getPackageName()).write();
        }
    }

    /* renamed from: notifyResetProtectionPolicyChanged */
    public final void lambda$setFactoryResetProtectionPolicy$57(int i) {
        this.mContext.sendBroadcastAsUser(new Intent("android.app.action.RESET_PROTECTION_POLICY_CHANGED").addFlags(285212672), UserHandle.getUserHandleForUid(i), "android.permission.MANAGE_FACTORY_RESET_PROTECTION");
    }

    public FactoryResetProtectionPolicy getFactoryResetProtectionPolicy(ComponentName componentName) {
        ActiveAdmin profileOwnerOrDeviceOwnerLocked;
        if (!this.mHasFeature) {
            return null;
        }
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        int frpManagementAgentUidOrThrow = getFrpManagementAgentUidOrThrow();
        synchronized (getLockObject()) {
            if (componentName == null) {
                Preconditions.checkCallAuthorization(frpManagementAgentUidOrThrow == callerIdentity.getUid() || hasCallingPermission("android.permission.MASTER_CLEAR") || hasCallingPermission("android.permission.MANAGE_DEVICE_POLICY_FACTORY_RESET"), "Must be called by the FRP management agent on device");
                profileOwnerOrDeviceOwnerLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceOrSystemPermissionBasedAdminLocked();
            } else {
                Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
                profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
            }
        }
        if (profileOwnerOrDeviceOwnerLocked != null) {
            return profileOwnerOrDeviceOwnerLocked.mFactoryResetProtectionPolicy;
        }
        return null;
    }

    public final int getFrpManagementAgentUid() {
        PersistentDataBlockManagerInternal persistentDataBlockManagerInternal = this.mInjector.getPersistentDataBlockManagerInternal();
        if (persistentDataBlockManagerInternal != null) {
            return persistentDataBlockManagerInternal.getAllowedUid();
        }
        return -1;
    }

    public final int getFrpManagementAgentUidOrThrow() {
        int frpManagementAgentUid = getFrpManagementAgentUid();
        if (frpManagementAgentUid != -1) {
            return frpManagementAgentUid;
        }
        throw new UnsupportedOperationException("The persistent data block service is not supported on this device");
    }

    public boolean isFactoryResetProtectionPolicySupported() {
        return getFrpManagementAgentUid() != -1;
    }

    public void sendLostModeLocationUpdate(final AndroidFuture androidFuture) {
        final ActiveAdmin deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked;
        if (!this.mHasFeature) {
            androidFuture.complete(Boolean.FALSE);
            return;
        }
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.TRIGGER_LOST_MODE"));
        synchronized (getLockObject()) {
            if (isHeadlessFlagEnabled()) {
                deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked();
            } else {
                deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked(0);
            }
            Preconditions.checkState(deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked != null, "Lost mode location updates can only be sent on an organization-owned device.");
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda192
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$sendLostModeLocationUpdate$58(deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked, androidFuture);
                }
            });
        }
    }

    public /* synthetic */ void lambda$sendLostModeLocationUpdate$58(ActiveAdmin activeAdmin, AndroidFuture androidFuture) {
        tryRetrieveAndSendLocationUpdate(activeAdmin, androidFuture, new String[]{"fused", "network", "gps"}, 0);
    }

    public final void tryRetrieveAndSendLocationUpdate(final ActiveAdmin activeAdmin, final AndroidFuture androidFuture, final String[] strArr, final int i) {
        if (i == strArr.length) {
            androidFuture.complete(Boolean.FALSE);
        } else if (this.mInjector.getLocationManager().isProviderEnabled(strArr[i])) {
            this.mInjector.getLocationManager().getCurrentLocation(strArr[i], null, this.mContext.getMainExecutor(), new Consumer() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda215
                @Override // java.util.function.Consumer
                public final void accept(Object obj) {
                    DevicePolicyManagerService.this.lambda$tryRetrieveAndSendLocationUpdate$59(activeAdmin, androidFuture, strArr, i, (Location) obj);
                }
            });
        } else {
            tryRetrieveAndSendLocationUpdate(activeAdmin, androidFuture, strArr, i + 1);
        }
    }

    public /* synthetic */ void lambda$tryRetrieveAndSendLocationUpdate$59(ActiveAdmin activeAdmin, AndroidFuture androidFuture, String[] strArr, int i, Location location) {
        if (location != null) {
            this.mContext.sendBroadcastAsUser(newLostModeLocationUpdateIntent(activeAdmin, location), activeAdmin.getUserHandle());
            androidFuture.complete(Boolean.TRUE);
        } else {
            tryRetrieveAndSendLocationUpdate(activeAdmin, androidFuture, strArr, i + 1);
        }
    }

    public final Intent newLostModeLocationUpdateIntent(ActiveAdmin activeAdmin, Location location) {
        Intent intent = new Intent("android.app.action.LOST_MODE_LOCATION_UPDATE");
        intent.putExtra("android.app.extra.LOST_MODE_LOCATION", location);
        intent.setPackage(activeAdmin.info.getPackageName());
        return intent;
    }

    public void getRemoveWarning(ComponentName componentName, RemoteCallback remoteCallback, int i) {
        if (this.mHasFeature) {
            Preconditions.checkArgumentNonnegative(i, "Invalid userId");
            Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
            Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.BIND_DEVICE_ADMIN"));
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                if (activeAdminUncheckedLocked == null) {
                    remoteCallback.sendResult((Bundle) null);
                    return;
                }
                Intent intent = new Intent("android.app.action.DEVICE_ADMIN_DISABLE_REQUESTED");
                intent.setFlags(268435456);
                intent.setComponent(activeAdminUncheckedLocked.info.getComponent());
                this.mContext.sendOrderedBroadcastAsUser(intent, new UserHandle(i), null, new BroadcastReceiver() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService.6
                    public final /* synthetic */ RemoteCallback val$result;

                    public AnonymousClass6(RemoteCallback remoteCallback2) {
                        r2 = remoteCallback2;
                    }

                    @Override // android.content.BroadcastReceiver
                    public void onReceive(Context context, Intent intent2) {
                        r2.sendResult(getResultExtras(false));
                    }
                }, null, -1, null, null);
            }
        }
    }

    /* renamed from: com.android.server.devicepolicy.DevicePolicyManagerService$6 */
    /* loaded from: classes2.dex */
    public class AnonymousClass6 extends BroadcastReceiver {
        public final /* synthetic */ RemoteCallback val$result;

        public AnonymousClass6(RemoteCallback remoteCallback2) {
            r2 = remoteCallback2;
        }

        @Override // android.content.BroadcastReceiver
        public void onReceive(Context context, Intent intent2) {
            r2.sendResult(getResultExtras(false));
        }
    }

    public void reportPasswordChanged(PasswordMetrics passwordMetrics, int i) {
        if (this.mHasFeature && this.mLockPatternUtils.hasSecureLockScreen()) {
            Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()));
            if (!isSeparateProfileChallengeEnabled(i)) {
                Preconditions.checkCallAuthorization(!isManagedProfile(i), "You can not set the active password for a managed profile, userId = %d", new Object[]{Integer.valueOf(i)});
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            ArraySet arraySet = new ArraySet();
            synchronized (getLockObject()) {
                lambda$getUserDataUnchecked$2.mFailedPasswordAttempts = 0;
                if (i != 0 && isManagedProfile(i)) {
                    lambda$getUserDataUnchecked$2.mFailedBiometricAttempts = 0;
                }
                arraySet.add(Integer.valueOf(i));
                arraySet.addAll(updatePasswordValidityCheckpointLocked(i, false));
                arraySet.addAll(updatePasswordExpirationsLocked(i));
                setExpirationAlarmCheckLocked(this.mContext, i, false);
                sendAdminCommandForLockscreenPoliciesLocked("android.app.action.ACTION_PASSWORD_CHANGED", 0, i);
                arraySet.addAll(removeCaApprovalsIfNeeded(i));
                saveSettingsForUsersLocked(arraySet);
            }
            if (this.mInjector.securityLogIsLoggingEnabled()) {
                SecurityLog.writeEvent(210036, new Object[]{Integer.valueOf(passwordMetrics.determineComplexity()), Integer.valueOf(i)});
            }
        }
    }

    public final Set updatePasswordExpirationsLocked(int i) {
        ArraySet arraySet = new ArraySet();
        List activeAdminsForLockscreenPoliciesLocked = getActiveAdminsForLockscreenPoliciesLocked(i);
        for (int i2 = 0; i2 < activeAdminsForLockscreenPoliciesLocked.size(); i2++) {
            ActiveAdmin activeAdmin = (ActiveAdmin) activeAdminsForLockscreenPoliciesLocked.get(i2);
            if (activeAdmin.isPermissionBased || activeAdmin.info.usesPolicy(6)) {
                arraySet.add(Integer.valueOf(activeAdmin.getUserHandle().getIdentifier()));
                long j = activeAdmin.passwordExpirationTimeout;
                activeAdmin.passwordExpirationDate = j > 0 ? System.currentTimeMillis() + j : 0L;
            }
        }
        return arraySet;
    }

    public void reportFailedPasswordAttempt(int i, boolean z) {
        ActiveAdmin activeAdmin;
        boolean z2;
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.BIND_DEVICE_ADMIN"));
        if (!isSeparateProfileChallengeEnabled(i)) {
            Preconditions.checkCallAuthorization(!isManagedProfile(i), "You can not report failed password attempt if separate profile challenge is not in place for a managed profile, userId = %d", new Object[]{Integer.valueOf(i)});
        }
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            synchronized (getLockObject()) {
                DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
                lambda$getUserDataUnchecked$2.mFailedPasswordAttempts++;
                saveSettingsLocked(i);
                if (this.mHasFeature) {
                    activeAdmin = getAdminWithMinimumFailedPasswordsForWipeLocked(i, false);
                    int i2 = activeAdmin != null ? activeAdmin.maximumFailedPasswordsForWipe : 0;
                    z2 = i2 > 0 && lambda$getUserDataUnchecked$2.mFailedPasswordAttempts >= i2;
                    sendAdminCommandForLockscreenPoliciesLocked("android.app.action.ACTION_PASSWORD_FAILED", 1, i);
                } else {
                    activeAdmin = null;
                    z2 = false;
                }
            }
            if (z2 && activeAdmin != null) {
                int userIdToWipeForFailedPasswords = getUserIdToWipeForFailedPasswords(activeAdmin);
                Slogf.i("DevicePolicyManager", "Max failed password attempts policy reached for admin: " + activeAdmin.info.getComponent().flattenToShortString() + ". Calling wipeData for user " + userIdToWipeForFailedPasswords);
                try {
                    wipeDataNoLock(activeAdmin.info.getComponent(), 0, "reportFailedPasswordAttempt() by " + activeAdmin.info.getComponent().flattenToShortString(), getFailedPasswordAttemptWipeMessage(), userIdToWipeForFailedPasswords, z, null);
                } catch (SecurityException e) {
                    Slogf.w("DevicePolicyManager", "Failed to wipe user " + userIdToWipeForFailedPasswords + " after max failed password attempts reached.", e);
                }
            }
            if (this.mInjector.securityLogIsLoggingEnabled()) {
                SecurityLog.writeEvent(210007, new Object[]{0, 1});
            }
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public final String getFailedPasswordAttemptWipeMessage() {
        return getUpdatableString("Core.WORK_PROFILE_DELETED_FAILED_PASSWORD_ATTEMPTS_MESSAGE", 17043410, new Object[0]);
    }

    public final int getUserIdToWipeForFailedPasswords(ActiveAdmin activeAdmin) {
        int identifier = activeAdmin.getUserHandle().getIdentifier();
        return (!activeAdmin.isPermissionBased && isProfileOwnerOfOrganizationOwnedDevice(activeAdmin.info.getComponent(), identifier)) ? getProfileParentId(identifier) : identifier;
    }

    public void reportSuccessfulPasswordAttempt(final int i) {
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.BIND_DEVICE_ADMIN"));
        synchronized (getLockObject()) {
            final DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            if (lambda$getUserDataUnchecked$2.mFailedPasswordAttempts != 0 || lambda$getUserDataUnchecked$2.mPasswordOwner >= 0 || lambda$getUserDataUnchecked$2.mFailedBiometricAttempts != 0) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda123
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$reportSuccessfulPasswordAttempt$60(lambda$getUserDataUnchecked$2, i);
                    }
                });
            }
        }
        if (this.mInjector.securityLogIsLoggingEnabled()) {
            SecurityLog.writeEvent(210007, new Object[]{1, 1});
        }
    }

    public /* synthetic */ void lambda$reportSuccessfulPasswordAttempt$60(DevicePolicyData devicePolicyData, int i) {
        devicePolicyData.mFailedPasswordAttempts = 0;
        if (i != 0 && isManagedProfile(i)) {
            devicePolicyData.mFailedBiometricAttempts = 0;
        }
        devicePolicyData.mPasswordOwner = -1;
        saveSettingsLocked(i);
        if (this.mHasFeature) {
            sendAdminCommandForLockscreenPoliciesLocked("android.app.action.ACTION_PASSWORD_SUCCEEDED", 1, i);
        }
    }

    public void reportFailedBiometricAttempt(int i) {
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.BIND_DEVICE_ADMIN"));
        if (this.mInjector.securityLogIsLoggingEnabled()) {
            SecurityLog.writeEvent(210007, new Object[]{0, 0});
        }
        if (i == 0 || !isManagedProfile(i)) {
            return;
        }
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            synchronized (getLockObject()) {
                lambda$getUserDataUnchecked$2(i).mFailedBiometricAttempts++;
                saveSettingsLocked(i);
            }
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public void reportSuccessfulBiometricAttempt(final int i) {
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.BIND_DEVICE_ADMIN"));
        if (this.mInjector.securityLogIsLoggingEnabled()) {
            SecurityLog.writeEvent(210007, new Object[]{1, 0});
        }
        if (i == 0 || !isManagedProfile(i)) {
            return;
        }
        synchronized (getLockObject()) {
            final DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            if (lambda$getUserDataUnchecked$2.mFailedBiometricAttempts != 0) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda50
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$reportSuccessfulBiometricAttempt$61(lambda$getUserDataUnchecked$2, i);
                    }
                });
            }
        }
    }

    public /* synthetic */ void lambda$reportSuccessfulBiometricAttempt$61(DevicePolicyData devicePolicyData, int i) {
        devicePolicyData.mFailedBiometricAttempts = 0;
        saveSettingsLocked(i);
    }

    public void reportKeyguardDismissed(int i) {
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.BIND_DEVICE_ADMIN"));
        if (this.mInjector.securityLogIsLoggingEnabled()) {
            SecurityLog.writeEvent(210006, new Object[0]);
        }
    }

    public void reportKeyguardSecured(int i) {
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.BIND_DEVICE_ADMIN"));
        if (this.mInjector.securityLogIsLoggingEnabled()) {
            SecurityLog.writeEvent(210008, new Object[0]);
        }
    }

    public ComponentName setGlobalProxy(ComponentName componentName, String str, String str2) {
        if (!this.mHasFeature) {
            return null;
        }
        synchronized (getLockObject()) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            final DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(0);
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 5);
            for (ComponentName componentName2 : lambda$getUserDataUnchecked$2.mAdminMap.keySet()) {
                if (((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminMap.get(componentName2)).specifiesGlobalProxy && !componentName2.equals(componentName)) {
                    return componentName2;
                }
            }
            if (UserHandle.getCallingUserId() != 0) {
                Slogf.w("DevicePolicyManager", "Only the owner is allowed to set the global proxy. User " + UserHandle.getCallingUserId() + " is not permitted.");
                return null;
            }
            if (str == null) {
                activeAdminForCallerLocked.specifiesGlobalProxy = false;
                activeAdminForCallerLocked.globalProxySpec = null;
                activeAdminForCallerLocked.globalProxyExclusionList = null;
            } else {
                activeAdminForCallerLocked.specifiesGlobalProxy = true;
                activeAdminForCallerLocked.globalProxySpec = str;
                activeAdminForCallerLocked.globalProxyExclusionList = str2;
            }
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda168
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setGlobalProxy$62(lambda$getUserDataUnchecked$2);
                }
            });
            return null;
        }
    }

    public ComponentName getGlobalProxyAdmin(int i) {
        if (!this.mHasFeature) {
            return null;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i) && canQueryAdminPolicy(callerIdentity));
        synchronized (getLockObject()) {
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(0);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            for (int i2 = 0; i2 < size; i2++) {
                ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2);
                if (activeAdmin.specifiesGlobalProxy) {
                    return activeAdmin.info.getComponent();
                }
            }
            return null;
        }
    }

    public void setRecommendedGlobalProxy(ComponentName componentName, final ProxyInfo proxyInfo) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(getCallerIdentity(componentName)));
        checkAllUsersAreAffiliatedWithDevice();
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda85
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setRecommendedGlobalProxy$64(proxyInfo);
            }
        });
    }

    public /* synthetic */ void lambda$setRecommendedGlobalProxy$64(ProxyInfo proxyInfo) {
        try {
            IMiscPolicy miscService = this.mInjector.getMiscService();
            if (miscService != null) {
                miscService.clearAllGlobalProxy();
            }
        } catch (RemoteException unused) {
        }
        this.mInjector.getConnectivityManager().setGlobalProxy(proxyInfo);
    }

    /* renamed from: resetGlobalProxyLocked */
    public final void lambda$setGlobalProxy$62(DevicePolicyData devicePolicyData) {
        int size = devicePolicyData.mAdminList.size();
        for (int i = 0; i < size; i++) {
            ActiveAdmin activeAdmin = (ActiveAdmin) devicePolicyData.mAdminList.get(i);
            if (activeAdmin.specifiesGlobalProxy) {
                saveGlobalProxyLocked(activeAdmin.globalProxySpec, activeAdmin.globalProxyExclusionList);
                return;
            }
        }
        saveGlobalProxyLocked(null, null);
    }

    /* JADX WARN: Removed duplicated region for block: B:11:0x0034  */
    /* JADX WARN: Removed duplicated region for block: B:14:0x004f  */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public final void saveGlobalProxyLocked(java.lang.String r5, java.lang.String r6) {
        /*
            r4 = this;
            java.lang.String r0 = ""
            if (r6 != 0) goto L5
            r6 = r0
        L5:
            if (r5 != 0) goto L8
            r5 = r0
        L8:
            java.lang.String r5 = r5.trim()
            java.lang.String r0 = ":"
            java.lang.String[] r5 = r5.split(r0)
            int r0 = r5.length
            r1 = 1
            if (r0 <= r1) goto L1d
            r0 = r5[r1]     // Catch: java.lang.NumberFormatException -> L1d
            int r0 = java.lang.Integer.parseInt(r0)     // Catch: java.lang.NumberFormatException -> L1d
            goto L1f
        L1d:
            r0 = 8080(0x1f90, float:1.1322E-41)
        L1f:
            java.lang.String r6 = r6.trim()
            r1 = 0
            r2 = r5[r1]
            java.util.List r3 = com.android.net.module.util.ProxyUtils.exclusionStringAsList(r6)
            android.net.ProxyInfo r2 = android.net.ProxyInfo.buildDirectProxy(r2, r0, r3)
            boolean r3 = r2.isValid()
            if (r3 != 0) goto L4f
            java.lang.StringBuilder r4 = new java.lang.StringBuilder
            r4.<init>()
            java.lang.String r5 = "Invalid proxy properties, ignoring: "
            r4.append(r5)
            java.lang.String r5 = r2.toString()
            r4.append(r5)
            java.lang.String r4 = r4.toString()
            java.lang.String r5 = "DevicePolicyManager"
            com.android.server.utils.Slogf.e(r5, r4)
            return
        L4f:
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r2 = r4.mInjector
            java.lang.String r3 = "global_http_proxy_host"
            r5 = r5[r1]
            r2.settingsGlobalPutString(r3, r5)
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r5 = r4.mInjector
            java.lang.String r1 = "global_http_proxy_port"
            r5.settingsGlobalPutInt(r1, r0)
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r4 = r4.mInjector
            java.lang.String r5 = "global_http_proxy_exclusion_list"
            r4.settingsGlobalPutString(r5, r6)
            return
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.saveGlobalProxyLocked(java.lang.String, java.lang.String):void");
    }

    public int setStorageEncryption(ComponentName componentName, boolean z) {
        ActiveAdmin activeAdminForCallerLocked;
        if (!this.mHasFeature) {
            return 0;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        int callingUserId = UserHandle.getCallingUserId();
        synchronized (getLockObject()) {
            if (callingUserId != 0) {
                Slogf.w("DevicePolicyManager", "Only owner/system user is allowed to set storage encryption. User " + UserHandle.getCallingUserId() + " is not permitted.");
                return 0;
            }
            if (this.mInjector.binderGetCallingPid() == Process.myPid()) {
                activeAdminForCallerLocked = getActiveAdminForCallerLockedMDM(componentName, 7, callingUserId);
            } else {
                activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 7);
            }
            if (!isEncryptionSupported()) {
                return 0;
            }
            if (activeAdminForCallerLocked.encryptionRequested != z) {
                activeAdminForCallerLocked.encryptionRequested = z;
                saveSettingsLocked(callingUserId);
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(0);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            boolean z2 = false;
            for (int i = 0; i < size; i++) {
                z2 |= ((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i)).encryptionRequested;
            }
            setEncryptionRequested(z2);
            return z2 ? 3 : 1;
        }
    }

    public boolean getStorageEncryption(ComponentName componentName, int i) {
        if (!this.mHasFeature) {
            return false;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i));
        synchronized (getLockObject()) {
            if (callerIdentity.hasAdminComponent()) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.encryptionRequested : false;
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            for (int i2 = 0; i2 < size; i2++) {
                if (((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2)).encryptionRequested) {
                    return true;
                }
            }
            return false;
        }
    }

    public int getStorageEncryptionStatus(String str, int i) {
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(str), i));
        try {
            boolean z = this.mIPackageManager.getApplicationInfo(str, 0L, i).targetSdkVersion <= 23;
            int encryptionStatus = getEncryptionStatus();
            if (encryptionStatus == 5 && z) {
                return 3;
            }
            return encryptionStatus;
        } catch (RemoteException e) {
            throw new SecurityException(e);
        }
    }

    public final boolean isEncryptionSupported() {
        return getEncryptionStatus() != 0;
    }

    public final int getEncryptionStatus() {
        return this.mInjector.storageManagerIsFileBasedEncryptionEnabled() ? 5 : 0;
    }

    public void setScreenCaptureDisabled(ComponentName componentName, String str, boolean z, boolean z2) {
        CallerIdentity callerIdentity;
        if (this.mHasFeature) {
            if (isPolicyEngineForFinanceFlagEnabled()) {
                callerIdentity = getCallerIdentity(componentName, str);
            } else {
                Objects.requireNonNull(componentName, "ComponentName is null");
                callerIdentity = getCallerIdentity(componentName);
                if (z2) {
                    Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
                } else {
                    Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
                }
            }
            if (isPolicyEngineForFinanceFlagEnabled()) {
                int identifier = Binder.getCallingUserHandle().getIdentifier();
                EnforcingAdmin enforcePermissionAndGetEnforcingAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_SCREEN_CAPTURE", callerIdentity.getPackageName(), z2 ? getProfileParentId(identifier) : identifier);
                if ((z2 && isProfileOwnerOfOrganizationOwnedDevice(callerIdentity)) || isDefaultDeviceOwner(callerIdentity)) {
                    if (z) {
                        this.mDevicePolicyEngine.setGlobalPolicy(PolicyDefinition.SCREEN_CAPTURE_DISABLED, enforcePermissionAndGetEnforcingAdmin, new BooleanPolicyValue(z));
                    } else {
                        this.mDevicePolicyEngine.removeGlobalPolicy(PolicyDefinition.SCREEN_CAPTURE_DISABLED, enforcePermissionAndGetEnforcingAdmin);
                    }
                } else if (z) {
                    this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.SCREEN_CAPTURE_DISABLED, enforcePermissionAndGetEnforcingAdmin, new BooleanPolicyValue(z), identifier);
                } else {
                    this.mDevicePolicyEngine.removeLocalPolicy(PolicyDefinition.SCREEN_CAPTURE_DISABLED, enforcePermissionAndGetEnforcingAdmin, identifier);
                }
            } else {
                synchronized (getLockObject()) {
                    ActiveAdmin parentOfAdminIfRequired = getParentOfAdminIfRequired(getProfileOwnerOrDefaultDeviceOwnerLocked(callerIdentity.getUserId()), z2);
                    if (parentOfAdminIfRequired.disableScreenCapture != z) {
                        parentOfAdminIfRequired.disableScreenCapture = z;
                        saveSettingsLocked(callerIdentity.getUserId());
                        pushScreenCapturePolicy(callerIdentity.getUserId());
                    }
                }
            }
            DevicePolicyEventLogger.createEvent(29).setAdmin(callerIdentity.getPackageName()).setBoolean(z).write();
        }
    }

    public final void pushScreenCapturePolicy(int i) {
        ActiveAdmin deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceParentLocked;
        if (SemPersonaManager.isSecureFolderId(i) || SemPersonaManager.isDualAppId(i) || isPolicyEngineForFinanceFlagEnabled()) {
            return;
        }
        if (isHeadlessFlagEnabled()) {
            deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceParentLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceParentLocked(this.mUserManagerInternal.getProfileParentId(i));
        } else {
            deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceParentLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceParentLocked(0);
        }
        if (deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceParentLocked != null && deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceParentLocked.disableScreenCapture) {
            setScreenCaptureDisabled(-1);
            return;
        }
        ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
        if (profileOwnerAdminLocked != null && profileOwnerAdminLocked.disableScreenCapture) {
            setScreenCaptureDisabled(i);
            return;
        }
        ActiveAdmin createOrGetPermissionBasedAdmin = lambda$getUserDataUnchecked$2(i).createOrGetPermissionBasedAdmin(i);
        if (createOrGetPermissionBasedAdmin != null && createOrGetPermissionBasedAdmin.disableScreenCapture) {
            setScreenCaptureDisabled(i);
        } else {
            setScreenCaptureDisabled(-10000);
        }
    }

    public final void setScreenCaptureDisabled(int i) {
        if (i == this.mPolicyCache.getScreenCaptureDisallowedUser()) {
            return;
        }
        this.mPolicyCache.setScreenCaptureDisallowedUser(i);
        updateScreenCaptureDisabled();
    }

    public boolean getScreenCaptureDisabled(ComponentName componentName, int i, boolean z) {
        if (!this.mHasFeature) {
            return false;
        }
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(componentName), i));
        if (z) {
            Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(getCallerIdentity().getUserId()));
        }
        if (isPolicyEngineForFinanceFlagEnabled()) {
            Boolean bool = (Boolean) this.mDevicePolicyEngine.getResolvedPolicy(PolicyDefinition.SCREEN_CAPTURE_DISABLED, i);
            return bool != null && bool.booleanValue();
        }
        return !this.mPolicyCache.isScreenCaptureAllowed(i);
    }

    public final void updateScreenCaptureDisabled() {
        this.mHandler.post(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda176
            @Override // java.lang.Runnable
            public final void run() {
                DevicePolicyManagerService.this.lambda$updateScreenCaptureDisabled$65();
            }
        });
    }

    public /* synthetic */ void lambda$updateScreenCaptureDisabled$65() {
        try {
            this.mInjector.getIWindowManager().refreshScreenCaptureDisabled();
        } catch (RemoteException e) {
            Slogf.w("DevicePolicyManager", "Unable to notify WindowManager.", e);
        }
    }

    public void setNearbyNotificationStreamingPolicy(int i) {
        if (this.mHasFeature) {
            CallerIdentity callerIdentity = getCallerIdentity();
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
            synchronized (getLockObject()) {
                ActiveAdmin profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
                if (profileOwnerOrDeviceOwnerLocked.mNearbyNotificationStreamingPolicy != i) {
                    profileOwnerOrDeviceOwnerLocked.mNearbyNotificationStreamingPolicy = i;
                    saveSettingsLocked(callerIdentity.getUserId());
                }
            }
        }
    }

    public int getNearbyNotificationStreamingPolicy(int i) {
        int i2;
        if (!this.mHasFeature) {
            return 0;
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || hasCallingOrSelfPermission("android.permission.READ_NEARBY_STREAMING_POLICY"));
        Preconditions.checkCallAuthorization(hasCrossUsersPermission(callerIdentity, i));
        synchronized (getLockObject()) {
            ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(i);
            i2 = deviceOrProfileOwnerAdminLocked != null ? deviceOrProfileOwnerAdminLocked.mNearbyNotificationStreamingPolicy : 0;
        }
        return i2;
    }

    public void setNearbyAppStreamingPolicy(int i) {
        if (this.mHasFeature) {
            CallerIdentity callerIdentity = getCallerIdentity();
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
            synchronized (getLockObject()) {
                ActiveAdmin profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
                if (profileOwnerOrDeviceOwnerLocked.mNearbyAppStreamingPolicy != i) {
                    profileOwnerOrDeviceOwnerLocked.mNearbyAppStreamingPolicy = i;
                    saveSettingsLocked(callerIdentity.getUserId());
                }
            }
        }
    }

    public int getNearbyAppStreamingPolicy(int i) {
        int i2;
        if (!this.mHasFeature) {
            return 0;
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || hasCallingOrSelfPermission("android.permission.READ_NEARBY_STREAMING_POLICY"));
        Preconditions.checkCallAuthorization(hasCrossUsersPermission(callerIdentity, i));
        synchronized (getLockObject()) {
            ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(i);
            i2 = deviceOrProfileOwnerAdminLocked != null ? deviceOrProfileOwnerAdminLocked.mNearbyAppStreamingPolicy : 0;
        }
        return i2;
    }

    public void setAutoTimeRequired(ComponentName componentName, boolean z) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            boolean z2 = false;
            Preconditions.checkCallAuthorization(isDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
            synchronized (getLockObject()) {
                Preconditions.checkCallAuthorization(!isManagedProfile(callerIdentity.getUserId()), "Managed profile cannot set auto time required");
                if (isPolicyEngineForFinanceFlagEnabled()) {
                    setGlobalUserRestrictionInternal(getEnforcingAdminForCaller(componentName, componentName.getPackageName()), "no_config_date_time", z);
                } else {
                    ActiveAdmin profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
                    if (profileOwnerOrDeviceOwnerLocked.requireAutoTime != z) {
                        profileOwnerOrDeviceOwnerLocked.requireAutoTime = z;
                        saveSettingsLocked(callerIdentity.getUserId());
                        z2 = true;
                    }
                    if (z2) {
                        pushUserRestrictions(callerIdentity.getUserId());
                    }
                }
            }
            if (z) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda0
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$setAutoTimeRequired$66();
                    }
                });
            }
            DevicePolicyEventLogger.createEvent(36).setAdmin(componentName).setBoolean(z).write();
            makeAuditLogGroupSecurity(String.format(z ? "Admin %s has enabled required automatic time." : "Admin %s has disabled required automatic time.", componentName.getPackageName()), callerIdentity.getUserId());
        }
    }

    public /* synthetic */ void lambda$setAutoTimeRequired$66() {
        this.mInjector.settingsGlobalPutInt("auto_time", 1);
    }

    public boolean getAutoTimeRequired() {
        if (!this.mHasFeature) {
            return false;
        }
        if (isPolicyEngineForFinanceFlagEnabled()) {
            Boolean bool = (Boolean) this.mDevicePolicyEngine.getResolvedPolicy(PolicyDefinition.getPolicyDefinitionForUserRestriction("no_config_date_time"), this.mInjector.binderGetCallingUserHandle().getIdentifier());
            return bool != null && bool.booleanValue();
        }
        synchronized (getLockObject()) {
            ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
            if (deviceOwnerAdminLocked != null && deviceOwnerAdminLocked.requireAutoTime) {
                return true;
            }
            Iterator it = this.mOwners.getProfileOwnerKeys().iterator();
            while (it.hasNext()) {
                ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(((Integer) it.next()).intValue());
                if (profileOwnerAdminLocked != null && profileOwnerAdminLocked.requireAutoTime) {
                    return true;
                }
            }
            return false;
        }
    }

    public void setAutoTimeEnabled(ComponentName componentName, String str, final boolean z) {
        CallerIdentity callerIdentity;
        if (this.mHasFeature) {
            if (isUnicornFlagEnabled()) {
                callerIdentity = getCallerIdentity(componentName, str);
            } else {
                callerIdentity = getCallerIdentity(componentName);
            }
            if (isUnicornFlagEnabled()) {
                enforcePermission("android.permission.SET_TIME", callerIdentity.getPackageName(), -1);
            } else {
                Objects.requireNonNull(componentName, "ComponentName is null");
                Preconditions.checkCallAuthorization(isProfileOwnerOnUser0(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
            }
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda185
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setAutoTimeEnabled$67(z);
                }
            });
            DevicePolicyEventLogger.createEvent(127).setAdmin(callerIdentity.getPackageName()).setBoolean(z).write();
        }
    }

    public /* synthetic */ void lambda$setAutoTimeEnabled$67(boolean z) {
        this.mInjector.settingsGlobalPutInt("auto_time", z ? 1 : 0);
    }

    public boolean getAutoTimeEnabled(ComponentName componentName, String str) {
        CallerIdentity callerIdentity;
        if (!this.mHasFeature) {
            return false;
        }
        if (isUnicornFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        if (isUnicornFlagEnabled()) {
            enforceCanQuery("android.permission.SET_TIME", callerIdentity.getPackageName(), -1);
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isProfileOwnerOnUser0(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        }
        return this.mInjector.settingsGlobalGetInt("auto_time", 0) > 0;
    }

    public void setAutoTimeZoneEnabled(ComponentName componentName, String str, final boolean z) {
        CallerIdentity callerIdentity;
        if (this.mHasFeature) {
            if (isUnicornFlagEnabled()) {
                callerIdentity = getCallerIdentity(componentName, str);
            } else {
                callerIdentity = getCallerIdentity(componentName);
            }
            if (isUnicornFlagEnabled()) {
                this.mDevicePolicyEngine.setGlobalPolicy(PolicyDefinition.AUTO_TIMEZONE, enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.SET_TIME_ZONE", callerIdentity.getPackageName(), -1), new BooleanPolicyValue(z));
            } else {
                Objects.requireNonNull(componentName, "ComponentName is null");
                Preconditions.checkCallAuthorization(isProfileOwnerOnUser0(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda24
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$setAutoTimeZoneEnabled$68(z);
                    }
                });
            }
            DevicePolicyEventLogger.createEvent(128).setAdmin(callerIdentity.getPackageName()).setBoolean(z).write();
        }
    }

    public /* synthetic */ void lambda$setAutoTimeZoneEnabled$68(boolean z) {
        this.mInjector.settingsGlobalPutInt("auto_time_zone", z ? 1 : 0);
    }

    public boolean getAutoTimeZoneEnabled(ComponentName componentName, String str) {
        CallerIdentity callerIdentity;
        if (!this.mHasFeature) {
            return false;
        }
        if (isUnicornFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        if (isUnicornFlagEnabled()) {
            enforceCanQuery("android.permission.SET_TIME_ZONE", callerIdentity.getPackageName(), -1);
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isProfileOwnerOnUser0(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        }
        return this.mInjector.settingsGlobalGetInt("auto_time_zone", 0) > 0;
    }

    public void setForceEphemeralUsers(ComponentName componentName, boolean z) {
        throw new UnsupportedOperationException("This method was used by split system user only.");
    }

    public boolean getForceEphemeralUsers(ComponentName componentName) {
        throw new UnsupportedOperationException("This method was used by split system user only.");
    }

    public boolean requestBugreport(ComponentName componentName) {
        if (!this.mHasFeature) {
            return false;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(getCallerIdentity(componentName)));
        checkAllUsersAreAffiliatedWithDevice();
        checkCanExecuteOrThrowUnsafe(29);
        if (!this.mBugreportCollectionManager.requestBugreport()) {
            return false;
        }
        DevicePolicyEventLogger.createEvent(53).setAdmin(componentName).write();
        long currentTimeMillis = System.currentTimeMillis();
        synchronized (getLockObject()) {
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(0);
            if (currentTimeMillis > lambda$getUserDataUnchecked$2.mLastBugReportRequestTime) {
                lambda$getUserDataUnchecked$2.mLastBugReportRequestTime = currentTimeMillis;
                saveSettingsLocked(0);
            }
        }
        return true;
    }

    public void sendDeviceOwnerCommand(String str, Bundle bundle) {
        int deviceOwnerUserId;
        ComponentName deviceOwnerComponent;
        synchronized (getLockObject()) {
            deviceOwnerUserId = this.mOwners.getDeviceOwnerUserId();
            deviceOwnerComponent = this.mOwners.getDeviceOwnerComponent();
        }
        sendActiveAdminCommand(str, bundle, deviceOwnerUserId, deviceOwnerComponent, false);
    }

    public void sendDeviceOwnerOrProfileOwnerCommand(String str, Bundle bundle, int i) {
        ComponentName componentName;
        boolean z;
        boolean z2 = false;
        int i2 = i == -1 ? 0 : i;
        if (str.equals("android.app.action.NETWORK_LOGS_AVAILABLE")) {
            componentName = resolveDelegateReceiver("delegation-network-logging", str, i2);
            z2 = true;
        } else {
            componentName = null;
        }
        if (str.equals("android.app.action.SECURITY_LOGS_AVAILABLE")) {
            componentName = resolveDelegateReceiver("delegation-security-logging", str, i2);
            z = true;
        } else {
            z = z2;
        }
        if (componentName == null) {
            componentName = getOwnerComponent(i2);
        }
        sendActiveAdminCommand(str, bundle, i2, componentName, z);
    }

    public final void sendProfileOwnerCommand(String str, Bundle bundle, int i) {
        sendActiveAdminCommand(str, bundle, i, this.mOwners.getProfileOwnerComponent(i), false);
    }

    public final void sendActiveAdminCommand(String str, Bundle bundle, int i, ComponentName componentName, boolean z) {
        Intent intent = new Intent(str);
        intent.setComponent(componentName);
        if (bundle != null) {
            intent.putExtras(bundle);
        }
        if (z) {
            intent.addFlags(268435456);
        }
        this.mContext.sendBroadcastAsUser(intent, UserHandle.of(i));
    }

    public final void sendOwnerChangedBroadcast(String str, int i) {
        this.mContext.sendBroadcastAsUser(new Intent(str).addFlags(16777216), UserHandle.of(i));
    }

    public void sendBugreportToDeviceOwner(Uri uri, String str) {
        synchronized (getLockObject()) {
            Intent intent = new Intent("android.app.action.BUGREPORT_SHARE");
            intent.setComponent(this.mOwners.getDeviceOwnerComponent());
            intent.setDataAndType(uri, "application/vnd.android.bugreport");
            intent.putExtra("android.app.extra.BUGREPORT_HASH", str);
            intent.setFlags(1);
            UriGrantsManagerInternal uriGrantsManagerInternal = (UriGrantsManagerInternal) LocalServices.getService(UriGrantsManagerInternal.class);
            uriGrantsManagerInternal.grantUriPermissionUncheckedFromIntent(uriGrantsManagerInternal.checkGrantUriPermissionFromIntent(intent, 2000, this.mOwners.getDeviceOwnerComponent().getPackageName(), this.mOwners.getDeviceOwnerUserId()), null);
            this.mContext.sendBroadcastAsUser(intent, UserHandle.of(this.mOwners.getDeviceOwnerUserId()));
        }
    }

    public void setDeviceOwnerRemoteBugreportUriAndHash(String str, String str2) {
        synchronized (getLockObject()) {
            this.mOwners.setDeviceOwnerRemoteBugreportUriAndHash(str, str2);
        }
    }

    public Pair getDeviceOwnerRemoteBugreportUriAndHash() {
        Pair pair;
        synchronized (getLockObject()) {
            String deviceOwnerRemoteBugreportUri = this.mOwners.getDeviceOwnerRemoteBugreportUri();
            pair = deviceOwnerRemoteBugreportUri == null ? null : new Pair(deviceOwnerRemoteBugreportUri, this.mOwners.getDeviceOwnerRemoteBugreportHash());
        }
        return pair;
    }

    public void setCameraDisabled(ComponentName componentName, String str, boolean z, boolean z2) {
        CallerIdentity callerIdentity;
        if (this.mHasFeature) {
            if (isPolicyEngineForFinanceFlagEnabled()) {
                callerIdentity = getCallerIdentity(componentName, str);
            } else {
                callerIdentity = getCallerIdentity(componentName);
            }
            int userId = callerIdentity.getUserId();
            checkCanExecuteOrThrowUnsafe(31);
            if (isPolicyEngineForFinanceFlagEnabled()) {
                try {
                    setBackwardCompatibleUserRestriction(callerIdentity, enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_CAMERA", callerIdentity.getPackageName(), getProfileParentUserIfRequested(userId, z2)), "no_camera", z, z2);
                } catch (IllegalStateException unused) {
                    throw new IllegalStateException("Please use addUserRestriction or addUserRestrictionGlobally using the key UserManager.DISALLOW_CAMERA to disable the camera locally or globally, respectively");
                }
            } else {
                Objects.requireNonNull(componentName, "ComponentName is null");
                if (z2) {
                    Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
                }
                synchronized (getLockObject()) {
                    ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 8, z2);
                    if (activeAdminForCallerLocked.disableCamera != z) {
                        activeAdminForCallerLocked.disableCamera = z;
                        saveSettingsLocked(userId);
                    }
                }
                pushUserRestrictions(userId);
            }
            int profileParentId = z2 ? getProfileParentId(userId) : userId;
            if (SecurityLog.isLoggingEnabled() && componentName != null) {
                SecurityLog.writeEvent(210034, new Object[]{componentName.getPackageName(), Integer.valueOf(userId), Integer.valueOf(profileParentId), Integer.valueOf(z ? 1 : 0)});
            }
            DevicePolicyEventLogger devicePolicyEventLogger = DevicePolicyEventLogger.createEvent(30).setAdmin(callerIdentity.getPackageName()).setBoolean(z);
            String[] strArr = new String[1];
            strArr[0] = z2 ? "calledFromParent" : "notCalledFromParent";
            devicePolicyEventLogger.setStrings(strArr).write();
        }
    }

    public boolean getCameraDisabled(ComponentName componentName, String str, int i, boolean z) {
        CallerIdentity callerIdentity;
        Boolean bool;
        boolean z2 = false;
        if (!this.mHasFeature) {
            return false;
        }
        if (isPolicyEngineForFinanceFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        if (isPolicyEngineForFinanceFlagEnabled()) {
            Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i) || isCameraServerUid(callerIdentity) || hasPermission("android.permission.MANAGE_DEVICE_POLICY_CAMERA", callerIdentity.getPackageName(), i) || hasPermission("android.permission.QUERY_ADMIN_POLICY", callerIdentity.getPackageName()));
        } else {
            Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i) || isCameraServerUid(callerIdentity));
            if (z) {
                Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity.getUserId()));
            }
        }
        int profileParentId = z ? getProfileParentId(i) : i;
        if (isPolicyEngineForFinanceFlagEnabled()) {
            PolicyDefinition policyDefinitionForUserRestriction = PolicyDefinition.getPolicyDefinitionForUserRestriction("no_camera");
            if (componentName != null) {
                EnforcingAdmin enforcingAdminForCaller = getEnforcingAdminForCaller(componentName, str);
                if (isDeviceOwner(callerIdentity)) {
                    bool = (Boolean) this.mDevicePolicyEngine.getGlobalPolicySetByAdmin(policyDefinitionForUserRestriction, enforcingAdminForCaller);
                } else {
                    bool = (Boolean) this.mDevicePolicyEngine.getLocalPolicySetByAdmin(policyDefinitionForUserRestriction, enforcingAdminForCaller, profileParentId);
                }
                return Boolean.TRUE.equals(bool);
            }
            return Boolean.TRUE.equals(this.mDevicePolicyEngine.getResolvedPolicy(policyDefinitionForUserRestriction, profileParentId));
        }
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i, z);
                if (activeAdminUncheckedLocked != null && activeAdminUncheckedLocked.disableCamera) {
                    z2 = true;
                }
                return z2;
            }
            ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
            if (deviceOwnerAdminLocked != null && deviceOwnerAdminLocked.disableCamera) {
                return true;
            }
            Iterator it = getActiveAdminsForAffectedUserLocked(profileParentId).iterator();
            while (it.hasNext()) {
                if (((ActiveAdmin) it.next()).disableCamera) {
                    return true;
                }
            }
            return false;
        }
    }

    public void setKeyguardDisabledFeatures(ComponentName componentName, String str, int i, boolean z) {
        CallerIdentity callerIdentity;
        if (this.mHasFeature) {
            if (isUnicornFlagEnabled()) {
                callerIdentity = getCallerIdentity(componentName, str);
            } else {
                callerIdentity = getCallerIdentity(componentName);
                Objects.requireNonNull(componentName, "ComponentName is null");
            }
            int userId = callerIdentity.getUserId();
            int profileParentId = z ? getProfileParentId(userId) : userId;
            synchronized (getLockObject()) {
                if (isUnicornFlagEnabled()) {
                    EnforcingAdmin enforcePermissionAndGetEnforcingAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_KEYGUARD", callerIdentity.getPackageName(), profileParentId);
                    if (i == 0) {
                        this.mDevicePolicyEngine.removeLocalPolicy(PolicyDefinition.KEYGUARD_DISABLED_FEATURES, enforcePermissionAndGetEnforcingAdmin, profileParentId);
                    } else {
                        if (isManagedProfile(userId)) {
                            if (z) {
                                i = isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) ? i & 950 : i & FrameworkStatsLog.HOTWORD_DETECTION_SERVICE_RESTARTED;
                            } else {
                                i &= 440;
                            }
                        }
                        this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.KEYGUARD_DISABLED_FEATURES, enforcePermissionAndGetEnforcingAdmin, new IntegerPolicyValue(i), profileParentId);
                    }
                    invalidateBinderCaches();
                } else {
                    ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 9, z);
                    if (isManagedProfile(userId)) {
                        if (z) {
                            i = isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) ? i & 950 : i & FrameworkStatsLog.HOTWORD_DETECTION_SERVICE_RESTARTED;
                        } else {
                            i &= 440;
                        }
                    }
                    if (activeAdminForCallerLocked.disabledKeyguardFeatures != i) {
                        activeAdminForCallerLocked.disabledKeyguardFeatures = i;
                        saveSettingsLocked(userId);
                    }
                }
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210021, new Object[]{callerIdentity.getPackageName(), Integer.valueOf(userId), Integer.valueOf(profileParentId), Integer.valueOf(i)});
            }
            DevicePolicyEventLogger devicePolicyEventLogger = DevicePolicyEventLogger.createEvent(9).setAdmin(callerIdentity.getPackageName()).setInt(i);
            String[] strArr = new String[1];
            strArr[0] = z ? "calledFromParent" : "notCalledFromParent";
            devicePolicyEventLogger.setStrings(strArr).write();
        }
    }

    /* JADX WARN: Removed duplicated region for block: B:42:0x00b4 A[Catch: all -> 0x00e4, TryCatch #0 {all -> 0x00e4, blocks: (B:65:0x0097, B:67:0x009d, B:40:0x00ac, B:42:0x00b4, B:47:0x00cb, B:50:0x00d2, B:53:0x00d7, B:39:0x00a4), top: B:64:0x0097, outer: #1 }] */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public int getKeyguardDisabledFeatures(android.content.ComponentName r12, int r13, boolean r14) {
        /*
            Method dump skipped, instructions count: 238
            To view this dump change 'Code comments level' option to 'DEBUG'
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.getKeyguardDisabledFeatures(android.content.ComponentName, int, boolean):int");
    }

    public /* synthetic */ Integer lambda$getKeyguardDisabledFeatures$69(Integer num, int i) {
        Integer num2;
        int intValue = num == null ? 0 : num.intValue();
        Iterator it = this.mUserManager.getProfiles(i).iterator();
        while (it.hasNext()) {
            int i2 = ((UserInfo) it.next()).id;
            if (i2 != i && (num2 = (Integer) this.mDevicePolicyEngine.getResolvedPolicy(PolicyDefinition.KEYGUARD_DISABLED_FEATURES, i2)) != null) {
                intValue |= num2.intValue() & 950;
            }
        }
        return Integer.valueOf(intValue);
    }

    public void setKeepUninstalledPackages(ComponentName componentName, String str, List list) {
        if (this.mHasFeature) {
            Objects.requireNonNull(list, "packageList is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
            Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && isDefaultDeviceOwner(callerIdentity)) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-keep-uninstalled-packages")));
            checkCanExecuteOrThrowUnsafe(17);
            synchronized (getLockObject()) {
                getDeviceOwnerAdminLocked().keepUninstalledPackages = list;
                saveSettingsLocked(callerIdentity.getUserId());
                this.mInjector.getPackageManagerInternal().setKeepUninstalledPackages(list);
            }
            DevicePolicyEventLogger.createEvent(61).setAdmin(callerIdentity.getPackageName()).setBoolean(componentName == null).setStrings((String[]) list.toArray(new String[0])).write();
        }
    }

    public List getKeepUninstalledPackages(ComponentName componentName, String str) {
        List keepUninstalledPackagesLocked;
        if (!this.mHasFeature) {
            return null;
        }
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && isDefaultDeviceOwner(callerIdentity)) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-keep-uninstalled-packages")));
        synchronized (getLockObject()) {
            keepUninstalledPackagesLocked = getKeepUninstalledPackagesLocked();
        }
        return keepUninstalledPackagesLocked;
    }

    public final List getKeepUninstalledPackagesLocked() {
        ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
        if (deviceOwnerAdminLocked != null) {
            return deviceOwnerAdminLocked.keepUninstalledPackages;
        }
        return null;
    }

    public final void logMissingFeatureAction(String str) {
        Slogf.w("DevicePolicyManager", str + " because device does not have the android.software.device_admin feature.");
    }

    public boolean setDeviceOwner(final ComponentName componentName, final int i, boolean z) {
        int currentForegroundUserId;
        if (!this.mHasFeature) {
            logMissingFeatureAction("Cannot set " + ComponentName.flattenToShortString(componentName) + " as device owner for user " + i);
            return false;
        }
        Preconditions.checkArgument(componentName != null);
        if (!this.mInjector.verifyDeviceIntegrity()) {
            Log.e("DevicePolicyManager", "Failed in device integrity check");
            return false;
        }
        if (!this.mInjector.isDeviceRootKeyInstalled()) {
            Log.e("DevicePolicyManager", "Failed in (DRK)Device Root Key check");
            return false;
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        boolean z2 = !isAdb(callerIdentity) || hasIncompatibleAccountsOnAnyUser();
        if (!z2) {
            synchronized (getLockObject()) {
                if (!isAdminTestOnlyLocked(componentName, i) && hasAccountsOnAnyUser()) {
                    Slogf.w("DevicePolicyManager", "Non test-only owner can't be installed with existing accounts.");
                    return false;
                }
            }
        }
        synchronized (getLockObject()) {
            enforceCanSetDeviceOwnerLocked(callerIdentity, componentName, i, z2);
            Preconditions.checkArgument(isPackageInstalledForUser(componentName.getPackageName(), i), "Invalid component " + componentName + " for device owner");
            ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
            Preconditions.checkArgument((activeAdminUncheckedLocked == null || lambda$getUserDataUnchecked$2(i).mRemovingAdmins.contains(componentName)) ? false : true, "Not active admin: " + componentName);
            toggleBackupServiceActive(0, false);
            if (isAdb(callerIdentity)) {
                MetricsLogger.action(this.mContext, 617, "device-owner");
                DevicePolicyEventLogger.createEvent(82).setAdmin(componentName).setStrings(new String[]{"device-owner"}).write();
            }
            this.mOwners.setDeviceOwner(componentName, i);
            this.mOwners.writeDeviceOwner();
            setDeviceOwnershipSystemPropertyLocked();
            this.mInjector.notifyDeviceOwnerChanged();
            if (isAdb(callerIdentity)) {
                activeAdminUncheckedLocked.mAdminCanGrantSensorsPermissions = true;
                this.mPolicyCache.setAdminCanGrantSensorsPermissions(true);
                saveSettingsLocked(i);
            }
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda163
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setDeviceOwner$70(i, componentName);
                }
            });
            this.mDeviceAdminServiceController.startServiceForAdmin(componentName.getPackageName(), i, "set-device-owner");
            Slogf.i("DevicePolicyManager", "Device owner set: " + componentName + " on user " + i);
        }
        if (z && this.mInjector.userManagerIsHeadlessSystemUserMode()) {
            synchronized (getLockObject()) {
                currentForegroundUserId = getCurrentForegroundUserId();
            }
            Slogf.i("DevicePolicyManager", "setDeviceOwner(): setting " + componentName + " as profile owner on user " + currentForegroundUserId);
            manageUserUnchecked(componentName, componentName, currentForegroundUserId, null, false);
        }
        return true;
    }

    public /* synthetic */ void lambda$setDeviceOwner$70(int i, ComponentName componentName) {
        if (isHeadlessFlagEnabled()) {
            for (int i2 : this.mUserManagerInternal.getUserIds()) {
                this.mUserManager.setUserRestriction("no_add_managed_profile", true, UserHandle.of(i2));
                this.mUserManager.setUserRestriction("no_add_clone_profile", true, UserHandle.of(i2));
            }
        } else {
            this.mUserManager.setUserRestriction("no_add_managed_profile", true, UserHandle.of(i));
            this.mUserManager.setUserRestriction("no_add_clone_profile", true, UserHandle.of(i));
        }
        sendOwnerChangedBroadcastWithExtra(DevicePolicyListener.ACTION_DEVICE_OWNER_CHANGED, i, componentName.getPackageName(), true);
    }

    public boolean hasDeviceOwner() {
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || canManageUsers(callerIdentity) || isFinancedDeviceOwner(callerIdentity) || hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        return this.mOwners.hasDeviceOwner();
    }

    public boolean isDeviceOwner(ActiveAdmin activeAdmin) {
        return isDeviceOwner(activeAdmin.info.getComponent(), activeAdmin.getUserHandle().getIdentifier());
    }

    public boolean isDeviceOwner(ComponentName componentName, int i) {
        boolean z;
        synchronized (getLockObject()) {
            z = this.mOwners.hasDeviceOwner() && this.mOwners.getDeviceOwnerUserId() == i && this.mOwners.getDeviceOwnerComponent().equals(componentName);
        }
        return z;
    }

    public final boolean isDefaultDeviceOwner(CallerIdentity callerIdentity) {
        boolean z;
        synchronized (getLockObject()) {
            z = isDeviceOwnerLocked(callerIdentity) && getDeviceOwnerTypeLocked(this.mOwners.getDeviceOwnerPackageName()) == 0;
        }
        return z;
    }

    public boolean isDeviceOwner(CallerIdentity callerIdentity) {
        boolean isDeviceOwnerLocked;
        synchronized (getLockObject()) {
            isDeviceOwnerLocked = isDeviceOwnerLocked(callerIdentity);
        }
        return isDeviceOwnerLocked;
    }

    public final boolean isDeviceOwnerLocked(CallerIdentity callerIdentity) {
        if (!this.mOwners.hasDeviceOwner() || this.mOwners.getDeviceOwnerUserId() != callerIdentity.getUserId()) {
            return false;
        }
        if (callerIdentity.hasAdminComponent()) {
            return this.mOwners.getDeviceOwnerComponent().equals(callerIdentity.getComponentName());
        }
        return isUidDeviceOwnerLocked(callerIdentity.getUid());
    }

    public final boolean isDeviceOwnerUserId(int i) {
        boolean z;
        synchronized (getLockObject()) {
            z = this.mOwners.getDeviceOwnerComponent() != null && this.mOwners.getDeviceOwnerUserId() == i;
        }
        return z;
    }

    public boolean isProfileOwner(ComponentName componentName, final int i) {
        return componentName != null && componentName.equals((ComponentName) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda171
            public final Object getOrThrow() {
                ComponentName lambda$isProfileOwner$71;
                lambda$isProfileOwner$71 = DevicePolicyManagerService.this.lambda$isProfileOwner$71(i);
                return lambda$isProfileOwner$71;
            }
        }));
    }

    public boolean isProfileOwner(final CallerIdentity callerIdentity) {
        synchronized (getLockObject()) {
            ComponentName componentName = (ComponentName) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda61
                public final Object getOrThrow() {
                    ComponentName lambda$isProfileOwner$72;
                    lambda$isProfileOwner$72 = DevicePolicyManagerService.this.lambda$isProfileOwner$72(callerIdentity);
                    return lambda$isProfileOwner$72;
                }
            });
            if (componentName == null) {
                return false;
            }
            if (callerIdentity.hasAdminComponent()) {
                return componentName.equals(callerIdentity.getComponentName());
            }
            return isUidProfileOwnerLocked(callerIdentity.getUid());
        }
    }

    public /* synthetic */ ComponentName lambda$isProfileOwner$72(CallerIdentity callerIdentity) {
        return lambda$isProfileOwner$71(callerIdentity.getUserId());
    }

    public final boolean isUidProfileOwnerLocked(int i) {
        ensureLocked();
        int userId = UserHandle.getUserId(i);
        ComponentName profileOwnerComponent = this.mOwners.getProfileOwnerComponent(userId);
        if (profileOwnerComponent == null) {
            return false;
        }
        Iterator it = lambda$getUserDataUnchecked$2(userId).mAdminList.iterator();
        while (it.hasNext()) {
            ActiveAdmin activeAdmin = (ActiveAdmin) it.next();
            ComponentName component = activeAdmin.info.getComponent();
            if (activeAdmin.getUid() == i && profileOwnerComponent.equals(component)) {
                return true;
            }
        }
        return false;
    }

    public final boolean hasProfileOwner(int i) {
        boolean hasProfileOwner;
        synchronized (getLockObject()) {
            hasProfileOwner = this.mOwners.hasProfileOwner(i);
        }
        return hasProfileOwner;
    }

    public final boolean isProfileOwnerOfOrganizationOwnedDevice(CallerIdentity callerIdentity) {
        return isProfileOwner(callerIdentity) && isProfileOwnerOfOrganizationOwnedDevice(callerIdentity.getUserId());
    }

    public final boolean isProfileOwnerOfOrganizationOwnedDevice(int i) {
        boolean isProfileOwnerOfOrganizationOwnedDevice;
        synchronized (getLockObject()) {
            isProfileOwnerOfOrganizationOwnedDevice = this.mOwners.isProfileOwnerOfOrganizationOwnedDevice(i);
        }
        return isProfileOwnerOfOrganizationOwnedDevice;
    }

    public final boolean isProfileOwnerOfOrganizationOwnedDevice(ComponentName componentName, int i) {
        return isProfileOwner(componentName, i) && isProfileOwnerOfOrganizationOwnedDevice(i);
    }

    public final boolean isProfileOwnerOnUser0(CallerIdentity callerIdentity) {
        return isProfileOwner(callerIdentity) && callerIdentity.getUserHandle().isSystem();
    }

    public final boolean isPackage(CallerIdentity callerIdentity, String str) {
        return isCallingFromPackage(str, callerIdentity.getUid());
    }

    public ComponentName getDeviceOwnerComponent(boolean z) {
        if (!this.mHasFeature) {
            return null;
        }
        if (!z) {
            Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        }
        synchronized (getLockObject()) {
            if (!this.mOwners.hasDeviceOwner()) {
                return null;
            }
            if (!z || this.mInjector.userHandleGetCallingUserId() == this.mOwners.getDeviceOwnerUserId()) {
                return this.mOwners.getDeviceOwnerComponent();
            }
            return null;
        }
    }

    public final int getDeviceOwnerUserIdUncheckedLocked() {
        if (this.mOwners.hasDeviceOwner()) {
            return this.mOwners.getDeviceOwnerUserId();
        }
        return -10000;
    }

    public int getDeviceOwnerUserId() {
        int deviceOwnerUserIdUncheckedLocked;
        if (!this.mHasFeature) {
            return -10000;
        }
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()));
        synchronized (getLockObject()) {
            deviceOwnerUserIdUncheckedLocked = getDeviceOwnerUserIdUncheckedLocked();
        }
        return deviceOwnerUserIdUncheckedLocked;
    }

    public final int getMainUserId() {
        int mainUserId = this.mUserManagerInternal.getMainUserId();
        if (mainUserId != -10000) {
            return mainUserId;
        }
        Slogf.d("DevicePolicyManager", "getMainUserId(): no main user, returning USER_SYSTEM");
        return 0;
    }

    public String getDeviceOwnerName() {
        if (!this.mHasFeature) {
            return null;
        }
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        synchronized (getLockObject()) {
            if (this.mOwners.hasDeviceOwner()) {
                return getApplicationLabel(this.mOwners.getDeviceOwnerPackageName(), 0);
            }
            return null;
        }
    }

    public ActiveAdmin getDeviceOwnerAdminLocked() {
        ensureLocked();
        ComponentName deviceOwnerComponent = this.mOwners.getDeviceOwnerComponent();
        if (deviceOwnerComponent == null) {
            return null;
        }
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(this.mOwners.getDeviceOwnerUserId());
        int size = lambda$getUserDataUnchecked$2.mAdminList.size();
        for (int i = 0; i < size; i++) {
            ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i);
            if (deviceOwnerComponent.equals(activeAdmin.info.getComponent())) {
                return activeAdmin;
            }
        }
        Slogf.wtf("DevicePolicyManager", "Active admin for device owner not found. component=" + deviceOwnerComponent);
        return null;
    }

    public ActiveAdmin getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked(int i) {
        ensureLocked();
        ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
        return deviceOwnerAdminLocked == null ? getProfileOwnerOfOrganizationOwnedDeviceLocked(i) : deviceOwnerAdminLocked;
    }

    public ActiveAdmin getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked() {
        ensureLocked();
        ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
        return deviceOwnerAdminLocked == null ? getProfileOwnerOfOrganizationOwnedDeviceLocked() : deviceOwnerAdminLocked;
    }

    public ActiveAdmin getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceOrSystemPermissionBasedAdminLocked() {
        ensureLocked();
        ActiveAdmin deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked();
        return (isPermissionCheckFlagEnabled() && deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked == null) ? lambda$getUserDataUnchecked$2(0).mPermissionBasedAdmin : deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked;
    }

    public ActiveAdmin getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceParentLocked(int i) {
        ensureLocked();
        ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
        if (deviceOwnerAdminLocked != null) {
            return deviceOwnerAdminLocked;
        }
        ActiveAdmin profileOwnerOfOrganizationOwnedDeviceLocked = getProfileOwnerOfOrganizationOwnedDeviceLocked(i);
        if (profileOwnerOfOrganizationOwnedDeviceLocked != null) {
            return profileOwnerOfOrganizationOwnedDeviceLocked.getParentActiveAdmin();
        }
        return null;
    }

    public void clearDeviceOwner(String str) {
        Objects.requireNonNull(str, "packageName is null");
        CallerIdentity callerIdentity = getCallerIdentity(str);
        synchronized (getLockObject()) {
            final ComponentName deviceOwnerComponent = this.mOwners.getDeviceOwnerComponent();
            final int deviceOwnerUserId = this.mOwners.getDeviceOwnerUserId();
            if (!this.mOwners.hasDeviceOwner() || !deviceOwnerComponent.getPackageName().equals(str) || deviceOwnerUserId != callerIdentity.getUserId()) {
                throw new SecurityException("clearDeviceOwner can only be called by the device owner");
            }
            enforceUserUnlocked(deviceOwnerUserId);
            final ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda169
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$clearDeviceOwner$73(deviceOwnerAdminLocked, deviceOwnerUserId, deviceOwnerComponent);
                }
            });
            Slogf.i("DevicePolicyManager", "Device owner removed: " + deviceOwnerComponent);
        }
    }

    public /* synthetic */ void lambda$clearDeviceOwner$73(ActiveAdmin activeAdmin, int i, ComponentName componentName) {
        clearDeviceOwnerLocked(activeAdmin, i);
        lambda$removeActiveAdmin$13(componentName, i);
        sendOwnerChangedBroadcastWithExtra(DevicePolicyListener.ACTION_DEVICE_OWNER_CHANGED, i, activeAdmin.info.getPackageName(), false);
    }

    public final void sendOwnerChangedBroadcastWithExtra(String str, int i, String str2, boolean z) {
        Intent addFlags = new Intent(str).addFlags(16777216);
        addFlags.putExtra(DevicePolicyListener.EXTRA_DO_PO_PACKAGE_NAME, str2);
        addFlags.putExtra(DevicePolicyListener.EXTRA_DO_CHANGED_STATUS, z);
        this.mContext.sendBroadcastAsUser(addFlags, UserHandle.of(i));
    }

    public final void clearOverrideApnUnchecked() {
        if (this.mHasTelephonyFeature || this.mHasTelephonyDataFeature) {
            setOverrideApnsEnabledUnchecked(false);
            List overrideApnsUnchecked = getOverrideApnsUnchecked();
            for (int i = 0; i < overrideApnsUnchecked.size(); i++) {
                removeOverrideApnUnchecked(((ApnSetting) overrideApnsUnchecked.get(i)).getId());
            }
        }
    }

    public final void clearManagedProfileApnUnchecked() {
        if (this.mHasTelephonyFeature || this.mHasTelephonyDataFeature) {
            if (!((SystemServiceManager) LocalServices.getService(SystemServiceManager.class)).isBootCompleted()) {
                Slogf.i("DevicePolicyManager", "Skip clearing managed profile Apn before boot completed");
                return;
            }
            for (ApnSetting apnSetting : getOverrideApnsUnchecked()) {
                if (apnSetting.getApnTypeBitmask() == 16384) {
                    removeOverrideApnUnchecked(apnSetting.getId());
                }
            }
        }
    }

    public final void clearDeviceOwnerLocked(ActiveAdmin activeAdmin, int i) {
        String deviceOwnerPackageName = this.mOwners.getDeviceOwnerPackageName();
        if (deviceOwnerPackageName != null) {
            this.mDeviceAdminServiceController.stopServiceForAdmin(deviceOwnerPackageName, i, "clear-device-owner");
        }
        if (activeAdmin != null) {
            activeAdmin.disableCamera = false;
            activeAdmin.userRestrictions = null;
            activeAdmin.defaultEnabledRestrictionsAlreadySet.clear();
            activeAdmin.forceEphemeralUsers = false;
            activeAdmin.isNetworkLoggingEnabled = false;
            activeAdmin.requireAutoTime = false;
            this.mUserManagerInternal.setForceEphemeralUsers(false);
        }
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
        lambda$getUserDataUnchecked$2.mCurrentInputMethodSet = false;
        long j = lambda$getUserDataUnchecked$2.mPasswordTokenHandle;
        if (j != 0) {
            this.mLockPatternUtils.removeEscrowToken(j, i);
            lambda$getUserDataUnchecked$2.mPasswordTokenHandle = 0L;
        }
        saveSettingsLocked(i);
        this.mPolicyCache.onUserRemoved(i);
        DevicePolicyData lambda$getUserDataUnchecked$22 = lambda$getUserDataUnchecked$2(0);
        lambda$getUserDataUnchecked$22.mLastSecurityLogRetrievalTime = -1L;
        lambda$getUserDataUnchecked$22.mLastBugReportRequestTime = -1L;
        lambda$getUserDataUnchecked$22.mLastNetworkLogsRetrievalTime = -1L;
        saveSettingsLocked(0);
        clearUserPoliciesLocked(i);
        clearOverrideApnUnchecked();
        clearApplicationRestrictions(i);
        if (!isPolicyEngineForFinanceFlagEnabled()) {
            this.mInjector.getPackageManagerInternal().clearBlockUninstallForUser(i);
        }
        this.mOwners.clearDeviceOwner();
        this.mOwners.writeDeviceOwner();
        updateAdminCanGrantSensorsPermissionCache(i);
        clearDeviceOwnerUserRestriction(UserHandle.of(i));
        this.mInjector.securityLogSetLoggingEnabledProperty(false);
        this.mSecurityLogMonitor.stop();
        setNetworkLoggingActiveInternal(false);
        deleteTransferOwnershipBundleLocked(i);
        toggleBackupServiceActive(0, true);
        if (!isPolicyEngineForFinanceFlagEnabled()) {
            pushUserControlDisabledPackagesLocked(i);
        }
        setGlobalSettingDeviceOwnerType(0);
        if (isPolicyEngineForFinanceFlagEnabled() || isPermissionCheckFlagEnabled()) {
            this.mDevicePolicyEngine.removePoliciesForAdmin(EnforcingAdmin.createEnterpriseEnforcingAdmin(activeAdmin.info.getComponent(), i, activeAdmin));
        }
        this.mInjector.notifyDeviceOwnerChanged();
    }

    public final void clearApplicationRestrictions(final int i) {
        this.mBackgroundHandler.post(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda146
            @Override // java.lang.Runnable
            public final void run() {
                DevicePolicyManagerService.this.lambda$clearApplicationRestrictions$74(i);
            }
        });
    }

    public /* synthetic */ void lambda$clearApplicationRestrictions$74(int i) {
        List<PackageInfo> installedPackages = this.mInjector.getPackageManager(i).getInstalledPackages(786432);
        UserHandle of = UserHandle.of(i);
        Iterator<PackageInfo> it = installedPackages.iterator();
        while (it.hasNext()) {
            this.mInjector.getUserManager().setApplicationRestrictions(it.next().packageName, null, of);
        }
    }

    public boolean setProfileOwner(ComponentName componentName, final int i) {
        if (!this.mHasFeature) {
            logMissingFeatureAction("Cannot set " + ComponentName.flattenToShortString(componentName) + " as profile owner for user " + i);
            return false;
        }
        Preconditions.checkArgument(componentName != null);
        CallerIdentity callerIdentity = getCallerIdentity();
        boolean hasIncompatibleAccountsOrNonAdbNoLock = hasIncompatibleAccountsOrNonAdbNoLock(callerIdentity, i, componentName);
        synchronized (getLockObject()) {
            enforceCanSetProfileOwnerLocked(callerIdentity, componentName, i, hasIncompatibleAccountsOrNonAdbNoLock);
            final ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
            Preconditions.checkArgument((!isPackageInstalledForUser(componentName.getPackageName(), i) || activeAdminUncheckedLocked == null || lambda$getUserDataUnchecked$2(i).mRemovingAdmins.contains(componentName)) ? false : true, "Not active admin: " + componentName);
            int profileParentId = getProfileParentId(i);
            if (profileParentId != i && this.mUserManager.hasUserRestriction("no_add_managed_profile", UserHandle.of(profileParentId)) && !getUserInfo(i).isUserTypeAppSeparation()) {
                Slogf.i("DevicePolicyManager", "Cannot set profile owner because of restriction.");
                return false;
            }
            if (isAdb(callerIdentity)) {
                MetricsLogger.action(this.mContext, 617, "profile-owner");
                DevicePolicyEventLogger.createEvent(82).setAdmin(componentName).setStrings(new String[]{"profile-owner"}).write();
            }
            toggleBackupServiceActive(i, false);
            this.mOwners.setProfileOwner(componentName, i);
            this.mOwners.writeProfileOwner(i);
            Slogf.i("DevicePolicyManager", "Profile owner set: " + componentName + " on user " + i);
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda200
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setProfileOwner$75(i, activeAdminUncheckedLocked);
                }
            });
            this.mDeviceAdminServiceController.startServiceForAdmin(componentName.getPackageName(), i, "set-profile-owner");
            return true;
        }
    }

    public /* synthetic */ void lambda$setProfileOwner$75(int i, ActiveAdmin activeAdmin) {
        if (this.mUserManager.isManagedProfile(i)) {
            maybeSetDefaultRestrictionsForAdminLocked(i, activeAdmin);
            ensureUnknownSourcesRestrictionForProfileOwnerLocked(i, activeAdmin, true);
        }
        sendOwnerChangedBroadcast("android.app.action.PROFILE_OWNER_CHANGED", i);
    }

    public final void toggleBackupServiceActive(int i, boolean z) {
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            try {
                if (this.mInjector.getIBackupManager() != null) {
                    this.mInjector.getIBackupManager().setBackupServiceActive(i, z);
                }
            } catch (RemoteException e) {
                Object[] objArr = new Object[1];
                objArr[0] = z ? "activating" : "deactivating";
                throw new IllegalStateException(String.format("Failed %s backup service.", objArr), e);
            }
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public void clearProfileOwner(final ComponentName componentName) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            final int userId = callerIdentity.getUserId();
            Preconditions.checkCallingUser(!isManagedProfile(userId));
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
            enforceUserUnlocked(userId);
            synchronized (getLockObject()) {
                final ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda71
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$clearProfileOwner$76(profileOwnerLocked, userId, componentName);
                    }
                });
                Slogf.i("DevicePolicyManager", "Profile owner " + componentName + " removed from user " + userId);
            }
        }
    }

    public /* synthetic */ void lambda$clearProfileOwner$76(ActiveAdmin activeAdmin, int i, ComponentName componentName) {
        clearProfileOwnerLocked(activeAdmin, i);
        lambda$removeActiveAdmin$13(componentName, i);
        sendOwnerChangedBroadcast("android.app.action.PROFILE_OWNER_CHANGED", i);
    }

    public void clearProfileOwnerLocked(ActiveAdmin activeAdmin, int i) {
        String profileOwnerPackage = this.mOwners.getProfileOwnerPackage(i);
        if (profileOwnerPackage != null) {
            this.mDeviceAdminServiceController.stopServiceForAdmin(profileOwnerPackage, i, "clear-profile-owner");
        }
        if (activeAdmin != null) {
            activeAdmin.disableCamera = false;
            activeAdmin.userRestrictions = null;
            activeAdmin.defaultEnabledRestrictionsAlreadySet.clear();
        }
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
        lambda$getUserDataUnchecked$2.mCurrentInputMethodSet = false;
        lambda$getUserDataUnchecked$2.mOwnerInstalledCaCerts.clear();
        saveSettingsLocked(i);
        clearUserPoliciesLocked(i);
        clearApplicationRestrictions(i);
        this.mOwners.removeProfileOwner(i);
        this.mOwners.writeProfileOwner(i);
        deleteTransferOwnershipBundleLocked(i);
        toggleBackupServiceActive(i, true);
        applyProfileRestrictionsIfDeviceOwnerLocked();
        setNetworkLoggingActiveInternal(false);
        if (isPolicyEngineForFinanceFlagEnabled() || isPermissionCheckFlagEnabled()) {
            this.mDevicePolicyEngine.removePoliciesForAdmin(EnforcingAdmin.createEnterpriseEnforcingAdmin(activeAdmin.info.getComponent(), i, activeAdmin));
        }
    }

    public void setDeviceOwnerLockScreenInfo(ComponentName componentName, final CharSequence charSequence) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda107
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setDeviceOwnerLockScreenInfo$77(charSequence);
                }
            });
            DevicePolicyEventLogger.createEvent(42).setAdmin(callerIdentity.getComponentName()).write();
        }
    }

    public /* synthetic */ void lambda$setDeviceOwnerLockScreenInfo$77(CharSequence charSequence) {
        this.mLockPatternUtils.setDeviceOwnerInfo(charSequence != null ? charSequence.toString() : null);
    }

    public CharSequence getDeviceOwnerLockScreenInfo() {
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        return (CharSequence) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda89
            public final Object getOrThrow() {
                String lambda$getDeviceOwnerLockScreenInfo$78;
                lambda$getDeviceOwnerLockScreenInfo$78 = DevicePolicyManagerService.this.lambda$getDeviceOwnerLockScreenInfo$78();
                return lambda$getDeviceOwnerLockScreenInfo$78;
            }
        });
    }

    public /* synthetic */ String lambda$getDeviceOwnerLockScreenInfo$78() {
        return this.mLockPatternUtils.getDeviceOwnerInfo();
    }

    public final void clearUserPoliciesLocked(int i) {
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
        lambda$getUserDataUnchecked$2.mPermissionPolicy = 0;
        lambda$getUserDataUnchecked$2.mDelegationMap.clear();
        lambda$getUserDataUnchecked$2.mStatusBarDisabled = false;
        lambda$getUserDataUnchecked$2.mSecondaryLockscreenEnabled = false;
        lambda$getUserDataUnchecked$2.mUserProvisioningState = 0;
        lambda$getUserDataUnchecked$2.mAffiliationIds.clear();
        resetAffiliationCacheLocked();
        lambda$getUserDataUnchecked$2.mLockTaskPackages.clear();
        if (!isPolicyEngineForFinanceFlagEnabled()) {
            updateLockTaskPackagesLocked(this.mContext, lambda$getUserDataUnchecked$2.mLockTaskPackages, i);
        }
        lambda$getUserDataUnchecked$2.mLockTaskFeatures = 0;
        saveSettingsLocked(i);
        try {
            this.mIPermissionManager.updatePermissionFlagsForAllApps(4, 0, i);
            pushUserRestrictions(i);
        } catch (RemoteException e) {
            Slogf.wtf("DevicePolicyManager", "Failing in updatePermissionFlagsForAllApps", e);
        }
    }

    public boolean hasUserSetupCompleted() {
        return hasUserSetupCompleted(this.mInjector.userHandleGetCallingUserId());
    }

    public final boolean hasUserSetupCompleted(int i) {
        if (this.mHasFeature) {
            return this.mInjector.hasUserSetupCompleted(lambda$getUserDataUnchecked$2(i));
        }
        return true;
    }

    public final boolean hasPaired(int i) {
        if (this.mHasFeature) {
            return lambda$getUserDataUnchecked$2(i).mPaired;
        }
        return true;
    }

    public int getUserProvisioningState(int i) {
        if (!this.mHasFeature) {
            return 0;
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(canManageUsers(callerIdentity) || hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        if (i != callerIdentity.getUserId()) {
            Preconditions.checkCallAuthorization(canManageUsers(callerIdentity) || hasCallingOrSelfPermission("android.permission.INTERACT_ACROSS_USERS"));
        }
        return lambda$getUserDataUnchecked$2(i).mUserProvisioningState;
    }

    public void setUserProvisioningState(int i, int i2) {
        boolean hasProfileOwner;
        int managedUserId;
        if (!this.mHasFeature) {
            logMissingFeatureAction("Cannot set provisioning state " + i + " for user " + i2);
            return;
        }
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        CallerIdentity callerIdentity = getCallerIdentity();
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            int deviceOwnerUserId = this.mOwners.getDeviceOwnerUserId();
            boolean z = false;
            if (i2 != deviceOwnerUserId && !(hasProfileOwner = this.mOwners.hasProfileOwner(i2)) && (managedUserId = getManagedUserId(i2)) < 0 && i != 0) {
                Slogf.w("DevicePolicyManager", "setUserProvisioningState(newState=%d, userId=%d) failed: deviceOwnerId=%d, hasProfileOwner=%b, managedUserId=%d, err=%s", Integer.valueOf(i), Integer.valueOf(i2), Integer.valueOf(deviceOwnerUserId), Boolean.valueOf(hasProfileOwner), Integer.valueOf(managedUserId), "Not allowed to change provisioning state unless a device or profile owner is set.");
                throw new IllegalStateException("Not allowed to change provisioning state unless a device or profile owner is set.");
            }
            synchronized (getLockObject()) {
                if (!isAdb(callerIdentity)) {
                    z = true;
                } else if (getUserProvisioningState(i2) != 0 || i != 3) {
                    throw new IllegalStateException("Not allowed to change provisioning state unless current provisioning state is unmanaged, and new stateis finalized.");
                }
                DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i2);
                if (z) {
                    checkUserProvisioningStateTransition(lambda$getUserDataUnchecked$2.mUserProvisioningState, i);
                }
                lambda$getUserDataUnchecked$2.mUserProvisioningState = i;
                saveSettingsLocked(i2);
            }
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public final void checkUserProvisioningStateTransition(int i, int i2) {
        if (i != 0) {
            if (i == 1 || i == 2) {
                if (i2 == 3) {
                    return;
                }
            } else if (i != 4) {
                if (i == 5 && i2 == 0) {
                    return;
                }
            } else if (i2 == 5) {
                return;
            }
        } else if (i2 != 0) {
            return;
        }
        throw new IllegalStateException("Cannot move to user provisioning state [" + i2 + "] from state [" + i + "]");
    }

    public void setProfileEnabled(ComponentName componentName) {
        if (!this.mHasFeature) {
            logMissingFeatureAction("Cannot enable profile for " + ComponentName.flattenToShortString(componentName));
            return;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        final int userId = callerIdentity.getUserId();
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        Preconditions.checkCallingUser(isManagedProfile(userId));
        synchronized (getLockObject()) {
            if (getUserInfo(userId).isEnabled()) {
                Slogf.e("DevicePolicyManager", "setProfileEnabled is called when the profile is already enabled");
            } else {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda135
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$setProfileEnabled$79(userId);
                    }
                });
            }
        }
    }

    public /* synthetic */ void lambda$setProfileEnabled$79(int i) {
        this.mUserManager.setUserEnabled(i);
        UserInfo profileParent = this.mUserManager.getProfileParent(i);
        Intent intent = new Intent(DevicePolicyListener.ACTION_PROFILE_OWNER_ADDED);
        intent.putExtra("android.intent.extra.USER", new UserHandle(i));
        UserHandle userHandle = new UserHandle(profileParent.id);
        this.mLocalService.broadcastIntentToManifestReceivers(intent, userHandle, true);
        intent.addFlags(1342177280);
        this.mContext.sendBroadcastAsUser(intent, userHandle);
    }

    public void setProfileName(ComponentName componentName, String str) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        final CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        final String substring = str.substring(0, Math.min(str.length(), 200));
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda57
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setProfileName$80(callerIdentity, substring);
            }
        });
    }

    public /* synthetic */ void lambda$setProfileName$80(CallerIdentity callerIdentity, String str) {
        this.mUserManager.setUserName(callerIdentity.getUserId(), str);
        DevicePolicyEventLogger.createEvent(40).setAdmin(callerIdentity.getComponentName()).write();
    }

    /* renamed from: getProfileOwnerAsUser */
    public ComponentName lambda$isProfileOwner$71(int i) {
        ComponentName profileOwnerComponent;
        if (!this.mHasFeature) {
            return null;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasCrossUsersPermission(callerIdentity, i) || hasFullCrossUsersPermission(callerIdentity, i));
        synchronized (getLockObject()) {
            profileOwnerComponent = this.mOwners.getProfileOwnerComponent(i);
        }
        return profileOwnerComponent;
    }

    public ActiveAdmin getProfileOwnerAdminLocked(int i) {
        ComponentName profileOwnerComponent = this.mOwners.getProfileOwnerComponent(i);
        if (profileOwnerComponent == null) {
            return null;
        }
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
        int size = lambda$getUserDataUnchecked$2.mAdminList.size();
        for (int i2 = 0; i2 < size; i2++) {
            ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2);
            if (profileOwnerComponent.equals(activeAdmin.info.getComponent())) {
                return activeAdmin;
            }
        }
        return null;
    }

    public final ActiveAdmin getDeviceOrProfileOwnerAdminLocked(int i) {
        ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
        return (profileOwnerAdminLocked == null && getDeviceOwnerUserIdUncheckedLocked() == i) ? getDeviceOwnerAdminLocked() : profileOwnerAdminLocked;
    }

    public ActiveAdmin getProfileOwnerOfOrganizationOwnedDeviceLocked(final int i) {
        return (ActiveAdmin) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda122
            public final Object getOrThrow() {
                ActiveAdmin lambda$getProfileOwnerOfOrganizationOwnedDeviceLocked$81;
                lambda$getProfileOwnerOfOrganizationOwnedDeviceLocked$81 = DevicePolicyManagerService.this.lambda$getProfileOwnerOfOrganizationOwnedDeviceLocked$81(i);
                return lambda$getProfileOwnerOfOrganizationOwnedDeviceLocked$81;
            }
        });
    }

    public /* synthetic */ ActiveAdmin lambda$getProfileOwnerOfOrganizationOwnedDeviceLocked$81(int i) {
        for (UserInfo userInfo : this.mUserManager.getProfiles(i)) {
            if (userInfo.isManagedProfile() && lambda$isProfileOwner$71(userInfo.id) != null && isProfileOwnerOfOrganizationOwnedDevice(userInfo.id)) {
                return getActiveAdminUncheckedLocked(lambda$isProfileOwner$71(userInfo.id), userInfo.id);
            }
        }
        return null;
    }

    public ActiveAdmin getProfileOwnerOfOrganizationOwnedDeviceLocked() {
        return (ActiveAdmin) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda147
            public final Object getOrThrow() {
                ActiveAdmin lambda$getProfileOwnerOfOrganizationOwnedDeviceLocked$82;
                lambda$getProfileOwnerOfOrganizationOwnedDeviceLocked$82 = DevicePolicyManagerService.this.lambda$getProfileOwnerOfOrganizationOwnedDeviceLocked$82();
                return lambda$getProfileOwnerOfOrganizationOwnedDeviceLocked$82;
            }
        });
    }

    public /* synthetic */ ActiveAdmin lambda$getProfileOwnerOfOrganizationOwnedDeviceLocked$82() {
        for (UserInfo userInfo : this.mUserManager.getUsers()) {
            if (userInfo.isManagedProfile() && lambda$isProfileOwner$71(userInfo.id) != null && isProfileOwnerOfOrganizationOwnedDevice(userInfo.id)) {
                return getActiveAdminUncheckedLocked(lambda$isProfileOwner$71(userInfo.id), userInfo.id);
            }
        }
        return null;
    }

    public ComponentName getProfileOwnerOrDeviceOwnerSupervisionComponent(UserHandle userHandle) {
        if (!this.mHasFeature) {
            return null;
        }
        synchronized (getLockObject()) {
            ComponentName deviceOwnerComponent = this.mOwners.getDeviceOwnerComponent();
            ComponentName profileOwnerComponent = this.mOwners.getProfileOwnerComponent(userHandle.getIdentifier());
            if (this.mConstants.USE_TEST_ADMIN_AS_SUPERVISION_COMPONENT) {
                if (isAdminTestOnlyLocked(deviceOwnerComponent, userHandle.getIdentifier())) {
                    return deviceOwnerComponent;
                }
                if (isAdminTestOnlyLocked(profileOwnerComponent, userHandle.getIdentifier())) {
                    return profileOwnerComponent;
                }
            }
            if (isSupervisionComponentLocked(profileOwnerComponent)) {
                return profileOwnerComponent;
            }
            if (isSupervisionComponentLocked(deviceOwnerComponent)) {
                return deviceOwnerComponent;
            }
            return null;
        }
    }

    public boolean isSupervisionComponent(ComponentName componentName) {
        if (!this.mHasFeature) {
            return false;
        }
        synchronized (getLockObject()) {
            if (this.mConstants.USE_TEST_ADMIN_AS_SUPERVISION_COMPONENT && isAdminTestOnlyLocked(componentName, getCallerIdentity().getUserId())) {
                return true;
            }
            return isSupervisionComponentLocked(componentName);
        }
    }

    public final boolean isSupervisionComponentLocked(ComponentName componentName) {
        if (componentName == null) {
            return false;
        }
        String string = this.mContext.getResources().getString(R.string.face_acquired_too_left);
        if (string != null && componentName.equals(ComponentName.unflattenFromString(string))) {
            return true;
        }
        return componentName.getPackageName().equals(this.mContext.getResources().getString(R.string.NetworkPreferenceSwitchTitle));
    }

    public String getProfileOwnerName(int i) {
        if (!this.mHasFeature) {
            return null;
        }
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        return getProfileOwnerNameUnchecked(i);
    }

    public final String getProfileOwnerNameUnchecked(int i) {
        ComponentName lambda$isProfileOwner$71 = lambda$isProfileOwner$71(i);
        if (lambda$isProfileOwner$71 == null) {
            return null;
        }
        return getApplicationLabel(lambda$isProfileOwner$71.getPackageName(), i);
    }

    public final int getOrganizationOwnedProfileUserId() {
        for (UserInfo userInfo : this.mUserManagerInternal.getUserInfos()) {
            if (userInfo.isManagedProfile() && isProfileOwnerOfOrganizationOwnedDevice(userInfo.id)) {
                return userInfo.id;
            }
        }
        return -10000;
    }

    public boolean isOrganizationOwnedDeviceWithManagedProfile() {
        return this.mHasFeature && getOrganizationOwnedProfileUserId() != -10000;
    }

    public boolean checkDeviceIdentifierAccess(String str, int i, int i2) {
        ensureCallerIdentityMatchesIfNotSystem(str, i, i2, getCallerIdentity());
        if (doesPackageMatchUid(str, i2) && hasPermission("android.permission.READ_PHONE_STATE", i, i2)) {
            return hasDeviceIdAccessUnchecked(str, i2);
        }
        return false;
    }

    public boolean hasDeviceIdAccessUnchecked(String str, int i) {
        int userId = UserHandle.getUserId(i);
        if (isPermissionCheckFlagEnabled() && !isUidProfileOwnerLocked(i) && !isUidDeviceOwnerLocked(i)) {
            return hasPermission("android.permission.MANAGE_DEVICE_POLICY_CERTIFICATES", str, userId);
        }
        ComponentName deviceOwnerComponent = getDeviceOwnerComponent(true);
        if (deviceOwnerComponent != null && (deviceOwnerComponent.getPackageName().equals(str) || isCallerDelegate(str, i, "delegation-cert-install"))) {
            return true;
        }
        ComponentName lambda$isProfileOwner$71 = lambda$isProfileOwner$71(userId);
        return (lambda$isProfileOwner$71 != null && (lambda$isProfileOwner$71.getPackageName().equals(str) || isCallerDelegate(str, i, "delegation-cert-install"))) && (isProfileOwnerOfOrganizationOwnedDevice(userId) || isUserAffiliatedWithDevice(userId));
    }

    public final boolean doesPackageMatchUid(String str, int i) {
        try {
            ApplicationInfo applicationInfo = this.mIPackageManager.getApplicationInfo(str, 0L, UserHandle.getUserId(i));
            if (applicationInfo == null) {
                Slogf.w("DevicePolicyManager", "appInfo could not be found for package %s", str);
                return false;
            }
            int i2 = applicationInfo.uid;
            if (i == i2) {
                return true;
            }
            String format = String.format("Package %s (uid=%d) does not match provided uid %d", str, Integer.valueOf(i2), Integer.valueOf(i));
            Slogf.w("DevicePolicyManager", format);
            throw new SecurityException(format);
        } catch (RemoteException e) {
            Slogf.e("DevicePolicyManager", e, "Exception caught obtaining appInfo for package %s", str);
            return false;
        }
    }

    public final void ensureCallerIdentityMatchesIfNotSystem(String str, int i, int i2, CallerIdentity callerIdentity) {
        int uid = callerIdentity.getUid();
        int binderGetCallingPid = this.mInjector.binderGetCallingPid();
        if (UserHandle.getAppId(uid) >= 10000) {
            if (uid == i2 && binderGetCallingPid == i) {
                return;
            }
            String format = String.format("Calling uid %d, pid %d cannot check device identifier access for package %s (uid=%d, pid=%d)", Integer.valueOf(uid), Integer.valueOf(binderGetCallingPid), str, Integer.valueOf(i2), Integer.valueOf(i));
            Slogf.w("DevicePolicyManager", format);
            throw new SecurityException(format);
        }
    }

    public final String getApplicationLabel(final String str, final int i) {
        return (String) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda159
            public final Object getOrThrow() {
                String lambda$getApplicationLabel$83;
                lambda$getApplicationLabel$83 = DevicePolicyManagerService.this.lambda$getApplicationLabel$83(i, str);
                return lambda$getApplicationLabel$83;
            }
        });
    }

    public /* synthetic */ String lambda$getApplicationLabel$83(int i, String str) {
        try {
            Context createPackageContextAsUser = this.mContext.createPackageContextAsUser(str, 0, UserHandle.of(i));
            ApplicationInfo applicationInfo = createPackageContextAsUser.getApplicationInfo();
            CharSequence loadUnsafeLabel = applicationInfo != null ? applicationInfo.loadUnsafeLabel(createPackageContextAsUser.getPackageManager()) : null;
            if (loadUnsafeLabel != null) {
                return loadUnsafeLabel.toString();
            }
            return null;
        } catch (PackageManager.NameNotFoundException e) {
            Slogf.w("DevicePolicyManager", e, "%s is not installed for user %d", str, Integer.valueOf(i));
            return null;
        }
    }

    public final void enforceCanSetProfileOwnerLocked(CallerIdentity callerIdentity, ComponentName componentName, int i, boolean z) {
        UserInfo userInfo = getUserInfo(i);
        if (userInfo == null) {
            throw new IllegalArgumentException("Attempted to set profile owner for invalid userId: " + i);
        }
        if (userInfo.isGuest()) {
            throw new IllegalStateException("Cannot set a profile owner on a guest");
        }
        if (this.mOwners.hasProfileOwner(i)) {
            StringBuilder sb = new StringBuilder("Trying to set the profile owner");
            if (!z) {
                StringBuilder append = append(sb, componentName);
                append.append(" on user ");
                append.append(i);
            }
            sb.append(", but profile owner");
            if (!z) {
                appendProfileOwnerLocked(sb, i);
            }
            sb.append(" is already set.");
            throw new IllegalStateException(sb.toString());
        }
        if (this.mOwners.hasDeviceOwner() && this.mOwners.getDeviceOwnerUserId() == i) {
            StringBuilder sb2 = new StringBuilder("Trying to set the profile owner");
            if (!z) {
                StringBuilder append2 = append(sb2, componentName);
                append2.append(" on user ");
                append2.append(i);
            }
            sb2.append(", but the user already has a device owner");
            if (!z) {
                appendDeviceOwnerLocked(sb2);
            }
            sb2.append('.');
            throw new IllegalStateException(sb2.toString());
        }
        if (isAdb(callerIdentity)) {
            if ((this.mIsWatch || hasUserSetupCompleted(i)) && z) {
                StringBuilder sb3 = new StringBuilder("Not allowed to set the profile owner");
                if (!z) {
                    StringBuilder append3 = append(sb3, componentName);
                    append3.append(" on user ");
                    append3.append(i);
                    append3.append(' ');
                }
                sb3.append(" because there are already some accounts on the profile.");
                throw new IllegalStateException(sb3.toString());
            }
            return;
        }
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        if (this.mIsWatch || hasUserSetupCompleted(i)) {
            Preconditions.checkState(isSystemUid(callerIdentity), "Cannot set the profile owner on a user which is already set-up");
            if (this.mIsWatch || isSupervisionComponentLocked(componentName)) {
                return;
            }
            throw new IllegalStateException("Unable to set non-default profile owner post-setup " + componentName);
        }
    }

    public final void enforceCanSetDeviceOwnerLocked(CallerIdentity callerIdentity, ComponentName componentName, int i, boolean z) {
        boolean z2;
        if (isAdb(callerIdentity)) {
            z2 = true;
        } else {
            Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
            z2 = false;
        }
        int checkDeviceOwnerProvisioningPreConditionLocked = checkDeviceOwnerProvisioningPreConditionLocked(componentName, i, callerIdentity.getUserId(), isAdb(callerIdentity), z);
        if (checkDeviceOwnerProvisioningPreConditionLocked != 0) {
            String computeProvisioningErrorStringLocked = computeProvisioningErrorStringLocked(checkDeviceOwnerProvisioningPreConditionLocked, i, componentName, z2);
            if (checkDeviceOwnerProvisioningPreConditionLocked == 16) {
                throw new ServiceSpecificException(checkDeviceOwnerProvisioningPreConditionLocked, computeProvisioningErrorStringLocked);
            }
            throw new IllegalStateException(computeProvisioningErrorStringLocked);
        }
    }

    public final String computeProvisioningErrorString(int i, int i2) {
        String computeProvisioningErrorStringLocked;
        synchronized (getLockObject()) {
            computeProvisioningErrorStringLocked = computeProvisioningErrorStringLocked(i, i2, null, false);
        }
        return computeProvisioningErrorStringLocked;
    }

    public final String computeProvisioningErrorStringLocked(int i, int i2, ComponentName componentName, boolean z) {
        if (i == 16) {
            return "Cannot provision an unsupported DPC into DO on a headless device";
        }
        switch (i) {
            case 0:
                return "OK";
            case 1:
                StringBuilder sb = new StringBuilder("Trying to set the device owner");
                if (z && componentName != null) {
                    append(sb, componentName);
                }
                sb.append(", but device owner");
                if (z) {
                    appendDeviceOwnerLocked(sb);
                }
                sb.append(" is already set.");
                return sb.toString();
            case 2:
                StringBuilder sb2 = new StringBuilder("Trying to set the device owner");
                if (z && componentName != null) {
                    append(sb2, componentName);
                }
                sb2.append(", but the user already has a profile owner");
                if (z) {
                    appendProfileOwnerLocked(sb2, i2);
                }
                sb2.append(".");
                return sb2.toString();
            case 3:
                return "User " + i2 + " not running.";
            case 4:
                return "Cannot set the device owner if the device is already set-up.";
            case 5:
                return "Not allowed to set the device owner because there are already several users on the device.";
            case 6:
                return "Not allowed to set the device owner because there are already some accounts on the device.";
            case 7:
                return "User " + i2 + " is not system user.";
            case 8:
                return "Not allowed to set the device owner because this device has already paired.";
            default:
                return "Unexpected @ProvisioningPreCondition: " + i;
        }
    }

    public final void appendDeviceOwnerLocked(StringBuilder sb) {
        ComponentName deviceOwnerComponent = getDeviceOwnerComponent(false);
        if (deviceOwnerComponent == null) {
            Slogf.wtf("DevicePolicyManager", "appendDeviceOwnerLocked(): device has no DO set");
        } else {
            append(sb, deviceOwnerComponent);
        }
    }

    public final void appendProfileOwnerLocked(StringBuilder sb, int i) {
        ComponentName profileOwnerComponent = this.mOwners.getProfileOwnerComponent(i);
        if (profileOwnerComponent == null) {
            Slogf.wtf("DevicePolicyManager", "profileOwner(%d): PO not set", Integer.valueOf(i));
        } else {
            append(sb, profileOwnerComponent);
        }
    }

    public static StringBuilder append(StringBuilder sb, ComponentName componentName) {
        sb.append(" (");
        sb.append(componentName.flattenToShortString());
        sb.append(')');
        return sb;
    }

    public final void enforceUserUnlocked(int i) {
        Preconditions.checkState(this.mUserManager.isUserUnlocked(i), "User must be running and unlocked");
    }

    public final void enforceUserUnlocked(int i, boolean z) {
        if (z) {
            enforceUserUnlocked(getProfileParentId(i));
        } else {
            enforceUserUnlocked(i);
        }
    }

    public final boolean canManageUsers(CallerIdentity callerIdentity) {
        return hasCallingOrSelfPermission("android.permission.MANAGE_USERS");
    }

    public final boolean canQueryAdminPolicy(CallerIdentity callerIdentity) {
        return hasCallingOrSelfPermission("android.permission.QUERY_ADMIN_POLICY");
    }

    public final boolean hasPermission(String str, int i, int i2) {
        return this.mContext.checkPermission(str, i, i2) == 0;
    }

    public final boolean hasCallingPermission(String str) {
        return this.mContext.checkCallingPermission(str) == 0;
    }

    public final boolean hasCallingOrSelfPermission(String str) {
        return this.mContext.checkCallingOrSelfPermission(str) == 0;
    }

    public final boolean hasPermissionForPreflight(CallerIdentity callerIdentity, String str) {
        return PermissionChecker.checkPermissionForPreflight(this.mContext, str, this.mInjector.binderGetCallingPid(), callerIdentity.getUid(), this.mContext.getPackageName()) == 0;
    }

    public final boolean hasFullCrossUsersPermission(CallerIdentity callerIdentity, int i) {
        return i == callerIdentity.getUserId() || isSystemUid(callerIdentity) || isRootUid(callerIdentity) || hasCallingOrSelfPermission("android.permission.INTERACT_ACROSS_USERS_FULL");
    }

    public final boolean hasCrossUsersPermission(CallerIdentity callerIdentity, int i) {
        return i == callerIdentity.getUserId() || isSystemUid(callerIdentity) || isRootUid(callerIdentity) || hasCallingOrSelfPermission("android.permission.INTERACT_ACROSS_USERS");
    }

    public final boolean canDPCManagedUserUseLockTaskLocked(int i) {
        if (isUserAffiliatedWithDeviceLocked(i)) {
            return true;
        }
        return (this.mOwners.hasDeviceOwner() || lambda$isProfileOwner$71(i) == null || isManagedProfile(i)) ? false : true;
    }

    public final void enforceCanQueryLockTaskLocked(ComponentName componentName, String str) {
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        int userId = callerIdentity.getUserId();
        enforceCanQuery("android.permission.MANAGE_DEVICE_POLICY_LOCK_TASK", callerIdentity.getPackageName(), userId);
        if ((isDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity)) && !canDPCManagedUserUseLockTaskLocked(userId)) {
            throw new SecurityException("User " + userId + " is not allowed to use lock task");
        }
    }

    public final EnforcingAdmin enforceCanCallLockTaskLocked(ComponentName componentName, String str) {
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        int userId = callerIdentity.getUserId();
        EnforcingAdmin enforcePermissionAndGetEnforcingAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_LOCK_TASK", callerIdentity.getPackageName(), userId);
        if ((!isDeviceOwner(callerIdentity) && !isProfileOwner(callerIdentity)) || canDPCManagedUserUseLockTaskLocked(userId)) {
            return enforcePermissionAndGetEnforcingAdmin;
        }
        throw new SecurityException("User " + userId + " is not allowed to use lock task");
    }

    public final void enforceCanCallLockTaskLocked(CallerIdentity callerIdentity) {
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || isFinancedDeviceOwner(callerIdentity));
        int userId = callerIdentity.getUserId();
        if (canDPCManagedUserUseLockTaskLocked(userId)) {
            return;
        }
        throw new SecurityException("User " + userId + " is not allowed to use lock task");
    }

    public final boolean isSystemUid(CallerIdentity callerIdentity) {
        return UserHandle.isSameApp(callerIdentity.getUid(), 1000);
    }

    public final boolean isRootUid(CallerIdentity callerIdentity) {
        return UserHandle.isSameApp(callerIdentity.getUid(), 0);
    }

    public final boolean isShellUid(CallerIdentity callerIdentity) {
        return UserHandle.isSameApp(callerIdentity.getUid(), 2000);
    }

    public final boolean isCameraServerUid(CallerIdentity callerIdentity) {
        return UserHandle.isSameApp(callerIdentity.getUid(), 1047);
    }

    public final int getCurrentForegroundUserId() {
        try {
            UserInfo currentUser = this.mInjector.getIActivityManager().getCurrentUser();
            if (currentUser == null) {
                Slogf.wtf("DevicePolicyManager", "getCurrentForegroundUserId(): mInjector.getIActivityManager().getCurrentUser() returned null, please ignore when running unit tests");
                return ActivityManager.getCurrentUser();
            }
            return currentUser.id;
        } catch (RemoteException e) {
            Slogf.wtf("DevicePolicyManager", "cannot get current user", e);
            return -10000;
        }
    }

    public List listForegroundAffiliatedUsers() {
        checkIsDeviceOwner(getCallerIdentity());
        return (List) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda53
            public final Object getOrThrow() {
                List lambda$listForegroundAffiliatedUsers$84;
                lambda$listForegroundAffiliatedUsers$84 = DevicePolicyManagerService.this.lambda$listForegroundAffiliatedUsers$84();
                return lambda$listForegroundAffiliatedUsers$84;
            }
        });
    }

    public /* synthetic */ List lambda$listForegroundAffiliatedUsers$84() {
        boolean isUserAffiliatedWithDeviceLocked;
        int currentForegroundUserId = getCurrentForegroundUserId();
        synchronized (getLockObject()) {
            isUserAffiliatedWithDeviceLocked = isUserAffiliatedWithDeviceLocked(currentForegroundUserId);
        }
        if (!isUserAffiliatedWithDeviceLocked) {
            return Collections.emptyList();
        }
        ArrayList arrayList = new ArrayList(1);
        arrayList.add(UserHandle.of(currentForegroundUserId));
        return arrayList;
    }

    public int getProfileParentId(final int i) {
        return ((Integer) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda151
            public final Object getOrThrow() {
                Integer lambda$getProfileParentId$85;
                lambda$getProfileParentId$85 = DevicePolicyManagerService.this.lambda$getProfileParentId$85(i);
                return lambda$getProfileParentId$85;
            }
        })).intValue();
    }

    public /* synthetic */ Integer lambda$getProfileParentId$85(int i) {
        UserInfo profileParent = this.mUserManager.getProfileParent(i);
        if (profileParent != null) {
            i = profileParent.id;
        }
        return Integer.valueOf(i);
    }

    public final int getProfileParentUserIfRequested(int i, boolean z) {
        return z ? getProfileParentId(i) : i;
    }

    public final int getCredentialOwner(final int i, final boolean z) {
        return ((Integer) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda21
            public final Object getOrThrow() {
                Integer lambda$getCredentialOwner$86;
                lambda$getCredentialOwner$86 = DevicePolicyManagerService.this.lambda$getCredentialOwner$86(i, z);
                return lambda$getCredentialOwner$86;
            }
        })).intValue();
    }

    public /* synthetic */ Integer lambda$getCredentialOwner$86(int i, boolean z) {
        UserInfo profileParent;
        if (z && (profileParent = this.mUserManager.getProfileParent(i)) != null) {
            i = profileParent.id;
        }
        return Integer.valueOf(this.mUserManager.getCredentialOwnerProfile(i));
    }

    public final boolean isManagedProfile(int i) {
        UserInfo userInfo = getUserInfo(i);
        return userInfo != null && userInfo.isManagedProfile();
    }

    public final void enableIfNecessary(String str, int i) {
        try {
            if (this.mIPackageManager.getApplicationInfo(str, 32768L, i).enabledSetting == 4) {
                this.mIPackageManager.setApplicationEnabledSetting(str, 0, 1, i, "DevicePolicyManager");
            }
        } catch (RemoteException unused) {
        }
    }

    public final void dumpPersonalAppInfoForSystemUserNoLock(IndentingPrintWriter indentingPrintWriter) {
        wtfIfInLock();
        PersonalAppsSuspensionHelper.forUser(this.mContext, 0).dump(indentingPrintWriter);
    }

    public final void dumpPerUserPolicyData(IndentingPrintWriter indentingPrintWriter) {
        int size = this.mUserData.size();
        for (int i = 0; i < size; i++) {
            lambda$getUserDataUnchecked$2(this.mUserData.keyAt(i)).dump(indentingPrintWriter);
            indentingPrintWriter.println();
        }
    }

    public void dump(FileDescriptor fileDescriptor, PrintWriter printWriter, String[] strArr) {
        if (DumpUtils.checkDumpPermission(this.mContext, "DevicePolicyManager", printWriter)) {
            final IndentingPrintWriter indentingPrintWriter = new IndentingPrintWriter(printWriter, "  ");
            try {
                indentingPrintWriter.println("Current Device Policy Manager state:");
                indentingPrintWriter.increaseIndent();
                dumpImmutableState(indentingPrintWriter);
                synchronized (getLockObject()) {
                    this.mOwners.dump(indentingPrintWriter);
                    indentingPrintWriter.println();
                    this.mDeviceAdminServiceController.dump(indentingPrintWriter);
                    indentingPrintWriter.println();
                    dumpPerUserPolicyData(indentingPrintWriter);
                    indentingPrintWriter.println();
                    this.mConstants.dump(indentingPrintWriter);
                    indentingPrintWriter.println();
                    this.mStatLogger.dump(indentingPrintWriter);
                    indentingPrintWriter.println();
                    this.mDevicePolicyEngine.dump(indentingPrintWriter);
                    indentingPrintWriter.println();
                    indentingPrintWriter.println("Encryption Status: " + getEncryptionStatusName(getEncryptionStatus()));
                    indentingPrintWriter.println("Logout user: " + getLogoutUserIdUnchecked());
                    indentingPrintWriter.println();
                    if (this.mPendingUserCreatedCallbackTokens.isEmpty()) {
                        indentingPrintWriter.println("no pending user created callback tokens");
                    } else {
                        int size = this.mPendingUserCreatedCallbackTokens.size();
                        Object[] objArr = new Object[2];
                        objArr[0] = Integer.valueOf(size);
                        objArr[1] = size == 1 ? "" : "s";
                        indentingPrintWriter.printf("%d pending user created callback token%s\n", objArr);
                    }
                    indentingPrintWriter.println();
                    indentingPrintWriter.println("Keep profiles running: " + lambda$getUserDataUnchecked$2(0).mEffectiveKeepProfilesRunning);
                    indentingPrintWriter.println();
                    this.mPolicyCache.dump(indentingPrintWriter);
                    indentingPrintWriter.println();
                    this.mStateCache.dump(indentingPrintWriter);
                    indentingPrintWriter.println();
                }
                dumpPersonalAppInfoForSystemUserNoLock(indentingPrintWriter);
                synchronized (this.mSubscriptionsChangedListenerLock) {
                    indentingPrintWriter.println("Subscription changed listener : " + this.mSubscriptionsChangedListener);
                }
                indentingPrintWriter.println("DPM Engine (Permission Based Check) Flag : " + isPermissionCheckFlagEnabled());
                indentingPrintWriter.println("DPM Engine (For Finance) Flag : " + isPolicyEngineForFinanceFlagEnabled());
                indentingPrintWriter.println("DPM global setting ALLOW_WORK_PROFILE_TELEPHONY_FOR_NON_DPM_ROLE_HOLDERS : " + this.mInjector.settingsGlobalGetString("allow_work_profile_telephony_for_non_dpm_role_holders"));
                this.mHandler.post(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda68
                    @Override // java.lang.Runnable
                    public final void run() {
                        DevicePolicyManagerService.this.lambda$dump$87(indentingPrintWriter);
                    }
                });
                dumpResources(indentingPrintWriter);
                indentingPrintWriter.close();
            } catch (Throwable th) {
                try {
                    indentingPrintWriter.close();
                } catch (Throwable th2) {
                    th.addSuppressed(th2);
                }
                throw th;
            }
        }
    }

    /* renamed from: handleDump */
    public final void lambda$dump$87(IndentingPrintWriter indentingPrintWriter) {
        if (this.mNetworkLoggingNotificationUserId != -10000) {
            indentingPrintWriter.println("mNetworkLoggingNotificationUserId:  " + this.mNetworkLoggingNotificationUserId);
        }
    }

    public final void dumpImmutableState(IndentingPrintWriter indentingPrintWriter) {
        indentingPrintWriter.println("Immutable state:");
        indentingPrintWriter.increaseIndent();
        indentingPrintWriter.printf("mHasFeature=%b\n", new Object[]{Boolean.valueOf(this.mHasFeature)});
        indentingPrintWriter.printf("mIsWatch=%b\n", new Object[]{Boolean.valueOf(this.mIsWatch)});
        indentingPrintWriter.printf("mIsAutomotive=%b\n", new Object[]{Boolean.valueOf(this.mIsAutomotive)});
        indentingPrintWriter.printf("mHasTelephonyFeature=%b\n", new Object[]{Boolean.valueOf(this.mHasTelephonyFeature)});
        indentingPrintWriter.printf("mSafetyChecker=%s\n", new Object[]{this.mSafetyChecker});
        indentingPrintWriter.decreaseIndent();
    }

    public final void dumpResources(IndentingPrintWriter indentingPrintWriter) {
        this.mOverlayPackagesProvider.dump(indentingPrintWriter);
        indentingPrintWriter.println();
        indentingPrintWriter.println("Other overlayable app resources");
        indentingPrintWriter.increaseIndent();
        dumpResources(indentingPrintWriter, this.mContext, "cross_profile_apps", 17236417);
        dumpResources(indentingPrintWriter, this.mContext, "vendor_cross_profile_apps", 17236464);
        dumpResources(indentingPrintWriter, this.mContext, "config_packagesExemptFromSuspension", 17236272);
        dumpResources(indentingPrintWriter, this.mContext, "policy_exempt_apps", 17236445);
        dumpResources(indentingPrintWriter, this.mContext, "vendor_policy_exempt_apps", 17236468);
        indentingPrintWriter.decreaseIndent();
        indentingPrintWriter.println();
    }

    public static void dumpResources(IndentingPrintWriter indentingPrintWriter, Context context, String str, int i) {
        dumpApps(indentingPrintWriter, str, context.getResources().getStringArray(i));
    }

    public static void dumpApps(IndentingPrintWriter indentingPrintWriter, String str, String[] strArr) {
        dumpApps(indentingPrintWriter, str, Arrays.asList(strArr));
    }

    public static void dumpApps(IndentingPrintWriter indentingPrintWriter, String str, List list) {
        if (list == null || list.isEmpty()) {
            indentingPrintWriter.printf("%s: empty\n", new Object[]{str});
            return;
        }
        int size = list.size();
        Object[] objArr = new Object[3];
        objArr[0] = str;
        objArr[1] = Integer.valueOf(size);
        objArr[2] = size == 1 ? "" : "s";
        indentingPrintWriter.printf("%s: %d app%s\n", objArr);
        indentingPrintWriter.increaseIndent();
        for (int i = 0; i < size; i++) {
            indentingPrintWriter.printf("%d: %s\n", new Object[]{Integer.valueOf(i), list.get(i)});
        }
        indentingPrintWriter.decreaseIndent();
    }

    /* JADX WARN: Multi-variable type inference failed */
    public void onShellCommand(FileDescriptor fileDescriptor, FileDescriptor fileDescriptor2, FileDescriptor fileDescriptor3, String[] strArr, ShellCallback shellCallback, ResultReceiver resultReceiver) {
        new DevicePolicyManagerServiceShellCommand(this).exec(this, fileDescriptor, fileDescriptor2, fileDescriptor3, strArr, shellCallback, resultReceiver);
    }

    /* JADX WARN: Multi-variable type inference failed */
    /* JADX WARN: Type inference failed for: r5v12 */
    /* JADX WARN: Type inference failed for: r5v13 */
    /* JADX WARN: Type inference failed for: r5v5, types: [com.android.server.devicepolicy.DevicePolicyManagerService$Injector] */
    public void addPersistentPreferredActivity(ComponentName componentName, String str, IntentFilter intentFilter, ComponentName componentName2) {
        CallerIdentity callerIdentity;
        EnforcingAdmin enforcingAdminForCaller;
        if (isPolicyEngineForFinanceFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        int userId = callerIdentity.getUserId();
        if (isPolicyEngineForFinanceFlagEnabled()) {
            if (componentName == null) {
                enforcingAdminForCaller = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_LOCK_TASK", callerIdentity.getPackageName(), userId);
            } else {
                Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || isFinancedDeviceOwner(callerIdentity));
                enforcingAdminForCaller = getEnforcingAdminForCaller(componentName, str);
            }
            if (!isPackageInstalledForUser(componentName2.getPackageName(), userId)) {
                return;
            } else {
                this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.PERSISTENT_PREFERRED_ACTIVITY(intentFilter), enforcingAdminForCaller, new ComponentNamePolicyValue(componentName2), userId);
            }
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || isFinancedDeviceOwner(callerIdentity));
            synchronized (getLockObject()) {
                long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
                try {
                    try {
                        this.mIPackageManager.addPersistentPreferredActivity(intentFilter, componentName2, userId);
                        this.mIPackageManager.flushPackageRestrictionsAsUser(userId);
                        this = this.mInjector;
                    } catch (RemoteException e) {
                        Slog.wtf("DevicePolicyManager", "Error adding persistent preferred activity", e);
                        this = this.mInjector;
                    }
                    this.binderRestoreCallingIdentity(binderClearCallingIdentity);
                } catch (Throwable th) {
                    this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                    throw th;
                }
            }
        }
        DevicePolicyEventLogger.createEvent(52).setAdmin(callerIdentity.getPackageName()).setStrings(componentName2 != null ? componentName2.getPackageName() : null, getIntentFilterActions(intentFilter)).write();
    }

    public void clearPackagePersistentPreferredActivities(ComponentName componentName, String str, String str2) {
        CallerIdentity callerIdentity;
        Injector injector;
        EnforcingAdmin enforcingAdminForCaller;
        if (isPolicyEngineForFinanceFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        int userId = callerIdentity.getUserId();
        if (isPolicyEngineForFinanceFlagEnabled()) {
            if (componentName == null) {
                enforcingAdminForCaller = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_LOCK_TASK", callerIdentity.getPackageName(), userId);
            } else {
                Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || isFinancedDeviceOwner(callerIdentity));
                enforcingAdminForCaller = getEnforcingAdminForCaller(componentName, str);
            }
            clearPackagePersistentPreferredActivitiesFromPolicyEngine(enforcingAdminForCaller, str2, userId);
            return;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || isFinancedDeviceOwner(callerIdentity));
        synchronized (getLockObject()) {
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                try {
                    this.mIPackageManager.clearPackagePersistentPreferredActivities(str2, userId);
                    this.mIPackageManager.flushPackageRestrictionsAsUser(userId);
                    injector = this.mInjector;
                } catch (Throwable th) {
                    this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                    throw th;
                }
            } catch (RemoteException e) {
                Slogf.wtf("DevicePolicyManager", "Error when clearing package persistent preferred activities", e);
                injector = this.mInjector;
            }
            injector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public final void clearPackagePersistentPreferredActivitiesFromPolicyEngine(EnforcingAdmin enforcingAdmin, String str, int i) {
        for (IntentFilterPolicyKey intentFilterPolicyKey : this.mDevicePolicyEngine.getLocalPolicyKeysSetByAdmin(PolicyDefinition.GENERIC_PERSISTENT_PREFERRED_ACTIVITY, enforcingAdmin, i)) {
            if (!(intentFilterPolicyKey instanceof IntentFilterPolicyKey)) {
                throw new IllegalStateException("PolicyKey for PERSISTENT_PREFERRED_ACTIVITY is notof type IntentFilterPolicyKey");
            }
            IntentFilter intentFilter = intentFilterPolicyKey.getIntentFilter();
            Objects.requireNonNull(intentFilter);
            ComponentName componentName = (ComponentName) this.mDevicePolicyEngine.getLocalPolicySetByAdmin(PolicyDefinition.PERSISTENT_PREFERRED_ACTIVITY(intentFilter), enforcingAdmin, i);
            if (componentName != null && componentName.getPackageName().equals(str)) {
                this.mDevicePolicyEngine.removeLocalPolicy(PolicyDefinition.PERSISTENT_PREFERRED_ACTIVITY(intentFilter), enforcingAdmin, i);
            }
        }
    }

    public void setDefaultSmsApplication(ComponentName componentName, String str, final String str2, boolean z) {
        CallerIdentity callerIdentity;
        final int userHandleGetCallingUserId;
        if (isPermissionCheckFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        if (isPermissionCheckFlagEnabled()) {
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_DEFAULT_SMS", callerIdentity.getPackageName(), getAffectedUser(z));
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        }
        if (!z && isManagedProfile(callerIdentity.getUserId()) && getManagedSubscriptionsPolicy().getPolicyType() != 1) {
            throw new IllegalStateException("Default sms application can only be set on the profile, when ManagedSubscriptions policy is set");
        }
        if (z) {
            userHandleGetCallingUserId = getProfileParentId(this.mInjector.userHandleGetCallingUserId());
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda33
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setDefaultSmsApplication$88(str2, userHandleGetCallingUserId);
                }
            });
        } else {
            userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        }
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda34
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setDefaultSmsApplication$89(str2, userHandleGetCallingUserId);
            }
        });
        synchronized (getLockObject()) {
            ActiveAdmin parentOfAdminIfRequired = getParentOfAdminIfRequired(getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()), z);
            if (isManagedProfile(userHandleGetCallingUserId)) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda35
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$setDefaultSmsApplication$90();
                    }
                });
            }
            if (!Objects.equals(parentOfAdminIfRequired.mSmsPackage, str2)) {
                parentOfAdminIfRequired.mSmsPackage = str2;
                saveSettingsLocked(callerIdentity.getUserId());
            }
        }
    }

    public /* synthetic */ void lambda$setDefaultSmsApplication$89(String str, int i) {
        SmsApplication.setDefaultApplicationAsUser(str, this.mContext, i);
    }

    public void setDefaultDialerApplication(final String str) {
        if (this.mHasFeature && this.mHasTelephonyFeature) {
            CallerIdentity callerIdentity = getCallerIdentity();
            final int userId = callerIdentity.getUserId();
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda83
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setDefaultDialerApplication$92(str, userId);
                }
            });
            synchronized (getLockObject()) {
                if (isManagedProfile(userId)) {
                    this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda84
                        public final void runOrThrow() {
                            DevicePolicyManagerService.this.lambda$setDefaultDialerApplication$93();
                        }
                    });
                }
                ActiveAdmin profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(userId);
                if (!Objects.equals(profileOwnerOrDeviceOwnerLocked.mDialerPackage, str)) {
                    profileOwnerOrDeviceOwnerLocked.mDialerPackage = str;
                    saveSettingsLocked(userId);
                }
            }
        }
    }

    public /* synthetic */ void lambda$setDefaultDialerApplication$92(final String str, int i) {
        final CompletableFuture completableFuture = new CompletableFuture();
        this.mRoleManager.addRoleHolderAsUser("android.app.role.DIALER", str, 0, UserHandle.of(i), AsyncTask.THREAD_POOL_EXECUTOR, new Consumer() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda206
            @Override // java.util.function.Consumer
            public final void accept(Object obj) {
                DevicePolicyManagerService.lambda$setDefaultDialerApplication$91(completableFuture, str, (Boolean) obj);
            }
        });
        try {
            completableFuture.get(20L, TimeUnit.SECONDS);
        } catch (ExecutionException e) {
            Throwable cause = e.getCause();
            if (cause instanceof IllegalArgumentException) {
                throw ((IllegalArgumentException) cause);
            }
            throw new IllegalStateException(cause);
        } catch (TimeoutException e2) {
            throw new IllegalArgumentException("Timeout when setting the app as the dialer", e2);
        }
    }

    public static /* synthetic */ void lambda$setDefaultDialerApplication$91(CompletableFuture completableFuture, String str, Boolean bool) {
        if (bool.booleanValue()) {
            completableFuture.complete(null);
            return;
        }
        completableFuture.completeExceptionally(new IllegalArgumentException(str + " cannot be set as the dialer"));
    }

    public boolean setApplicationRestrictionsManagingPackage(ComponentName componentName, String str) {
        try {
            setDelegatedScopePreO(componentName, str, "delegation-app-restrictions");
            return true;
        } catch (IllegalArgumentException unused) {
            return false;
        }
    }

    public String getApplicationRestrictionsManagingPackage(ComponentName componentName) {
        List delegatePackages = getDelegatePackages(componentName, "delegation-app-restrictions");
        if (delegatePackages.size() > 0) {
            return (String) delegatePackages.get(0);
        }
        return null;
    }

    public boolean isCallerApplicationRestrictionsManagingPackage(String str) {
        return isCallerDelegate(str, getCallerIdentity().getUid(), "delegation-app-restrictions");
    }

    public void setApplicationRestrictions(ComponentName componentName, String str, final String str2, final Bundle bundle) {
        final CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        checkCanExecuteOrThrowUnsafe(16);
        boolean z = false;
        if (isUnicornFlagEnabled()) {
            EnforcingAdmin enforcePermissionAndGetEnforcingAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_APP_RESTRICTIONS", callerIdentity.getPackageName(), callerIdentity.getUserId());
            String validateName = FrameworkParsingPackageUtils.validateName(str2, false, false);
            if (validateName != null) {
                throw new IllegalArgumentException("Invalid package name: " + validateName);
            }
            if (bundle == null || bundle.isEmpty()) {
                this.mDevicePolicyEngine.removeLocalPolicy(PolicyDefinition.APPLICATION_RESTRICTIONS(str2), enforcePermissionAndGetEnforcingAdmin, callerIdentity.getUserId());
            } else {
                this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.APPLICATION_RESTRICTIONS(str2), enforcePermissionAndGetEnforcingAdmin, new BundlePolicyValue(bundle), callerIdentity.getUserId());
            }
            setBackwardsCompatibleAppRestrictions(callerIdentity, str2, bundle, callerIdentity.getUserHandle());
        } else {
            if ((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-app-restrictions"))) {
                z = true;
            }
            Preconditions.checkCallAuthorization(z);
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda42
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setApplicationRestrictions$94(str2, bundle, callerIdentity);
                }
            });
        }
        DevicePolicyEventLogger.createEvent(62).setAdmin(callerIdentity.getPackageName()).setBoolean(isCallerDelegate(callerIdentity)).setStrings(new String[]{str2}).write();
    }

    public /* synthetic */ void lambda$setApplicationRestrictions$94(String str, Bundle bundle, CallerIdentity callerIdentity) {
        this.mUserManager.setApplicationRestrictions(str, bundle, callerIdentity.getUserHandle());
    }

    public final void setBackwardsCompatibleAppRestrictions(CallerIdentity callerIdentity, final String str, final Bundle bundle, final UserHandle userHandle) {
        if ((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-app-restrictions"))) {
            if (bundle == null || bundle.isEmpty()) {
                bundle = getAppRestrictionsSetByAnyAdmin(str, userHandle);
            }
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda222
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setBackwardsCompatibleAppRestrictions$95(str, bundle, userHandle);
                }
            });
            return;
        }
        Intent intent = new Intent("android.intent.action.APPLICATION_RESTRICTIONS_CHANGED");
        intent.setPackage(str);
        intent.addFlags(1073741824);
        this.mContext.sendBroadcastAsUser(intent, userHandle);
    }

    public /* synthetic */ void lambda$setBackwardsCompatibleAppRestrictions$95(String str, Bundle bundle, UserHandle userHandle) {
        this.mUserManager.setApplicationRestrictions(str, bundle, userHandle);
    }

    public final Bundle getAppRestrictionsSetByAnyAdmin(String str, UserHandle userHandle) {
        LinkedHashMap localPoliciesSetByAdmins = this.mDevicePolicyEngine.getLocalPoliciesSetByAdmins(PolicyDefinition.APPLICATION_RESTRICTIONS(str), userHandle.getIdentifier());
        if (localPoliciesSetByAdmins.isEmpty()) {
            return null;
        }
        return (Bundle) ((PolicyValue) ((Map.Entry) localPoliciesSetByAdmins.entrySet().stream().findAny().get()).getValue()).getValue();
    }

    public final int getUidForPackage(final String str, final int i) {
        return ((Integer) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda224
            public final Object getOrThrow() {
                Integer lambda$getUidForPackage$96;
                lambda$getUidForPackage$96 = DevicePolicyManagerService.this.lambda$getUidForPackage$96(str, i);
                return lambda$getUidForPackage$96;
            }
        })).intValue();
    }

    public /* synthetic */ Integer lambda$getUidForPackage$96(String str, int i) {
        try {
            return Integer.valueOf(this.mContext.getPackageManager().getApplicationInfoAsUser(str, 0, i).uid);
        } catch (PackageManager.NameNotFoundException unused) {
            return -1;
        }
    }

    public void setTrustAgentConfiguration(ComponentName componentName, String str, ComponentName componentName2, PersistableBundle persistableBundle, boolean z) {
        ActiveAdmin activeAdminForCallerLocked;
        if (this.mHasFeature && this.mLockPatternUtils.hasSecureLockScreen()) {
            if (!isPermissionCheckFlagEnabled()) {
                Objects.requireNonNull(componentName, "admin is null");
            }
            Objects.requireNonNull(componentName2, "agent is null");
            enforceMaxPackageNameLength(componentName2.getPackageName());
            String flattenToString = componentName2.flattenToString();
            enforceMaxStringLength(flattenToString, "agent name");
            if (persistableBundle != null) {
                enforceMaxStringLength(persistableBundle, "args");
            }
            int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            synchronized (getLockObject()) {
                if (isPermissionCheckFlagEnabled()) {
                    activeAdminForCallerLocked = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_KEYGUARD", 9, getCallerIdentity(componentName, str).getPackageName(), z ? getProfileParentId(userHandleGetCallingUserId) : userHandleGetCallingUserId).getActiveAdmin();
                } else {
                    activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 9, z);
                }
                checkCanExecuteOrThrowUnsafe(21);
                activeAdminForCallerLocked.trustAgentInfos.put(flattenToString, new ActiveAdmin.TrustAgentInfo(persistableBundle));
                saveSettingsLocked(userHandleGetCallingUserId);
            }
        }
    }

    public List getTrustAgentConfiguration(ComponentName componentName, ComponentName componentName2, int i, boolean z) {
        PersistableBundle persistableBundle;
        if (!this.mHasFeature || !this.mLockPatternUtils.hasSecureLockScreen()) {
            return null;
        }
        Objects.requireNonNull(componentName2, "agent null");
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(componentName), i));
        synchronized (getLockObject()) {
            String flattenToString = componentName2.flattenToString();
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i, z);
                if (activeAdminUncheckedLocked == null) {
                    return null;
                }
                ActiveAdmin.TrustAgentInfo trustAgentInfo = (ActiveAdmin.TrustAgentInfo) activeAdminUncheckedLocked.trustAgentInfos.get(flattenToString);
                if (trustAgentInfo != null && trustAgentInfo.options != null) {
                    ArrayList arrayList = new ArrayList();
                    arrayList.add(trustAgentInfo.options);
                    return arrayList;
                }
                return null;
            }
            List activeAdminsForLockscreenPoliciesLocked = getActiveAdminsForLockscreenPoliciesLocked(getProfileParentUserIfRequested(i, z));
            int size = activeAdminsForLockscreenPoliciesLocked.size();
            boolean z2 = false;
            int i2 = 0;
            ArrayList arrayList2 = null;
            while (true) {
                if (i2 >= size) {
                    z2 = true;
                    break;
                }
                ActiveAdmin activeAdmin = (ActiveAdmin) activeAdminsForLockscreenPoliciesLocked.get(i2);
                boolean z3 = (activeAdmin.disabledKeyguardFeatures & 16) != 0;
                ActiveAdmin.TrustAgentInfo trustAgentInfo2 = (ActiveAdmin.TrustAgentInfo) activeAdmin.trustAgentInfos.get(flattenToString);
                if (trustAgentInfo2 == null || (persistableBundle = trustAgentInfo2.options) == null || persistableBundle.isEmpty()) {
                    if (z3) {
                        break;
                    }
                } else if (z3) {
                    if (arrayList2 == null) {
                        arrayList2 = new ArrayList();
                    }
                    arrayList2.add(trustAgentInfo2.options);
                } else {
                    Slogf.w("DevicePolicyManager", "Ignoring admin %s because it has trust options but doesn't declare KEYGUARD_DISABLE_TRUST_AGENTS", activeAdmin.info);
                }
                i2++;
            }
            return z2 ? arrayList2 : null;
        }
    }

    public void setRestrictionsProvider(ComponentName componentName, ComponentName componentName2) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        checkCanExecuteOrThrowUnsafe(39);
        synchronized (getLockObject()) {
            int userId = callerIdentity.getUserId();
            lambda$getUserDataUnchecked$2(userId).mRestrictionsProvider = componentName2;
            saveSettingsLocked(userId);
        }
    }

    public ComponentName getRestrictionsProvider(int i) {
        ComponentName componentName;
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()), String.format("Only the system can %s", "query the permission provider"));
        synchronized (getLockObject()) {
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            componentName = lambda$getUserDataUnchecked$2 != null ? lambda$getUserDataUnchecked$2.mRestrictionsProvider : null;
        }
        return componentName;
    }

    public void addCrossProfileIntentFilter(ComponentName componentName, String str, IntentFilter intentFilter, int i) {
        Injector injector;
        UserInfo profileParent;
        CallerIdentity callerIdentity = isPermissionCheckFlagEnabled() ? getCallerIdentity(componentName, str) : getCallerIdentity(componentName);
        int userId = callerIdentity.getUserId();
        if (isPermissionCheckFlagEnabled()) {
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_PROFILE_INTERACTION", callerIdentity.getPackageName(), userId);
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        }
        synchronized (getLockObject()) {
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                try {
                    profileParent = this.mUserManager.getProfileParent(userId);
                } catch (RemoteException e) {
                    Slogf.wtf("DevicePolicyManager", "Error adding cross profile intent filter", e);
                    injector = this.mInjector;
                }
                if (profileParent == null) {
                    Slogf.e("DevicePolicyManager", "Cannot call addCrossProfileIntentFilter if there is no parent");
                    return;
                }
                if ((i & 1) != 0) {
                    this.mIPackageManager.addCrossProfileIntentFilter(intentFilter, componentName.getPackageName(), userId, profileParent.id, 0);
                }
                if ((i & 2) != 0) {
                    this.mIPackageManager.addCrossProfileIntentFilter(intentFilter, componentName.getPackageName(), profileParent.id, userId, 0);
                }
                injector = this.mInjector;
                injector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                DevicePolicyEventLogger.createEvent(48).setAdmin(callerIdentity.getPackageName()).setStrings(getIntentFilterActions(intentFilter)).setInt(i).write();
            } finally {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        }
    }

    public static String[] getIntentFilterActions(IntentFilter intentFilter) {
        if (intentFilter == null) {
            return null;
        }
        int countActions = intentFilter.countActions();
        String[] strArr = new String[countActions];
        for (int i = 0; i < countActions; i++) {
            strArr[i] = intentFilter.getAction(i);
        }
        return strArr;
    }

    public void clearCrossProfileIntentFilters(ComponentName componentName, String str) {
        Injector injector;
        UserInfo profileParent;
        CallerIdentity callerIdentity = isPermissionCheckFlagEnabled() ? getCallerIdentity(componentName, str) : getCallerIdentity(componentName);
        int userId = callerIdentity.getUserId();
        if (isPermissionCheckFlagEnabled()) {
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_PROFILE_INTERACTION", callerIdentity.getPackageName(), userId);
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        }
        synchronized (getLockObject()) {
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                try {
                    profileParent = this.mUserManager.getProfileParent(userId);
                } catch (RemoteException e) {
                    Slogf.wtf("DevicePolicyManager", "Error clearing cross profile intent filters", e);
                    injector = this.mInjector;
                }
                if (profileParent == null) {
                    Slogf.e("DevicePolicyManager", "Cannot call clearCrossProfileIntentFilter if there is no parent");
                    return;
                }
                this.mIPackageManager.clearCrossProfileIntentFilters(userId, componentName.getPackageName());
                this.mIPackageManager.clearCrossProfileIntentFilters(profileParent.id, componentName.getPackageName());
                injector = this.mInjector;
                injector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            } finally {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        }
    }

    /* JADX WARN: Code restructure failed: missing block: B:16:0x0037, code lost:
    
        if ((r5.flags & 1) != 0) goto L64;
     */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public final boolean checkPackagesInPermittedListOrSystem(java.util.List r9, java.util.List r10, int r11) {
        /*
            r8 = this;
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r0 = r8.mInjector
            long r0 = r0.binderClearCallingIdentity()
            android.content.pm.UserInfo r2 = r8.getUserInfo(r11)     // Catch: java.lang.Throwable -> L52
            boolean r3 = r2.isManagedProfile()     // Catch: java.lang.Throwable -> L52
            if (r3 == 0) goto L12
            int r11 = r2.profileGroupId     // Catch: java.lang.Throwable -> L52
        L12:
            java.util.Iterator r9 = r9.iterator()     // Catch: java.lang.Throwable -> L52
        L16:
            boolean r2 = r9.hasNext()     // Catch: java.lang.Throwable -> L52
            r3 = 1
            if (r2 == 0) goto L4c
            java.lang.Object r2 = r9.next()     // Catch: java.lang.Throwable -> L52
            java.lang.String r2 = (java.lang.String) r2     // Catch: java.lang.Throwable -> L52
            r4 = 0
            android.content.pm.IPackageManager r5 = r8.mIPackageManager     // Catch: android.os.RemoteException -> L3a java.lang.Throwable -> L52
            r6 = 8192(0x2000, double:4.0474E-320)
            android.content.pm.ApplicationInfo r5 = r5.getApplicationInfo(r2, r6, r11)     // Catch: android.os.RemoteException -> L3a java.lang.Throwable -> L52
            if (r5 != 0) goto L34
        L2e:
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r8 = r8.mInjector
            r8.binderRestoreCallingIdentity(r0)
            return r4
        L34:
            int r5 = r5.flags     // Catch: android.os.RemoteException -> L3a java.lang.Throwable -> L52
            r5 = r5 & r3
            if (r5 == 0) goto L42
            goto L43
        L3a:
            r3 = move-exception
            java.lang.String r5 = "DevicePolicyManager"
            java.lang.String r6 = "Can't talk to package managed"
            com.android.server.utils.Slogf.i(r5, r6, r3)     // Catch: java.lang.Throwable -> L52
        L42:
            r3 = r4
        L43:
            if (r3 != 0) goto L16
            boolean r2 = r10.contains(r2)     // Catch: java.lang.Throwable -> L52
            if (r2 != 0) goto L16
            goto L2e
        L4c:
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r8 = r8.mInjector
            r8.binderRestoreCallingIdentity(r0)
            return r3
        L52:
            r9 = move-exception
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r8 = r8.mInjector
            r8.binderRestoreCallingIdentity(r0)
            throw r9
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.checkPackagesInPermittedListOrSystem(java.util.List, java.util.List, int):boolean");
    }

    public final Object withAccessibilityManager(int i, Function function) {
        IBinder service = ServiceManager.getService("accessibility");
        AccessibilityManager accessibilityManager = new AccessibilityManager(this.mContext, service == null ? null : IAccessibilityManager.Stub.asInterface(service), i);
        try {
            return function.apply(accessibilityManager);
        } finally {
            accessibilityManager.removeClient();
        }
    }

    public boolean setPermittedAccessibilityServices(ComponentName componentName, List list) {
        if (!this.mHasFeature) {
            return false;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        if (list != null) {
            Iterator it = list.iterator();
            while (it.hasNext()) {
                enforceMaxPackageNameLength((String) it.next());
            }
            int userId = callerIdentity.getUserId();
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                UserInfo userInfo = getUserInfo(userId);
                if (userInfo.isManagedProfile()) {
                    userId = userInfo.profileGroupId;
                }
                List list2 = (List) withAccessibilityManager(userId, new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda5
                    @Override // java.util.function.Function
                    public final Object apply(Object obj) {
                        List enabledAccessibilityServiceList;
                        enabledAccessibilityServiceList = ((AccessibilityManager) obj).getEnabledAccessibilityServiceList(-1);
                        return enabledAccessibilityServiceList;
                    }
                });
                if (list2 != null) {
                    ArrayList arrayList = new ArrayList();
                    Iterator it2 = list2.iterator();
                    while (it2.hasNext()) {
                        arrayList.add(((AccessibilityServiceInfo) it2.next()).getResolveInfo().serviceInfo.packageName);
                    }
                    if (!checkPackagesInPermittedListOrSystem(arrayList, list, userId)) {
                        Slogf.e("DevicePolicyManager", "Cannot set permitted accessibility services, because it contains already enabled accesibility services.");
                        return false;
                    }
                }
            } finally {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        }
        synchronized (getLockObject()) {
            getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()).permittedAccessiblityServices = list;
            saveSettingsLocked(UserHandle.getCallingUserId());
        }
        DevicePolicyEventLogger.createEvent(28).setAdmin(componentName).setStrings(list != null ? (String[]) list.toArray(new String[0]) : null).write();
        return true;
    }

    public List getPermittedAccessibilityServices(ComponentName componentName) {
        List list;
        if (!this.mHasFeature) {
            return null;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        synchronized (getLockObject()) {
            list = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()).permittedAccessiblityServices;
        }
        return list;
    }

    public List getPermittedAccessibilityServicesForUser(int i) {
        ArrayList arrayList = null;
        if (!this.mHasFeature) {
            return null;
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(canManageUsers(callerIdentity) || canQueryAdminPolicy(callerIdentity));
        synchronized (getLockObject()) {
            for (int i2 : this.mUserManager.getProfileIdsWithDisabled(i)) {
                DevicePolicyData userDataUnchecked = getUserDataUnchecked(i2);
                int size = userDataUnchecked.mAdminList.size();
                for (int i3 = 0; i3 < size; i3++) {
                    List list = ((ActiveAdmin) userDataUnchecked.mAdminList.get(i3)).permittedAccessiblityServices;
                    if (list != null) {
                        if (arrayList == null) {
                            arrayList = new ArrayList(list);
                        } else {
                            arrayList.retainAll(list);
                        }
                    }
                }
            }
        }
        if (arrayList != null) {
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                UserInfo userInfo = getUserInfo(i);
                if (userInfo.isManagedProfile()) {
                    i = userInfo.profileGroupId;
                }
                List list2 = (List) withAccessibilityManager(i, new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda94
                    @Override // java.util.function.Function
                    public final Object apply(Object obj) {
                        return ((AccessibilityManager) obj).getInstalledAccessibilityServiceList();
                    }
                });
                if (list2 != null) {
                    Iterator it = list2.iterator();
                    while (it.hasNext()) {
                        ServiceInfo serviceInfo = ((AccessibilityServiceInfo) it.next()).getResolveInfo().serviceInfo;
                        if ((serviceInfo.applicationInfo.flags & 1) != 0) {
                            arrayList.add(serviceInfo.packageName);
                        }
                    }
                }
            } finally {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        }
        return arrayList;
    }

    public boolean isAccessibilityServicePermittedByAdmin(ComponentName componentName, String str, int i) {
        if (!this.mHasFeature) {
            return true;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkStringNotEmpty(str, "packageName is null");
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()), String.format("Only the system can %s", "query if an accessibility service is disabled by admin"));
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
            if (activeAdminUncheckedLocked == null) {
                return false;
            }
            if (activeAdminUncheckedLocked.permittedAccessiblityServices == null) {
                return true;
            }
            return checkPackagesInPermittedListOrSystem(Collections.singletonList(str), activeAdminUncheckedLocked.permittedAccessiblityServices, i);
        }
    }

    public boolean setPermittedInputMethods(ComponentName componentName, String str, List list, boolean z) {
        CallerIdentity callerIdentity;
        if (!this.mHasFeature) {
            return false;
        }
        if (isPolicyEngineForFinanceFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
            Objects.requireNonNull(componentName, "ComponentName is null");
        }
        final int profileParentUserIfRequested = getProfileParentUserIfRequested(callerIdentity.getUserId(), z);
        if (z) {
            if (!isPolicyEngineForFinanceFlagEnabled()) {
                Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
            }
            Preconditions.checkArgument(list == null || list.isEmpty(), "Permitted input methods must allow all input methods or only system input methods when called on the parent instance of an organization-owned device");
        } else if (!isPolicyEngineForFinanceFlagEnabled()) {
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        }
        if (list != null) {
            Iterator it = list.iterator();
            while (it.hasNext()) {
                enforceMaxPackageNameLength((String) it.next());
            }
            List list2 = (List) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda96
                public final Object getOrThrow() {
                    List lambda$setPermittedInputMethods$98;
                    lambda$setPermittedInputMethods$98 = DevicePolicyManagerService.lambda$setPermittedInputMethods$98(profileParentUserIfRequested);
                    return lambda$setPermittedInputMethods$98;
                }
            });
            if (list2 != null) {
                ArrayList arrayList = new ArrayList();
                Iterator it2 = list2.iterator();
                while (it2.hasNext()) {
                    arrayList.add(((InputMethodInfo) it2.next()).getPackageName());
                }
                if (!checkPackagesInPermittedListOrSystem(arrayList, list, profileParentUserIfRequested)) {
                    Slogf.e("DevicePolicyManager", "Cannot set permitted input methods, because the list of permitted input methods excludes an already-enabled input method.");
                    return false;
                }
            }
        }
        synchronized (getLockObject()) {
            if (isPolicyEngineForFinanceFlagEnabled()) {
                EnforcingAdmin enforcePermissionAndGetEnforcingAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_INPUT_METHODS", callerIdentity.getPackageName(), profileParentUserIfRequested);
                if (list == null) {
                    this.mDevicePolicyEngine.removeLocalPolicy(PolicyDefinition.PERMITTED_INPUT_METHODS, enforcePermissionAndGetEnforcingAdmin, profileParentUserIfRequested);
                } else {
                    this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.PERMITTED_INPUT_METHODS, enforcePermissionAndGetEnforcingAdmin, new StringSetPolicyValue(new HashSet(list)), profileParentUserIfRequested);
                }
            } else {
                getParentOfAdminIfRequired(getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()), z).permittedInputMethods = list;
                saveSettingsLocked(callerIdentity.getUserId());
            }
        }
        DevicePolicyEventLogger.createEvent(27).setAdmin(callerIdentity.getPackageName()).setStrings(getStringArrayForLogging(list, z)).write();
        return true;
    }

    public static /* synthetic */ List lambda$setPermittedInputMethods$98(int i) {
        return InputMethodManagerInternal.get().getEnabledInputMethodListAsUser(i);
    }

    public final String[] getStringArrayForLogging(List list, boolean z) {
        ArrayList arrayList = new ArrayList();
        arrayList.add(z ? "calledFromParent" : "notCalledFromParent");
        if (list == null) {
            arrayList.add("nullStringArray");
        } else {
            arrayList.addAll(list);
        }
        return (String[]) arrayList.toArray(new String[0]);
    }

    public List getPermittedInputMethods(ComponentName componentName, String str, boolean z) {
        CallerIdentity callerIdentity;
        int userId;
        ArrayList arrayList = null;
        if (!this.mHasFeature) {
            return null;
        }
        if (isPolicyEngineForFinanceFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            CallerIdentity callerIdentity2 = getCallerIdentity(componentName);
            Objects.requireNonNull(componentName, "ComponentName is null");
            callerIdentity = callerIdentity2;
        }
        if (!isPolicyEngineForFinanceFlagEnabled()) {
            if (z) {
                Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
            } else {
                Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
            }
        }
        synchronized (getLockObject()) {
            if (isPolicyEngineForFinanceFlagEnabled()) {
                if (z) {
                    userId = getProfileParentId(callerIdentity.getUserId());
                } else {
                    userId = callerIdentity.getUserId();
                }
                Set set = (Set) this.mDevicePolicyEngine.getResolvedPolicy(PolicyDefinition.PERMITTED_INPUT_METHODS, userId);
                if (set != null) {
                    arrayList = new ArrayList(set);
                }
                return arrayList;
            }
            return getParentOfAdminIfRequired(getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()), z).permittedInputMethods;
        }
    }

    public List getPermittedInputMethodsAsUser(int i) {
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i));
        Preconditions.checkCallAuthorization(canManageUsers(callerIdentity) || canQueryAdminPolicy(callerIdentity));
        long clearCallingIdentity = Binder.clearCallingIdentity();
        try {
            return getPermittedInputMethodsUnchecked(i);
        } finally {
            Binder.restoreCallingIdentity(clearCallingIdentity);
        }
    }

    public final List getPermittedInputMethodsUnchecked(int i) {
        List inputMethodListAsUser;
        ArrayList arrayList = null;
        if (isPolicyEngineForFinanceFlagEnabled()) {
            Set set = (Set) this.mDevicePolicyEngine.getResolvedPolicy(PolicyDefinition.PERMITTED_INPUT_METHODS, i);
            if (set != null) {
                arrayList = new ArrayList(set);
            }
        } else {
            synchronized (getLockObject()) {
                Iterator it = getActiveAdminsForAffectedUserInclPermissionBasedAdminLocked(i).iterator();
                while (it.hasNext()) {
                    List list = ((ActiveAdmin) it.next()).permittedInputMethods;
                    if (list != null) {
                        if (arrayList == null) {
                            arrayList = new ArrayList(list);
                        } else {
                            arrayList.retainAll(list);
                        }
                    }
                }
            }
        }
        if (arrayList != null && (inputMethodListAsUser = InputMethodManagerInternal.get().getInputMethodListAsUser(i)) != null) {
            Iterator it2 = inputMethodListAsUser.iterator();
            while (it2.hasNext()) {
                ServiceInfo serviceInfo = ((InputMethodInfo) it2.next()).getServiceInfo();
                if ((serviceInfo.applicationInfo.flags & 1) != 0) {
                    arrayList.add(serviceInfo.packageName);
                }
            }
        }
        return arrayList;
    }

    public boolean isInputMethodPermittedByAdmin(ComponentName componentName, String str, int i, boolean z) {
        if (!this.mHasFeature) {
            return true;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkStringNotEmpty(str, "packageName is null");
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()), String.format("Only the system can %s", "query if an input method is disabled by admin"));
        if (isPolicyEngineForFinanceFlagEnabled()) {
            if (z) {
                i = getProfileParentId(i);
            }
            LinkedHashMap localPoliciesSetByAdmins = this.mDevicePolicyEngine.getLocalPoliciesSetByAdmins(PolicyDefinition.PERMITTED_INPUT_METHODS, i);
            for (EnforcingAdmin enforcingAdmin : localPoliciesSetByAdmins.keySet()) {
                if (enforcingAdmin.getPackageName().equals(componentName.getPackageName())) {
                    if (((PolicyValue) localPoliciesSetByAdmins.get(enforcingAdmin)).getValue() == null) {
                        return true;
                    }
                    return checkPackagesInPermittedListOrSystem(Collections.singletonList(str), new ArrayList((Collection) ((PolicyValue) localPoliciesSetByAdmins.get(enforcingAdmin)).getValue()), i);
                }
            }
            return false;
        }
        synchronized (getLockObject()) {
            ActiveAdmin parentOfAdminIfRequired = getParentOfAdminIfRequired(getActiveAdminUncheckedLocked(componentName, i), z);
            if (parentOfAdminIfRequired == null) {
                return false;
            }
            if (parentOfAdminIfRequired.permittedInputMethods == null) {
                return true;
            }
            return checkPackagesInPermittedListOrSystem(Collections.singletonList(str), parentOfAdminIfRequired.permittedInputMethods, i);
        }
    }

    public boolean setPermittedCrossProfileNotificationListeners(ComponentName componentName, List list) {
        if (!this.mHasFeature) {
            return false;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        if (!isManagedProfile(callerIdentity.getUserId())) {
            return false;
        }
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
        synchronized (getLockObject()) {
            getProfileOwnerLocked(callerIdentity.getUserId()).permittedNotificationListeners = list;
            saveSettingsLocked(callerIdentity.getUserId());
        }
        return true;
    }

    public List getPermittedCrossProfileNotificationListeners(ComponentName componentName) {
        List list;
        if (!this.mHasFeature) {
            return null;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        synchronized (getLockObject()) {
            list = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()).permittedNotificationListeners;
        }
        return list;
    }

    public boolean isNotificationListenerServicePermitted(String str, int i) {
        if (!this.mHasFeature) {
            return true;
        }
        Preconditions.checkStringNotEmpty(str, "packageName is null or empty");
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()), String.format("Only the system can %s", "query if a notification listener service is permitted"));
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            if (profileOwnerAdminLocked != null && profileOwnerAdminLocked.permittedNotificationListeners != null) {
                return checkPackagesInPermittedListOrSystem(Collections.singletonList(str), profileOwnerAdminLocked.permittedNotificationListeners, i);
            }
            return true;
        }
    }

    public final void maybeSendAdminEnabledBroadcastLocked(int i) {
        boolean z;
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
        if (lambda$getUserDataUnchecked$2.mAdminBroadcastPending) {
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            if (profileOwnerAdminLocked != null) {
                PersistableBundle persistableBundle = lambda$getUserDataUnchecked$2.mInitBundle;
                z = sendAdminCommandLocked(profileOwnerAdminLocked, "android.app.action.DEVICE_ADMIN_ENABLED", persistableBundle == null ? null : new Bundle(persistableBundle), null, true);
            } else {
                z = true;
            }
            if (z) {
                lambda$getUserDataUnchecked$2.mInitBundle = null;
                lambda$getUserDataUnchecked$2.mAdminBroadcastPending = false;
                saveSettingsLocked(i);
            }
        }
    }

    /* JADX WARN: Removed duplicated region for block: B:51:0x0122  */
    /* JADX WARN: Removed duplicated region for block: B:55:0x012d  */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public android.os.UserHandle createAndManageUser(android.content.ComponentName r23, java.lang.String r24, android.content.ComponentName r25, android.os.PersistableBundle r26, int r27) {
        /*
            Method dump skipped, instructions count: 432
            To view this dump change 'Code comments level' option to 'DEBUG'
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.createAndManageUser(android.content.ComponentName, java.lang.String, android.content.ComponentName, android.os.PersistableBundle, int):android.os.UserHandle");
    }

    public final void sendProvisioningCompletedBroadcast(int i, String str, boolean z) {
        this.mContext.sendBroadcastAsUser(new Intent("android.app.action.PROVISIONING_COMPLETED").putExtra("android.intent.extra.user_handle", i).putExtra("android.intent.extra.USER", UserHandle.of(i)).putExtra("android.app.extra.PROVISIONING_LEAVE_ALL_SYSTEM_APPS_ENABLED", z).putExtra("android.app.extra.PROVISIONING_ACTION", str).setPackage(getManagedProvisioningPackage(this.mContext)).addFlags(268435456), UserHandle.SYSTEM);
    }

    public final void manageUserUnchecked(ComponentName componentName, ComponentName componentName2, final int i, PersistableBundle persistableBundle, boolean z) {
        synchronized (getLockObject()) {
        }
        final String packageName = componentName.getPackageName();
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda172
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$manageUserUnchecked$99(packageName, i);
            }
        });
        setActiveAdmin(componentName2, true, i);
        setProfileOwner(componentName2, i);
        synchronized (getLockObject()) {
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            lambda$getUserDataUnchecked$2.mInitBundle = persistableBundle;
            lambda$getUserDataUnchecked$2.mAdminBroadcastPending = true;
            lambda$getUserDataUnchecked$2.mNewUserDisclaimer = z ? "needed" : "not_needed";
            saveSettingsLocked(i);
        }
    }

    public /* synthetic */ void lambda$manageUserUnchecked$99(String str, int i) {
        try {
            if (this.mIPackageManager.isPackageAvailable(str, i)) {
                return;
            }
            this.mIPackageManager.installExistingPackageAsUser(str, i, 4194304, 1, (List) null);
        } catch (RemoteException e) {
            Slogf.wtf("DevicePolicyManager", e, "Failed to install admin package %s for user %d", str, Integer.valueOf(i));
        }
    }

    public final void handleNewUserCreated(UserInfo userInfo, Object obj) {
        int i = userInfo.id;
        if (isPolicyEngineForFinanceFlagEnabled() || isPermissionCheckFlagEnabled()) {
            this.mDevicePolicyEngine.handleUserCreated(userInfo);
        }
        if (obj != null) {
            synchronized (getLockObject()) {
                if (this.mPendingUserCreatedCallbackTokens.contains(obj)) {
                    Slogf.d("DevicePolicyManager", "handleNewUserCreated(): ignoring for user " + i + " due to token " + obj);
                    this.mPendingUserCreatedCallbackTokens.remove(obj);
                    return;
                }
            }
        }
        if (!this.mOwners.hasDeviceOwner() || !userInfo.isFull() || userInfo.isManagedProfile() || userInfo.isGuest()) {
            return;
        }
        if (this.mInjector.userManagerIsHeadlessSystemUserMode()) {
            ComponentName deviceOwnerComponent = this.mOwners.getDeviceOwnerComponent();
            Slogf.i("DevicePolicyManager", "Automatically setting profile owner (" + deviceOwnerComponent + ") on new user " + i);
            manageUserUnchecked(deviceOwnerComponent, deviceOwnerComponent, i, null, true);
            return;
        }
        Slogf.i("DevicePolicyManager", "User %d added on DO mode; setting ShowNewUserDisclaimer", Integer.valueOf(i));
        setShowNewUserDisclaimer(i, "needed");
    }

    public void acknowledgeNewUserDisclaimer(int i) {
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.INTERACT_ACROSS_USERS"));
        setShowNewUserDisclaimer(i, "acked");
    }

    public final void setShowNewUserDisclaimer(int i, String str) {
        Slogf.i("DevicePolicyManager", "Setting new user disclaimer for user " + i + " as " + str);
        synchronized (getLockObject()) {
            lambda$getUserDataUnchecked$2(i).mNewUserDisclaimer = str;
            saveSettingsLocked(i);
        }
    }

    public final void showNewUserDisclaimerIfNecessary(int i) {
        boolean equals;
        synchronized (getLockObject()) {
            equals = "needed".equals(lambda$getUserDataUnchecked$2(i).mNewUserDisclaimer);
        }
        if (equals) {
            Intent intent = new Intent("android.app.action.SHOW_NEW_USER_DISCLAIMER");
            Slogf.i("DevicePolicyManager", "Dispatching ACTION_SHOW_NEW_USER_DISCLAIMER intent");
            this.mContext.sendBroadcastAsUser(intent, UserHandle.of(i));
        }
    }

    public boolean isNewUserDisclaimerAcknowledged(int i) {
        boolean isNewUserDisclaimerAcknowledged;
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.INTERACT_ACROSS_USERS"));
        synchronized (getLockObject()) {
            isNewUserDisclaimerAcknowledged = lambda$getUserDataUnchecked$2(i).isNewUserDisclaimerAcknowledged();
        }
        return isNewUserDisclaimerAcknowledged;
    }

    public boolean removeUser(final ComponentName componentName, final UserHandle userHandle) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        Objects.requireNonNull(userHandle, "UserHandle is null");
        final CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity));
        checkCanExecuteOrThrowUnsafe(6);
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda149
            public final Object getOrThrow() {
                Boolean lambda$removeUser$100;
                lambda$removeUser$100 = DevicePolicyManagerService.this.lambda$removeUser$100(userHandle, componentName, callerIdentity);
                return lambda$removeUser$100;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$removeUser$100(UserHandle userHandle, ComponentName componentName, CallerIdentity callerIdentity) {
        String str = isManagedProfile(userHandle.getIdentifier()) ? "no_remove_managed_profile" : "no_remove_user";
        if (isAdminAffectedByRestriction(componentName, str, callerIdentity.getUserId())) {
            Slogf.w("DevicePolicyManager", "The device owner cannot remove a user because %s is enabled, and was not set by the device owner", str);
            return Boolean.FALSE;
        }
        boolean removeUserEvenWhenDisallowed = this.mUserManagerInternal.removeUserEvenWhenDisallowed(userHandle.getIdentifier());
        Slogf.w("DevicePolicyManager", "[after removeUserEvenWhenDisallowed] removeUserEvenWhenDisallowed = " + removeUserEvenWhenDisallowed);
        return Boolean.valueOf(removeUserEvenWhenDisallowed);
    }

    public final boolean isAdminAffectedByRestriction(ComponentName componentName, String str, int i) {
        int userRestrictionSource = this.mUserManager.getUserRestrictionSource(str, UserHandle.of(i));
        if (userRestrictionSource == 0) {
            return false;
        }
        if (userRestrictionSource == 2 || userRestrictionSource == 4) {
            return (isDeviceOwner(componentName, i) || isProfileOwner(componentName, i)) ? false : true;
        }
        return true;
    }

    /* JADX WARN: Removed duplicated region for block: B:16:0x0090 A[Catch: all -> 0x00a2, TryCatch #1 {, blocks: (B:4:0x001d, B:31:0x0069, B:33:0x0070, B:34:0x0073, B:23:0x0097, B:25:0x009e, B:26:0x00a1, B:14:0x0089, B:16:0x0090, B:17:0x0093), top: B:3:0x001d }] */
    /* JADX WARN: Removed duplicated region for block: B:25:0x009e A[Catch: all -> 0x00a2, TryCatch #1 {, blocks: (B:4:0x001d, B:31:0x0069, B:33:0x0070, B:34:0x0073, B:23:0x0097, B:25:0x009e, B:26:0x00a1, B:14:0x0089, B:16:0x0090, B:17:0x0093), top: B:3:0x001d }] */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public boolean switchUser(android.content.ComponentName r11, android.os.UserHandle r12) {
        /*
            r10 = this;
            java.lang.String r0 = "ComponentName is null"
            java.util.Objects.requireNonNull(r11, r0)
            com.android.server.devicepolicy.CallerIdentity r11 = r10.getCallerIdentity(r11)
            boolean r11 = r10.isDefaultDeviceOwner(r11)
            com.android.internal.util.Preconditions.checkCallAuthorization(r11)
            r11 = 2
            r10.checkCanExecuteOrThrowUnsafe(r11)
            int r0 = r10.getLogoutUserIdUnchecked()
            java.lang.Object r1 = r10.getLockObject()
            monitor-enter(r1)
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r2 = r10.mInjector     // Catch: java.lang.Throwable -> La2
            long r2 = r2.binderClearCallingIdentity()     // Catch: java.lang.Throwable -> La2
            r4 = 0
            if (r12 == 0) goto L2b
            int r12 = r12.getIdentifier()     // Catch: java.lang.Throwable -> L7e android.os.RemoteException -> L80
            goto L2c
        L2b:
            r12 = r4
        L2c:
            java.lang.String r5 = "DevicePolicyManager"
            java.lang.String r6 = "Switching to user %d (logout user is %d)"
            java.lang.Object[] r11 = new java.lang.Object[r11]     // Catch: java.lang.Throwable -> L7e android.os.RemoteException -> L80
            java.lang.Integer r7 = java.lang.Integer.valueOf(r12)     // Catch: java.lang.Throwable -> L7e android.os.RemoteException -> L80
            r11[r4] = r7     // Catch: java.lang.Throwable -> L7e android.os.RemoteException -> L80
            java.lang.Integer r7 = java.lang.Integer.valueOf(r0)     // Catch: java.lang.Throwable -> L7e android.os.RemoteException -> L80
            r8 = 1
            r11[r8] = r7     // Catch: java.lang.Throwable -> L7e android.os.RemoteException -> L80
            com.android.server.utils.Slogf.i(r5, r6, r11)     // Catch: java.lang.Throwable -> L7e android.os.RemoteException -> L80
            r11 = -2
            r10.setLogoutUserIdLocked(r11)     // Catch: java.lang.Throwable -> L7e android.os.RemoteException -> L80
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r11 = r10.mInjector     // Catch: java.lang.Throwable -> L7e android.os.RemoteException -> L80
            android.app.IActivityManager r11 = r11.getIActivityManager()     // Catch: java.lang.Throwable -> L7e android.os.RemoteException -> L80
            boolean r11 = r11.switchUser(r12)     // Catch: java.lang.Throwable -> L7e android.os.RemoteException -> L80
            if (r11 != 0) goto L62
            java.lang.String r5 = "DevicePolicyManager"
            java.lang.String r6 = "Failed to switch to user %d"
            java.lang.Object[] r7 = new java.lang.Object[r8]     // Catch: java.lang.Throwable -> L75 android.os.RemoteException -> L79
            java.lang.Integer r12 = java.lang.Integer.valueOf(r12)     // Catch: java.lang.Throwable -> L75 android.os.RemoteException -> L79
            r7[r4] = r12     // Catch: java.lang.Throwable -> L75 android.os.RemoteException -> L79
            com.android.server.utils.Slogf.w(r5, r6, r7)     // Catch: java.lang.Throwable -> L75 android.os.RemoteException -> L79
            goto L69
        L62:
            java.lang.String r12 = "DevicePolicyManager"
            java.lang.String r5 = "Switched"
            com.android.server.utils.Slogf.d(r12, r5)     // Catch: java.lang.Throwable -> L75 android.os.RemoteException -> L79
        L69:
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r12 = r10.mInjector     // Catch: java.lang.Throwable -> La2
            r12.binderRestoreCallingIdentity(r2)     // Catch: java.lang.Throwable -> La2
            if (r11 != 0) goto L73
            r10.setLogoutUserIdLocked(r0)     // Catch: java.lang.Throwable -> La2
        L73:
            monitor-exit(r1)     // Catch: java.lang.Throwable -> La2
            return r11
        L75:
            r12 = move-exception
            r4 = r11
            r11 = r12
            goto L97
        L79:
            r12 = move-exception
            r9 = r12
            r12 = r11
            r11 = r9
            goto L82
        L7e:
            r11 = move-exception
            goto L97
        L80:
            r11 = move-exception
            r12 = r4
        L82:
            java.lang.String r5 = "DevicePolicyManager"
            java.lang.String r6 = "Couldn't switch user"
            com.android.server.utils.Slogf.e(r5, r6, r11)     // Catch: java.lang.Throwable -> L95
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r11 = r10.mInjector     // Catch: java.lang.Throwable -> La2
            r11.binderRestoreCallingIdentity(r2)     // Catch: java.lang.Throwable -> La2
            if (r12 != 0) goto L93
            r10.setLogoutUserIdLocked(r0)     // Catch: java.lang.Throwable -> La2
        L93:
            monitor-exit(r1)     // Catch: java.lang.Throwable -> La2
            return r4
        L95:
            r11 = move-exception
            r4 = r12
        L97:
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r12 = r10.mInjector     // Catch: java.lang.Throwable -> La2
            r12.binderRestoreCallingIdentity(r2)     // Catch: java.lang.Throwable -> La2
            if (r4 != 0) goto La1
            r10.setLogoutUserIdLocked(r0)     // Catch: java.lang.Throwable -> La2
        La1:
            throw r11     // Catch: java.lang.Throwable -> La2
        La2:
            r10 = move-exception
            monitor-exit(r1)     // Catch: java.lang.Throwable -> La2
            throw r10
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.switchUser(android.content.ComponentName, android.os.UserHandle):boolean");
    }

    public int getLogoutUserId() {
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.INTERACT_ACROSS_USERS"));
        return getLogoutUserIdUnchecked();
    }

    public final int getLogoutUserIdUnchecked() {
        int i;
        synchronized (getLockObject()) {
            i = this.mLogoutUserId;
        }
        return i;
    }

    public final void clearLogoutUser() {
        synchronized (getLockObject()) {
            setLogoutUserIdLocked(-10000);
        }
    }

    public final void setLogoutUserIdLocked(int i) {
        if (i == -2) {
            i = getCurrentForegroundUserId();
        }
        Slogf.d("DevicePolicyManager", "setLogoutUserId(): %d -> %d", Integer.valueOf(this.mLogoutUserId), Integer.valueOf(i));
        this.mLogoutUserId = i;
    }

    public int startUserInBackground(ComponentName componentName, UserHandle userHandle) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        Objects.requireNonNull(userHandle, "UserHandle is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(getCallerIdentity(componentName)));
        checkCanExecuteOrThrowUnsafe(3);
        int identifier = userHandle.getIdentifier();
        if (isManagedProfile(identifier)) {
            Slogf.w("DevicePolicyManager", "Managed profile cannot be started in background");
            return 2;
        }
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
        } catch (RemoteException unused) {
        } catch (Throwable th) {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            throw th;
        }
        if (this.mInjector.getActivityManagerInternal().canStartMoreUsers()) {
            Slogf.i("DevicePolicyManager", "Starting user %d in background", Integer.valueOf(identifier));
            if (this.mInjector.getIActivityManager().startUserInBackground(identifier)) {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                return 0;
            }
            Slogf.w("DevicePolicyManager", "failed to start user %d in background", Integer.valueOf(identifier));
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            return 1;
        }
        Slogf.w("DevicePolicyManager", "Cannot start user %d, too many users in background", Integer.valueOf(identifier));
        this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        return 3;
    }

    public int stopUser(ComponentName componentName, UserHandle userHandle) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        Objects.requireNonNull(userHandle, "UserHandle is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(getCallerIdentity(componentName)));
        checkCanExecuteOrThrowUnsafe(4);
        int identifier = userHandle.getIdentifier();
        if (isManagedProfile(identifier)) {
            Slogf.w("DevicePolicyManager", "Managed profile cannot be stopped");
            return 2;
        }
        return stopUserUnchecked(identifier);
    }

    public int logoutUser(ComponentName componentName) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        checkCanExecuteOrThrowUnsafe(9);
        int userId = callerIdentity.getUserId();
        synchronized (getLockObject()) {
            if (!isUserAffiliatedWithDeviceLocked(userId)) {
                throw new SecurityException("Admin " + componentName + " is neither the device owner or affiliated user's profile owner.");
            }
        }
        if (isManagedProfile(userId)) {
            Slogf.w("DevicePolicyManager", "Managed profile cannot be logout");
            return 2;
        }
        if (userId != ((Integer) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda199
            public final Object getOrThrow() {
                Integer lambda$logoutUser$101;
                lambda$logoutUser$101 = DevicePolicyManagerService.this.lambda$logoutUser$101();
                return lambda$logoutUser$101;
            }
        })).intValue()) {
            Slogf.d("DevicePolicyManager", "logoutUser(): user %d is in background, just stopping, not switching", Integer.valueOf(userId));
            return stopUserUnchecked(userId);
        }
        return logoutUserUnchecked(userId);
    }

    public /* synthetic */ Integer lambda$logoutUser$101() {
        return Integer.valueOf(getCurrentForegroundUserId());
    }

    public int logoutUserInternal() {
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.INTERACT_ACROSS_USERS"));
        return logoutUserUnchecked(getCurrentForegroundUserId());
    }

    public final int logoutUserUnchecked(int i) {
        int logoutUserIdUnchecked = getLogoutUserIdUnchecked();
        if (logoutUserIdUnchecked == -10000) {
            Slogf.w("DevicePolicyManager", "logoutUser(): could not determine which user to switch to");
            return 1;
        }
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            Slogf.i("DevicePolicyManager", "logoutUser(): switching to user %d", Integer.valueOf(logoutUserIdUnchecked));
            if (!this.mInjector.getIActivityManager().switchUser(logoutUserIdUnchecked)) {
                Slogf.w("DevicePolicyManager", "Failed to switch to user %d", Integer.valueOf(logoutUserIdUnchecked));
                return 1;
            }
            clearLogoutUser();
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            return stopUserUnchecked(i);
        } catch (RemoteException unused) {
            return 1;
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public final int stopUserUnchecked(int i) {
        int stopUser;
        Slogf.i("DevicePolicyManager", "Stopping user %d", Integer.valueOf(i));
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            stopUser = this.mInjector.getIActivityManager().stopUser(i, true, (IStopUserCallback) null);
        } catch (RemoteException unused) {
        } catch (Throwable th) {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            throw th;
        }
        if (stopUser == -2) {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            return 4;
        }
        if (stopUser == 0) {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            return 0;
        }
        this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        return 1;
    }

    public List getSecondaryUsers(ComponentName componentName) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(getCallerIdentity(componentName)));
        return (List) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda74
            public final Object getOrThrow() {
                List lambda$getSecondaryUsers$102;
                lambda$getSecondaryUsers$102 = DevicePolicyManagerService.this.lambda$getSecondaryUsers$102();
                return lambda$getSecondaryUsers$102;
            }
        });
    }

    public /* synthetic */ List lambda$getSecondaryUsers$102() {
        List<UserInfo> aliveUsers = this.mInjector.getUserManager().getAliveUsers();
        ArrayList arrayList = new ArrayList();
        for (UserInfo userInfo : aliveUsers) {
            UserHandle userHandle = userInfo.getUserHandle();
            if (!userHandle.isSystem() && !isManagedProfile(userHandle.getIdentifier())) {
                arrayList.add(userInfo.getUserHandle());
            }
        }
        return arrayList;
    }

    public boolean isEphemeralUser(ComponentName componentName) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        final CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda188
            public final Object getOrThrow() {
                Boolean lambda$isEphemeralUser$103;
                lambda$isEphemeralUser$103 = DevicePolicyManagerService.this.lambda$isEphemeralUser$103(callerIdentity);
                return lambda$isEphemeralUser$103;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$isEphemeralUser$103(CallerIdentity callerIdentity) {
        return Boolean.valueOf(this.mInjector.getUserManager().isUserEphemeral(callerIdentity.getUserId()));
    }

    public Bundle getApplicationRestrictions(ComponentName componentName, String str, final String str2) {
        final CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        if (isUnicornFlagEnabled()) {
            EnforcingAdmin enforceCanQueryAndGetEnforcingAdmin = enforceCanQueryAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_APP_RESTRICTIONS", callerIdentity.getPackageName(), callerIdentity.getUserId());
            LinkedHashMap localPoliciesSetByAdmins = this.mDevicePolicyEngine.getLocalPoliciesSetByAdmins(PolicyDefinition.APPLICATION_RESTRICTIONS(str2), callerIdentity.getUserId());
            if (localPoliciesSetByAdmins.isEmpty() || !localPoliciesSetByAdmins.containsKey(enforceCanQueryAndGetEnforcingAdmin)) {
                return Bundle.EMPTY;
            }
            return (Bundle) ((PolicyValue) localPoliciesSetByAdmins.get(enforceCanQueryAndGetEnforcingAdmin)).getValue();
        }
        Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-app-restrictions")));
        return (Bundle) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda167
            public final Object getOrThrow() {
                Bundle lambda$getApplicationRestrictions$104;
                lambda$getApplicationRestrictions$104 = DevicePolicyManagerService.this.lambda$getApplicationRestrictions$104(str2, callerIdentity);
                return lambda$getApplicationRestrictions$104;
            }
        });
    }

    public /* synthetic */ Bundle lambda$getApplicationRestrictions$104(String str, CallerIdentity callerIdentity) {
        Bundle applicationRestrictions = this.mUserManager.getApplicationRestrictions(str, callerIdentity.getUserHandle());
        return applicationRestrictions != null ? applicationRestrictions : Bundle.EMPTY;
    }

    public final String[] populateNonExemptAndExemptFromPolicyApps(String[] strArr, Set set) {
        Preconditions.checkArgument(set.isEmpty(), "outputExemptApps is not empty");
        List listPolicyExemptAppsUnchecked = listPolicyExemptAppsUnchecked(this.mContext);
        if (listPolicyExemptAppsUnchecked.isEmpty()) {
            return strArr;
        }
        HashSet hashSet = new HashSet(listPolicyExemptAppsUnchecked);
        ArrayList arrayList = new ArrayList(strArr.length);
        for (String str : strArr) {
            if (hashSet.contains(str)) {
                set.add(str);
            } else {
                arrayList.add(str);
            }
        }
        String[] strArr2 = new String[arrayList.size()];
        arrayList.toArray(strArr2);
        return strArr2;
    }

    public String[] setPackagesSuspended(ComponentName componentName, String str, String[] strArr, boolean z) {
        ActiveAdmin profileOwnerOrDeviceOwnerLocked;
        ActiveAdmin activeAdmin;
        String[] packagesSuspendedByAdmin;
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        if (isUnicornFlagEnabled()) {
            activeAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_PACKAGE_STATE", callerIdentity.getPackageName(), callerIdentity.getUserId()).getActiveAdmin();
        } else {
            Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-package-access")));
            synchronized (getLockObject()) {
                profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
            }
            activeAdmin = profileOwnerOrDeviceOwnerLocked;
        }
        checkCanExecuteOrThrowUnsafe(20);
        HashSet hashSet = new HashSet();
        String[] populateNonExemptAndExemptFromPolicyApps = populateNonExemptAndExemptFromPolicyApps(strArr, hashSet);
        synchronized (getLockObject()) {
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                packagesSuspendedByAdmin = this.mInjector.getPackageManagerInternal().setPackagesSuspendedByAdmin(callerIdentity.getUserId(), populateNonExemptAndExemptFromPolicyApps, z);
            } finally {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        }
        DevicePolicyEventLogger.createEvent(68).setAdmin(callerIdentity.getPackageName()).setBoolean(componentName == null).setStrings(populateNonExemptAndExemptFromPolicyApps).write();
        if (packagesSuspendedByAdmin == null) {
            Slogf.w("DevicePolicyManager", "PM failed to suspend packages (%s)", Arrays.toString(populateNonExemptAndExemptFromPolicyApps));
            return populateNonExemptAndExemptFromPolicyApps;
        }
        ArraySet arraySet = new ArraySet(populateNonExemptAndExemptFromPolicyApps);
        if (z) {
            arraySet.removeAll(List.of((Object[]) packagesSuspendedByAdmin));
        } else {
            arraySet.addAll(hashSet);
        }
        synchronized (getLockObject()) {
            ArraySet arraySet2 = new ArraySet(activeAdmin.suspendedPackages);
            if (z) {
                arraySet2.addAll(arraySet);
            } else {
                arraySet2.removeAll(arraySet);
            }
            activeAdmin.suspendedPackages = arraySet2.isEmpty() ? null : new ArrayList(arraySet2);
            saveSettingsLocked(callerIdentity.getUserId());
        }
        return hashSet.isEmpty() ? packagesSuspendedByAdmin : buildNonSuspendedPackagesUnionArray(packagesSuspendedByAdmin, hashSet);
    }

    public final String[] buildNonSuspendedPackagesUnionArray(String[] strArr, Set set) {
        String[] strArr2 = new String[strArr.length + set.size()];
        int length = strArr.length;
        int i = 0;
        int i2 = 0;
        while (i < length) {
            strArr2[i2] = strArr[i];
            i++;
            i2++;
        }
        Iterator it = set.iterator();
        while (it.hasNext()) {
            strArr2[i2] = (String) it.next();
            i2++;
        }
        return strArr2;
    }

    public boolean isPackageSuspended(ComponentName componentName, String str, String str2) {
        boolean isPackageSuspendedForUser;
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        if (isUnicornFlagEnabled()) {
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_PACKAGE_STATE", callerIdentity.getPackageName(), callerIdentity.getUserId());
        } else {
            Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-package-access")));
        }
        synchronized (getLockObject()) {
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                try {
                    isPackageSuspendedForUser = this.mIPackageManager.isPackageSuspendedForUser(str2, callerIdentity.getUserId());
                } finally {
                    this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                }
            } catch (RemoteException e) {
                Slogf.e("DevicePolicyManager", "Failed talking to the package manager", e);
                return false;
            }
        }
        return isPackageSuspendedForUser;
    }

    public List listPolicyExemptApps() {
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_DEVICE_ADMINS") || isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        return listPolicyExemptAppsUnchecked(this.mContext);
    }

    public static List listPolicyExemptAppsUnchecked(Context context) {
        String[] stringArray = context.getResources().getStringArray(17236445);
        String[] stringArray2 = context.getResources().getStringArray(17236468);
        ArraySet arraySet = new ArraySet(stringArray.length + stringArray2.length);
        for (String str : stringArray) {
            arraySet.add(str);
        }
        for (String str2 : stringArray2) {
            arraySet.add(str2);
        }
        return new ArrayList(arraySet);
    }

    public void setUserRestriction(ComponentName componentName, String str, String str2, boolean z, boolean z2) {
        CallerIdentity callerIdentity;
        if (isPolicyEngineForFinanceFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        int userId = callerIdentity.getUserId();
        int profileParentId = z2 ? getProfileParentId(userId) : userId;
        checkCanExecuteOrThrowUnsafe(10);
        if (isPolicyEngineForFinanceFlagEnabled()) {
            if (!isDeviceOwner(callerIdentity) && !isProfileOwner(callerIdentity)) {
                EnforcingAdmin enforcePermissionForUserRestriction = enforcePermissionForUserRestriction(componentName, str2, callerIdentity.getPackageName(), profileParentId);
                if (!this.mInjector.isChangeEnabled(260560985L, str, userId)) {
                    throw new IllegalStateException("Calling package is not targeting Android U.");
                }
                if (!UserRestrictionsUtils.isValidRestriction(str2)) {
                    throw new IllegalArgumentException("Invalid restriction key: " + str2);
                }
                PolicyDefinition policyDefinitionForUserRestriction = PolicyDefinition.getPolicyDefinitionForUserRestriction(str2);
                if (z) {
                    setLocalUserRestrictionInternal(enforcePermissionForUserRestriction, str2, true, profileParentId);
                } else {
                    if (!policyDefinitionForUserRestriction.isLocalOnlyPolicy()) {
                        setGlobalUserRestrictionInternal(enforcePermissionForUserRestriction, str2, false);
                    }
                    if (!policyDefinitionForUserRestriction.isGlobalOnlyPolicy()) {
                        setLocalUserRestrictionInternal(enforcePermissionForUserRestriction, str2, false, userId);
                        int profileParentId2 = getProfileParentId(userId);
                        if (profileParentId2 != userId) {
                            setLocalUserRestrictionInternal(enforcePermissionForUserRestriction, str2, false, profileParentId2);
                        }
                    }
                }
            } else {
                if (!UserRestrictionsUtils.isValidRestriction(str2)) {
                    return;
                }
                Objects.requireNonNull(componentName, "ComponentName is null");
                EnforcingAdmin enforcingAdminForCaller = getEnforcingAdminForCaller(componentName, str);
                checkAdminCanSetRestriction(callerIdentity, z2, str2);
                setBackwardCompatibleUserRestriction(callerIdentity, enforcingAdminForCaller, str2, z, z2);
            }
        } else {
            if (!UserRestrictionsUtils.isValidRestriction(str2)) {
                return;
            }
            Objects.requireNonNull(componentName, "ComponentName is null");
            checkAdminCanSetRestriction(callerIdentity, z2, str2);
            synchronized (getLockObject()) {
                Bundle ensureUserRestrictions = getParentOfAdminIfRequired(getProfileOwnerOrDeviceOwnerLocked(userId), z2).ensureUserRestrictions();
                if (z) {
                    ensureUserRestrictions.putBoolean(str2, true);
                } else {
                    ensureUserRestrictions.remove(str2);
                }
                saveUserRestrictionsLocked(userId);
            }
        }
        logUserRestrictionCall(str2, z, z2, callerIdentity);
    }

    public final void checkAdminCanSetRestriction(CallerIdentity callerIdentity, boolean z, String str) {
        boolean z2;
        if (z) {
            Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        } else {
            Preconditions.checkCallAuthorization(isDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        }
        synchronized (getLockObject()) {
            if (isDefaultDeviceOwner(callerIdentity)) {
                if (!UserRestrictionsUtils.canDeviceOwnerChange(str)) {
                    throw new SecurityException("Device owner cannot set user restriction " + str);
                }
                Preconditions.checkArgument(z ? false : true, "Cannot use the parent instance in Device Owner mode");
            } else if (!isFinancedDeviceOwner(callerIdentity)) {
                if (!z) {
                    if (UserRestrictionsUtils.canProfileOwnerChange(str, callerIdentity.getUserId() == getMainUserId())) {
                        z2 = true;
                        if (z && isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) && UserRestrictionsUtils.canProfileOwnerOfOrganizationOwnedDeviceChange(str)) {
                            r0 = true;
                        }
                        if (!z2 && !r0) {
                            throw new SecurityException("Profile owner cannot set user restriction " + str);
                        }
                    }
                }
                z2 = false;
                if (z) {
                    r0 = true;
                }
                if (!z2) {
                    throw new SecurityException("Profile owner cannot set user restriction " + str);
                }
            } else {
                if (!UserRestrictionsUtils.canFinancedDeviceOwnerChange(str)) {
                    throw new SecurityException("Cannot set user restriction " + str + " when managing a financed device");
                }
                Preconditions.checkArgument(z ? false : true, "Cannot use the parent instance in Financed Device Owner mode");
            }
        }
    }

    public final void setBackwardCompatibleUserRestriction(CallerIdentity callerIdentity, EnforcingAdmin enforcingAdmin, String str, boolean z, boolean z2) {
        int i;
        synchronized (getLockObject()) {
            if (isDeviceOwner(callerIdentity)) {
                i = 0;
            } else if (isProfileOwnerOfOrganizationOwnedDevice(callerIdentity)) {
                i = 2;
            } else {
                if (!isProfileOwner(callerIdentity)) {
                    throw new IllegalStateException("Non-DO/Non-PO cannot set restriction " + str + " while targetSdkVersion is less than UPSIDE_DOWN_CAKE");
                }
                i = 1;
            }
            setBackwardCompatibleUserRestrictionLocked(i, enforcingAdmin, callerIdentity.getUserId(), str, z, z2);
        }
    }

    public final void setBackwardCompatibleUserRestrictionLocked(int i, EnforcingAdmin enforcingAdmin, int i2, String str, boolean z, boolean z2) {
        if (i == 0) {
            if (UserRestrictionsUtils.isGlobal(0, str)) {
                setGlobalUserRestrictionInternal(enforcingAdmin, str, z);
                return;
            } else {
                setLocalUserRestrictionInternal(enforcingAdmin, str, z, i2);
                return;
            }
        }
        if (i == 1 || i == 2) {
            if (UserRestrictionsUtils.isGlobal(1, str) || (z2 && i == 2 && UserRestrictionsUtils.isGlobal(2, str))) {
                setGlobalUserRestrictionInternal(enforcingAdmin, str, z);
                return;
            }
            if (z2) {
                i2 = getProfileParentId(i2);
            }
            setLocalUserRestrictionInternal(enforcingAdmin, str, z, i2);
            return;
        }
        throw new IllegalStateException("Non-DO/Non-PO cannot set restriction " + str + " while targetSdkVersion is less than UPSIDE_DOWN_CAKE");
    }

    public void setUserRestrictionGlobally(String str, String str2) {
        CallerIdentity callerIdentity = getCallerIdentity(str);
        EnforcingAdmin enforcePermissionForUserRestriction = enforcePermissionForUserRestriction(null, str2, callerIdentity.getPackageName(), -1);
        checkCanExecuteOrThrowUnsafe(10);
        if (!isPolicyEngineForFinanceFlagEnabled()) {
            throw new IllegalStateException("Feature flag is not enabled.");
        }
        if (isDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity)) {
            throw new SecurityException("Admins are not allowed to call this API.");
        }
        if (!this.mInjector.isChangeEnabled(260560985L, str, callerIdentity.getUserId())) {
            throw new IllegalStateException("Calling package is not targeting Android U.");
        }
        if (!UserRestrictionsUtils.isValidRestriction(str2)) {
            throw new IllegalArgumentException("Invalid restriction key: " + str2);
        }
        setGlobalUserRestrictionInternal(enforcePermissionForUserRestriction, str2, true);
        logUserRestrictionCall(str2, true, false, callerIdentity);
    }

    public final void setLocalUserRestrictionInternal(EnforcingAdmin enforcingAdmin, String str, boolean z, int i) {
        PolicyDefinition policyDefinitionForUserRestriction = PolicyDefinition.getPolicyDefinitionForUserRestriction(str);
        if (z) {
            this.mDevicePolicyEngine.setLocalPolicy(policyDefinitionForUserRestriction, enforcingAdmin, new BooleanPolicyValue(true), i);
        } else {
            this.mDevicePolicyEngine.removeLocalPolicy(policyDefinitionForUserRestriction, enforcingAdmin, i);
        }
    }

    public final void setGlobalUserRestrictionInternal(EnforcingAdmin enforcingAdmin, String str, boolean z) {
        PolicyDefinition policyDefinitionForUserRestriction = PolicyDefinition.getPolicyDefinitionForUserRestriction(str);
        if (z) {
            this.mDevicePolicyEngine.setGlobalPolicy(PolicyDefinition.getPolicyDefinitionForUserRestriction(str), enforcingAdmin, new BooleanPolicyValue(true));
        } else {
            this.mDevicePolicyEngine.removeGlobalPolicy(policyDefinitionForUserRestriction, enforcingAdmin);
        }
    }

    public final void logUserRestrictionCall(String str, boolean z, boolean z2, CallerIdentity callerIdentity) {
        DevicePolicyEventLogger admin = DevicePolicyEventLogger.createEvent(z ? 12 : 13).setAdmin(callerIdentity.getComponentName());
        String[] strArr = new String[2];
        strArr[0] = str;
        strArr[1] = z2 ? "calledFromParent" : "notCalledFromParent";
        admin.setStrings(strArr).write();
        if (SecurityLog.isLoggingEnabled()) {
            SecurityLog.writeEvent(z ? 210027 : 210028, new Object[]{callerIdentity.getPackageName(), Integer.valueOf(callerIdentity.getUserId()), str});
        }
    }

    public final void saveUserRestrictionsLocked(int i) {
        if (isPolicyEngineForFinanceFlagEnabled()) {
            return;
        }
        saveSettingsLocked(i);
        pushUserRestrictions(i);
        sendChangedNotification(i);
    }

    public final void pushUserRestrictions(int i) {
        Bundle globalUserRestrictions;
        if (isPolicyEngineForFinanceFlagEnabled()) {
            return;
        }
        RestrictionsSet restrictionsSet = new RestrictionsSet();
        synchronized (getLockObject()) {
            boolean isDeviceOwnerUserId = this.mOwners.isDeviceOwnerUserId(i);
            if (isDeviceOwnerUserId) {
                ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
                if (deviceOwnerAdminLocked == null) {
                    return;
                }
                globalUserRestrictions = deviceOwnerAdminLocked.getGlobalUserRestrictions(0);
                restrictionsSet.updateRestrictions(i, deviceOwnerAdminLocked.getLocalUserRestrictions(0));
            } else {
                ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
                if (profileOwnerAdminLocked == null) {
                    return;
                }
                globalUserRestrictions = profileOwnerAdminLocked.getGlobalUserRestrictions(1);
                restrictionsSet.updateRestrictions(i, profileOwnerAdminLocked.getLocalUserRestrictions(1));
                if (isProfileOwnerOfOrganizationOwnedDevice(profileOwnerAdminLocked.getUserHandle().getIdentifier())) {
                    UserRestrictionsUtils.merge(globalUserRestrictions, profileOwnerAdminLocked.getParentActiveAdmin().getGlobalUserRestrictions(2));
                    restrictionsSet.updateRestrictions(getProfileParentId(profileOwnerAdminLocked.getUserHandle().getIdentifier()), profileOwnerAdminLocked.getParentActiveAdmin().getLocalUserRestrictions(2));
                }
            }
            this.mUserManagerInternal.setDevicePolicyUserRestrictions(i, globalUserRestrictions, restrictionsSet, isDeviceOwnerUserId);
        }
    }

    public final void pushCameraRestrictionForRemovingAdmin(int i) {
        RestrictionsSet restrictionsSet = new RestrictionsSet();
        synchronized (getLockObject()) {
            if (!this.mOwners.isDeviceOwnerUserId(i) && getProfileOwnerAdminLocked(i) == null) {
                Bundle userRestrictions = this.mUserManager.getUserRestrictions(UserHandle.of(i));
                if (userRestrictions != null && !userRestrictions.isEmpty()) {
                    if (!this.mUserManager.hasUserRestriction("no_camera", UserHandle.of(i))) {
                        Log.i("DevicePolicyManager", "pushCameraRestrictionForRemovingAdmin()::No need to update restriction UserManager.DISALLOW_CAMERA");
                        return;
                    }
                    Bundle bundle = new Bundle();
                    Bundle bundle2 = new Bundle();
                    DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
                    boolean z = false;
                    for (int i2 = 0; i2 < lambda$getUserDataUnchecked$2.mAdminList.size(); i2++) {
                        if (((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2)).disableCamera) {
                            z = true;
                        }
                    }
                    if (z) {
                        return;
                    }
                    bundle2.putBoolean("no_camera", z);
                    restrictionsSet.updateRestrictions(i, bundle2);
                    Log.i("DevicePolicyManager", "pushCameraRestrictionForRemovingAdmin() updated DISALLOW_CAMERA to " + z);
                    this.mUserManagerInternal.setDevicePolicyUserRestrictions(i, bundle, restrictionsSet, false);
                    return;
                }
                Log.i("DevicePolicyManager", "pushCameraRestrictionForRemovingAdmin()::EffectiveUserRestrictions from UserManager is null");
                return;
            }
            Object[] objArr = new Object[2];
            objArr[0] = Boolean.valueOf(this.mOwners.isDeviceOwnerUserId(i));
            objArr[1] = Boolean.valueOf(getProfileOwnerAdminLocked(i) != null);
            Log.i("DevicePolicyManager", String.format("pushCameraRestrictionForRemovingAdmin()::DeviceOwner[%s] ProfileOwner[%s] -- stop running", objArr));
        }
    }

    public Bundle getUserRestrictions(ComponentName componentName, String str, boolean z) {
        CallerIdentity callerIdentity;
        Bundle bundle;
        if (!this.mHasFeature) {
            return null;
        }
        if (isPolicyEngineForFinanceFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        boolean z2 = false;
        if (isPolicyEngineForFinanceFlagEnabled()) {
            int profileParentId = z ? getProfileParentId(callerIdentity.getUserId()) : callerIdentity.getUserId();
            EnforcingAdmin enforcingAdminForCaller = getEnforcingAdminForCaller(componentName, str);
            if (isDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity)) {
                Objects.requireNonNull(componentName, "ComponentName is null");
                if (isDefaultDeviceOwner(callerIdentity) || isFinancedDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity) || (z && isProfileOwnerOfOrganizationOwnedDevice(callerIdentity))) {
                    z2 = true;
                }
                Preconditions.checkCallAuthorization(z2);
                Bundle userRestrictionsFromPolicyEngine = getUserRestrictionsFromPolicyEngine(enforcingAdminForCaller, profileParentId);
                userRestrictionsFromPolicyEngine.putAll(getUserRestrictionsFromPolicyEngine(enforcingAdminForCaller, -1));
                return userRestrictionsFromPolicyEngine;
            }
            if (!this.mInjector.isChangeEnabled(260560985L, str, callerIdentity.getUserId())) {
                throw new IllegalStateException("Calling package is not targeting Android U.");
            }
            return getUserRestrictionsFromPolicyEngine(enforcingAdminForCaller, profileParentId);
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        if (isDefaultDeviceOwner(callerIdentity) || isFinancedDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity) || (z && isProfileOwnerOfOrganizationOwnedDevice(callerIdentity))) {
            z2 = true;
        }
        Preconditions.checkCallAuthorization(z2);
        synchronized (getLockObject()) {
            bundle = getParentOfAdminIfRequired(getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()), z).userRestrictions;
        }
        return bundle;
    }

    public final EnforcingAdmin enforcePermissionForUserRestriction(ComponentName componentName, String str, String str2, int i) {
        String[] strArr = (String[]) USER_RESTRICTION_PERMISSIONS.get(str);
        if (strArr.length > 0) {
            try {
                return enforcePermissionsAndGetEnforcingAdmin(componentName, strArr, str2, i);
            } catch (SecurityException e) {
                throw new SecurityException("Caller does not hold the required permission for this user restriction: " + str + ".\n" + e.getMessage());
            }
        }
        throw new SecurityException("Admins are not permitted to set User Restriction: " + str);
    }

    public Bundle getUserRestrictionsGlobally(String str) {
        if (!this.mHasFeature) {
            return null;
        }
        CallerIdentity callerIdentity = getCallerIdentity(str);
        if (!isPolicyEngineForFinanceFlagEnabled()) {
            throw new IllegalStateException("Feature flag is not enabled.");
        }
        return getUserRestrictionsFromPolicyEngine(getEnforcingAdminForCaller(null, callerIdentity.getPackageName()), -1);
    }

    public final Bundle getUserRestrictionsFromPolicyEngine(EnforcingAdmin enforcingAdmin, int i) {
        Set userRestrictionPolicyKeysForAdmin = this.mDevicePolicyEngine.getUserRestrictionPolicyKeysForAdmin(enforcingAdmin, i);
        Bundle bundle = new Bundle();
        Iterator it = userRestrictionPolicyKeysForAdmin.iterator();
        while (it.hasNext()) {
            bundle.putBoolean(((UserRestrictionPolicyKey) it.next()).getRestriction(), true);
        }
        return bundle;
    }

    public boolean setApplicationHidden(ComponentName componentName, String str, final String str2, final boolean z, boolean z2) {
        boolean booleanValue;
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        final int userId = callerIdentity.getUserId();
        if (z2) {
            userId = getProfileParentId(userId);
        }
        if (isPolicyEngineForFinanceFlagEnabled()) {
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_PACKAGE_STATE", callerIdentity.getPackageName(), userId);
        } else {
            Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-package-access")));
        }
        if (listPolicyExemptAppsUnchecked(this.mContext).contains(str2)) {
            Slogf.d("DevicePolicyManager", "setApplicationHidden(): ignoring %s as it's on policy-exempt list", str2);
            return false;
        }
        synchronized (getLockObject()) {
            if (z2) {
                if (!isPolicyEngineForFinanceFlagEnabled()) {
                    Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity.getUserId()) && isManagedProfile(callerIdentity.getUserId()));
                }
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda154
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$setApplicationHidden$105(str2, userId);
                    }
                });
            }
            checkCanExecuteOrThrowUnsafe(15);
            if (isPolicyEngineForFinanceFlagEnabled()) {
                this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.APPLICATION_HIDDEN(str2), getEnforcingAdminForCaller(componentName, str), new BooleanPolicyValue(z), userId);
                booleanValue = ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda155
                    public final Object getOrThrow() {
                        Boolean lambda$setApplicationHidden$106;
                        lambda$setApplicationHidden$106 = DevicePolicyManagerService.this.lambda$setApplicationHidden$106(str2, userId, z);
                        return lambda$setApplicationHidden$106;
                    }
                })).booleanValue();
            } else {
                booleanValue = ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda156
                    public final Object getOrThrow() {
                        Boolean lambda$setApplicationHidden$107;
                        lambda$setApplicationHidden$107 = DevicePolicyManagerService.this.lambda$setApplicationHidden$107(str2, z, userId);
                        return lambda$setApplicationHidden$107;
                    }
                })).booleanValue();
            }
        }
        DevicePolicyEventLogger devicePolicyEventLogger = DevicePolicyEventLogger.createEvent(63).setAdmin(callerIdentity.getPackageName()).setBoolean(isCallerDelegate(callerIdentity));
        String[] strArr = new String[3];
        strArr[0] = str2;
        strArr[1] = z ? "hidden" : "not_hidden";
        strArr[2] = z2 ? "calledFromParent" : "notCalledFromParent";
        devicePolicyEventLogger.setStrings(strArr).write();
        return booleanValue;
    }

    public /* synthetic */ Boolean lambda$setApplicationHidden$106(String str, int i, boolean z) {
        try {
            return Boolean.valueOf(this.mInjector.getIPackageManager().getPackageInfo(str, 8192L, i) != null && this.mIPackageManager.getApplicationHiddenSettingAsUser(str, i) == z);
        } catch (RemoteException unused) {
            return Boolean.FALSE;
        }
    }

    public /* synthetic */ Boolean lambda$setApplicationHidden$107(String str, boolean z, int i) {
        return Boolean.valueOf(this.mIPackageManager.setApplicationHiddenSettingAsUser(str, z, i));
    }

    public boolean isApplicationHidden(ComponentName componentName, String str, final String str2, boolean z) {
        boolean booleanValue;
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        final int userId = callerIdentity.getUserId();
        if (z) {
            userId = getProfileParentId(userId);
        }
        boolean z2 = true;
        if (isPolicyEngineForFinanceFlagEnabled()) {
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_PACKAGE_STATE", callerIdentity.getPackageName(), userId);
        } else {
            Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-package-access")));
        }
        synchronized (getLockObject()) {
            if (z) {
                if (!isPolicyEngineForFinanceFlagEnabled()) {
                    if (!isProfileOwnerOfOrganizationOwnedDevice(callerIdentity.getUserId()) || !isManagedProfile(callerIdentity.getUserId())) {
                        z2 = false;
                    }
                    Preconditions.checkCallAuthorization(z2);
                }
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda164
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$isApplicationHidden$108(str2, userId);
                    }
                });
            }
            booleanValue = ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda165
                public final Object getOrThrow() {
                    Boolean lambda$isApplicationHidden$109;
                    lambda$isApplicationHidden$109 = DevicePolicyManagerService.this.lambda$isApplicationHidden$109(str2, userId);
                    return lambda$isApplicationHidden$109;
                }
            })).booleanValue();
        }
        return booleanValue;
    }

    public /* synthetic */ Boolean lambda$isApplicationHidden$109(String str, int i) {
        return Boolean.valueOf(this.mIPackageManager.getApplicationHiddenSettingAsUser(str, i));
    }

    /* renamed from: enforcePackageIsSystemPackage, reason: merged with bridge method [inline-methods] and merged with bridge method [inline-methods] and merged with bridge method [inline-methods] */
    public final void lambda$setDefaultSmsApplication$88(String str, int i) {
        boolean z;
        try {
            z = isSystemApp(this.mIPackageManager, str, i);
        } catch (IllegalArgumentException unused) {
            z = false;
        }
        if (!z) {
            throw new IllegalArgumentException("The provided package is not a system package");
        }
    }

    /* JADX WARN: Removed duplicated region for block: B:13:0x0062 A[Catch: all -> 0x004b, RemoteException -> 0x004d, TRY_LEAVE, TryCatch #0 {RemoteException -> 0x004d, blocks: (B:31:0x003c, B:11:0x0050, B:13:0x0062), top: B:30:0x003c, outer: #1 }] */
    /* JADX WARN: Removed duplicated region for block: B:27:0x009e  */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public void enableSystemApp(android.content.ComponentName r13, java.lang.String r14, java.lang.String r15) {
        /*
            r12 = this;
            com.android.server.devicepolicy.CallerIdentity r14 = r12.getCallerIdentity(r13, r14)
            boolean r0 = r14.hasAdminComponent()
            r1 = 1
            r2 = 0
            if (r0 == 0) goto L18
            boolean r0 = r12.isProfileOwner(r14)
            if (r0 != 0) goto L26
            boolean r0 = r12.isDefaultDeviceOwner(r14)
            if (r0 != 0) goto L26
        L18:
            boolean r0 = r14.hasPackage()
            if (r0 == 0) goto L28
            java.lang.String r0 = "delegation-enable-system-app"
            boolean r0 = r12.isCallerDelegate(r14, r0)
            if (r0 == 0) goto L28
        L26:
            r0 = r1
            goto L29
        L28:
            r0 = r2
        L29:
            com.android.internal.util.Preconditions.checkCallAuthorization(r0)
            boolean r0 = r12.isCurrentUserDemo()
            int r9 = r14.getUserId()
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r3 = r12.mInjector
            long r10 = r3.binderClearCallingIdentity()
            if (r0 != 0) goto L4f
            android.content.pm.IPackageManager r3 = r12.mIPackageManager     // Catch: java.lang.Throwable -> L4b android.os.RemoteException -> L4d
            int r4 = r12.getProfileParentId(r9)     // Catch: java.lang.Throwable -> L4b android.os.RemoteException -> L4d
            boolean r3 = r12.isSystemApp(r3, r15, r4)     // Catch: java.lang.Throwable -> L4b android.os.RemoteException -> L4d
            if (r3 == 0) goto L49
            goto L4f
        L49:
            r3 = r2
            goto L50
        L4b:
            r13 = move-exception
            goto Laf
        L4d:
            r0 = move-exception
            goto L73
        L4f:
            r3 = r1
        L50:
            java.lang.String r4 = "Only system apps can be enabled this way"
            com.android.internal.util.Preconditions.checkArgument(r3, r4)     // Catch: java.lang.Throwable -> L4b android.os.RemoteException -> L4d
            android.content.pm.IPackageManager r3 = r12.mIPackageManager     // Catch: java.lang.Throwable -> L4b android.os.RemoteException -> L4d
            r6 = 4194304(0x400000, float:5.877472E-39)
            r7 = 1
            r8 = 0
            r4 = r15
            r5 = r9
            r3.installExistingPackageAsUser(r4, r5, r6, r7, r8)     // Catch: java.lang.Throwable -> L4b android.os.RemoteException -> L4d
            if (r0 == 0) goto L6d
            android.content.pm.IPackageManager r3 = r12.mIPackageManager     // Catch: java.lang.Throwable -> L4b android.os.RemoteException -> L4d
            r5 = 1
            r6 = 1
            java.lang.String r8 = "DevicePolicyManager"
            r4 = r15
            r7 = r9
            r3.setApplicationEnabledSetting(r4, r5, r6, r7, r8)     // Catch: java.lang.Throwable -> L4b android.os.RemoteException -> L4d
        L6d:
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r0 = r12.mInjector
            r0.binderRestoreCallingIdentity(r10)
            goto L8a
        L73:
            java.lang.String r3 = "DevicePolicyManager"
            java.lang.StringBuilder r4 = new java.lang.StringBuilder     // Catch: java.lang.Throwable -> L4b
            r4.<init>()     // Catch: java.lang.Throwable -> L4b
            java.lang.String r5 = "Failed to install "
            r4.append(r5)     // Catch: java.lang.Throwable -> L4b
            r4.append(r15)     // Catch: java.lang.Throwable -> L4b
            java.lang.String r4 = r4.toString()     // Catch: java.lang.Throwable -> L4b
            com.android.server.utils.Slogf.wtf(r3, r4, r0)     // Catch: java.lang.Throwable -> L4b
            goto L6d
        L8a:
            r12.setCrossProfileAppToIgnored(r15, r9)
            r12 = 64
            android.app.admin.DevicePolicyEventLogger r12 = android.app.admin.DevicePolicyEventLogger.createEvent(r12)
            java.lang.String r14 = r14.getPackageName()
            android.app.admin.DevicePolicyEventLogger r12 = r12.setAdmin(r14)
            if (r13 != 0) goto L9e
            goto L9f
        L9e:
            r1 = r2
        L9f:
            android.app.admin.DevicePolicyEventLogger r12 = r12.setBoolean(r1)
            java.lang.String[] r13 = new java.lang.String[]{r15}
            android.app.admin.DevicePolicyEventLogger r12 = r12.setStrings(r13)
            r12.write()
            return
        Laf:
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r12 = r12.mInjector
            r12.binderRestoreCallingIdentity(r10)
            throw r13
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.enableSystemApp(android.content.ComponentName, java.lang.String, java.lang.String):void");
    }

    public int enableSystemAppWithIntent(ComponentName componentName, String str, Intent intent) {
        int i;
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-enable-system-app")));
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            try {
                int profileParentId = getProfileParentId(callerIdentity.getUserId());
                List list = this.mIPackageManager.queryIntentActivities(intent, intent.resolveTypeIfNeeded(this.mContext.getContentResolver()), 786432L, profileParentId).getList();
                if (list != null) {
                    Iterator it = list.iterator();
                    i = 0;
                    while (it.hasNext()) {
                        ActivityInfo activityInfo = ((ResolveInfo) it.next()).activityInfo;
                        if (activityInfo != null) {
                            String str2 = activityInfo.packageName;
                            if (isSystemApp(this.mIPackageManager, str2, profileParentId)) {
                                i++;
                                this.mIPackageManager.installExistingPackageAsUser(str2, callerIdentity.getUserId(), 4194304, 1, (List) null);
                            } else {
                                Slogf.d("DevicePolicyManager", "Not enabling " + str2 + " since is not a system app");
                            }
                        }
                    }
                } else {
                    i = 0;
                }
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                DevicePolicyEventLogger.createEvent(65).setAdmin(callerIdentity.getPackageName()).setBoolean(componentName == null).setStrings(new String[]{intent.getAction()}).write();
                return i;
            } catch (RemoteException e) {
                Slogf.wtf("DevicePolicyManager", "Failed to resolve intent for: " + intent, e);
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                return 0;
            }
        } catch (Throwable th) {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            throw th;
        }
    }

    public final boolean isSystemApp(IPackageManager iPackageManager, String str, int i) {
        ApplicationInfo applicationInfo = iPackageManager.getApplicationInfo(str, 8192L, i);
        if (applicationInfo != null) {
            return (applicationInfo.flags & 1) != 0;
        }
        throw new IllegalArgumentException("The application " + str + " is not present on this device");
    }

    public boolean installExistingPackage(ComponentName componentName, String str, String str2) {
        boolean z;
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-install-existing-package")));
        synchronized (getLockObject()) {
            Preconditions.checkCallAuthorization(isUserAffiliatedWithDeviceLocked(callerIdentity.getUserId()), "Admin %s is neither the device owner or affiliated user's profile owner.", new Object[]{componentName});
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                z = this.mIPackageManager.installExistingPackageAsUser(str2, callerIdentity.getUserId(), 4194304, 1, (List) null) == 1;
            } catch (RemoteException e) {
                Slogf.wtf("DevicePolicyManager", "Error installing package", e);
                return false;
            } finally {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        }
        if (z) {
            DevicePolicyEventLogger.createEvent(66).setAdmin(callerIdentity.getPackageName()).setBoolean(componentName == null).setStrings(new String[]{str2}).write();
        }
        return z;
    }

    public void setAccountManagementDisabled(ComponentName componentName, String str, String str2, boolean z, boolean z2) {
        CallerIdentity callerIdentity;
        boolean z3;
        ActiveAdmin parentOfAdminIfRequired;
        if (this.mHasFeature) {
            enforceMaxStringLength(str2, "account type");
            if (isPolicyEngineForFinanceFlagEnabled()) {
                callerIdentity = getCallerIdentity(componentName, str);
            } else {
                callerIdentity = getCallerIdentity(componentName);
            }
            synchronized (getLockObject()) {
                if (isPolicyEngineForFinanceFlagEnabled()) {
                    int affectedUser = getAffectedUser(z2);
                    EnforcingAdmin enforcePermissionAndGetEnforcingAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_ACCOUNT_MANAGEMENT", callerIdentity.getPackageName(), affectedUser);
                    if (z) {
                        this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.ACCOUNT_MANAGEMENT_DISABLED(str2), enforcePermissionAndGetEnforcingAdmin, new BooleanPolicyValue(z), affectedUser);
                    } else {
                        this.mDevicePolicyEngine.removeLocalPolicy(PolicyDefinition.ACCOUNT_MANAGEMENT_DISABLED(str2), enforcePermissionAndGetEnforcingAdmin, affectedUser);
                    }
                } else {
                    Objects.requireNonNull(componentName, "ComponentName is null");
                    if (z2) {
                        parentOfAdminIfRequired = getParentOfAdminIfRequired(getOrganizationOwnedProfileOwnerLocked(callerIdentity), z2);
                    } else {
                        if (!isDefaultDeviceOwner(callerIdentity) && !isProfileOwner(callerIdentity)) {
                            z3 = false;
                            Preconditions.checkCallAuthorization(z3);
                            parentOfAdminIfRequired = getParentOfAdminIfRequired(getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()), z2);
                        }
                        z3 = true;
                        Preconditions.checkCallAuthorization(z3);
                        parentOfAdminIfRequired = getParentOfAdminIfRequired(getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()), z2);
                    }
                    if (z) {
                        parentOfAdminIfRequired.accountTypesWithManagementDisabled.add(str2);
                    } else {
                        parentOfAdminIfRequired.accountTypesWithManagementDisabled.remove(str2);
                    }
                    saveSettingsLocked(UserHandle.getCallingUserId());
                }
            }
        }
    }

    public String[] getAccountTypesWithManagementDisabled(String str) {
        return getAccountTypesWithManagementDisabledAsUser(UserHandle.getCallingUserId(), str, false);
    }

    public String[] getAccountTypesWithManagementDisabledAsUser(int i, String str, boolean z) {
        if (!this.mHasFeature) {
            return null;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        ArraySet arraySet = new ArraySet();
        if (isPolicyEngineForFinanceFlagEnabled()) {
            int profileParentId = z ? getProfileParentId(i) : i;
            CallerIdentity callerIdentity = getCallerIdentity(str);
            if (!hasPermission("android.permission.MANAGE_DEVICE_POLICY_ACCOUNT_MANAGEMENT", str, profileParentId) && !hasFullCrossUsersPermission(callerIdentity, i)) {
                throw new SecurityException("Caller does not have permission to call this on user: " + profileParentId);
            }
            for (AccountTypePolicyKey accountTypePolicyKey : this.mDevicePolicyEngine.getLocalPolicyKeysSetByAllAdmins(PolicyDefinition.GENERIC_ACCOUNT_MANAGEMENT_DISABLED, profileParentId)) {
                if (!(accountTypePolicyKey instanceof AccountTypePolicyKey)) {
                    throw new IllegalStateException("PolicyKey for MANAGE_DEVICE_POLICY_ACCOUNT_MANAGEMENT is not of type AccountTypePolicyKey");
                }
                String accountType = accountTypePolicyKey.getAccountType();
                Objects.requireNonNull(accountType);
                Boolean bool = (Boolean) this.mDevicePolicyEngine.getResolvedPolicy(PolicyDefinition.ACCOUNT_MANAGEMENT_DISABLED(accountType), profileParentId);
                if (bool != null && bool.booleanValue()) {
                    arraySet.add(accountType);
                }
            }
        } else {
            Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
            synchronized (getLockObject()) {
                if (!z) {
                    Iterator it = lambda$getUserDataUnchecked$2(i).mAdminList.iterator();
                    while (it.hasNext()) {
                        arraySet.addAll(((ActiveAdmin) it.next()).accountTypesWithManagementDisabled);
                    }
                }
                ActiveAdmin profileOwnerOfOrganizationOwnedDeviceLocked = getProfileOwnerOfOrganizationOwnedDeviceLocked(i);
                if (profileOwnerOfOrganizationOwnedDeviceLocked != null && (z || UserHandle.getUserId(profileOwnerOfOrganizationOwnedDeviceLocked.getUid()) != i)) {
                    arraySet.addAll(profileOwnerOfOrganizationOwnedDeviceLocked.getParentActiveAdmin().accountTypesWithManagementDisabled);
                }
            }
        }
        return (String[]) arraySet.toArray(new String[arraySet.size()]);
    }

    public void setUninstallBlocked(ComponentName componentName, String str, String str2, boolean z) {
        Injector injector;
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        if (isPolicyEngineForFinanceFlagEnabled()) {
            this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.PACKAGE_UNINSTALL_BLOCKED(str2), enforcePermissionsAndGetEnforcingAdmin(componentName, new String[]{"android.permission.MANAGE_DEVICE_POLICY_APPS_CONTROL", "manage_device_policy_block_uninstall"}, callerIdentity.getPackageName(), callerIdentity.getUserId()), new BooleanPolicyValue(z), callerIdentity.getUserId());
        } else {
            Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || isFinancedDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-block-uninstall")));
            int userId = callerIdentity.getUserId();
            synchronized (getLockObject()) {
                long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
                try {
                    try {
                        this.mIPackageManager.setBlockUninstallForUser(str2, z, userId);
                        injector = this.mInjector;
                    } catch (RemoteException e) {
                        Slogf.e("DevicePolicyManager", "Failed to setBlockUninstallForUser", e);
                        injector = this.mInjector;
                    }
                    injector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                } catch (Throwable th) {
                    this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                    throw th;
                }
            }
            if (z) {
                PackageManagerInternal packageManagerInternal = this.mInjector.getPackageManagerInternal();
                packageManagerInternal.removeNonSystemPackageSuspensions(str2, userId);
                packageManagerInternal.removeDistractingPackageRestrictions(str2, userId);
                packageManagerInternal.flushPackageRestrictions(userId);
            }
        }
        DevicePolicyEventLogger.createEvent(67).setAdmin(callerIdentity.getPackageName()).setBoolean(isCallerDelegate(callerIdentity)).setStrings(new String[]{str2}).write();
    }

    public static void setUninstallBlockedUnchecked(final String str, final boolean z, final int i) {
        Binder.withCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda227
            public final void runOrThrow() {
                DevicePolicyManagerService.lambda$setUninstallBlockedUnchecked$110(str, z, i);
            }
        });
        if (z) {
            PackageManagerInternal packageManagerInternal = (PackageManagerInternal) LocalServices.getService(PackageManagerInternal.class);
            packageManagerInternal.removeNonSystemPackageSuspensions(str, i);
            packageManagerInternal.removeDistractingPackageRestrictions(str, i);
            packageManagerInternal.flushPackageRestrictions(i);
        }
    }

    public static /* synthetic */ void lambda$setUninstallBlockedUnchecked$110(String str, boolean z, int i) {
        try {
            AppGlobals.getPackageManager().setBlockUninstallForUser(str, z, i);
        } catch (RemoteException e) {
            Slogf.e("DevicePolicyManager", "Failed to setBlockUninstallForUser", e);
        }
    }

    public boolean isUninstallBlocked(String str) {
        boolean blockUninstallForUser;
        int callingUserId = UserHandle.getCallingUserId();
        synchronized (getLockObject()) {
            try {
                try {
                    blockUninstallForUser = this.mIPackageManager.getBlockUninstallForUser(str, callingUserId);
                } catch (RemoteException e) {
                    Slogf.e("DevicePolicyManager", "Failed to getBlockUninstallForUser", e);
                    return false;
                }
            } catch (Throwable th) {
                throw th;
            }
        }
        return blockUninstallForUser;
    }

    public void setCrossProfileCallerIdDisabled(ComponentName componentName, boolean z) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
            synchronized (getLockObject()) {
                ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
                if (z) {
                    profileOwnerLocked.mManagedProfileCallerIdAccess = new PackagePolicy(3);
                } else {
                    profileOwnerLocked.mManagedProfileCallerIdAccess = new PackagePolicy(1);
                }
                saveSettingsLocked(callerIdentity.getUserId());
            }
            DevicePolicyEventLogger.createEvent(46).setAdmin(componentName).setBoolean(z).write();
        }
    }

    public boolean getCrossProfileCallerIdDisabled(ComponentName componentName) {
        if (!this.mHasFeature) {
            return false;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
            if (profileOwnerLocked == null) {
                return false;
            }
            PackagePolicy packagePolicy = profileOwnerLocked.mManagedProfileCallerIdAccess;
            if (packagePolicy == null) {
                return profileOwnerLocked.disableCallerId;
            }
            if (packagePolicy.getPolicyType() == 2) {
                Slogf.w("DevicePolicyManager", "Denying callerId due to PACKAGE_POLICY_SYSTEM policyType");
            }
            return profileOwnerLocked.mManagedProfileCallerIdAccess.getPolicyType() != 1;
        }
    }

    public boolean getCrossProfileCallerIdDisabledForUser(int i) {
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasCrossUsersPermission(getCallerIdentity(), i));
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            if (profileOwnerAdminLocked == null) {
                return false;
            }
            PackagePolicy packagePolicy = profileOwnerAdminLocked.mManagedProfileCallerIdAccess;
            if (packagePolicy == null) {
                return profileOwnerAdminLocked.disableCallerId;
            }
            return packagePolicy.getPolicyType() == 3;
        }
    }

    public void setManagedProfileCallerIdAccessPolicy(PackagePolicy packagePolicy) {
        if (this.mHasFeature) {
            CallerIdentity callerIdentity = getCallerIdentity();
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) && isManagedProfile(callerIdentity.getUserId()));
            synchronized (getLockObject()) {
                ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
                profileOwnerLocked.disableCallerId = false;
                profileOwnerLocked.mManagedProfileCallerIdAccess = packagePolicy;
                saveSettingsLocked(callerIdentity.getUserId());
            }
        }
    }

    public PackagePolicy getManagedProfileCallerIdAccessPolicy() {
        PackagePolicy packagePolicy;
        if (!this.mHasFeature) {
            return null;
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) && isManagedProfile(callerIdentity.getUserId()));
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
            packagePolicy = profileOwnerLocked != null ? profileOwnerLocked.mManagedProfileCallerIdAccess : null;
        }
        return packagePolicy;
    }

    public boolean hasManagedProfileCallerIdAccess(int i, String str) {
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasCrossUsersPermission(getCallerIdentity(), i));
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            boolean z = true;
            if (profileOwnerAdminLocked == null) {
                return true;
            }
            PackagePolicy packagePolicy = profileOwnerAdminLocked.mManagedProfileCallerIdAccess;
            if (packagePolicy == null) {
                if (profileOwnerAdminLocked.disableCallerId) {
                    z = false;
                }
                return z;
            }
            return packagePolicy.isPackageAllowed(str, this.mContactSystemRoleHolders);
        }
    }

    public void setManagedProfileContactsAccessPolicy(PackagePolicy packagePolicy) {
        if (this.mHasFeature) {
            CallerIdentity callerIdentity = getCallerIdentity();
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) && isManagedProfile(callerIdentity.getUserId()));
            synchronized (getLockObject()) {
                ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
                profileOwnerLocked.disableContactsSearch = false;
                profileOwnerLocked.mManagedProfileContactsAccess = packagePolicy;
                saveSettingsLocked(callerIdentity.getUserId());
            }
        }
    }

    public PackagePolicy getManagedProfileContactsAccessPolicy() {
        PackagePolicy packagePolicy;
        if (!this.mHasFeature) {
            return null;
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) && isManagedProfile(callerIdentity.getUserId()));
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
            packagePolicy = profileOwnerLocked != null ? profileOwnerLocked.mManagedProfileContactsAccess : null;
        }
        return packagePolicy;
    }

    public boolean hasManagedProfileContactsAccess(int i, String str) {
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasCrossUsersPermission(getCallerIdentity(), i));
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            boolean z = true;
            if (profileOwnerAdminLocked == null) {
                return true;
            }
            PackagePolicy packagePolicy = profileOwnerAdminLocked.mManagedProfileContactsAccess;
            if (packagePolicy == null) {
                if (profileOwnerAdminLocked.disableContactsSearch) {
                    z = false;
                }
                return z;
            }
            return packagePolicy.isPackageAllowed(str, this.mContactSystemRoleHolders);
        }
    }

    public void setCrossProfileContactsSearchDisabled(ComponentName componentName, boolean z) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
            synchronized (getLockObject()) {
                ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
                if (z) {
                    profileOwnerLocked.mManagedProfileContactsAccess = new PackagePolicy(3);
                } else {
                    profileOwnerLocked.mManagedProfileContactsAccess = new PackagePolicy(1);
                }
                saveSettingsLocked(callerIdentity.getUserId());
            }
            DevicePolicyEventLogger.createEvent(45).setAdmin(componentName).setBoolean(z).write();
        }
    }

    public boolean getCrossProfileContactsSearchDisabled(ComponentName componentName) {
        if (!this.mHasFeature) {
            return false;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
            if (profileOwnerLocked == null) {
                return false;
            }
            PackagePolicy packagePolicy = profileOwnerLocked.mManagedProfileContactsAccess;
            if (packagePolicy == null) {
                return profileOwnerLocked.disableContactsSearch;
            }
            return packagePolicy.getPolicyType() != 1;
        }
    }

    public boolean getCrossProfileContactsSearchDisabledForUser(int i) {
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasCrossUsersPermission(getCallerIdentity(), i));
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            if (profileOwnerAdminLocked == null) {
                return false;
            }
            PackagePolicy packagePolicy = profileOwnerAdminLocked.mManagedProfileContactsAccess;
            if (packagePolicy == null) {
                return profileOwnerAdminLocked.disableContactsSearch;
            }
            if (packagePolicy.getPolicyType() == 2) {
                Slogf.w("DevicePolicyManager", "Denying contacts due to PACKAGE_POLICY_SYSTEM policyType");
            }
            return profileOwnerAdminLocked.mManagedProfileContactsAccess.getPolicyType() != 1;
        }
    }

    public void startManagedQuickContact(String str, long j, boolean z, long j2, Intent intent) {
        final boolean z2 = j >= 700000000;
        final Intent rebuildManagedQuickContactsIntent = ContactsContract.QuickContact.rebuildManagedQuickContactsIntent(str, z2 ? j - 700000000 : j, z, j2, intent);
        final int callingUserId = UserHandle.getCallingUserId();
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda145
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$startManagedQuickContact$111(z2, callingUserId, rebuildManagedQuickContactsIntent);
            }
        });
    }

    public /* synthetic */ void lambda$startManagedQuickContact$111(boolean z, int i, Intent intent) {
        int managedUserId;
        synchronized (getLockObject()) {
            if (z) {
                managedUserId = SemPersonaManager.getSecureFolderId(this.mContext);
            } else {
                managedUserId = getManagedUserId(i);
            }
            if (managedUserId < 0) {
                return;
            }
            if (isCrossProfileQuickContactDisabled(managedUserId)) {
                return;
            }
            ContactsInternal.startQuickContactWithErrorToastForUser(this.mContext, intent, new UserHandle(managedUserId));
        }
    }

    public final boolean isCrossProfileQuickContactDisabled(int i) {
        return getCrossProfileCallerIdDisabledForUser(i) && getCrossProfileContactsSearchDisabledForUser(i);
    }

    public int getManagedUserId(int i) {
        for (UserInfo userInfo : this.mUserManager.getProfiles(i)) {
            if (userInfo.id != i && userInfo.isManagedProfile()) {
                return userInfo.id;
            }
        }
        return -10000;
    }

    public final int getManagedUserId() {
        UserHandle mainUser = this.mUserManager.getMainUser();
        if (mainUser == null) {
            return -10000;
        }
        return getManagedUserId(mainUser.getIdentifier());
    }

    public void setBluetoothContactSharingDisabled(ComponentName componentName, boolean z) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
            synchronized (getLockObject()) {
                ActiveAdmin profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
                if (profileOwnerOrDeviceOwnerLocked.disableBluetoothContactSharing != z) {
                    profileOwnerOrDeviceOwnerLocked.disableBluetoothContactSharing = z;
                    saveSettingsLocked(callerIdentity.getUserId());
                }
            }
            DevicePolicyEventLogger.createEvent(47).setAdmin(componentName).setBoolean(z).write();
        }
    }

    public boolean getBluetoothContactSharingDisabled(ComponentName componentName) {
        boolean z;
        if (!this.mHasFeature) {
            return false;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        synchronized (getLockObject()) {
            z = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()).disableBluetoothContactSharing;
        }
        return z;
    }

    public boolean getBluetoothContactSharingDisabledForUser(int i) {
        boolean z;
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            z = profileOwnerAdminLocked != null ? profileOwnerAdminLocked.disableBluetoothContactSharing : false;
        }
        return z;
    }

    public void setSecondaryLockscreenEnabled(ComponentName componentName, boolean z) {
        boolean z2;
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        Preconditions.checkCallAuthorization(!isManagedProfile(callerIdentity.getUserId()), "User %d is not allowed to call setSecondaryLockscreenEnabled", new Object[]{Integer.valueOf(callerIdentity.getUserId())});
        synchronized (getLockObject()) {
            if (!isAdminTestOnlyLocked(componentName, callerIdentity.getUserId()) && !isSupervisionComponentLocked(callerIdentity.getComponentName())) {
                z2 = false;
                Preconditions.checkCallAuthorization(z2, "Admin %s is not the default supervision component", new Object[]{callerIdentity.getComponentName()});
                lambda$getUserDataUnchecked$2(callerIdentity.getUserId()).mSecondaryLockscreenEnabled = z;
                saveSettingsLocked(callerIdentity.getUserId());
            }
            z2 = true;
            Preconditions.checkCallAuthorization(z2, "Admin %s is not the default supervision component", new Object[]{callerIdentity.getComponentName()});
            lambda$getUserDataUnchecked$2(callerIdentity.getUserId()).mSecondaryLockscreenEnabled = z;
            saveSettingsLocked(callerIdentity.getUserId());
        }
    }

    public boolean isSecondaryLockscreenEnabled(UserHandle userHandle) {
        boolean z;
        synchronized (getLockObject()) {
            z = lambda$getUserDataUnchecked$2(userHandle.getIdentifier()).mSecondaryLockscreenEnabled;
        }
        return z;
    }

    public final boolean isManagedProfileOwner(CallerIdentity callerIdentity) {
        return isProfileOwner(callerIdentity) && isManagedProfile(callerIdentity.getUserId());
    }

    public void setPreferentialNetworkServiceConfigs(List list) {
        if (this.mHasFeature) {
            CallerIdentity callerIdentity = getCallerIdentity();
            Preconditions.checkCallAuthorization((isProfileOwner(callerIdentity) && isManagedProfile(callerIdentity.getUserId())) || isDefaultDeviceOwner(callerIdentity), "Caller is not managed profile owner or device owner; only managed profile owner or device owner may control the preferential network service");
            synchronized (getLockObject()) {
                ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(callerIdentity.getUserId());
                if (!deviceOrProfileOwnerAdminLocked.mPreferentialNetworkServiceConfigs.equals(list)) {
                    deviceOrProfileOwnerAdminLocked.mPreferentialNetworkServiceConfigs = new ArrayList(list);
                    saveSettingsLocked(callerIdentity.getUserId());
                }
            }
            updateNetworkPreferenceForUser(callerIdentity.getUserId(), list);
            DevicePolicyEventLogger.createEvent(FrameworkStatsLog.DEVICE_POLICY_EVENT__EVENT_ID__SET_PREFERENTIAL_NETWORK_SERVICE_ENABLED).setBoolean(list.stream().anyMatch(new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda60
                @Override // java.util.function.Predicate
                public final boolean test(Object obj) {
                    boolean isEnabled;
                    isEnabled = ((PreferentialNetworkServiceConfig) obj).isEnabled();
                    return isEnabled;
                }
            })).write();
        }
    }

    public List getPreferentialNetworkServiceConfigs() {
        List list;
        if (!this.mHasFeature) {
            return List.of(PreferentialNetworkServiceConfig.DEFAULT);
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization((isProfileOwner(callerIdentity) && isManagedProfile(callerIdentity.getUserId())) || isDefaultDeviceOwner(callerIdentity), "Caller is not managed profile owner or device owner; only managed profile owner or device owner may retrieve the preferential network service configurations");
        synchronized (getLockObject()) {
            list = getDeviceOrProfileOwnerAdminLocked(callerIdentity.getUserId()).mPreferentialNetworkServiceConfigs;
        }
        return list;
    }

    public void setLockTaskPackages(ComponentName componentName, String str, String[] strArr) {
        CallerIdentity callerIdentity;
        EnforcingAdmin enforceCanCallLockTaskLocked;
        LockTaskPolicy lockTaskPolicy;
        Objects.requireNonNull(strArr, "packages is null");
        for (String str2 : strArr) {
            enforceMaxPackageNameLength(str2);
        }
        if (isPolicyEngineForFinanceFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        checkCanExecuteOrThrowUnsafe(19);
        if (isPolicyEngineForFinanceFlagEnabled()) {
            synchronized (getLockObject()) {
                enforceCanCallLockTaskLocked = enforceCanCallLockTaskLocked(componentName, callerIdentity.getPackageName());
            }
            LockTaskPolicy lockTaskPolicy2 = (LockTaskPolicy) this.mDevicePolicyEngine.getLocalPolicySetByAdmin(PolicyDefinition.LOCK_TASK, enforceCanCallLockTaskLocked, callerIdentity.getUserId());
            if (lockTaskPolicy2 == null) {
                lockTaskPolicy = new LockTaskPolicy(Set.of((Object[]) strArr));
            } else {
                LockTaskPolicy lockTaskPolicy3 = new LockTaskPolicy(lockTaskPolicy2);
                lockTaskPolicy3.setPackages(Set.of((Object[]) strArr));
                lockTaskPolicy = lockTaskPolicy3;
            }
            if (lockTaskPolicy.getPackages().isEmpty()) {
                this.mDevicePolicyEngine.removeLocalPolicy(PolicyDefinition.LOCK_TASK, enforceCanCallLockTaskLocked, callerIdentity.getUserId());
                return;
            } else {
                this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.LOCK_TASK, enforceCanCallLockTaskLocked, lockTaskPolicy, callerIdentity.getUserId());
                return;
            }
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        synchronized (getLockObject()) {
            enforceCanCallLockTaskLocked(callerIdentity);
            setLockTaskPackagesLocked(callerIdentity.getUserId(), new ArrayList(Arrays.asList(strArr)));
        }
    }

    public final void setLockTaskPackagesLocked(int i, List list) {
        lambda$getUserDataUnchecked$2(i).mLockTaskPackages = list;
        saveSettingsLocked(i);
        updateLockTaskPackagesLocked(this.mContext, list, i);
    }

    public String[] getLockTaskPackages(ComponentName componentName, String str) {
        CallerIdentity callerIdentity;
        String[] strArr;
        if (isPolicyEngineForFinanceFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        int userId = callerIdentity.getUserId();
        if (isPolicyEngineForFinanceFlagEnabled()) {
            synchronized (getLockObject()) {
                enforceCanQueryLockTaskLocked(componentName, callerIdentity.getPackageName());
            }
            LockTaskPolicy lockTaskPolicy = (LockTaskPolicy) this.mDevicePolicyEngine.getResolvedPolicy(PolicyDefinition.LOCK_TASK, userId);
            return lockTaskPolicy == null ? new String[0] : (String[]) lockTaskPolicy.getPackages().toArray(new String[lockTaskPolicy.getPackages().size()]);
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        synchronized (getLockObject()) {
            enforceCanCallLockTaskLocked(callerIdentity);
            List list = lambda$getUserDataUnchecked$2(userId).mLockTaskPackages;
            strArr = (String[]) list.toArray(new String[list.size()]);
        }
        return strArr;
    }

    public boolean isLockTaskPermitted(String str) {
        boolean contains;
        if (listPolicyExemptAppsUnchecked(this.mContext).contains(str)) {
            return true;
        }
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        if (isPolicyEngineForFinanceFlagEnabled()) {
            LockTaskPolicy lockTaskPolicy = (LockTaskPolicy) this.mDevicePolicyEngine.getResolvedPolicy(PolicyDefinition.LOCK_TASK, userHandleGetCallingUserId);
            if (lockTaskPolicy == null) {
                return false;
            }
            return lockTaskPolicy.getPackages().contains(str);
        }
        synchronized (getLockObject()) {
            contains = lambda$getUserDataUnchecked$2(userHandleGetCallingUserId).mLockTaskPackages.contains(str);
        }
        return contains;
    }

    public void setLockTaskFeatures(ComponentName componentName, String str, int i) {
        CallerIdentity callerIdentity;
        EnforcingAdmin enforceCanCallLockTaskLocked;
        LockTaskPolicy lockTaskPolicy;
        boolean z = true;
        boolean z2 = (i & 4) != 0;
        Preconditions.checkArgument(z2 || !((i & 8) != 0), "Cannot use LOCK_TASK_FEATURE_OVERVIEW without LOCK_TASK_FEATURE_HOME");
        boolean z3 = (i & 2) != 0;
        if (!z2 && z3) {
            z = false;
        }
        Preconditions.checkArgument(z, "Cannot use LOCK_TASK_FEATURE_NOTIFICATIONS without LOCK_TASK_FEATURE_HOME");
        if (isPolicyEngineForFinanceFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        int userId = callerIdentity.getUserId();
        synchronized (getLockObject()) {
            checkCanExecuteOrThrowUnsafe(18);
        }
        if (isPolicyEngineForFinanceFlagEnabled()) {
            synchronized (getLockObject()) {
                enforceCanCallLockTaskLocked = enforceCanCallLockTaskLocked(componentName, callerIdentity.getPackageName());
                enforceCanSetLockTaskFeaturesOnFinancedDevice(callerIdentity, i);
            }
            LockTaskPolicy lockTaskPolicy2 = (LockTaskPolicy) this.mDevicePolicyEngine.getLocalPolicySetByAdmin(PolicyDefinition.LOCK_TASK, enforceCanCallLockTaskLocked, callerIdentity.getUserId());
            if (lockTaskPolicy2 == null) {
                lockTaskPolicy = new LockTaskPolicy(i);
            } else {
                LockTaskPolicy lockTaskPolicy3 = new LockTaskPolicy(lockTaskPolicy2);
                lockTaskPolicy3.setFlags(i);
                lockTaskPolicy = lockTaskPolicy3;
            }
            if (lockTaskPolicy.getPackages().isEmpty() && lockTaskPolicy.getFlags() == 0) {
                this.mDevicePolicyEngine.removeLocalPolicy(PolicyDefinition.LOCK_TASK, enforceCanCallLockTaskLocked, callerIdentity.getUserId());
                return;
            } else {
                this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.LOCK_TASK, enforceCanCallLockTaskLocked, lockTaskPolicy, callerIdentity.getUserId());
                return;
            }
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        synchronized (getLockObject()) {
            enforceCanCallLockTaskLocked(callerIdentity);
            enforceCanSetLockTaskFeaturesOnFinancedDevice(callerIdentity, i);
            setLockTaskFeaturesLocked(userId, i);
        }
    }

    public final void setLockTaskFeaturesLocked(int i, int i2) {
        lambda$getUserDataUnchecked$2(i).mLockTaskFeatures = i2;
        saveSettingsLocked(i);
        updateLockTaskFeaturesLocked(i2, i);
    }

    public int getLockTaskFeatures(ComponentName componentName, String str) {
        CallerIdentity callerIdentity;
        int i;
        if (isPolicyEngineForFinanceFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        int userId = callerIdentity.getUserId();
        if (isPolicyEngineForFinanceFlagEnabled()) {
            synchronized (getLockObject()) {
                enforceCanQueryLockTaskLocked(componentName, callerIdentity.getPackageName());
            }
            LockTaskPolicy lockTaskPolicy = (LockTaskPolicy) this.mDevicePolicyEngine.getResolvedPolicy(PolicyDefinition.LOCK_TASK, userId);
            if (lockTaskPolicy == null) {
                return 16;
            }
            return lockTaskPolicy.getFlags();
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        synchronized (getLockObject()) {
            enforceCanCallLockTaskLocked(callerIdentity);
            i = lambda$getUserDataUnchecked$2(userId).mLockTaskFeatures;
        }
        return i;
    }

    public final void maybeClearLockTaskPolicyLocked() {
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda15
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$maybeClearLockTaskPolicyLocked$113();
            }
        });
    }

    public /* synthetic */ void lambda$maybeClearLockTaskPolicyLocked$113() {
        List aliveUsers = this.mUserManager.getAliveUsers();
        for (int size = aliveUsers.size() - 1; size >= 0; size--) {
            int i = ((UserInfo) aliveUsers.get(size)).id;
            if (!canDPCManagedUserUseLockTaskLocked(i)) {
                if (isPolicyEngineForFinanceFlagEnabled()) {
                    for (EnforcingAdmin enforcingAdmin : new HashSet(this.mDevicePolicyEngine.getLocalPoliciesSetByAdmins(PolicyDefinition.LOCK_TASK, i).keySet())) {
                        if (enforcingAdmin.hasAuthority("enterprise")) {
                            this.mDevicePolicyEngine.removeLocalPolicy(PolicyDefinition.LOCK_TASK, enforcingAdmin, i);
                        }
                    }
                } else {
                    if (!lambda$getUserDataUnchecked$2(i).mLockTaskPackages.isEmpty()) {
                        Slogf.d("DevicePolicyManager", "User id " + i + " not affiliated. Clearing lock task packages");
                        setLockTaskPackagesLocked(i, Collections.emptyList());
                    }
                    if (lambda$getUserDataUnchecked$2(i).mLockTaskFeatures != 0) {
                        Slogf.d("DevicePolicyManager", "User id " + i + " not affiliated. Clearing lock task features");
                        setLockTaskFeaturesLocked(i, 0);
                    }
                }
            }
        }
    }

    public final void enforceCanSetLockTaskFeaturesOnFinancedDevice(CallerIdentity callerIdentity, int i) {
        if (isFinancedDeviceOwner(callerIdentity) && (i & (-120)) != 0) {
            throw new SecurityException("Permitted lock task features when managing a financed device: LOCK_TASK_FEATURE_SYSTEM_INFO, LOCK_TASK_FEATURE_KEYGUARD, LOCK_TASK_FEATURE_HOME, LOCK_TASK_FEATURE_GLOBAL_ACTIONS, LOCK_TASK_FEATURE_NOTIFICATIONS or LOCK_TASK_FEATURE_BLOCK_ACTIVITY_START_IN_TASK");
        }
    }

    public void notifyLockTaskModeChanged(boolean z, String str, int i) {
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()), String.format("Only the system can %s", "call notifyLockTaskModeChanged"));
        synchronized (getLockObject()) {
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            if (lambda$getUserDataUnchecked$2.mStatusBarDisabled) {
                setStatusBarDisabledInternal(!z, i);
            }
            Bundle bundle = new Bundle();
            bundle.putString("android.app.extra.LOCK_TASK_PACKAGE", str);
            Iterator it = lambda$getUserDataUnchecked$2.mAdminList.iterator();
            while (it.hasNext()) {
                ActiveAdmin activeAdmin = (ActiveAdmin) it.next();
                boolean isDeviceOwner = isDeviceOwner(activeAdmin.info.getComponent(), i);
                boolean isProfileOwner = isProfileOwner(activeAdmin.info.getComponent(), i);
                if (isDeviceOwner || isProfileOwner) {
                    String str2 = null;
                    if (z) {
                        sendAdminCommandLocked(activeAdmin, "android.app.action.LOCK_TASK_ENTERING", bundle, (BroadcastReceiver) null);
                    } else {
                        sendAdminCommandLocked(activeAdmin, "android.app.action.LOCK_TASK_EXITING");
                    }
                    DevicePolicyEventLogger createEvent = DevicePolicyEventLogger.createEvent(51);
                    DeviceAdminInfo deviceAdminInfo = activeAdmin.info;
                    if (deviceAdminInfo != null) {
                        str2 = deviceAdminInfo.getPackageName();
                    }
                    createEvent.setAdmin(str2).setBoolean(z).setStrings(new String[]{str}).write();
                }
            }
        }
        for (EnforcingAdmin enforcingAdmin : this.mDevicePolicyEngine.getLocalPoliciesSetByAdmins(PolicyDefinition.LOCK_TASK, i).keySet()) {
            if (!enforcingAdmin.hasAuthority("enterprise")) {
                DevicePolicyEventLogger.createEvent(51).setAdmin(enforcingAdmin.getPackageName()).setBoolean(z).setStrings(new String[]{str}).write();
            }
        }
    }

    public void setGlobalSetting(ComponentName componentName, final String str, final String str2) {
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        if ("allow_work_profile_telephony_for_non_dpm_role_holders".equals(str)) {
            Preconditions.checkCallAuthorization(isCallerDevicePolicyManagementRoleHolder(callerIdentity));
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda80
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setGlobalSetting$114(str, str2);
                }
            });
            return;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity));
        DevicePolicyEventLogger.createEvent(111).setAdmin(componentName).setStrings(new String[]{str, str2}).write();
        synchronized (getLockObject()) {
            if (GLOBAL_SETTINGS_DEPRECATED.contains(str)) {
                Slogf.i("DevicePolicyManager", "Global setting no longer supported: %s", str);
                return;
            }
            if (!GLOBAL_SETTINGS_ALLOWLIST.contains(str) && !UserManager.isDeviceInDemoMode(this.mContext)) {
                throw new SecurityException(String.format("Permission denial: device owners cannot update %1$s", str));
            }
            if ("stay_on_while_plugged_in".equals(str)) {
                long maximumTimeToLock = getMaximumTimeToLock(componentName, this.mInjector.userHandleGetCallingUserId(), false);
                if (maximumTimeToLock > 0 && maximumTimeToLock < Long.MAX_VALUE) {
                    return;
                }
            }
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda81
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setGlobalSetting$115(str, str2);
                }
            });
        }
    }

    public /* synthetic */ void lambda$setGlobalSetting$114(String str, String str2) {
        this.mInjector.settingsGlobalPutString(str, str2);
    }

    public /* synthetic */ void lambda$setGlobalSetting$115(String str, String str2) {
        this.mInjector.settingsGlobalPutString(str, str2);
    }

    public void setSystemSetting(ComponentName componentName, final String str, final String str2) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkStringNotEmpty(str, "String setting is null or empty");
        final CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        checkCanExecuteOrThrowUnsafe(11);
        synchronized (getLockObject()) {
            if (!SYSTEM_SETTINGS_ALLOWLIST.contains(str)) {
                throw new SecurityException(String.format("Permission denial: device owners cannot update %1$s", str));
            }
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda38
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setSystemSetting$116(str, str2, callerIdentity);
                }
            });
        }
    }

    public /* synthetic */ void lambda$setSystemSetting$116(String str, String str2, CallerIdentity callerIdentity) {
        this.mInjector.settingsSystemPutStringForUser(str, str2, callerIdentity.getUserId());
    }

    public void setConfiguredNetworksLockdownState(ComponentName componentName, String str, final boolean z) {
        CallerIdentity callerIdentity;
        if (this.mHasFeature) {
            if (isPermissionCheckFlagEnabled()) {
                callerIdentity = getCallerIdentity(componentName, str);
                enforcePermission("android.permission.MANAGE_DEVICE_POLICY_WIFI", callerIdentity.getPackageName(), -1);
            } else {
                CallerIdentity callerIdentity2 = getCallerIdentity(componentName);
                Preconditions.checkNotNull(componentName, "ComponentName is null");
                Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity2) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity2));
                callerIdentity = callerIdentity2;
            }
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda87
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setConfiguredNetworksLockdownState$117(z);
                }
            });
            DevicePolicyEventLogger.createEvent(132).setAdmin(callerIdentity.getPackageName()).setBoolean(z).write();
        }
    }

    public /* synthetic */ void lambda$setConfiguredNetworksLockdownState$117(boolean z) {
        this.mInjector.settingsGlobalPutInt("wifi_device_owner_configs_lockdown", z ? 1 : 0);
    }

    public boolean hasLockdownAdminConfiguredNetworks(ComponentName componentName) {
        if (!this.mHasFeature) {
            return false;
        }
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        if (isPermissionCheckFlagEnabled()) {
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_WIFI", componentName.getPackageName(), -1);
        } else {
            Preconditions.checkNotNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        }
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda52
            public final Object getOrThrow() {
                Boolean lambda$hasLockdownAdminConfiguredNetworks$118;
                lambda$hasLockdownAdminConfiguredNetworks$118 = DevicePolicyManagerService.this.lambda$hasLockdownAdminConfiguredNetworks$118();
                return lambda$hasLockdownAdminConfiguredNetworks$118;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$hasLockdownAdminConfiguredNetworks$118() {
        return Boolean.valueOf(this.mInjector.settingsGlobalGetInt("wifi_device_owner_configs_lockdown", 0) > 0);
    }

    public void setLocationEnabled(ComponentName componentName, final boolean z) {
        Preconditions.checkNotNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity));
        final UserHandle userHandle = callerIdentity.getUserHandle();
        if (this.mIsAutomotive && !z) {
            Slogf.i("DevicePolicyManager", "setLocationEnabled(%s, %b): ignoring for user %s on automotive build", componentName.flattenToShortString(), Boolean.valueOf(z), userHandle);
            return;
        }
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda132
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setLocationEnabled$119(userHandle, z);
            }
        });
        DevicePolicyEventLogger admin = DevicePolicyEventLogger.createEvent(14).setAdmin(componentName);
        String[] strArr = new String[2];
        strArr[0] = "location_mode";
        strArr[1] = Integer.toString(z ? 3 : 0);
        admin.setStrings(strArr).write();
    }

    public /* synthetic */ void lambda$setLocationEnabled$119(UserHandle userHandle, boolean z) {
        boolean isLocationEnabledForUser = this.mInjector.getLocationManager().isLocationEnabledForUser(userHandle);
        Slogf.v("DevicePolicyManager", "calling locationMgr.setLocationEnabledForUser(%b, %s) when it was %b", Boolean.valueOf(z), userHandle, Boolean.valueOf(isLocationEnabledForUser));
        this.mInjector.getLocationManager().setLocationEnabledForUser(z, userHandle);
        if (!z || isLocationEnabledForUser) {
            return;
        }
        showLocationSettingsEnabledNotification(userHandle);
    }

    public final void showLocationSettingsEnabledNotification(UserHandle userHandle) {
        Intent addFlags = new Intent("android.settings.LOCATION_SOURCE_SETTINGS").addFlags(268435456);
        ActivityInfo resolveActivityInfo = addFlags.resolveActivityInfo(this.mInjector.getPackageManager(userHandle.getIdentifier()), 1048576);
        if (resolveActivityInfo != null) {
            addFlags.setComponent(resolveActivityInfo.getComponentName());
        } else {
            Slogf.wtf("DevicePolicyManager", "Failed to resolve intent for location settings");
        }
        final Notification build = new Notification.Builder(this.mContext, SystemNotificationChannels.DEVICE_ADMIN).setSmallIcon(R.drawable.ic_media_route_connected_dark_03_mtrl).setContentTitle(getLocationChangedTitle()).setContentText(getLocationChangedText()).setColor(this.mContext.getColor(R.color.system_notification_accent_color)).setShowWhen(true).setContentIntent(this.mInjector.pendingIntentGetActivityAsUser(this.mContext, 0, addFlags, 201326592, null, userHandle)).setAutoCancel(true).build();
        this.mHandler.post(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda208
            @Override // java.lang.Runnable
            public final void run() {
                DevicePolicyManagerService.this.lambda$showLocationSettingsEnabledNotification$120(build);
            }
        });
    }

    public /* synthetic */ void lambda$showLocationSettingsEnabledNotification$120(Notification notification) {
        this.mInjector.getNotificationManager().notify(59, notification);
    }

    public final String getLocationChangedTitle() {
        return getUpdatableString("Core.LOCATION_CHANGED_TITLE", R.string.preposition_for_date, new Object[0]);
    }

    public final String getLocationChangedText() {
        return getUpdatableString("Core.LOCATION_CHANGED_MESSAGE", R.string.prepend_shortcut_label, new Object[0]);
    }

    public boolean setTime(ComponentName componentName, String str, final long j) {
        CallerIdentity callerIdentity;
        if (isPermissionCheckFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
            enforcePermission("android.permission.SET_TIME", callerIdentity.getPackageName(), -1);
        } else {
            CallerIdentity callerIdentity2 = getCallerIdentity(componentName);
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity2) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity2));
            callerIdentity = callerIdentity2;
        }
        if (this.mInjector.settingsGlobalGetInt("auto_time", 0) == 1) {
            return false;
        }
        DevicePolicyEventLogger.createEvent(133).setAdmin(callerIdentity.getPackageName()).write();
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda196
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setTime$121(j);
            }
        });
        return true;
    }

    public /* synthetic */ void lambda$setTime$121(long j) {
        this.mInjector.getAlarmManager().setTime(j);
    }

    public boolean setTimeZone(ComponentName componentName, String str, final String str2) {
        CallerIdentity callerIdentity;
        if (isPermissionCheckFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
            enforcePermission("android.permission.SET_TIME_ZONE", callerIdentity.getPackageName(), -1);
        } else {
            CallerIdentity callerIdentity2 = getCallerIdentity(componentName);
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity2) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity2));
            callerIdentity = callerIdentity2;
        }
        if (this.mInjector.settingsGlobalGetInt("auto_time_zone", 0) == 1) {
            return false;
        }
        final String str3 = "DevicePolicyManager.setTimeZone()";
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda136
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setTimeZone$122(str2, str3);
            }
        });
        DevicePolicyEventLogger.createEvent(134).setAdmin(callerIdentity.getPackageName()).write();
        return true;
    }

    public /* synthetic */ void lambda$setTimeZone$122(String str, String str2) {
        this.mInjector.getAlarmManagerInternal().setTimeZone(str, 100, str2);
    }

    public void setSecureSetting(ComponentName componentName, final String str, final String str2) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        final int userId = callerIdentity.getUserId();
        synchronized (getLockObject()) {
            if (isDeviceOwner(componentName, userId)) {
                if (!SECURE_SETTINGS_DEVICEOWNER_ALLOWLIST.contains(str) && !isCurrentUserDemo()) {
                    throw new SecurityException(String.format("Permission denial: Device owners cannot update %1$s", str));
                }
            } else if (!SECURE_SETTINGS_ALLOWLIST.contains(str) && !isCurrentUserDemo()) {
                throw new SecurityException(String.format("Permission denial: Profile owners cannot update %1$s", str));
            }
            if (str.equals("location_mode") && isSetSecureSettingLocationModeCheckEnabled(componentName.getPackageName(), userId)) {
                throw new UnsupportedOperationException("location_mode is deprecated. Please use setLocationEnabled() instead.");
            }
            if (str.equals("install_non_market_apps")) {
                if (getTargetSdk(componentName.getPackageName(), userId) >= 26) {
                    throw new UnsupportedOperationException("install_non_market_apps is deprecated. Please use one of the user restrictions no_install_unknown_sources or no_install_unknown_sources_globally instead.");
                }
                if (!this.mUserManager.isManagedProfile(userId)) {
                    Slogf.e("DevicePolicyManager", "Ignoring setSecureSetting request for " + str + ". User restriction no_install_unknown_sources or no_install_unknown_sources_globally should be used instead.");
                } else {
                    try {
                        setUserRestriction(componentName, componentName.getPackageName(), "no_install_unknown_sources", Integer.parseInt(str2) == 0, false);
                        DevicePolicyEventLogger.createEvent(14).setAdmin(componentName).setStrings(new String[]{str, str2}).write();
                    } catch (NumberFormatException unused) {
                        Slogf.e("DevicePolicyManager", "Invalid value: " + str2 + " for setting " + str);
                    }
                }
                return;
            }
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda120
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setSecureSetting$123(str, userId, str2);
                }
            });
            DevicePolicyEventLogger.createEvent(14).setAdmin(componentName).setStrings(new String[]{str, str2}).write();
        }
    }

    public /* synthetic */ void lambda$setSecureSetting$123(String str, int i, String str2) {
        if ("default_input_method".equals(str)) {
            if (!TextUtils.equals(this.mInjector.settingsSecureGetStringForUser("default_input_method", i), str2)) {
                this.mSetupContentObserver.addPendingChangeByOwnerLocked(i);
            }
            lambda$getUserDataUnchecked$2(i).mCurrentInputMethodSet = true;
            saveSettingsLocked(i);
        }
        this.mInjector.settingsSecurePutStringForUser(str, str2, i);
        if (!str.equals("location_mode") || Integer.parseInt(str2) == 0) {
            return;
        }
        showLocationSettingsEnabledNotification(UserHandle.of(i));
    }

    public final boolean isSetSecureSettingLocationModeCheckEnabled(String str, int i) {
        return this.mInjector.isChangeEnabled(117835097L, str, i);
    }

    public void setMasterVolumeMuted(ComponentName componentName, boolean z) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        checkCanExecuteOrThrowUnsafe(35);
        synchronized (getLockObject()) {
            setUserRestriction(componentName, componentName.getPackageName(), "disallow_unmute_device", z, false);
            DevicePolicyEventLogger.createEvent(35).setAdmin(componentName).setBoolean(z).write();
        }
    }

    public boolean isMasterVolumeMuted(ComponentName componentName) {
        boolean isMasterMute;
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        synchronized (getLockObject()) {
            isMasterMute = ((AudioManager) this.mContext.getSystemService("audio")).isMasterMute();
        }
        return isMasterMute;
    }

    public void setUserIcon(ComponentName componentName, final Bitmap bitmap) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        final CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        synchronized (getLockObject()) {
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda125
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setUserIcon$124(callerIdentity, bitmap);
                }
            });
        }
        DevicePolicyEventLogger.createEvent(41).setAdmin(componentName).write();
    }

    public /* synthetic */ void lambda$setUserIcon$124(CallerIdentity callerIdentity, Bitmap bitmap) {
        this.mUserManagerInternal.setUserIcon(callerIdentity.getUserId(), bitmap);
    }

    public boolean setKeyguardDisabled(ComponentName componentName, boolean z) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        int userId = callerIdentity.getUserId();
        synchronized (getLockObject()) {
            Preconditions.checkCallAuthorization(isUserAffiliatedWithDeviceLocked(userId), String.format("Admin %s is neither the device owner or affiliated user's profile owner.", componentName));
        }
        if (isManagedProfile(userId)) {
            throw new SecurityException("Managed profile cannot disable keyguard");
        }
        checkCanExecuteOrThrowUnsafe(12);
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        if (z) {
            try {
                if (this.mLockPatternUtils.isSecure(userId)) {
                    this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                    return false;
                }
            } catch (RemoteException unused) {
            } catch (Throwable th) {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                throw th;
            }
        }
        this.mLockPatternUtils.setLockScreenDisabled(z, userId);
        if (z) {
            this.mInjector.getIWindowManager().dismissKeyguard((IKeyguardDismissCallback) null, (CharSequence) null);
        }
        DevicePolicyEventLogger.createEvent(37).setAdmin(componentName).setBoolean(z).write();
        this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        return true;
    }

    public boolean setStatusBarDisabled(ComponentName componentName, String str, boolean z) {
        CallerIdentity callerIdentity;
        boolean z2;
        if (isUnicornFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        if (isUnicornFlagEnabled()) {
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_STATUS_BAR", callerIdentity.getPackageName(), -1);
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        }
        int userId = callerIdentity.getUserId();
        synchronized (getLockObject()) {
            if (!isUnicornFlagEnabled()) {
                Preconditions.checkCallAuthorization(isUserAffiliatedWithDeviceLocked(userId), "Admin " + componentName + " is neither the device owner or affiliated user's profile owner.");
                if (isManagedProfile(userId)) {
                    throw new SecurityException("Managed profile cannot disable status bar");
                }
            }
            checkCanExecuteOrThrowUnsafe(13);
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(userId);
            if (lambda$getUserDataUnchecked$2.mStatusBarDisabled != z) {
                try {
                } catch (RemoteException unused) {
                    Slogf.e("DevicePolicyManager", "Failed to get LockTask mode");
                }
                if (this.mInjector.getIActivityTaskManager().getLockTaskModeState() != 0) {
                    z2 = true;
                    if (z2 && !setStatusBarDisabledInternal(z, userId)) {
                        return false;
                    }
                    lambda$getUserDataUnchecked$2.mStatusBarDisabled = z;
                    saveSettingsLocked(userId);
                }
                z2 = false;
                if (z2) {
                }
                lambda$getUserDataUnchecked$2.mStatusBarDisabled = z;
                saveSettingsLocked(userId);
            }
            DevicePolicyEventLogger.createEvent(38).setAdmin(callerIdentity.getPackageName()).setBoolean(z).write();
            return true;
        }
    }

    public final boolean setStatusBarDisabledInternal(boolean z, int i) {
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            try {
                IStatusBarService asInterface = IStatusBarService.Stub.asInterface(ServiceManager.checkService("statusbar"));
                if (asInterface != null) {
                    int i2 = z ? 34013184 : 0;
                    int i3 = z ? 1 : 0;
                    asInterface.disableForUser(i2, this.mToken, this.mContext.getPackageName(), i);
                    asInterface.disable2ForUser(i3, this.mToken, this.mContext.getPackageName(), i);
                    return true;
                }
            } catch (RemoteException e) {
                Slogf.e("DevicePolicyManager", "Failed to disable the status bar", e);
            }
            return false;
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public boolean isStatusBarDisabled(String str) {
        boolean z;
        CallerIdentity callerIdentity = getCallerIdentity(str);
        if (isUnicornFlagEnabled()) {
            enforceCanQuery("android.permission.MANAGE_DEVICE_POLICY_STATUS_BAR", callerIdentity.getPackageName(), callerIdentity.getUserId());
        } else {
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        }
        int userId = callerIdentity.getUserId();
        synchronized (getLockObject()) {
            if (!isUnicornFlagEnabled()) {
                Preconditions.checkCallAuthorization(isUserAffiliatedWithDeviceLocked(userId), "Admin " + str + " is neither the device owner or affiliated user's profile owner.");
                if (isManagedProfile(userId)) {
                    throw new SecurityException("Managed profile cannot disable status bar");
                }
            }
            z = lambda$getUserDataUnchecked$2(userId).mStatusBarDisabled;
        }
        return z;
    }

    public final Set getPackagesSuspendedByAdmin(int i) {
        synchronized (getLockObject()) {
            ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(i);
            if (deviceOrProfileOwnerAdminLocked != null && deviceOrProfileOwnerAdminLocked.suspendedPackages != null) {
                return new ArraySet(deviceOrProfileOwnerAdminLocked.suspendedPackages);
            }
            return Collections.emptySet();
        }
    }

    public void updateUserSetupCompleteAndPaired() {
        List aliveUsers = this.mUserManager.getAliveUsers();
        int size = aliveUsers.size();
        for (int i = 0; i < size; i++) {
            int i2 = ((UserInfo) aliveUsers.get(i)).id;
            if (this.mInjector.settingsSecureGetIntForUser("user_setup_complete", 0, i2) != 0) {
                DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i2);
                if (!lambda$getUserDataUnchecked$2.mUserSetupComplete) {
                    lambda$getUserDataUnchecked$2.mUserSetupComplete = true;
                    if (i2 == 0) {
                        this.mStateCache.setDeviceProvisioned(true);
                    }
                    synchronized (getLockObject()) {
                        saveSettingsLocked(i2);
                    }
                }
            }
            if (this.mIsWatch && this.mInjector.settingsSecureGetIntForUser("device_paired", 0, i2) != 0) {
                DevicePolicyData lambda$getUserDataUnchecked$22 = lambda$getUserDataUnchecked$2(i2);
                if (lambda$getUserDataUnchecked$22.mPaired) {
                    continue;
                } else {
                    lambda$getUserDataUnchecked$22.mPaired = true;
                    synchronized (getLockObject()) {
                        saveSettingsLocked(i2);
                    }
                }
            }
        }
    }

    /* loaded from: classes2.dex */
    public class SetupContentObserver extends ContentObserver {
        public final Uri mDefaultImeChanged;
        public final Uri mDeviceProvisioned;
        public final Uri mPaired;
        public Set mUserIdsWithPendingChangesByOwner;
        public final Uri mUserSetupComplete;

        public SetupContentObserver(Handler handler) {
            super(handler);
            this.mUserSetupComplete = Settings.Secure.getUriFor("user_setup_complete");
            this.mDeviceProvisioned = Settings.Global.getUriFor("device_provisioned");
            this.mPaired = Settings.Secure.getUriFor("device_paired");
            this.mDefaultImeChanged = Settings.Secure.getUriFor("default_input_method");
            this.mUserIdsWithPendingChangesByOwner = new ArraySet();
        }

        public void register() {
            DevicePolicyManagerService.this.mInjector.registerContentObserver(this.mUserSetupComplete, false, this, -1);
            DevicePolicyManagerService.this.mInjector.registerContentObserver(this.mDeviceProvisioned, false, this, -1);
            DevicePolicyManagerService devicePolicyManagerService = DevicePolicyManagerService.this;
            if (devicePolicyManagerService.mIsWatch) {
                devicePolicyManagerService.mInjector.registerContentObserver(this.mPaired, false, this, -1);
            }
            DevicePolicyManagerService.this.mInjector.registerContentObserver(this.mDefaultImeChanged, false, this, -1);
        }

        public final void addPendingChangeByOwnerLocked(int i) {
            this.mUserIdsWithPendingChangesByOwner.add(Integer.valueOf(i));
        }

        @Override // android.database.ContentObserver
        public void onChange(boolean z, Uri uri, int i) {
            if (this.mUserSetupComplete.equals(uri) || (DevicePolicyManagerService.this.mIsWatch && this.mPaired.equals(uri))) {
                DevicePolicyManagerService.this.updateUserSetupCompleteAndPaired();
                return;
            }
            if (this.mDeviceProvisioned.equals(uri)) {
                synchronized (DevicePolicyManagerService.this.getLockObject()) {
                    DevicePolicyManagerService.this.setDeviceOwnershipSystemPropertyLocked();
                }
            } else if (this.mDefaultImeChanged.equals(uri)) {
                synchronized (DevicePolicyManagerService.this.getLockObject()) {
                    if (this.mUserIdsWithPendingChangesByOwner.contains(Integer.valueOf(i))) {
                        this.mUserIdsWithPendingChangesByOwner.remove(Integer.valueOf(i));
                    } else {
                        DevicePolicyManagerService.this.lambda$getUserDataUnchecked$2(i).mCurrentInputMethodSet = false;
                        DevicePolicyManagerService.this.saveSettingsLocked(i);
                    }
                }
            }
        }
    }

    /* loaded from: classes2.dex */
    public class DevicePolicyConstantsObserver extends ContentObserver {
        public final Uri mConstantsUri;

        public DevicePolicyConstantsObserver(Handler handler) {
            super(handler);
            this.mConstantsUri = Settings.Global.getUriFor("device_policy_constants");
        }

        public void register() {
            DevicePolicyManagerService.this.mInjector.registerContentObserver(this.mConstantsUri, false, this, -1);
        }

        @Override // android.database.ContentObserver
        public void onChange(boolean z, Uri uri, int i) {
            DevicePolicyManagerService devicePolicyManagerService = DevicePolicyManagerService.this;
            devicePolicyManagerService.mConstants = devicePolicyManagerService.loadConstants();
            DevicePolicyManagerService.invalidateBinderCaches();
            DevicePolicyManagerService.this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$DevicePolicyConstantsObserver$$ExternalSyntheticLambda0
                public final void runOrThrow() {
                    DevicePolicyManagerService.DevicePolicyConstantsObserver.this.lambda$onChange$0();
                }
            });
        }

        public /* synthetic */ void lambda$onChange$0() {
            Intent intent = new Intent("android.app.action.DEVICE_POLICY_CONSTANTS_CHANGED");
            intent.setFlags(1073741824);
            List aliveUsers = DevicePolicyManagerService.this.mUserManager.getAliveUsers();
            for (int i = 0; i < aliveUsers.size(); i++) {
                DevicePolicyManagerService.this.mContext.sendBroadcastAsUser(intent, UserHandle.of(((UserInfo) aliveUsers.get(i)).id));
            }
        }
    }

    /* loaded from: classes2.dex */
    public final class LocalService extends DevicePolicyManagerInternal implements DevicePolicyManagerLiteInternal {
        public List mWidgetProviderListeners;

        public LocalService() {
        }

        public List getCrossProfileWidgetProviders(int i) {
            List list;
            synchronized (DevicePolicyManagerService.this.getLockObject()) {
                Owners owners = DevicePolicyManagerService.this.mOwners;
                if (owners == null) {
                    return Collections.emptyList();
                }
                ComponentName profileOwnerComponent = owners.getProfileOwnerComponent(i);
                if (profileOwnerComponent == null) {
                    return Collections.emptyList();
                }
                ActiveAdmin activeAdmin = (ActiveAdmin) DevicePolicyManagerService.this.getUserDataUnchecked(i).mAdminMap.get(profileOwnerComponent);
                if (activeAdmin != null && (list = activeAdmin.crossProfileWidgetProviders) != null && !list.isEmpty()) {
                    return activeAdmin.crossProfileWidgetProviders;
                }
                return Collections.emptyList();
            }
        }

        public void addOnCrossProfileWidgetProvidersChangeListener(DevicePolicyManagerInternal.OnCrossProfileWidgetProvidersChangeListener onCrossProfileWidgetProvidersChangeListener) {
            synchronized (DevicePolicyManagerService.this.getLockObject()) {
                if (this.mWidgetProviderListeners == null) {
                    this.mWidgetProviderListeners = new ArrayList();
                }
                if (!this.mWidgetProviderListeners.contains(onCrossProfileWidgetProvidersChangeListener)) {
                    this.mWidgetProviderListeners.add(onCrossProfileWidgetProvidersChangeListener);
                }
            }
        }

        public ComponentName getProfileOwnerOrDeviceOwnerSupervisionComponent(UserHandle userHandle) {
            return DevicePolicyManagerService.this.getProfileOwnerOrDeviceOwnerSupervisionComponent(userHandle);
        }

        public boolean isActiveDeviceOwner(int i) {
            return DevicePolicyManagerService.this.isDefaultDeviceOwner(new CallerIdentity(i, null, null));
        }

        public boolean isActiveProfileOwner(int i) {
            return DevicePolicyManagerService.this.isProfileOwner(new CallerIdentity(i, null, null));
        }

        public boolean isActiveSupervisionApp(int i) {
            if (!DevicePolicyManagerService.this.isProfileOwner(new CallerIdentity(i, null, null))) {
                return false;
            }
            synchronized (DevicePolicyManagerService.this.getLockObject()) {
                ActiveAdmin profileOwnerAdminLocked = DevicePolicyManagerService.this.getProfileOwnerAdminLocked(UserHandle.getUserId(i));
                if (profileOwnerAdminLocked == null) {
                    return false;
                }
                return DevicePolicyManagerService.this.isSupervisionComponentLocked(profileOwnerAdminLocked.info.getComponent());
            }
        }

        public final void notifyCrossProfileProvidersChanged(int i, List list) {
            ArrayList arrayList;
            synchronized (DevicePolicyManagerService.this.getLockObject()) {
                arrayList = new ArrayList(this.mWidgetProviderListeners);
            }
            int size = arrayList.size();
            for (int i2 = 0; i2 < size; i2++) {
                ((DevicePolicyManagerInternal.OnCrossProfileWidgetProvidersChangeListener) arrayList.get(i2)).onCrossProfileWidgetProvidersChanged(i, list);
            }
        }

        public Intent createShowAdminSupportIntent(int i, boolean z) {
            if (DevicePolicyManagerService.this.getEnforcingAdminAndUserDetailsInternal(i, null) != null || z) {
                return DevicePolicyManagerService.this.createShowAdminSupportIntent(i);
            }
            return null;
        }

        public Intent createUserRestrictionSupportIntent(int i, String str) {
            if (DevicePolicyManagerService.this.getEnforcingAdminAndUserDetailsInternal(i, str) == null) {
                return null;
            }
            Intent createShowAdminSupportIntent = DevicePolicyManagerService.this.createShowAdminSupportIntent(i);
            createShowAdminSupportIntent.putExtra("android.app.extra.RESTRICTION", str);
            return createShowAdminSupportIntent;
        }

        public boolean isUserAffiliatedWithDevice(int i) {
            return DevicePolicyManagerService.this.isUserAffiliatedWithDeviceLocked(i);
        }

        public boolean canSilentlyInstallPackage(String str, int i) {
            if (str == null) {
                return false;
            }
            CallerIdentity callerIdentity = new CallerIdentity(i, null, null);
            return isUserAffiliatedWithDevice(UserHandle.getUserId(i)) && (isActiveProfileOwner(i) || DevicePolicyManagerService.this.isDefaultDeviceOwner(callerIdentity) || DevicePolicyManagerService.this.isFinancedDeviceOwner(callerIdentity));
        }

        public void reportSeparateProfileChallengeChanged(final int i) {
            DevicePolicyManagerService.this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$LocalService$$ExternalSyntheticLambda1
                public final void runOrThrow() {
                    DevicePolicyManagerService.LocalService.this.lambda$reportSeparateProfileChallengeChanged$0(i);
                }
            });
            DevicePolicyEventLogger.createEvent(110).setBoolean(DevicePolicyManagerService.this.isSeparateProfileChallengeEnabled(i)).write();
            DevicePolicyManagerService.invalidateBinderCaches();
        }

        public /* synthetic */ void lambda$reportSeparateProfileChallengeChanged$0(int i) {
            synchronized (DevicePolicyManagerService.this.getLockObject()) {
                DevicePolicyManagerService.this.updateMaximumTimeToLockLocked(i);
                DevicePolicyManagerService.this.updatePasswordQualityCacheForUserGroup(i);
            }
        }

        public CharSequence getPrintingDisabledReasonForUser(int i) {
            synchronized (DevicePolicyManagerService.this.getLockObject()) {
                if (!DevicePolicyManagerService.this.mUserManager.hasUserRestriction("no_printing", UserHandle.of(i))) {
                    Slogf.e("DevicePolicyManager", "printing is enabled for user %d", Integer.valueOf(i));
                    return null;
                }
                final String profileOwnerPackage = DevicePolicyManagerService.this.mOwners.getProfileOwnerPackage(i);
                if (profileOwnerPackage == null) {
                    profileOwnerPackage = DevicePolicyManagerService.this.mOwners.getDeviceOwnerPackageName();
                }
                final PackageManager packageManager = DevicePolicyManagerService.this.mInjector.getPackageManager();
                PackageInfo packageInfo = (PackageInfo) DevicePolicyManagerService.this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$LocalService$$ExternalSyntheticLambda0
                    public final Object getOrThrow() {
                        PackageInfo lambda$getPrintingDisabledReasonForUser$1;
                        lambda$getPrintingDisabledReasonForUser$1 = DevicePolicyManagerService.LocalService.lambda$getPrintingDisabledReasonForUser$1(packageManager, profileOwnerPackage);
                        return lambda$getPrintingDisabledReasonForUser$1;
                    }
                });
                if (packageInfo == null) {
                    Slogf.e("DevicePolicyManager", "packageInfo is inexplicably null");
                    return null;
                }
                ApplicationInfo applicationInfo = packageInfo.applicationInfo;
                if (applicationInfo == null) {
                    Slogf.e("DevicePolicyManager", "appInfo is inexplicably null");
                    return null;
                }
                CharSequence applicationLabel = packageManager.getApplicationLabel(applicationInfo);
                if (applicationLabel == null) {
                    Slogf.e("DevicePolicyManager", "appLabel is inexplicably null");
                    return null;
                }
                return DevicePolicyManagerService.this.getUpdatableString("Core.PRINTING_DISABLED_NAMED_ADMIN", 17042336, applicationLabel);
            }
        }

        public static /* synthetic */ PackageInfo lambda$getPrintingDisabledReasonForUser$1(PackageManager packageManager, String str) {
            try {
                return packageManager.getPackageInfo(str, 0);
            } catch (PackageManager.NameNotFoundException e) {
                Slogf.e("DevicePolicyManager", "getPackageInfo error", e);
                return null;
            }
        }

        public DevicePolicyCache getDevicePolicyCache() {
            return DevicePolicyManagerService.this.mPolicyCache;
        }

        public DeviceStateCache getDeviceStateCache() {
            return DevicePolicyManagerService.this.mStateCache;
        }

        public List getAllCrossProfilePackages(int i) {
            return DevicePolicyManagerService.this.getAllCrossProfilePackages(i);
        }

        public List getDefaultCrossProfilePackages() {
            return DevicePolicyManagerService.this.getDefaultCrossProfilePackages();
        }

        public void broadcastIntentToManifestReceivers(Intent intent, UserHandle userHandle, boolean z) {
            Objects.requireNonNull(intent);
            Objects.requireNonNull(userHandle);
            Slogf.i("DevicePolicyManager", "Sending %s broadcast to manifest receivers.", intent.getAction());
            broadcastIntentToCrossProfileManifestReceivers(intent, userHandle, z);
            DevicePolicyManagerService.this.broadcastExplicitIntentToRoleHolder(intent, "android.app.role.DEVICE_POLICY_MANAGEMENT", userHandle);
        }

        public void enforcePermission(String str, String str2, int i) {
            DevicePolicyManagerService.this.enforcePermission(str2, str, i);
        }

        public boolean hasPermission(String str, String str2, int i) {
            return DevicePolicyManagerService.this.hasPermission(str2, str, i);
        }

        public final void broadcastIntentToCrossProfileManifestReceivers(Intent intent, UserHandle userHandle, boolean z) {
            int identifier = userHandle.getIdentifier();
            try {
                for (ResolveInfo resolveInfo : DevicePolicyManagerService.this.mIPackageManager.queryIntentReceivers(intent, (String) null, 1024L, identifier).getList()) {
                    String str = resolveInfo.getComponentInfo().packageName;
                    if (checkCrossProfilePackagePermissions(str, identifier, z) || checkModifyQuietModePermission(str, identifier)) {
                        Slogf.i("DevicePolicyManager", "Sending %s broadcast to %s.", intent.getAction(), str);
                        DevicePolicyManagerService.this.mContext.sendBroadcastAsUser(new Intent(intent).setComponent(resolveInfo.getComponentInfo().getComponentName()).addFlags(16777216), userHandle);
                    }
                }
            } catch (RemoteException e) {
                Slogf.w("DevicePolicyManager", "Cannot get list of broadcast receivers for %s because: %s.", intent.getAction(), e);
            }
        }

        public final boolean checkModifyQuietModePermission(String str, int i) {
            try {
                PackageManager packageManager = DevicePolicyManagerService.this.mInjector.getPackageManager();
                Objects.requireNonNull(str);
                ApplicationInfo applicationInfoAsUser = packageManager.getApplicationInfoAsUser(str, 0, i);
                Objects.requireNonNull(applicationInfoAsUser);
                ApplicationInfo applicationInfo = applicationInfoAsUser;
                return ActivityManager.checkComponentPermission("android.permission.MODIFY_QUIET_MODE", applicationInfoAsUser.uid, -1, true) == 0;
            } catch (PackageManager.NameNotFoundException unused) {
                Slogf.w("DevicePolicyManager", "Cannot find the package %s to check for permissions.", str);
                return false;
            }
        }

        public final boolean checkCrossProfilePackagePermissions(String str, int i, boolean z) {
            AndroidPackage androidPackage = ((PackageManagerInternal) LocalServices.getService(PackageManagerInternal.class)).getPackage(str);
            if (androidPackage != null && androidPackage.isCrossProfile()) {
                if (!z) {
                    return true;
                }
                if (!isPackageEnabled(str, i)) {
                    return false;
                }
                try {
                    return ((CrossProfileAppsInternal) LocalServices.getService(CrossProfileAppsInternal.class)).verifyPackageHasInteractAcrossProfilePermission(str, i);
                } catch (PackageManager.NameNotFoundException unused) {
                    Slogf.w("DevicePolicyManager", "Cannot find the package %s to check for permissions.", str);
                }
            }
            return false;
        }

        public final boolean isPackageEnabled(String str, int i) {
            boolean z;
            int callingUid = Binder.getCallingUid();
            long clearCallingIdentity = Binder.clearCallingIdentity();
            try {
                PackageInfo packageInfo = DevicePolicyManagerService.this.mInjector.getPackageManagerInternal().getPackageInfo(str, 786432L, callingUid, i);
                if (packageInfo != null) {
                    if (packageInfo.applicationInfo.enabled) {
                        z = true;
                        return z;
                    }
                }
                z = false;
                return z;
            } finally {
                Binder.restoreCallingIdentity(clearCallingIdentity);
            }
        }

        public ComponentName getProfileOwnerAsUser(int i) {
            return DevicePolicyManagerService.this.lambda$isProfileOwner$71(i);
        }

        public int getDeviceOwnerUserId() {
            return DevicePolicyManagerService.this.getDeviceOwnerUserId();
        }

        public boolean isDeviceOrProfileOwnerInCallingUser(String str) {
            return isDeviceOwnerInCallingUser(str) || isProfileOwnerInCallingUser(str);
        }

        public final boolean isDeviceOwnerInCallingUser(String str) {
            ComponentName deviceOwnerComponent = DevicePolicyManagerService.this.getDeviceOwnerComponent(true);
            return deviceOwnerComponent != null && str.equals(deviceOwnerComponent.getPackageName());
        }

        public final boolean isProfileOwnerInCallingUser(String str) {
            ComponentName profileOwnerAsUser = getProfileOwnerAsUser(UserHandle.getCallingUserId());
            return profileOwnerAsUser != null && str.equals(profileOwnerAsUser.getPackageName());
        }

        public boolean supportsResetOp(int i) {
            return i == 93 && LocalServices.getService(CrossProfileAppsInternal.class) != null;
        }

        public void resetOp(int i, String str, int i2) {
            if (i != 93) {
                throw new IllegalArgumentException("Unsupported op for DPM reset: " + i);
            }
            ((CrossProfileAppsInternal) LocalServices.getService(CrossProfileAppsInternal.class)).setInteractAcrossProfilesAppOp(str, findInteractAcrossProfilesResetMode(str), i2);
        }

        public Set getPackagesSuspendedByAdmin(int i) {
            return DevicePolicyManagerService.this.getPackagesSuspendedByAdmin(i);
        }

        public void notifyUnsafeOperationStateChanged(DevicePolicySafetyChecker devicePolicySafetyChecker, int i, boolean z) {
            Preconditions.checkArgument(DevicePolicyManagerService.this.mSafetyChecker == devicePolicySafetyChecker, "invalid checker: should be %s, was %s", new Object[]{DevicePolicyManagerService.this.mSafetyChecker, devicePolicySafetyChecker});
            Bundle bundle = new Bundle();
            bundle.putInt("android.app.extra.OPERATION_SAFETY_REASON", i);
            bundle.putBoolean("android.app.extra.OPERATION_SAFETY_STATE", z);
            if (DevicePolicyManagerService.this.mOwners.hasDeviceOwner()) {
                DevicePolicyManagerService.this.sendDeviceOwnerCommand("android.app.action.OPERATION_SAFETY_STATE_CHANGED", bundle);
            }
            Iterator it = DevicePolicyManagerService.this.mOwners.getProfileOwnerKeys().iterator();
            while (it.hasNext()) {
                DevicePolicyManagerService.this.sendProfileOwnerCommand("android.app.action.OPERATION_SAFETY_STATE_CHANGED", bundle, ((Integer) it.next()).intValue());
            }
        }

        public boolean isKeepProfilesRunningEnabled() {
            return DevicePolicyManagerService.this.getUserDataUnchecked(0).mEffectiveKeepProfilesRunning;
        }

        public final int findInteractAcrossProfilesResetMode(String str) {
            if (getDefaultCrossProfilePackages().contains(str)) {
                return 0;
            }
            return AppOpsManager.opToDefaultMode(93);
        }

        public boolean isUserOrganizationManaged(int i) {
            return getDeviceStateCache().isUserOrganizationManaged(i);
        }

        public boolean isApplicationExemptionsFlagEnabled() {
            return DeviceConfig.getBoolean("device_policy_manager", "application_exemptions", true);
        }

        public List getApplicationRestrictionsPerAdminForUser(final String str, final int i) {
            if (UserHandle.getCallingUserId() != i || !UserHandle.isSameApp(Binder.getCallingUid(), DevicePolicyManagerService.this.getUidForPackage(str, i))) {
                int callingUid = Binder.getCallingUid();
                if (!UserHandle.isSameApp(callingUid, 1000) && callingUid != 0) {
                    throw new SecurityException("Only system may: get application restrictions for other user/app " + str);
                }
            }
            LinkedHashMap localPoliciesSetByAdmins = DevicePolicyManagerService.this.mDevicePolicyEngine.getLocalPoliciesSetByAdmins(PolicyDefinition.APPLICATION_RESTRICTIONS(str), i);
            ArrayList arrayList = new ArrayList();
            Iterator it = localPoliciesSetByAdmins.keySet().iterator();
            while (it.hasNext()) {
                arrayList.add((Bundle) ((PolicyValue) localPoliciesSetByAdmins.get((EnforcingAdmin) it.next())).getValue());
            }
            return !arrayList.isEmpty() ? arrayList : (List) DevicePolicyManagerService.this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$LocalService$$ExternalSyntheticLambda2
                public final Object getOrThrow() {
                    List lambda$getApplicationRestrictionsPerAdminForUser$2;
                    lambda$getApplicationRestrictionsPerAdminForUser$2 = DevicePolicyManagerService.LocalService.this.lambda$getApplicationRestrictionsPerAdminForUser$2(str, i);
                    return lambda$getApplicationRestrictionsPerAdminForUser$2;
                }
            });
        }

        public /* synthetic */ List lambda$getApplicationRestrictionsPerAdminForUser$2(String str, int i) {
            Bundle applicationRestrictions = DevicePolicyManagerService.this.mUserManager.getApplicationRestrictions(str, UserHandle.of(i));
            if (applicationRestrictions == null || applicationRestrictions.isEmpty()) {
                return new ArrayList();
            }
            return List.of(applicationRestrictions);
        }

        public List getUserRestrictionSources(String str, int i) {
            PolicyDefinition policyDefinitionForUserRestriction = PolicyDefinition.getPolicyDefinitionForUserRestriction(str);
            Set keySet = DevicePolicyManagerService.this.mDevicePolicyEngine.getLocalPoliciesSetByAdmins(policyDefinitionForUserRestriction, i).keySet();
            Set keySet2 = DevicePolicyManagerService.this.mDevicePolicyEngine.getGlobalPoliciesSetByAdmins(policyDefinitionForUserRestriction).keySet();
            ArrayList arrayList = new ArrayList();
            arrayList.addAll(getEnforcingUsers(keySet));
            arrayList.addAll(getEnforcingUsers(keySet2));
            return arrayList;
        }

        public final List getEnforcingUsers(Set set) {
            ArrayList arrayList = new ArrayList();
            ComponentName deviceOwnerComponent = DevicePolicyManagerService.this.mOwners.getDeviceOwnerComponent();
            Iterator it = set.iterator();
            while (it.hasNext()) {
                EnforcingAdmin enforcingAdmin = (EnforcingAdmin) it.next();
                if (deviceOwnerComponent != null && deviceOwnerComponent.getPackageName().equals(enforcingAdmin.getPackageName())) {
                    arrayList.add(new UserManager.EnforcingUser(enforcingAdmin.getUserId(), 2));
                } else {
                    arrayList.add(new UserManager.EnforcingUser(enforcingAdmin.getUserId(), 4));
                }
            }
            return arrayList;
        }

        public void setMinimumRequiredWifiSecurityLevel(ComponentName componentName, int i, int i2) {
            synchronized (DevicePolicyManagerService.this.getLockObject()) {
                ActiveAdmin activeAdminUncheckedLocked = DevicePolicyManagerService.this.getActiveAdminUncheckedLocked(componentName, i2);
                if (activeAdminUncheckedLocked == null) {
                    Log.e("DevicePolicyManager", "setMinimumRequiredWifiSecurityLevel - admin is null!");
                    return;
                }
                if (DevicePolicyManagerService.this.setMinimumRequiredWifiSecurityLevelLocked(activeAdminUncheckedLocked, i)) {
                    DevicePolicyManagerService devicePolicyManagerService = DevicePolicyManagerService.this;
                    devicePolicyManagerService.notifyMinimumRequiredWifiSecurityLevelChanged(devicePolicyManagerService.getStrictestMinimumRequiredWifiSecurityLevelLocked());
                }
            }
        }

        public void setWifiSsidPolicy(ComponentName componentName, WifiSsidPolicy wifiSsidPolicy, int i) {
            synchronized (DevicePolicyManagerService.this.getLockObject()) {
                ActiveAdmin activeAdminUncheckedLocked = DevicePolicyManagerService.this.getActiveAdminUncheckedLocked(componentName, i);
                if (activeAdminUncheckedLocked == null) {
                    Log.e("DevicePolicyManager", "setWifiSsidPolicy - admin is null!");
                    return;
                }
                if (DevicePolicyManagerService.this.setWifiSsidPolicyLocked(activeAdminUncheckedLocked, wifiSsidPolicy)) {
                    DevicePolicyManagerService devicePolicyManagerService = DevicePolicyManagerService.this;
                    devicePolicyManagerService.notifyWifiSsidPolicyChanged(devicePolicyManagerService.getCombinedWifiSsidPolicyLocked());
                }
            }
        }

        public void notifyChangesOnWifiPolicy() {
            DevicePolicyManagerService devicePolicyManagerService = DevicePolicyManagerService.this;
            devicePolicyManagerService.notifyMinimumRequiredWifiSecurityLevelChanged(devicePolicyManagerService.getStrictestMinimumRequiredWifiSecurityLevelLocked());
            DevicePolicyManagerService devicePolicyManagerService2 = DevicePolicyManagerService.this;
            devicePolicyManagerService2.notifyWifiSsidPolicyChanged(devicePolicyManagerService2.getCombinedWifiSsidPolicyLocked());
        }
    }

    public final Intent createShowAdminSupportIntent(int i) {
        Intent intent = new Intent("android.settings.SHOW_ADMIN_SUPPORT_DETAILS");
        intent.putExtra("android.intent.extra.USER_ID", i);
        intent.setFlags(268435456);
        return intent;
    }

    public final Bundle getEnforcingAdminAndUserDetailsInternal(int i, String str) {
        ActiveAdmin deviceOwnerAdminLocked;
        if (str == null || "policy_suspend_packages".equals(str)) {
            ComponentName profileOwnerComponent = this.mOwners.getProfileOwnerComponent(i);
            if (profileOwnerComponent != null) {
                Bundle bundle = new Bundle();
                bundle.putInt("android.intent.extra.USER_ID", i);
                bundle.putParcelable("android.app.extra.DEVICE_ADMIN", profileOwnerComponent);
                return bundle;
            }
            Pair deviceOwnerUserIdAndComponent = this.mOwners.getDeviceOwnerUserIdAndComponent();
            if (deviceOwnerUserIdAndComponent != null && ((Integer) deviceOwnerUserIdAndComponent.first).intValue() == i) {
                Bundle bundle2 = new Bundle();
                bundle2.putInt("android.intent.extra.USER_ID", i);
                bundle2.putParcelable("android.app.extra.DEVICE_ADMIN", (Parcelable) deviceOwnerUserIdAndComponent.second);
                return bundle2;
            }
        } else {
            int i2 = 0;
            if ("policy_disable_screen_capture".equals(str)) {
                if (isPolicyEngineForFinanceFlagEnabled()) {
                    Boolean bool = (Boolean) this.mDevicePolicyEngine.getResolvedPolicy(PolicyDefinition.SCREEN_CAPTURE_DISABLED, i);
                    if (bool != null && bool.booleanValue()) {
                        Bundle bundle3 = new Bundle();
                        bundle3.putInt("android.intent.extra.USER_ID", i);
                        return bundle3;
                    }
                } else {
                    synchronized (getLockObject()) {
                        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
                        int size = lambda$getUserDataUnchecked$2.mAdminList.size();
                        while (i2 < size) {
                            ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2);
                            if (activeAdmin.disableScreenCapture) {
                                Bundle bundle4 = new Bundle();
                                bundle4.putInt("android.intent.extra.USER_ID", i);
                                bundle4.putParcelable("android.app.extra.DEVICE_ADMIN", activeAdmin.info.getComponent());
                                return bundle4;
                            }
                            i2++;
                        }
                    }
                }
            } else if ("policy_disable_camera".equals(str)) {
                if (isPolicyEngineForFinanceFlagEnabled()) {
                    Boolean bool2 = (Boolean) this.mDevicePolicyEngine.getResolvedPolicy(PolicyDefinition.getPolicyDefinitionForUserRestriction("no_camera"), i);
                    if (bool2 != null && bool2.booleanValue()) {
                        Bundle bundle5 = new Bundle();
                        bundle5.putInt("android.intent.extra.USER_ID", i);
                        return bundle5;
                    }
                } else {
                    synchronized (getLockObject()) {
                        DevicePolicyData lambda$getUserDataUnchecked$22 = lambda$getUserDataUnchecked$2(i);
                        int size2 = lambda$getUserDataUnchecked$22.mAdminList.size();
                        while (i2 < size2) {
                            ActiveAdmin activeAdmin2 = (ActiveAdmin) lambda$getUserDataUnchecked$22.mAdminList.get(i2);
                            if (activeAdmin2.disableCamera) {
                                Bundle bundle6 = new Bundle();
                                bundle6.putInt("android.intent.extra.USER_ID", i);
                                bundle6.putParcelable("android.app.extra.DEVICE_ADMIN", activeAdmin2.info.getComponent());
                                return bundle6;
                            }
                            i2++;
                        }
                        if ("policy_disable_camera".equals(str) && (deviceOwnerAdminLocked = getDeviceOwnerAdminLocked()) != null && deviceOwnerAdminLocked.disableCamera) {
                            Bundle bundle7 = new Bundle();
                            bundle7.putInt("android.intent.extra.USER_ID", this.mOwners.getDeviceOwnerUserId());
                            bundle7.putParcelable("android.app.extra.DEVICE_ADMIN", deviceOwnerAdminLocked.info.getComponent());
                            return bundle7;
                        }
                    }
                }
            } else {
                long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
                try {
                    List userRestrictionSources = this.mUserManager.getUserRestrictionSources(str, UserHandle.of(i));
                    if (userRestrictionSources != null) {
                        int size3 = userRestrictionSources.size();
                        if (size3 > 1) {
                            Slogf.d("DevicePolicyManager", "getEnforcingAdminAndUserDetailsInternal(%d, %s): %d sources found, excluding those set by UserManager", Integer.valueOf(i), str, Integer.valueOf(size3));
                            userRestrictionSources = getDevicePolicySources(userRestrictionSources);
                        }
                        if (!userRestrictionSources.isEmpty()) {
                            if (userRestrictionSources.size() > 1) {
                                Slogf.w("DevicePolicyManager", "getEnforcingAdminAndUserDetailsInternal(%d, %s): multiple sources for restriction %s on user %d", Integer.valueOf(i), str, str, Integer.valueOf(i));
                                Bundle bundle8 = new Bundle();
                                bundle8.putInt("android.intent.extra.USER_ID", i);
                                return bundle8;
                            }
                            int userRestrictionSource = ((UserManager.EnforcingUser) userRestrictionSources.get(0)).getUserRestrictionSource();
                            if (userRestrictionSource != 4 && userRestrictionSource != 2) {
                                if (userRestrictionSource == 1) {
                                }
                            }
                            ActiveAdmin mostProbableDPCAdminForLocalPolicy = getMostProbableDPCAdminForLocalPolicy(i);
                            if (mostProbableDPCAdminForLocalPolicy != null) {
                                Bundle bundle9 = new Bundle();
                                bundle9.putInt("android.intent.extra.USER_ID", mostProbableDPCAdminForLocalPolicy.getUserHandle().getIdentifier());
                                bundle9.putParcelable("android.app.extra.DEVICE_ADMIN", mostProbableDPCAdminForLocalPolicy.info.getComponent());
                                return bundle9;
                            }
                        }
                    }
                    return null;
                } finally {
                    this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                }
            }
        }
        return null;
    }

    public final List getDevicePolicySources(List list) {
        int size = list.size();
        ArrayList arrayList = new ArrayList(size);
        for (int i = 0; i < size; i++) {
            UserManager.EnforcingUser enforcingUser = (UserManager.EnforcingUser) list.get(i);
            int userRestrictionSource = enforcingUser.getUserRestrictionSource();
            if (userRestrictionSource != 4 && userRestrictionSource != 2) {
                Slogf.d("DevicePolicyManager", "excluding source of type %s at index %d", userRestrictionSourceToString(userRestrictionSource), Integer.valueOf(i));
            } else {
                arrayList.add(enforcingUser);
            }
        }
        return arrayList;
    }

    public static String userRestrictionSourceToString(int i) {
        return DebugUtils.flagsToString(UserManager.class, "RESTRICTION_", i);
    }

    public Bundle getEnforcingAdminAndUserDetails(int i, String str) {
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()));
        return getEnforcingAdminAndUserDetailsInternal(i, str);
    }

    public Intent createAdminSupportIntent(String str) {
        Objects.requireNonNull(str);
        int userId = getCallerIdentity().getUserId();
        if (getEnforcingAdminAndUserDetailsInternal(userId, str) == null) {
            return null;
        }
        Intent createShowAdminSupportIntent = createShowAdminSupportIntent(userId);
        createShowAdminSupportIntent.putExtra("android.app.extra.RESTRICTION", str);
        return createShowAdminSupportIntent;
    }

    public static boolean isLimitPasswordAllowed(ActiveAdmin activeAdmin, int i) {
        if (activeAdmin.mPasswordPolicy.quality < i) {
            return false;
        }
        return activeAdmin.isPermissionBased || activeAdmin.info.usesPolicy(0);
    }

    public void setCredentialManagerPolicy(PackagePolicy packagePolicy) {
        if (this.mHasFeature) {
            CallerIdentity callerIdentity = getCallerIdentity();
            Preconditions.checkCallAuthorization(canWriteCredentialManagerPolicy(callerIdentity));
            synchronized (getLockObject()) {
                ActiveAdmin profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
                if (Objects.equals(profileOwnerOrDeviceOwnerLocked.mCredentialManagerPolicy, packagePolicy)) {
                    return;
                }
                profileOwnerOrDeviceOwnerLocked.mCredentialManagerPolicy = packagePolicy;
                saveSettingsLocked(callerIdentity.getUserId());
            }
        }
    }

    public final boolean canWriteCredentialManagerPolicy(CallerIdentity callerIdentity) {
        return (isProfileOwner(callerIdentity) && isManagedProfile(callerIdentity.getUserId())) || isDefaultDeviceOwner(callerIdentity) || hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS");
    }

    public PackagePolicy getCredentialManagerPolicy(int i) {
        PackagePolicy packagePolicy;
        if (!this.mHasFeature) {
            return null;
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(canWriteCredentialManagerPolicy(callerIdentity) || canQueryAdminPolicy(callerIdentity));
        if (i != callerIdentity.getUserId()) {
            Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.INTERACT_ACROSS_USERS"));
        }
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(i);
            packagePolicy = profileOwnerOrDeviceOwnerLocked != null ? profileOwnerOrDeviceOwnerLocked.mCredentialManagerPolicy : null;
        }
        return packagePolicy;
    }

    public void setSystemUpdatePolicy(ComponentName componentName, String str, SystemUpdatePolicy systemUpdatePolicy) {
        CallerIdentity callerIdentity;
        boolean z;
        if (systemUpdatePolicy != null) {
            systemUpdatePolicy.validateType();
            systemUpdatePolicy.validateFreezePeriods();
            Pair systemUpdateFreezePeriodRecord = this.mOwners.getSystemUpdateFreezePeriodRecord();
            systemUpdatePolicy.validateAgainstPreviousFreezePeriod((LocalDate) systemUpdateFreezePeriodRecord.first, (LocalDate) systemUpdateFreezePeriodRecord.second, LocalDate.now());
        }
        synchronized (getLockObject()) {
            if (isPermissionCheckFlagEnabled()) {
                callerIdentity = getCallerIdentity(componentName, str);
                enforcePermission("android.permission.MANAGE_DEVICE_POLICY_SYSTEM_UPDATES", callerIdentity.getPackageName(), -1);
            } else {
                callerIdentity = getCallerIdentity(componentName);
                if (!isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) && !isDefaultDeviceOwner(callerIdentity)) {
                    z = false;
                    Preconditions.checkCallAuthorization(z);
                }
                z = true;
                Preconditions.checkCallAuthorization(z);
            }
            checkCanExecuteOrThrowUnsafe(14);
            if (systemUpdatePolicy == null) {
                this.mOwners.clearSystemUpdatePolicy();
            } else {
                this.mOwners.setSystemUpdatePolicy(systemUpdatePolicy);
                updateSystemUpdateFreezePeriodsRecord(false);
            }
            this.mOwners.writeDeviceOwner();
        }
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda72
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setSystemUpdatePolicy$125();
            }
        });
        DevicePolicyEventLogger.createEvent(50).setAdmin(callerIdentity.getPackageName()).setInt(systemUpdatePolicy != null ? systemUpdatePolicy.getPolicyType() : 0).write();
    }

    public /* synthetic */ void lambda$setSystemUpdatePolicy$125() {
        this.mContext.sendBroadcastAsUser(new Intent("android.app.action.SYSTEM_UPDATE_POLICY_CHANGED"), UserHandle.SYSTEM);
    }

    public SystemUpdatePolicy getSystemUpdatePolicy() {
        synchronized (getLockObject()) {
            SystemUpdatePolicy systemUpdatePolicy = this.mOwners.getSystemUpdatePolicy();
            if (systemUpdatePolicy == null || systemUpdatePolicy.isValid()) {
                return systemUpdatePolicy;
            }
            Slogf.w("DevicePolicyManager", "Stored system update policy is invalid, return null instead.");
            return null;
        }
    }

    public static boolean withinRange(Pair pair, LocalDate localDate) {
        return (localDate.isBefore((ChronoLocalDate) pair.first) || localDate.isAfter((ChronoLocalDate) pair.second)) ? false : true;
    }

    public final void updateSystemUpdateFreezePeriodsRecord(boolean z) {
        boolean systemUpdateFreezePeriodRecord;
        Slogf.d("DevicePolicyManager", "updateSystemUpdateFreezePeriodsRecord");
        synchronized (getLockObject()) {
            SystemUpdatePolicy systemUpdatePolicy = this.mOwners.getSystemUpdatePolicy();
            if (systemUpdatePolicy == null) {
                return;
            }
            LocalDate now = LocalDate.now();
            Pair currentFreezePeriod = systemUpdatePolicy.getCurrentFreezePeriod(now);
            if (currentFreezePeriod == null) {
                return;
            }
            Pair systemUpdateFreezePeriodRecord2 = this.mOwners.getSystemUpdateFreezePeriodRecord();
            LocalDate localDate = (LocalDate) systemUpdateFreezePeriodRecord2.first;
            LocalDate localDate2 = (LocalDate) systemUpdateFreezePeriodRecord2.second;
            if (localDate2 != null && localDate != null) {
                if (now.equals(localDate2.plusDays(1L))) {
                    systemUpdateFreezePeriodRecord = this.mOwners.setSystemUpdateFreezePeriodRecord(localDate, now);
                } else if (now.isAfter(localDate2.plusDays(1L))) {
                    if (withinRange(currentFreezePeriod, localDate) && withinRange(currentFreezePeriod, localDate2)) {
                        systemUpdateFreezePeriodRecord = this.mOwners.setSystemUpdateFreezePeriodRecord(localDate, now);
                    } else {
                        systemUpdateFreezePeriodRecord = this.mOwners.setSystemUpdateFreezePeriodRecord(now, now);
                    }
                } else {
                    systemUpdateFreezePeriodRecord = now.isBefore(localDate) ? this.mOwners.setSystemUpdateFreezePeriodRecord(now, now) : false;
                }
                if (systemUpdateFreezePeriodRecord && z) {
                    this.mOwners.writeDeviceOwner();
                }
            }
            systemUpdateFreezePeriodRecord = this.mOwners.setSystemUpdateFreezePeriodRecord(now, now);
            if (systemUpdateFreezePeriodRecord) {
                this.mOwners.writeDeviceOwner();
            }
        }
    }

    public void clearSystemUpdatePolicyFreezePeriodRecord() {
        Preconditions.checkCallAuthorization(isAdb(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.CLEAR_FREEZE_PERIOD"), "Caller must be shell, or hold CLEAR_FREEZE_PERIOD permission to call clearSystemUpdatePolicyFreezePeriodRecord");
        synchronized (getLockObject()) {
            Slogf.i("DevicePolicyManager", "Clear freeze period record: " + this.mOwners.getSystemUpdateFreezePeriodRecordAsString());
            if (this.mOwners.setSystemUpdateFreezePeriodRecord(null, null)) {
                this.mOwners.writeDeviceOwner();
            }
        }
    }

    public final boolean isUidDeviceOwnerLocked(int i) {
        String[] packagesForUid;
        ensureLocked();
        String packageName = this.mOwners.getDeviceOwnerComponent().getPackageName();
        try {
            packagesForUid = this.mInjector.getIPackageManager().getPackagesForUid(i);
        } catch (RemoteException unused) {
        }
        if (packagesForUid == null) {
            return false;
        }
        for (String str : packagesForUid) {
            if (packageName.equals(str)) {
                return true;
            }
        }
        return false;
    }

    public void notifyPendingSystemUpdate(SystemUpdateInfo systemUpdateInfo) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.NOTIFY_PENDING_SYSTEM_UPDATE"), "Only the system update service can broadcast update information");
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda26
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$notifyPendingSystemUpdate$126();
            }
        });
        if (this.mOwners.saveSystemUpdateInfo(systemUpdateInfo)) {
            final Intent putExtra = new Intent("android.app.action.NOTIFY_PENDING_SYSTEM_UPDATE").putExtra("android.app.extra.SYSTEM_UPDATE_RECEIVED_TIME", systemUpdateInfo == null ? -1L : systemUpdateInfo.getReceivedTime());
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda27
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$notifyPendingSystemUpdate$127(putExtra);
                }
            });
        }
    }

    public /* synthetic */ void lambda$notifyPendingSystemUpdate$126() {
        if (this.mUserManager.getUserInfo(UserHandle.getCallingUserId()).isMain()) {
            return;
        }
        Slogf.w("DevicePolicyManager", "Only the system update service in the main user can broadcast update information.");
    }

    public /* synthetic */ void lambda$notifyPendingSystemUpdate$127(Intent intent) {
        synchronized (getLockObject()) {
            if (this.mOwners.hasDeviceOwner()) {
                UserHandle of = UserHandle.of(this.mOwners.getDeviceOwnerUserId());
                intent.setComponent(this.mOwners.getDeviceOwnerComponent());
                this.mContext.sendBroadcastAsUser(intent, of);
            }
        }
        try {
            for (int i : this.mInjector.getIActivityManager().getRunningUserIds()) {
                synchronized (getLockObject()) {
                    ComponentName profileOwnerComponent = this.mOwners.getProfileOwnerComponent(i);
                    if (profileOwnerComponent != null) {
                        intent.setComponent(profileOwnerComponent);
                        this.mContext.sendBroadcastAsUser(intent, UserHandle.of(i));
                    }
                }
            }
        } catch (RemoteException e) {
            Slogf.e("DevicePolicyManager", "Could not retrieve the list of running users", e);
        }
    }

    public SystemUpdateInfo getPendingSystemUpdate(ComponentName componentName) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        return this.mOwners.getSystemUpdateInfo();
    }

    public void setPermissionPolicy(ComponentName componentName, String str, int i) {
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-permission-grant")));
        checkCanExecuteOrThrowUnsafe(38);
        int userId = callerIdentity.getUserId();
        synchronized (getLockObject()) {
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(userId);
            if (lambda$getUserDataUnchecked$2.mPermissionPolicy != i) {
                lambda$getUserDataUnchecked$2.mPermissionPolicy = i;
                this.mPolicyCache.setPermissionPolicy(userId, i);
                saveSettingsLocked(userId);
            }
        }
        DevicePolicyEventLogger.createEvent(18).setAdmin(callerIdentity.getPackageName()).setInt(i).setBoolean(componentName == null).write();
    }

    public final void updatePermissionPolicyCache(int i) {
        synchronized (getLockObject()) {
            this.mPolicyCache.setPermissionPolicy(i, lambda$getUserDataUnchecked$2(i).mPermissionPolicy);
        }
    }

    public int getPermissionPolicy(ComponentName componentName) {
        return this.mPolicyCache.getPermissionPolicy(UserHandle.getCallingUserId());
    }

    public void setPermissionGrantState(ComponentName componentName, String str, String str2, String str3, int i, final RemoteCallback remoteCallback) {
        long binderClearCallingIdentity;
        Injector injector;
        Injector injector2;
        Objects.requireNonNull(remoteCallback);
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        checkCanExecuteOrThrowUnsafe(37);
        synchronized (getLockObject()) {
            if (isFinancedDeviceOwner(callerIdentity)) {
                enforcePermissionGrantStateOnFinancedDevice(str2, str3);
            }
        }
        if (isUnicornFlagEnabled()) {
            enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_RUNTIME_PERMISSIONS", str, callerIdentity.getUserId());
            if (SENSOR_PERMISSIONS.contains(str3) && i == 1 && (!canAdminGrantSensorsPermissions() || isCallerDelegate(callerIdentity))) {
                if (this.mInjector.isChangeEnabled(277035314L, callerIdentity.getPackageName(), callerIdentity.getUserId())) {
                    throw new SecurityException("Caller not permitted to grant sensor permissions.");
                }
                remoteCallback.sendResult(Bundle.EMPTY);
                return;
            } else if (!canGrantPermission(callerIdentity, str3, str2)) {
                remoteCallback.sendResult((Bundle) null);
                return;
            }
        } else {
            Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || isFinancedDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-permission-grant")));
            synchronized (getLockObject()) {
                binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
                try {
                    try {
                    } catch (SecurityException e) {
                        Slogf.e("DevicePolicyManager", "Could not set permission grant state", e);
                        remoteCallback.sendResult((Bundle) null);
                        injector = this.mInjector;
                    }
                    if (!(getTargetSdk(callerIdentity.getPackageName(), callerIdentity.getUserId()) >= 29) && getTargetSdk(str2, callerIdentity.getUserId()) < 23) {
                        remoteCallback.sendResult((Bundle) null);
                        return;
                    } else if (!isRuntimePermission(str3)) {
                        remoteCallback.sendResult((Bundle) null);
                        return;
                    } else {
                        injector = this.mInjector;
                        injector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                    }
                } finally {
                }
            }
        }
        synchronized (getLockObject()) {
            binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                try {
                    final boolean z = getTargetSdk(callerIdentity.getPackageName(), callerIdentity.getUserId()) >= 29;
                    if (i == 1 || i == 2 || i == 0) {
                        this.mInjector.getPermissionControllerManager(callerIdentity.getUserHandle()).setRuntimePermissionGrantStateByDeviceAdmin(callerIdentity.getPackageName(), new AdminPermissionControlParams(str2, str3, i, canAdminGrantSensorsPermissions()), this.mContext.getMainExecutor(), new Consumer() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda47
                            @Override // java.util.function.Consumer
                            public final void accept(Object obj) {
                                DevicePolicyManagerService.lambda$setPermissionGrantState$129(z, remoteCallback, (Boolean) obj);
                            }
                        });
                    }
                    injector2 = this.mInjector;
                } catch (SecurityException e2) {
                    Slogf.e("DevicePolicyManager", "Could not set permission grant state", e2);
                    remoteCallback.sendResult((Bundle) null);
                    injector2 = this.mInjector;
                }
                injector2.binderRestoreCallingIdentity(binderClearCallingIdentity);
            } finally {
            }
        }
        DevicePolicyEventLogger.createEvent(19).setAdmin(callerIdentity.getPackageName()).setStrings(new String[]{str3}).setInt(i).setBoolean(isCallerDelegate(callerIdentity)).write();
    }

    public static /* synthetic */ void lambda$setPermissionGrantState$129(boolean z, RemoteCallback remoteCallback, Boolean bool) {
        if (z && !bool.booleanValue()) {
            remoteCallback.sendResult((Bundle) null);
        } else {
            remoteCallback.sendResult(Bundle.EMPTY);
        }
    }

    public final boolean canGrantPermission(CallerIdentity callerIdentity, String str, String str2) {
        return ((getTargetSdk(callerIdentity.getPackageName(), callerIdentity.getUserId()) >= 29) || getTargetSdk(str2, callerIdentity.getUserId()) >= 23) && isRuntimePermission(str);
    }

    public final void enforcePermissionGrantStateOnFinancedDevice(String str, String str2) {
        if (!"android.permission.READ_PHONE_STATE".equals(str2)) {
            throw new SecurityException(str2 + " cannot be used when managing a financed device for permission grant state");
        }
        if (!this.mOwners.getDeviceOwnerPackageName().equals(str)) {
            throw new SecurityException("Device owner package is the only package that can be used for permission grant state when managing a financed device");
        }
    }

    public int getPermissionGrantState(ComponentName componentName, String str, final String str2, final String str3) {
        int intValue;
        final CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        if (isUnicornFlagEnabled()) {
            enforceCanQuery("android.permission.MANAGE_DEVICE_POLICY_RUNTIME_PERMISSIONS", callerIdentity.getPackageName(), callerIdentity.getUserId());
        } else {
            Preconditions.checkCallAuthorization(isSystemUid(callerIdentity) || (callerIdentity.hasAdminComponent() && (isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || isFinancedDeviceOwner(callerIdentity))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-permission-grant")));
        }
        synchronized (getLockObject()) {
            if (isFinancedDeviceOwner(callerIdentity)) {
                enforcePermissionGrantStateOnFinancedDevice(str2, str3);
            }
            intValue = ((Integer) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda97
                public final Object getOrThrow() {
                    Integer lambda$getPermissionGrantState$130;
                    lambda$getPermissionGrantState$130 = DevicePolicyManagerService.this.lambda$getPermissionGrantState$130(str2, str3, callerIdentity);
                    return lambda$getPermissionGrantState$130;
                }
            })).intValue();
        }
        return intValue;
    }

    public /* synthetic */ Integer lambda$getPermissionGrantState$130(String str, String str2, CallerIdentity callerIdentity) {
        return Integer.valueOf(getPermissionGrantStateForUser(str, str2, callerIdentity, callerIdentity.getUserId()));
    }

    public final int getPermissionGrantStateForUser(String str, String str2, CallerIdentity callerIdentity, int i) {
        int i2;
        if (getTargetSdk(callerIdentity.getPackageName(), callerIdentity.getUserId()) < 29) {
            i2 = this.mIPackageManager.checkPermission(str2, str, i);
        } else {
            PackageManagerLocal.UnfilteredSnapshot withUnfilteredSnapshot = this.mInjector.getPackageManagerLocal().withUnfilteredSnapshot();
            try {
                PackageState packageState = (PackageState) withUnfilteredSnapshot.getPackageStates().get(str);
                if (packageState == null) {
                    Slog.w("DevicePolicyManager", "Can't get permission state for missing package " + str);
                    withUnfilteredSnapshot.close();
                    return 0;
                }
                if (!packageState.getUserStateOrDefault(i).isInstalled()) {
                    Slog.w("DevicePolicyManager", "Can't get permission state for uninstalled package " + str);
                    withUnfilteredSnapshot.close();
                    return 0;
                }
                int i3 = PermissionChecker.checkPermissionForPreflight(this.mContext, str2, -1, UserHandle.getUid(i, packageState.getAppId()), str) == 0 ? 0 : -1;
                withUnfilteredSnapshot.close();
                i2 = i3;
            } catch (Throwable th) {
                if (withUnfilteredSnapshot != null) {
                    try {
                        withUnfilteredSnapshot.close();
                    } catch (Throwable th2) {
                        th.addSuppressed(th2);
                    }
                }
                throw th;
            }
        }
        if ((this.mInjector.getPackageManager().getPermissionFlags(str2, str, UserHandle.of(i)) & 4) != 4) {
            return 0;
        }
        return i2 == 0 ? 1 : 2;
    }

    public boolean isPackageInstalledForUser(final String str, final int i) {
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda95
            public final Object getOrThrow() {
                Boolean lambda$isPackageInstalledForUser$131;
                lambda$isPackageInstalledForUser$131 = DevicePolicyManagerService.this.lambda$isPackageInstalledForUser$131(str, i);
                return lambda$isPackageInstalledForUser$131;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$isPackageInstalledForUser$131(String str, int i) {
        try {
            PackageInfo packageInfo = this.mInjector.getIPackageManager().getPackageInfo(str, 0L, i);
            return Boolean.valueOf((packageInfo == null || packageInfo.applicationInfo.flags == 0) ? false : true);
        } catch (RemoteException e) {
            throw new RuntimeException("Package manager has died", e);
        }
    }

    public final boolean isRuntimePermission(String str) {
        try {
            return (this.mInjector.getPackageManager().getPermissionInfo(str, 0).protectionLevel & 15) == 1;
        } catch (PackageManager.NameNotFoundException unused) {
            return false;
        }
    }

    public boolean isProvisioningAllowed(String str, String str2) {
        Objects.requireNonNull(str2);
        CallerIdentity callerIdentity = getCallerIdentity();
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            Preconditions.checkArgument(Arrays.asList(this.mInjector.getPackageManager().getPackagesForUid(callerIdentity.getUid())).contains(str2), "Caller uid doesn't match the one for the provided package.");
            return checkProvisioningPreconditionSkipPermission(str, str2, callerIdentity.getUserId()) == 0;
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public int checkProvisioningPrecondition(String str, String str2) {
        Objects.requireNonNull(str2, "packageName is null");
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            return checkProvisioningPreconditionSkipPermission(str, str2, callerIdentity.getUserId());
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public final int checkProvisioningPreconditionSkipPermission(String str, String str2, int i) {
        if (!this.mHasFeature) {
            logMissingFeatureAction("Cannot check provisioning for action " + str);
            return 13;
        }
        if (!isProvisioningAllowed()) {
            return 15;
        }
        int checkProvisioningPreConditionSkipPermissionNoLog = checkProvisioningPreConditionSkipPermissionNoLog(str, str2, i);
        if (checkProvisioningPreConditionSkipPermissionNoLog != 0) {
            Slogf.d("DevicePolicyManager", "checkProvisioningPreCondition(" + str + ", " + str2 + ") failed: " + computeProvisioningErrorString(checkProvisioningPreConditionSkipPermissionNoLog, this.mInjector.userHandleGetCallingUserId()));
        }
        return checkProvisioningPreConditionSkipPermissionNoLog;
    }

    public final boolean isProvisioningAllowed() {
        return isDeveloperMode(this.mContext) || SystemProperties.getBoolean("ro.config.allowuserprovisioning", true);
    }

    public static boolean isDeveloperMode(Context context) {
        return Settings.Global.getInt(context.getContentResolver(), "adb_enabled", 0) > 0;
    }

    /* JADX WARN: Can't fix incorrect switch cases order, some code will duplicate */
    /* JADX WARN: Code restructure failed: missing block: B:31:0x0063, code lost:
    
        if (r5.equals("android.app.action.PROVISION_MANAGED_DEVICE") == false) goto L60;
     */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public final int checkProvisioningPreConditionSkipPermissionNoLog(java.lang.String r5, java.lang.String r6, int r7) {
        /*
            r4 = this;
            android.content.Context r0 = r4.mContext
            android.content.ContentResolver r0 = r0.getContentResolver()
            java.lang.String r1 = "rampart_blocked_device_admin_apps"
            r2 = 0
            int r0 = android.provider.Settings.Secure.getInt(r0, r1, r2)
            r1 = 1
            if (r0 != r1) goto L13
            r0 = r1
            goto L14
        L13:
            r0 = r2
        L14:
            if (r0 == 0) goto L19
            r4 = 22
            return r4
        L19:
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r0 = r4.mInjector
            boolean r0 = r0.verifyDeviceIntegrity()
            java.lang.String r3 = "DevicePolicyManager"
            if (r0 != 0) goto L2b
            java.lang.String r4 = "Failed in device integrity check"
            android.util.Log.e(r3, r4)
            r4 = 20
            return r4
        L2b:
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r0 = r4.mInjector
            boolean r0 = r0.isDeviceRootKeyInstalled()
            if (r0 != 0) goto L3b
            java.lang.String r4 = "Failed in (DRK)Device Root Key check"
            android.util.Log.e(r3, r4)
            r4 = 21
            return r4
        L3b:
            if (r5 == 0) goto L74
            int r0 = r5.hashCode()
            r3 = -1
            switch(r0) {
                case -920528692: goto L5d;
                case -340845101: goto L52;
                case 1340354933: goto L47;
                default: goto L45;
            }
        L45:
            r2 = r3
            goto L66
        L47:
            java.lang.String r0 = "android.app.action.PROVISION_FINANCED_DEVICE"
            boolean r0 = r5.equals(r0)
            if (r0 != 0) goto L50
            goto L45
        L50:
            r2 = 2
            goto L66
        L52:
            java.lang.String r0 = "android.app.action.PROVISION_MANAGED_PROFILE"
            boolean r0 = r5.equals(r0)
            if (r0 != 0) goto L5b
            goto L45
        L5b:
            r2 = r1
            goto L66
        L5d:
            java.lang.String r0 = "android.app.action.PROVISION_MANAGED_DEVICE"
            boolean r0 = r5.equals(r0)
            if (r0 != 0) goto L66
            goto L45
        L66:
            switch(r2) {
                case 0: goto L6f;
                case 1: goto L6a;
                case 2: goto L6f;
                default: goto L69;
            }
        L69:
            goto L74
        L6a:
            int r4 = r4.checkManagedProfileProvisioningPreCondition(r6, r7)
            return r4
        L6f:
            int r4 = r4.checkDeviceOwnerProvisioningPreCondition(r7)
            return r4
        L74:
            java.lang.IllegalArgumentException r4 = new java.lang.IllegalArgumentException
            java.lang.StringBuilder r6 = new java.lang.StringBuilder
            r6.<init>()
            java.lang.String r7 = "Unknown provisioning action "
            r6.append(r7)
            r6.append(r5)
            java.lang.String r5 = r6.toString()
            r4.<init>(r5)
            throw r4
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.checkProvisioningPreConditionSkipPermissionNoLog(java.lang.String, java.lang.String, int):int");
    }

    public final int checkDeviceOwnerProvisioningPreConditionLocked(ComponentName componentName, int i, int i2, boolean z, boolean z2) {
        if (this.mOwners.hasDeviceOwner()) {
            return 1;
        }
        if (this.mOwners.hasProfileOwner(i)) {
            return 2;
        }
        if (!this.mUserManager.isUserRunning(new UserHandle(i))) {
            return 3;
        }
        if (this.mIsWatch && hasPaired(0)) {
            return 8;
        }
        if (this.mInjector.userManagerIsHeadlessSystemUserMode()) {
            if (i != 0) {
                Slogf.e("DevicePolicyManager", "In headless system user mode, device owner can only be set on headless system user.");
                return 7;
            }
            if (componentName != null && findAdmin(componentName, i, false).getHeadlessDeviceOwnerMode() != 1) {
                return 16;
            }
        }
        if (!z) {
            if (i != 0) {
                return 7;
            }
            return hasUserSetupCompleted(0) ? 4 : 0;
        }
        if (this.mIsWatch || hasUserSetupCompleted(0)) {
            if (nonTestNonPrecreatedUsersExist()) {
                return 5;
            }
            int currentForegroundUserId = getCurrentForegroundUserId();
            if (i2 != currentForegroundUserId && this.mInjector.userManagerIsHeadlessSystemUserMode() && currentForegroundUserId == 0) {
                Slogf.wtf("DevicePolicyManager", "In headless system user mode, current user cannot be system user when setting device owner");
                return 10;
            }
            if (z2) {
                return 6;
            }
        }
        return 0;
    }

    public final boolean nonTestNonPrecreatedUsersExist() {
        return this.mUserManagerInternal.getUsers(true).stream().filter(new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda46
            @Override // java.util.function.Predicate
            public final boolean test(Object obj) {
                boolean lambda$nonTestNonPrecreatedUsersExist$132;
                lambda$nonTestNonPrecreatedUsersExist$132 = DevicePolicyManagerService.lambda$nonTestNonPrecreatedUsersExist$132((UserInfo) obj);
                return lambda$nonTestNonPrecreatedUsersExist$132;
            }
        }).count() > ((long) (UserManager.isHeadlessSystemUserMode() ? 2 : 1));
    }

    public static /* synthetic */ boolean lambda$nonTestNonPrecreatedUsersExist$132(UserInfo userInfo) {
        return !userInfo.isForTesting();
    }

    public final int checkDeviceOwnerProvisioningPreCondition(int i) {
        int checkDeviceOwnerProvisioningPreConditionLocked;
        synchronized (getLockObject()) {
            int i2 = this.mInjector.userManagerIsHeadlessSystemUserMode() ? 0 : i;
            Slogf.i("DevicePolicyManager", "Calling user %d, device owner will be set on user %d", Integer.valueOf(i), Integer.valueOf(i2));
            checkDeviceOwnerProvisioningPreConditionLocked = checkDeviceOwnerProvisioningPreConditionLocked(null, i2, i, false, true);
        }
        return checkDeviceOwnerProvisioningPreConditionLocked;
    }

    public final int checkManagedProfileProvisioningPreCondition(String str, int i) {
        boolean z;
        if (!hasFeatureManagedUsers()) {
            return 9;
        }
        if (lambda$isProfileOwner$71(i) != null) {
            return 2;
        }
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            UserHandle of = UserHandle.of(i);
            synchronized (getLockObject()) {
                z = getDeviceOwnerAdminLocked() != null;
            }
            boolean hasUserRestriction = this.mUserManager.hasUserRestriction("no_add_managed_profile", of);
            if (this.mUserManager.getUserInfo(i).isProfile()) {
                Slogf.i("DevicePolicyManager", "Calling user %d is a profile, cannot add another.", Integer.valueOf(i));
            } else {
                if (z && !hasUserRestriction) {
                    Slogf.wtf("DevicePolicyManager", "Has a device owner but no restriction on adding a profile.");
                }
                if (hasUserRestriction) {
                    Slogf.i("DevicePolicyManager", "Adding a profile is restricted: User %s Has device owner? %b", of, Boolean.valueOf(z));
                } else {
                    if (this.mUserManager.canAddMoreManagedProfiles(i, false)) {
                        return 0;
                    }
                    Slogf.i("DevicePolicyManager", "Cannot add more managed profiles.");
                }
            }
            return 11;
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public final void checkIsDeviceOwner(CallerIdentity callerIdentity) {
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity), callerIdentity.getUid() + " is not device owner");
    }

    public final ComponentName getOwnerComponent(int i) {
        synchronized (getLockObject()) {
            if (this.mOwners.getDeviceOwnerUserId() == i) {
                return this.mOwners.getDeviceOwnerComponent();
            }
            if (!this.mOwners.hasProfileOwner(i)) {
                return null;
            }
            return this.mOwners.getProfileOwnerComponent(i);
        }
    }

    public final boolean hasFeatureManagedUsers() {
        try {
            return this.mIPackageManager.hasSystemFeature("android.software.managed_users", 0);
        } catch (RemoteException unused) {
            return false;
        }
    }

    public String getWifiMacAddress(ComponentName componentName, String str) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        final CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        return (String) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda31
            public final Object getOrThrow() {
                String lambda$getWifiMacAddress$133;
                lambda$getWifiMacAddress$133 = DevicePolicyManagerService.this.lambda$getWifiMacAddress$133(callerIdentity);
                return lambda$getWifiMacAddress$133;
            }
        });
    }

    public /* synthetic */ String lambda$getWifiMacAddress$133(CallerIdentity callerIdentity) {
        String[] factoryMacAddresses = this.mInjector.getWifiManager().getFactoryMacAddresses();
        if (factoryMacAddresses == null) {
            return null;
        }
        DevicePolicyEventLogger.createEvent(54).setAdmin(callerIdentity.getPackageName()).write();
        if (factoryMacAddresses.length > 0) {
            return factoryMacAddresses[0];
        }
        return null;
    }

    public final int getTargetSdk(String str, int i) {
        try {
            ApplicationInfo applicationInfo = this.mIPackageManager.getApplicationInfo(str, 0L, i);
            if (applicationInfo == null) {
                return 0;
            }
            return applicationInfo.targetSdkVersion;
        } catch (RemoteException e) {
            Slogf.wtf("DevicePolicyManager", "Error getting application info", e);
            return 0;
        }
    }

    public boolean isManagedProfile(ComponentName componentName) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        return isManagedProfile(callerIdentity.getUserId());
    }

    public void reboot(final ComponentName componentName) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(getCallerIdentity(componentName)));
        checkCanExecuteOrThrowUnsafe(7);
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda109
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$reboot$134(componentName);
            }
        });
    }

    public /* synthetic */ void lambda$reboot$134(ComponentName componentName) {
        if (this.mTelephonyManager.getCallState() != 0) {
            throw new IllegalStateException("Cannot be called with ongoing call on the device");
        }
        DevicePolicyEventLogger.createEvent(34).setAdmin(componentName).write();
        this.mInjector.powerManagerReboot("deviceowner");
    }

    public void setShortSupportMessage(ComponentName componentName, String str, CharSequence charSequence) {
        CallerIdentity callerIdentity;
        ActiveAdmin activeAdminForUidLocked;
        if (this.mHasFeature) {
            CharSequence truncateIfLonger = truncateIfLonger(charSequence, 200);
            if (isPermissionCheckFlagEnabled()) {
                callerIdentity = getCallerIdentity(componentName, str);
                activeAdminForUidLocked = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_SUPPORT_MESSAGE", callerIdentity.getPackageName(), callerIdentity.getUserId()).getActiveAdmin();
            } else {
                callerIdentity = getCallerIdentity(componentName);
                Objects.requireNonNull(componentName, "ComponentName is null");
                synchronized (getLockObject()) {
                    activeAdminForUidLocked = getActiveAdminForUidLocked(componentName, callerIdentity.getUid());
                }
            }
            synchronized (getLockObject()) {
                if (!TextUtils.equals(activeAdminForUidLocked.shortSupportMessage, truncateIfLonger)) {
                    activeAdminForUidLocked.shortSupportMessage = truncateIfLonger;
                    saveSettingsLocked(callerIdentity.getUserId());
                }
            }
            DevicePolicyEventLogger.createEvent(43).setAdmin(callerIdentity.getPackageName()).write();
        }
    }

    public CharSequence getShortSupportMessage(ComponentName componentName, String str) {
        ActiveAdmin activeAdminForUidLocked;
        if (!this.mHasFeature) {
            return null;
        }
        if (isPermissionCheckFlagEnabled()) {
            CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
            activeAdminForUidLocked = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_SUPPORT_MESSAGE", callerIdentity.getPackageName(), callerIdentity.getUserId()).getActiveAdmin();
        } else {
            CallerIdentity callerIdentity2 = getCallerIdentity(componentName);
            Objects.requireNonNull(componentName, "ComponentName is null");
            synchronized (getLockObject()) {
                activeAdminForUidLocked = getActiveAdminForUidLocked(componentName, callerIdentity2.getUid());
            }
        }
        return activeAdminForUidLocked.shortSupportMessage;
    }

    public void setLongSupportMessage(ComponentName componentName, CharSequence charSequence) {
        if (this.mHasFeature) {
            CharSequence truncateIfLonger = truncateIfLonger(charSequence, 20000);
            Objects.requireNonNull(componentName, "ComponentName is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminForUidLocked = getActiveAdminForUidLocked(componentName, callerIdentity.getUid());
                if (!TextUtils.equals(activeAdminForUidLocked.longSupportMessage, truncateIfLonger)) {
                    activeAdminForUidLocked.longSupportMessage = truncateIfLonger;
                    saveSettingsLocked(callerIdentity.getUserId());
                }
            }
            DevicePolicyEventLogger.createEvent(44).setAdmin(componentName).write();
        }
    }

    public CharSequence getLongSupportMessage(ComponentName componentName) {
        CharSequence charSequence;
        if (!this.mHasFeature) {
            return null;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        synchronized (getLockObject()) {
            charSequence = getActiveAdminForUidLocked(componentName, callerIdentity.getUid()).longSupportMessage;
        }
        return charSequence;
    }

    public CharSequence getShortSupportMessageForUser(ComponentName componentName, int i) {
        if (!this.mHasFeature) {
            return null;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()), String.format("Only the system can %s", "query support message for user"));
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
            if (activeAdminUncheckedLocked == null) {
                return null;
            }
            return activeAdminUncheckedLocked.shortSupportMessage;
        }
    }

    public CharSequence getLongSupportMessageForUser(ComponentName componentName, int i) {
        if (!this.mHasFeature) {
            return null;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()), String.format("Only the system can %s", "query support message for user"));
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
            if (activeAdminUncheckedLocked == null) {
                return null;
            }
            return activeAdminUncheckedLocked.longSupportMessage;
        }
    }

    public void setOrganizationColor(ComponentName componentName, int i) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallingUser(isManagedProfile(callerIdentity.getUserId()));
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
            synchronized (getLockObject()) {
                getProfileOwnerLocked(callerIdentity.getUserId()).organizationColor = i;
                saveSettingsLocked(callerIdentity.getUserId());
            }
            DevicePolicyEventLogger.createEvent(39).setAdmin(callerIdentity.getComponentName()).write();
        }
    }

    public void setOrganizationColorForUser(int i, int i2) {
        if (this.mHasFeature) {
            Preconditions.checkArgumentNonnegative(i2, "Invalid userId");
            CallerIdentity callerIdentity = getCallerIdentity();
            Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i2));
            Preconditions.checkCallAuthorization(canManageUsers(callerIdentity));
            Preconditions.checkCallAuthorization(isManagedProfile(i2), "You can not set organization color outside a managed profile, userId = %d", new Object[]{Integer.valueOf(i2)});
            synchronized (getLockObject()) {
                getProfileOwnerAdminLocked(i2).organizationColor = i;
                saveSettingsLocked(i2);
            }
        }
    }

    public int getOrganizationColor(ComponentName componentName) {
        int i;
        if (!this.mHasFeature) {
            return ActiveAdmin.DEF_ORGANIZATION_COLOR;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallingUser(isManagedProfile(callerIdentity.getUserId()));
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
        synchronized (getLockObject()) {
            i = getProfileOwnerLocked(callerIdentity.getUserId()).organizationColor;
        }
        return i;
    }

    public int getOrganizationColorForUser(int i) {
        int i2;
        if (!this.mHasFeature) {
            return ActiveAdmin.DEF_ORGANIZATION_COLOR;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        Preconditions.checkCallAuthorization(isManagedProfile(i), "You can not get organization color outside a managed profile, userId = %d", new Object[]{Integer.valueOf(i)});
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            if (profileOwnerAdminLocked != null) {
                i2 = profileOwnerAdminLocked.organizationColor;
            } else {
                i2 = ActiveAdmin.DEF_ORGANIZATION_COLOR;
            }
        }
        return i2;
    }

    public void setOrganizationName(ComponentName componentName, String str, CharSequence charSequence) {
        ActiveAdmin activeAdmin;
        if (this.mHasFeature) {
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            String str2 = null;
            if (isPermissionCheckFlagEnabled()) {
                activeAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_ORGANIZATION_IDENTITY", callerIdentity.getPackageName(), callerIdentity.getUserId()).getActiveAdmin();
            } else {
                Objects.requireNonNull(componentName, "ComponentName is null");
                Preconditions.checkCallAuthorization(isDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
                activeAdmin = null;
            }
            CharSequence truncateIfLonger = truncateIfLonger(charSequence, 200);
            synchronized (getLockObject()) {
                if (!isPermissionCheckFlagEnabled()) {
                    activeAdmin = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
                }
                if (!TextUtils.equals(activeAdmin.organizationName, truncateIfLonger)) {
                    if (truncateIfLonger != null && truncateIfLonger.length() != 0) {
                        str2 = truncateIfLonger.toString();
                    }
                    activeAdmin.organizationName = str2;
                    saveSettingsLocked(callerIdentity.getUserId());
                }
            }
        }
    }

    public CharSequence getOrganizationName(ComponentName componentName, String str) {
        ActiveAdmin profileOwnerOrDeviceOwnerLocked;
        if (!this.mHasFeature) {
            return null;
        }
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        if (isPermissionCheckFlagEnabled()) {
            profileOwnerOrDeviceOwnerLocked = enforceCanQueryAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_ORGANIZATION_IDENTITY", callerIdentity.getPackageName(), callerIdentity.getUserId()).getActiveAdmin();
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallingUser(isManagedProfile(callerIdentity.getUserId()));
            Preconditions.checkCallAuthorization(isDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
            synchronized (getLockObject()) {
                profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
            }
        }
        return profileOwnerOrDeviceOwnerLocked.organizationName;
    }

    public CharSequence getDeviceOwnerOrganizationName() {
        String str = null;
        if (!this.mHasFeature) {
            return null;
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || canManageUsers(callerIdentity) || isFinancedDeviceOwner(callerIdentity));
        synchronized (getLockObject()) {
            ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
            if (deviceOwnerAdminLocked != null) {
                str = deviceOwnerAdminLocked.organizationName;
            }
        }
        return str;
    }

    public CharSequence getOrganizationNameForUser(int i) {
        String str;
        if (!this.mHasFeature) {
            return null;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(callerIdentity, i));
        Preconditions.checkCallAuthorization(canManageUsers(callerIdentity));
        Preconditions.checkCallAuthorization(isManagedProfile(i), "You can not get organization name outside a managed profile, userId = %d", new Object[]{Integer.valueOf(i)});
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            str = profileOwnerAdminLocked != null ? profileOwnerAdminLocked.organizationName : null;
        }
        return str;
    }

    public List setMeteredDataDisabledPackages(ComponentName componentName, final List list) {
        Objects.requireNonNull(componentName);
        Objects.requireNonNull(list);
        final CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity), "Admin %s does not own the profile", new Object[]{callerIdentity.getComponentName()});
        return !this.mHasFeature ? list : (List) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda106
            public final Object getOrThrow() {
                List lambda$setMeteredDataDisabledPackages$135;
                lambda$setMeteredDataDisabledPackages$135 = DevicePolicyManagerService.this.lambda$setMeteredDataDisabledPackages$135(callerIdentity, list);
                return lambda$setMeteredDataDisabledPackages$135;
            }
        });
    }

    public /* synthetic */ List lambda$setMeteredDataDisabledPackages$135(CallerIdentity callerIdentity, List list) {
        List removeInvalidPkgsForMeteredDataRestriction = removeInvalidPkgsForMeteredDataRestriction(callerIdentity.getUserId(), list);
        synchronized (getLockObject()) {
            getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()).meteredDisabledPackages = list;
            saveSettingsLocked(callerIdentity.getUserId());
        }
        pushMeteredDisabledPackages(callerIdentity.getUserId());
        return removeInvalidPkgsForMeteredDataRestriction;
    }

    public final List removeInvalidPkgsForMeteredDataRestriction(int i, List list) {
        ArrayList arrayList;
        synchronized (getLockObject()) {
            Set activeAdminPackagesLocked = getActiveAdminPackagesLocked(i);
            arrayList = new ArrayList();
            for (int size = list.size() - 1; size >= 0; size--) {
                String str = (String) list.get(size);
                if (activeAdminPackagesLocked.contains(str)) {
                    arrayList.add(str);
                } else {
                    try {
                        if (!this.mInjector.getIPackageManager().isPackageAvailable(str, i)) {
                            arrayList.add(str);
                        }
                    } catch (RemoteException unused) {
                    }
                }
            }
            list.removeAll(arrayList);
        }
        return arrayList;
    }

    public List getMeteredDataDisabledPackages(ComponentName componentName) {
        List list;
        Objects.requireNonNull(componentName);
        if (!this.mHasFeature) {
            return new ArrayList();
        }
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity), "Admin %s does not own the profile", new Object[]{callerIdentity.getComponentName()});
        synchronized (getLockObject()) {
            list = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()).meteredDisabledPackages;
            if (list == null) {
                list = new ArrayList();
            }
        }
        return list;
    }

    public boolean isMeteredDataDisabledPackageForUser(ComponentName componentName, String str, int i) {
        List list;
        Objects.requireNonNull(componentName);
        if (!this.mHasFeature) {
            return false;
        }
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()), String.format("Only the system can %s", "query restricted pkgs for a specific user"));
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
            if (activeAdminUncheckedLocked == null || (list = activeAdminUncheckedLocked.meteredDisabledPackages) == null) {
                return false;
            }
            return list.contains(str);
        }
    }

    public void setProfileOwnerOnOrganizationOwnedDevice(ComponentName componentName, int i, boolean z) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName);
            CallerIdentity callerIdentity = getCallerIdentity();
            if (!isAdb(callerIdentity) && !hasCallingPermission("android.permission.MARK_DEVICE_ORGANIZATION_OWNED") && !hasCallingPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS")) {
                throw new SecurityException("Only the system can mark a profile owner of organization-owned device.");
            }
            synchronized (getLockObject()) {
                if (!z) {
                    if (!isAdminTestOnlyLocked(componentName, i)) {
                        throw new SecurityException("Only a test admin can be unmarked as a profile owner of organization-owned device.");
                    }
                }
            }
            if (isAdb(callerIdentity)) {
                if (hasIncompatibleAccountsOrNonAdbNoLock(callerIdentity, i, componentName)) {
                    throw new SecurityException("Can only be called from ADB if the device has no accounts.");
                }
            } else if (hasUserSetupCompleted(0)) {
                throw new IllegalStateException("Cannot mark profile owner as managing an organization-owned device after set-up");
            }
            synchronized (getLockObject()) {
                setProfileOwnerOnOrganizationOwnedDeviceUncheckedLocked(componentName, i, z);
            }
            addPseudoAdminForWpcod(i);
        }
    }

    public final void setProfileOwnerOnOrganizationOwnedDeviceUncheckedLocked(ComponentName componentName, final int i, final boolean z) {
        if (!isProfileOwner(componentName, i)) {
            throw new IllegalArgumentException(String.format("Component %s is not a Profile Owner of user %d", componentName.flattenToString(), Integer.valueOf(i)));
        }
        Object[] objArr = new Object[3];
        objArr[0] = z ? "Marking" : "Unmarking";
        objArr[1] = componentName.flattenToString();
        objArr[2] = Integer.valueOf(i);
        Slogf.i("DevicePolicyManager", "%s %s as profile owner on organization-owned device for user %d", objArr);
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda141
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setProfileOwnerOnOrganizationOwnedDeviceUncheckedLocked$136(i, z);
            }
        });
        this.mOwners.setProfileOwnerOfOrganizationOwnedDevice(i, z);
    }

    public /* synthetic */ void lambda$setProfileOwnerOnOrganizationOwnedDeviceUncheckedLocked$136(int i, boolean z) {
        UserHandle profileParent = this.mUserManager.getProfileParent(UserHandle.of(i));
        if (profileParent == null) {
            throw new IllegalStateException(String.format("User %d is not a profile", Integer.valueOf(i)));
        }
        this.mUserManager.setUserRestriction("no_remove_managed_profile", z, profileParent);
        this.mUserManager.setUserRestriction("no_add_user", z, profileParent);
    }

    public final void pushMeteredDisabledPackages(int i) {
        wtfIfInLock();
        this.mInjector.getNetworkPolicyManagerInternal().setMeteredRestrictedPackages(getMeteredDisabledPackages(i), i);
    }

    public final Set getMeteredDisabledPackages(int i) {
        ArraySet arraySet;
        List list;
        synchronized (getLockObject()) {
            arraySet = new ArraySet();
            ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(i);
            if (deviceOrProfileOwnerAdminLocked != null && (list = deviceOrProfileOwnerAdminLocked.meteredDisabledPackages) != null) {
                arraySet.addAll(list);
            }
        }
        return arraySet;
    }

    public void setAffiliationIds(ComponentName componentName, List list) {
        boolean z;
        if (this.mHasFeature) {
            if (list == null) {
                throw new IllegalArgumentException("ids must not be null");
            }
            Iterator it = list.iterator();
            while (true) {
                z = true;
                if (!it.hasNext()) {
                    break;
                }
                String str = (String) it.next();
                Preconditions.checkArgument(true ^ TextUtils.isEmpty(str), "ids must not have empty string");
                enforceMaxStringLength(str, "affiliation id");
            }
            ArraySet arraySet = new ArraySet(list);
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            if (!isProfileOwner(callerIdentity) && !isDefaultDeviceOwner(callerIdentity)) {
                z = false;
            }
            Preconditions.checkCallAuthorization(z);
            int userId = callerIdentity.getUserId();
            synchronized (getLockObject()) {
                lambda$getUserDataUnchecked$2(userId).mAffiliationIds = arraySet;
                saveSettingsLocked(userId);
                this.mStateCache.setHasAffiliationWithDevice(userId, Boolean.valueOf(isUserAffiliatedWithDeviceLocked(userId)));
                if (userId == 0) {
                    resetAffiliationCacheLocked();
                } else if (userId != 0 && isDeviceOwner(componentName, userId)) {
                    lambda$getUserDataUnchecked$2(0).mAffiliationIds = arraySet;
                    this.mStateCache.setHasAffiliationWithDevice(0, Boolean.TRUE);
                    saveSettingsLocked(0);
                }
                maybePauseDeviceWideLoggingLocked();
                maybeResumeDeviceWideLoggingLocked();
                maybeClearLockTaskPolicyLocked();
                updateAdminCanGrantSensorsPermissionCache(userId);
            }
        }
    }

    public final void resetAffiliationCacheLocked() {
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda88
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$resetAffiliationCacheLocked$137();
            }
        });
    }

    public /* synthetic */ void lambda$resetAffiliationCacheLocked$137() {
        for (UserInfo userInfo : this.mUserManager.getUsers()) {
            DeviceStateCacheImpl deviceStateCacheImpl = this.mStateCache;
            int i = userInfo.id;
            deviceStateCacheImpl.setHasAffiliationWithDevice(i, Boolean.valueOf(isUserAffiliatedWithDeviceLocked(i)));
        }
    }

    public List getAffiliationIds(ComponentName componentName) {
        ArrayList arrayList;
        if (!this.mHasFeature) {
            return Collections.emptyList();
        }
        Objects.requireNonNull(componentName);
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        synchronized (getLockObject()) {
            arrayList = new ArrayList(lambda$getUserDataUnchecked$2(callerIdentity.getUserId()).mAffiliationIds);
        }
        return arrayList;
    }

    public boolean isCallingUserAffiliated() {
        boolean isUserAffiliatedWithDeviceLocked;
        if (!this.mHasFeature) {
            return false;
        }
        synchronized (getLockObject()) {
            isUserAffiliatedWithDeviceLocked = isUserAffiliatedWithDeviceLocked(this.mInjector.userHandleGetCallingUserId());
        }
        return isUserAffiliatedWithDeviceLocked;
    }

    public boolean isAffiliatedUser(int i) {
        if (!this.mHasFeature) {
            return false;
        }
        Preconditions.checkCallAuthorization(hasCrossUsersPermission(getCallerIdentity(), i));
        return isUserAffiliatedWithDevice(i);
    }

    public final boolean isUserAffiliatedWithDevice(int i) {
        boolean isUserAffiliatedWithDeviceLocked;
        synchronized (getLockObject()) {
            isUserAffiliatedWithDeviceLocked = isUserAffiliatedWithDeviceLocked(i);
        }
        return isUserAffiliatedWithDeviceLocked;
    }

    public final boolean isUserAffiliatedWithDeviceLocked(int i) {
        if (!this.mOwners.hasDeviceOwner()) {
            return false;
        }
        if (i == 0 || i == this.mOwners.getDeviceOwnerUserId()) {
            return true;
        }
        if (lambda$isProfileOwner$71(i) == null) {
            return false;
        }
        Set set = lambda$getUserDataUnchecked$2(i).mAffiliationIds;
        Set set2 = lambda$getUserDataUnchecked$2(0).mAffiliationIds;
        Iterator it = set.iterator();
        while (it.hasNext()) {
            if (set2.contains((String) it.next())) {
                return true;
            }
        }
        return false;
    }

    public final boolean areAllUsersAffiliatedWithDeviceLocked() {
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda3
            public final Object getOrThrow() {
                Boolean lambda$areAllUsersAffiliatedWithDeviceLocked$138;
                lambda$areAllUsersAffiliatedWithDeviceLocked$138 = DevicePolicyManagerService.this.lambda$areAllUsersAffiliatedWithDeviceLocked$138();
                return lambda$areAllUsersAffiliatedWithDeviceLocked$138;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$areAllUsersAffiliatedWithDeviceLocked$138() {
        List aliveUsers = this.mUserManager.getAliveUsers();
        for (int i = 0; i < aliveUsers.size(); i++) {
            int i2 = ((UserInfo) aliveUsers.get(i)).id;
            if (!isUserAffiliatedWithDeviceLocked(i2)) {
                Slogf.d("DevicePolicyManager", "User id " + i2 + " not affiliated.");
                return Boolean.FALSE;
            }
        }
        return Boolean.TRUE;
    }

    public final int getSecurityLoggingEnabledUser() {
        synchronized (getLockObject()) {
            if (this.mOwners.hasDeviceOwner()) {
                return -1;
            }
            return getOrganizationOwnedProfileUserId();
        }
    }

    public void setSecurityLoggingEnabled(ComponentName componentName, String str, boolean z) {
        boolean z2;
        if (this.mHasFeature) {
            CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
            synchronized (getLockObject()) {
                if (isPermissionCheckFlagEnabled()) {
                    enforcePermission("android.permission.MANAGE_DEVICE_POLICY_SECURITY_LOGGING", callerIdentity.getPackageName(), -1);
                } else if (componentName != null) {
                    if (!isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) && !isDefaultDeviceOwner(callerIdentity)) {
                        z2 = false;
                        Preconditions.checkCallAuthorization(z2);
                    }
                    z2 = true;
                    Preconditions.checkCallAuthorization(z2);
                } else {
                    Preconditions.checkCallAuthorization(isCallerDelegate(callerIdentity, "delegation-security-logging"));
                }
                if (z == this.mInjector.securityLogGetLoggingEnabledProperty()) {
                    return;
                }
                this.mInjector.securityLogSetLoggingEnabledProperty(z);
                if (z) {
                    this.mSecurityLogMonitor.start(getSecurityLoggingEnabledUser());
                    maybePauseDeviceWideLoggingLocked();
                } else {
                    this.mSecurityLogMonitor.stop();
                }
                DevicePolicyEventLogger.createEvent(15).setAdmin(callerIdentity.getPackageName()).setBoolean(z).write();
            }
        }
    }

    public boolean isSecurityLoggingEnabled(ComponentName componentName, String str) {
        boolean securityLogGetLoggingEnabledProperty;
        if (!this.mHasFeature) {
            return false;
        }
        synchronized (getLockObject()) {
            if (!isSystemUid(getCallerIdentity())) {
                CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
                if (isPermissionCheckFlagEnabled()) {
                    enforcePermission("android.permission.MANAGE_DEVICE_POLICY_SECURITY_LOGGING", callerIdentity.getPackageName(), -1);
                } else if (componentName != null) {
                    Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
                } else {
                    Preconditions.checkCallAuthorization(isCallerDelegate(callerIdentity, "delegation-security-logging"));
                }
            }
            securityLogGetLoggingEnabledProperty = this.mInjector.securityLogGetLoggingEnabledProperty();
        }
        return securityLogGetLoggingEnabledProperty;
    }

    public final void recordSecurityLogRetrievalTime() {
        synchronized (getLockObject()) {
            long currentTimeMillis = System.currentTimeMillis();
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(0);
            if (currentTimeMillis > lambda$getUserDataUnchecked$2.mLastSecurityLogRetrievalTime) {
                lambda$getUserDataUnchecked$2.mLastSecurityLogRetrievalTime = currentTimeMillis;
                saveSettingsLocked(0);
            }
        }
    }

    public ParceledListSlice retrievePreRebootSecurityLogs(ComponentName componentName, String str) {
        if (!this.mHasFeature) {
            return null;
        }
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        if (isPermissionCheckFlagEnabled()) {
            Preconditions.checkCallAuthorization(isOrganizationOwnedDeviceWithManagedProfile() || areAllUsersAffiliatedWithDeviceLocked());
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_SECURITY_LOGGING", callerIdentity.getPackageName(), -1);
        } else {
            if (componentName != null) {
                Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
            } else {
                Preconditions.checkCallAuthorization(isCallerDelegate(callerIdentity, "delegation-security-logging"));
            }
            Preconditions.checkCallAuthorization(isOrganizationOwnedDeviceWithManagedProfile() || areAllUsersAffiliatedWithDeviceLocked());
        }
        DevicePolicyEventLogger.createEvent(17).setAdmin(callerIdentity.getPackageName()).write();
        if (!this.mContext.getResources().getBoolean(17891856) || !this.mInjector.securityLogGetLoggingEnabledProperty()) {
            return null;
        }
        recordSecurityLogRetrievalTime();
        ArrayList arrayList = new ArrayList();
        try {
            SecurityLog.readPreviousEvents(arrayList);
            int securityLoggingEnabledUser = getSecurityLoggingEnabledUser();
            if (securityLoggingEnabledUser != -1) {
                SecurityLog.redactEvents(arrayList, securityLoggingEnabledUser);
            }
            return new ParceledListSlice(arrayList);
        } catch (IOException e) {
            Slogf.w("DevicePolicyManager", "Fail to read previous events", e);
            return new ParceledListSlice(Collections.emptyList());
        }
    }

    public ParceledListSlice retrieveSecurityLogs(ComponentName componentName, String str) {
        if (!this.mHasFeature) {
            return null;
        }
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        if (isPermissionCheckFlagEnabled()) {
            Preconditions.checkCallAuthorization(isOrganizationOwnedDeviceWithManagedProfile() || areAllUsersAffiliatedWithDeviceLocked());
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_SECURITY_LOGGING", callerIdentity.getPackageName(), -1);
        } else {
            if (componentName != null) {
                Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
            } else {
                Preconditions.checkCallAuthorization(isCallerDelegate(callerIdentity, "delegation-security-logging"));
            }
            Preconditions.checkCallAuthorization(isOrganizationOwnedDeviceWithManagedProfile() || areAllUsersAffiliatedWithDeviceLocked());
        }
        if (!this.mInjector.securityLogGetLoggingEnabledProperty()) {
            return null;
        }
        recordSecurityLogRetrievalTime();
        List retrieveLogs = this.mSecurityLogMonitor.retrieveLogs();
        DevicePolicyEventLogger.createEvent(16).setAdmin(callerIdentity.getPackageName()).write();
        if (retrieveLogs != null) {
            return new ParceledListSlice(retrieveLogs);
        }
        return null;
    }

    public long forceSecurityLogs() {
        Preconditions.checkCallAuthorization(isAdb(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.FORCE_DEVICE_POLICY_MANAGER_LOGS"), "Caller must be shell or hold FORCE_DEVICE_POLICY_MANAGER_LOGS to call forceSecurityLogs");
        if (!this.mInjector.securityLogGetLoggingEnabledProperty()) {
            throw new IllegalStateException("logging is not available");
        }
        return this.mSecurityLogMonitor.forceLogs();
    }

    public boolean isUninstallInQueue(String str) {
        boolean contains;
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_DEVICE_ADMINS"));
        UserPackage of = UserPackage.of(callerIdentity.getUserId(), str);
        synchronized (getLockObject()) {
            contains = this.mPackagesToRemove.contains(of);
        }
        return contains;
    }

    public void uninstallPackageWithActiveAdmins(String str) {
        Preconditions.checkArgument(!TextUtils.isEmpty(str));
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_DEVICE_ADMINS"));
        int userId = callerIdentity.getUserId();
        enforceUserUnlocked(userId);
        ComponentName lambda$isProfileOwner$71 = lambda$isProfileOwner$71(userId);
        if (lambda$isProfileOwner$71 != null && str.equals(lambda$isProfileOwner$71.getPackageName())) {
            throw new IllegalArgumentException("Cannot uninstall a package with a profile owner");
        }
        ComponentName deviceOwnerComponent = getDeviceOwnerComponent(false);
        if (getDeviceOwnerUserId() == userId && deviceOwnerComponent != null && str.equals(deviceOwnerComponent.getPackageName())) {
            throw new IllegalArgumentException("Cannot uninstall a package with a device owner");
        }
        IEnterpriseDeviceManager iEDMService = this.mInjector.getIEDMService();
        ComponentName componentNameByPackageName = getComponentNameByPackageName(str, userId);
        if (iEDMService == null || componentNameByPackageName == null) {
            Log.d("DevicePolicyManager", "uninstallPackageWithActiveAdmins() : passed by invalid edms - " + componentNameByPackageName + ", userId = " + userId);
        } else {
            try {
                if (!iEDMService.isAdminRemovableInternal(componentNameByPackageName, userId)) {
                    Log.d("DevicePolicyManager", "uninstallPackageWithActiveAdmins() has failed because this admin doesn't allow to remove - " + componentNameByPackageName + ", userId = " + userId);
                    return;
                }
            } catch (Exception e) {
                Log.e("DevicePolicyManager", "uninstallPackageWithActiveAdmins() : failed to call isAdminRemovableInternal()", e);
            }
        }
        UserPackage of = UserPackage.of(userId, str);
        synchronized (getLockObject()) {
            this.mPackagesToRemove.add(of);
        }
        List<ComponentName> activeAdmins = getActiveAdmins(userId);
        ArrayList arrayList = new ArrayList();
        if (activeAdmins != null) {
            for (ComponentName componentName : activeAdmins) {
                if (str.equals(componentName.getPackageName())) {
                    arrayList.add(componentName);
                    removeActiveAdmin(componentName, userId);
                }
            }
        }
        if (arrayList.size() == 0) {
            startUninstallIntent(str, userId);
        } else {
            this.mHandler.postDelayed(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService.7
                public final /* synthetic */ List val$packageActiveAdmins;
                public final /* synthetic */ String val$packageName;
                public final /* synthetic */ int val$userId;

                public AnonymousClass7(List arrayList2, int userId2, String str2) {
                    r2 = arrayList2;
                    r3 = userId2;
                    r4 = str2;
                }

                @Override // java.lang.Runnable
                public void run() {
                    Iterator it = r2.iterator();
                    while (it.hasNext()) {
                        DevicePolicyManagerService.this.removeAdminArtifacts((ComponentName) it.next(), r3);
                    }
                    DevicePolicyManagerService.this.startUninstallIntent(r4, r3);
                }
            }, 10000L);
        }
    }

    /* renamed from: com.android.server.devicepolicy.DevicePolicyManagerService$7 */
    /* loaded from: classes2.dex */
    public class AnonymousClass7 implements Runnable {
        public final /* synthetic */ List val$packageActiveAdmins;
        public final /* synthetic */ String val$packageName;
        public final /* synthetic */ int val$userId;

        public AnonymousClass7(List arrayList2, int userId2, String str2) {
            r2 = arrayList2;
            r3 = userId2;
            r4 = str2;
        }

        @Override // java.lang.Runnable
        public void run() {
            Iterator it = r2.iterator();
            while (it.hasNext()) {
                DevicePolicyManagerService.this.removeAdminArtifacts((ComponentName) it.next(), r3);
            }
            DevicePolicyManagerService.this.startUninstallIntent(r4, r3);
        }
    }

    public boolean isDeviceProvisioned() {
        boolean z;
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()));
        synchronized (getLockObject()) {
            z = getUserDataUnchecked(0).mUserSetupComplete;
        }
        return z;
    }

    public final boolean isCurrentUserDemo() {
        if (!UserManager.isDeviceInDemoMode(this.mContext)) {
            return false;
        }
        final int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda32
            public final Object getOrThrow() {
                Boolean lambda$isCurrentUserDemo$139;
                lambda$isCurrentUserDemo$139 = DevicePolicyManagerService.this.lambda$isCurrentUserDemo$139(userHandleGetCallingUserId);
                return lambda$isCurrentUserDemo$139;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$isCurrentUserDemo$139(int i) {
        return Boolean.valueOf(this.mUserManager.getUserInfo(i).isDemo());
    }

    public final void removePackageIfRequired(String str, int i) {
        if (packageHasActiveAdmins(str, i)) {
            return;
        }
        startUninstallIntent(str, i);
    }

    public final void startUninstallIntent(String str, int i) {
        UserPackage of = UserPackage.of(i, str);
        synchronized (getLockObject()) {
            if (this.mPackagesToRemove.contains(of)) {
                this.mPackagesToRemove.remove(of);
                if (isPackageInstalledForUser(str, i)) {
                    try {
                        this.mInjector.getIActivityManager().forceStopPackage(str, i);
                    } catch (RemoteException unused) {
                        Slogf.e("DevicePolicyManager", "Failure talking to ActivityManager while force stopping package");
                    }
                    Intent intent = new Intent("android.intent.action.UNINSTALL_PACKAGE", Uri.parse("package:" + str));
                    intent.setFlags(268435456);
                    this.mContext.startActivityAsUser(intent, UserHandle.of(i));
                }
            }
        }
    }

    public final void removeAdminArtifacts(ComponentName componentName, int i) {
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
            if (activeAdminUncheckedLocked == null) {
                return;
            }
            resetWifiAutomaticConnectionPolicy(activeAdminUncheckedLocked.getUid());
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            boolean usesPolicy = activeAdminUncheckedLocked.info.usesPolicy(5);
            lambda$getUserDataUnchecked$2.mAdminList.remove(activeAdminUncheckedLocked);
            lambda$getUserDataUnchecked$2.mAdminMap.remove(componentName);
            lambda$getUserDataUnchecked$2.validatePasswordOwner();
            if (usesPolicy) {
                lambda$setGlobalProxy$62(lambda$getUserDataUnchecked$2);
            }
            int i2 = activeAdminUncheckedLocked.allowBluetoothMode;
            boolean z = activeAdminUncheckedLocked.allowWifi;
            boolean z2 = activeAdminUncheckedLocked.allowStorageCard;
            boolean z3 = activeAdminUncheckedLocked.allowInternetSharing;
            boolean z4 = activeAdminUncheckedLocked.allowDesktopSync;
            boolean z5 = true;
            boolean z6 = i2 != semGetAllowBluetoothMode(null, i);
            boolean z7 = z != semGetAllowWifi(null, i);
            boolean z8 = z2 != semGetAllowStorageCard(null, i);
            boolean z9 = z3 != semGetAllowInternetSharing(null, i);
            boolean z10 = z4 != semGetAllowDesktopSync(null, i);
            if (!z6 && !z7 && !z8 && !z9 && !z10) {
                z5 = false;
            }
            pushActiveAdminPackagesLocked(i);
            saveSettingsLocked(i, z6, z7, z5);
            updateMaximumTimeToLockLocked(i);
            lambda$getUserDataUnchecked$2.mRemovingAdmins.remove(componentName);
            pushScreenCapturePolicy(i);
            Slogf.i("DevicePolicyManager", "Device admin " + componentName + " removed from user " + i);
            pushMeteredDisabledPackages(i);
            pushUserRestrictions(i);
            pushCameraRestrictionForRemovingAdmin(i);
        }
    }

    public final void resetWifiAutomaticConnectionPolicy(final int i) {
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda198
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$resetWifiAutomaticConnectionPolicy$140(i);
            }
        });
    }

    public /* synthetic */ void lambda$resetWifiAutomaticConnectionPolicy$140(int i) {
        try {
            IWifiPolicy wifiService = this.mInjector.getWifiService();
            if (wifiService != null) {
                wifiService.resetAutomaticConnectionPolicy(i);
            }
        } catch (RemoteException unused) {
        }
    }

    public void setDeviceProvisioningConfigApplied() {
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()));
        synchronized (getLockObject()) {
            lambda$getUserDataUnchecked$2(0).mDeviceProvisioningConfigApplied = true;
            saveSettingsLocked(0);
        }
    }

    public boolean isDeviceProvisioningConfigApplied() {
        boolean z;
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()));
        synchronized (getLockObject()) {
            z = lambda$getUserDataUnchecked$2(0).mDeviceProvisioningConfigApplied;
        }
        return z;
    }

    public void forceUpdateUserSetupComplete(int i) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        boolean z = this.mInjector.settingsSecureGetIntForUser("user_setup_complete", 0, i) != 0;
        lambda$getUserDataUnchecked$2(i).mUserSetupComplete = z;
        this.mStateCache.setDeviceProvisioned(z);
        synchronized (getLockObject()) {
            saveSettingsLocked(i);
        }
    }

    public void setBackupServiceEnabled(ComponentName componentName, boolean z) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity) || isFinancedDeviceOwner(callerIdentity));
            toggleBackupServiceActive(callerIdentity.getUserId(), z);
        }
    }

    public boolean isBackupServiceEnabled(ComponentName componentName) {
        boolean z = true;
        if (!this.mHasFeature) {
            return true;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        final CallerIdentity callerIdentity = getCallerIdentity(componentName);
        if (!isDefaultDeviceOwner(callerIdentity) && !isProfileOwner(callerIdentity) && !isFinancedDeviceOwner(callerIdentity)) {
            z = false;
        }
        Preconditions.checkCallAuthorization(z);
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda103
            public final Object getOrThrow() {
                Boolean lambda$isBackupServiceEnabled$141;
                lambda$isBackupServiceEnabled$141 = DevicePolicyManagerService.this.lambda$isBackupServiceEnabled$141(callerIdentity);
                return lambda$isBackupServiceEnabled$141;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$isBackupServiceEnabled$141(CallerIdentity callerIdentity) {
        Boolean valueOf;
        synchronized (getLockObject()) {
            try {
                try {
                    IBackupManager iBackupManager = this.mInjector.getIBackupManager();
                    valueOf = Boolean.valueOf(iBackupManager != null && iBackupManager.isBackupServiceActive(callerIdentity.getUserId()));
                } catch (RemoteException e) {
                    throw new IllegalStateException("Failed requesting backup service state.", e);
                }
            } catch (Throwable th) {
                throw th;
            }
        }
        return valueOf;
    }

    public boolean bindDeviceAdminServiceAsUser(ComponentName componentName, IApplicationThread iApplicationThread, IBinder iBinder, Intent intent, IServiceConnection iServiceConnection, long j, int i) {
        String ownerPackageNameForUserLocked;
        boolean z = false;
        if (!this.mHasFeature) {
            return false;
        }
        Objects.requireNonNull(componentName);
        Objects.requireNonNull(iApplicationThread);
        Objects.requireNonNull(intent);
        Preconditions.checkArgument((intent.getComponent() == null && intent.getPackage() == null) ? false : true, "Service intent must be explicit (with a package name or component): " + intent);
        Objects.requireNonNull(iServiceConnection);
        Preconditions.checkArgument(this.mInjector.userHandleGetCallingUserId() != i, "target user id must be different from the calling user id");
        if (!getBindDeviceAdminTargetUsers(componentName).contains(UserHandle.of(i))) {
            throw new SecurityException("Not allowed to bind to target user id");
        }
        synchronized (getLockObject()) {
            ownerPackageNameForUserLocked = getOwnerPackageNameForUserLocked(i);
        }
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            if (createCrossUserServiceIntent(intent, ownerPackageNameForUserLocked, i) != null) {
                if (this.mInjector.getIActivityManager().bindService(iApplicationThread, iBinder, intent, intent.resolveTypeIfNeeded(this.mContext.getContentResolver()), iServiceConnection, j, this.mContext.getOpPackageName(), i) != 0) {
                    z = true;
                }
            }
            return z;
        } catch (RemoteException unused) {
            return false;
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public List getBindDeviceAdminTargetUsers(final ComponentName componentName) {
        List list;
        if (!this.mHasFeature) {
            return Collections.emptyList();
        }
        Objects.requireNonNull(componentName);
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        synchronized (getLockObject()) {
            final int userId = callerIdentity.getUserId();
            list = (List) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda190
                public final Object getOrThrow() {
                    ArrayList lambda$getBindDeviceAdminTargetUsers$142;
                    lambda$getBindDeviceAdminTargetUsers$142 = DevicePolicyManagerService.this.lambda$getBindDeviceAdminTargetUsers$142(componentName, userId);
                    return lambda$getBindDeviceAdminTargetUsers$142;
                }
            });
        }
        return list;
    }

    public /* synthetic */ ArrayList lambda$getBindDeviceAdminTargetUsers$142(ComponentName componentName, int i) {
        ArrayList arrayList = new ArrayList();
        if (!isDeviceOwner(componentName, i)) {
            if (canUserBindToDeviceOwnerLocked(i)) {
                arrayList.add(UserHandle.of(this.mOwners.getDeviceOwnerUserId()));
            }
        } else {
            List aliveUsers = this.mUserManager.getAliveUsers();
            for (int i2 = 0; i2 < aliveUsers.size(); i2++) {
                int i3 = ((UserInfo) aliveUsers.get(i2)).id;
                if (i3 != i && canUserBindToDeviceOwnerLocked(i3)) {
                    arrayList.add(UserHandle.of(i3));
                }
            }
        }
        return arrayList;
    }

    public final boolean canUserBindToDeviceOwnerLocked(int i) {
        if (this.mOwners.hasDeviceOwner() && i != this.mOwners.getDeviceOwnerUserId() && this.mOwners.hasProfileOwner(i) && TextUtils.equals(this.mOwners.getDeviceOwnerPackageName(), this.mOwners.getProfileOwnerPackage(i))) {
            return isUserAffiliatedWithDeviceLocked(i);
        }
        return false;
    }

    public final boolean hasIncompatibleAccountsOnAnyUser() {
        if (this.mHasIncompatibleAccounts == null) {
            return true;
        }
        Iterator it = this.mHasIncompatibleAccounts.values().iterator();
        while (it.hasNext()) {
            if (((Boolean) it.next()).booleanValue()) {
                return true;
            }
        }
        return false;
    }

    public final boolean hasIncompatibleAccounts(int i) {
        if (this.mHasIncompatibleAccounts == null) {
            return true;
        }
        return ((Boolean) this.mHasIncompatibleAccounts.getOrDefault(Integer.valueOf(i), Boolean.FALSE)).booleanValue();
    }

    public final boolean hasIncompatibleAccountsOrNonAdbNoLock(CallerIdentity callerIdentity, final int i, final ComponentName componentName) {
        if (!isAdb(callerIdentity)) {
            return true;
        }
        wtfIfInLock();
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda55
            public final Object getOrThrow() {
                Boolean lambda$hasIncompatibleAccountsOrNonAdbNoLock$143;
                lambda$hasIncompatibleAccountsOrNonAdbNoLock$143 = DevicePolicyManagerService.this.lambda$hasIncompatibleAccountsOrNonAdbNoLock$143(i, componentName);
                return lambda$hasIncompatibleAccountsOrNonAdbNoLock$143;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$hasIncompatibleAccountsOrNonAdbNoLock$143(int i, ComponentName componentName) {
        if (((AccountManager) this.mContext.createContextAsUser(UserHandle.of(i), 0).getSystemService(AccountManager.class)).getAccounts().length == 0) {
            return Boolean.FALSE;
        }
        synchronized (getLockObject()) {
            if (componentName != null) {
                if (isAdminTestOnlyLocked(componentName, i)) {
                    boolean z = !hasIncompatibleAccounts(i);
                    if (z) {
                        Slogf.w("DevicePolicyManager", "All accounts are compatible");
                    } else {
                        Slogf.e("DevicePolicyManager", "Found incompatible accounts");
                    }
                    return Boolean.valueOf(!z);
                }
            }
            Slogf.w("DevicePolicyManager", "Non test-only owner can't be installed with existing accounts.");
            return Boolean.TRUE;
        }
    }

    public void calculateHasIncompatibleAccounts() {
        if (this.calculateHasIncompatibleAccountsExecutor.getQueue().size() > 1) {
            return;
        }
        new CalculateHasIncompatibleAccountsTask().executeOnExecutor(this.calculateHasIncompatibleAccountsExecutor, null);
    }

    /* loaded from: classes2.dex */
    public class CalculateHasIncompatibleAccountsTask extends AsyncTask {
        public static final String[] FEATURE_ALLOW = {"android.account.DEVICE_OR_PROFILE_OWNER_ALLOWED"};
        public static final String[] FEATURE_DISALLOW = {"android.account.DEVICE_OR_PROFILE_OWNER_DISALLOWED"};

        public CalculateHasIncompatibleAccountsTask() {
        }

        @Override // android.os.AsyncTask
        public Map doInBackground(Void... voidArr) {
            List<UserInfo> users = DevicePolicyManagerService.this.mUserManagerInternal.getUsers(true);
            HashMap hashMap = new HashMap();
            for (UserInfo userInfo : users) {
                hashMap.put(Integer.valueOf(userInfo.id), Boolean.valueOf(userHasIncompatibleAccounts(userInfo.id)));
            }
            return hashMap;
        }

        public final boolean userHasIncompatibleAccounts(int i) {
            AccountManager accountManager = (AccountManager) DevicePolicyManagerService.this.mContext.createContextAsUser(UserHandle.of(i), 0).getSystemService(AccountManager.class);
            for (Account account : accountManager.getAccounts()) {
                if (hasAccountFeatures(accountManager, account, FEATURE_DISALLOW) || !hasAccountFeatures(accountManager, account, FEATURE_ALLOW)) {
                    return true;
                }
            }
            return false;
        }

        @Override // android.os.AsyncTask
        public void onPostExecute(Map map) {
            DevicePolicyManagerService.this.mHasIncompatibleAccounts = Collections.unmodifiableMap(map);
            Slogf.i("DevicePolicyManager", "Finished calculating hasIncompatibleAccountsTask");
        }

        public static boolean hasAccountFeatures(AccountManager accountManager, Account account, String[] strArr) {
            try {
                return accountManager.hasFeatures(account, strArr, null, null).getResult().booleanValue();
            } catch (Exception e) {
                Slogf.w("DevicePolicyManager", "Failed to get account feature", e);
                return false;
            }
        }
    }

    public final boolean isAdb(CallerIdentity callerIdentity) {
        return isShellUid(callerIdentity) || isRootUid(callerIdentity);
    }

    public void setNetworkLoggingEnabled(ComponentName componentName, String str, boolean z) {
        if (this.mHasFeature) {
            CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
            boolean z2 = isProfileOwner(callerIdentity) && isManagedProfile(callerIdentity.getUserId());
            Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isDefaultDeviceOwner(callerIdentity) || z2)) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-network-logging")));
            synchronized (getLockObject()) {
                if (z == isNetworkLoggingEnabledInternalLocked()) {
                    return;
                }
                ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(callerIdentity.getUserId());
                deviceOrProfileOwnerAdminLocked.isNetworkLoggingEnabled = z;
                if (!z) {
                    deviceOrProfileOwnerAdminLocked.numNetworkLoggingNotifications = 0;
                    deviceOrProfileOwnerAdminLocked.lastNetworkLoggingNotificationTimeMs = 0L;
                }
                saveSettingsLocked(callerIdentity.getUserId());
                setNetworkLoggingActiveInternal(z);
                DevicePolicyEventLogger devicePolicyEventLogger = DevicePolicyEventLogger.createEvent(119).setAdmin(callerIdentity.getPackageName()).setBoolean(componentName == null).setInt(z ? 1 : 0);
                String[] strArr = new String[1];
                strArr[0] = z2 ? "profile-owner" : "device-owner";
                devicePolicyEventLogger.setStrings(strArr).write();
            }
        }
    }

    public final void setNetworkLoggingActiveInternal(final boolean z) {
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda2
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setNetworkLoggingActiveInternal$146(z);
            }
        });
    }

    public /* synthetic */ void lambda$setNetworkLoggingActiveInternal$146(boolean z) {
        boolean z2;
        synchronized (getLockObject()) {
            if (z) {
                if (this.mNetworkLogger == null) {
                    int networkLoggingAffectedUser = getNetworkLoggingAffectedUser();
                    PackageManagerInternal packageManagerInternal = this.mInjector.getPackageManagerInternal();
                    if (networkLoggingAffectedUser == 0) {
                        networkLoggingAffectedUser = -1;
                    }
                    this.mNetworkLogger = new NetworkLogger(this, packageManagerInternal, networkLoggingAffectedUser);
                }
                if (!this.mNetworkLogger.startNetworkLogging()) {
                    this.mNetworkLogger = null;
                    Slogf.wtf("DevicePolicyManager", "Network logging could not be started due to the logging service not being available yet.");
                }
                maybePauseDeviceWideLoggingLocked();
                z2 = shouldSendNetworkLoggingNotificationLocked();
            } else {
                NetworkLogger networkLogger = this.mNetworkLogger;
                if (networkLogger != null && !networkLogger.stopNetworkLogging()) {
                    Slogf.wtf("DevicePolicyManager", "Network logging could not be stopped due to the logging service not being available yet.");
                }
                this.mNetworkLogger = null;
                z2 = false;
            }
        }
        if (!z) {
            this.mHandler.post(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda217
                @Override // java.lang.Runnable
                public final void run() {
                    DevicePolicyManagerService.this.lambda$setNetworkLoggingActiveInternal$145();
                }
            });
        } else if (z2) {
            this.mHandler.post(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda216
                @Override // java.lang.Runnable
                public final void run() {
                    DevicePolicyManagerService.this.lambda$setNetworkLoggingActiveInternal$144();
                }
            });
        }
    }

    public final int getNetworkLoggingAffectedUser() {
        synchronized (getLockObject()) {
            if (this.mOwners.hasDeviceOwner()) {
                return this.mOwners.getDeviceOwnerUserId();
            }
            return ((Integer) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda161
                public final Object getOrThrow() {
                    Integer lambda$getNetworkLoggingAffectedUser$147;
                    lambda$getNetworkLoggingAffectedUser$147 = DevicePolicyManagerService.this.lambda$getNetworkLoggingAffectedUser$147();
                    return lambda$getNetworkLoggingAffectedUser$147;
                }
            })).intValue();
        }
    }

    public /* synthetic */ Integer lambda$getNetworkLoggingAffectedUser$147() {
        return Integer.valueOf(getManagedUserId());
    }

    public final ActiveAdmin getNetworkLoggingControllingAdminLocked() {
        int networkLoggingAffectedUser = getNetworkLoggingAffectedUser();
        if (networkLoggingAffectedUser < 0) {
            return null;
        }
        return getDeviceOrProfileOwnerAdminLocked(networkLoggingAffectedUser);
    }

    public long forceNetworkLogs() {
        Preconditions.checkCallAuthorization(isAdb(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.FORCE_DEVICE_POLICY_MANAGER_LOGS"), "Caller must be shell or hold FORCE_DEVICE_POLICY_MANAGER_LOGS to call forceNetworkLogs");
        synchronized (getLockObject()) {
            if (!isNetworkLoggingEnabledInternalLocked()) {
                throw new IllegalStateException("logging is not available");
            }
            if (this.mNetworkLogger != null) {
                return ((Long) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda183
                    public final Object getOrThrow() {
                        Long lambda$forceNetworkLogs$148;
                        lambda$forceNetworkLogs$148 = DevicePolicyManagerService.this.lambda$forceNetworkLogs$148();
                        return lambda$forceNetworkLogs$148;
                    }
                })).longValue();
            }
            return 0L;
        }
    }

    public /* synthetic */ Long lambda$forceNetworkLogs$148() {
        return Long.valueOf(this.mNetworkLogger.forceBatchFinalization());
    }

    public final void maybePauseDeviceWideLoggingLocked() {
        if (areAllUsersAffiliatedWithDeviceLocked()) {
            return;
        }
        if (this.mOwners.hasDeviceOwner()) {
            Slogf.i("DevicePolicyManager", "There are unaffiliated users, network logging will be paused if enabled.");
            NetworkLogger networkLogger = this.mNetworkLogger;
            if (networkLogger != null) {
                networkLogger.pause();
            }
        }
        if (isOrganizationOwnedDeviceWithManagedProfile()) {
            return;
        }
        Slogf.i("DevicePolicyManager", "Not org-owned managed profile device, security logging will be paused if enabled.");
        this.mSecurityLogMonitor.pause();
    }

    public final void maybeResumeDeviceWideLoggingLocked() {
        final boolean areAllUsersAffiliatedWithDeviceLocked = areAllUsersAffiliatedWithDeviceLocked();
        final boolean isOrganizationOwnedDeviceWithManagedProfile = isOrganizationOwnedDeviceWithManagedProfile();
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda134
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$maybeResumeDeviceWideLoggingLocked$149(areAllUsersAffiliatedWithDeviceLocked, isOrganizationOwnedDeviceWithManagedProfile);
            }
        });
    }

    public /* synthetic */ void lambda$maybeResumeDeviceWideLoggingLocked$149(boolean z, boolean z2) {
        NetworkLogger networkLogger;
        if (z || z2) {
            this.mSecurityLogMonitor.resume();
        }
        if ((z || !this.mOwners.hasDeviceOwner()) && (networkLogger = this.mNetworkLogger) != null) {
            networkLogger.resume();
        }
    }

    public final void discardDeviceWideLogsLocked() {
        this.mSecurityLogMonitor.discardLogs();
        NetworkLogger networkLogger = this.mNetworkLogger;
        if (networkLogger != null) {
            networkLogger.discardLogs();
        }
    }

    public boolean isNetworkLoggingEnabled(ComponentName componentName, String str) {
        boolean isNetworkLoggingEnabledInternalLocked;
        if (!this.mHasFeature) {
            return false;
        }
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isDefaultDeviceOwner(callerIdentity) || (isProfileOwner(callerIdentity) && isManagedProfile(callerIdentity.getUserId())))) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-network-logging")) || hasCallingOrSelfPermission("android.permission.MANAGE_USERS"));
        synchronized (getLockObject()) {
            isNetworkLoggingEnabledInternalLocked = isNetworkLoggingEnabledInternalLocked();
        }
        return isNetworkLoggingEnabledInternalLocked;
    }

    public final boolean isNetworkLoggingEnabledInternalLocked() {
        ActiveAdmin networkLoggingControllingAdminLocked = getNetworkLoggingControllingAdminLocked();
        return networkLoggingControllingAdminLocked != null && networkLoggingControllingAdminLocked.isNetworkLoggingEnabled;
    }

    public List retrieveNetworkLogs(ComponentName componentName, String str, long j) {
        if (!this.mHasFeature) {
            return null;
        }
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        boolean z = isProfileOwner(callerIdentity) && isManagedProfile(callerIdentity.getUserId());
        Preconditions.checkCallAuthorization((callerIdentity.hasAdminComponent() && (isDefaultDeviceOwner(callerIdentity) || z)) || (callerIdentity.hasPackage() && isCallerDelegate(callerIdentity, "delegation-network-logging")));
        if (this.mOwners.hasDeviceOwner()) {
            checkAllUsersAreAffiliatedWithDevice();
        }
        synchronized (getLockObject()) {
            if (this.mNetworkLogger != null && isNetworkLoggingEnabledInternalLocked()) {
                DevicePolicyEventLogger devicePolicyEventLogger = DevicePolicyEventLogger.createEvent(120).setAdmin(callerIdentity.getPackageName()).setBoolean(componentName == null);
                String[] strArr = new String[1];
                strArr[0] = z ? "profile-owner" : "device-owner";
                devicePolicyEventLogger.setStrings(strArr).write();
                long currentTimeMillis = System.currentTimeMillis();
                DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(callerIdentity.getUserId());
                if (currentTimeMillis > lambda$getUserDataUnchecked$2.mLastNetworkLogsRetrievalTime) {
                    lambda$getUserDataUnchecked$2.mLastNetworkLogsRetrievalTime = currentTimeMillis;
                    saveSettingsLocked(callerIdentity.getUserId());
                }
                return this.mNetworkLogger.retrieveLogs(j);
            }
            return null;
        }
    }

    public final boolean shouldSendNetworkLoggingNotificationLocked() {
        ensureLocked();
        ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
        if (deviceOwnerAdminLocked == null || !deviceOwnerAdminLocked.isNetworkLoggingEnabled || deviceOwnerAdminLocked.numNetworkLoggingNotifications >= 2) {
            return false;
        }
        long currentTimeMillis = System.currentTimeMillis();
        if (currentTimeMillis - deviceOwnerAdminLocked.lastNetworkLoggingNotificationTimeMs < MS_PER_DAY) {
            return false;
        }
        int i = deviceOwnerAdminLocked.numNetworkLoggingNotifications + 1;
        deviceOwnerAdminLocked.numNetworkLoggingNotifications = i;
        if (i >= 2) {
            deviceOwnerAdminLocked.lastNetworkLoggingNotificationTimeMs = 0L;
        } else {
            deviceOwnerAdminLocked.lastNetworkLoggingNotificationTimeMs = currentTimeMillis;
        }
        saveSettingsLocked(deviceOwnerAdminLocked.getUserHandle().getIdentifier());
        return true;
    }

    /* renamed from: handleSendNetworkLoggingNotification */
    public final void lambda$setNetworkLoggingActiveInternal$144() {
        PackageManagerInternal packageManagerInternal = this.mInjector.getPackageManagerInternal();
        Intent intent = new Intent("android.app.action.SHOW_DEVICE_MONITORING_DIALOG");
        intent.setPackage(packageManagerInternal.getSystemUiServiceComponent().getPackageName());
        this.mNetworkLoggingNotificationUserId = getCurrentForegroundUserId();
        PendingIntent broadcastAsUser = PendingIntent.getBroadcastAsUser(this.mContext, 0, intent, 67108864, UserHandle.CURRENT);
        String networkLoggingTitle = getNetworkLoggingTitle();
        String networkLoggingText = getNetworkLoggingText();
        Notification build = new Notification.Builder(this.mContext, SystemNotificationChannels.DEVICE_ADMIN).setSmallIcon(R.drawable.ic_media_route_connected_dark_03_mtrl).setContentTitle(networkLoggingTitle).setContentText(networkLoggingText).setTicker(networkLoggingTitle).setShowWhen(true).setContentIntent(broadcastAsUser).setStyle(new Notification.BigTextStyle().bigText(networkLoggingText)).build();
        Slogf.i("DevicePolicyManager", "Sending network logging notification to user %d", Integer.valueOf(this.mNetworkLoggingNotificationUserId));
        this.mInjector.getNotificationManager().notifyAsUser(null, 1002, build, UserHandle.of(this.mNetworkLoggingNotificationUserId));
    }

    public final String getNetworkLoggingTitle() {
        return getUpdatableString("Core.NETWORK_LOGGING_TITLE", R.string.zen_mode_default_events_name, new Object[0]);
    }

    public final String getNetworkLoggingText() {
        return getUpdatableString("Core.NETWORK_LOGGING_MESSAGE", R.string.zen_mode_alarm, new Object[0]);
    }

    /* renamed from: handleCancelNetworkLoggingNotification */
    public final void lambda$setNetworkLoggingActiveInternal$145() {
        int i = this.mNetworkLoggingNotificationUserId;
        if (i == -10000) {
            Slogf.d("DevicePolicyManager", "Not cancelling network logging notification for USER_NULL");
            return;
        }
        Slogf.i("DevicePolicyManager", "Cancelling network logging notification for user %d", Integer.valueOf(i));
        this.mInjector.getNotificationManager().cancelAsUser(null, 1002, UserHandle.of(this.mNetworkLoggingNotificationUserId));
        this.mNetworkLoggingNotificationUserId = -10000;
    }

    public final String getOwnerPackageNameForUserLocked(int i) {
        if (this.mOwners.getDeviceOwnerUserId() == i) {
            return this.mOwners.getDeviceOwnerPackageName();
        }
        return this.mOwners.getProfileOwnerPackage(i);
    }

    public final Intent createCrossUserServiceIntent(Intent intent, String str, int i) {
        ServiceInfo serviceInfo;
        ResolveInfo resolveService = this.mIPackageManager.resolveService(intent, intent.resolveTypeIfNeeded(this.mContext.getContentResolver()), 0L, i);
        if (resolveService == null || (serviceInfo = resolveService.serviceInfo) == null) {
            Slogf.e("DevicePolicyManager", "Fail to look up the service: %s or user %d is not running", intent, Integer.valueOf(i));
            return null;
        }
        if (!str.equals(serviceInfo.packageName)) {
            throw new SecurityException("Only allow to bind service in " + str);
        }
        ServiceInfo serviceInfo2 = resolveService.serviceInfo;
        if (serviceInfo2.exported && !"android.permission.BIND_DEVICE_ADMIN".equals(serviceInfo2.permission)) {
            throw new SecurityException("Service must be protected by BIND_DEVICE_ADMIN permission");
        }
        intent.setComponent(resolveService.serviceInfo.getComponentName());
        return intent;
    }

    public long getLastSecurityLogRetrievalTime() {
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || canManageUsers(callerIdentity));
        return lambda$getUserDataUnchecked$2(0).mLastSecurityLogRetrievalTime;
    }

    public long getLastBugReportRequestTime() {
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || canManageUsers(callerIdentity));
        return lambda$getUserDataUnchecked$2(0).mLastBugReportRequestTime;
    }

    public long getLastNetworkLogRetrievalTime() {
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || (isProfileOwner(callerIdentity) && isManagedProfile(callerIdentity.getUserId())) || canManageUsers(callerIdentity));
        int networkLoggingAffectedUser = getNetworkLoggingAffectedUser();
        if (networkLoggingAffectedUser >= 0) {
            return lambda$getUserDataUnchecked$2(networkLoggingAffectedUser).mLastNetworkLogsRetrievalTime;
        }
        return -1L;
    }

    public boolean setResetPasswordToken(ComponentName componentName, String str, byte[] bArr) {
        CallerIdentity callerIdentity;
        boolean z;
        SDPLog.i("Set reset token for user " + this.mInjector.userHandleGetCallingUserId());
        SDPLog.p("admin", componentName, KnoxCustomManagerService.SPCM_KEY_TOKEN, bArr);
        if (!this.mHasFeature || !this.mLockPatternUtils.hasSecureLockScreen()) {
            return false;
        }
        if (bArr == null || bArr.length < 32) {
            throw new IllegalArgumentException("token must be at least 32-byte long");
        }
        if (isUnicornFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        int userId = callerIdentity.getUserId();
        if (isUnicornFlagEnabled()) {
            EnforcingAdmin enforcePermissionAndGetEnforcingAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_RESET_PASSWORD", callerIdentity.getPackageName(), userId);
            Long l = (Long) this.mDevicePolicyEngine.getLocalPolicySetByAdmin(PolicyDefinition.RESET_PASSWORD_TOKEN, enforcePermissionAndGetEnforcingAdmin, userId);
            long addEscrowToken = addEscrowToken(bArr, l == null ? 0L : l.longValue(), userId);
            if (addEscrowToken == 0) {
                return false;
            }
            this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.RESET_PASSWORD_TOKEN, enforcePermissionAndGetEnforcingAdmin, new LongPolicyValue(addEscrowToken), userId);
            return true;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        synchronized (getLockObject()) {
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(userId);
            lambda$getUserDataUnchecked$2.mPasswordTokenHandle = addEscrowToken(bArr, lambda$getUserDataUnchecked$2.mPasswordTokenHandle, userId);
            saveSettingsLocked(userId);
            z = lambda$getUserDataUnchecked$2.mPasswordTokenHandle != 0;
        }
        return z;
    }

    public final long addEscrowToken(final byte[] bArr, long j, final int i) {
        resetEscrowToken(j, i);
        return ((Long) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda29
            public final Object getOrThrow() {
                Long lambda$addEscrowToken$150;
                lambda$addEscrowToken$150 = DevicePolicyManagerService.this.lambda$addEscrowToken$150(bArr, i);
                return lambda$addEscrowToken$150;
            }
        })).longValue();
    }

    public /* synthetic */ Long lambda$addEscrowToken$150(byte[] bArr, int i) {
        return Long.valueOf(this.mLockPatternUtils.addEscrowToken(bArr, i, (LockPatternUtils.EscrowTokenStateChangeCallback) null));
    }

    public final boolean resetEscrowToken(final long j, final int i) {
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda56
            public final Object getOrThrow() {
                Boolean lambda$resetEscrowToken$151;
                lambda$resetEscrowToken$151 = DevicePolicyManagerService.this.lambda$resetEscrowToken$151(j, i);
                return lambda$resetEscrowToken$151;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$resetEscrowToken$151(long j, int i) {
        if (j != 0) {
            return Boolean.valueOf(this.mLockPatternUtils.removeEscrowToken(j, i));
        }
        return Boolean.FALSE;
    }

    public boolean clearResetPasswordToken(ComponentName componentName, String str) {
        CallerIdentity callerIdentity;
        boolean z = false;
        if (!this.mHasFeature || !this.mLockPatternUtils.hasSecureLockScreen()) {
            return false;
        }
        if (isUnicornFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        int userId = callerIdentity.getUserId();
        if (isUnicornFlagEnabled()) {
            EnforcingAdmin enforcePermissionAndGetEnforcingAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_RESET_PASSWORD", callerIdentity.getPackageName(), userId);
            Long l = (Long) this.mDevicePolicyEngine.getLocalPolicySetByAdmin(PolicyDefinition.RESET_PASSWORD_TOKEN, enforcePermissionAndGetEnforcingAdmin, userId);
            if (l == null) {
                return false;
            }
            boolean resetEscrowToken = resetEscrowToken(l.longValue(), userId);
            this.mDevicePolicyEngine.removeLocalPolicy(PolicyDefinition.RESET_PASSWORD_TOKEN, enforcePermissionAndGetEnforcingAdmin, userId);
            return resetEscrowToken;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        synchronized (getLockObject()) {
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(userId);
            long j = lambda$getUserDataUnchecked$2.mPasswordTokenHandle;
            if (j != 0) {
                z = resetEscrowToken(j, userId);
                lambda$getUserDataUnchecked$2.mPasswordTokenHandle = 0L;
                saveSettingsLocked(userId);
            }
        }
        return z;
    }

    public boolean isResetPasswordTokenActive(ComponentName componentName, String str) {
        CallerIdentity callerIdentity;
        boolean isResetPasswordTokenActiveForUserLocked;
        if (!this.mHasFeature || !this.mLockPatternUtils.hasSecureLockScreen()) {
            return false;
        }
        if (isUnicornFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        int userId = callerIdentity.getUserId();
        if (isUnicornFlagEnabled()) {
            Long l = (Long) this.mDevicePolicyEngine.getLocalPolicySetByAdmin(PolicyDefinition.RESET_PASSWORD_TOKEN, enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_RESET_PASSWORD", callerIdentity.getPackageName(), userId), userId);
            return isResetPasswordTokenActiveForUserLocked(l == null ? 0L : l.longValue(), userId);
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        synchronized (getLockObject()) {
            isResetPasswordTokenActiveForUserLocked = isResetPasswordTokenActiveForUserLocked(lambda$getUserDataUnchecked$2(userId).mPasswordTokenHandle, userId);
        }
        return isResetPasswordTokenActiveForUserLocked;
    }

    public final boolean isResetPasswordTokenActiveForUserLocked(final long j, final int i) {
        if (j != 0) {
            return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda130
                public final Object getOrThrow() {
                    Boolean lambda$isResetPasswordTokenActiveForUserLocked$152;
                    lambda$isResetPasswordTokenActiveForUserLocked$152 = DevicePolicyManagerService.this.lambda$isResetPasswordTokenActiveForUserLocked$152(j, i);
                    return lambda$isResetPasswordTokenActiveForUserLocked$152;
                }
            })).booleanValue();
        }
        return false;
    }

    public /* synthetic */ Boolean lambda$isResetPasswordTokenActiveForUserLocked$152(long j, int i) {
        return Boolean.valueOf(this.mLockPatternUtils.isEscrowTokenActive(j, i));
    }

    public boolean resetPasswordWithToken(ComponentName componentName, String str, String str2, byte[] bArr, int i) {
        CallerIdentity callerIdentity;
        boolean z = false;
        if (!this.mHasFeature || !this.mLockPatternUtils.hasSecureLockScreen()) {
            return false;
        }
        Objects.requireNonNull(bArr);
        if (isUnicornFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        CallerIdentity callerIdentity2 = callerIdentity;
        SDPLog.i("Reset password with token for user " + this.mInjector.userHandleGetCallingUserId());
        SDPLog.p("admin", componentName, "passwordOrNull", str2, KnoxCustomManagerService.SPCM_KEY_TOKEN, bArr, "flags", Integer.valueOf(i));
        int userId = callerIdentity2.getUserId();
        String str3 = str2 != null ? str2 : "";
        if (isUnicornFlagEnabled()) {
            Long l = (Long) this.mDevicePolicyEngine.getLocalPolicySetByAdmin(PolicyDefinition.RESET_PASSWORD_TOKEN, enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_RESET_PASSWORD", callerIdentity2.getPackageName(), userId), userId);
            if (l != null && l.longValue() != 0) {
                z = resetPasswordInternal(str3, l.longValue(), bArr, i, callerIdentity2);
            } else {
                Slogf.w("DevicePolicyManager", "No saved token handle");
            }
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity2) || isDefaultDeviceOwner(callerIdentity2));
            synchronized (getLockObject()) {
                long j = lambda$getUserDataUnchecked$2(userId).mPasswordTokenHandle;
                if (j != 0) {
                    z = resetPasswordInternal(str3, j, bArr, i, callerIdentity2);
                } else {
                    Slogf.w("DevicePolicyManager", "No saved token handle");
                }
            }
        }
        if (z) {
            if (isUnicornFlagEnabled()) {
                DevicePolicyEventLogger.createEvent(206).setAdmin(str).write();
            } else {
                DevicePolicyEventLogger.createEvent(206).setAdmin(callerIdentity2.getComponentName()).write();
            }
        }
        return z;
    }

    public boolean isCurrentInputMethodSetByOwner() {
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity) || isSystemUid(callerIdentity), "Only profile owner, device owner and system may call this method.");
        return lambda$getUserDataUnchecked$2(callerIdentity.getUserId()).mCurrentInputMethodSet;
    }

    public StringParceledListSlice getOwnerInstalledCaCerts(UserHandle userHandle) {
        StringParceledListSlice stringParceledListSlice;
        int identifier = userHandle.getIdentifier();
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization((isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity) || canQueryAdminPolicy(callerIdentity)) && hasFullCrossUsersPermission(callerIdentity, identifier));
        synchronized (getLockObject()) {
            stringParceledListSlice = new StringParceledListSlice(new ArrayList(lambda$getUserDataUnchecked$2(identifier).mOwnerInstalledCaCerts));
        }
        return stringParceledListSlice;
    }

    public void clearApplicationUserData(ComponentName componentName, String str, IPackageDataObserver iPackageDataObserver) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        Objects.requireNonNull(str, "packageName is null");
        Objects.requireNonNull(iPackageDataObserver, "callback is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
        checkCanExecuteOrThrowUnsafe(23);
        if (!(this.mInjector.settingsGlobalGetInt("device_provisioned", 0) != 0) && FRP_PROTECTED_PACKAGES.contains(str)) {
            Log.i("DevicePolicyManager", "clearApplicationUserData blocked : SVE-2022-1517");
            return;
        }
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            try {
                try {
                    ActivityManager.getService().clearApplicationUserData(str, false, iPackageDataObserver, callerIdentity.getUserId());
                } catch (SecurityException e) {
                    Slogf.w("DevicePolicyManager", "Not allowed to clear application user data for package " + str, e);
                    iPackageDataObserver.onRemoveCompleted(str, false);
                }
            } catch (RemoteException unused) {
            }
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public void setLogoutEnabled(ComponentName componentName, boolean z) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity));
            checkCanExecuteOrThrowUnsafe(34);
            synchronized (getLockObject()) {
                ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
                if (deviceOwnerAdminLocked.isLogoutEnabled == z) {
                    return;
                }
                deviceOwnerAdminLocked.isLogoutEnabled = z;
                saveSettingsLocked(callerIdentity.getUserId());
            }
        }
    }

    public boolean isLogoutEnabled() {
        boolean z = false;
        if (!this.mHasFeature) {
            return false;
        }
        synchronized (getLockObject()) {
            ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
            if (deviceOwnerAdminLocked != null && deviceOwnerAdminLocked.isLogoutEnabled) {
                z = true;
            }
        }
        return z;
    }

    public List getDisallowedSystemApps(ComponentName componentName, int i, String str) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        return new ArrayList(this.mOverlayPackagesProvider.getNonRequiredApps(componentName, i, str));
    }

    public void transferOwnership(ComponentName componentName, ComponentName componentName2, PersistableBundle persistableBundle) {
        String str;
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Objects.requireNonNull(componentName2, "Target cannot be null.");
            Preconditions.checkArgument(!componentName.equals(componentName2), "Provided administrator and target are the same object.");
            Preconditions.checkArgument(!componentName.getPackageName().equals(componentName2.getPackageName()), "Provided administrator and target have the same package name.");
            if (persistableBundle != null) {
                enforceMaxStringLength(persistableBundle, "bundle");
            }
            IEnterpriseDeviceManager iEDMService = this.mInjector.getIEDMService();
            if (iEDMService != null) {
                try {
                    if (!iEDMService.isPossibleTransferOwenerShip(componentName)) {
                        throw new IllegalArgumentException("Provided administrator already have Knox permission");
                    }
                } catch (RemoteException e) {
                    Slogf.w("DevicePolicyManager", "RemoteException", e);
                    e.printStackTrace();
                }
            }
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity));
            int userId = callerIdentity.getUserId();
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(userId);
            DeviceAdminInfo findAdmin = findAdmin(componentName2, userId, true);
            checkActiveAdminPrecondition(componentName2, findAdmin, lambda$getUserDataUnchecked$2);
            Preconditions.checkArgument(findAdmin.supportsTransferOwnership(), "Provided target does not support ownership transfer.");
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                synchronized (getLockObject()) {
                    if (persistableBundle == null) {
                        persistableBundle = new PersistableBundle();
                    }
                    if (isProfileOwner(callerIdentity)) {
                        str = "profile-owner";
                        prepareTransfer(componentName, componentName2, persistableBundle, userId, "profile-owner");
                        transferProfileOwnershipLocked(componentName, componentName2, userId);
                        sendProfileOwnerCommand("android.app.action.TRANSFER_OWNERSHIP_COMPLETE", getTransferOwnershipAdminExtras(persistableBundle), userId);
                        postTransfer("android.app.action.PROFILE_OWNER_CHANGED", userId);
                        if (isUserAffiliatedWithDeviceLocked(userId)) {
                            notifyAffiliatedProfileTransferOwnershipComplete(userId);
                        }
                    } else if (isDefaultDeviceOwner(callerIdentity)) {
                        str = "device-owner";
                        prepareTransfer(componentName, componentName2, persistableBundle, userId, "device-owner");
                        transferDeviceOwnershipLocked(componentName, componentName2, userId);
                        sendDeviceOwnerCommand("android.app.action.TRANSFER_OWNERSHIP_COMPLETE", getTransferOwnershipAdminExtras(persistableBundle));
                        postTransfer(DevicePolicyListener.ACTION_DEVICE_OWNER_CHANGED, userId);
                    } else {
                        str = null;
                    }
                }
                if (iEDMService != null) {
                    try {
                        iEDMService.transferOwnerShip(componentName, componentName2, userId);
                    } catch (RemoteException e2) {
                        Slogf.w("DevicePolicyManager", "RemoteException", e2);
                    }
                }
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                DevicePolicyEventLogger.createEvent(58).setAdmin(componentName).setStrings(new String[]{componentName2.getPackageName(), str}).write();
            } catch (Throwable th) {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                throw th;
            }
        }
    }

    public final void prepareTransfer(ComponentName componentName, ComponentName componentName2, PersistableBundle persistableBundle, int i, String str) {
        saveTransferOwnershipBundleLocked(persistableBundle, i);
        this.mTransferOwnershipMetadataManager.saveMetadataFile(new TransferOwnershipMetadataManager.Metadata(componentName, componentName2, i, str));
    }

    public final void postTransfer(String str, int i) {
        deleteTransferOwnershipMetadataFileLocked();
        sendOwnerChangedBroadcast(str, i);
    }

    public final void notifyAffiliatedProfileTransferOwnershipComplete(int i) {
        Bundle bundle = new Bundle();
        bundle.putParcelable("android.intent.extra.USER", UserHandle.of(i));
        sendDeviceOwnerCommand("android.app.action.AFFILIATED_PROFILE_TRANSFER_OWNERSHIP_COMPLETE", bundle);
    }

    public final void transferProfileOwnershipLocked(ComponentName componentName, ComponentName componentName2, int i) {
        transferActiveAdminUncheckedLocked(componentName2, componentName, i);
        this.mOwners.transferProfileOwner(componentName2, i);
        Slogf.i("DevicePolicyManager", "Profile owner set: " + componentName2 + " on user " + i);
        this.mOwners.writeProfileOwner(i);
        this.mDeviceAdminServiceController.startServiceForAdmin(componentName2.getPackageName(), i, "transfer-profile-owner");
    }

    public final void transferDeviceOwnershipLocked(ComponentName componentName, ComponentName componentName2, int i) {
        transferActiveAdminUncheckedLocked(componentName2, componentName, i);
        this.mOwners.transferDeviceOwnership(componentName2);
        Slogf.i("DevicePolicyManager", "Device owner set: " + componentName2 + " on user " + i);
        this.mOwners.writeDeviceOwner();
        this.mDeviceAdminServiceController.startServiceForAdmin(componentName2.getPackageName(), i, "transfer-device-owner");
    }

    public final Bundle getTransferOwnershipAdminExtras(PersistableBundle persistableBundle) {
        Bundle bundle = new Bundle();
        if (persistableBundle != null) {
            bundle.putParcelable("android.app.extra.TRANSFER_OWNERSHIP_ADMIN_EXTRAS_BUNDLE", persistableBundle);
        }
        return bundle;
    }

    public void setStartUserSessionMessage(ComponentName componentName, CharSequence charSequence) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity));
            String charSequence2 = charSequence != null ? charSequence.toString() : null;
            synchronized (getLockObject()) {
                ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
                if (TextUtils.equals(deviceOwnerAdminLocked.startUserSessionMessage, charSequence)) {
                    return;
                }
                deviceOwnerAdminLocked.startUserSessionMessage = charSequence2;
                saveSettingsLocked(callerIdentity.getUserId());
                this.mInjector.getActivityManagerInternal().setSwitchingFromSystemUserMessage(charSequence2);
            }
        }
    }

    public void setEndUserSessionMessage(ComponentName componentName, CharSequence charSequence) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity));
            String charSequence2 = charSequence != null ? charSequence.toString() : null;
            synchronized (getLockObject()) {
                ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
                if (TextUtils.equals(deviceOwnerAdminLocked.endUserSessionMessage, charSequence)) {
                    return;
                }
                deviceOwnerAdminLocked.endUserSessionMessage = charSequence2;
                saveSettingsLocked(callerIdentity.getUserId());
                this.mInjector.getActivityManagerInternal().setSwitchingToSystemUserMessage(charSequence2);
            }
        }
    }

    public String getStartUserSessionMessage(ComponentName componentName) {
        String str;
        if (!this.mHasFeature) {
            return null;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(getCallerIdentity(componentName)));
        synchronized (getLockObject()) {
            str = getDeviceOwnerAdminLocked().startUserSessionMessage;
        }
        return str;
    }

    public String getEndUserSessionMessage(ComponentName componentName) {
        String str;
        if (!this.mHasFeature) {
            return null;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(getCallerIdentity(componentName)));
        synchronized (getLockObject()) {
            str = getDeviceOwnerAdminLocked().endUserSessionMessage;
        }
        return str;
    }

    public final void deleteTransferOwnershipMetadataFileLocked() {
        this.mTransferOwnershipMetadataManager.deleteMetadataFile();
    }

    public PersistableBundle getTransferOwnershipBundle() {
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity) || isDefaultDeviceOwner(callerIdentity));
        synchronized (getLockObject()) {
            File file = new File(this.mPathProvider.getUserSystemDirectory(callerIdentity.getUserId()), "transfer-ownership-parameters.xml");
            if (!file.exists()) {
                return null;
            }
            try {
                FileInputStream fileInputStream = new FileInputStream(file);
                try {
                    TypedXmlPullParser resolvePullParser = Xml.resolvePullParser(fileInputStream);
                    resolvePullParser.next();
                    PersistableBundle restoreFromXml = PersistableBundle.restoreFromXml(resolvePullParser);
                    fileInputStream.close();
                    return restoreFromXml;
                } catch (Throwable th) {
                    try {
                        fileInputStream.close();
                    } catch (Throwable th2) {
                        th.addSuppressed(th2);
                    }
                    throw th;
                }
            } catch (IOException | IllegalArgumentException | XmlPullParserException e) {
                Slogf.e("DevicePolicyManager", "Caught exception while trying to load the owner transfer parameters from file " + file, e);
                return null;
            }
        }
    }

    public int addOverrideApn(ComponentName componentName, final ApnSetting apnSetting) {
        if (this.mHasFeature && (this.mHasTelephonyFeature || this.mHasTelephonyDataFeature)) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Objects.requireNonNull(apnSetting, "ApnSetting is null in addOverrideApn");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            if (apnSetting.getApnTypeBitmask() == 16384) {
                Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isManagedProfileOwner(callerIdentity));
            } else {
                Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity));
            }
            final TelephonyManager telephonyManager = (TelephonyManager) this.mContext.getSystemService(TelephonyManager.class);
            if (telephonyManager != null) {
                return ((Integer) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda76
                    public final Object getOrThrow() {
                        Integer lambda$addOverrideApn$153;
                        lambda$addOverrideApn$153 = DevicePolicyManagerService.this.lambda$addOverrideApn$153(telephonyManager, apnSetting);
                        return lambda$addOverrideApn$153;
                    }
                })).intValue();
            }
            Slogf.w("DevicePolicyManager", "TelephonyManager is null when trying to add override apn");
        }
        return -1;
    }

    public /* synthetic */ Integer lambda$addOverrideApn$153(TelephonyManager telephonyManager, ApnSetting apnSetting) {
        return Integer.valueOf(telephonyManager.addDevicePolicyOverrideApn(this.mContext, apnSetting));
    }

    public boolean updateOverrideApn(ComponentName componentName, final int i, final ApnSetting apnSetting) {
        if (this.mHasFeature && (this.mHasTelephonyFeature || this.mHasTelephonyDataFeature)) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Objects.requireNonNull(apnSetting, "ApnSetting is null in updateOverrideApn");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            ApnSetting apnSetting2 = getApnSetting(i);
            if (apnSetting2 != null && apnSetting2.getApnTypeBitmask() == 16384 && apnSetting.getApnTypeBitmask() == 16384) {
                Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isManagedProfileOwner(callerIdentity));
            } else {
                Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity));
            }
            if (i < 0) {
                return false;
            }
            final TelephonyManager telephonyManager = (TelephonyManager) this.mContext.getSystemService(TelephonyManager.class);
            if (telephonyManager != null) {
                return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda90
                    public final Object getOrThrow() {
                        Boolean lambda$updateOverrideApn$154;
                        lambda$updateOverrideApn$154 = DevicePolicyManagerService.this.lambda$updateOverrideApn$154(telephonyManager, i, apnSetting);
                        return lambda$updateOverrideApn$154;
                    }
                })).booleanValue();
            }
            Slogf.w("DevicePolicyManager", "TelephonyManager is null when trying to modify override apn");
        }
        return false;
    }

    public /* synthetic */ Boolean lambda$updateOverrideApn$154(TelephonyManager telephonyManager, int i, ApnSetting apnSetting) {
        return Boolean.valueOf(telephonyManager.modifyDevicePolicyOverrideApn(this.mContext, i, apnSetting));
    }

    public boolean removeOverrideApn(ComponentName componentName, int i) {
        if (!this.mHasFeature || (!this.mHasTelephonyFeature && !this.mHasTelephonyDataFeature)) {
            return false;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        ApnSetting apnSetting = getApnSetting(i);
        if (apnSetting != null && apnSetting.getApnTypeBitmask() == 16384) {
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isManagedProfileOwner(callerIdentity));
        } else {
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity));
        }
        return removeOverrideApnUnchecked(i);
    }

    public final boolean removeOverrideApnUnchecked(final int i) {
        return i >= 0 && ((Integer) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda105
            public final Object getOrThrow() {
                Integer lambda$removeOverrideApnUnchecked$155;
                lambda$removeOverrideApnUnchecked$155 = DevicePolicyManagerService.this.lambda$removeOverrideApnUnchecked$155(i);
                return lambda$removeOverrideApnUnchecked$155;
            }
        })).intValue() > 0;
    }

    public /* synthetic */ Integer lambda$removeOverrideApnUnchecked$155(int i) {
        return Integer.valueOf(this.mContext.getContentResolver().delete(Uri.withAppendedPath(Telephony.Carriers.DPC_URI, Integer.toString(i)), null, null));
    }

    /* JADX WARN: Code restructure failed: missing block: B:10:0x001d, code lost:
    
        if (r0 == null) goto L31;
     */
    /* JADX WARN: Code restructure failed: missing block: B:12:0x001f, code lost:
    
        r3.close();
     */
    /* JADX WARN: Code restructure failed: missing block: B:15:0x0022, code lost:
    
        return r0;
     */
    /* JADX WARN: Code restructure failed: missing block: B:6:0x0011, code lost:
    
        if (r3 != null) goto L23;
     */
    /* JADX WARN: Code restructure failed: missing block: B:8:0x0017, code lost:
    
        if (r3.moveToNext() == false) goto L29;
     */
    /* JADX WARN: Code restructure failed: missing block: B:9:0x0019, code lost:
    
        r0 = android.telephony.data.ApnSetting.makeApnSetting(r3);
     */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public final android.telephony.data.ApnSetting getApnSetting(final int r4) {
        /*
            r3 = this;
            r0 = 0
            if (r4 >= 0) goto L4
            return r0
        L4:
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r1 = r3.mInjector
            com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda25 r2 = new com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda25
            r2.<init>()
            java.lang.Object r3 = r1.binderWithCleanCallingIdentity(r2)
            android.database.Cursor r3 = (android.database.Cursor) r3
            if (r3 == 0) goto L22
        L13:
            boolean r4 = r3.moveToNext()
            if (r4 == 0) goto L1f
            android.telephony.data.ApnSetting r0 = android.telephony.data.ApnSetting.makeApnSetting(r3)
            if (r0 == 0) goto L13
        L1f:
            r3.close()
        L22:
            return r0
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.getApnSetting(int):android.telephony.data.ApnSetting");
    }

    public /* synthetic */ Cursor lambda$getApnSetting$156(int i) {
        return this.mContext.getContentResolver().query(Uri.withAppendedPath(Telephony.Carriers.DPC_URI, Integer.toString(i)), null, null, null, "name ASC");
    }

    public List getOverrideApns(ComponentName componentName) {
        if (!this.mHasFeature || (!this.mHasTelephonyFeature && !this.mHasTelephonyDataFeature)) {
            return Collections.emptyList();
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isManagedProfileOwner(callerIdentity));
        List<ApnSetting> overrideApnsUnchecked = getOverrideApnsUnchecked();
        if (!isProfileOwner(callerIdentity)) {
            return overrideApnsUnchecked;
        }
        ArrayList arrayList = new ArrayList();
        for (ApnSetting apnSetting : overrideApnsUnchecked) {
            if (apnSetting.getApnTypeBitmask() == 16384) {
                arrayList.add(apnSetting);
            }
        }
        return arrayList;
    }

    public final List getOverrideApnsUnchecked() {
        final TelephonyManager telephonyManager = (TelephonyManager) this.mContext.getSystemService(TelephonyManager.class);
        if (telephonyManager != null) {
            return (List) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda157
                public final Object getOrThrow() {
                    List lambda$getOverrideApnsUnchecked$157;
                    lambda$getOverrideApnsUnchecked$157 = DevicePolicyManagerService.this.lambda$getOverrideApnsUnchecked$157(telephonyManager);
                    return lambda$getOverrideApnsUnchecked$157;
                }
            });
        }
        Slogf.w("DevicePolicyManager", "TelephonyManager is null when trying to get override apns");
        return Collections.emptyList();
    }

    public /* synthetic */ List lambda$getOverrideApnsUnchecked$157(TelephonyManager telephonyManager) {
        return telephonyManager.getDevicePolicyOverrideApns(this.mContext);
    }

    public void setOverrideApnsEnabled(ComponentName componentName, boolean z) {
        if (this.mHasFeature) {
            if (this.mHasTelephonyFeature || this.mHasTelephonyDataFeature) {
                Objects.requireNonNull(componentName, "ComponentName is null");
                Preconditions.checkCallAuthorization(isDefaultDeviceOwner(getCallerIdentity(componentName)));
                checkCanExecuteOrThrowUnsafe(36);
                setOverrideApnsEnabledUnchecked(z);
            }
        }
    }

    public final void setOverrideApnsEnabledUnchecked(boolean z) {
        final ContentValues contentValues = new ContentValues();
        contentValues.put("enforced", Boolean.valueOf(z));
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda14
            public final Object getOrThrow() {
                Integer lambda$setOverrideApnsEnabledUnchecked$158;
                lambda$setOverrideApnsEnabledUnchecked$158 = DevicePolicyManagerService.this.lambda$setOverrideApnsEnabledUnchecked$158(contentValues);
                return lambda$setOverrideApnsEnabledUnchecked$158;
            }
        });
    }

    public /* synthetic */ Integer lambda$setOverrideApnsEnabledUnchecked$158(ContentValues contentValues) {
        return Integer.valueOf(this.mContext.getContentResolver().update(Telephony.Carriers.ENFORCE_MANAGED_URI, contentValues, null, null));
    }

    public boolean isOverrideApnEnabled(ComponentName componentName) {
        if (!this.mHasFeature || (!this.mHasTelephonyFeature && !this.mHasTelephonyDataFeature)) {
            return false;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(getCallerIdentity(componentName)));
        Cursor cursor = (Cursor) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda127
            public final Object getOrThrow() {
                Cursor lambda$isOverrideApnEnabled$159;
                lambda$isOverrideApnEnabled$159 = DevicePolicyManagerService.this.lambda$isOverrideApnEnabled$159();
                return lambda$isOverrideApnEnabled$159;
            }
        });
        if (cursor == null) {
            return false;
        }
        try {
            try {
                if (cursor.moveToFirst()) {
                    return cursor.getInt(cursor.getColumnIndex("enforced")) == 1;
                }
            } catch (IllegalArgumentException e) {
                Slogf.e("DevicePolicyManager", "Cursor returned from ENFORCE_MANAGED_URI doesn't contain correct info.", e);
            }
            return false;
        } finally {
            cursor.close();
        }
    }

    public /* synthetic */ Cursor lambda$isOverrideApnEnabled$159() {
        return this.mContext.getContentResolver().query(Telephony.Carriers.ENFORCE_MANAGED_URI, null, null, null, null);
    }

    public void saveTransferOwnershipBundleLocked(PersistableBundle persistableBundle, int i) {
        FileOutputStream startWrite;
        File file = new File(this.mPathProvider.getUserSystemDirectory(i), "transfer-ownership-parameters.xml");
        AtomicFile atomicFile = new AtomicFile(file);
        FileOutputStream fileOutputStream = null;
        try {
            startWrite = atomicFile.startWrite();
        } catch (IOException | XmlPullParserException e) {
            e = e;
        }
        try {
            TypedXmlSerializer resolveSerializer = Xml.resolveSerializer(startWrite);
            resolveSerializer.startDocument((String) null, Boolean.TRUE);
            resolveSerializer.startTag((String) null, "transfer-ownership-bundle");
            persistableBundle.saveToXml(resolveSerializer);
            resolveSerializer.endTag((String) null, "transfer-ownership-bundle");
            resolveSerializer.endDocument();
            atomicFile.finishWrite(startWrite);
        } catch (IOException | XmlPullParserException e2) {
            e = e2;
            fileOutputStream = startWrite;
            Slogf.e("DevicePolicyManager", "Caught exception while trying to save the owner transfer parameters to file " + file, e);
            file.delete();
            atomicFile.failWrite(fileOutputStream);
        }
    }

    public void deleteTransferOwnershipBundleLocked(int i) {
        new File(this.mPathProvider.getUserSystemDirectory(i), "transfer-ownership-parameters.xml").delete();
    }

    public final void logPasswordQualitySetIfSecurityLogEnabled(ComponentName componentName, int i, boolean z, PasswordPolicy passwordPolicy) {
        if (SecurityLog.isLoggingEnabled()) {
            SecurityLog.writeEvent(210017, new Object[]{componentName.getPackageName(), Integer.valueOf(i), Integer.valueOf(z ? getProfileParentId(i) : i), Integer.valueOf(passwordPolicy.length), Integer.valueOf(passwordPolicy.quality), Integer.valueOf(passwordPolicy.letters), Integer.valueOf(passwordPolicy.nonLetter), Integer.valueOf(passwordPolicy.numeric), Integer.valueOf(passwordPolicy.upperCase), Integer.valueOf(passwordPolicy.lowerCase), Integer.valueOf(passwordPolicy.symbols)});
        }
    }

    public static String getManagedProvisioningPackage(Context context) {
        return context.getResources().getString(R.string.floating_toolbar_open_overflow_description);
    }

    public ComponentName getComponentNameByPackageName(String str, int i) {
        List<ComponentName> activeAdmins = getActiveAdmins(i);
        if (activeAdmins == null || str == null) {
            return null;
        }
        for (ComponentName componentName : activeAdmins) {
            if (str.equals(componentName.getPackageName())) {
                return componentName;
            }
        }
        return null;
    }

    public final boolean isCalledFromMDMAdmin(int i) {
        boolean z = false;
        try {
            this.mInjector.getEDM().enforceActiveAdminPermissionByContext(new ContextInfo(this.mInjector.binderGetCallingUid(), i), new ArrayList(Arrays.asList("com.samsung.android.knox.permission.KNOX_SECURITY")));
            z = true;
        } catch (SecurityException unused) {
            Log.i("DevicePolicyManager", "isCalledFromMDMAdmin() : Not a MDM client");
        } catch (Exception e) {
            Log.i("DevicePolicyManager", "isCalledFromMDMAdmin() : failed to check mdm admin", e);
        }
        if (z) {
            Log.i("DevicePolicyManager", "isCalledFromMDMAdmin() : called");
        }
        return z;
    }

    public String getActualDeviceOwnerMDM() {
        if (!this.mHasFeature) {
            return null;
        }
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        synchronized (getLockObject()) {
            Owners owners = this.mOwners;
            if (owners == null || !owners.hasDeviceOwner()) {
                return null;
            }
            return this.mOwners.getDeviceOwnerPackageName();
        }
    }

    public boolean rebootMDM(String str) {
        try {
            this.mContext.enforceCallingOrSelfPermission("com.samsung.android.knox.permission.KNOX_SECURITY", null);
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                try {
                    this.mInjector.powerManagerReboot(str);
                    this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                    return true;
                } catch (Exception e) {
                    Log.e("DevicePolicyManager", "Exception", e);
                    this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                    return false;
                }
            } catch (Throwable th) {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                throw th;
            }
        } catch (SecurityException unused) {
            throw new SecurityException("uid " + this.mInjector.binderGetCallingUid() + " does not have com.samsung.android.knox.permission.KNOX_SECURITY permission.");
        }
    }

    public void setPasswordQualityMDM(ComponentName componentName, int i, int i2) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            validateQualityConstant(i);
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i2);
                PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
                if (passwordPolicy.quality != i) {
                    passwordPolicy.quality = i;
                    resetInactivePasswordRequirementsIfRPlus(i2, activeAdminForCallerLockedMDM);
                    updatePasswordValidityCheckpointLocked(i2, false);
                    updatePasswordQualityCacheForUserGroup(i2);
                    saveSettingsLocked(i2);
                    makeAuditLogGroupSecurity(String.format("Admin %s has changed password quality to %d", componentName.getPackageName(), Integer.valueOf(i)), i2);
                }
                logPasswordQualitySetIfSecurityLogEnabled(componentName, i2, false, passwordPolicy);
            }
        }
    }

    public void setPasswordMinimumLengthMDM(ComponentName componentName, int i, int i2) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i2);
                ensureMinimumQuality(i2, activeAdminForCallerLockedMDM, IInstalld.FLAG_CLEAR_APP_DATA_KEEP_ART_PROFILES, "setPasswordMinimumLength");
                PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
                if (passwordPolicy.length != i) {
                    passwordPolicy.length = i;
                    updatePasswordValidityCheckpointLocked(i2, false);
                    saveSettingsLocked(i2);
                    makeAuditLogGroupSecurity(String.format("Admin %s has changed password minimum length to %d", componentName.getPackageName(), Integer.valueOf(i)), i2);
                }
                logPasswordQualitySetIfSecurityLogEnabled(componentName, i2, false, passwordPolicy);
            }
        }
    }

    public void setPasswordMinimumUpperCaseMDM(ComponentName componentName, int i, int i2) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i2);
                ensureMinimumQuality(i2, activeAdminForCallerLockedMDM, 393216, "setPasswordMinimumUpperCase");
                PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
                if (passwordPolicy.upperCase != i) {
                    passwordPolicy.upperCase = i;
                    updatePasswordValidityCheckpointLocked(i2, false);
                    saveSettingsLocked(i2);
                    makeAuditLogGroupSecurity(String.format("Admin %s has changed password minimum upper case to %d", componentName.getPackageName(), Integer.valueOf(i)), i2);
                }
                logPasswordQualitySetIfSecurityLogEnabled(componentName, i2, false, passwordPolicy);
            }
        }
    }

    public void setPasswordMinimumLowerCaseMDM(ComponentName componentName, int i, int i2) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i2);
            ensureMinimumQuality(i2, activeAdminForCallerLockedMDM, 393216, "setPasswordMinimumLowerCase");
            PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
            if (passwordPolicy.lowerCase != i) {
                passwordPolicy.lowerCase = i;
                updatePasswordValidityCheckpointLocked(i2, false);
                saveSettingsLocked(i2);
                makeAuditLogGroupSecurity(String.format("Admin %s has changed password minimum lower case to %d", componentName.getPackageName(), Integer.valueOf(i)), i2);
            }
            logPasswordQualitySetIfSecurityLogEnabled(componentName, i2, false, passwordPolicy);
        }
    }

    public void setPasswordMinimumLettersMDM(ComponentName componentName, int i, int i2) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i2);
                ensureMinimumQuality(i2, activeAdminForCallerLockedMDM, 393216, "setPasswordMinimumLetters");
                PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
                if (passwordPolicy.letters != i) {
                    passwordPolicy.letters = i;
                    updatePasswordValidityCheckpointLocked(i2, false);
                    saveSettingsLocked(i2);
                    makeAuditLogGroupSecurity(String.format("Admin %s has changed password minimum letters to %d", componentName.getPackageName(), Integer.valueOf(i)), i2);
                }
                logPasswordQualitySetIfSecurityLogEnabled(componentName, i2, false, passwordPolicy);
            }
        }
    }

    public void setPasswordMinimumNumericMDM(ComponentName componentName, int i, int i2) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i2);
                ensureMinimumQuality(i2, activeAdminForCallerLockedMDM, 393216, "setPasswordMinimumNumeric");
                PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
                if (passwordPolicy.numeric != i) {
                    passwordPolicy.numeric = i;
                    updatePasswordValidityCheckpointLocked(i2, false);
                    saveSettingsLocked(i2);
                    makeAuditLogGroupSecurity(String.format("Admin %s has changed password minimum numeric to %d", componentName.getPackageName(), Integer.valueOf(i)), i2);
                }
                logPasswordQualitySetIfSecurityLogEnabled(componentName, i2, false, passwordPolicy);
            }
        }
    }

    public void setPasswordMinimumSymbolsMDM(ComponentName componentName, int i, int i2) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i2);
                ensureMinimumQuality(i2, activeAdminForCallerLockedMDM, 393216, "setPasswordMinimumSymbols");
                PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
                if (passwordPolicy.symbols != i) {
                    passwordPolicy.symbols = i;
                    updatePasswordValidityCheckpointLocked(i2, false);
                    saveSettingsLocked(i2);
                    makeAuditLogGroupSecurity(String.format("Admin %s has changed password minimum symbols to %d", componentName.getPackageName(), Integer.valueOf(i)), i2);
                }
                logPasswordQualitySetIfSecurityLogEnabled(componentName, i2, false, passwordPolicy);
            }
        }
    }

    public void setPasswordMinimumNonLetterMDM(ComponentName componentName, int i, int i2) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i2);
                ensureMinimumQuality(i2, activeAdminForCallerLockedMDM, 393216, "setPasswordMinimumNonLetter");
                PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
                if (passwordPolicy.nonLetter != i) {
                    passwordPolicy.nonLetter = i;
                    updatePasswordValidityCheckpointLocked(i2, false);
                    saveSettingsLocked(i2);
                    makeAuditLogGroupSecurity(String.format("Admin %s has changed password minimum non-letter to %d", componentName.getPackageName(), Integer.valueOf(i)), i2);
                }
                logPasswordQualitySetIfSecurityLogEnabled(componentName, i2, false, passwordPolicy);
            }
        }
    }

    public void setPasswordHistoryLengthMDM(ComponentName componentName, int i, int i2) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i2);
                if (activeAdminForCallerLockedMDM.passwordHistoryLength != i) {
                    activeAdminForCallerLockedMDM.passwordHistoryLength = i;
                    updatePasswordValidityCheckpointLocked(i2, false);
                    saveSettingsLocked(i2);
                }
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210018, new Object[]{componentName.getPackageName(), Integer.valueOf(i2), Integer.valueOf(i2), Integer.valueOf(i)});
            }
        }
    }

    public void setPasswordExpirationTimeoutMDM(ComponentName componentName, long j, int i) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkArgumentNonnegative(j, "Timeout must be >= 0 ms");
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 6, i);
                long currentTimeMillis = j > 0 ? System.currentTimeMillis() + j : 0L;
                activeAdminForCallerLockedMDM.passwordExpirationDate = currentTimeMillis;
                activeAdminForCallerLockedMDM.passwordExpirationTimeout = j;
                if (j > 0) {
                    Slogf.w("DevicePolicyManager", "setPasswordExpiration(): password will expire on " + DateFormat.getDateTimeInstance(2, 2).format(new Date(currentTimeMillis)));
                }
                saveSettingsLocked(i);
                setExpirationAlarmCheckLocked(this.mContext, i, false);
                makeAuditLogGroupSecurity(String.format("Admin %s has changed password expiration time out to %d", componentName.getPackageName(), Long.valueOf(j)), i);
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210016, new Object[]{componentName.getPackageName(), Integer.valueOf(i), Integer.valueOf(i), Long.valueOf(j)});
            }
        }
    }

    public void setMaximumFailedPasswordsForWipeMDM(ComponentName componentName, int i, int i2) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            synchronized (getLockObject()) {
                getActiveAdminForCallerLockedMDM(componentName, 4, i2);
                ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 1, i2);
                if (activeAdminForCallerLockedMDM.maximumFailedPasswordsForWipe != i) {
                    activeAdminForCallerLockedMDM.maximumFailedPasswordsForWipe = i;
                    saveSettingsLocked(i2);
                    makeAuditLogGroupSecurity(String.format("Admin %s has changed maximum failed passwords for wipe to %d", componentName.getPackageName(), Integer.valueOf(i)), i2);
                }
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210020, new Object[]{componentName.getPackageName(), Integer.valueOf(i2), Integer.valueOf(i2), Integer.valueOf(i)});
            }
        }
    }

    public void setMaximumTimeToLockMDM(ComponentName componentName, long j, int i) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 3, i);
                if (activeAdminForCallerLockedMDM.maximumTimeToUnlock != j) {
                    activeAdminForCallerLockedMDM.maximumTimeToUnlock = j;
                    saveSettingsLocked(i);
                    updateMaximumTimeToLockLocked(i);
                    makeAuditLogGroupSecurity(String.format("Admin %s has changed screen lock time out to %d", componentName.getPackageName(), Long.valueOf(j)), i);
                }
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210019, new Object[]{componentName.getPackageName(), Integer.valueOf(i), Integer.valueOf(i), Long.valueOf(j)});
            }
        }
    }

    public void setKeyguardDisabledFeaturesMDM(ComponentName componentName, int i, int i2) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            synchronized (getLockObject()) {
                ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 9, i2);
                if (activeAdminForCallerLockedMDM.disabledKeyguardFeatures != i) {
                    activeAdminForCallerLockedMDM.disabledKeyguardFeatures = i;
                    saveSettingsLocked(i2);
                }
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210021, new Object[]{componentName.getPackageName(), Integer.valueOf(i2), Integer.valueOf(i2), Integer.valueOf(i)});
            }
        }
    }

    public void setTrustAgentConfigurationMDM(int i, ComponentName componentName, ComponentName componentName2, PersistableBundle persistableBundle) {
        if (this.mInjector.binderGetCallingPid() != Process.myPid()) {
            throw new SecurityException("Not allowed to call setTrustAgentConfigurationMDM!");
        }
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "admin is null");
            Objects.requireNonNull(componentName2, "agent is null");
            synchronized (getLockObject()) {
                getActiveAdminForCallerLockedMDM(componentName, 9, i).trustAgentInfos.put(componentName2.flattenToString(), new ActiveAdmin.TrustAgentInfo(persistableBundle));
                saveSettingsLocked(i);
            }
        }
    }

    public void setApplicationRestrictionsMDM(ComponentName componentName, String str, Bundle bundle, int i) {
        ContextInfo contextInfo = new ContextInfo(this.mInjector.binderGetCallingUid(), i);
        this.mInjector.getEDM().enforceComponentCheck(contextInfo, componentName);
        this.mInjector.getEDM().enforceActiveAdminPermissionByContext(contextInfo, new ArrayList(Arrays.asList("com.samsung.android.knox.permission.KNOX_APP_MGMT")));
        String processName = getProcessName(Binder.getCallingPid());
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            if (EdmConstants.APP_MANAGEMENT_SERVICE_PACKAGES.contains(processName) && EdmConstants.APP_RESTRICTIONS_PACKAGES.containsKey(str) && bundle.isEmpty()) {
                KnoxsdkFileLog.d("DevicePolicyManager", "cPN: " + processName + " may try to revoke an app restrictions to tPN: " + str);
                ((ApplicationRestrictionsInternal) LocalServices.getService(ApplicationRestrictionsInternal.class)).setApplicationRestrictionsInternal(str, bundle, 0, true);
            }
            this.mUserManager.setApplicationRestrictions(str, bundle, new UserHandle(i));
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public Bundle getApplicationRestrictionsMDM(ComponentName componentName, String str, int i) {
        ContextInfo contextInfo = new ContextInfo(this.mInjector.binderGetCallingUid(), i);
        this.mInjector.getEDM().enforceComponentCheck(contextInfo, componentName);
        this.mInjector.getEDM().enforceActiveAdminPermissionByContext(contextInfo, new ArrayList(Arrays.asList("com.samsung.android.knox.permission.KNOX_APP_MGMT")));
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            Bundle applicationRestrictions = this.mUserManager.getApplicationRestrictions(str, new UserHandle(i));
            if (applicationRestrictions == null) {
                applicationRestrictions = Bundle.EMPTY;
            }
            return applicationRestrictions;
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public final String getProcessName(int i) {
        String str;
        String str2 = "unidentified";
        long clearCallingIdentity = Binder.clearCallingIdentity();
        try {
            try {
                List runningAppProcesses = this.mInjector.getIActivityManager().getRunningAppProcesses();
                if (runningAppProcesses != null && runningAppProcesses.size() > 0) {
                    Iterator it = runningAppProcesses.iterator();
                    while (true) {
                        if (!it.hasNext()) {
                            break;
                        }
                        ActivityManager.RunningAppProcessInfo runningAppProcessInfo = (ActivityManager.RunningAppProcessInfo) it.next();
                        if (runningAppProcessInfo.pid == i && (str = runningAppProcessInfo.processName) != null) {
                            str2 = str;
                            break;
                        }
                    }
                }
                return str2.split(XmlUtils.STRING_ARRAY_SEPARATOR)[0];
            } catch (Exception e) {
                e.printStackTrace();
                Binder.restoreCallingIdentity(clearCallingIdentity);
                return str2;
            }
        } finally {
            Binder.restoreCallingIdentity(clearCallingIdentity);
        }
    }

    public void addCrossProfileIntentFilterMDM(ComponentName componentName, IntentFilter intentFilter, int i, int i2) {
        Injector injector;
        UserInfo profileParent;
        Objects.requireNonNull(componentName, "ComponentName is null");
        ContextInfo contextInfo = new ContextInfo(this.mInjector.binderGetCallingUid(), i2);
        this.mInjector.getEDM().enforceComponentCheck(contextInfo, componentName);
        this.mInjector.getEDM().enforceActiveAdminPermissionByContext(contextInfo, new ArrayList(Arrays.asList("com.samsung.android.knox.permission.KNOX_CONTAINER")));
        synchronized (getLockObject()) {
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                profileParent = this.mUserManager.getProfileParent(i2);
            } catch (RemoteException unused) {
                injector = this.mInjector;
            } catch (Throwable th) {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                throw th;
            }
            if (profileParent == null) {
                Slogf.e("DevicePolicyManager", "Cannot call addCrossProfileIntentFilter if there is no parent");
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                return;
            }
            int i3 = i & 1;
            if (i3 != 0) {
                this.mIPackageManager.addCrossProfileIntentFilter(intentFilter, componentName.getPackageName(), i2, profileParent.id, 0);
            }
            int i4 = i & 2;
            if (i4 != 0) {
                this.mIPackageManager.addCrossProfileIntentFilter(intentFilter, componentName.getPackageName(), profileParent.id, i2, 0);
            }
            String str = (i3 == 0 || i4 == 0) ? i3 != 0 ? "MANAGED" : i4 != 0 ? "PARENT" : null : "MANAGED and PARENT";
            if (intentFilter.actionsIterator() != null && str != null) {
                Iterator<String> actionsIterator = intentFilter.actionsIterator();
                while (actionsIterator.hasNext()) {
                    makeAuditLogGroupSecurity(String.format("Admin %s has allowed %s action to be sent cross profile, using flag %s.", componentName.getPackageName(), actionsIterator.next(), str), i2);
                }
            }
            injector = this.mInjector;
            injector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public void clearCrossProfileIntentFiltersMDM(ComponentName componentName, int i) {
        Injector injector;
        UserInfo profileParent;
        Objects.requireNonNull(componentName, "ComponentName is null");
        ContextInfo contextInfo = new ContextInfo(this.mInjector.binderGetCallingUid(), i);
        this.mInjector.getEDM().enforceComponentCheck(contextInfo, componentName);
        this.mInjector.getEDM().enforceActiveAdminPermissionByContext(contextInfo, new ArrayList(Arrays.asList("com.samsung.android.knox.permission.KNOX_CONTAINER")));
        synchronized (getLockObject()) {
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                try {
                    profileParent = this.mUserManager.getProfileParent(i);
                } finally {
                    this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                }
            } catch (RemoteException unused) {
                injector = this.mInjector;
            }
            if (profileParent == null) {
                Slogf.e("DevicePolicyManager", "Cannot call clearCrossProfileIntentFilter if there is no parent");
                return;
            }
            this.mIPackageManager.clearCrossProfileIntentFilters(i, componentName.getPackageName());
            this.mIPackageManager.clearCrossProfileIntentFilters(profileParent.id, componentName.getPackageName());
            makeAuditLogGroupSecurity(String.format("Admin %s has cleared all cross-profile intent filters.", componentName.getPackageName()), i);
            injector = this.mInjector;
            injector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public boolean setResetPasswordTokenMDM(ComponentName componentName, byte[] bArr, int i) {
        boolean z;
        if (!this.mHasFeature) {
            return false;
        }
        if (bArr == null || bArr.length < 32) {
            throw new IllegalArgumentException("token must be at least 32-byte long");
        }
        SDPLog.i("Set reset token MDM for user " + this.mInjector.userHandleGetCallingUserId());
        SDPLog.p("admin", componentName, KnoxCustomManagerService.SPCM_KEY_TOKEN, bArr);
        synchronized (getLockObject()) {
            getActiveAdminForCallerLockedMDM(componentName, 2, i);
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                long j = lambda$getUserDataUnchecked$2.mPasswordTokenHandle;
                if (j != 0) {
                    this.mLockPatternUtils.removeEscrowToken(j, i);
                }
                lambda$getUserDataUnchecked$2.mPasswordTokenHandle = this.mLockPatternUtils.addEscrowToken(bArr, i, (LockPatternUtils.EscrowTokenStateChangeCallback) null);
                saveSettingsLocked(i);
                z = lambda$getUserDataUnchecked$2.mPasswordTokenHandle != 0;
            } finally {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        }
        return z;
    }

    public boolean clearResetPasswordTokenMDM(ComponentName componentName, int i) {
        if (!this.mHasFeature) {
            return false;
        }
        synchronized (getLockObject()) {
            getActiveAdminForCallerLockedMDM(componentName, 2, i);
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            if (lambda$getUserDataUnchecked$2.mPasswordTokenHandle == 0) {
                return false;
            }
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                boolean removeEscrowToken = this.mLockPatternUtils.removeEscrowToken(lambda$getUserDataUnchecked$2.mPasswordTokenHandle, i);
                lambda$getUserDataUnchecked$2.mPasswordTokenHandle = 0L;
                saveSettingsLocked(i);
                return removeEscrowToken;
            } finally {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        }
    }

    public boolean isResetPasswordTokenActiveMDM(ComponentName componentName, int i) {
        synchronized (getLockObject()) {
            getActiveAdminForCallerLockedMDM(componentName, 2, i);
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            if (lambda$getUserDataUnchecked$2.mPasswordTokenHandle == 0) {
                return false;
            }
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                return this.mLockPatternUtils.isEscrowTokenActive(lambda$getUserDataUnchecked$2.mPasswordTokenHandle, i);
            } finally {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        }
    }

    public boolean resetPasswordWithTokenMDM(ComponentName componentName, String str, byte[] bArr, int i, int i2) {
        Objects.requireNonNull(bArr);
        SDPLog.i("Set reset password MDM with token for user " + this.mInjector.userHandleGetCallingUserId());
        SDPLog.p("admin", componentName, "passwordOrNull", str, KnoxCustomManagerService.SPCM_KEY_TOKEN, bArr, "flags", Integer.valueOf(i));
        synchronized (getLockObject()) {
            getActiveAdminForCallerLockedMDM(componentName, 2, i2);
            long j = lambda$getUserDataUnchecked$2(i2).mPasswordTokenHandle;
            if (j != 0) {
                if (str == null) {
                    str = "";
                }
                return resetPasswordInternal(str, j, bArr, i, new CallerIdentity(this.mInjector.binderGetCallingUid(), null, null), i2);
            }
            Slogf.w("DevicePolicyManager", "No saved token handle");
            return false;
        }
    }

    public final void makeAuditLogGroupSystem(String str, int i) {
        makeAuditLog(2, str, i);
    }

    public final void makeAuditLogGroupSecurity(String str, int i) {
        makeAuditLog(1, str, i);
    }

    public final void makeAuditLog(int i, String str, int i2) {
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            AuditLog.logAsUser(5, i, true, Process.myPid(), "DevicePolicyManager", str, i2);
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public boolean isProfileOwnerOfOrganizationOwnedDeviceMDM(int i) {
        boolean isProfileOwnerOfOrganizationOwnedDevice;
        synchronized (getLockObject()) {
            isProfileOwnerOfOrganizationOwnedDevice = this.mOwners.isProfileOwnerOfOrganizationOwnedDevice(i);
        }
        return isProfileOwnerOfOrganizationOwnedDevice;
    }

    public final void putPrivateDnsSettings(final int i, final String str) {
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda8
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$putPrivateDnsSettings$160(i, str);
            }
        });
    }

    public /* synthetic */ void lambda$putPrivateDnsSettings$160(int i, String str) {
        ConnectivitySettingsManager.setPrivateDnsMode(this.mContext, i);
        ConnectivitySettingsManager.setPrivateDnsHostname(this.mContext, str);
    }

    public int setGlobalPrivateDns(ComponentName componentName, int i, String str) {
        if (!this.mHasFeature) {
            return 2;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(getCallerIdentity(componentName)));
        checkAllUsersAreAffiliatedWithDevice();
        checkCanExecuteOrThrowUnsafe(33);
        if (i == 2) {
            if (!TextUtils.isEmpty(str)) {
                throw new IllegalArgumentException("Host provided for opportunistic mode, but is not needed.");
            }
            putPrivateDnsSettings(2, null);
            return 0;
        }
        if (i == 3) {
            if (TextUtils.isEmpty(str) || !NetworkUtilsInternal.isWeaklyValidatedHostname(str)) {
                throw new IllegalArgumentException(String.format("Provided hostname %s is not valid", str));
            }
            putPrivateDnsSettings(3, str);
            return 0;
        }
        throw new IllegalArgumentException(String.format("Provided mode, %d, is not a valid mode.", Integer.valueOf(i)));
    }

    public int getGlobalPrivateDnsMode(ComponentName componentName) {
        if (!this.mHasFeature) {
            return 0;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(getCallerIdentity(componentName)));
        int privateDnsMode = ConnectivitySettingsManager.getPrivateDnsMode(this.mContext);
        int i = 1;
        if (privateDnsMode != 1) {
            i = 2;
            if (privateDnsMode != 2) {
                i = 3;
                if (privateDnsMode != 3) {
                    return 0;
                }
            }
        }
        return i;
    }

    public String getGlobalPrivateDnsHost(ComponentName componentName) {
        if (!this.mHasFeature) {
            return null;
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(getCallerIdentity(componentName)));
        return this.mInjector.settingsGlobalGetString("private_dns_specifier");
    }

    public void installUpdateFromFile(ComponentName componentName, String str, final ParcelFileDescriptor parcelFileDescriptor, final StartInstallingUpdateCallback startInstallingUpdateCallback) {
        CallerIdentity callerIdentity;
        if (!isPermissionCheckFlagEnabled()) {
            Objects.requireNonNull(componentName, "ComponentName is null");
        }
        if (isPermissionCheckFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_SYSTEM_UPDATES", callerIdentity.getPackageName(), -1);
        } else {
            callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        }
        checkCanExecuteOrThrowUnsafe(26);
        DevicePolicyEventLogger.createEvent(73).setAdmin(callerIdentity.getPackageName()).setBoolean(isDeviceAB()).write();
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda11
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$installUpdateFromFile$161(parcelFileDescriptor, startInstallingUpdateCallback);
            }
        });
    }

    public /* synthetic */ void lambda$installUpdateFromFile$161(ParcelFileDescriptor parcelFileDescriptor, StartInstallingUpdateCallback startInstallingUpdateCallback) {
        UpdateInstaller nonAbUpdateInstaller;
        if (isDeviceAB()) {
            nonAbUpdateInstaller = new AbUpdateInstaller(this.mContext, parcelFileDescriptor, startInstallingUpdateCallback, this.mInjector, this.mConstants);
        } else {
            nonAbUpdateInstaller = new NonAbUpdateInstaller(this.mContext, parcelFileDescriptor, startInstallingUpdateCallback, this.mInjector, this.mConstants);
        }
        nonAbUpdateInstaller.startInstallUpdate();
    }

    public final boolean isDeviceAB() {
        return "true".equalsIgnoreCase(SystemProperties.get("ro.build.ab_update", ""));
    }

    public void setCrossProfileCalendarPackages(ComponentName componentName, List list) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
            synchronized (getLockObject()) {
                getProfileOwnerLocked(callerIdentity.getUserId()).mCrossProfileCalendarPackages = list;
                saveSettingsLocked(callerIdentity.getUserId());
            }
            DevicePolicyEventLogger.createEvent(70).setAdmin(componentName).setStrings(list == null ? null : (String[]) list.toArray(new String[list.size()])).write();
        }
    }

    public List getCrossProfileCalendarPackages(ComponentName componentName) {
        List list;
        if (!this.mHasFeature) {
            return Collections.emptyList();
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
        synchronized (getLockObject()) {
            list = getProfileOwnerLocked(callerIdentity.getUserId()).mCrossProfileCalendarPackages;
        }
        return list;
    }

    public boolean isPackageAllowedToAccessCalendarForUser(String str, int i) {
        if (!this.mHasFeature) {
            return false;
        }
        Preconditions.checkStringNotEmpty(str, "Package name is null or empty");
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        PackageManagerLocal.UnfilteredSnapshot withUnfilteredSnapshot = this.mInjector.getPackageManagerLocal().withUnfilteredSnapshot();
        try {
            PackageState packageState = (PackageState) withUnfilteredSnapshot.getPackageStates().get(str);
            if (packageState == null) {
                Slogf.w("DevicePolicyManager", "Couldn't find package %s in user %d", str, Integer.valueOf(i));
                withUnfilteredSnapshot.close();
                return false;
            }
            if (!packageState.getUserStateOrDefault(i).isInstalled()) {
                Slogf.w("DevicePolicyManager", "Couldn't find installed package %s in user %d", str, Integer.valueOf(i));
                withUnfilteredSnapshot.close();
                return false;
            }
            int uid = UserHandle.getUid(i, packageState.getAppId());
            withUnfilteredSnapshot.close();
            if (getCallerIdentity().getUid() != uid) {
                Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.INTERACT_ACROSS_USERS") || hasCallingOrSelfPermission("android.permission.INTERACT_ACROSS_USERS_FULL"));
            }
            synchronized (getLockObject()) {
                if (this.mInjector.settingsSecureGetIntForUser("cross_profile_calendar_enabled", 0, i) == 0) {
                    return false;
                }
                ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
                if (profileOwnerAdminLocked == null) {
                    return false;
                }
                List list = profileOwnerAdminLocked.mCrossProfileCalendarPackages;
                if (list == null) {
                    return true;
                }
                return list.contains(str);
            }
        } catch (Throwable th) {
            if (withUnfilteredSnapshot != null) {
                try {
                    withUnfilteredSnapshot.close();
                } catch (Throwable th2) {
                    th.addSuppressed(th2);
                }
            }
            throw th;
        }
    }

    public List getCrossProfileCalendarPackagesForUser(int i) {
        if (!this.mHasFeature) {
            return Collections.emptyList();
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.INTERACT_ACROSS_USERS") || hasCallingOrSelfPermission("android.permission.INTERACT_ACROSS_USERS_FULL"));
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            if (profileOwnerAdminLocked != null) {
                return profileOwnerAdminLocked.mCrossProfileCalendarPackages;
            }
            return Collections.emptyList();
        }
    }

    public void setCrossProfilePackages(ComponentName componentName, final List list) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Objects.requireNonNull(list, "Package names is null");
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
            synchronized (getLockObject()) {
                ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
                final List list2 = profileOwnerLocked.mCrossProfilePackages;
                if (list.equals(list2)) {
                    return;
                }
                profileOwnerLocked.mCrossProfilePackages = list;
                saveSettingsLocked(callerIdentity.getUserId());
                logSetCrossProfilePackages(componentName, list);
                final CrossProfileApps crossProfileApps = (CrossProfileApps) this.mContext.createContextAsUser(callerIdentity.getUserHandle(), 0).getSystemService(CrossProfileApps.class);
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda65
                    public final void runOrThrow() {
                        DevicePolicyManagerService.lambda$setCrossProfilePackages$162(crossProfileApps, list2, list);
                    }
                });
            }
        }
    }

    public static /* synthetic */ void lambda$setCrossProfilePackages$162(CrossProfileApps crossProfileApps, List list, List list2) {
        crossProfileApps.resetInteractAcrossProfilesAppOps(list, new HashSet(list2));
    }

    public final void logSetCrossProfilePackages(ComponentName componentName, List list) {
        DevicePolicyEventLogger.createEvent(138).setAdmin(componentName).setStrings((String[]) list.toArray(new String[list.size()])).write();
    }

    public List getCrossProfilePackages(ComponentName componentName) {
        List list;
        if (!this.mHasFeature) {
            return Collections.emptyList();
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwner(callerIdentity));
        synchronized (getLockObject()) {
            list = getProfileOwnerLocked(callerIdentity.getUserId()).mCrossProfilePackages;
        }
        return list;
    }

    public List getAllCrossProfilePackages(int i) {
        List crossProfilePackagesForAdmins;
        if (!this.mHasFeature) {
            return Collections.emptyList();
        }
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isSystemUid(callerIdentity) || isRootUid(callerIdentity) || hasCallingPermission("android.permission.INTERACT_ACROSS_USERS") || hasCallingPermission("android.permission.INTERACT_ACROSS_USERS_FULL") || hasPermissionForPreflight(callerIdentity, "android.permission.INTERACT_ACROSS_PROFILES"));
        synchronized (getLockObject()) {
            crossProfilePackagesForAdmins = getCrossProfilePackagesForAdmins(getProfileOwnerAdminsForProfileGroup(i));
            crossProfilePackagesForAdmins.addAll(getDefaultCrossProfilePackages());
        }
        return crossProfilePackagesForAdmins;
    }

    public final List getCrossProfilePackagesForAdmins(List list) {
        ArrayList arrayList = new ArrayList();
        for (int i = 0; i < list.size(); i++) {
            arrayList.addAll(((ActiveAdmin) list.get(i)).mCrossProfilePackages);
        }
        return arrayList;
    }

    public List getDefaultCrossProfilePackages() {
        HashSet hashSet = new HashSet();
        try {
            if (this.mOwners.hasDeviceOwner()) {
                Log.i("DevicePolicyManager", "getDefaultCrossProfilePackages : DO is enabled. Return empty list.");
                return new ArrayList();
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
        Collections.addAll(hashSet, this.mContext.getResources().getStringArray(17236417));
        Collections.addAll(hashSet, this.mContext.getResources().getStringArray(17236464));
        return new ArrayList(hashSet);
    }

    public final List getProfileOwnerAdminsForProfileGroup(int i) {
        ArrayList arrayList;
        ActiveAdmin activeAdminUncheckedLocked;
        synchronized (getLockObject()) {
            arrayList = new ArrayList();
            int[] profileIdsWithDisabled = this.mUserManager.getProfileIdsWithDisabled(i);
            for (int i2 = 0; i2 < profileIdsWithDisabled.length; i2++) {
                ComponentName lambda$isProfileOwner$71 = lambda$isProfileOwner$71(profileIdsWithDisabled[i2]);
                if (lambda$isProfileOwner$71 != null && (activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(lambda$isProfileOwner$71, profileIdsWithDisabled[i2])) != null) {
                    arrayList.add(activeAdminUncheckedLocked);
                }
            }
        }
        return arrayList;
    }

    public boolean isManagedKiosk() {
        if (!this.mHasFeature) {
            return false;
        }
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
        try {
            try {
                return isManagedKioskInternal();
            } catch (RemoteException e) {
                throw new IllegalStateException(e);
            }
        } finally {
            this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
        }
    }

    public final boolean isUnattendedManagedKioskUnchecked() {
        try {
            if (isManagedKioskInternal()) {
                if (getPowerManagerInternal().wasDeviceIdleFor(30000L)) {
                    return true;
                }
            }
            return false;
        } catch (RemoteException e) {
            throw new IllegalStateException(e);
        }
    }

    public boolean isUnattendedManagedKiosk() {
        if (!this.mHasFeature) {
            return false;
        }
        Preconditions.checkCallAuthorization(canManageUsers(getCallerIdentity()) || hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda51
            public final Object getOrThrow() {
                Boolean lambda$isUnattendedManagedKiosk$163;
                lambda$isUnattendedManagedKiosk$163 = DevicePolicyManagerService.this.lambda$isUnattendedManagedKiosk$163();
                return lambda$isUnattendedManagedKiosk$163;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$isUnattendedManagedKiosk$163() {
        return Boolean.valueOf(isUnattendedManagedKioskUnchecked());
    }

    public final boolean isManagedKioskInternal() {
        return (!this.mOwners.hasDeviceOwner() || this.mInjector.getIActivityManager().getLockTaskModeState() != 1 || isLockTaskFeatureEnabled(1) || deviceHasKeyguard() || inEphemeralUserSession()) ? false : true;
    }

    public final boolean isLockTaskFeatureEnabled(int i) {
        int i2;
        if (isPolicyEngineForFinanceFlagEnabled()) {
            LockTaskPolicy lockTaskPolicy = (LockTaskPolicy) this.mDevicePolicyEngine.getResolvedPolicy(PolicyDefinition.LOCK_TASK, getCurrentForegroundUserId());
            i2 = lockTaskPolicy == null ? 16 : lockTaskPolicy.getFlags();
        } else {
            i2 = lambda$getUserDataUnchecked$2(getCurrentForegroundUserId()).mLockTaskFeatures;
        }
        return (i2 & i) == i;
    }

    public final boolean deviceHasKeyguard() {
        Iterator it = this.mUserManager.getUsers().iterator();
        while (it.hasNext()) {
            if (this.mLockPatternUtils.isSecure(((UserInfo) it.next()).id)) {
                return true;
            }
        }
        return false;
    }

    public final boolean inEphemeralUserSession() {
        Iterator it = this.mUserManager.getUsers().iterator();
        while (it.hasNext()) {
            if (this.mInjector.getUserManager().isUserEphemeral(((UserInfo) it.next()).id)) {
                return true;
            }
        }
        return false;
    }

    public final PowerManagerInternal getPowerManagerInternal() {
        return this.mInjector.getPowerManagerInternal();
    }

    public boolean startViewCalendarEventInManagedProfile(final String str, final long j, final long j2, final long j3, final boolean z, final int i) {
        if (!this.mHasFeature) {
            return false;
        }
        Preconditions.checkStringNotEmpty(str, "Package name is empty");
        final CallerIdentity callerIdentity = getCallerIdentity();
        if (!isCallingFromPackage(str, callerIdentity.getUid())) {
            throw new SecurityException("Input package name doesn't align with actual calling package.");
        }
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda63
            public final Object getOrThrow() {
                Boolean lambda$startViewCalendarEventInManagedProfile$164;
                lambda$startViewCalendarEventInManagedProfile$164 = DevicePolicyManagerService.this.lambda$startViewCalendarEventInManagedProfile$164(callerIdentity, str, j, j2, j3, z, i);
                return lambda$startViewCalendarEventInManagedProfile$164;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$startViewCalendarEventInManagedProfile$164(CallerIdentity callerIdentity, String str, long j, long j2, long j3, boolean z, int i) {
        int managedUserId = getManagedUserId(callerIdentity.getUserId());
        if (managedUserId < 0) {
            return Boolean.FALSE;
        }
        if (!isPackageAllowedToAccessCalendarForUser(str, managedUserId)) {
            Slogf.d("DevicePolicyManager", "Package %s is not allowed to access cross-profile calendar APIs", str);
            return Boolean.FALSE;
        }
        Intent intent = new Intent("android.provider.calendar.action.VIEW_MANAGED_PROFILE_CALENDAR_EVENT");
        intent.setPackage(str);
        intent.putExtra("id", j);
        intent.putExtra("beginTime", j2);
        intent.putExtra("endTime", j3);
        intent.putExtra("allDay", z);
        intent.setFlags(i);
        try {
            this.mContext.startActivityAsUser(intent, UserHandle.of(managedUserId));
            return Boolean.TRUE;
        } catch (ActivityNotFoundException e) {
            Slogf.e("DevicePolicyManager", "View event activity not found", e);
            return Boolean.FALSE;
        }
    }

    public void setApplicationExemptions(String str, final String str2, int[] iArr) {
        int i;
        if (this.mHasFeature) {
            Preconditions.checkStringNotEmpty(str2, "Package name cannot be empty.");
            Objects.requireNonNull(iArr, "Application exemptions must not be null.");
            Preconditions.checkArgument(areApplicationExemptionsValid(iArr), "Invalid application exemption constant found in application exemptions set.");
            Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_DEVICE_POLICY_APP_EXEMPTIONS"));
            CallerIdentity callerIdentity = getCallerIdentity(str);
            final ApplicationInfo packageInfoWithNullCheck = getPackageInfoWithNullCheck(str2, callerIdentity);
            Iterator it = APPLICATION_EXEMPTION_CONSTANTS_TO_APP_OPS.entrySet().iterator();
            while (true) {
                if (!it.hasNext()) {
                    break;
                }
                final Map.Entry entry = (Map.Entry) it.next();
                final int unsafeCheckOpNoThrow = this.mInjector.getAppOpsManager().unsafeCheckOpNoThrow((String) entry.getValue(), packageInfoWithNullCheck.uid, packageInfoWithNullCheck.packageName);
                final int i2 = ArrayUtils.contains(iArr, ((Integer) entry.getKey()).intValue()) ? 0 : 3;
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda17
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$setApplicationExemptions$165(unsafeCheckOpNoThrow, i2, entry, packageInfoWithNullCheck, str2);
                    }
                });
            }
            String[] strArr = new String[iArr.length];
            for (i = 0; i < iArr.length; i++) {
                strArr[i] = (String) APPLICATION_EXEMPTION_CONSTANTS_TO_APP_OPS.get(Integer.valueOf(iArr[i]));
            }
            DevicePolicyEventLogger.createEvent(FrameworkStatsLog.DEVICE_POLICY_EVENT__EVENT_ID__SET_APPLICATION_EXEMPTIONS).setAdmin(callerIdentity.getPackageName()).setStrings(str2, strArr).write();
        }
    }

    public /* synthetic */ void lambda$setApplicationExemptions$165(int i, int i2, Map.Entry entry, ApplicationInfo applicationInfo, String str) {
        if (i != i2) {
            this.mInjector.getAppOpsManager().setMode((String) entry.getValue(), applicationInfo.uid, str, i2);
        }
    }

    public int[] getApplicationExemptions(String str) {
        if (!this.mHasFeature) {
            return new int[0];
        }
        Preconditions.checkStringNotEmpty(str, "Package name cannot be empty.");
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_DEVICE_POLICY_APP_EXEMPTIONS"));
        ApplicationInfo packageInfoWithNullCheck = getPackageInfoWithNullCheck(str, getCallerIdentity());
        IntArray intArray = new IntArray(0);
        for (Map.Entry entry : APPLICATION_EXEMPTION_CONSTANTS_TO_APP_OPS.entrySet()) {
            if (this.mInjector.getAppOpsManager().unsafeCheckOpNoThrow((String) entry.getValue(), packageInfoWithNullCheck.uid, packageInfoWithNullCheck.packageName) == 0) {
                intArray.add(((Integer) entry.getKey()).intValue());
            }
        }
        return intArray.toArray();
    }

    public final ApplicationInfo getPackageInfoWithNullCheck(String str, CallerIdentity callerIdentity) {
        ApplicationInfo applicationInfo = this.mInjector.getPackageManagerInternal().getApplicationInfo(str, 0L, callerIdentity.getUid(), callerIdentity.getUserId());
        if (applicationInfo != null) {
            return applicationInfo;
        }
        throw new ServiceSpecificException(1, "Package name not found.");
    }

    public final boolean areApplicationExemptionsValid(int[] iArr) {
        for (int i : iArr) {
            if (!APPLICATION_EXEMPTION_CONSTANTS_TO_APP_OPS.containsKey(Integer.valueOf(i))) {
                return false;
            }
        }
        return true;
    }

    public final boolean isCallingFromPackage(String str, int i) {
        PackageManagerLocal.UnfilteredSnapshot withUnfilteredSnapshot = this.mInjector.getPackageManagerLocal().withUnfilteredSnapshot();
        try {
            PackageState packageState = (PackageState) withUnfilteredSnapshot.getPackageStates().get(str);
            int userId = UserHandle.getUserId(i);
            if (packageState == null) {
                Slogf.d("DevicePolicyManager", "Calling UID " + i + " not found");
                withUnfilteredSnapshot.close();
                return false;
            }
            if (!packageState.getUserStateOrDefault(userId).isInstalled()) {
                Slogf.d("DevicePolicyManager", "Calling UID " + i + " not installed");
                withUnfilteredSnapshot.close();
                return false;
            }
            boolean z = i == UserHandle.getUid(userId, packageState.getAppId());
            withUnfilteredSnapshot.close();
            return z;
        } catch (Throwable th) {
            if (withUnfilteredSnapshot != null) {
                try {
                    withUnfilteredSnapshot.close();
                } catch (Throwable th2) {
                    th.addSuppressed(th2);
                }
            }
            throw th;
        }
    }

    public final DevicePolicyConstants loadConstants() {
        return DevicePolicyConstants.loadFromString(this.mInjector.settingsGlobalGetString("device_policy_constants"));
    }

    public void setUserControlDisabledPackages(ComponentName componentName, String str, final List list) {
        final CallerIdentity callerIdentity;
        Objects.requireNonNull(list, "packages is null");
        if (isPolicyEngineForFinanceFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        checkCanExecuteOrThrowUnsafe(22);
        if (isPolicyEngineForFinanceFlagEnabled()) {
            final EnforcingAdmin enforcePermissionAndGetEnforcingAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_APPS_CONTROL", callerIdentity.getPackageName(), callerIdentity.getUserId());
            Binder.withCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda78
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$setUserControlDisabledPackages$166(list, callerIdentity, enforcePermissionAndGetEnforcingAdmin);
                }
            });
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity) || isFinancedDeviceOwner(callerIdentity));
            synchronized (getLockObject()) {
                ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(callerIdentity.getUserId());
                if (!Objects.equals(deviceOrProfileOwnerAdminLocked.protectedPackages, list)) {
                    deviceOrProfileOwnerAdminLocked.protectedPackages = list.isEmpty() ? null : list;
                    saveSettingsLocked(callerIdentity.getUserId());
                    pushUserControlDisabledPackagesLocked(callerIdentity.getUserId());
                }
            }
        }
        DevicePolicyEventLogger.createEvent(129).setAdmin(callerIdentity.getPackageName()).setStrings((String[]) list.toArray(new String[list.size()])).write();
    }

    public /* synthetic */ void lambda$setUserControlDisabledPackages$166(List list, CallerIdentity callerIdentity, EnforcingAdmin enforcingAdmin) {
        if (list.isEmpty()) {
            removeUserControlDisabledPackages(callerIdentity, enforcingAdmin);
        } else {
            addUserControlDisabledPackages(callerIdentity, enforcingAdmin, new HashSet(list));
        }
    }

    public final void addUserControlDisabledPackages(CallerIdentity callerIdentity, EnforcingAdmin enforcingAdmin, Set set) {
        if (isDeviceOwner(callerIdentity)) {
            this.mDevicePolicyEngine.setGlobalPolicy(PolicyDefinition.USER_CONTROLLED_DISABLED_PACKAGES, enforcingAdmin, new StringSetPolicyValue(set));
        } else {
            this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.USER_CONTROLLED_DISABLED_PACKAGES, enforcingAdmin, new StringSetPolicyValue(set), callerIdentity.getUserId());
        }
    }

    public final void removeUserControlDisabledPackages(CallerIdentity callerIdentity, EnforcingAdmin enforcingAdmin) {
        if (isDeviceOwner(callerIdentity)) {
            this.mDevicePolicyEngine.removeGlobalPolicy(PolicyDefinition.USER_CONTROLLED_DISABLED_PACKAGES, enforcingAdmin);
        } else {
            this.mDevicePolicyEngine.removeLocalPolicy(PolicyDefinition.USER_CONTROLLED_DISABLED_PACKAGES, enforcingAdmin, callerIdentity.getUserId());
        }
    }

    public List getUserControlDisabledPackages(ComponentName componentName, String str) {
        CallerIdentity callerIdentity;
        List list;
        if (isPolicyEngineForFinanceFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        if (isPolicyEngineForFinanceFlagEnabled()) {
            enforceCanQuery("android.permission.MANAGE_DEVICE_POLICY_APPS_CONTROL", callerIdentity.getPackageName(), callerIdentity.getUserId());
            Set set = (Set) this.mDevicePolicyEngine.getResolvedPolicy(PolicyDefinition.USER_CONTROLLED_DISABLED_PACKAGES, callerIdentity.getUserId());
            return set == null ? Collections.emptyList() : set.stream().toList();
        }
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity) || isFinancedDeviceOwner(callerIdentity));
        synchronized (getLockObject()) {
            list = getDeviceOrProfileOwnerAdminLocked(callerIdentity.getUserId()).protectedPackages;
            if (list == null) {
                list = Collections.emptyList();
            }
        }
        return list;
    }

    /* JADX WARN: Multi-variable type inference failed */
    /* JADX WARN: Type inference failed for: r5v6, types: [com.android.server.devicepolicy.DevicePolicyManagerService$Injector] */
    public void setCommonCriteriaModeEnabled(ComponentName componentName, String str, boolean z) {
        CallerIdentity callerIdentity;
        ActiveAdmin profileOwnerOrDeviceOwnerLocked;
        ActiveAdmin activeAdmin;
        if (isPermissionCheckFlagEnabled()) {
            callerIdentity = getCallerIdentity(componentName, str);
        } else {
            callerIdentity = getCallerIdentity(componentName);
        }
        boolean z2 = false;
        if (isPermissionCheckFlagEnabled()) {
            activeAdmin = enforcePermissionAndGetEnforcingAdmin(componentName, "android.permission.MANAGE_DEVICE_POLICY_COMMON_CRITERIA_MODE", callerIdentity.getPackageName(), callerIdentity.getUserId()).getActiveAdmin();
        } else {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity), "Common Criteria mode can only be controlled by a device owner or a profile owner on an organization-owned device.");
            synchronized (getLockObject()) {
                profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
            }
            activeAdmin = profileOwnerOrDeviceOwnerLocked;
        }
        synchronized (getLockObject()) {
            activeAdmin.mCommonCriteriaMode = z;
            saveSettingsLocked(callerIdentity.getUserId());
        }
        DevicePolicyEventLogger.createEvent(131).setAdmin(callerIdentity.getPackageName()).setBoolean(z).write();
        if (MdfUtils.isMdfSupported()) {
            IRestrictionPolicy restrictionService = this.mInjector.getRestrictionService();
            if (restrictionService != null) {
                int userId = callerIdentity.getUserId();
                ContextInfo contextInfo = new ContextInfo(this.mInjector.binderGetCallingUid(), userId);
                long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
                try {
                    try {
                        z2 = restrictionService.setCCModeOnlyForCallerSystem(contextInfo, z);
                    } catch (RemoteException e) {
                        Log.e("DevicePolicyManager", "error. setCCModeOnlyForCallerSystem = " + e);
                    }
                    Log.d("DevicePolicyManager", "retSetCCMode = " + z2 + " userId = " + userId);
                    return;
                } finally {
                    this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                }
            }
            return;
        }
        Log.d("DevicePolicyManager", "This model has not been certified MDFPP");
    }

    public boolean isCommonCriteriaModeEnabled(ComponentName componentName) {
        ActiveAdmin deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked;
        boolean z;
        boolean z2;
        boolean z3 = true;
        if (componentName != null) {
            CallerIdentity callerIdentity = getCallerIdentity(componentName);
            if (!isDefaultDeviceOwner(callerIdentity) && !isProfileOwnerOfOrganizationOwnedDevice(callerIdentity)) {
                z3 = false;
            }
            Preconditions.checkCallAuthorization(z3, "Common Criteria mode can only be controlled by a device owner or a profile owner on an organization-owned device.");
            synchronized (getLockObject()) {
                z2 = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()).mCommonCriteriaMode;
            }
            return z2;
        }
        if (MdfUtils.isMdfEnforced()) {
            return true;
        }
        synchronized (getLockObject()) {
            if (isHeadlessFlagEnabled()) {
                deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked();
            } else {
                deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked(0);
            }
            z = deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked != null ? deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked.mCommonCriteriaMode : false;
        }
        return z;
    }

    public int getPersonalAppsSuspendedReasons(ComponentName componentName) {
        int makeSuspensionReasons;
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
            long j = profileOwnerLocked.mProfileOffDeadline;
            makeSuspensionReasons = makeSuspensionReasons(profileOwnerLocked.mSuspendPersonalApps, j != 0 && this.mInjector.systemCurrentTimeMillis() > j);
            Slogf.d("DevicePolicyManager", "getPersonalAppsSuspendedReasons user: %d; result: %d", Integer.valueOf(this.mInjector.userHandleGetCallingUserId()), Integer.valueOf(makeSuspensionReasons));
        }
        return makeSuspensionReasons;
    }

    public void setPersonalAppsSuspended(ComponentName componentName, boolean z) {
        boolean z2;
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        Preconditions.checkState(canHandleCheckPolicyComplianceIntent(callerIdentity));
        final int userId = callerIdentity.getUserId();
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(userId);
            boolean z3 = true;
            if (profileOwnerLocked.mSuspendPersonalApps != z) {
                profileOwnerLocked.mSuspendPersonalApps = z;
                z2 = true;
            } else {
                z2 = false;
            }
            if (profileOwnerLocked.mProfileOffDeadline != 0) {
                profileOwnerLocked.mProfileOffDeadline = 0L;
            } else {
                z3 = z2;
            }
            if (z3) {
                saveSettingsLocked(userId);
            }
        }
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda144
            public final Object getOrThrow() {
                Boolean lambda$setPersonalAppsSuspended$167;
                lambda$setPersonalAppsSuspended$167 = DevicePolicyManagerService.this.lambda$setPersonalAppsSuspended$167(userId);
                return lambda$setPersonalAppsSuspended$167;
            }
        });
        DevicePolicyEventLogger.createEvent(135).setAdmin(callerIdentity.getComponentName()).setBoolean(z).write();
    }

    public /* synthetic */ Boolean lambda$setPersonalAppsSuspended$167(int i) {
        return Boolean.valueOf(updatePersonalAppsSuspension(i));
    }

    public final void triggerPolicyComplianceCheckIfNeeded(int i, boolean z) {
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            if (profileOwnerAdminLocked == null) {
                Slogf.wtf("DevicePolicyManager", "Profile owner not found for compliance check");
                return;
            }
            if (z) {
                Intent intent = new Intent("android.app.action.CHECK_POLICY_COMPLIANCE");
                intent.setPackage(profileOwnerAdminLocked.info.getPackageName());
                this.mContext.startActivityAsUser(intent, UserHandle.of(i));
            } else if (profileOwnerAdminLocked.mProfileOffDeadline > 0) {
                sendAdminCommandLocked(profileOwnerAdminLocked, "android.app.action.COMPLIANCE_ACKNOWLEDGEMENT_REQUIRED", null, null, true);
            }
        }
    }

    /* JADX WARN: Removed duplicated region for block: B:14:0x0033  */
    /* JADX WARN: Removed duplicated region for block: B:19:0x0035  */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public final boolean updatePersonalAppsSuspension(int r13) {
        /*
            r12 = this;
            java.lang.Object r0 = r12.getLockObject()
            monitor-enter(r0)
            com.android.server.devicepolicy.ActiveAdmin r1 = r12.getProfileOwnerAdminLocked(r13)     // Catch: java.lang.Throwable -> L64
            r2 = 0
            if (r1 == 0) goto L5b
            com.android.server.pm.UserManagerInternal r3 = r12.mUserManagerInternal     // Catch: java.lang.Throwable -> L64
            boolean r3 = r3.isUserUnlockingOrUnlocked(r13)     // Catch: java.lang.Throwable -> L64
            r4 = 1
            if (r3 == 0) goto L24
            android.os.UserManager r3 = r12.mUserManager     // Catch: java.lang.Throwable -> L64
            android.os.UserHandle r5 = android.os.UserHandle.of(r13)     // Catch: java.lang.Throwable -> L64
            boolean r3 = r3.isQuietModeEnabled(r5)     // Catch: java.lang.Throwable -> L64
            if (r3 == 0) goto L22
            goto L24
        L22:
            r3 = r2
            goto L25
        L24:
            r3 = r4
        L25:
            int r3 = r12.updateProfileOffDeadlineLocked(r13, r1, r3)     // Catch: java.lang.Throwable -> L64
            boolean r5 = r1.mSuspendPersonalApps     // Catch: java.lang.Throwable -> L64
            long r6 = r1.mProfileOffDeadline     // Catch: java.lang.Throwable -> L64
            r8 = -1
            int r6 = (r6 > r8 ? 1 : (r6 == r8 ? 0 : -1))
            if (r6 != 0) goto L35
            r6 = r4
            goto L36
        L35:
            r6 = r2
        L36:
            java.lang.String r7 = "DevicePolicyManager"
            java.lang.String r8 = "Personal apps suspended explicitly: %b, by timeout: %b, notification: %d"
            r9 = 3
            java.lang.Object[] r9 = new java.lang.Object[r9]     // Catch: java.lang.Throwable -> L64
            java.lang.Boolean r10 = java.lang.Boolean.valueOf(r5)     // Catch: java.lang.Throwable -> L64
            r9[r2] = r10     // Catch: java.lang.Throwable -> L64
            java.lang.Boolean r10 = java.lang.Boolean.valueOf(r6)     // Catch: java.lang.Throwable -> L64
            r9[r4] = r10     // Catch: java.lang.Throwable -> L64
            java.lang.Integer r10 = java.lang.Integer.valueOf(r3)     // Catch: java.lang.Throwable -> L64
            r11 = 2
            r9[r11] = r10     // Catch: java.lang.Throwable -> L64
            com.android.server.utils.Slogf.d(r7, r8, r9)     // Catch: java.lang.Throwable -> L64
            r12.updateProfileOffDeadlineNotificationLocked(r13, r1, r3)     // Catch: java.lang.Throwable -> L64
            if (r5 != 0) goto L5a
            if (r6 == 0) goto L5b
        L5a:
            r2 = r4
        L5b:
            monitor-exit(r0)     // Catch: java.lang.Throwable -> L64
            int r0 = r12.getProfileParentId(r13)
            r12.suspendPersonalAppsInternal(r0, r13, r2)
            return r2
        L64:
            r12 = move-exception
            monitor-exit(r0)     // Catch: java.lang.Throwable -> L64
            throw r12
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.updatePersonalAppsSuspension(int):boolean");
    }

    /* JADX WARN: Removed duplicated region for block: B:28:0x00b2  */
    /* JADX WARN: Removed duplicated region for block: B:30:0x00bb  */
    /*
        Code decompiled incorrectly, please refer to instructions dump.
        To view partially-correct code enable 'Show inconsistent code' option in preferences
    */
    public final int updateProfileOffDeadlineLocked(int r13, com.android.server.devicepolicy.ActiveAdmin r14, boolean r15) {
        /*
            r12 = this;
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r0 = r12.mInjector
            long r0 = r0.systemCurrentTimeMillis()
            long r2 = r14.mProfileOffDeadline
            r4 = 0
            int r6 = (r2 > r4 ? 1 : (r2 == r4 ? 0 : -1))
            r7 = 0
            java.lang.String r8 = "DevicePolicyManager"
            if (r6 == 0) goto L3a
            int r6 = (r0 > r2 ? 1 : (r0 == r2 ? 0 : -1))
            if (r6 <= 0) goto L3a
            java.lang.StringBuilder r0 = new java.lang.StringBuilder
            r0.<init>()
            java.lang.String r1 = "Profile off deadline has been reached, off: "
            r0.append(r1)
            r0.append(r15)
            java.lang.String r0 = r0.toString()
            com.android.server.utils.Slogf.i(r8, r0)
            long r0 = r14.mProfileOffDeadline
            r2 = -1
            int r0 = (r0 > r2 ? 1 : (r0 == r2 ? 0 : -1))
            if (r0 == 0) goto L36
            r14.mProfileOffDeadline = r2
            r12.saveSettingsLocked(r13)
        L36:
            if (r15 == 0) goto L39
            r7 = 2
        L39:
            return r7
        L3a:
            boolean r6 = r14.mSuspendPersonalApps
            r9 = 1
            if (r6 == 0) goto L47
            int r2 = (r2 > r4 ? 1 : (r2 == r4 ? 0 : -1))
            if (r2 == 0) goto L70
            r14.mProfileOffDeadline = r4
        L45:
            r2 = r9
            goto L71
        L47:
            int r6 = (r2 > r4 ? 1 : (r2 == r4 ? 0 : -1))
            if (r6 == 0) goto L59
            long r10 = r14.mProfileMaximumTimeOffMillis
            int r6 = (r10 > r4 ? 1 : (r10 == r4 ? 0 : -1))
            if (r6 != 0) goto L59
            java.lang.String r2 = "Profile off deadline is reset to zero"
            com.android.server.utils.Slogf.i(r8, r2)
            r14.mProfileOffDeadline = r4
            goto L45
        L59:
            int r2 = (r2 > r4 ? 1 : (r2 == r4 ? 0 : -1))
            if (r2 != 0) goto L70
            long r2 = r14.mProfileMaximumTimeOffMillis
            int r2 = (r2 > r4 ? 1 : (r2 == r4 ? 0 : -1))
            if (r2 == 0) goto L70
            if (r15 == 0) goto L70
            java.lang.String r2 = "Profile off deadline is set."
            com.android.server.utils.Slogf.i(r8, r2)
            long r2 = r14.mProfileMaximumTimeOffMillis
            long r2 = r2 + r0
            r14.mProfileOffDeadline = r2
            goto L45
        L70:
            r2 = r7
        L71:
            if (r2 == 0) goto L76
            r12.saveSettingsLocked(r13)
        L76:
            if (r15 == 0) goto L8b
            long r13 = r14.mProfileOffDeadline
            int r15 = (r13 > r4 ? 1 : (r13 == r4 ? 0 : -1))
            if (r15 != 0) goto L7f
            goto L8b
        L7f:
            long r0 = r13 - r0
            long r2 = com.android.server.devicepolicy.DevicePolicyManagerService.MANAGED_PROFILE_OFF_WARNING_PERIOD
            int r15 = (r0 > r2 ? 1 : (r0 == r2 ? 0 : -1))
            if (r15 >= 0) goto L89
            r7 = r9
            goto L8c
        L89:
            long r13 = r13 - r2
            goto L8c
        L8b:
            r13 = r4
        L8c:
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r15 = r12.mInjector
            android.app.AlarmManager r15 = r15.getAlarmManager()
            android.content.Intent r0 = new android.content.Intent
            java.lang.String r1 = "com.android.server.ACTION_PROFILE_OFF_DEADLINE"
            r0.<init>(r1)
            android.content.Context r1 = r12.mContext
            java.lang.String r1 = r1.getPackageName()
            r0.setPackage(r1)
            com.android.server.devicepolicy.DevicePolicyManagerService$Injector r1 = r12.mInjector
            android.content.Context r12 = r12.mContext
            r2 = 5572(0x15c4, float:7.808E-42)
            r3 = 1275068416(0x4c000000, float:3.3554432E7)
            android.app.PendingIntent r12 = r1.pendingIntentGetBroadcast(r12, r2, r0, r3)
            int r0 = (r13 > r4 ? 1 : (r13 == r4 ? 0 : -1))
            if (r0 != 0) goto Lbb
            java.lang.String r13 = "Profile off deadline alarm is removed."
            com.android.server.utils.Slogf.i(r8, r13)
            r15.cancel(r12)
            goto Lc3
        Lbb:
            java.lang.String r0 = "Profile off deadline alarm is set."
            com.android.server.utils.Slogf.i(r8, r0)
            r15.set(r9, r13, r12)
        Lc3:
            return r7
        */
        throw new UnsupportedOperationException("Method not decompiled: com.android.server.devicepolicy.DevicePolicyManagerService.updateProfileOffDeadlineLocked(int, com.android.server.devicepolicy.ActiveAdmin, boolean):int");
    }

    public final void suspendPersonalAppsInternal(int i, int i2, boolean z) {
        if (lambda$getUserDataUnchecked$2(i).mAppsSuspended == z) {
            return;
        }
        Object[] objArr = new Object[2];
        objArr[0] = z ? "Suspending" : "Unsuspending";
        objArr[1] = Integer.valueOf(i);
        Slogf.i("DevicePolicyManager", "%s personal apps for user %d", objArr);
        if (isPolicyEngineForFinanceFlagEnabled()) {
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i2);
            if (profileOwnerAdminLocked != null) {
                this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.PERSONAL_APPS_SUSPENDED, EnforcingAdmin.createEnterpriseEnforcingAdmin(profileOwnerAdminLocked.info.getComponent(), i2, profileOwnerAdminLocked), new BooleanPolicyValue(z), i);
            }
        } else if (z) {
            suspendPersonalAppsInPackageManager(i);
        } else {
            this.mInjector.getPackageManagerInternal().unsuspendForSuspendingPackage("android", i);
        }
        synchronized (getLockObject()) {
            lambda$getUserDataUnchecked$2(i).mAppsSuspended = z;
            saveSettingsLocked(i);
        }
    }

    public final void suspendPersonalAppsInPackageManager(final int i) {
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda6
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$suspendPersonalAppsInPackageManager$168(i);
            }
        });
    }

    public /* synthetic */ void lambda$suspendPersonalAppsInPackageManager$168(int i) {
        String[] packagesSuspendedByAdmin = this.mInjector.getPackageManagerInternal().setPackagesSuspendedByAdmin(i, this.mInjector.getPersonalAppsForSuspension(i), true);
        if (ArrayUtils.isEmpty(packagesSuspendedByAdmin)) {
            return;
        }
        Slogf.wtf("DevicePolicyManager", "Failed to suspend apps: " + String.join(",", packagesSuspendedByAdmin));
    }

    public final void notifyIfManagedSubscriptionsAreUnavailable(UserHandle userHandle, boolean z) {
        if (!isManagedProfile(userHandle.getIdentifier())) {
            Slog.wtf("DevicePolicyManager", "Expected managed profile when notified of profile availability change.");
        }
        if (getManagedSubscriptionsPolicy().getPolicyType() != 1) {
            return;
        }
        if (z) {
            this.mInjector.getNotificationManager().cancel(1006);
            return;
        }
        Intent intent = new Intent(ACTION_TURN_PROFILE_ON_NOTIFICATION);
        intent.putExtra("android.intent.extra.user_handle", userHandle.getIdentifier());
        Notification.Action build = new Notification.Action.Builder((Icon) null, getUnpauseWorkAppsButtonText(), this.mInjector.pendingIntentGetBroadcast(this.mContext, 0, intent, 201326592)).build();
        Bundle bundle = new Bundle();
        bundle.putString("android.substName", getWorkProfileContentDescription());
        this.mInjector.getNotificationManager().notifyAsUser(null, 1006, new Notification.Builder(this.mContext, SystemNotificationChannels.DEVICE_ADMIN).setSmallIcon(R.drawable.ime_qwerty).setContentTitle(getUnpauseWorkAppsForTelephonyTitle()).setContentText(getUnpauseWorkAppsForTelephonyText()).setStyle(new Notification.BigTextStyle().bigText(getUnpauseWorkAppsForTelephonyText())).addAction(build).addExtras(bundle).setOngoing(false).setShowWhen(true).setAutoCancel(true).build(), UserHandle.of(getProfileParentId(userHandle.getIdentifier())));
    }

    public final String getUnpauseWorkAppsButtonText() {
        return getUpdatableString("Core.TURN_ON_WORK_PROFILE_BUTTON_TEXT", 17043417, new Object[0]);
    }

    public final String getUnpauseWorkAppsForTelephonyTitle() {
        return getUpdatableString("Core.WORK_PROFILE_TELEPHONY_UNAVAILABLE_TITLE", 17043416, new Object[0]);
    }

    public final String getUnpauseWorkAppsForTelephonyText() {
        return getUpdatableString("Core.WORK_PROFILE_TELEPHONY_UNAVAILABLE_BODY", 17043415, new Object[0]);
    }

    public final void updateProfileOffDeadlineNotificationLocked(final int i, ActiveAdmin activeAdmin, int i2) {
        String personalAppSuspensionText;
        if (i2 == 0) {
            this.mInjector.getNotificationManager().cancel(1003);
            return;
        }
        Intent intent = new Intent(ACTION_TURN_PROFILE_ON_NOTIFICATION);
        intent.setPackage(this.mContext.getPackageName());
        intent.putExtra("android.intent.extra.user_handle", i);
        Notification.Action build = new Notification.Action.Builder((Icon) null, getPersonalAppSuspensionButtonText(), this.mInjector.pendingIntentGetBroadcast(this.mContext, 0, intent, 201326592)).build();
        boolean z = true;
        if (i2 == 1) {
            long j = activeAdmin.mProfileMaximumTimeOffMillis;
            long j2 = MS_PER_DAY;
            personalAppSuspensionText = getPersonalAppSuspensionSoonText(DateUtils.formatDateTime(this.mContext, activeAdmin.mProfileOffDeadline, 16), DateUtils.formatDateTime(this.mContext, activeAdmin.mProfileOffDeadline, 1), (int) ((j + (j2 / 2)) / j2));
            z = false;
        } else {
            personalAppSuspensionText = getPersonalAppSuspensionText();
        }
        int color = this.mContext.getColor(17171169);
        Bundle bundle = new Bundle();
        bundle.putString("android.substName", getWorkProfileContentDescription());
        final Notification build2 = new Notification.Builder(this.mContext, SystemNotificationChannels.DEVICE_ADMIN).setSmallIcon(R.drawable.ic_jog_dial_answer).setOngoing(z).setAutoCancel(false).setContentTitle(getPersonalAppSuspensionTitle()).setContentText(personalAppSuspensionText).setStyle(new Notification.BigTextStyle().bigText(personalAppSuspensionText)).setColor(color).addAction(build).addExtras(bundle).build();
        this.mHandler.post(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda210
            @Override // java.lang.Runnable
            public final void run() {
                DevicePolicyManagerService.this.lambda$updateProfileOffDeadlineNotificationLocked$169(build2, i);
            }
        });
    }

    public /* synthetic */ void lambda$updateProfileOffDeadlineNotificationLocked$169(Notification notification, int i) {
        this.mInjector.getNotificationManager().notifyAsUser(null, 1003, notification, UserHandle.of(getProfileParentId(i)));
    }

    public final String getPersonalAppSuspensionButtonText() {
        return getUpdatableString("Core.PERSONAL_APP_SUSPENSION_TURN_ON_PROFILE", 17042235, new Object[0]);
    }

    public final String getPersonalAppSuspensionTitle() {
        return getUpdatableString("Core.PERSONAL_APP_SUSPENSION_TITLE", 17042238, new Object[0]);
    }

    public final String getPersonalAppSuspensionText() {
        return getUpdatableString("Core.PERSONAL_APP_SUSPENSION_MESSAGE", 17042237, new Object[0]);
    }

    public final String getPersonalAppSuspensionSoonText(String str, String str2, int i) {
        return getUpdatableString("Core.PERSONAL_APP_SUSPENSION_SOON_MESSAGE", 17042236, str, str2, Integer.valueOf(i));
    }

    public final String getWorkProfileContentDescription() {
        return getUpdatableString("Core.NOTIFICATION_WORK_PROFILE_CONTENT_DESCRIPTION", 17041590, new Object[0]);
    }

    public void setManagedProfileMaximumTimeOff(ComponentName componentName, long j) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkArgumentNonnegative(j, "Timeout must be non-negative.");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        Preconditions.checkState(canHandleCheckPolicyComplianceIntent(callerIdentity));
        final int userId = callerIdentity.getUserId();
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(userId);
            if (j > 0) {
                long j2 = MANAGED_PROFILE_MAXIMUM_TIME_OFF_THRESHOLD;
                if (j < j2 && !isAdminTestOnlyLocked(componentName, userId)) {
                    j = j2;
                }
            }
            if (profileOwnerLocked.mProfileMaximumTimeOffMillis == j) {
                return;
            }
            profileOwnerLocked.mProfileMaximumTimeOffMillis = j;
            saveSettingsLocked(userId);
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda181
                public final Object getOrThrow() {
                    Boolean lambda$setManagedProfileMaximumTimeOff$170;
                    lambda$setManagedProfileMaximumTimeOff$170 = DevicePolicyManagerService.this.lambda$setManagedProfileMaximumTimeOff$170(userId);
                    return lambda$setManagedProfileMaximumTimeOff$170;
                }
            });
            DevicePolicyEventLogger.createEvent(136).setAdmin(callerIdentity.getComponentName()).setTimePeriod(j).write();
        }
    }

    public /* synthetic */ Boolean lambda$setManagedProfileMaximumTimeOff$170(int i) {
        return Boolean.valueOf(updatePersonalAppsSuspension(i));
    }

    public final boolean canHandleCheckPolicyComplianceIntent(final CallerIdentity callerIdentity) {
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda218
            public final Object getOrThrow() {
                Boolean lambda$canHandleCheckPolicyComplianceIntent$171;
                lambda$canHandleCheckPolicyComplianceIntent$171 = DevicePolicyManagerService.this.lambda$canHandleCheckPolicyComplianceIntent$171(callerIdentity);
                return lambda$canHandleCheckPolicyComplianceIntent$171;
            }
        });
        return true;
    }

    public /* synthetic */ Boolean lambda$canHandleCheckPolicyComplianceIntent$171(CallerIdentity callerIdentity) {
        new Intent("android.app.action.CHECK_POLICY_COMPLIANCE").setPackage(callerIdentity.getPackageName());
        return Boolean.valueOf(!this.mInjector.getPackageManager().queryIntentActivitiesAsUser(r0, 0, callerIdentity.getUserId()).isEmpty());
    }

    public long getManagedProfileMaximumTimeOff(ComponentName componentName) {
        long j;
        Objects.requireNonNull(componentName, "ComponentName is null");
        CallerIdentity callerIdentity = getCallerIdentity(componentName);
        Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        synchronized (getLockObject()) {
            j = getProfileOwnerLocked(callerIdentity.getUserId()).mProfileMaximumTimeOffMillis;
        }
        return j;
    }

    public void acknowledgeDeviceCompliant() {
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        enforceUserUnlocked(callerIdentity.getUserId());
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
            if (profileOwnerLocked.mProfileOffDeadline > 0) {
                profileOwnerLocked.mProfileOffDeadline = 0L;
                saveSettingsLocked(callerIdentity.getUserId());
            }
        }
    }

    public boolean isComplianceAcknowledgementRequired() {
        boolean z;
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        enforceUserUnlocked(callerIdentity.getUserId());
        synchronized (getLockObject()) {
            z = getProfileOwnerLocked(callerIdentity.getUserId()).mProfileOffDeadline != 0;
        }
        return z;
    }

    public boolean canProfileOwnerResetPasswordWhenLocked(int i) {
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()), String.format("Only the system can %s", "call canProfileOwnerResetPasswordWhenLocked"));
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            if (profileOwnerAdminLocked == null || getEncryptionStatus() != 5 || !isResetPasswordTokenActiveForUserLocked(lambda$getUserDataUnchecked$2.mPasswordTokenHandle, i)) {
                return false;
            }
            try {
                ApplicationInfo applicationInfo = this.mIPackageManager.getApplicationInfo(profileOwnerAdminLocked.info.getPackageName(), 0L, i);
                if (applicationInfo == null) {
                    Slogf.wtf("DevicePolicyManager", "Cannot find AppInfo for profile owner");
                    return false;
                }
                if (!applicationInfo.isEncryptionAware()) {
                    return false;
                }
                Slogf.d("DevicePolicyManager", "PO should be able to reset password from direct boot");
                return true;
            } catch (RemoteException e) {
                Slogf.e("DevicePolicyManager", "Failed to query PO app info", e);
                return false;
            }
        }
    }

    public ActiveAdmin getActiveAdminForCallerLockedMDM(ComponentName componentName, int i, int i2) {
        ensureLocked();
        ActiveAdmin activeAdminWithPolicyLockedMDM = getActiveAdminWithPolicyLockedMDM(componentName, i, i2);
        if (activeAdminWithPolicyLockedMDM != null) {
            return activeAdminWithPolicyLockedMDM;
        }
        if (componentName != null) {
            ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2(i2).mAdminMap.get(componentName);
            throw new SecurityException("Admin " + activeAdmin.info.getComponent() + " did not specify uses-policy for: " + activeAdmin.info.getTagForPolicy(i));
        }
        throw new SecurityException("No active admin owned by uid " + this.mInjector.binderGetCallingUid() + " for policy #" + i);
    }

    public ActiveAdmin getActiveAdminForCallerLockedMDM(ComponentName componentName, int i, int i2, boolean z) {
        ensureLocked();
        ActiveAdmin activeAdminWithPolicyLockedMDM = getActiveAdminWithPolicyLockedMDM(componentName, i, i2);
        if (activeAdminWithPolicyLockedMDM != null) {
            return z ? activeAdminWithPolicyLockedMDM.getParentActiveAdmin() : activeAdminWithPolicyLockedMDM;
        }
        if (componentName != null) {
            ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2(i2).mAdminMap.get(componentName);
            throw new SecurityException("Admin " + activeAdmin.info.getComponent() + " did not specify uses-policy for: " + activeAdmin.info.getTagForPolicy(i));
        }
        throw new SecurityException("No active admin owned by uid " + this.mInjector.binderGetCallingUid() + " for policy #" + i);
    }

    public final ActiveAdmin getActiveAdminWithPolicyLockedMDM(ComponentName componentName, int i, int i2) {
        ensureLocked();
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i2);
        if (componentName != null) {
            ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminMap.get(componentName);
            if (activeAdmin == null) {
                throw new SecurityException("No active admin " + componentName);
            }
            if (this.mInjector.binderGetCallingPid() == Process.myPid() && isActiveAdminWithPolicyForUserLockedMDM(activeAdmin, i, i2)) {
                return activeAdmin;
            }
            return null;
        }
        Iterator it = lambda$getUserDataUnchecked$2.mAdminList.iterator();
        while (it.hasNext()) {
            ActiveAdmin activeAdmin2 = (ActiveAdmin) it.next();
            if (this.mInjector.binderGetCallingPid() == Process.myPid() && isActiveAdminWithPolicyForUserLockedMDM(activeAdmin2, i, i2)) {
                return activeAdmin2;
            }
        }
        return null;
    }

    public boolean isActiveAdminWithPolicyForUserLockedMDM(ActiveAdmin activeAdmin, int i, int i2) {
        ensureLocked();
        return isDeviceOwner(activeAdmin.info.getComponent(), i2) || isProfileOwner(activeAdmin.info.getComponent(), i2) || activeAdmin.info.usesPolicy(i);
    }

    public final void enforceCrossUserPermissionODE(int i) {
        if (i < 0) {
            throw new IllegalArgumentException("Invalid userId " + i);
        }
        int binderGetCallingUid = this.mInjector.binderGetCallingUid();
        if (i == UserHandle.getUserId(binderGetCallingUid) || binderGetCallingUid == 1000 || binderGetCallingUid == 0) {
            return;
        }
        this.mContext.enforceCallingOrSelfPermission("android.permission.INTERACT_ACROSS_USERS_FULL", "Must be system or have INTERACT_ACROSS_USERS_FULL permission");
    }

    public boolean getSamsungSDcardEncryptionStatus(ComponentName componentName, int i) {
        if (!this.mHasFeature) {
            return false;
        }
        enforceCrossUserPermissionODE(i);
        SemSdCardEncryption semSdCardEncryption = new SemSdCardEncryption(this.mContext);
        if (semSdCardEncryption.getCurrentUserID() != 0) {
            return false;
        }
        return semGetRequireStorageCardEncryption(componentName, i, false) || semSdCardEncryption.isSdCardEncryped() || semSdCardEncryption.getCurrentStatus() == 3;
    }

    public String getEnrollmentSpecificId(String str) {
        String str2;
        if (!this.mHasFeature) {
            return "";
        }
        CallerIdentity callerIdentity = getCallerIdentity(str);
        Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity) || isCallerDelegate(callerIdentity, "delegation-cert-install"));
        synchronized (getLockObject()) {
            str2 = getDeviceOrProfileOwnerAdminLocked(callerIdentity.getUserId()).mEnrollmentSpecificId;
            if (str2 == null) {
                str2 = "";
            }
        }
        return str2;
    }

    public void setOrganizationIdForUser(String str, String str2, int i) {
        String packageName;
        if (this.mHasFeature) {
            Objects.requireNonNull(str);
            CallerIdentity callerIdentity = getCallerIdentity(str);
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity), "Only a Device Owner or Profile Owner may set the Enterprise ID.");
            Preconditions.checkArgument(!TextUtils.isEmpty(str2), "Enterprise ID may not be empty.");
            Slogf.i("DevicePolicyManager", "Setting Enterprise ID to %s for user %d", str2, Integer.valueOf(i));
            synchronized (this.mESIDInitilizationLock) {
                if (this.mEsidCalculator == null) {
                    this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda39
                        public final void runOrThrow() {
                            DevicePolicyManagerService.this.lambda$setOrganizationIdForUser$172();
                        }
                    });
                }
            }
            synchronized (getLockObject()) {
                ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(i);
                Preconditions.checkCallAuthorization(deviceOrProfileOwnerAdminLocked != null && deviceOrProfileOwnerAdminLocked.getUserHandle().getIdentifier() == i, String.format("The Profile Owner or Device Owner may only set the Enterprise ID on its own user, called on user %d but owner user is %d", Integer.valueOf(i), Integer.valueOf(deviceOrProfileOwnerAdminLocked.getUserHandle().getIdentifier())));
                packageName = deviceOrProfileOwnerAdminLocked.info.getPackageName();
                Preconditions.checkState(TextUtils.isEmpty(deviceOrProfileOwnerAdminLocked.mOrganizationId) || deviceOrProfileOwnerAdminLocked.mOrganizationId.equals(str2), "The organization ID has been previously set to a different value and cannot be changed");
                String calculateEnterpriseId = this.mEsidCalculator.calculateEnterpriseId(deviceOrProfileOwnerAdminLocked.info.getPackageName(), str2);
                deviceOrProfileOwnerAdminLocked.mOrganizationId = str2;
                deviceOrProfileOwnerAdminLocked.mEnrollmentSpecificId = calculateEnterpriseId;
                saveSettingsLocked(i);
            }
            DevicePolicyEventLogger.createEvent(FrameworkStatsLog.DEVICE_POLICY_EVENT__EVENT_ID__SET_ORGANIZATION_ID).setAdmin(packageName).setBoolean(isManagedProfile(i)).write();
        }
    }

    public /* synthetic */ void lambda$setOrganizationIdForUser$172() {
        this.mEsidCalculator = this.mInjector.newEnterpriseSpecificIdCalculator();
    }

    public void clearOrganizationIdForUser(int i) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        synchronized (getLockObject()) {
            ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(i);
            deviceOrProfileOwnerAdminLocked.mOrganizationId = null;
            deviceOrProfileOwnerAdminLocked.mEnrollmentSpecificId = null;
            saveSettingsLocked(i);
        }
    }

    public UserHandle createAndProvisionManagedProfile(ManagedProfileProvisioningParams managedProfileProvisioningParams, String str) {
        UserInfo userInfo;
        Set nonRequiredApps;
        Objects.requireNonNull(managedProfileProvisioningParams, "provisioningParams is null");
        Objects.requireNonNull(str, "callerPackage is null");
        ComponentName profileAdminComponentName = managedProfileProvisioningParams.getProfileAdminComponentName();
        Objects.requireNonNull(profileAdminComponentName, "admin is null");
        CallerIdentity callerIdentity = getCallerIdentity(str);
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        managedProfileProvisioningParams.logParams(str);
        long clearCallingIdentity = Binder.clearCallingIdentity();
        try {
            try {
                int checkProvisioningPreconditionSkipPermission = checkProvisioningPreconditionSkipPermission("android.app.action.PROVISION_MANAGED_PROFILE", profileAdminComponentName.getPackageName(), callerIdentity.getUserId());
                if (checkProvisioningPreconditionSkipPermission != 0) {
                    throw new ServiceSpecificException(1, "Provisioning preconditions failed with result: " + checkProvisioningPreconditionSkipPermission);
                }
                long elapsedRealtime = SystemClock.elapsedRealtime();
                onCreateAndProvisionManagedProfileStarted(managedProfileProvisioningParams);
                if (managedProfileProvisioningParams.isLeaveAllSystemAppsEnabled()) {
                    nonRequiredApps = Collections.emptySet();
                } else {
                    nonRequiredApps = this.mOverlayPackagesProvider.getNonRequiredApps(profileAdminComponentName, callerIdentity.getUserId(), "android.app.action.PROVISION_MANAGED_PROFILE");
                }
                if (nonRequiredApps.isEmpty()) {
                    Slogf.i("DevicePolicyManager", "No disallowed packages for the managed profile.");
                } else {
                    Iterator it = nonRequiredApps.iterator();
                    while (it.hasNext()) {
                        Slogf.i("DevicePolicyManager", "Disallowed package [" + ((String) it.next()) + "]");
                    }
                }
                UserInfo createProfileForUserEvenWhenDisallowed = this.mUserManager.createProfileForUserEvenWhenDisallowed(managedProfileProvisioningParams.getProfileName(), "android.os.usertype.profile.MANAGED", this.mDualDarProvisioningHelper.getDualDarProfileFlags(managedProfileProvisioningParams), callerIdentity.getUserId(), (String[]) nonRequiredApps.toArray(new String[nonRequiredApps.size()]));
                try {
                    if (createProfileForUserEvenWhenDisallowed == null) {
                        throw new ServiceSpecificException(2, "Error creating profile, createProfileForUserEvenWhenDisallowed returned null.");
                    }
                    resetInteractAcrossProfilesAppOps(callerIdentity.getUserId());
                    Bundle provisioningState = KnoxContainerManager.getProvisioningState();
                    provisioningState.putInt(LauncherConfigurationInternal.KEY_STATE_BOOLEAN, 3);
                    provisioningState.putInt(KnoxCustomManagerService.CONTAINER_ID_ZERO, createProfileForUserEvenWhenDisallowed.id);
                    KnoxContainerManager.updateProvisioningState(provisioningState);
                    KnoxUtils.disableDocumentsUIComponent(createProfileForUserEvenWhenDisallowed.id);
                    logEventDuration(191, elapsedRealtime, str);
                    maybeInstallDevicePolicyManagementRoleHolderInUser(createProfileForUserEvenWhenDisallowed.id);
                    installExistingAdminPackage(createProfileForUserEvenWhenDisallowed.id, profileAdminComponentName.getPackageName());
                    if (!enableAdminAndSetProfileOwner(createProfileForUserEvenWhenDisallowed.id, callerIdentity.getUserId(), profileAdminComponentName)) {
                        throw new ServiceSpecificException(4, "Error setting profile owner.");
                    }
                    setUserSetupComplete(createProfileForUserEvenWhenDisallowed.id);
                    startProfileForSetup(createProfileForUserEvenWhenDisallowed.id, str);
                    maybeMigrateAccount(createProfileForUserEvenWhenDisallowed.id, callerIdentity.getUserId(), managedProfileProvisioningParams.getAccountToMigrate(), managedProfileProvisioningParams.isKeepingAccountOnMigration(), str);
                    if (managedProfileProvisioningParams.isOrganizationOwnedProvisioning()) {
                        synchronized (getLockObject()) {
                            setProfileOwnerOnOrganizationOwnedDeviceUncheckedLocked(profileAdminComponentName, createProfileForUserEvenWhenDisallowed.id, true);
                        }
                        if (TextUtils.isEmpty(SystemProperties.get("persist.ril.config.defaultmsgapp"))) {
                            Slog.d("DevicePolicyManager", "defaultmsgapp empty");
                            SmsApplication.setDefaultMessageAppConfig(this.mContext);
                        }
                        Slog.d("DevicePolicyManager", "getDefaultSmsApplication = " + SmsApplication.getDefaultSmsApplication(this.mContext, true));
                    }
                    onCreateAndProvisionManagedProfileCompleted(managedProfileProvisioningParams, createProfileForUserEvenWhenDisallowed.id);
                    KnoxUtils.setKnoxWorkChallengeRequiredComponent(this.mContext, ((ActiveAdmin) lambda$getUserDataUnchecked$2(createProfileForUserEvenWhenDisallowed.id).mAdminMap.get(profileAdminComponentName)).getUid(), createProfileForUserEvenWhenDisallowed.id);
                    sendProvisioningCompletedBroadcast(createProfileForUserEvenWhenDisallowed.id, "android.app.action.PROVISION_MANAGED_PROFILE", managedProfileProvisioningParams.isLeaveAllSystemAppsEnabled());
                    Bundle provisioningState2 = KnoxContainerManager.getProvisioningState();
                    provisioningState2.putInt(LauncherConfigurationInternal.KEY_STATE_BOOLEAN, 10);
                    KnoxContainerManager.updateProvisioningState(provisioningState2);
                    return createProfileForUserEvenWhenDisallowed.getUserHandle();
                } catch (Exception e) {
                    e = e;
                    userInfo = createProfileForUserEvenWhenDisallowed;
                    DevicePolicyEventLogger.createEvent(FrameworkStatsLog.DEVICE_POLICY_EVENT__EVENT_ID__PLATFORM_PROVISIONING_ERROR).setStrings(new String[]{str}).write();
                    if (userInfo != null) {
                        this.mUserManager.removeUserEvenWhenDisallowed(userInfo.id);
                    }
                    throw e;
                }
            } catch (Exception e2) {
                e = e2;
                userInfo = null;
            }
        } finally {
            Binder.restoreCallingIdentity(clearCallingIdentity);
        }
    }

    public void finalizeWorkProfileProvisioning(UserHandle userHandle, Account account) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        if (!isManagedProfile(userHandle.getIdentifier())) {
            throw new IllegalStateException("Given user is not a managed profile");
        }
        ComponentName profileOwnerComponent = this.mOwners.getProfileOwnerComponent(userHandle.getIdentifier());
        if (profileOwnerComponent == null) {
            throw new IllegalStateException("There is no profile owner on the given profile");
        }
        Intent intent = new Intent("android.app.action.MANAGED_PROFILE_PROVISIONED");
        intent.setPackage(profileOwnerComponent.getPackageName());
        intent.addFlags(268435488);
        intent.putExtra("android.intent.extra.USER", userHandle);
        if (account != null) {
            intent.putExtra("android.app.extra.PROVISIONING_ACCOUNT_TO_MIGRATE", account);
        }
        this.mContext.sendBroadcastAsUser(intent, UserHandle.of(getProfileParentId(userHandle.getIdentifier())));
    }

    public final void onCreateAndProvisionManagedProfileStarted(ManagedProfileProvisioningParams managedProfileProvisioningParams) {
        this.mDualDarProvisioningHelper.onCreateAndProvisioningManagedProfileStartedForDualDar(managedProfileProvisioningParams);
    }

    public final void onCreateAndProvisionManagedProfileCompleted(ManagedProfileProvisioningParams managedProfileProvisioningParams, int i) {
        this.mDualDarProvisioningHelper.onCreateAndProvisioningManagedProfileCompletedForDualDar(managedProfileProvisioningParams, i);
    }

    public final void maybeInstallDevicePolicyManagementRoleHolderInUser(int i) {
        String roleHolderPackageName = getRoleHolderPackageName(this.mContext, "android.app.role.DEVICE_POLICY_MANAGEMENT");
        if (roleHolderPackageName == null) {
            Slogf.d("DevicePolicyManager", "No device policy management role holder specified.");
            return;
        }
        try {
            if (this.mIPackageManager.isPackageAvailable(roleHolderPackageName, i)) {
                Slogf.d("DevicePolicyManager", "The device policy management role holder " + roleHolderPackageName + " is already installed in user " + i);
                return;
            }
            Slogf.d("DevicePolicyManager", "Installing the device policy management role holder " + roleHolderPackageName + " in user " + i);
            this.mIPackageManager.installExistingPackageAsUser(roleHolderPackageName, i, 4194304, 1, (List) null);
        } catch (RemoteException unused) {
        }
    }

    public final String getRoleHolderPackageName(Context context, String str) {
        return getRoleHolderPackageNameOnUser(context, str, Process.myUserHandle());
    }

    public final String getRoleHolderPackageNameOnUser(Context context, final String str, final UserHandle userHandle) {
        final RoleManager roleManager = (RoleManager) context.getSystemService(RoleManager.class);
        return (String) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda138
            public final Object getOrThrow() {
                String lambda$getRoleHolderPackageNameOnUser$173;
                lambda$getRoleHolderPackageNameOnUser$173 = DevicePolicyManagerService.lambda$getRoleHolderPackageNameOnUser$173(roleManager, str, userHandle);
                return lambda$getRoleHolderPackageNameOnUser$173;
            }
        });
    }

    public static /* synthetic */ String lambda$getRoleHolderPackageNameOnUser$173(RoleManager roleManager, String str, UserHandle userHandle) {
        List roleHoldersAsUser = roleManager.getRoleHoldersAsUser(str, userHandle);
        if (roleHoldersAsUser.isEmpty()) {
            return null;
        }
        return (String) roleHoldersAsUser.get(0);
    }

    public final boolean isCallerDevicePolicyManagementRoleHolder(CallerIdentity callerIdentity) {
        return doesCallerHoldRole(callerIdentity, "android.app.role.DEVICE_POLICY_MANAGEMENT");
    }

    public final boolean isCallerSystemSupervisionRoleHolder(CallerIdentity callerIdentity) {
        return doesCallerHoldRole(callerIdentity, "android.app.role.SYSTEM_SUPERVISION");
    }

    public final boolean doesCallerHoldRole(CallerIdentity callerIdentity, String str) {
        return callerIdentity.getUid() == this.mInjector.getPackageManagerInternal().getPackageUid(getRoleHolderPackageNameOnUser(str, callerIdentity.getUserId()), 0L, callerIdentity.getUserId());
    }

    public final String getRoleHolderPackageNameOnUser(final String str, final int i) {
        final RoleManager roleManager = (RoleManager) this.mContext.getSystemService(RoleManager.class);
        return (String) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda191
            public final Object getOrThrow() {
                String lambda$getRoleHolderPackageNameOnUser$174;
                lambda$getRoleHolderPackageNameOnUser$174 = DevicePolicyManagerService.this.lambda$getRoleHolderPackageNameOnUser$174(i, roleManager, str);
                return lambda$getRoleHolderPackageNameOnUser$174;
            }
        });
    }

    public /* synthetic */ String lambda$getRoleHolderPackageNameOnUser$174(int i, RoleManager roleManager, String str) {
        List of;
        if (i == -1) {
            of = this.mInjector.getUserManagerInternal().getUsers(true);
        } else {
            of = List.of(new UserInfo(i, (String) null, 0));
        }
        Iterator it = of.iterator();
        while (it.hasNext()) {
            List roleHoldersAsUser = roleManager.getRoleHoldersAsUser(str, ((UserInfo) it.next()).getUserHandle());
            if (!roleHoldersAsUser.isEmpty()) {
                return (String) roleHoldersAsUser.get(0);
            }
        }
        return null;
    }

    public final void resetInteractAcrossProfilesAppOps(int i) {
        this.mInjector.getCrossProfileApps(i).clearInteractAcrossProfilesAppOps();
        pregrantDefaultInteractAcrossProfilesAppOps(i);
    }

    public final void pregrantDefaultInteractAcrossProfilesAppOps(int i) {
        String permissionToOp = AppOpsManager.permissionToOp("android.permission.INTERACT_ACROSS_PROFILES");
        for (String str : getConfigurableDefaultCrossProfilePackages(i)) {
            if (appOpIsDefaultOrAllowed(i, permissionToOp, str)) {
                this.mInjector.getCrossProfileApps(i).setInteractAcrossProfilesAppOp(str, 0);
            }
        }
    }

    public final Set getConfigurableDefaultCrossProfilePackages(int i) {
        Stream stream = getDefaultCrossProfilePackages().stream();
        final CrossProfileApps crossProfileApps = this.mInjector.getCrossProfileApps(i);
        Objects.requireNonNull(crossProfileApps);
        return (Set) stream.filter(new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda49
            @Override // java.util.function.Predicate
            public final boolean test(Object obj) {
                return crossProfileApps.canConfigureInteractAcrossProfiles((String) obj);
            }
        }).collect(Collectors.toSet());
    }

    public final boolean appOpIsDefaultOrAllowed(int i, String str, String str2) {
        try {
            int unsafeCheckOpNoThrow = this.mInjector.getAppOpsManager().unsafeCheckOpNoThrow(str, this.mContext.createContextAsUser(UserHandle.of(i), 0).getPackageManager().getPackageUid(str2, 0), str2);
            return unsafeCheckOpNoThrow == 0 || unsafeCheckOpNoThrow == 3;
        } catch (PackageManager.NameNotFoundException unused) {
            return false;
        }
    }

    public final void installExistingAdminPackage(int i, String str) {
        try {
            int installExistingPackageAsUser = this.mContext.getPackageManager().installExistingPackageAsUser(str, i);
            if (installExistingPackageAsUser == 1) {
            } else {
                throw new ServiceSpecificException(3, String.format("Failed to install existing package %s for user %d with result code %d", str, Integer.valueOf(i), Integer.valueOf(installExistingPackageAsUser)));
            }
        } catch (PackageManager.NameNotFoundException e) {
            throw new ServiceSpecificException(3, String.format("Failed to install existing package %s for user %d: %s", str, Integer.valueOf(i), e.getMessage()));
        }
    }

    public final boolean enableAdminAndSetProfileOwner(int i, int i2, ComponentName componentName) {
        enableAndSetActiveAdmin(i, i2, componentName);
        return setProfileOwner(componentName, i);
    }

    public final void enableAndSetActiveAdmin(int i, int i2, ComponentName componentName) {
        enablePackage(componentName.getPackageName(), i2);
        setActiveAdmin(componentName, true, i);
    }

    public final void enablePackage(String str, int i) {
        try {
            int applicationEnabledSetting = this.mIPackageManager.getApplicationEnabledSetting(str, i);
            if (applicationEnabledSetting == 0 || applicationEnabledSetting == 1) {
                return;
            }
            this.mIPackageManager.setApplicationEnabledSetting(str, 0, 1, i, this.mContext.getOpPackageName());
        } catch (RemoteException e) {
            Slogf.wtf("DevicePolicyManager", "Error setting application enabled", e);
        }
    }

    public final void setUserSetupComplete(int i) {
        Settings.Secure.putIntForUser(this.mContext.getContentResolver(), "user_setup_complete", 1, i);
    }

    public final void startProfileForSetup(int i, String str) {
        Slogf.i("DevicePolicyManager", "Starting profile %d as requested by package %s", Integer.valueOf(i), str);
        long elapsedRealtime = SystemClock.elapsedRealtime();
        UserUnlockedBlockingReceiver userUnlockedBlockingReceiver = new UserUnlockedBlockingReceiver(i);
        this.mContext.registerReceiverAsUser(userUnlockedBlockingReceiver, new UserHandle(i), new IntentFilter("android.intent.action.USER_UNLOCKED"), null, null);
        try {
            if (!this.mInjector.getActivityManagerInternal().startProfileEvenWhenDisabled(i)) {
                throw new ServiceSpecificException(5, String.format("Unable to start user %d in background", Integer.valueOf(i)));
            }
            if (!userUnlockedBlockingReceiver.waitForUserUnlocked()) {
                throw new ServiceSpecificException(5, String.format("Timeout whilst waiting for unlock of user %d.", Integer.valueOf(i)));
            }
            logEventDuration(192, elapsedRealtime, str);
        } finally {
            this.mContext.unregisterReceiver(userUnlockedBlockingReceiver);
        }
    }

    public final void maybeMigrateAccount(int i, int i2, Account account, boolean z, String str) {
        UserHandle of = UserHandle.of(i2);
        UserHandle of2 = UserHandle.of(i);
        if (account == null) {
            Slogf.d("DevicePolicyManager", "No account to migrate.");
            return;
        }
        if (of.equals(of2)) {
            Slogf.w("DevicePolicyManager", "sourceUser and targetUser are the same, won't migrate account.");
            return;
        }
        copyAccount(of2, of, account, str);
        if (z) {
            return;
        }
        removeAccount(account, i2);
    }

    public final void copyAccount(UserHandle userHandle, UserHandle userHandle2, Account account, String str) {
        long elapsedRealtime = SystemClock.elapsedRealtime();
        try {
            if (((Boolean) ((AccountManager) this.mContext.getSystemService(AccountManager.class)).copyAccountToUser(account, userHandle2, userHandle, null, null).getResult(180L, TimeUnit.SECONDS)).booleanValue()) {
                logCopyAccountStatus(1, str);
                logEventDuration(190, elapsedRealtime, str);
            } else {
                logCopyAccountStatus(2, str);
                Slogf.e("DevicePolicyManager", "Failed to copy account to " + userHandle);
            }
        } catch (AuthenticatorException | IOException e) {
            logCopyAccountStatus(4, str);
            Slogf.e("DevicePolicyManager", "Exception copying account to " + userHandle, e);
        } catch (OperationCanceledException e2) {
            logCopyAccountStatus(3, str);
            Slogf.e("DevicePolicyManager", "Exception copying account to " + userHandle, e2);
        }
    }

    public static void logCopyAccountStatus(int i, String str) {
        DevicePolicyEventLogger.createEvent(193).setInt(i).setStrings(new String[]{str}).write();
    }

    public final void removeAccount(Account account, int i) {
        try {
            Bundle result = ((AccountManager) this.mContext.createContextAsUser(UserHandle.of(i), 0).getSystemService(AccountManager.class)).removeAccount(account, null, null, null).getResult(60L, TimeUnit.SECONDS);
            if (result.getBoolean("booleanResult", false)) {
                Slogf.i("DevicePolicyManager", "Account removed from the primary user.");
            } else {
                final Intent intent = (Intent) result.getParcelable(KnoxCustomManagerService.INTENT, Intent.class);
                intent.addFlags(268435456);
                Slogf.i("DevicePolicyManager", "Starting activity to remove account");
                new Handler(Looper.getMainLooper()).post(new Runnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda48
                    @Override // java.lang.Runnable
                    public final void run() {
                        DevicePolicyManagerService.this.lambda$removeAccount$175(intent);
                    }
                });
            }
        } catch (AuthenticatorException | OperationCanceledException | IOException e) {
            Slogf.e("DevicePolicyManager", "Exception removing account from the primary user.", e);
        }
    }

    public /* synthetic */ void lambda$removeAccount$175(Intent intent) {
        this.mContext.startActivity(intent);
    }

    public void provisionFullyManagedDevice(FullyManagedDeviceProvisioningParams fullyManagedDeviceProvisioningParams, String str) {
        Objects.requireNonNull(fullyManagedDeviceProvisioningParams, "provisioningParams is null.");
        Objects.requireNonNull(str, "callerPackage is null.");
        ComponentName deviceAdminComponentName = fullyManagedDeviceProvisioningParams.getDeviceAdminComponentName();
        Objects.requireNonNull(deviceAdminComponentName, "admin is null.");
        Objects.requireNonNull(fullyManagedDeviceProvisioningParams.getOwnerName(), "owner name is null.");
        CallerIdentity callerIdentity = getCallerIdentity();
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS") || (hasCallingOrSelfPermission("android.permission.PROVISION_DEMO_DEVICE") && fullyManagedDeviceProvisioningParams.isDemoDevice()));
        fullyManagedDeviceProvisioningParams.logParams(str);
        long clearCallingIdentity = Binder.clearCallingIdentity();
        try {
            try {
                int checkProvisioningPreconditionSkipPermission = checkProvisioningPreconditionSkipPermission("android.app.action.PROVISION_MANAGED_DEVICE", deviceAdminComponentName.getPackageName(), callerIdentity.getUserId());
                if (checkProvisioningPreconditionSkipPermission != 0) {
                    throw new ServiceSpecificException(1, "Provisioning preconditions failed with result: " + checkProvisioningPreconditionSkipPermission);
                }
                onProvisionFullyManagedDeviceStarted(fullyManagedDeviceProvisioningParams);
                setTimeAndTimezone(fullyManagedDeviceProvisioningParams.getTimeZone(), fullyManagedDeviceProvisioningParams.getLocalTime());
                setLocale(fullyManagedDeviceProvisioningParams.getLocale());
                if (!removeNonRequiredAppsForManagedDevice(0, fullyManagedDeviceProvisioningParams.isLeaveAllSystemAppsEnabled(), deviceAdminComponentName)) {
                    throw new ServiceSpecificException(6, "PackageManager failed to remove non required apps.");
                }
                if (!setActiveAdminAndDeviceOwner(0, deviceAdminComponentName)) {
                    throw new ServiceSpecificException(7, "Failed to set device owner.");
                }
                disallowAddUser();
                setAdminCanGrantSensorsPermissionForUserUnchecked(0, fullyManagedDeviceProvisioningParams.canDeviceOwnerGrantSensorsPermissions());
                setDemoDeviceStateUnchecked(0, fullyManagedDeviceProvisioningParams.isDemoDevice());
                onProvisionFullyManagedDeviceCompleted(fullyManagedDeviceProvisioningParams);
                sendProvisioningCompletedBroadcast(0, "android.app.action.PROVISION_MANAGED_DEVICE", fullyManagedDeviceProvisioningParams.isLeaveAllSystemAppsEnabled());
            } catch (Exception e) {
                DevicePolicyEventLogger.createEvent(FrameworkStatsLog.DEVICE_POLICY_EVENT__EVENT_ID__PLATFORM_PROVISIONING_ERROR).setStrings(new String[]{str}).write();
                throw e;
            }
        } finally {
            Binder.restoreCallingIdentity(clearCallingIdentity);
        }
    }

    public final void onProvisionFullyManagedDeviceStarted(FullyManagedDeviceProvisioningParams fullyManagedDeviceProvisioningParams) {
        this.mDualDarProvisioningHelper.onProvisionFullyManagedDeviceStartedForDualDar(fullyManagedDeviceProvisioningParams);
    }

    public final void onProvisionFullyManagedDeviceCompleted(FullyManagedDeviceProvisioningParams fullyManagedDeviceProvisioningParams) {
        this.mDualDarProvisioningHelper.onProvisionFullyManagedDeviceCompletedForDualDar(fullyManagedDeviceProvisioningParams);
    }

    public final void setTimeAndTimezone(String str, long j) {
        try {
            AlarmManager alarmManager = (AlarmManager) this.mContext.getSystemService(AlarmManager.class);
            if (str != null) {
                alarmManager.setTimeZone(str);
            }
            if (j > 0) {
                alarmManager.setTime(j);
            }
        } catch (Exception e) {
            Slogf.e("DevicePolicyManager", "Alarm manager failed to set the system time/timezone.", e);
        }
    }

    public final void setLocale(Locale locale) {
        if (locale == null || locale.equals(Locale.getDefault())) {
            return;
        }
        try {
            LocalePicker.updateLocale(locale);
        } catch (Exception e) {
            Slogf.e("DevicePolicyManager", "Failed to set the system locale.", e);
        }
    }

    public final boolean removeNonRequiredAppsForManagedDevice(int i, boolean z, ComponentName componentName) {
        Set<String> nonRequiredApps;
        if (z) {
            nonRequiredApps = Collections.emptySet();
        } else {
            nonRequiredApps = this.mOverlayPackagesProvider.getNonRequiredApps(componentName, i, "android.app.action.PROVISION_MANAGED_DEVICE");
        }
        removeNonInstalledPackages(nonRequiredApps, i);
        if (nonRequiredApps.isEmpty()) {
            Slogf.i("DevicePolicyManager", "No packages to delete on user " + i);
            return true;
        }
        removeDualDarClientPackage(nonRequiredApps, i);
        IPackageDeleteObserver nonRequiredPackageDeleteObserver = new NonRequiredPackageDeleteObserver(nonRequiredApps.size());
        for (String str : nonRequiredApps) {
            Slogf.i("DevicePolicyManager", "Deleting package [" + str + "] as user " + i);
            this.mContext.getPackageManager().deletePackageAsUser(str, nonRequiredPackageDeleteObserver, 4, i);
        }
        Slogf.i("DevicePolicyManager", "Waiting for non required apps to be deleted");
        return nonRequiredPackageDeleteObserver.awaitPackagesDeletion();
    }

    public final void removeNonInstalledPackages(Set set, int i) {
        HashSet hashSet = new HashSet();
        Iterator it = set.iterator();
        while (it.hasNext()) {
            String str = (String) it.next();
            if (!isPackageInstalledForUser(str, i)) {
                hashSet.add(str);
            }
        }
        set.removeAll(hashSet);
    }

    public final void removeDualDarClientPackage(Set set, int i) {
        if (DualDarManager.isOnDeviceOwnerEnabled()) {
            HashSet hashSet = new HashSet();
            String clientPackage = DualDarManager.getInstance(this.mContext).getClientPackage(i);
            if (clientPackage != null) {
                Log.d("DevicePolicyManager", "DualDar client pkg " + clientPackage + " should not be deleted during Managed Device Provisioning");
                hashSet.add(clientPackage);
                set.removeAll(hashSet);
            }
        }
    }

    public final void disallowAddUser() {
        if ((!isHeadlessFlagEnabled() || this.mIsAutomotive) && this.mInjector.userManagerIsHeadlessSystemUserMode()) {
            Slogf.i("DevicePolicyManager", "Not setting DISALLOW_ADD_USER on headless system user mode.");
            return;
        }
        Iterator it = this.mUserManager.getUsers().iterator();
        while (it.hasNext()) {
            UserHandle userHandle = ((UserInfo) it.next()).getUserHandle();
            if (!this.mUserManager.hasUserRestriction("no_add_user", userHandle)) {
                this.mUserManager.setUserRestriction("no_add_user", true, userHandle);
            }
        }
    }

    public final boolean setActiveAdminAndDeviceOwner(int i, ComponentName componentName) {
        enableAndSetActiveAdmin(i, i, componentName);
        if (getDeviceOwnerComponent(true) == null) {
            return setDeviceOwner(componentName, i, true);
        }
        return true;
    }

    public static void logEventDuration(int i, long j, String str) {
        DevicePolicyEventLogger.createEvent(i).setTimePeriod(SystemClock.elapsedRealtime() - j).setStrings(new String[]{str}).write();
    }

    public void resetDefaultCrossProfileIntentFilters(final int i) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda30
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$resetDefaultCrossProfileIntentFilters$176(i);
            }
        });
    }

    public /* synthetic */ void lambda$resetDefaultCrossProfileIntentFilters$176(int i) {
        try {
            List profiles = this.mUserManager.getProfiles(i);
            int size = profiles.size();
            if (size <= 1) {
                return;
            }
            String managedProvisioningPackage = getManagedProvisioningPackage(this.mContext);
            this.mIPackageManager.clearCrossProfileIntentFilters(i, this.mContext.getOpPackageName());
            this.mIPackageManager.clearCrossProfileIntentFilters(i, managedProvisioningPackage);
            for (int i2 = 0; i2 < size; i2++) {
                UserInfo userInfo = (UserInfo) profiles.get(i2);
                this.mIPackageManager.clearCrossProfileIntentFilters(userInfo.id, this.mContext.getOpPackageName());
                this.mIPackageManager.clearCrossProfileIntentFilters(userInfo.id, managedProvisioningPackage);
                this.mUserManagerInternal.setDefaultCrossProfileIntentFilters(i, userInfo.id);
            }
        } catch (RemoteException e) {
            Slogf.wtf("DevicePolicyManager", "Error resetting default cross profile intent filters", e);
        }
    }

    public final void setAdminCanGrantSensorsPermissionForUserUnchecked(int i, boolean z) {
        Slogf.d("DevicePolicyManager", "setAdminCanGrantSensorsPermissionForUserUnchecked(%d, %b)", Integer.valueOf(i), Boolean.valueOf(z));
        synchronized (getLockObject()) {
            ActiveAdmin deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(i);
            Preconditions.checkState(isDeviceOwner(deviceOrProfileOwnerAdminLocked) && deviceOrProfileOwnerAdminLocked.getUserHandle().getIdentifier() == i, "May only be set on a the user of a device owner.");
            deviceOrProfileOwnerAdminLocked.mAdminCanGrantSensorsPermissions = z;
            this.mPolicyCache.setAdminCanGrantSensorsPermissions(z);
            saveSettingsLocked(i);
        }
    }

    public final void setDemoDeviceStateUnchecked(int i, boolean z) {
        Slogf.d("DevicePolicyManager", "setDemoDeviceStateUnchecked(%d, %b)", Integer.valueOf(i), Boolean.valueOf(z));
        if (z) {
            synchronized (getLockObject()) {
                this.mInjector.settingsGlobalPutStringForUser("device_demo_mode", Integer.toString(1), i);
            }
            setUserProvisioningState(3, i);
        }
    }

    public final void updateAdminCanGrantSensorsPermissionCache(int i) {
        ActiveAdmin deviceOrProfileOwnerAdminLocked;
        synchronized (getLockObject()) {
            if (isUserAffiliatedWithDeviceLocked(i)) {
                deviceOrProfileOwnerAdminLocked = getDeviceOwnerAdminLocked();
            } else {
                deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(i);
            }
            boolean z = deviceOrProfileOwnerAdminLocked != null ? deviceOrProfileOwnerAdminLocked.mAdminCanGrantSensorsPermissions : false;
            if (!SemPersonaManager.isAppSeparationUserId(i)) {
                this.mPolicyCache.setAdminCanGrantSensorsPermissions(z);
            }
        }
    }

    public final void updateNetworkPreferenceForUser(final int i, List list) {
        if (isManagedProfile(i) || isDeviceOwnerUserId(i)) {
            final ArrayList arrayList = new ArrayList();
            Iterator it = list.iterator();
            while (it.hasNext()) {
                PreferentialNetworkServiceConfig preferentialNetworkServiceConfig = (PreferentialNetworkServiceConfig) it.next();
                ProfileNetworkPreference.Builder builder = new ProfileNetworkPreference.Builder();
                if (preferentialNetworkServiceConfig.isEnabled()) {
                    if (preferentialNetworkServiceConfig.isFallbackToDefaultConnectionAllowed()) {
                        builder.setPreference(1);
                    } else if (preferentialNetworkServiceConfig.shouldBlockNonMatchingNetworks()) {
                        builder.setPreference(3);
                    } else {
                        builder.setPreference(2);
                    }
                    builder.setIncludedUids(preferentialNetworkServiceConfig.getIncludedUids());
                    builder.setExcludedUids(preferentialNetworkServiceConfig.getExcludedUids());
                    builder.setPreferenceEnterpriseId(preferentialNetworkServiceConfig.getNetworkId());
                } else {
                    builder.setPreference(0);
                }
                arrayList.add(builder.build());
            }
            Slogf.d("DevicePolicyManager", "updateNetworkPreferenceForUser to " + arrayList);
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda92
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$updateNetworkPreferenceForUser$177(i, arrayList);
                }
            });
        }
    }

    public /* synthetic */ void lambda$updateNetworkPreferenceForUser$177(int i, List list) {
        this.mInjector.getConnectivityManager().setProfileNetworkPreferences(UserHandle.of(i), list, null, null);
    }

    public boolean canAdminGrantSensorsPermissions() {
        if (this.mHasFeature) {
            return this.mPolicyCache.canAdminGrantSensorsPermissions();
        }
        return false;
    }

    public void setDeviceOwnerType(ComponentName componentName, int i) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        synchronized (getLockObject()) {
            setDeviceOwnerTypeLocked(componentName, i);
        }
    }

    public final void setDeviceOwnerTypeLocked(ComponentName componentName, int i) {
        String packageName = componentName.getPackageName();
        verifyDeviceOwnerTypePreconditionsLocked(componentName);
        boolean isAdminTestOnlyLocked = isAdminTestOnlyLocked(componentName, this.mOwners.getDeviceOwnerUserId());
        Preconditions.checkState(isAdminTestOnlyLocked || !this.mOwners.isDeviceOwnerTypeSetForDeviceOwner(packageName), "Test only admins can only set the device owner type more than once");
        this.mOwners.setDeviceOwnerType(packageName, i, isAdminTestOnlyLocked);
        setGlobalSettingDeviceOwnerType(i);
    }

    public final void setGlobalSettingDeviceOwnerType(final int i) {
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda13
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setGlobalSettingDeviceOwnerType$178(i);
            }
        });
    }

    public /* synthetic */ void lambda$setGlobalSettingDeviceOwnerType$178(int i) {
        this.mInjector.settingsGlobalPutInt("device_owner_type", i);
    }

    public int getDeviceOwnerType(ComponentName componentName) {
        int deviceOwnerTypeLocked;
        synchronized (getLockObject()) {
            verifyDeviceOwnerTypePreconditionsLocked(componentName);
            deviceOwnerTypeLocked = getDeviceOwnerTypeLocked(componentName.getPackageName());
        }
        return deviceOwnerTypeLocked;
    }

    public final int getDeviceOwnerTypeLocked(String str) {
        return this.mOwners.getDeviceOwnerType(str);
    }

    public final boolean isFinancedDeviceOwner(CallerIdentity callerIdentity) {
        boolean z;
        synchronized (getLockObject()) {
            if (isDeviceOwnerLocked(callerIdentity)) {
                z = true;
                if (getDeviceOwnerTypeLocked(this.mOwners.getDeviceOwnerPackageName()) == 1) {
                }
            }
            z = false;
        }
        return z;
    }

    public final void verifyDeviceOwnerTypePreconditionsLocked(ComponentName componentName) {
        Preconditions.checkState(this.mOwners.hasDeviceOwner(), "there is no device owner");
        Preconditions.checkState(this.mOwners.getDeviceOwnerComponent().equals(componentName), "admin is not the device owner");
    }

    public void setUsbDataSignalingEnabled(String str, boolean z) {
        ActiveAdmin profileOwnerOrDeviceOwnerLocked;
        Objects.requireNonNull(str, "Admin package name must be provided");
        CallerIdentity callerIdentity = getCallerIdentity(str);
        if (!isPermissionCheckFlagEnabled()) {
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity), "USB data signaling can only be controlled by a device owner or a profile owner on an organization-owned device.");
            Preconditions.checkState(canUsbDataSignalingBeDisabled(), "USB data signaling cannot be disabled.");
        }
        synchronized (getLockObject()) {
            if (isPermissionCheckFlagEnabled()) {
                profileOwnerOrDeviceOwnerLocked = enforcePermissionAndGetEnforcingAdmin(null, "android.permission.MANAGE_DEVICE_POLICY_USB_DATA_SIGNALLING", callerIdentity.getPackageName(), callerIdentity.getUserId()).getActiveAdmin();
            } else {
                profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
            }
            if (profileOwnerOrDeviceOwnerLocked.mUsbDataSignalingEnabled != z) {
                profileOwnerOrDeviceOwnerLocked.mUsbDataSignalingEnabled = z;
                saveSettingsLocked(callerIdentity.getUserId());
                updateUsbDataSignal();
            }
        }
        DevicePolicyEventLogger.createEvent(198).setAdmin(str).setBoolean(z).write();
    }

    public final void updateUsbDataSignal() {
        final boolean isUsbDataSignalingEnabledInternalLocked;
        if (canUsbDataSignalingBeDisabled()) {
            synchronized (getLockObject()) {
                isUsbDataSignalingEnabledInternalLocked = isUsbDataSignalingEnabledInternalLocked();
            }
            if (((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda54
                public final Object getOrThrow() {
                    Boolean lambda$updateUsbDataSignal$179;
                    lambda$updateUsbDataSignal$179 = DevicePolicyManagerService.this.lambda$updateUsbDataSignal$179(isUsbDataSignalingEnabledInternalLocked);
                    return lambda$updateUsbDataSignal$179;
                }
            })).booleanValue()) {
                return;
            }
            Slogf.w("DevicePolicyManager", "Failed to set usb data signaling state");
        }
    }

    public /* synthetic */ Boolean lambda$updateUsbDataSignal$179(boolean z) {
        return Boolean.valueOf(this.mInjector.getUsbManager().enableUsbDataSignal(z));
    }

    public boolean isUsbDataSignalingEnabled(String str) {
        CallerIdentity callerIdentity = getCallerIdentity(str);
        synchronized (getLockObject()) {
            if (!isDefaultDeviceOwner(callerIdentity) && !isProfileOwnerOfOrganizationOwnedDevice(callerIdentity)) {
                return isUsbDataSignalingEnabledInternalLocked();
            }
            return getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId()).mUsbDataSignalingEnabled;
        }
    }

    public boolean isUsbDataSignalingEnabledForUser(int i) {
        boolean isUsbDataSignalingEnabledInternalLocked;
        Preconditions.checkCallAuthorization(isSystemUid(getCallerIdentity()));
        synchronized (getLockObject()) {
            isUsbDataSignalingEnabledInternalLocked = isUsbDataSignalingEnabledInternalLocked();
        }
        return isUsbDataSignalingEnabledInternalLocked;
    }

    public final boolean isUsbDataSignalingEnabledInternalLocked() {
        ActiveAdmin deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked;
        if (isHeadlessFlagEnabled()) {
            deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked();
        } else {
            deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked(0);
        }
        return deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked == null || deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked.mUsbDataSignalingEnabled;
    }

    public boolean canUsbDataSignalingBeDisabled() {
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda62
            public final Object getOrThrow() {
                Boolean lambda$canUsbDataSignalingBeDisabled$180;
                lambda$canUsbDataSignalingBeDisabled$180 = DevicePolicyManagerService.this.lambda$canUsbDataSignalingBeDisabled$180();
                return lambda$canUsbDataSignalingBeDisabled$180;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$canUsbDataSignalingBeDisabled$180() {
        return Boolean.valueOf(this.mInjector.getUsbManager() != null && this.mInjector.getUsbManager().getUsbHalVersion() >= 13);
    }

    public final void notifyMinimumRequiredWifiSecurityLevelChanged(final int i) {
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda148
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$notifyMinimumRequiredWifiSecurityLevelChanged$181(i);
            }
        });
    }

    public /* synthetic */ void lambda$notifyMinimumRequiredWifiSecurityLevelChanged$181(int i) {
        this.mInjector.getWifiManager().notifyMinimumRequiredWifiSecurityLevelChanged(i);
    }

    public final void notifyWifiSsidPolicyChanged(final WifiSsidPolicy wifiSsidPolicy) {
        if (wifiSsidPolicy == null) {
            return;
        }
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda69
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$notifyWifiSsidPolicyChanged$182(wifiSsidPolicy);
            }
        });
    }

    public /* synthetic */ void lambda$notifyWifiSsidPolicyChanged$182(WifiSsidPolicy wifiSsidPolicy) {
        this.mInjector.getWifiManager().notifyWifiSsidPolicyChanged(wifiSsidPolicy);
    }

    public void setMinimumRequiredWifiSecurityLevel(String str, int i) {
        CallerIdentity callerIdentity;
        ActiveAdmin profileOwnerOrDeviceOwnerLocked;
        boolean minimumRequiredWifiSecurityLevelLocked;
        if (isPermissionCheckFlagEnabled()) {
            callerIdentity = getCallerIdentity(str);
        } else {
            callerIdentity = getCallerIdentity();
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity), "Wi-Fi minimum security level can only be controlled by a device owner or a profile owner on an organization-owned device.");
        }
        synchronized (getLockObject()) {
            if (isPermissionCheckFlagEnabled()) {
                profileOwnerOrDeviceOwnerLocked = enforcePermissionAndGetEnforcingAdmin(null, "android.permission.MANAGE_DEVICE_POLICY_WIFI", callerIdentity.getPackageName(), callerIdentity.getUserId()).getActiveAdmin();
            } else {
                profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
            }
            minimumRequiredWifiSecurityLevelLocked = setMinimumRequiredWifiSecurityLevelLocked(profileOwnerOrDeviceOwnerLocked, i);
            if (minimumRequiredWifiSecurityLevelLocked) {
                i = getStrictestMinimumRequiredWifiSecurityLevelLocked();
            }
        }
        if (minimumRequiredWifiSecurityLevelLocked) {
            notifyMinimumRequiredWifiSecurityLevelChanged(i);
        }
    }

    public final boolean setMinimumRequiredWifiSecurityLevelLocked(ActiveAdmin activeAdmin, int i) {
        if (activeAdmin.mWifiMinimumSecurityLevel == i) {
            return false;
        }
        activeAdmin.mWifiMinimumSecurityLevel = i;
        saveSettingsLocked(activeAdmin.getUserHandle().getIdentifier());
        return true;
    }

    public final int getStrictestMinimumRequiredWifiSecurityLevelLocked() {
        int i = 0;
        Iterator it = getActiveAdminsForUserAndItsManagedProfilesLocked(0, new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda121
            @Override // java.util.function.Predicate
            public final boolean test(Object obj) {
                boolean lambda$getStrictestMinimumRequiredWifiSecurityLevelLocked$183;
                lambda$getStrictestMinimumRequiredWifiSecurityLevelLocked$183 = DevicePolicyManagerService.lambda$getStrictestMinimumRequiredWifiSecurityLevelLocked$183((UserInfo) obj);
                return lambda$getStrictestMinimumRequiredWifiSecurityLevelLocked$183;
            }
        }).iterator();
        while (it.hasNext()) {
            int i2 = ((ActiveAdmin) it.next()).mWifiMinimumSecurityLevel;
            if (i2 > i) {
                i = i2;
            }
        }
        return i;
    }

    public int getMinimumRequiredWifiSecurityLevel() {
        int strictestMinimumRequiredWifiSecurityLevelLocked;
        synchronized (getLockObject()) {
            strictestMinimumRequiredWifiSecurityLevelLocked = getStrictestMinimumRequiredWifiSecurityLevelLocked();
        }
        return strictestMinimumRequiredWifiSecurityLevelLocked;
    }

    public WifiSsidPolicy getWifiSsidPolicy(String str) {
        WifiSsidPolicy combinedWifiSsidPolicyLocked;
        CallerIdentity callerIdentity = getCallerIdentity();
        if (isPermissionCheckFlagEnabled()) {
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_WIFI", str, callerIdentity.getUserId());
        } else {
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) || canQueryAdminPolicy(callerIdentity), "SSID policy can only be retrieved by a device owner or a profile owner on an organization-owned device or an app with the QUERY_ADMIN_POLICY permission.");
        }
        synchronized (getLockObject()) {
            combinedWifiSsidPolicyLocked = getCombinedWifiSsidPolicyLocked();
        }
        return combinedWifiSsidPolicyLocked;
    }

    public void setWifiSsidPolicy(String str, WifiSsidPolicy wifiSsidPolicy) {
        CallerIdentity callerIdentity;
        ActiveAdmin profileOwnerOrDeviceOwnerLocked;
        boolean wifiSsidPolicyLocked;
        if (isPermissionCheckFlagEnabled()) {
            callerIdentity = getCallerIdentity(str);
        } else {
            callerIdentity = getCallerIdentity();
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity), "SSID denylist can only be controlled by a device owner or a profile owner on an organization-owned device.");
        }
        synchronized (getLockObject()) {
            if (isPermissionCheckFlagEnabled()) {
                profileOwnerOrDeviceOwnerLocked = enforcePermissionAndGetEnforcingAdmin(null, "android.permission.MANAGE_DEVICE_POLICY_WIFI", callerIdentity.getPackageName(), callerIdentity.getUserId()).getActiveAdmin();
            } else {
                profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(callerIdentity.getUserId());
            }
            wifiSsidPolicyLocked = setWifiSsidPolicyLocked(profileOwnerOrDeviceOwnerLocked, wifiSsidPolicy);
            if (wifiSsidPolicyLocked) {
                wifiSsidPolicy = getCombinedWifiSsidPolicyLocked();
            }
        }
        if (wifiSsidPolicyLocked) {
            notifyWifiSsidPolicyChanged(wifiSsidPolicy);
        }
    }

    public final boolean setWifiSsidPolicyLocked(ActiveAdmin activeAdmin, WifiSsidPolicy wifiSsidPolicy) {
        boolean z;
        if (Objects.equals(wifiSsidPolicy, activeAdmin.mWifiSsidPolicy)) {
            z = false;
        } else {
            activeAdmin.mWifiSsidPolicy = wifiSsidPolicy;
            z = true;
        }
        if (z) {
            saveSettingsLocked(activeAdmin.getUserHandle().getIdentifier());
        }
        return z;
    }

    public final WifiSsidPolicy getCombinedWifiSsidPolicyLocked() {
        ArraySet arraySet = new ArraySet();
        ArraySet arraySet2 = new ArraySet();
        Iterator it = getActiveAdminsForUserAndItsManagedProfilesLocked(0, new Predicate() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda43
            @Override // java.util.function.Predicate
            public final boolean test(Object obj) {
                boolean lambda$getCombinedWifiSsidPolicyLocked$184;
                lambda$getCombinedWifiSsidPolicyLocked$184 = DevicePolicyManagerService.lambda$getCombinedWifiSsidPolicyLocked$184((UserInfo) obj);
                return lambda$getCombinedWifiSsidPolicyLocked$184;
            }
        }).iterator();
        while (it.hasNext()) {
            WifiSsidPolicy wifiSsidPolicy = ((ActiveAdmin) it.next()).mWifiSsidPolicy;
            if (wifiSsidPolicy != null) {
                if (wifiSsidPolicy.getPolicyType() == 0) {
                    arraySet.addAll(wifiSsidPolicy.getSsids());
                } else if (wifiSsidPolicy.getPolicyType() == 1) {
                    arraySet2.addAll(wifiSsidPolicy.getSsids());
                }
            }
        }
        if (!arraySet.isEmpty()) {
            return new WifiSsidPolicy(0, arraySet);
        }
        if (arraySet2.isEmpty()) {
            return null;
        }
        return new WifiSsidPolicy(1, arraySet2);
    }

    public void setDrawables(final List list) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.UPDATE_DEVICE_MANAGEMENT_RESOURCES"));
        Objects.requireNonNull(list, "drawables must be provided.");
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda170
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setDrawables$186(list);
            }
        });
    }

    public /* synthetic */ void lambda$setDrawables$186(List list) {
        if (this.mDeviceManagementResourcesProvider.updateDrawables(list)) {
            sendDrawableUpdatedBroadcast((List) list.stream().map(new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda221
                @Override // java.util.function.Function
                public final Object apply(Object obj) {
                    String drawableId;
                    drawableId = ((DevicePolicyDrawableResource) obj).getDrawableId();
                    return drawableId;
                }
            }).collect(Collectors.toList()));
        }
    }

    public void resetDrawables(final List list) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.UPDATE_DEVICE_MANAGEMENT_RESOURCES"));
        Objects.requireNonNull(list, "drawableIds must be provided.");
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda128
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$resetDrawables$187(list);
            }
        });
    }

    public /* synthetic */ void lambda$resetDrawables$187(List list) {
        if (this.mDeviceManagementResourcesProvider.removeDrawables(list)) {
            sendDrawableUpdatedBroadcast(list);
        }
    }

    public ParcelableResource getDrawable(final String str, final String str2, final String str3) {
        return (ParcelableResource) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda189
            public final Object getOrThrow() {
                ParcelableResource lambda$getDrawable$188;
                lambda$getDrawable$188 = DevicePolicyManagerService.this.lambda$getDrawable$188(str, str2, str3);
                return lambda$getDrawable$188;
            }
        });
    }

    public /* synthetic */ ParcelableResource lambda$getDrawable$188(String str, String str2, String str3) {
        return this.mDeviceManagementResourcesProvider.getDrawable(str, str2, str3);
    }

    public final void sendDrawableUpdatedBroadcast(List list) {
        sendResourceUpdatedBroadcast(1, list);
    }

    public void setStrings(final List list) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.UPDATE_DEVICE_MANAGEMENT_RESOURCES"));
        Objects.requireNonNull(list, "strings must be provided.");
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda18
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$setStrings$190(list);
            }
        });
    }

    public /* synthetic */ void lambda$setStrings$190(List list) {
        if (this.mDeviceManagementResourcesProvider.updateStrings(list)) {
            sendStringsUpdatedBroadcast((List) list.stream().map(new Function() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda211
                @Override // java.util.function.Function
                public final Object apply(Object obj) {
                    String stringId;
                    stringId = ((DevicePolicyStringResource) obj).getStringId();
                    return stringId;
                }
            }).collect(Collectors.toList()));
        }
    }

    public void resetStrings(final List list) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.UPDATE_DEVICE_MANAGEMENT_RESOURCES"));
        this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda160
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$resetStrings$191(list);
            }
        });
    }

    public /* synthetic */ void lambda$resetStrings$191(List list) {
        if (this.mDeviceManagementResourcesProvider.removeStrings(list)) {
            sendStringsUpdatedBroadcast(list);
        }
    }

    public ParcelableResource getString(final String str) {
        return (ParcelableResource) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda194
            public final Object getOrThrow() {
                ParcelableResource lambda$getString$192;
                lambda$getString$192 = DevicePolicyManagerService.this.lambda$getString$192(str);
                return lambda$getString$192;
            }
        });
    }

    public /* synthetic */ ParcelableResource lambda$getString$192(String str) {
        return this.mDeviceManagementResourcesProvider.getString(str);
    }

    public final void sendStringsUpdatedBroadcast(List list) {
        sendResourceUpdatedBroadcast(2, list);
    }

    public final void sendResourceUpdatedBroadcast(int i, List list) {
        Intent intent = new Intent("android.app.action.DEVICE_POLICY_RESOURCE_UPDATED");
        intent.putExtra("android.app.extra.RESOURCE_IDS", (String[]) list.toArray(new IntFunction() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda223
            @Override // java.util.function.IntFunction
            public final Object apply(int i2) {
                String[] lambda$sendResourceUpdatedBroadcast$193;
                lambda$sendResourceUpdatedBroadcast$193 = DevicePolicyManagerService.lambda$sendResourceUpdatedBroadcast$193(i2);
                return lambda$sendResourceUpdatedBroadcast$193;
            }
        }));
        intent.putExtra("android.app.extra.RESOURCE_TYPE", i);
        intent.setFlags(268435456);
        intent.setFlags(1073741824);
        List aliveUsers = this.mUserManager.getAliveUsers();
        for (int i2 = 0; i2 < aliveUsers.size(); i2++) {
            this.mContext.sendBroadcastAsUser(intent, ((UserInfo) aliveUsers.get(i2)).getUserHandle());
        }
    }

    public static /* synthetic */ String[] lambda$sendResourceUpdatedBroadcast$193(int i) {
        return new String[i];
    }

    public final String getUpdatableString(String str, final int i, final Object... objArr) {
        ParcelableResource string = this.mDeviceManagementResourcesProvider.getString(str);
        if (string == null) {
            return ParcelableResource.loadDefaultString(new Supplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda58
                @Override // java.util.function.Supplier
                public final Object get() {
                    String lambda$getUpdatableString$194;
                    lambda$getUpdatableString$194 = DevicePolicyManagerService.this.lambda$getUpdatableString$194(i, objArr);
                    return lambda$getUpdatableString$194;
                }
            });
        }
        return string.getString(this.mContext, new Supplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda59
            @Override // java.util.function.Supplier
            public final Object get() {
                String lambda$getUpdatableString$195;
                lambda$getUpdatableString$195 = DevicePolicyManagerService.this.lambda$getUpdatableString$195(i, objArr);
                return lambda$getUpdatableString$195;
            }
        }, objArr);
    }

    public /* synthetic */ String lambda$getUpdatableString$194(int i, Object[] objArr) {
        return this.mContext.getString(i, objArr);
    }

    public /* synthetic */ String lambda$getUpdatableString$195(int i, Object[] objArr) {
        return this.mContext.getString(i, objArr);
    }

    public boolean isDpcDownloaded() {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        final ContentResolver contentResolver = this.mContext.getContentResolver();
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda110
            public final Object getOrThrow() {
                Boolean lambda$isDpcDownloaded$196;
                lambda$isDpcDownloaded$196 = DevicePolicyManagerService.lambda$isDpcDownloaded$196(contentResolver);
                return lambda$isDpcDownloaded$196;
            }
        })).booleanValue();
    }

    public static /* synthetic */ Boolean lambda$isDpcDownloaded$196(ContentResolver contentResolver) {
        return Boolean.valueOf(Settings.Secure.getIntForUser(contentResolver, "managed_provisioning_dpc_downloaded", 0, contentResolver.getUserId()) == 1);
    }

    public void setDpcDownloaded(boolean z) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        Injector injector = this.mInjector;
        final int i = z ? 1 : 0;
        injector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda126
            public final Object getOrThrow() {
                Boolean lambda$setDpcDownloaded$197;
                lambda$setDpcDownloaded$197 = DevicePolicyManagerService.this.lambda$setDpcDownloaded$197(i);
                return lambda$setDpcDownloaded$197;
            }
        });
    }

    public /* synthetic */ Boolean lambda$setDpcDownloaded$197(int i) {
        return Boolean.valueOf(Settings.Secure.putInt(this.mContext.getContentResolver(), "managed_provisioning_dpc_downloaded", i));
    }

    public void resetShouldAllowBypassingDevicePolicyManagementRoleQualificationState() {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_ROLE_HOLDERS"));
        setBypassDevicePolicyManagementRoleQualificationStateInternal(null, false);
    }

    public boolean shouldAllowBypassingDevicePolicyManagementRoleQualification() {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_ROLE_HOLDERS"));
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda70
            public final Object getOrThrow() {
                Boolean lambda$shouldAllowBypassingDevicePolicyManagementRoleQualification$198;
                lambda$shouldAllowBypassingDevicePolicyManagementRoleQualification$198 = DevicePolicyManagerService.this.lambda$shouldAllowBypassingDevicePolicyManagementRoleQualification$198();
                return lambda$shouldAllowBypassingDevicePolicyManagementRoleQualification$198;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$shouldAllowBypassingDevicePolicyManagementRoleQualification$198() {
        if (lambda$getUserDataUnchecked$2(0).mBypassDevicePolicyManagementRoleQualifications) {
            return Boolean.TRUE;
        }
        return Boolean.valueOf(shouldAllowBypassingDevicePolicyManagementRoleQualificationInternal());
    }

    public final boolean shouldAllowBypassingDevicePolicyManagementRoleQualificationInternal() {
        if (nonTestNonPrecreatedUsersExist()) {
            return false;
        }
        return !hasIncompatibleAccountsOnAnyUser();
    }

    public final boolean hasAccountsOnAnyUser() {
        long clearCallingIdentity = Binder.clearCallingIdentity();
        try {
            Iterator it = this.mUserManagerInternal.getUsers(true).iterator();
            while (it.hasNext()) {
                if (((AccountManager) this.mContext.createContextAsUser(UserHandle.of(((UserInfo) it.next()).id), 0).getSystemService(AccountManager.class)).getAccounts().length != 0) {
                    return true;
                }
            }
            return false;
        } finally {
            Binder.restoreCallingIdentity(clearCallingIdentity);
        }
    }

    public final void setBypassDevicePolicyManagementRoleQualificationStateInternal(String str, boolean z) {
        boolean z2;
        DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(0);
        boolean z3 = true;
        if (lambda$getUserDataUnchecked$2.mBypassDevicePolicyManagementRoleQualifications != z) {
            lambda$getUserDataUnchecked$2.mBypassDevicePolicyManagementRoleQualifications = z;
            z2 = true;
        } else {
            z2 = false;
        }
        if (Objects.equals(str, lambda$getUserDataUnchecked$2.mCurrentRoleHolder)) {
            z3 = z2;
        } else {
            lambda$getUserDataUnchecked$2.mCurrentRoleHolder = str;
        }
        if (z3) {
            synchronized (getLockObject()) {
                saveSettingsLocked(0);
            }
        }
    }

    /* loaded from: classes2.dex */
    public final class DevicePolicyManagementRoleObserver implements OnRoleHoldersChangedListener {
        public final Context mContext;
        public final Executor mExecutor;
        public RoleManager mRm;

        public static /* synthetic */ void lambda$handleDevicePolicyManagementRoleChange$0(Boolean bool) {
        }

        public DevicePolicyManagementRoleObserver(Context context) {
            this.mContext = context;
            this.mExecutor = context.getMainExecutor();
            this.mRm = (RoleManager) context.getSystemService(RoleManager.class);
        }

        public void register() {
            this.mRm.addOnRoleHoldersChangedListenerAsUser(this.mExecutor, this, UserHandle.ALL);
        }

        public void onRoleHoldersChanged(String str, UserHandle userHandle) {
            DevicePolicyManagerService.this.mDevicePolicyEngine.handleRoleChanged(str, userHandle.getIdentifier());
            if ("android.app.role.DEVICE_POLICY_MANAGEMENT".equals(str)) {
                handleDevicePolicyManagementRoleChange(userHandle);
            } else if ("android.app.role.FINANCED_DEVICE_KIOSK".equals(str)) {
                handleFinancedDeviceKioskRoleChange();
            }
        }

        public final void handleDevicePolicyManagementRoleChange(UserHandle userHandle) {
            String deviceManagementRoleHolder = getDeviceManagementRoleHolder(userHandle);
            if (isDefaultRoleHolder(deviceManagementRoleHolder)) {
                Slogf.i("DevicePolicyManager", "onRoleHoldersChanged: Default role holder is set, returning early");
                return;
            }
            if (deviceManagementRoleHolder == null) {
                Slogf.i("DevicePolicyManager", "onRoleHoldersChanged: New role holder is null, returning early");
                return;
            }
            if (DevicePolicyManagerService.this.shouldAllowBypassingDevicePolicyManagementRoleQualificationInternal()) {
                Slogf.w("DevicePolicyManager", "onRoleHoldersChanged: Updating current role holder to " + deviceManagementRoleHolder);
                DevicePolicyManagerService.this.setBypassDevicePolicyManagementRoleQualificationStateInternal(deviceManagementRoleHolder, true);
                return;
            }
            if (deviceManagementRoleHolder.equals(DevicePolicyManagerService.this.lambda$getUserDataUnchecked$2(0).mCurrentRoleHolder)) {
                return;
            }
            Slogf.w("DevicePolicyManager", "onRoleHoldersChanged: You can't set a different role holder, role is getting revoked from " + deviceManagementRoleHolder);
            DevicePolicyManagerService.this.setBypassDevicePolicyManagementRoleQualificationStateInternal(null, false);
            this.mRm.removeRoleHolderAsUser("android.app.role.DEVICE_POLICY_MANAGEMENT", deviceManagementRoleHolder, 0, userHandle, this.mExecutor, new Consumer() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$DevicePolicyManagementRoleObserver$$ExternalSyntheticLambda1
                @Override // java.util.function.Consumer
                public final void accept(Object obj) {
                    DevicePolicyManagerService.DevicePolicyManagementRoleObserver.lambda$handleDevicePolicyManagementRoleChange$0((Boolean) obj);
                }
            });
        }

        public final void handleFinancedDeviceKioskRoleChange() {
            if (DevicePolicyManagerService.isPolicyEngineForFinanceFlagEnabled()) {
                Slog.i("DevicePolicyManager", "Handling action android.app.admin.action.DEVICE_FINANCING_STATE_CHANGED");
                final Intent intent = new Intent("android.app.admin.action.DEVICE_FINANCING_STATE_CHANGED");
                DevicePolicyManagerService.this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$DevicePolicyManagementRoleObserver$$ExternalSyntheticLambda0
                    public final void runOrThrow() {
                        DevicePolicyManagerService.DevicePolicyManagementRoleObserver.this.lambda$handleFinancedDeviceKioskRoleChange$1(intent);
                    }
                });
            }
        }

        public /* synthetic */ void lambda$handleFinancedDeviceKioskRoleChange$1(Intent intent) {
            Iterator it = DevicePolicyManagerService.this.mUserManager.getUsers().iterator();
            while (it.hasNext()) {
                UserHandle userHandle = ((UserInfo) it.next()).getUserHandle();
                DevicePolicyManagerService.this.broadcastExplicitIntentToRoleHolder(intent, "android.app.role.SYSTEM_SUPERVISION", userHandle);
                DevicePolicyManagerService.this.broadcastExplicitIntentToRoleHolder(intent, "android.app.role.DEVICE_POLICY_MANAGEMENT", userHandle);
                ActiveAdmin deviceOrProfileOwnerAdminLocked = DevicePolicyManagerService.this.getDeviceOrProfileOwnerAdminLocked(userHandle.getIdentifier());
                if (deviceOrProfileOwnerAdminLocked != null && (DevicePolicyManagerService.this.isProfileOwnerOfOrganizationOwnedDevice(deviceOrProfileOwnerAdminLocked.info.getComponent(), userHandle.getIdentifier()) || DevicePolicyManagerService.this.isDeviceOwner(deviceOrProfileOwnerAdminLocked) || (DevicePolicyManagerService.this.isProfileOwner(deviceOrProfileOwnerAdminLocked.info.getComponent(), userHandle.getIdentifier()) && deviceOrProfileOwnerAdminLocked.getUserHandle().isSystem()))) {
                    if (!deviceOrProfileOwnerAdminLocked.info.getPackageName().equals(getDeviceManagementRoleHolder(userHandle))) {
                        DevicePolicyManagerService.this.broadcastExplicitIntentToPackage(intent, deviceOrProfileOwnerAdminLocked.info.getPackageName(), deviceOrProfileOwnerAdminLocked.getUserHandle());
                    }
                }
            }
        }

        public final String getDeviceManagementRoleHolder(UserHandle userHandle) {
            return DevicePolicyManagerService.this.getRoleHolderPackageNameOnUser(this.mContext, "android.app.role.DEVICE_POLICY_MANAGEMENT", userHandle);
        }

        public final boolean isDefaultRoleHolder(String str) {
            String defaultRoleHolderPackageName = getDefaultRoleHolderPackageName();
            if (str == null || defaultRoleHolderPackageName == null || !defaultRoleHolderPackageName.equals(str)) {
                return false;
            }
            return hasSigningCertificate(str, getDefaultRoleHolderPackageSignature());
        }

        public final boolean hasSigningCertificate(String str, String str2) {
            if (str != null && str2 != null) {
                try {
                    return DevicePolicyManagerService.this.mInjector.getPackageManager().hasSigningCertificate(str, new Signature(str2).toByteArray(), 1);
                } catch (IllegalArgumentException e) {
                    Slogf.w("DevicePolicyManager", "Cannot parse signing certificate: " + str2, e);
                }
            }
            return false;
        }

        public final String getDefaultRoleHolderPackageName() {
            String[] defaultRoleHolderPackageNameAndSignature = getDefaultRoleHolderPackageNameAndSignature();
            if (defaultRoleHolderPackageNameAndSignature == null) {
                return null;
            }
            return defaultRoleHolderPackageNameAndSignature[0];
        }

        public final String getDefaultRoleHolderPackageSignature() {
            String[] defaultRoleHolderPackageNameAndSignature = getDefaultRoleHolderPackageNameAndSignature();
            if (defaultRoleHolderPackageNameAndSignature == null || defaultRoleHolderPackageNameAndSignature.length < 2) {
                return null;
            }
            return defaultRoleHolderPackageNameAndSignature[1];
        }

        public final String[] getDefaultRoleHolderPackageNameAndSignature() {
            String string = this.mContext.getString(R.string.Noon);
            if (TextUtils.isEmpty(string)) {
                return null;
            }
            if (string.contains(XmlUtils.STRING_ARRAY_SEPARATOR)) {
                return string.split(XmlUtils.STRING_ARRAY_SEPARATOR);
            }
            return new String[]{string};
        }
    }

    public final void broadcastExplicitIntentToRoleHolder(Intent intent, String str, UserHandle userHandle) {
        String roleHolderPackageNameOnUser = getRoleHolderPackageNameOnUser(this.mContext, str, userHandle);
        if (roleHolderPackageNameOnUser == null) {
            return;
        }
        broadcastExplicitIntentToPackage(intent, roleHolderPackageNameOnUser, userHandle);
    }

    public final void broadcastExplicitIntentToPackage(Intent intent, String str, UserHandle userHandle) {
        int identifier = userHandle.getIdentifier();
        if (str == null) {
            return;
        }
        Intent intent2 = new Intent(intent).setPackage(str);
        List queryBroadcastReceiversAsUser = this.mContext.getPackageManager().queryBroadcastReceiversAsUser(intent2, PackageManager.ResolveInfoFlags.of(2L), identifier);
        if (queryBroadcastReceiversAsUser.isEmpty()) {
            Slog.i("DevicePolicyManager", "Found no receivers to handle intent " + intent + " in package " + str);
            return;
        }
        Iterator it = queryBroadcastReceiversAsUser.iterator();
        while (it.hasNext()) {
            this.mContext.sendBroadcastAsUser(new Intent(intent2).setComponent(((ResolveInfo) it.next()).getComponentInfo().getComponentName()).addFlags(16777216), userHandle);
        }
    }

    public List getPolicyManagedProfiles(UserHandle userHandle) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        final int identifier = userHandle.getIdentifier();
        return (List) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda37
            public final Object getOrThrow() {
                List lambda$getPolicyManagedProfiles$199;
                lambda$getPolicyManagedProfiles$199 = DevicePolicyManagerService.this.lambda$getPolicyManagedProfiles$199(identifier);
                return lambda$getPolicyManagedProfiles$199;
            }
        });
    }

    public /* synthetic */ List lambda$getPolicyManagedProfiles$199(int i) {
        List profiles = this.mUserManager.getProfiles(i);
        ArrayList arrayList = new ArrayList();
        for (int i2 = 0; i2 < profiles.size(); i2++) {
            UserInfo userInfo = (UserInfo) profiles.get(i2);
            if (userInfo.isManagedProfile() && hasProfileOwner(userInfo.id) && !userInfo.isSecureFolder()) {
                arrayList.add(new UserHandle(userInfo.id));
            }
        }
        return arrayList;
    }

    public void semSetPasswordQuality(final ComponentName componentName, final int i) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            validateQualityConstant(i);
            Preconditions.checkCallAuthorization(isAuthorizedSamsungPackage(componentName));
            final int userId = getCallerIdentity(componentName).getUserId();
            synchronized (getLockObject()) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda113
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$semSetPasswordQuality$200(componentName, userId, i);
                    }
                });
            }
            DevicePolicyEventLogger.createEvent(1).setAdmin(componentName).setInt(i).setStrings(new String[]{"notCalledFromParent"}).write();
        }
    }

    public /* synthetic */ void lambda$semSetPasswordQuality$200(ComponentName componentName, int i, int i2) {
        ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i);
        PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
        if (passwordPolicy.quality != i2) {
            passwordPolicy.quality = i2;
            activeAdminForCallerLockedMDM.mPasswordComplexity = 0;
            resetInactivePasswordRequirementsIfRPlus(i, activeAdminForCallerLockedMDM);
            updatePasswordValidityCheckpointLocked(i, false);
            updatePasswordQualityCacheForUserGroup(i);
            saveSettingsLocked(i);
        }
        logPasswordQualitySetIfSecurityLogEnabled(componentName, i, false, passwordPolicy);
    }

    public void semSetPasswordMinimumLength(final ComponentName componentName, final int i) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isAuthorizedSamsungPackage(componentName));
            final int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            synchronized (getLockObject()) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda153
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$semSetPasswordMinimumLength$201(componentName, userHandleGetCallingUserId, i);
                    }
                });
            }
            DevicePolicyEventLogger.createEvent(2).setAdmin(componentName).setInt(i).write();
        }
    }

    public /* synthetic */ void lambda$semSetPasswordMinimumLength$201(ComponentName componentName, int i, int i2) {
        ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i);
        ensureMinimumQuality(i, activeAdminForCallerLockedMDM, IInstalld.FLAG_CLEAR_APP_DATA_KEEP_ART_PROFILES, "semSetPasswordMinimumLength");
        PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
        if (passwordPolicy.length != i2) {
            passwordPolicy.length = i2;
            updatePasswordValidityCheckpointLocked(i, false);
            saveSettingsLocked(i);
        }
        logPasswordQualitySetIfSecurityLogEnabled(componentName, i, false, passwordPolicy);
    }

    public void semSetPasswordMinimumUpperCase(final ComponentName componentName, final int i) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isAuthorizedSamsungPackage(componentName));
            final int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            synchronized (getLockObject()) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda36
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$semSetPasswordMinimumUpperCase$202(componentName, userHandleGetCallingUserId, i);
                    }
                });
            }
            DevicePolicyEventLogger.createEvent(7).setAdmin(componentName).setInt(i).write();
        }
    }

    public /* synthetic */ void lambda$semSetPasswordMinimumUpperCase$202(ComponentName componentName, int i, int i2) {
        ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i);
        ensureMinimumQuality(i, activeAdminForCallerLockedMDM, 393216, "semSetPasswordMinimumUpperCase");
        PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
        if (passwordPolicy.upperCase != i2) {
            passwordPolicy.upperCase = i2;
            updatePasswordValidityCheckpointLocked(i, false);
            saveSettingsLocked(i);
        }
        logPasswordQualitySetIfSecurityLogEnabled(componentName, i, false, passwordPolicy);
    }

    public void semSetPasswordMinimumLowerCase(final ComponentName componentName, final int i) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        Preconditions.checkCallAuthorization(isAuthorizedSamsungPackage(componentName));
        final int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda1
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$semSetPasswordMinimumLowerCase$203(componentName, userHandleGetCallingUserId, i);
                }
            });
        }
        DevicePolicyEventLogger.createEvent(6).setAdmin(componentName).setInt(i).write();
    }

    public /* synthetic */ void lambda$semSetPasswordMinimumLowerCase$203(ComponentName componentName, int i, int i2) {
        ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i);
        ensureMinimumQuality(i, activeAdminForCallerLockedMDM, 393216, "semSetPasswordMinimumLowerCase");
        PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
        if (passwordPolicy.lowerCase != i2) {
            passwordPolicy.lowerCase = i2;
            updatePasswordValidityCheckpointLocked(i, false);
            saveSettingsLocked(i);
        }
        logPasswordQualitySetIfSecurityLogEnabled(componentName, i, false, passwordPolicy);
    }

    public void semSetPasswordMinimumLetters(final ComponentName componentName, final int i) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isAuthorizedSamsungPackage(componentName));
            final int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            synchronized (getLockObject()) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda175
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$semSetPasswordMinimumLetters$204(componentName, userHandleGetCallingUserId, i);
                    }
                });
            }
            DevicePolicyEventLogger.createEvent(5).setAdmin(componentName).setInt(i).write();
        }
    }

    public /* synthetic */ void lambda$semSetPasswordMinimumLetters$204(ComponentName componentName, int i, int i2) {
        ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i);
        ensureMinimumQuality(i, activeAdminForCallerLockedMDM, 393216, "semSetPasswordMinimumLetters");
        PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
        if (passwordPolicy.letters != i2) {
            passwordPolicy.letters = i2;
            updatePasswordValidityCheckpointLocked(i, false);
            saveSettingsLocked(i);
        }
        logPasswordQualitySetIfSecurityLogEnabled(componentName, i, false, passwordPolicy);
    }

    public void semSetPasswordMinimumNumeric(final ComponentName componentName, final int i) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isAuthorizedSamsungPackage(componentName));
            final int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            synchronized (getLockObject()) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda143
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$semSetPasswordMinimumNumeric$205(componentName, userHandleGetCallingUserId, i);
                    }
                });
            }
            DevicePolicyEventLogger.createEvent(3).setAdmin(componentName).setInt(i).write();
        }
    }

    public /* synthetic */ void lambda$semSetPasswordMinimumNumeric$205(ComponentName componentName, int i, int i2) {
        ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i);
        ensureMinimumQuality(i, activeAdminForCallerLockedMDM, 393216, "semSetPasswordMinimumNumeric");
        PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
        if (passwordPolicy.numeric != i2) {
            passwordPolicy.numeric = i2;
            updatePasswordValidityCheckpointLocked(i, false);
            saveSettingsLocked(i);
        }
        logPasswordQualitySetIfSecurityLogEnabled(componentName, i, false, passwordPolicy);
    }

    public void semSetPasswordMinimumSymbols(final ComponentName componentName, final int i) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isAuthorizedSamsungPackage(componentName));
            final int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            synchronized (getLockObject()) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda102
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$semSetPasswordMinimumSymbols$206(componentName, userHandleGetCallingUserId, i);
                    }
                });
            }
            DevicePolicyEventLogger.createEvent(8).setAdmin(componentName).setInt(i).write();
        }
    }

    public /* synthetic */ void lambda$semSetPasswordMinimumSymbols$206(ComponentName componentName, int i, int i2) {
        ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i);
        ensureMinimumQuality(i, activeAdminForCallerLockedMDM, 393216, "semSetPasswordMinimumSymbols");
        PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
        if (passwordPolicy.symbols != i2) {
            passwordPolicy.symbols = i2;
            updatePasswordValidityCheckpointLocked(i, false);
            saveSettingsLocked(i);
        }
        logPasswordQualitySetIfSecurityLogEnabled(componentName, i, false, passwordPolicy);
    }

    public void semSetPasswordMinimumNonLetter(final ComponentName componentName, final int i) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isAuthorizedSamsungPackage(componentName));
            final int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            synchronized (getLockObject()) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda20
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$semSetPasswordMinimumNonLetter$207(componentName, userHandleGetCallingUserId, i);
                    }
                });
            }
            DevicePolicyEventLogger.createEvent(4).setAdmin(componentName).setInt(i).write();
        }
    }

    public /* synthetic */ void lambda$semSetPasswordMinimumNonLetter$207(ComponentName componentName, int i, int i2) {
        ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i);
        ensureMinimumQuality(i, activeAdminForCallerLockedMDM, 393216, "semSetPasswordMinimumNonLetter");
        PasswordPolicy passwordPolicy = activeAdminForCallerLockedMDM.mPasswordPolicy;
        if (passwordPolicy.nonLetter != i2) {
            passwordPolicy.nonLetter = i2;
            updatePasswordValidityCheckpointLocked(i, false);
            saveSettingsLocked(i);
        }
        logPasswordQualitySetIfSecurityLogEnabled(componentName, i, false, passwordPolicy);
    }

    public void semSetPasswordHistoryLength(final ComponentName componentName, final int i) {
        if (this.mHasFeature && this.mLockPatternUtils.hasSecureLockScreen()) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isAuthorizedSamsungPackage(componentName));
            final int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            synchronized (getLockObject()) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda162
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$semSetPasswordHistoryLength$208(componentName, userHandleGetCallingUserId, i);
                    }
                });
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210018, new Object[]{componentName.getPackageName(), Integer.valueOf(userHandleGetCallingUserId), Integer.valueOf(userHandleGetCallingUserId), Integer.valueOf(i)});
            }
        }
    }

    public /* synthetic */ void lambda$semSetPasswordHistoryLength$208(ComponentName componentName, int i, int i2) {
        ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i);
        if (activeAdminForCallerLockedMDM.passwordHistoryLength != i2) {
            activeAdminForCallerLockedMDM.passwordHistoryLength = i2;
            updatePasswordValidityCheckpointLocked(i, false);
            saveSettingsLocked(i);
        }
    }

    public void semSetPasswordExpirationTimeout(final ComponentName componentName, final long j) {
        if (this.mHasFeature && this.mLockPatternUtils.hasSecureLockScreen()) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isAuthorizedSamsungPackage(componentName));
            Preconditions.checkArgumentNonnegative(j, "Timeout must be >= 0 ms");
            final int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            synchronized (getLockObject()) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda201
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$semSetPasswordExpirationTimeout$209(componentName, userHandleGetCallingUserId, j);
                    }
                });
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210016, new Object[]{componentName.getPackageName(), Integer.valueOf(userHandleGetCallingUserId), Integer.valueOf(userHandleGetCallingUserId), Long.valueOf(j)});
            }
        }
    }

    public /* synthetic */ void lambda$semSetPasswordExpirationTimeout$209(ComponentName componentName, int i, long j) {
        ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i);
        long currentTimeMillis = j > 0 ? System.currentTimeMillis() + j : 0L;
        activeAdminForCallerLockedMDM.passwordExpirationDate = currentTimeMillis;
        activeAdminForCallerLockedMDM.passwordExpirationTimeout = j;
        if (j > 0) {
            Slogf.w("DevicePolicyManager", "semSetPasswordExpirationTimeout(): password will expire on " + DateFormat.getDateTimeInstance(2, 2).format(new Date(currentTimeMillis)));
        }
        saveSettingsLocked(i);
        setExpirationAlarmCheckLocked(this.mContext, i, false);
    }

    public boolean semIsActivePasswordSufficient(final int i) {
        boolean isActivePasswordSufficientForUserLocked;
        if (!this.mHasFeature) {
            return true;
        }
        Preconditions.checkArgumentNonnegative(i, "Invalid userId");
        Preconditions.checkCallAuthorization(hasFullCrossUsersPermission(getCallerIdentity(), i));
        enforceUserUnlocked(i, false);
        synchronized (getLockObject()) {
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda67
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$semIsActivePasswordSufficient$210(i);
                }
            });
            int credentialOwner = getCredentialOwner(i, false);
            DevicePolicyData userDataUnchecked = getUserDataUnchecked(credentialOwner);
            isActivePasswordSufficientForUserLocked = isActivePasswordSufficientForUserLocked(userDataUnchecked.mPasswordValidAtLastCheckpoint, this.mLockSettingsInternal.getUserPasswordMetrics(credentialOwner), getProfileParentUserIfRequested(i, false));
        }
        return isActivePasswordSufficientForUserLocked;
    }

    public /* synthetic */ void lambda$semIsActivePasswordSufficient$210(int i) {
        getActiveAdminForCallerLockedMDM(null, 0, i);
    }

    public void semSetCameraDisabled(final ComponentName componentName, final boolean z) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isAuthorizedSamsungPackage(componentName));
            checkCanExecuteOrThrowUnsafe(31);
            final int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            synchronized (getLockObject()) {
                this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda86
                    public final void runOrThrow() {
                        DevicePolicyManagerService.this.lambda$semSetCameraDisabled$211(componentName, userHandleGetCallingUserId, z);
                    }
                });
            }
            pushUserRestrictions(userHandleGetCallingUserId);
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210034, new Object[]{componentName.getPackageName(), Integer.valueOf(userHandleGetCallingUserId), Integer.valueOf(userHandleGetCallingUserId), Integer.valueOf(z ? 1 : 0)});
            }
            DevicePolicyEventLogger.createEvent(30).setAdmin(componentName).setBoolean(z).setStrings(new String[]{"notCalledFromParent"}).write();
        }
    }

    public /* synthetic */ void lambda$semSetCameraDisabled$211(ComponentName componentName, int i, boolean z) {
        ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 8, i);
        if (activeAdminForCallerLockedMDM.disableCamera != z) {
            activeAdminForCallerLockedMDM.disableCamera = z;
            saveSettingsLocked(i);
        }
    }

    public void semSetKeyguardDisabledFeatures(ComponentName componentName, int i) {
        if (this.mHasFeature) {
            Objects.requireNonNull(componentName, "ComponentName is null");
            Preconditions.checkCallAuthorization(isAuthorizedSamsungPackage(componentName));
            int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            synchronized (getLockObject()) {
                long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
                try {
                    ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 9, userHandleGetCallingUserId);
                    if (isManagedProfile(userHandleGetCallingUserId)) {
                        i &= 440;
                    }
                    if (activeAdminForCallerLockedMDM.disabledKeyguardFeatures != i) {
                        activeAdminForCallerLockedMDM.disabledKeyguardFeatures = i;
                        saveSettingsLocked(userHandleGetCallingUserId);
                    }
                } finally {
                    this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                }
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(210021, new Object[]{componentName.getPackageName(), Integer.valueOf(userHandleGetCallingUserId), Integer.valueOf(userHandleGetCallingUserId), Integer.valueOf(i)});
            }
            DevicePolicyEventLogger.createEvent(9).setAdmin(componentName).setInt(i).setStrings(new String[]{"notCalledFromParent"}).write();
        }
    }

    public void semSetSimplePasswordEnabled(final ComponentName componentName, final boolean z) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        final int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda77
                public final void runOrThrow() {
                    DevicePolicyManagerService.this.lambda$semSetSimplePasswordEnabled$212(componentName, userHandleGetCallingUserId, z);
                }
            });
        }
    }

    public /* synthetic */ void lambda$semSetSimplePasswordEnabled$212(ComponentName componentName, int i, boolean z) {
        ActiveAdmin activeAdminForCallerLockedMDM = getActiveAdminForCallerLockedMDM(componentName, 0, i);
        if (activeAdminForCallerLockedMDM.simplePasswordEnabled != z) {
            activeAdminForCallerLockedMDM.simplePasswordEnabled = z;
            saveSettingsLocked(i);
        }
    }

    public boolean semIsSimplePasswordEnabled(ComponentName componentName, int i) {
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.simplePasswordEnabled : true;
            }
            Iterator it = this.mUserManager.getProfiles(i).iterator();
            while (it.hasNext()) {
                DevicePolicyData userDataUnchecked = getUserDataUnchecked(((UserInfo) it.next()).id);
                int size = userDataUnchecked.mAdminList.size();
                int i2 = 0;
                while (true) {
                    if (i2 >= size) {
                        break;
                    }
                    ActiveAdmin activeAdmin = (ActiveAdmin) userDataUnchecked.mAdminList.get(i2);
                    if (r1 && !activeAdmin.simplePasswordEnabled) {
                        r1 = false;
                        break;
                    }
                    i2++;
                }
                if (!r1) {
                    break;
                }
            }
            return r1;
        }
    }

    public void semSetAllowStorageCard(ComponentName componentName, boolean z) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 11);
            if (activeAdminForCallerLocked.allowStorageCard != z) {
                activeAdminForCallerLocked.allowStorageCard = z;
                saveSettingsLocked(userHandleGetCallingUserId, false, false, true);
            }
        }
    }

    public boolean semGetAllowStorageCard(ComponentName componentName, int i) {
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.allowStorageCard : true;
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(0);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            boolean z = true;
            for (int i2 = 0; i2 < size; i2++) {
                ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2);
                if (z) {
                    z = activeAdmin.allowStorageCard;
                }
            }
            if (!z) {
                return z;
            }
            DevicePolicyData lambda$getUserDataUnchecked$22 = lambda$getUserDataUnchecked$2(i);
            int size2 = lambda$getUserDataUnchecked$22.mAdminList.size();
            boolean z2 = true;
            for (int i3 = 0; i3 < size2; i3++) {
                ActiveAdmin activeAdmin2 = (ActiveAdmin) lambda$getUserDataUnchecked$22.mAdminList.get(i3);
                if (z2) {
                    z2 = activeAdmin2.allowStorageCard;
                }
            }
            return z2;
        }
    }

    public void semSetAllowWifi(ComponentName componentName, boolean z) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 12);
            if (activeAdminForCallerLocked.allowWifi != z) {
                activeAdminForCallerLocked.allowWifi = z;
                saveSettingsLocked(userHandleGetCallingUserId, false, true, true);
            }
        }
    }

    public boolean semGetAllowWifi(ComponentName componentName, int i) {
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.allowWifi : true;
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(0);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            for (int i2 = 0; i2 < size; i2++) {
                if (!((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2)).allowWifi) {
                    return false;
                }
            }
            DevicePolicyData lambda$getUserDataUnchecked$22 = lambda$getUserDataUnchecked$2(i);
            int size2 = lambda$getUserDataUnchecked$22.mAdminList.size();
            for (int i3 = 0; i3 < size2; i3++) {
                if (!((ActiveAdmin) lambda$getUserDataUnchecked$22.mAdminList.get(i3)).allowWifi) {
                    return false;
                }
            }
            return true;
        }
    }

    public void semSetAllowTextMessaging(ComponentName componentName, boolean z) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 13);
            if (activeAdminForCallerLocked.allowTextMessaging != z) {
                activeAdminForCallerLocked.allowTextMessaging = z;
                saveSettingsLocked(userHandleGetCallingUserId);
            }
        }
    }

    public boolean semGetAllowTextMessaging(ComponentName componentName, int i) {
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.allowTextMessaging : true;
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            for (int i2 = 0; i2 < size; i2++) {
                if (!((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2)).allowTextMessaging) {
                    return false;
                }
            }
            return true;
        }
    }

    public void semSetAllowPopImapEmail(ComponentName componentName, boolean z) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 14);
            if (activeAdminForCallerLocked.allowPOPIMAPEmail != z) {
                activeAdminForCallerLocked.allowPOPIMAPEmail = z;
                saveSettingsLocked(userHandleGetCallingUserId);
            }
        }
    }

    public boolean semGetAllowPopImapEmail(ComponentName componentName, int i) {
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.allowPOPIMAPEmail : true;
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            for (int i2 = 0; i2 < size; i2++) {
                if (!((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2)).allowPOPIMAPEmail) {
                    return false;
                }
            }
            return true;
        }
    }

    public void semSetAllowBrowser(ComponentName componentName, boolean z) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 15);
            if (activeAdminForCallerLocked.allowBrowser != z) {
                activeAdminForCallerLocked.allowBrowser = z;
                saveSettingsLocked(userHandleGetCallingUserId);
            }
        }
    }

    public boolean semGetAllowBrowser(ComponentName componentName, int i) {
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.allowBrowser : true;
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            for (int i2 = 0; i2 < size; i2++) {
                if (!((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2)).allowBrowser) {
                    return false;
                }
            }
            return true;
        }
    }

    public void semSetAllowInternetSharing(ComponentName componentName, boolean z) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 16);
            if (activeAdminForCallerLocked.allowInternetSharing != z) {
                activeAdminForCallerLocked.allowInternetSharing = z;
                saveSettingsLocked(userHandleGetCallingUserId, false, false, true);
            }
        }
    }

    public boolean semGetAllowInternetSharing(ComponentName componentName, int i) {
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.allowInternetSharing : true;
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(0);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            for (int i2 = 0; i2 < size; i2++) {
                if (!((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2)).allowInternetSharing) {
                    return false;
                }
            }
            DevicePolicyData lambda$getUserDataUnchecked$22 = lambda$getUserDataUnchecked$2(i);
            int size2 = lambda$getUserDataUnchecked$22.mAdminList.size();
            for (int i3 = 0; i3 < size2; i3++) {
                if (!((ActiveAdmin) lambda$getUserDataUnchecked$22.mAdminList.get(i3)).allowInternetSharing) {
                    return false;
                }
            }
            return true;
        }
    }

    public void semSetAllowBluetoothMode(ComponentName componentName, int i) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 17);
            if (activeAdminForCallerLocked.allowBluetoothMode != i) {
                activeAdminForCallerLocked.allowBluetoothMode = i;
                saveSettingsLocked(userHandleGetCallingUserId, true, false, true);
            }
        }
    }

    public int semGetAllowBluetoothMode(ComponentName componentName, int i) {
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.allowBluetoothMode : 2;
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(0);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            int i2 = 2;
            for (int i3 = 0; i3 < size; i3++) {
                ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i3);
                if (i2 == 2) {
                    i2 = activeAdmin.allowBluetoothMode;
                }
            }
            if (i2 != 2) {
                Slogf.e("DevicePolicyManager", "semGetAllowBluetoothMode - value_root retunrs : " + i2);
                return i2;
            }
            DevicePolicyData lambda$getUserDataUnchecked$22 = lambda$getUserDataUnchecked$2(i);
            int size2 = lambda$getUserDataUnchecked$22.mAdminList.size();
            int i4 = 2;
            for (int i5 = 0; i5 < size2; i5++) {
                ActiveAdmin activeAdmin2 = (ActiveAdmin) lambda$getUserDataUnchecked$22.mAdminList.get(i5);
                if (i4 == 2) {
                    i4 = activeAdmin2.allowBluetoothMode;
                }
            }
            Slogf.e("DevicePolicyManager", "semGetAllowBluetoothMode - value retunrs : " + i4);
            return i4;
        }
    }

    public void semSetAllowDesktopSync(ComponentName componentName, boolean z) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 18);
            if (activeAdminForCallerLocked.allowDesktopSync != z) {
                activeAdminForCallerLocked.allowDesktopSync = z;
                saveSettingsLocked(userHandleGetCallingUserId, false, false, true);
            }
        }
    }

    public boolean semGetAllowDesktopSync(ComponentName componentName, int i) {
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.allowDesktopSync : true;
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(0);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            for (int i2 = 0; i2 < size; i2++) {
                if (!((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2)).allowDesktopSync) {
                    return false;
                }
            }
            DevicePolicyData lambda$getUserDataUnchecked$22 = lambda$getUserDataUnchecked$2(i);
            int size2 = lambda$getUserDataUnchecked$22.mAdminList.size();
            for (int i3 = 0; i3 < size2; i3++) {
                if (!((ActiveAdmin) lambda$getUserDataUnchecked$22.mAdminList.get(i3)).allowDesktopSync) {
                    return false;
                }
            }
            return true;
        }
    }

    public void semSetAllowIrda(ComponentName componentName, boolean z) {
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            ActiveAdmin activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 19);
            if (activeAdminForCallerLocked.allowIrDA != z) {
                activeAdminForCallerLocked.allowIrDA = z;
                saveSettingsLocked(userHandleGetCallingUserId);
            }
        }
    }

    public boolean semGetAllowIrda(ComponentName componentName, int i) {
        synchronized (getLockObject()) {
            if (componentName != null) {
                ActiveAdmin activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.allowIrDA : true;
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            for (int i2 = 0; i2 < size; i2++) {
                if (!((ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2)).allowIrDA) {
                    return false;
                }
            }
            return true;
        }
    }

    public void semSetRequireStorageCardEncryption(ComponentName componentName, boolean z, boolean z2) {
        ActiveAdmin activeAdminForCallerLocked;
        Objects.requireNonNull(componentName, "ComponentName is null");
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            if (this.mInjector.binderGetCallingPid() != Process.myPid()) {
                activeAdminForCallerLocked = getActiveAdminForCallerLocked(componentName, 20);
            } else if (!z2) {
                activeAdminForCallerLocked = getActiveAdminForCallerLockedMDM(componentName, 20, userHandleGetCallingUserId);
            } else {
                activeAdminForCallerLocked = getActiveAdminForCallerLockedMDM(componentName, 20, getOrganizationOwnedProfileUserId(), z2);
            }
            if (activeAdminForCallerLocked.requireStorageCardEncryption != z) {
                activeAdminForCallerLocked.requireStorageCardEncryption = z;
                if (z2) {
                    saveSettingsLocked(getOrganizationOwnedProfileUserId());
                } else {
                    saveSettingsLocked(userHandleGetCallingUserId);
                }
                if (SemSdCardEncryption.isEncryptionFeatureEnabled()) {
                    new SemSdCardEncryption(this.mContext).setAdminPolicy(z, (String) null);
                }
            }
        }
    }

    public boolean semGetRequireStorageCardEncryption(ComponentName componentName, int i, boolean z) {
        ActiveAdmin activeAdminUncheckedLocked;
        synchronized (getLockObject()) {
            int organizationOwnedProfileUserId = getOrganizationOwnedProfileUserId();
            if (componentName != null) {
                if (z) {
                    activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, organizationOwnedProfileUserId, true);
                } else {
                    activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                }
                return activeAdminUncheckedLocked != null ? activeAdminUncheckedLocked.requireStorageCardEncryption : false;
            }
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(i);
            int size = lambda$getUserDataUnchecked$2.mAdminList.size();
            boolean z2 = false;
            for (int i2 = 0; i2 < size; i2++) {
                ActiveAdmin activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2.mAdminList.get(i2);
                if (!z2) {
                    z2 = activeAdmin.requireStorageCardEncryption;
                }
            }
            if (organizationOwnedProfileUserId != -10000) {
                Iterator it = getActiveAdminsForAffectedUserLocked(getProfileParentId(organizationOwnedProfileUserId)).iterator();
                while (it.hasNext()) {
                    if (((ActiveAdmin) it.next()).requireStorageCardEncryption) {
                        z2 = true;
                    }
                }
            }
            return z2;
        }
    }

    public void semSetChangeNotificationEnabled(ComponentName componentName, boolean z) {
        if (componentName == null) {
            return;
        }
        if (!isPackageSignedByPlatform(componentName.getPackageName())) {
            Slogf.e("DevicePolicyManager", "Not Samsung Package, not proceeding.");
            return;
        }
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        synchronized (getLockObject()) {
            if (getActiveAdminUncheckedLocked(componentName, userHandleGetCallingUserId) == null) {
                return;
            }
            boolean z2 = z && !this.mNotifyChanges;
            this.mNotifyChanges = z;
            if (z2) {
                boolean semGetAllowWifi = semGetAllowWifi(null, userHandleGetCallingUserId);
                Slogf.d("DevicePolicyManager", "curAllowWifi = " + semGetAllowWifi + ", oldAllowWifi = " + this.oldAllowWifi);
                sendChangedNotification(userHandleGetCallingUserId, false, this.oldAllowWifi != semGetAllowWifi, false);
                this.oldAllowWifi = semGetAllowWifi;
            }
        }
    }

    public boolean isPackageSignedByPlatform(String str) {
        boolean z = this.mInjector.getPackageManager().checkSignatures("android", str) == 0;
        Log.d("DevicePolicyManager", "EAS IT Policy " + str + " isPackageSignedByPlatform = " + z);
        return z;
    }

    public final boolean isAuthorizedSamsungPackage(ComponentName componentName) {
        String packageName = componentName.getPackageName();
        if (!Arrays.asList(this.mInjector.getPackageManager().getPackagesForUid(this.mInjector.binderGetCallingUid())).contains(packageName)) {
            Slogf.e("DevicePolicyManager", "Invalid ComponentName for uid, not proceeding.");
            return false;
        }
        if (isPackageSignedByPlatform(packageName)) {
            return true;
        }
        Slogf.e("DevicePolicyManager", "Not Samsung Package, not proceeding.");
        return false;
    }

    public final void migrateKnoxPoliciesForWpcod(int i) {
        Log.d("DevicePolicyManager", "migrateKnoxPoliciesForWpcod()");
        try {
            IEnterpriseDeviceManager iEDMService = this.mInjector.getIEDMService();
            if (iEDMService != null) {
                iEDMService.migrateKnoxPoliciesForWpcod(i);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public final int addPseudoAdminForWpcod(final int i) {
        try {
            final IEnterpriseDeviceManager iEDMService = this.mInjector.getIEDMService();
            if (iEDMService == null) {
                return -1;
            }
            Log.d("DevicePolicyManager", "addPseudoAdminForWpcod:: containerId-" + i);
            return ((Integer) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda195
                public final Object getOrThrow() {
                    Integer lambda$addPseudoAdminForWpcod$213;
                    lambda$addPseudoAdminForWpcod$213 = DevicePolicyManagerService.lambda$addPseudoAdminForWpcod$213(iEDMService, i);
                    return lambda$addPseudoAdminForWpcod$213;
                }
            })).intValue();
        } catch (Exception e) {
            Log.d("DevicePolicyManager", "addPseudoAdminForWpcod: exception: " + e.getMessage());
            e.printStackTrace();
            return -1;
        }
    }

    public static /* synthetic */ Integer lambda$addPseudoAdminForWpcod$213(IEnterpriseDeviceManager iEnterpriseDeviceManager, int i) {
        return Integer.valueOf(iEnterpriseDeviceManager.addPseudoAdminForParent(i));
    }

    public final void migrateApplicationRestrictions() {
        KnoxsdkFileLog.d("DevicePolicyManager", "migrateApplicationRestrictions for wpcod");
        try {
            IKnoxCustomManager kCMService = this.mInjector.getKCMService();
            if (kCMService != null) {
                kCMService.migrateApplicationRestrictions();
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public final EnforcingAdmin enforcePermissionsAndGetEnforcingAdmin(ComponentName componentName, String[] strArr, String str, int i) {
        enforcePermissions(strArr, str, i);
        return getEnforcingAdminForCaller(componentName, str);
    }

    public final EnforcingAdmin enforcePermissionAndGetEnforcingAdmin(ComponentName componentName, String str, String str2, int i) {
        enforcePermission(str, str2, i);
        return getEnforcingAdminForCaller(componentName, str2);
    }

    public final EnforcingAdmin enforcePermissionAndGetEnforcingAdmin(ComponentName componentName, String str, int i, String str2, int i2) {
        enforcePermission(str, i, str2, i2);
        return getEnforcingAdminForCaller(componentName, str2);
    }

    public final EnforcingAdmin enforcePermissionsAndGetEnforcingAdmin(ComponentName componentName, String[] strArr, int i, String str, int i2) {
        enforcePermissions(strArr, i, str, i2);
        return getEnforcingAdminForCaller(componentName, str);
    }

    public final EnforcingAdmin enforceCanQueryAndGetEnforcingAdmin(ComponentName componentName, String str, String str2, int i) {
        enforceCanQuery(str, str2, i);
        return getEnforcingAdminForCaller(componentName, str2);
    }

    public final void enforcePermission(String str, String str2) {
        if (hasPermission(str, str2)) {
            return;
        }
        throw new SecurityException("Caller does not have the required permissions for this user. Permission required: " + str + ".");
    }

    public final void enforcePermission(String str, String str2, int i) {
        enforcePermission(str, str2);
        if (i != getCallerIdentity(str2).getUserId()) {
            enforcePermission((String) CROSS_USER_PERMISSIONS.get(str), str2);
        }
    }

    public final void enforcePermissions(String[] strArr, String str, int i) {
        String str2;
        int length = strArr.length;
        int i2 = 0;
        while (true) {
            if (i2 >= length) {
                str2 = "";
                break;
            }
            str2 = strArr[i2];
            if (hasPermission(str2, str)) {
                break;
            } else {
                i2++;
            }
        }
        if (str2.isEmpty()) {
            throw new SecurityException("Caller does not have the required permissions for this user. One of the following permission required: " + Arrays.toString(strArr));
        }
        enforcePermission(str2, str, i);
    }

    public final void enforcePermission(String str, int i, String str2, int i2) {
        if (hasAdminPolicy(i, str2)) {
            return;
        }
        enforcePermission(str, str2, i2);
    }

    public final void enforcePermissions(String[] strArr, int i, String str, int i2) {
        if (hasAdminPolicy(i, str) && this.mInjector.userHandleGetCallingUserId() == i2) {
            return;
        }
        enforcePermissions(strArr, str, i2);
    }

    public final void enforceCanQuery(String str, String str2, int i) {
        if (hasPermission("android.permission.QUERY_ADMIN_POLICY", str2)) {
            return;
        }
        enforcePermission(str, str2, i);
    }

    public final boolean hasAdminPolicy(int i, String str) {
        return getActiveAdminWithPolicyForUidLocked(null, i, getCallerIdentity(str).getUid()) != null;
    }

    public final boolean hasPermission(String str, String str2, int i) {
        CallerIdentity callerIdentity = getCallerIdentity(str2);
        boolean hasPermission = hasPermission(str, callerIdentity.getPackageName());
        return hasPermission && (!hasPermission || callerIdentity.getUserId() == i || hasPermission((String) CROSS_USER_PERMISSIONS.get(str), callerIdentity.getPackageName()));
    }

    public final boolean hasPermission(String str, String str2) {
        Objects.requireNonNull(str2, "callerPackageName is null");
        if (str == null) {
            return true;
        }
        CallerIdentity callerIdentity = getCallerIdentity(str2);
        if (this.mContext.checkCallingOrSelfPermission(str) == 0) {
            return true;
        }
        int dpcType = getDpcType(callerIdentity);
        if (dpcType != -1) {
            return ((List) DPC_PERMISSIONS.get(Integer.valueOf(dpcType))).contains(str);
        }
        if (isCallerDevicePolicyManagementRoleHolder(callerIdentity)) {
            return anyDpcHasPermission(str, callerIdentity.getUserId());
        }
        HashMap hashMap = DELEGATE_SCOPES;
        if (hashMap.containsKey(str)) {
            return isCallerDelegate(callerIdentity, (String) hashMap.get(str));
        }
        return false;
    }

    public final boolean anyDpcHasPermission(String str, int i) {
        if (this.mOwners.isDefaultDeviceOwnerUserId(i)) {
            return ((List) DPC_PERMISSIONS.get(0)).contains(str);
        }
        if (this.mOwners.isFinancedDeviceOwnerUserId(i)) {
            return ((List) DPC_PERMISSIONS.get(1)).contains(str);
        }
        if (this.mOwners.isProfileOwnerOfOrganizationOwnedDevice(i)) {
            return ((List) DPC_PERMISSIONS.get(2)).contains(str);
        }
        if (i == 0 && this.mOwners.hasProfileOwner(0)) {
            return ((List) DPC_PERMISSIONS.get(3)).contains(str);
        }
        if (this.mOwners.hasProfileOwner(i)) {
            return ((List) DPC_PERMISSIONS.get(4)).contains(str);
        }
        return false;
    }

    public final EnforcingAdmin getEnforcingAdminForCaller(ComponentName componentName, String str) {
        ActiveAdmin deviceOrProfileOwnerAdminLocked;
        CallerIdentity callerIdentity = getCallerIdentity(componentName, str);
        int userId = callerIdentity.getUserId();
        if (isDeviceOwner(callerIdentity) || isProfileOwner(callerIdentity) || isCallerDelegate(callerIdentity)) {
            synchronized (getLockObject()) {
                if (componentName != null) {
                    deviceOrProfileOwnerAdminLocked = getActiveAdminUncheckedLocked(componentName, userId);
                } else {
                    deviceOrProfileOwnerAdminLocked = getDeviceOrProfileOwnerAdminLocked(userId);
                    componentName = deviceOrProfileOwnerAdminLocked.info.getComponent();
                }
            }
            return EnforcingAdmin.createEnterpriseEnforcingAdmin(componentName, userId, deviceOrProfileOwnerAdminLocked);
        }
        ActiveAdmin activeAdminForCaller = getActiveAdminForCaller(componentName, callerIdentity);
        if (activeAdminForCaller != null) {
            return EnforcingAdmin.createDeviceAdminEnforcingAdmin(activeAdminForCaller.info.getComponent(), userId, activeAdminForCaller);
        }
        return EnforcingAdmin.createEnforcingAdmin(callerIdentity.getPackageName(), userId, lambda$getUserDataUnchecked$2(userId).createOrGetPermissionBasedAdmin(userId));
    }

    public final EnforcingAdmin getEnforcingAdminForPackage(ComponentName componentName, String str, int i) {
        ActiveAdmin activeAdminUncheckedLocked;
        if (componentName != null) {
            if (isDeviceOwner(componentName, i) || isProfileOwner(componentName, i)) {
                synchronized (getLockObject()) {
                    activeAdminUncheckedLocked = getActiveAdminUncheckedLocked(componentName, i);
                }
                if (activeAdminUncheckedLocked != null) {
                    return EnforcingAdmin.createEnterpriseEnforcingAdmin(componentName, i, activeAdminUncheckedLocked);
                }
            } else {
                ActiveAdmin activeAdminUncheckedLocked2 = getActiveAdminUncheckedLocked(componentName, i);
                if (activeAdminUncheckedLocked2 != null) {
                    return EnforcingAdmin.createDeviceAdminEnforcingAdmin(componentName, i, activeAdminUncheckedLocked2);
                }
            }
        }
        return EnforcingAdmin.createEnforcingAdmin(str, i, lambda$getUserDataUnchecked$2(i).createOrGetPermissionBasedAdmin(i));
    }

    public final int getAffectedUser(boolean z) {
        int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
        return z ? getProfileParentId(userHandleGetCallingUserId) : userHandleGetCallingUserId;
    }

    public final int getDpcType(CallerIdentity callerIdentity) {
        if (isDefaultDeviceOwner(callerIdentity)) {
            return 0;
        }
        if (isFinancedDeviceOwner(callerIdentity)) {
            return 1;
        }
        if (!isProfileOwner(callerIdentity)) {
            return -1;
        }
        if (isProfileOwnerOfOrganizationOwnedDevice(callerIdentity)) {
            return 2;
        }
        if (isManagedProfile(callerIdentity.getUserId())) {
            return 4;
        }
        if (isProfileOwnerOnUser0(callerIdentity)) {
            return 3;
        }
        return isUserAffiliatedWithDevice(callerIdentity.getUserId()) ? 6 : 5;
    }

    public final boolean isPermissionCheckFlagEnabled() {
        return DeviceConfig.getBoolean("device_policy_manager", "enable_permission_based_access", false);
    }

    public static boolean isPolicyEngineForFinanceFlagEnabled() {
        return DeviceConfig.getBoolean("device_policy_manager", "enable_device_policy_engine", true);
    }

    public final void setKeepProfileRunningEnabledUnchecked(boolean z) {
        synchronized (getLockObject()) {
            DevicePolicyData userDataUnchecked = getUserDataUnchecked(0);
            if (userDataUnchecked.mEffectiveKeepProfilesRunning == z) {
                return;
            }
            userDataUnchecked.mEffectiveKeepProfilesRunning = z;
            saveSettingsLocked(0);
            suspendAppsForQuietProfiles(z);
        }
    }

    public void setOverrideKeepProfilesRunning(boolean z) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        setKeepProfileRunningEnabledUnchecked(z);
        Slog.i("DevicePolicyManager", "Keep profiles running overridden to: " + z);
    }

    public void setMtePolicy(int i, String str) {
        ActiveAdmin deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked;
        Preconditions.checkArgument(Set.of(0, 2, 1).contains(Integer.valueOf(i)), "Provided mode is not one of the allowed values.");
        Injector injector = this.mInjector;
        if (!injector.systemPropertiesGetBoolean("ro.arm64.memtag.bootctl_device_policy_manager", injector.systemPropertiesGetBoolean("ro.arm64.memtag.bootctl_settings_toggle", false))) {
            throw new UnsupportedOperationException("device does not support MTE");
        }
        CallerIdentity callerIdentity = getCallerIdentity(str);
        if (i == 2) {
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity));
        }
        if (isPermissionCheckFlagEnabled()) {
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_MTE", callerIdentity.getPackageName(), -1);
        } else {
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity));
        }
        synchronized (getLockObject()) {
            if (isHeadlessFlagEnabled()) {
                deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked();
            } else {
                deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked(0);
            }
            if (deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked != null) {
                if (i == 1) {
                    this.mInjector.systemPropertiesSet("arm64.memtag.bootctl", "memtag");
                } else if (i == 2) {
                    this.mInjector.systemPropertiesSet("arm64.memtag.bootctl", "memtag-off");
                }
                deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked.mtePolicy = i;
                saveSettingsLocked(callerIdentity.getUserId());
                DevicePolicyEventLogger.createEvent(FrameworkStatsLog.DEVICE_POLICY_EVENT__EVENT_ID__SET_MTE_POLICY).setInt(i).setAdmin(callerIdentity.getPackageName()).write();
            }
        }
    }

    public int getMtePolicy(String str) {
        ActiveAdmin deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked;
        int i;
        CallerIdentity callerIdentity = getCallerIdentity(str);
        if (isPermissionCheckFlagEnabled()) {
            enforcePermission("android.permission.MANAGE_DEVICE_POLICY_MTE", callerIdentity.getPackageName(), -1);
        } else {
            Preconditions.checkCallAuthorization(isDefaultDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) || isSystemUid(callerIdentity));
        }
        synchronized (getLockObject()) {
            if (isHeadlessFlagEnabled()) {
                deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked();
            } else {
                deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked(0);
            }
            i = deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked != null ? deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked.mtePolicy : 0;
        }
        return i;
    }

    public final boolean isHeadlessFlagEnabled() {
        return DeviceConfig.getBoolean("device_policy_manager", "headless", true);
    }

    public ManagedSubscriptionsPolicy getManagedSubscriptionsPolicy() {
        ManagedSubscriptionsPolicy managedSubscriptionsPolicy;
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerOfOrganizationOwnedDeviceLocked = getProfileOwnerOfOrganizationOwnedDeviceLocked();
            return (profileOwnerOfOrganizationOwnedDeviceLocked == null || (managedSubscriptionsPolicy = profileOwnerOfOrganizationOwnedDeviceLocked.mManagedSubscriptionsPolicy) == null) ? new ManagedSubscriptionsPolicy(0) : managedSubscriptionsPolicy;
        }
    }

    public void setManagedSubscriptionsPolicy(ManagedSubscriptionsPolicy managedSubscriptionsPolicy) {
        boolean z;
        CallerIdentity callerIdentity = getCallerIdentity();
        if (!isCallerDevicePolicyManagementRoleHolder(callerIdentity) && !Objects.equals(this.mInjector.settingsGlobalGetString("allow_work_profile_telephony_for_non_dpm_role_holders"), "1")) {
            throw new UnsupportedOperationException("This api is not enabled");
        }
        Preconditions.checkCallAuthorization(isProfileOwnerOfOrganizationOwnedDevice(callerIdentity), "This policy can only be set by a profile owner on an organization-owned device.");
        int profileParentId = getProfileParentId(callerIdentity.getUserId());
        synchronized (getLockObject()) {
            ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(callerIdentity.getUserId());
            if (hasUserSetupCompleted(profileParentId) && !isAdminTestOnlyLocked(profileOwnerLocked.info.getComponent(), callerIdentity.getUserId())) {
                throw new IllegalStateException("Not allowed to apply this policy after setup");
            }
            if (Objects.equals(managedSubscriptionsPolicy, profileOwnerLocked.mManagedSubscriptionsPolicy)) {
                z = false;
            } else {
                profileOwnerLocked.mManagedSubscriptionsPolicy = managedSubscriptionsPolicy;
                z = true;
            }
            if (z) {
                saveSettingsLocked(callerIdentity.getUserId());
                applyManagedSubscriptionsPolicyIfRequired();
                int policyType = getManagedSubscriptionsPolicy().getPolicyType();
                long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
                try {
                    if (policyType == 1) {
                        installOemDefaultDialerAndSmsApp(callerIdentity.getUserId());
                        updateTelephonyCrossProfileIntentFilters(profileParentId, callerIdentity.getUserId(), true);
                    } else {
                        if (policyType == 0) {
                            updateTelephonyCrossProfileIntentFilters(profileParentId, callerIdentity.getUserId(), false);
                        }
                        this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                    }
                    this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                } catch (Throwable th) {
                    this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                    throw th;
                }
            }
        }
    }

    public final void installOemDefaultDialerAndSmsApp(int i) {
        try {
            String oemDefaultDialerPackage = getOemDefaultDialerPackage();
            String oemDefaultSmsPackage = getOemDefaultSmsPackage();
            if (oemDefaultDialerPackage != null) {
                this.mIPackageManager.installExistingPackageAsUser(oemDefaultDialerPackage, i, 4194304, 1, (List) null);
            } else {
                Slogf.w("DevicePolicyManager", "Couldn't install dialer app, dialer app package is null");
            }
            Slog.e("DevicePolicyManager", "[installOemDefaultDialerAndSmsApp] defaultSmsPackageName = " + oemDefaultSmsPackage);
            if (oemDefaultSmsPackage != null) {
                this.mIPackageManager.installExistingPackageAsUser(oemDefaultSmsPackage, i, 4194304, 1, (List) null);
            } else {
                Slogf.w("DevicePolicyManager", "Couldn't install sms app, sms app package is null");
            }
            lambda$setDefaultSmsApplication$90();
        } catch (RemoteException e) {
            Slogf.wtf("DevicePolicyManager", "Failed to install dialer/sms app", e);
        }
    }

    public final String getOemDefaultDialerPackage() {
        return ((TelecomManager) this.mContext.getSystemService(TelecomManager.class)).getSystemDialerPackage();
    }

    public final String getOemDefaultSmsPackage() {
        return SmsApplication.getDefaultSmsApplication(this.mContext, true).getPackageName();
    }

    /* renamed from: updateDialerAndSmsManagedShortcutsOverrideCache, reason: merged with bridge method [inline-methods] and merged with bridge method [inline-methods] */
    public final void lambda$setDefaultSmsApplication$90() {
        ArrayMap arrayMap = new ArrayMap();
        int managedUserId = getManagedUserId();
        List roleHoldersAsUser = this.mRoleManager.getRoleHoldersAsUser("android.app.role.DIALER", UserHandle.of(managedUserId));
        List roleHoldersAsUser2 = this.mRoleManager.getRoleHoldersAsUser("android.app.role.SMS", UserHandle.of(managedUserId));
        String oemDefaultDialerPackage = getOemDefaultDialerPackage();
        String oemDefaultSmsPackage = getOemDefaultSmsPackage();
        if (oemDefaultDialerPackage != null) {
            arrayMap.put(oemDefaultDialerPackage, roleHoldersAsUser.isEmpty() ? oemDefaultDialerPackage : (String) roleHoldersAsUser.get(0));
        }
        if (oemDefaultSmsPackage != null) {
            arrayMap.put(oemDefaultSmsPackage, roleHoldersAsUser2.isEmpty() ? oemDefaultSmsPackage : (String) roleHoldersAsUser2.get(0));
        }
        this.mPolicyCache.setLauncherShortcutOverrides(arrayMap);
    }

    public void setBluetoothContactSharingEnabledForKnox(int i, boolean z) {
        ActiveAdmin profileOwnerAdminLocked;
        if (KnoxUtils.isSpfKnoxSupported() && this.mHasFeature) {
            synchronized (getLockObject()) {
                if (SemPersonaManager.isKnoxId(i) && isCalledFromMDMAdmin(i) && (profileOwnerAdminLocked = getProfileOwnerAdminLocked(i)) != null) {
                    profileOwnerAdminLocked.disableBluetoothContactSharing = !z;
                    saveSettingsLocked(i);
                }
            }
        }
    }

    public boolean getBluetoothContactSharingEnabledForKnox(int i) {
        boolean z = false;
        if (!KnoxUtils.isSpfKnoxSupported()) {
            return false;
        }
        synchronized (getLockObject()) {
            if (!SemPersonaManager.isKnoxId(i)) {
                return false;
            }
            ActiveAdmin profileOwnerAdminLocked = getProfileOwnerAdminLocked(i);
            if (profileOwnerAdminLocked != null && !profileOwnerAdminLocked.disableBluetoothContactSharing) {
                z = true;
            }
            return z;
        }
    }

    public void setUserRestrictionForKnox(ComponentName componentName, String str, boolean z, int i) {
        Exception e;
        boolean z2;
        ActiveAdmin activeAdmin;
        Objects.requireNonNull(componentName, "ComponentName is null");
        if (UserRestrictionsUtils.isValidRestriction(str)) {
            int userHandleGetCallingUserId = this.mInjector.userHandleGetCallingUserId();
            synchronized (getLockObject()) {
                try {
                    z2 = isCalledFromMDMAdmin(userHandleGetCallingUserId);
                    try {
                        activeAdmin = (ActiveAdmin) lambda$getUserDataUnchecked$2(i).mAdminMap.get(componentName);
                        try {
                            if (this.mInjector.binderGetCallingUid() == 1000) {
                                z2 = true;
                            }
                        } catch (Exception e2) {
                            e = e2;
                            e.printStackTrace();
                            Log.d("DevicePolicyManager", "setUserRestrictionForKnox() isCalledFromMDMAdmin = " + z2);
                            if (z2) {
                            }
                            throw new SecurityException("Caller is not Device admin. cannot set user restriction " + str);
                        }
                    } catch (Exception e3) {
                        activeAdmin = null;
                        e = e3;
                    }
                } catch (Exception e4) {
                    e = e4;
                    i = userHandleGetCallingUserId;
                    z2 = false;
                    activeAdmin = null;
                }
                Log.d("DevicePolicyManager", "setUserRestrictionForKnox() isCalledFromMDMAdmin = " + z2);
                if (z2 || activeAdmin == null) {
                    throw new SecurityException("Caller is not Device admin. cannot set user restriction " + str);
                }
                Bundle ensureUserRestrictions = activeAdmin.ensureUserRestrictions();
                if (z) {
                    ensureUserRestrictions.putBoolean(str, true);
                } else {
                    ensureUserRestrictions.remove(str);
                }
                saveUserRestrictionsLocked(i);
            }
            if (SecurityLog.isLoggingEnabled()) {
                SecurityLog.writeEvent(z ? 210027 : 210028, new Object[]{componentName.getPackageName(), Integer.valueOf(i), str});
            }
        }
    }

    public final boolean isMultifactorAuthEnforced(int i) {
        boolean z = false;
        try {
            if (i == 0) {
                EnterpriseDeviceManager edm = this.mInjector.getEDM();
                if (edm != null) {
                    z = edm.getPasswordPolicy().isMultifactorAuthenticationEnabled();
                }
            } else {
                KnoxContainerManager kcm = this.mInjector.getKCM(i);
                if (kcm != null) {
                    z = kcm.getPasswordPolicy().isMultifactorAuthenticationEnabled();
                }
            }
        } catch (SecurityException e) {
            Log.d("DevicePolicyManager", "SecurityException : " + e);
        }
        return z;
    }

    public final void registerListenerToAssignSubscriptionsToUser(int i) {
        synchronized (this.mSubscriptionsChangedListenerLock) {
            if (this.mSubscriptionsChangedListener != null) {
                return;
            }
            SubscriptionManager subscriptionManager = (SubscriptionManager) this.mContext.getSystemService(SubscriptionManager.class);
            this.mSubscriptionsChangedListener = new SubscriptionManager.OnSubscriptionsChangedListener(this.mHandler.getLooper()) { // from class: com.android.server.devicepolicy.DevicePolicyManagerService.8
                public final /* synthetic */ SubscriptionManager val$subscriptionManager;
                public final /* synthetic */ int val$userId;

                /* JADX WARN: 'super' call moved to the top of the method (can break code semantics) */
                public AnonymousClass8(Looper looper, SubscriptionManager subscriptionManager2, int i2) {
                    super(looper);
                    r3 = subscriptionManager2;
                    r4 = i2;
                }

                @Override // android.telephony.SubscriptionManager.OnSubscriptionsChangedListener
                public void onSubscriptionsChanged() {
                    long binderClearCallingIdentity = DevicePolicyManagerService.this.mInjector.binderClearCallingIdentity();
                    try {
                        for (int i2 : r3.getActiveSubscriptionIdList(false)) {
                            UserHandle subscriptionUserHandle = r3.getSubscriptionUserHandle(i2);
                            if (subscriptionUserHandle == null || subscriptionUserHandle.getIdentifier() != r4) {
                                r3.setSubscriptionUserHandle(i2, UserHandle.of(r4));
                            }
                        }
                    } finally {
                        DevicePolicyManagerService.this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
                    }
                }
            };
            long binderClearCallingIdentity = this.mInjector.binderClearCallingIdentity();
            try {
                subscriptionManager2.addOnSubscriptionsChangedListener(this.mSubscriptionsChangedListener.getHandlerExecutor(), this.mSubscriptionsChangedListener);
            } finally {
                this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        }
    }

    /* renamed from: com.android.server.devicepolicy.DevicePolicyManagerService$8 */
    /* loaded from: classes2.dex */
    public class AnonymousClass8 extends SubscriptionManager.OnSubscriptionsChangedListener {
        public final /* synthetic */ SubscriptionManager val$subscriptionManager;
        public final /* synthetic */ int val$userId;

        /* JADX WARN: 'super' call moved to the top of the method (can break code semantics) */
        public AnonymousClass8(Looper looper, SubscriptionManager subscriptionManager2, int i2) {
            super(looper);
            r3 = subscriptionManager2;
            r4 = i2;
        }

        @Override // android.telephony.SubscriptionManager.OnSubscriptionsChangedListener
        public void onSubscriptionsChanged() {
            long binderClearCallingIdentity = DevicePolicyManagerService.this.mInjector.binderClearCallingIdentity();
            try {
                for (int i2 : r3.getActiveSubscriptionIdList(false)) {
                    UserHandle subscriptionUserHandle = r3.getSubscriptionUserHandle(i2);
                    if (subscriptionUserHandle == null || subscriptionUserHandle.getIdentifier() != r4) {
                        r3.setSubscriptionUserHandle(i2, UserHandle.of(r4));
                    }
                }
            } finally {
                DevicePolicyManagerService.this.mInjector.binderRestoreCallingIdentity(binderClearCallingIdentity);
            }
        }
    }

    public final void unregisterOnSubscriptionsChangedListener() {
        synchronized (this.mSubscriptionsChangedListenerLock) {
            if (this.mSubscriptionsChangedListener != null) {
                ((SubscriptionManager) this.mContext.getSystemService(SubscriptionManager.class)).removeOnSubscriptionsChangedListener(this.mSubscriptionsChangedListener);
                this.mSubscriptionsChangedListener = null;
            }
        }
    }

    public DevicePolicyState getDevicePolicyState() {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        Injector injector = this.mInjector;
        final DevicePolicyEngine devicePolicyEngine = this.mDevicePolicyEngine;
        Objects.requireNonNull(devicePolicyEngine);
        return (DevicePolicyState) injector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda91
            public final Object getOrThrow() {
                return DevicePolicyEngine.this.getDevicePolicyState();
            }
        });
    }

    public boolean triggerDevicePolicyEngineMigration(final boolean z) {
        Preconditions.checkCallAuthorization(hasCallingOrSelfPermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS"));
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda66
            public final Object getOrThrow() {
                Boolean lambda$triggerDevicePolicyEngineMigration$214;
                lambda$triggerDevicePolicyEngineMigration$214 = DevicePolicyManagerService.this.lambda$triggerDevicePolicyEngineMigration$214(z);
                return lambda$triggerDevicePolicyEngineMigration$214;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$triggerDevicePolicyEngineMigration$214(boolean z) {
        boolean z2;
        synchronized (getLockObject()) {
            if (z) {
                try {
                    if (!hasNonTestOnlyActiveAdmins()) {
                        z2 = true;
                        if (z2 && !shouldMigrateToDevicePolicyEngine()) {
                            return Boolean.FALSE;
                        }
                        return Boolean.valueOf(migratePoliciesPostUpgradeToDevicePolicyEngineLocked() & migratePoliciesToDevicePolicyEngine());
                    }
                } catch (Throwable th) {
                    throw th;
                }
            }
            z2 = false;
            if (z2) {
            }
            return Boolean.valueOf(migratePoliciesPostUpgradeToDevicePolicyEngineLocked() & migratePoliciesToDevicePolicyEngine());
        }
    }

    public final boolean hasNonTestOnlyActiveAdmins() {
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda220
            public final Object getOrThrow() {
                Boolean lambda$hasNonTestOnlyActiveAdmins$215;
                lambda$hasNonTestOnlyActiveAdmins$215 = DevicePolicyManagerService.this.lambda$hasNonTestOnlyActiveAdmins$215();
                return lambda$hasNonTestOnlyActiveAdmins$215;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$hasNonTestOnlyActiveAdmins$215() {
        for (UserInfo userInfo : this.mUserManager.getUsers()) {
            synchronized (getLockObject()) {
                List<ComponentName> activeAdmins = getActiveAdmins(userInfo.id);
                if (activeAdmins != null) {
                    for (ComponentName componentName : activeAdmins) {
                        if (!isAdminTestOnlyLocked(componentName, userInfo.id) && !isSamsungInternalAdmin(componentName.getPackageName())) {
                            return Boolean.TRUE;
                        }
                    }
                }
            }
        }
        return Boolean.FALSE;
    }

    public final boolean isSamsungInternalAdmin(String str) {
        return KnoxCustomManagerService.KG_PKG_NAME.equals(str) || "com.nttdocomo.android.remotelock".equals(str) || "com.nttdocomo.android.wipe".equals(str);
    }

    public final boolean shouldMigrateToDevicePolicyEngine() {
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda98
            public final Object getOrThrow() {
                Boolean lambda$shouldMigrateToDevicePolicyEngine$216;
                lambda$shouldMigrateToDevicePolicyEngine$216 = DevicePolicyManagerService.this.lambda$shouldMigrateToDevicePolicyEngine$216();
                return lambda$shouldMigrateToDevicePolicyEngine$216;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$shouldMigrateToDevicePolicyEngine$216() {
        return Boolean.valueOf((isPermissionCheckFlagEnabled() || isPolicyEngineForFinanceFlagEnabled()) && !this.mOwners.isMigratedToPolicyEngine());
    }

    public final void maybeMigratePoliciesPostUpgradeToDevicePolicyEngineLocked() {
        if (!this.mOwners.isMigratedToPolicyEngine() || this.mOwners.isMigratedPostUpdate()) {
            return;
        }
        migratePoliciesPostUpgradeToDevicePolicyEngineLocked();
        this.mOwners.markPostUpgradeMigration();
    }

    public final boolean migratePoliciesPostUpgradeToDevicePolicyEngineLocked() {
        try {
            migrateScreenCapturePolicyLocked();
            migrateLockTaskPolicyLocked();
            migrateUserRestrictionsLocked();
            return true;
        } catch (Exception e) {
            Slogf.e("DevicePolicyManager", e, "Error occurred during post upgrade migration to the device policy engine.", new Object[0]);
            return false;
        }
    }

    public final boolean migratePoliciesToDevicePolicyEngine() {
        return ((Boolean) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda139
            public final Object getOrThrow() {
                Boolean lambda$migratePoliciesToDevicePolicyEngine$217;
                lambda$migratePoliciesToDevicePolicyEngine$217 = DevicePolicyManagerService.this.lambda$migratePoliciesToDevicePolicyEngine$217();
                return lambda$migratePoliciesToDevicePolicyEngine$217;
            }
        })).booleanValue();
    }

    public /* synthetic */ Boolean lambda$migratePoliciesToDevicePolicyEngine$217() {
        Boolean bool;
        try {
            synchronized (getLockObject()) {
                Slogf.i("DevicePolicyManager", "Started device policies migration to the device policy engine.");
                if (isUnicornFlagEnabled()) {
                    migrateAutoTimezonePolicy();
                    migratePermissionGrantStatePolicies();
                }
                migratePermittedInputMethodsPolicyLocked();
                migrateAccountManagementDisabledPolicyLocked();
                migrateUserControlDisabledPackagesLocked();
                this.mOwners.markMigrationToPolicyEngine();
                bool = Boolean.TRUE;
            }
            return bool;
        } catch (Exception e) {
            this.mDevicePolicyEngine.clearAllPolicies();
            Slogf.e("DevicePolicyManager", e, "Error occurred during device policy migration, will reattempt on the next system server restart.", new Object[0]);
            return Boolean.FALSE;
        }
    }

    public final void migrateAutoTimezonePolicy() {
        Slogf.i("DevicePolicyManager", "Skipping Migration of AUTO_TIMEZONE policy to device policy engine,as no way to identify if the value was set by the admin or the user.");
    }

    public final void migratePermissionGrantStatePolicies() {
        int i;
        Slogf.i("DevicePolicyManager", "Migrating PERMISSION_GRANT policy to device policy engine.");
        for (UserInfo userInfo : this.mUserManager.getUsers()) {
            ActiveAdmin mostProbableDPCAdminForLocalPolicy = getMostProbableDPCAdminForLocalPolicy(userInfo.id);
            if (mostProbableDPCAdminForLocalPolicy == null) {
                Slogf.i("DevicePolicyManager", "No admin found that can set permission grant state on user " + userInfo.id);
            } else {
                for (PackageInfo packageInfo : getInstalledPackagesOnUser(userInfo.id)) {
                    String[] strArr = packageInfo.requestedPermissions;
                    if (strArr != null) {
                        for (String str : strArr) {
                            if (isRuntimePermission(str)) {
                                try {
                                    i = getPermissionGrantStateForUser(packageInfo.packageName, str, new CallerIdentity(this.mInjector.binderGetCallingUid(), mostProbableDPCAdminForLocalPolicy.info.getComponent().getPackageName(), mostProbableDPCAdminForLocalPolicy.info.getComponent()), userInfo.id);
                                } catch (RemoteException e) {
                                    Slogf.e("DevicePolicyManager", e, "Error retrieving permission grant state for %s and %s", packageInfo.packageName, str);
                                    i = 0;
                                }
                                if (i != 0) {
                                    this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.PERMISSION_GRANT(packageInfo.packageName, str), EnforcingAdmin.createEnterpriseEnforcingAdmin(mostProbableDPCAdminForLocalPolicy.info.getComponent(), mostProbableDPCAdminForLocalPolicy.getUserHandle().getIdentifier()), new IntegerPolicyValue(i), userInfo.id, true);
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    public final void migrateScreenCapturePolicyLocked() {
        Binder.withCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda119
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$migrateScreenCapturePolicyLocked$218();
            }
        });
    }

    public /* synthetic */ void lambda$migrateScreenCapturePolicyLocked$218() {
        ActiveAdmin deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked = getDeviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked();
        if (deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked != null && ((isDeviceOwner(deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked) && deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked.disableScreenCapture) || (deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked.getParentActiveAdmin() != null && deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked.getParentActiveAdmin().disableScreenCapture))) {
            this.mDevicePolicyEngine.setGlobalPolicy(PolicyDefinition.SCREEN_CAPTURE_DISABLED, EnforcingAdmin.createEnterpriseEnforcingAdmin(deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked.info.getComponent(), deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked.getUserHandle().getIdentifier(), deviceOwnerOrProfileOwnerOfOrganizationOwnedDeviceLocked), new BooleanPolicyValue(true));
        }
        Iterator it = this.mUserManager.getUsers().iterator();
        while (it.hasNext()) {
            ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(((UserInfo) it.next()).id);
            if (profileOwnerLocked != null && profileOwnerLocked.disableScreenCapture) {
                this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.SCREEN_CAPTURE_DISABLED, EnforcingAdmin.createEnterpriseEnforcingAdmin(profileOwnerLocked.info.getComponent(), profileOwnerLocked.getUserHandle().getIdentifier(), profileOwnerLocked), new BooleanPolicyValue(true), profileOwnerLocked.getUserHandle().getIdentifier());
            }
        }
    }

    public final void migrateLockTaskPolicyLocked() {
        Binder.withCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda22
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$migrateLockTaskPolicyLocked$219();
            }
        });
    }

    public /* synthetic */ void lambda$migrateLockTaskPolicyLocked$219() {
        ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
        if (deviceOwnerAdminLocked != null) {
            int identifier = deviceOwnerAdminLocked.getUserHandle().getIdentifier();
            DevicePolicyData lambda$getUserDataUnchecked$2 = lambda$getUserDataUnchecked$2(identifier);
            List list = lambda$getUserDataUnchecked$2.mLockTaskPackages;
            int i = lambda$getUserDataUnchecked$2.mLockTaskFeatures;
            if (!list.isEmpty()) {
                setLockTaskPolicyInPolicyEngine(deviceOwnerAdminLocked, identifier, list, i);
            }
        }
        for (int i2 : this.mUserManagerInternal.getUserIds()) {
            ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(i2);
            if (profileOwnerLocked != null && canDPCManagedUserUseLockTaskLocked(i2)) {
                DevicePolicyData lambda$getUserDataUnchecked$22 = lambda$getUserDataUnchecked$2(i2);
                List list2 = lambda$getUserDataUnchecked$22.mLockTaskPackages;
                int i3 = lambda$getUserDataUnchecked$22.mLockTaskFeatures;
                if (!list2.isEmpty()) {
                    setLockTaskPolicyInPolicyEngine(profileOwnerLocked, i2, list2, i3);
                }
            }
        }
    }

    public final void setLockTaskPolicyInPolicyEngine(ActiveAdmin activeAdmin, int i, List list, int i2) {
        this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.LOCK_TASK, EnforcingAdmin.createEnterpriseEnforcingAdmin(activeAdmin.info.getComponent(), i, activeAdmin), new LockTaskPolicy(new HashSet(list), i2), i);
    }

    public final void migratePermittedInputMethodsPolicyLocked() {
        Binder.withCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda203
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$migratePermittedInputMethodsPolicyLocked$220();
            }
        });
    }

    public /* synthetic */ void lambda$migratePermittedInputMethodsPolicyLocked$220() {
        Iterator it = this.mUserManager.getUsers().iterator();
        while (it.hasNext()) {
            ActiveAdmin profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(((UserInfo) it.next()).id);
            if (profileOwnerOrDeviceOwnerLocked != null) {
                EnforcingAdmin createEnterpriseEnforcingAdmin = EnforcingAdmin.createEnterpriseEnforcingAdmin(profileOwnerOrDeviceOwnerLocked.info.getComponent(), profileOwnerOrDeviceOwnerLocked.getUserHandle().getIdentifier(), profileOwnerOrDeviceOwnerLocked);
                if (profileOwnerOrDeviceOwnerLocked.permittedInputMethods != null) {
                    this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.PERMITTED_INPUT_METHODS, createEnterpriseEnforcingAdmin, new StringSetPolicyValue(new HashSet(profileOwnerOrDeviceOwnerLocked.permittedInputMethods)), profileOwnerOrDeviceOwnerLocked.getUserHandle().getIdentifier());
                }
                if (profileOwnerOrDeviceOwnerLocked.getParentActiveAdmin() != null && profileOwnerOrDeviceOwnerLocked.getParentActiveAdmin().permittedInputMethods != null) {
                    this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.PERMITTED_INPUT_METHODS, createEnterpriseEnforcingAdmin, new StringSetPolicyValue(new HashSet(profileOwnerOrDeviceOwnerLocked.getParentActiveAdmin().permittedInputMethods)), getProfileParentId(profileOwnerOrDeviceOwnerLocked.getUserHandle().getIdentifier()));
                }
            }
        }
    }

    public final void migrateAccountManagementDisabledPolicyLocked() {
        Binder.withCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda209
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$migrateAccountManagementDisabledPolicyLocked$221();
            }
        });
    }

    public /* synthetic */ void lambda$migrateAccountManagementDisabledPolicyLocked$221() {
        Iterator it = this.mUserManager.getUsers().iterator();
        while (it.hasNext()) {
            ActiveAdmin profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(((UserInfo) it.next()).id);
            if (profileOwnerOrDeviceOwnerLocked != null) {
                EnforcingAdmin createEnterpriseEnforcingAdmin = EnforcingAdmin.createEnterpriseEnforcingAdmin(profileOwnerOrDeviceOwnerLocked.info.getComponent(), profileOwnerOrDeviceOwnerLocked.getUserHandle().getIdentifier(), profileOwnerOrDeviceOwnerLocked);
                Iterator it2 = profileOwnerOrDeviceOwnerLocked.accountTypesWithManagementDisabled.iterator();
                while (it2.hasNext()) {
                    this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.ACCOUNT_MANAGEMENT_DISABLED((String) it2.next()), createEnterpriseEnforcingAdmin, new BooleanPolicyValue(true), profileOwnerOrDeviceOwnerLocked.getUserHandle().getIdentifier());
                }
                if (profileOwnerOrDeviceOwnerLocked.getParentActiveAdmin() != null) {
                    Iterator it3 = profileOwnerOrDeviceOwnerLocked.getParentActiveAdmin().accountTypesWithManagementDisabled.iterator();
                    while (it3.hasNext()) {
                        this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.ACCOUNT_MANAGEMENT_DISABLED((String) it3.next()), createEnterpriseEnforcingAdmin, new BooleanPolicyValue(true), getProfileParentId(profileOwnerOrDeviceOwnerLocked.getUserHandle().getIdentifier()));
                    }
                }
            }
        }
    }

    public final void migrateUserControlDisabledPackagesLocked() {
        Binder.withCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda212
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$migrateUserControlDisabledPackagesLocked$222();
            }
        });
    }

    public /* synthetic */ void lambda$migrateUserControlDisabledPackagesLocked$222() {
        Iterator it = this.mUserManager.getUsers().iterator();
        while (it.hasNext()) {
            ActiveAdmin profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(((UserInfo) it.next()).id);
            if (profileOwnerOrDeviceOwnerLocked != null && profileOwnerOrDeviceOwnerLocked.protectedPackages != null) {
                EnforcingAdmin createEnterpriseEnforcingAdmin = EnforcingAdmin.createEnterpriseEnforcingAdmin(profileOwnerOrDeviceOwnerLocked.info.getComponent(), profileOwnerOrDeviceOwnerLocked.getUserHandle().getIdentifier(), profileOwnerOrDeviceOwnerLocked);
                if (isDeviceOwner(profileOwnerOrDeviceOwnerLocked)) {
                    this.mDevicePolicyEngine.setGlobalPolicy(PolicyDefinition.USER_CONTROLLED_DISABLED_PACKAGES, createEnterpriseEnforcingAdmin, new StringSetPolicyValue(new HashSet(profileOwnerOrDeviceOwnerLocked.protectedPackages)));
                } else {
                    this.mDevicePolicyEngine.setLocalPolicy(PolicyDefinition.USER_CONTROLLED_DISABLED_PACKAGES, createEnterpriseEnforcingAdmin, new StringSetPolicyValue(new HashSet(profileOwnerOrDeviceOwnerLocked.protectedPackages)), profileOwnerOrDeviceOwnerLocked.getUserHandle().getIdentifier());
                }
            }
        }
    }

    public final void migrateUserRestrictionsLocked() {
        Binder.withCleanCallingIdentity(new FunctionalUtils.ThrowingRunnable() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda140
            public final void runOrThrow() {
                DevicePolicyManagerService.this.lambda$migrateUserRestrictionsLocked$223();
            }
        });
    }

    public /* synthetic */ void lambda$migrateUserRestrictionsLocked$223() {
        int i;
        for (UserInfo userInfo : this.mUserManager.getUsers()) {
            ActiveAdmin profileOwnerOrDeviceOwnerLocked = getProfileOwnerOrDeviceOwnerLocked(userInfo.id);
            if (profileOwnerOrDeviceOwnerLocked != null) {
                ComponentName component = profileOwnerOrDeviceOwnerLocked.info.getComponent();
                int i2 = userInfo.id;
                EnforcingAdmin createEnterpriseEnforcingAdmin = EnforcingAdmin.createEnterpriseEnforcingAdmin(component, i2, profileOwnerOrDeviceOwnerLocked);
                if (isDeviceOwner(profileOwnerOrDeviceOwnerLocked)) {
                    i = 0;
                } else if (isProfileOwnerOfOrganizationOwnedDevice(component, i2)) {
                    i = 2;
                } else {
                    if (!isProfileOwner(component, i2)) {
                        throw new IllegalStateException("Invalid DO/PO state");
                    }
                    i = 1;
                }
                Iterator<String> it = profileOwnerOrDeviceOwnerLocked.ensureUserRestrictions().keySet().iterator();
                while (it.hasNext()) {
                    setBackwardCompatibleUserRestrictionLocked(i, createEnterpriseEnforcingAdmin, i2, it.next(), true, false);
                }
                Iterator<String> it2 = profileOwnerOrDeviceOwnerLocked.getParentActiveAdmin().ensureUserRestrictions().keySet().iterator();
                while (it2.hasNext()) {
                    setBackwardCompatibleUserRestrictionLocked(i, createEnterpriseEnforcingAdmin, i2, it2.next(), true, true);
                }
            }
        }
    }

    public final List getInstalledPackagesOnUser(final int i) {
        return (List) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda207
            public final Object getOrThrow() {
                List lambda$getInstalledPackagesOnUser$224;
                lambda$getInstalledPackagesOnUser$224 = DevicePolicyManagerService.this.lambda$getInstalledPackagesOnUser$224(i);
                return lambda$getInstalledPackagesOnUser$224;
            }
        });
    }

    public /* synthetic */ List lambda$getInstalledPackagesOnUser$224(int i) {
        return this.mContext.getPackageManager().getInstalledPackagesAsUser(PackageManager.PackageInfoFlags.of(4096L), i);
    }

    public final ActiveAdmin getMostProbableDPCAdminForLocalPolicy(int i) {
        synchronized (getLockObject()) {
            ActiveAdmin deviceOwnerLocked = getDeviceOwnerLocked(i);
            if (deviceOwnerLocked != null) {
                return deviceOwnerLocked;
            }
            ActiveAdmin profileOwnerLocked = getProfileOwnerLocked(i);
            if (profileOwnerLocked != null) {
                return profileOwnerLocked;
            }
            int[] profileIds = this.mUserManager.getProfileIds(i, false);
            for (int i2 : profileIds) {
                if (i2 != i && isProfileOwnerOfOrganizationOwnedDevice(i2)) {
                    return getProfileOwnerAdminLocked(i2);
                }
            }
            for (int i3 : profileIds) {
                if (i3 != i && isManagedProfile(i3)) {
                    return getProfileOwnerAdminLocked(i3);
                }
            }
            ActiveAdmin deviceOwnerAdminLocked = getDeviceOwnerAdminLocked();
            if (deviceOwnerAdminLocked != null) {
                return deviceOwnerAdminLocked;
            }
            Iterator it = this.mUserManager.getUsers().iterator();
            while (it.hasNext()) {
                ActiveAdmin profileOwnerLocked2 = getProfileOwnerLocked(((UserInfo) it.next()).id);
                if (profileOwnerLocked2 != null) {
                    return profileOwnerLocked2;
                }
            }
            return null;
        }
    }

    public static CharSequence truncateIfLonger(CharSequence charSequence, int i) {
        return (charSequence == null || charSequence.length() <= i) ? charSequence : charSequence.subSequence(0, i);
    }

    public static void enforceMaxStringLength(String str, String str2) {
        Preconditions.checkArgument(str.length() <= 65535, str2 + " loo long");
    }

    public static void enforceMaxPackageNameLength(String str) {
        Preconditions.checkArgument(str.length() <= 223, "Package name too long");
    }

    public static void enforceMaxStringLength(PersistableBundle persistableBundle, String str) {
        ArrayDeque arrayDeque = new ArrayDeque();
        arrayDeque.add(persistableBundle);
        while (!arrayDeque.isEmpty()) {
            PersistableBundle persistableBundle2 = (PersistableBundle) arrayDeque.remove();
            for (String str2 : persistableBundle2.keySet()) {
                enforceMaxStringLength(str2, "key in " + str);
                Object obj = persistableBundle2.get(str2);
                if (obj instanceof String) {
                    enforceMaxStringLength((String) obj, "string value in " + str);
                } else if (obj instanceof String[]) {
                    for (String str3 : (String[]) obj) {
                        enforceMaxStringLength(str3, "string value in " + str);
                    }
                } else if (obj instanceof PersistableBundle) {
                    arrayDeque.add((PersistableBundle) obj);
                }
            }
        }
    }

    public final ActiveAdmin getActiveAdminForCaller(ComponentName componentName, final CallerIdentity callerIdentity) {
        synchronized (getLockObject()) {
            if (componentName != null) {
                return getActiveAdminUncheckedLocked(componentName, callerIdentity.getUserId());
            }
            return (ActiveAdmin) this.mInjector.binderWithCleanCallingIdentity(new FunctionalUtils.ThrowingSupplier() { // from class: com.android.server.devicepolicy.DevicePolicyManagerService$$ExternalSyntheticLambda142
                public final Object getOrThrow() {
                    ActiveAdmin lambda$getActiveAdminForCaller$226;
                    lambda$getActiveAdminForCaller$226 = DevicePolicyManagerService.this.lambda$getActiveAdminForCaller$226(callerIdentity);
                    return lambda$getActiveAdminForCaller$226;
                }
            });
        }
    }

    public /* synthetic */ ActiveAdmin lambda$getActiveAdminForCaller$226(CallerIdentity callerIdentity) {
        List<ComponentName> activeAdmins = getActiveAdmins(callerIdentity.getUserId());
        if (activeAdmins == null) {
            return null;
        }
        for (ComponentName componentName : activeAdmins) {
            if (componentName.getPackageName().equals(callerIdentity.getPackageName())) {
                return getActiveAdminUncheckedLocked(componentName, callerIdentity.getUserId());
            }
        }
        return null;
    }

    public boolean isDeviceFinanced(String str) {
        CallerIdentity callerIdentity = getCallerIdentity(str);
        Preconditions.checkCallAuthorization(isDeviceOwner(callerIdentity) || isProfileOwnerOfOrganizationOwnedDevice(callerIdentity) || isProfileOwnerOnUser0(callerIdentity) || isCallerDevicePolicyManagementRoleHolder(callerIdentity) || isCallerSystemSupervisionRoleHolder(callerIdentity));
        return getFinancedDeviceKioskRoleHolderOnAnyUser() != null;
    }

    public String getFinancedDeviceKioskRoleHolder(String str) {
        CallerIdentity callerIdentity = getCallerIdentity(str);
        enforcePermission("android.permission.MANAGE_PROFILE_AND_DEVICE_OWNERS", callerIdentity.getPackageName(), callerIdentity.getUserId());
        return getFinancedDeviceKioskRoleHolderOnAnyUser();
    }

    public final String getFinancedDeviceKioskRoleHolderOnAnyUser() {
        return getRoleHolderPackageNameOnUser("android.app.role.FINANCED_DEVICE_KIOSK", -1);
    }
}
